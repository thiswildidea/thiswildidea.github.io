/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Map.js";import i from"../TimeExtent.js";import r from"../core/Accessor.js";import{c as o}from"../chunks/asyncUtils.js";import s from"../core/Collection.js";import{C as a}from"../chunks/CollectionFlattener.js";import n from"../core/Error.js";import l from"../core/Evented.js";import p,{f as h}from"../core/Handles.js";import{m as c}from"../chunks/handleUtils.js";import u from"../core/Loadable.js";import{L as d}from"../chunks/Logger.js";import{r as m,a as y,d as g}from"../chunks/maybe.js";import{EsriPromiseMixin as f}from"../core/Promise.js";import{createResolver as _,createAbortError as w,isAbortError as v,onAbort as b,throwIfAborted as j,c as k,isAborted as M,after as T}from"../core/promiseUtils.js";import{on as S,watch as V,syncAndInitial as R,whenOnce as I,when as E,sync as L}from"../core/reactiveUtils.js";import{g as C,property as x}from"../core/accessorSupport/decorators/property.js";import{s as P}from"../chunks/ensureType.js";import"../chunks/typedArrayUtil.js";import{subclass as F}from"../core/accessorSupport/decorators/subclass.js";import{O,G as D,o as U}from"../chunks/GraphicsCollection.js";import{U as A}from"../chunks/UpdatingHandles.js";import H from"../geometry/Extent.js";import q from"../geometry/HeightModelInfo.js";import W from"../geometry/SpatialReference.js";import{f as G}from"../chunks/unitUtils.js";import{s as N,a as z}from"../chunks/timeZoneUtils.js";import{BasemapView as Z}from"./BasemapView.js";import{schedule as B}from"../core/scheduling.js";import{d as K}from"../chunks/collectionUtils2.js";import $ from"./Magnifier.js";import Q from"./Theme.js";import{V as J}from"../chunks/InputManager.js";import{e as X,V as Y}from"../chunks/ViewEvents.js";import{E as ee}from"../chunks/interfaces5.js";import{c as te}from"../chunks/mathUtils.js";import{c as ie}from"../chunks/screenUtils.js";import{c as re}from"../chunks/screenUtils2.js";import oe from"./input/Input.js";import se from"./navigation/Navigation.js";import{s as ae,d as ne}from"../chunks/heightModelInfoUtils.js";import{V as le}from"../chunks/ViewingMode.js";import{p as pe}from"../chunks/projectionUtils.js";import"../Basemap.js";import"../request.js";import"../config.js";import"../core/lang.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"../chunks/utils.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/time.js";import"../chunks/collectionUtils.js";import"../chunks/loadAll.js";import"../chunks/writer.js";import"../portal/Portal.js";import"../chunks/reader.js";import"../chunks/locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../chunks/jsonMap.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/messages.js";import"../support/BasemapStyle.js";import"../chunks/writeUtils.js";import"../chunks/layerUtils2.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../Ground.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../chunks/compilerUtils.js";import"../chunks/enumeration.js";import"../chunks/opacityUtils.js";import"../chunks/editableLayers.js";import"../chunks/infoFor3D.js";import"../chunks/basemapUtils.js";import"../chunks/utils3.js";import"../chunks/mat4.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Identifiable.js";import"../support/TablesMixin.js";import"../chunks/timeUtils.js";import"../chunks/date.js";import"../chunks/datetime.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"../chunks/arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils4.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils5.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../chunks/Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/Queue.js";import"../chunks/PropertiesPool.js";import"../core/signal.js";import"../chunks/IViewEvents.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/arcgisLayerUrl.js";import"../geometry/projection.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";let he=class extends O{constructor(e){super(e),this.addHandles(this.on("before-add",(e=>{null!=e.item&&e.item.parent===this.owner&&(d.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),e.preventDefault())})))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};he=e([F("esri.support.AnalysesCollection")],he);class ce{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=_(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,b(this._controller.signal,(()=>{const t=new n("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}tryRecycle(e){if(!this.done||!this.layerView||!("tryRecycleWith"in this.layerView))return null;const t=this.layer.type,i=this._controller.signal;for(let r=0;r<e.length;r++){const o=e[r];if(o.type!==t)continue;const s=this.layerView.tryRecycleWith(o,{signal:i});if(s){e.splice(r,1),this.layer=o;const t=this.layerView,i=t.view;return this.promise=Promise.race([s.then((()=>(j(this._controller.signal),o.emit("layerview-destroy",{view:i,layerView:t}),i.emit("layerview-destroy",{view:i,layerView:t}),o.emit("layerview-create",{view:i,layerView:t}),i.emit("layerview-create",{view:i,layerView:t}),t))),new Promise(((e,t)=>b(this._controller.signal,(()=>t(w())))))]),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:t,view:i}=this;this._map=i.map;try{let r,o;if(await t.load({signal:e}),t.prefetchResources&&await t.prefetchResources({signal:e}),function(e){return"createLayerView"in e&&null!=e.createLayerView}(t))r=await t.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(t))throw new n("layer:view-not-supported","No layerview implementation was found");const o=await this.layerViewImporter.importLayerView(t);j(e),r="default"in o?new o.default({layer:t,view:i}):new o({layer:t,view:i})}const s=()=>{o=m(o),r.destroyed||r.destroy(),r.layer=null,r.parent=null,r.view=null,this.done=!0};o=b(e,s),j(e);try{await r.when()}catch(e){throw s(),e}const a=this._map?.allLayers?.includes(t);if(!a)return s(),void this._deferred.reject(new n("view:no-layerview-for-layer","The layer has been removed from the map",{layer:t}));this.layerView=r,t.emit("layerview-create",{view:i,layerView:r}),i.emit("layerview-create",{layer:t,layerView:r}),this.done=!0,this._deferred.resolve(r)}catch(e){t.emit("layerview-create-error",{view:i,error:e}),i.emit("layerview-create-error",{layer:t,error:e}),this.done=!0,this._deferred.reject(new n("layerview:create-error","layerview creation failed",{layer:t,error:e}))}}}let ue=class extends r{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new A,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const e=this.view.map?.allLayers;if(e)for(const t of e)this.layerViewImporter.hasLayerViewModule(t)&&this.layerViewImporter.importLayerView(t)},this._reschedule=()=>this.destroyed?Promise.reject():(null==this._workPromise&&(this._workPromise=_(),this._workPromise.promise.catch((()=>{}))),this.removeHandles("reschedule"),this.addHandles(B(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;const e=this.view.map;if(this._map!==e&&(this.clear(),this._map=e),null==this._workPromise)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const t=new Set,i=[],r=this.view.ready,o=e=>{if(null!=e)for(const s of e)if(s){t.add(s);const e=this._layerLayerViewInfoMap.get(s);e&&r?e.start():e||this._recyclingInfoMap.has(s)||i.push(s),"layers"in s&&s.layers&&o(s.layers)}};for(const e of this._rootCollectionNames)o(C(this,e));for(const[e,r]of this._layerLayerViewInfoMap)if(!t.has(e)){this._layerLayerViewInfoMap.delete(r.layer);const e=r.tryRecycle(i);e?(this.notifyChange("updating"),this._recyclingInfoMap.set(r.layer,r),e.then((()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(r.layer),this._layerLayerViewInfoMap.set(r.layer,r),this._reschedule()})).catch((()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(r.layer),r.destroy(),this._reschedule()}))):r.destroy()}for(const[e,i]of this._recyclingInfoMap)t.has(e)||(this.notifyChange("updating"),this._recyclingInfoMap.delete(i.layer),i.destroy());for(const e of i)this._createLayerView(e);this._refreshCollections();const s=[e?.ground?.layers,e?.basemap?.baseLayers,e?.basemap?.referenceLayers,e?.layers].filter((e=>!!e));t.forEach((e=>"layers"in e&&s.push(e.layers))),this.addHandles(s.map((e=>this._watchUpdatingTracking.addOnCollectionChange((()=>e),this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.addHandles([S((()=>this.view?.map?.allLayers),"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),V((()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]}),(()=>this._reschedule()),R)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),K(this._recyclingInfoMap),K(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,null!=this._workPromise&&(this._workPromise.reject(w()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return null!=this._workPromise||this._watchUpdatingTracking.updating||P(this._layerLayerViewInfoMap,(e=>!e.done))||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(K(this._layerLayerViewInfoMap),this._refreshCollections())}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new n("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(C(this,e),C(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let r=0;for(const o of e){const e=this._layerLayerViewInfoMap.get(o);if(!e?.layerView)continue;const s=e.layerView;s.layer=o,s.parent=i,t.at(r)!==s&&t.splice(r,0,s),o.layers&&this._populateLayerViewsOwners(o.layers,s.layerViews,s),r+=1}r<t.length&&t.splice(r,t.length)}_createLayerView(e){e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new ce(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{t&&(v(t)||"cancelled:layerview-create"===t.name)||d.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:t}),this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};e([x()],ue.prototype,"_workPromise",void 0),e([x({readOnly:!0})],ue.prototype,"_watchUpdatingTracking",void 0),e([x({readOnly:!0})],ue.prototype,"_layersToLayerViews",null),e([x({readOnly:!0})],ue.prototype,"_rootCollectionNames",null),e([x()],ue.prototype,"layerViewImporter",void 0),e([x()],ue.prototype,"supportsGround",void 0),e([x({readOnly:!0})],ue.prototype,"updating",null),e([x({readOnly:!0})],ue.prototype,"updatingRemaining",null),e([x({constructOnly:!0})],ue.prototype,"view",void 0),ue=e([F("esri.views.LayerViewManager")],ue);const de=ue;function me(e){return e.visible&&null!=e.getEditableFlag&&e.getEditableFlag(ee.USER)&&e.getEditableFlag(ee.MANAGER)}class ye{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":ge(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!fe(e))break;const r=re(e),o=this._intersect(r,e.pointerType,t.forEachTool);if(null==o)break;const s=o.manipulator,a=o.tool;null==s||null==a||!s.interactive||s.grabbable&&s.grabbableForEvent(e)||!s.grabbing||s.dragging||this._ungrabManipulatorBeforeDragging(s,e,t),null!=s&&null!=a&&s.interactive&&s.grabbable&&s.grabbableForEvent(e)&&!s.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:s,tool:a,start:r,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&null==t.activeTool&&(this._revertToNullActiveTool=!0,t.setActiveTool(o.tool)),s.grabbing=!0,s.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!fe(e))break;const r=this._grabbedManipulators.get(e.pointerId),o=r?.manipulator,s=r?.tool;if(null==o||null==s)break;const a=re(e);a.x=te(a.x,0,t.view.width),a.y=te(a.y,0,t.view.height);const n=r.start,l=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(o.dragging=!0,l?o.events.emit("drag",{action:"update",start:n,screenPoint:a}):o.events.emit("drag",{action:"start",start:n,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:s,manipulator:o,start:n}));break;case"end":o.dragging=!1,l&&o.events.emit("drag",{action:"end",start:n,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const r=re(e),o=this._intersect(r,e.pointerType,t.forEachTool);if(e.native.shiftKey||t.forEachTool((e=>{if((null==o||o.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}})),null==o)break;const{manipulator:s,tool:a}=o;if(!s.interactive)break;s.selectable&&a.automaticManipulatorSelection&&(s.selected=!s.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const n=e.native.shiftKey;s.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:n,stopPropagation:i}),_e(s,i);break}case"click":{const r=re(e),o=this._intersect(r,e.pointerType,t.forEachTool),s=o?.manipulator;if(null==s||!s.interactive)break;const a=e.native.shiftKey;s.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a}),i();break}case"double-click":{const r=re(e),o=this._intersect(r,e.pointerType,t.forEachTool),s=null!=o?o.manipulator:null;if(null==s||!s.interactive)break;const a=e.native.shiftKey;s.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),_e(s,i);break}case"immediate-double-click":{const r=re(e),o=this._intersect(r,e.pointerType,t.forEachTool),s=null!=o?o.manipulator:null;if(null==s||!s.interactive)break;const a=e.native.shiftKey;s.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),_e(s,i);break}}this._onFocusChange(t.forEachTool)}_ungrabManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:re(t)}),this._grabbedManipulators.forEach((({manipulator:t},i)=>{t===e&&this._grabbedManipulators.delete(i)})),this._afterManipulatorUngrab(i.setActiveTool)}_handlePointerEnd(e,t){const i=this._grabbedManipulators.get(e.pointerId)?.manipulator;null!=i&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:re(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorUngrab(t.setActiveTool))}_cursorFromMap(e){let t=null;return P(e,(({manipulator:e})=>!(null==e||!e.interactive||(e.grabbing&&e.grabCursor?(t=e.grabCursor,0):!e.cursor||(t=e.cursor,0))))),t}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach((({tool:e})=>{t.add(e)})),this._hoveredManipulators.forEach((({tool:e})=>{i.add(e)})),e((e=>{e.hasGrabbedManipulators=t.has(e),e.hasHoveredManipulators=i.has(e);const r=this._grabbedManipulators.values(),o=h(r,(({tool:t})=>t===e));e.firstGrabbedManipulator=null!=o?o.manipulator:null}))}clearPointers(e,{forEachTool:t,setActiveTool:i},r=!0,o){const s=(t,i)=>t===e&&(null==o||o===i);this._grabbedManipulators.forEach((({tool:e,manipulator:t,pointerType:i},r)=>{s(e,t)&&(this._grabbedManipulators.delete(r),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:i}))})),this._draggedManipulators.forEach((({tool:e,manipulator:t},i)=>{s(e,t)&&(this._draggedManipulators.delete(i),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))})),r&&this._hoveredManipulators.forEach((({tool:e,manipulator:t},i)=>{s(e,t)&&(this._hoveredManipulators.delete(i),t.hovering=!1)})),this._afterManipulatorUngrab(i),this._onFocusChange(t)}_intersect(e,t,i){let r=null;return i((i=>{if(null==i.manipulators||!me(i))return!1;const o=i.manipulators.intersect(e,t);return null!=o&&(r={tool:i,manipulator:o},!0)})),r}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(ie(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){"pointer-up"!==e.type&&"immediate-click"!==e.type&&"pointer-move"!==e.type||!ge(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(re(e),e.pointerId,e.pointerType,t)}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){let o=this._intersect(e,i,r);const s=this._hoveredManipulators.get(t)?.manipulator;null==o||o.manipulator.interactive||(o=null),null!=o&&s===o.manipulator||(null!=s&&(s.hovering=!1),null!=o?(o.manipulator.hovering=!0,this._hoveredManipulators.set(t,o)):this._hoveredManipulators.delete(t),this._onFocusChange(r))}_afterManipulatorUngrab(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}}function ge(e){return"mouse"===e}function fe(e){return"mouse"!==e.pointerType||0===e.button}function _e(e,t){e?.consumesClicks&&t()}const we="attached",ve="tools";let be=class extends r{constructor(e){super(e),this._updatingHandles=new A,this._clock=k,this._manipulatorState=new ye,this.tools=new s,this.cursor=null,this._interacting=!1,this._interactingTimeout=1e3,this._interactingTimeoutHandle=null,this._forEachTool=e=>{for(const t of this.tools.items)if(e(t))return}}initialize(){var e;this.addHandles([this.view.on(X,(e=>{this._handleInputEvent(e)}),J.TOOL),...(e=this.tools,[e.on("before-add",(t=>{const i=t.item;if(null==i||e.includes(i))return d.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()})),e.on("after-remove",(e=>{const t=e.item;t.active&&(t.view.activeTool=null),t.destroy()}))]),this.tools.on("before-add",(({item:e})=>{this._updateToolEditableFlag(e)})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this.activeTool=null,this.tools.drain((e=>e.destroy())),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(null!=e&&!this.view.ready)return void d.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),null!=t&&t.deactivate(),null!=e&&e.activate(),this._removeIncompleteTools(e);for(const e of this.tools){this._updateToolEditableFlag(e);const t=me(e);null!=this.activeTool&&t||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!t)}this._updateCursor()}get updating(){return this._updatingHandles.updating||this.tools.some((e=>e.updating))}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=m(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout((()=>this._interacting=!1),this._interactingTimeout)}attach(){"3d"===this.view.type?this.addHandles([V((()=>{const{state:e}=this.view;return"camera"in e&&e.camera}),(()=>this._forEachManipulator((e=>e.onViewChange())))),this.view.elevationProvider?.on("elevation-change",(e=>this._forEachManipulator((t=>t.onElevationChange(e)))))],we):this.addHandles(V((()=>this.view.extent),(()=>this._forEachManipulator((e=>e.onViewChange())))))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(we),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};null!=this.activeTool?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&e.visible&&e.handleInputEvent(i)})),!t&&"key-down"===e.type&&"Escape"===e.key&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||null==this.activeTool||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),"pointer-move"===e.type&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(ve),this._forEachTool((e=>{if(e instanceof r){const t=V((()=>[e.cursor,e.visible,e.editable]),(()=>{me(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}));this.addHandles(t,ve)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",(t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)})),e.manipulators.on("change",(()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}))],ve)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(ee.MANAGER,null==this.activeTool||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;null==e&&this._forEachTool((t=>!(null==t.cursor||!t.visible||(e=t.cursor,0)))),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter((t=>(null==e||t!==e)&&!t.created&&t.removeIncompleteOnCancel)).forEach((e=>{this.tools.remove(e)}))}get test(){const e=this;return{setClock:e=>this._clock=e,set interactingTimeoutEnabled(t){e._interactingTimeout=t?1e3:0},get interactingTimeoutEnabled(){return 0!==e._interactingTimeout}}}};e([x({constructOnly:!0,nonNullable:!0})],be.prototype,"view",void 0),e([x({value:null})],be.prototype,"activeTool",null),e([x({readOnly:!0,type:s})],be.prototype,"tools",void 0),e([x({readOnly:!0})],be.prototype,"cursor",void 0),e([x({readOnly:!0})],be.prototype,"updating",null),e([x()],be.prototype,"_interacting",void 0),e([x({readOnly:!0})],be.prototype,"interacting",null),be=e([F("esri.views.ToolViewManager")],be);let je=class extends r{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=y(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return null!=this.userSpatialReference?this.userSpatialReference:this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return null==this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),t=[];return null!=this.priorityCollection&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _allLayers(){return this._collectLayers(this.mapCollections)}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;let i=null;for(const t of e){const e=this._getSupportedSpatialReferences(t);if(e.length>0){const t=this._narrowDownSpatialReferenceCandidates(i,e);null!=t&&(i=t)}if(null!=i&&1===i.length)break}if(t&&(null==i||1!==i.length))return{updating:!0};const r=this._pickSpatialReferenceCandidate(i);return{spatialReference:null!=r?r.spatialReference:null,viewingMode:null!=r?r.viewingMode:null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:t}=this._collectLayers([{parent:this.map?.()?.basemap,layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const t=e[0].tileInfo;return{tileInfo:t&&t.spatialReference.equals(this.spatialReference)?t:null,updating:!1}}return{updating:t}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;for(const t of e)if(ae(t)){const e=ne(t);if(e)return{heightModelInfo:e,vcsWkid:t.spatialReference?.vcsWkid,latestVcsWkid:t.spatialReference?.latestVcsWkid,updating:!1}}return{updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,t=e.updating,i=[];for(const t of e.layers){const e="fullExtents"in t&&t.fullExtents||(null!=t.fullExtent?[t.fullExtent]:[]),r=this.requiresExtentInSpatialReference?null:e[0],o=e.find((e=>e.spatialReference.equals(this.spatialReference)))??r;if(o)return{candidates:[{extent:o,layer:t}],updating:!1};if(this._getSupportedSpatialReferences(t).length>0)for(const r of e)i.push({extent:r,layer:t})}return{candidates:i,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(null==e||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished}:(null!=this._projectExtentTask.task&&(this._projectExtentTask.task=y(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:o((async e=>{try{const t=await pe(i.extent,r,"portalItem"in i.layer?i.layer.portalItem:void 0,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if(M(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(null==e)return t;const i=[],r=(e,t)=>null!=e?null!=t?e===t&&e:e:t;for(const o of e)for(const e of t){if(!o.spatialReference.equals(e.spatialReference))continue;const t=r(o.viewingMode,e.viewingMode);if(!1!==t){i.push({spatialReference:o.spatialReference,viewingMode:t});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return null==e||e.length<1?null!=t?{spatialReference:t,viewingMode:null}:null:(null!=t&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==le.Local))&&(e=e.filter((({viewingMode:e})=>e!==le.Local))),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const i=[];for(const r of t){const t=this.getSpatialReferenceSupport({spatialReference:r,layer:e});if(null!=t){const e=null!=t.constraints?t.constraints:[{spatialReference:r,viewingMode:null}];for(const{spatialReference:t,viewingMode:r}of e)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!t.equals(this.userSpatialReference)||i.push({spatialReference:t,viewingMode:r})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]}_collectLayers(e){if("loaded"!==this._loadMaybe(this.map?.()))return{layers:[],updating:!0};const t=new ke;for(const i of e)if(this._collectCollection(i,t),t.preloading===this.sourcePreloadCount)break;return{layers:t.layers,updating:t.updating}}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":t.updating||t.layers.push(i),"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&null!=e.loadStatus?"not-loaded"===e.loadStatus?(e.load().catch((e=>{v(e)||console.log(e)})),"loading"):e.loadStatus:"loaded"}};e([x()],je.prototype,"required",void 0),e([x({constructOnly:!0})],je.prototype,"map",void 0),e([x({constructOnly:!0})],je.prototype,"getSpatialReferenceSupport",void 0),e([x()],je.prototype,"defaultSpatialReference",void 0),e([x()],je.prototype,"userSpatialReference",void 0),e([x()],je.prototype,"sourcePreloadCount",void 0),e([x()],je.prototype,"priorityCollection",void 0),e([x()],je.prototype,"requiresExtentInSpatialReference",void 0),e([x()],je.prototype,"suspended",void 0),e([x({readOnly:!0})],je.prototype,"ready",null),e([x({readOnly:!0})],je.prototype,"heightModelInfoReady",null),e([x({readOnly:!0})],je.prototype,"spatialReference",null),e([x({readOnly:!0})],je.prototype,"extent",null),e([x({readOnly:!0})],je.prototype,"heightModelInfo",null),e([x({readOnly:!0})],je.prototype,"vcsWkid",null),e([x({readOnly:!0})],je.prototype,"latestVcsWkid",null),e([x({readOnly:!0})],je.prototype,"viewingMode",null),e([x({readOnly:!0})],je.prototype,"tileInfo",null),e([x({readOnly:!0})],je.prototype,"mapCollections",null),e([x({readOnly:!0})],je.prototype,"_allLayers",null),e([x({readOnly:!0})],je.prototype,"_spatialReferenceTask",null),e([x({readOnly:!0})],je.prototype,"_tileInfoTask",null),e([x({readOnly:!0})],je.prototype,"_heightModelInfoTask",null),e([x({readOnly:!0})],je.prototype,"_extentCandidatesTask",null),e([x()],je.prototype,"_extentTask",null),e([x()],je.prototype,"_projectExtentTask",void 0),je=e([F("esri.views.support.DefaultsFromMap")],je);class ke{constructor(){this.layers=new Array,this.preloading=-1,this.updating=!1}}var Me;let Te=Me=class extends(l.EventedMixin(f(r))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.handles=new p,this.updatingHandles=new A,this.allLayerViews=new a({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:Ve}),this.groundView=null,this.basemapView=null,this.fatalError=null,this.graphics=new D,this.analyses=new he,this.typeSpecificPreconditionsReady=!0,this.layerViews=new s,this.magnifier=new $,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new oe,this.navigation=new se,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new Y(this),this.persistableViewModels=new s,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this.theme=null,this.handles.add(V((()=>this.preconditionsReady),(e=>{e?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,Me.views.add(this)):(this._lockedSpatialReference=null,Me.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?(this.toolViewManager?.detach(),null!=this.analysisViewManager&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown()):e&&!this.ready&&(this._startup(),null!=this.analysisViewManager&&this.analysisViewManager.attach(),this.toolViewManager.attach())}),L))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this.validate()]).then((()=>(this._isValid=!0,I((()=>this.ready)))))),this.basemapView=new Z({view:this}),this.layerViewManager=new de({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new be({view:this}),this._setupSpatialReferenceLogger(),this.addHandles([V((()=>this.initialExtentRequired),(e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e}),{sync:!0,initial:!0}),V((()=>this.ready),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)}),{sync:!0}),V((()=>this._userSpatialReference),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)}),{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let e=null;this.addHandles([V((()=>this.defaultsFromMap?.ready),(t=>{const i=this.map?.allLayers.length>0;if(t&&!this.spatialReference&&i){if(null!=e)return;const t=c((()=>e=y(e)));e=o((async t=>{try{await T(this.spatialReferenceWarningDelay,null,t)}catch{return}finally{e=null}d.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})),this.addHandles(t,"spatial-reference-logger-task")}else this.removeHandles("spatial-reference-logger-task")}),{sync:!0})])}destroy(){this.destroyed||(Me.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=g(this.graphics),this.analyses=g(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),g(this.analysisViewManager),this.toolViewManager=g(this.toolViewManager),this.layerViewManager=g(this.layerViewManager),this.basemapView=g(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach((e=>e.destroy())),this.layerViews.length=0,this.invalidate(),this._emitter.clear(),this.handles.destroy(),this.map=g(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return d.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new je({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:e=>this.getSpatialReferenceSupport(e),...this._defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||u.isLoadable(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(d.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),u.isLoadable(e)&&e.load().catch((()=>{})),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get spatialReference(){let e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.defaultsFromMap?.required?.heightModelInfo&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e}set spatialReference(e){const t=!G(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??N}set timeZone(e){const t=new Set(["etc/utc","etc/gmt","gmt"]),i=new Set(Intl.supportedValuesOf("timeZone").map((e=>e.toLowerCase())));this._userTimeZone=e,e===N||e===z||t.has(e.toLowerCase())||i.has(e.toLowerCase())||d.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._cursor??"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new Q}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}importLayerView(e){throw new n("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return null!=this.getSpatialReferenceSupport({spatialReference:e})}when(e,t){return this.isResolved()&&!this.ready&&d.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(E((()=>this.destroyed||!1===this.preconditionsReady),(()=>this._readyCycleForced=!1),{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};Te.views=new s,e([x()],Te.prototype,"_userSpatialReference",void 0),e([x()],Te.prototype,"activeTool",null),e([x({readOnly:!0})],Te.prototype,"allLayerViews",void 0),e([x()],Te.prototype,"groundView",void 0),e([x()],Te.prototype,"animation",null),e([x()],Te.prototype,"basemapView",void 0),e([x()],Te.prototype,"center",null),e([x({readOnly:!0})],Te.prototype,"_defaultsFromMapSettings",null),e([x()],Te.prototype,"defaultsFromMap",null),e([x()],Te.prototype,"fatalError",void 0),e([x({type:H})],Te.prototype,"extent",null),e([x(U(D,"graphics"))],Te.prototype,"graphics",void 0),e([x(U(he,"analyses"))],Te.prototype,"analyses",void 0),e([x({readOnly:!0,type:q})],Te.prototype,"heightModelInfo",null),e([x({readOnly:!0})],Te.prototype,"interacting",null),e([x({readOnly:!0})],Te.prototype,"navigating",null),e([x({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Te.prototype,"preconditionsReady",null),e([x({readOnly:!0})],Te.prototype,"typeSpecificPreconditionsReady",void 0),e([x({type:s,readOnly:!0})],Te.prototype,"layerViews",void 0),e([x()],Te.prototype,"resolution",null),e([x({type:$})],Te.prototype,"magnifier",void 0),e([x({value:null,type:t})],Te.prototype,"map",null),e([x()],Te.prototype,"padding",void 0),e([x({readOnly:!0})],Te.prototype,"ready",void 0),e([x({type:W})],Te.prototype,"spatialReference",null),e([x()],Te.prototype,"spatialReferenceWarningDelay",void 0),e([x()],Te.prototype,"stationary",null),e([x({readOnly:!0})],Te.prototype,"supportsGround",void 0),e([x({type:i})],Te.prototype,"timeExtent",void 0),e([x({type:String,nonNullable:!0})],Te.prototype,"timeZone",null),e([x()],Te.prototype,"tools",null),e([x()],Te.prototype,"toolViewManager",void 0),e([x({readOnly:!0})],Te.prototype,"type",void 0),e([x({type:Number})],Te.prototype,"scale",void 0),e([x({readOnly:!0})],Te.prototype,"updating",void 0),e([x({readOnly:!0})],Te.prototype,"initialExtentRequired",void 0),e([x({readOnly:!0})],Te.prototype,"initialExtent",null),e([x()],Te.prototype,"cursor",null),e([x({readOnly:!0})],Te.prototype,"input",void 0),e([x({type:se,nonNullable:!0})],Te.prototype,"navigation",void 0),e([x()],Te.prototype,"layerViewManager",void 0),e([x()],Te.prototype,"analysisViewManager",void 0),e([x()],Te.prototype,"width",void 0),e([x()],Te.prototype,"height",void 0),e([x({readOnly:!0})],Te.prototype,"resizing",void 0),e([x({value:null,readOnly:!0})],Te.prototype,"size",null),e([x({readOnly:!0})],Te.prototype,"suspended",void 0),e([x({readOnly:!0})],Te.prototype,"viewEvents",void 0),e([x({readOnly:!0})],Te.prototype,"persistableViewModels",void 0),e([x()],Te.prototype,"_isValid",void 0),e([x()],Te.prototype,"_readyCycleForced",void 0),e([x()],Te.prototype,"_lockedSpatialReference",void 0),e([x()],Te.prototype,"_userTimeZone",void 0),e([x()],Te.prototype,"_lockedTimeZone",void 0),e([x({type:Q})],Te.prototype,"theme",void 0),e([x({readOnly:!0,type:Q})],Te.prototype,"effectiveTheme",null),Te=Me=e([F("esri.views.View")],Te);const Se=Te;function Ve(e){return e.layerViews}export{he as A,Se as default};
