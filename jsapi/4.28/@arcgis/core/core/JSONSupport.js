/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import r,{O as t,n as s,i}from"./Accessor.js";import{clone as n}from"./lang.js";import{v as o,e as a,g as u}from"./accessorSupport/decorators/property.js";import{g as l,m as c}from"../chunks/utils.js";import{o as f,a as p,b as g,subclass as d}from"./accessorSupport/decorators/subclass.js";import{l as m}from"../chunks/typedArrayUtil.js";import h from"./Error.js";import{L as O}from"../chunks/Logger.js";import"./Handles.js";import"../chunks/maybe.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/handleUtils.js";import"../chunks/tracking.js";import"./scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"./promiseUtils.js";import"../config.js";import"../chunks/time.js";import"../chunks/ensureType.js";class y{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new y;return this._values.forEach(((t,s)=>{e&&e.has(s)||r.set(s,n(t.value),t.origin)})),r}get(e,r){r=this._normalizeOrigin(r);const t=this._values.get(e);return null==r||t?.origin===r?t?.value:void 0}originOf(e){return this._values.get(e)?.origin??t.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return null==e?r:r.filter((r=>this._values.get(r)?.origin===e))}set(e,r,s){if((s=this._normalizeOrigin(s))===t.DEFAULTS){const r=this._values.get(e);if(null!=r?.origin&&r.origin>s)return}this._values.set(e,new w(r,s))}delete(e,r){null!=(r=this._normalizeOrigin(r))&&this._values.get(e)?.origin!==r||this._values.delete(e)}has(e,r){return null!=(r=this._normalizeOrigin(r))?this._values.get(e)?.origin===r:this._values.has(e)}forEach(e){this._values.forEach((({value:r},t)=>e(r,t)))}_normalizeOrigin(e){if(null!=e)return e===t.DEFAULTS?e:t.USER}}class w{constructor(e,r){this.value=e,this.origin=r}}function v(e,r,s){r.keys().forEach((e=>{s.set(e,r.get(e),t.DEFAULTS)}));const i=e.metadatas;Object.keys(i).forEach((r=>{e.internalGet(r)&&s.set(r,e.internalGet(r),t.DEFAULTS)}))}function j(e,r,t){if(!e?.read||!1===e.read.enabled||!e.read.source)return!1;const s=e.read.source;if("string"==typeof s){if(s===r)return!0;if(s.includes(".")&&0===s.indexOf(r)&&a(s,t))return!0}else for(const e of s){if(e===r)return!0;if(e.includes(".")&&0===e.indexOf(r)&&a(e,t))return!0}return!1}function S(e,r,t,s,i){let n=f(r[t],i);(function(e){return e&&(!e.read||!1!==e.read.enabled&&!e.read.source)})(n)&&(e[t]=!0);for(const o of Object.getOwnPropertyNames(r))n=f(r[o],i),j(n,t,s)&&(e[o]=!0)}function N(e,r,t,s){const i=t.metadatas,n=p(i[r],s),o=n?.default;if(void 0===o)return;const a="function"==typeof o?o.call(e,r,s):o;void 0!==a&&t.set(r,a)}const b={origin:"service"};function k(e,r,t=b){if(!r||"object"!=typeof r)return;const s=l(e),i=s.metadatas,n={};for(const e of Object.getOwnPropertyNames(r))S(n,i,e,r,t);s.setDefaultOrigin(t.origin);for(const a of Object.getOwnPropertyNames(n)){const n=f(i[a],t).read,u=n?.source;let l;l=u&&"string"==typeof u?o(r,u):r[a],n?.reader&&(l=n.reader.call(e,l,r,t)),void 0!==l&&s.set(a,l)}if(!t||!t.ignoreDefaults){s.setDefaultOrigin("defaults");for(const r of Object.getOwnPropertyNames(i))n[r]||N(e,r,s,t)}s.setDefaultOrigin("user")}function _(e,r,t,s=b){const i={...s,messages:[]};t(i),i.messages?.forEach((r=>{"warning"!==r.type||e.loaded?s?.messages&&s.messages.push(r):e.loadWarnings.push(r)}))}function E(e,r,t,s,i){const n={};return r.write?.writer?.call(e,s,n,t,i),n}function J(e,r,i,n,o,a){if(!n?.write)return!1;const l=u(e,i);if(!o&&n.write.overridePolicy){const r=n.write.overridePolicy.call(e,l,i,a??void 0);void 0!==r&&(o=r)}if(o||(o=n.write),!o||!1===o.enabled)return!1;if(o.layerContainerTypes&&a?.layerContainerType&&!o.layerContainerTypes.includes(a.layerContainerType))return!1;if((null===l&&!o.allowNull&&!o.writerEnsuresNonNull||void 0===l)&&o.isRequired){const r=new h("web-document-write:property-required",`Missing value for required property '${i}' on '${e.declaredClass}'`,{propertyName:i,target:e});return r&&a?.messages?a.messages.push(r):r&&!a&&O.getLogger("esri.core.accessorSupport.write").error(r.name,r.message),!1}return!(void 0===l||null===l&&!o.allowNull&&!o.writerEnsuresNonNull||!(o.alwaysWriteDefaults||r.store.multipleOriginsSupported&&r.store.originOf(i)!==t.DEFAULTS)&&function(e,r,t,s,i){const n=s.default;if(void 0===n)return!1;if(null!=s.defaultEquals)return s.defaultEquals(i);if("function"==typeof n){if(Array.isArray(i)){const s=n.call(e,r,t??void 0);return m(s,i)}return!1}return n===i}(e,i,a,n,l)||!o.ignoreOrigin&&a?.origin&&r.store.multipleOriginsSupported&&r.store.originOf(i)<s(a.origin))}function T(e,r,t,s){const i=l(e),n=i.metadatas,o=g(n[r],s);return!!o&&J(e,i,r,o,t,s)}function D(e,r,t){if(e&&"function"==typeof e.toJSON&&(!e.toJSON.isDefaultToJSON||!e.write))return c(r,e.toJSON(t));const s=l(e),n=s.metadatas;for(const o in n){const a=g(n[o],t);if(!J(e,s,o,a,void 0,t))continue;const l=u(e,o),f=E(e,a,a.write&&"string"==typeof a.write.target?a.write.target:o,l,t);Object.keys(f).length>0&&(r=c(r,f),t?.resources?.pendingOperations?.length&&t.resources.pendingOperations.push(Promise.all(t.resources.pendingOperations).then((()=>c(r,f,(()=>"replace-arrays"))))),t?.writtenProperties&&t.writtenProperties.push({target:e,propName:o,oldOrigin:i(s.store.originOf(o)),newOrigin:t.origin}))}return r}const P=r=>{let t=class extends r{constructor(...e){super(...e);const r=l(this),t=r.store,s=new y;r.store=s,v(r,t,s)}read(e,r){k(this,e,r)}write(e,r){return D(this,e??{},r)}toJSON(e){return this.write({},e)}static fromJSON(e,r){return A.call(this,e,r)}};return t=e([d("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function A(e,r){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new this;return t.read(e,r),t}function U(e){return e&&"object"==typeof e&&"toJSON"in e&&"function"==typeof e.toJSON}let L=class extends(P(r)){};L=e([d("esri.core.JSONSupport")],L);export{L as JSONSupport,P as JSONSupportMixin,T as a,_ as b,U as isSerializable,k as r,v as s,D as w};
