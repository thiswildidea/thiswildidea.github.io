/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{n as e}from"../chunks/nextTick.js";import{P as s}from"../chunks/PooledArray.js";import{createResolver as t,isAborted as r,createAbortError as n}from"./promiseUtils.js";import{M as o}from"../chunks/time.js";import"../chunks/typedArrayUtil.js";import"../chunks/handleUtils.js";import"./Error.js";import"./lang.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/maybe.js";class a{constructor(e,s=30){this.name=e,this._counter=0,this._samples=new Array(s)}record(e){null!=e&&(this._samples[++this._counter%this._samples.length]=e)}get median(){return this._samples.slice().sort(((e,s)=>e-s))[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce(((e,s)=>e+s),0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}}class i{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class c{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let l=0,m=0;const h={time:o(0),deltaTime:o(0),elapsedFrameTime:o(0),frameDuration:o(0)},p=["prepare","preRender","render","postRender","update","finish"],u=[],f=new s;class d{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const k={frameTasks:f,willDispatch:!1,clearFrameTasks:function(e=!1){f.forAll((e=>{e.removed=!0})),e&&T()},dispatch:F,executeFrameTasks:function(e){const s=o(e-l);l=e;const t=m>0?m:1e3/60,r=Math.max(0,s-t);h.time=e,h.frameDuration=o(t-r);for(let t=0;t<p.length;t++){const r=performance.now(),n=p[t];f.forAll((r=>{r.paused||r.removed||(0===t&&r.ticks++,r.phases[n]&&(h.elapsedFrameTime=o(performance.now()-e),h.deltaTime=0===r.ticks?o(0):s,r.phases[n]?.call(r,h)))})),D[t].record(performance.now()-r)}T(),M.record(performance.now()-e)}};function w(s){const t=new c(s);return u.push(t),k.willDispatch||(k.willDispatch=!0,e(F)),t}function g(e){const s=new i(e);return f.push(s),null==_&&(l=performance.now(),_=requestAnimationFrame(j)),new d(s)}let _=null;function v(e){m=Math.max(0,e)}function j(){const e=performance.now();_=null,_=f.length>0?requestAnimationFrame(j):null,k.executeFrameTasks(e)}const A=new s;function T(){f.forAll((e=>{e.removed&&A.push(e)})),f.removeUnorderedMany(A.data,A.length),A.clear()}function F(){for(;u.length;){const e=u.shift();e.isActive&&e.callback()}k.willDispatch=!1}function x(s=1,o){const a=t(),i=()=>{r(o)?a.reject(n()):0===s?a():(--s,e((()=>i())))};return i(),a.promise}function y(){const e=t(),s=g({postRender:()=>{s.remove(),w(e)}});return e.promise}const D=p.map((e=>new a(e))),M=new a("total");export{d as FrameTaskHandle,a as P,g as addFrameTask,k as debug,D as performanceInfo,M as performanceTotal,w as schedule,v as setFrameDuration,y as waitAnimationFrame,x as waitTicks};
