/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../Color.js";import{isSymbol3D as t,isSymbol2D as n}from"../symbols.js";import{f as o}from"./asyncUtils.js";import"./typedArrayUtil.js";import{d as r,p as l}from"./screenUtils.js";import{O as s}from"./vec3f64.js";import{e as i}from"./jsonUtils.js";import{getCIMSymbolColor as a}from"../symbols/support/cimSymbolUtils.js";import{g as c}from"./assets.js";import u from"../request.js";import{L as f}from"./LRUCache.js";import{S as m}from"./Symbol3DMaterial.js";const y="picture-fill",p="simple-fill",h="simple-line",b="simple-marker",d=new f(1e3);function w(e){const t=e.style;let n=null;if(e)switch(e.type){case b:"cross"!==t&&"x"!==t&&(n=e.color);break;case p:"solid"===t?n=e.color:"none"!==t&&(n={type:"pattern",x:0,y:0,src:c(`esri/symbols/patterns/${t}.png`),width:5,height:5});break;case y:n={type:"pattern",src:e.url,width:r(e.width)*e.xscale,height:r(e.height)*e.yscale,x:r(e.xoffset),y:r(e.yoffset)};break;case"text":n=e.color;break;case"cim":n=a(e)}return n}function g(e,t){const n=e+"-"+t;return void 0!==d.get(n)?Promise.resolve(d.get(n)):u(e,{responseType:"image"}).then((e=>{const o=e.data,r=o.naturalWidth,l=o.naturalHeight,s=document.createElement("canvas");s.width=r,s.height=l;const i=s.getContext("2d");i.fillStyle=t,i.fillRect(0,0,r,l),i.globalCompositeOperation="destination-in",i.drawImage(o,0,0);const a=s.toDataURL();return d.put(n,a),a}))}function j(e){if(!e)return null;let t=null;switch(e.type){case p:case y:case b:t=j(e.outline);break;case h:{const n=r(e.width);null!=e.style&&"none"!==e.style&&0!==n&&(t={color:e.color,style:k(e.style),width:n,cap:e.cap,join:"miter"===e.join?r(e.miterLimit):e.join});break}default:t=null}return t}const k=(()=>{const e={};return t=>{if(e[t])return e[t];const n=t.replaceAll("-","");return e[t]=n,n}})(),L=new e([128,128,128]),x=new e("white");function S(e){if(!e)return 0;if(t(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return l(j(e)?.width)}function z(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function v(e){return e.resource?.href??""}function U(o,r){if(!o)return null;let l=null;return t(o)?l=function(t){const n=t.symbolLayers;if(!n)return null;let o=null;return n.forEach((e=>{"object"===e.type&&e.resource?.href||(o="water"===e.type?e.color:e.material?e.material.color:null)})),o?new e(o):null}(o):n(o)&&(l="cim"===o.type?a(o):o.color?new e(o.color):null),l?C(l,r):null}function C(t,n){if(null==n||null==t)return t;const o=t.toRgba();return o[3]=o[3]*n,new e(o)}function R(o,r,l){o&&(r||null!=l)&&(r&&(r=new e(r)),t(o)?function(e,t,n){const o=e.symbolLayers;if(!o)return;const r=e=>C(t=t??e??(null!=n?x:null),n);o.forEach((e=>{if("object"!==e.type||!e.resource?.href||t)if("water"===e.type)e.color=r(e.color);else{const t=null!=e.material?e.material.color:null,o=r(t);null==e.material?e.material=new m({color:o}):e.material.color=o,null!=n&&"outline"in e&&null!=e.outline?.color&&(e.outline.color=C(e.outline.color,n))}}))}(o,r,l):n(o)&&function(e,t,n){(t=t??e.color)&&(e.color=C(t,n)),null!=n&&"outline"in e&&e.outline?.color&&(e.outline.color=C(e.outline.color,n))}(o,r,l))}function E(e){for(const t of e)if("number"==typeof t)return t;return null}function O(e,t,n){for(let o=0;o<3;o++){const r=e[o];switch(r){case"symbol-value":{const e=n[o];return null!=e?e/t[o]:1}case"proportional":break;default:if(r&&t[o])return r/t[o]}}return 1}function A(e,t,n,o){switch(e){case"proportional":return n*o;case"symbol-value":return null!=t?t:n;default:return e}}async function D(e,r){if(e&&r)return t(e)?async function(e,t){const n=e.symbolLayers;n&&await o(n,(async e=>async function(e,t){switch(e.type){case"extrude":!function(e,t){e.size="number"==typeof t[2]?t[2]:0}(e,t);break;case"icon":case"line":case"text":!function(e,t){const n=E(t);null!=n&&(e.size=n)}(e,t);break;case"path":!function(e,t){const n=O(t,s,[e.width,void 0,e.height]);e.width=A(t[0],e.width,1,n),e.height=A(t[2],e.height,1,n)}(e,t);break;case"object":await async function(e,t){const{resourceSize:n,symbolSize:o}=await async function(e){const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js"),n=await t(e,10),{width:o,height:r,depth:l}=e,s=[o,l,r];let i=1;for(let e=0;e<3;e++){const t=s[e];if(null!=t){i=t/n[e];break}}for(let e=0;e<3;e++)null==s[e]&&(s[e]=n[e]*i);return{resourceSize:n,symbolSize:s}}(e),r=O(t,n,o);e.width=A(t[0],o[0],n[0],r),e.depth=A(t[1],o[1],n[1],r),e.height=A(t[2],o[2],n[2],r)}(e,t)}}(e,t)))}(e,r):void(n(e)&&function(e,t){const n=E(t);if(null!=n)switch(e.type){case"simple-marker":e.size=n;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=n,e.height=n*t):(e.width=n*t,e.height=n);break}case"simple-line":e.width=n;break;case"text":e.font.size=n}}(e,r))}function I(e,o,r){if(e&&null!=o)if(t(e)){const t=e.symbolLayers;t&&t.forEach((e=>{if(e&&"object"===e.type)switch(r){case"tilt":e.tilt=o;break;case"roll":e.roll=o;break;default:e.heading=o}}))}else n(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=o))}function M(e){if(!e)return null;const t=e.effects.filter((e=>"bloom"!==e.type)).map((e=>e.toJSON()));return i(t)}function q(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some((e=>"extrude"===e.type))}async function H(e,t){return await e.fetchSymbol(t)||e.fetchCIMSymbol(t)}export{D as a,I as b,R as c,M as d,j as e,w as f,U as g,H as h,C as i,L as j,g as k,z as l,k as m,v as n,S as o,q as s};
