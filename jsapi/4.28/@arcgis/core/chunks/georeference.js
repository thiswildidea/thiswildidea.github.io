/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{Q as e,v as r,w as t,R as n,x as o}from"./unitUtils.js";import{a}from"./mat3f64.js";import{b as i,m as s,i as l,c as f}from"./mat4.js";import{a as c,I as p}from"./mat4f64.js";import{r as u,p as m,e as g}from"./vec3.js";import{c as y,Z as h,f as P}from"./vec3f64.js";import{f as A,t as F,n as T,i as d}from"./mat3.js";import{canProjectWithoutEngine as R}from"../geometry/projection.js";import{g as j}from"./spatialReferenceEllipsoidUtils.js";import{c as v}from"./computeTranslationToOriginAndRotation.js";import{p as w}from"./projectBuffer.js";import{n as M,c as C}from"./DoubleArray.js";import _ from"../geometry/support/MeshGeoreferencedRelativeVertexSpace.js";import x from"../geometry/support/MeshGeoreferencedVertexSpace.js";import O from"../geometry/support/MeshLocalVertexSpace.js";import S from"../geometry/support/MeshTransform.js";import{t as b,n as E,a as V}from"./vec32.js";import{L as B}from"./Logger.js";import{y2lat as G}from"../geometry/support/webMercatorUtils.js";import{B as L,a as z}from"./BufferView.js";function U(e,r){return e.isGeographic||e.isWebMercator&&(r?.geographic??!0)}function W(e,r,t){const n=!e.isGeoreferenced;null!=t?.geographic&&t.geographic!==n&&B.getLogger(r).warnOnce(`Specifying the 'geographic' parameter (${t.geographic}) for a Mesh vertex space of type "${e.type}" is not supported. This parameter will be ignored.`)}const N=B.getLogger("esri.geometry.support.meshUtils.normalProjection");function Y(e,r,t,n,o){return J(n)?(H(X.TO_PCPF,L.fromTypedArray(e),z.fromTypedArray(r),z.fromTypedArray(t),n,L.fromTypedArray(o)),o):(N.error("Cannot convert spatial reference to PCPF"),o)}function $(e,r,t,n,o){return J(n)?(H(X.FROM_PCPF,L.fromTypedArray(e),z.fromTypedArray(r),z.fromTypedArray(t),n,L.fromTypedArray(o)),o):(N.error("Cannot convert to spatial reference from PCPF"),o)}function k(e,r,t){return w(e,r,0,t,j(r),0,e.length/3),t}function q(e,r,t){return w(e,j(t),0,r,t,0,e.length/3),r}function D(e,r,t){return T(ne,t),b(r,e,ne),d(ne)||E(r,r),r}function I(e,r,t){if(T(ne,t),b(r,e,ne,4),d(ne)||E(r,r,4),e!==r)for(let t=3;t<e.length;t+=4)r[t]=e[t];return r}function Q(e,r,t,n,o){if(!J(n))return N.error("Cannot convert spatial reference to PCPF"),o;H(X.TO_PCPF,L.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),z.fromTypedArray(r),z.fromTypedArray(t),n,L.fromTypedArray(o,4*Float32Array.BYTES_PER_ELEMENT));for(let r=3;r<e.length;r+=4)o[r]=e[r];return o}function Z(e,r,t,n,o){if(!J(n))return N.error("Cannot convert to spatial reference from PCPF"),o;H(X.FROM_PCPF,L.fromTypedArray(e,16),z.fromTypedArray(r),z.fromTypedArray(t),n,L.fromTypedArray(o,16));for(let r=3;r<e.length;r+=4)o[r]=e[r];return o}function H(e,r,t,n,o,a){if(!r)return;const i=t.count,s=j(o);if(K(o))for(let t=0;t<i;t++)n.getVec(t,ee),r.getVec(t,re),v(s,ee,te,s),A(ne,te),e===X.FROM_PCPF&&F(ne,ne),u(re,re,ne),a.setVec(t,re);else for(let o=0;o<i;o++){n.getVec(o,ee),r.getVec(o,re),v(s,ee,te,s),A(ne,te);const i=G(t.get(o,1));let l=Math.cos(i);e===X.TO_PCPF&&(l=1/l),ne[0]*=l,ne[1]*=l,ne[2]*=l,ne[3]*=l,ne[4]*=l,ne[5]*=l,e===X.FROM_PCPF&&F(ne,ne),u(re,re,ne),m(re,re),a.setVec(o,re)}return a}function J(e){return K(e)||function(e){return e.isWebMercator}(e)}function K(n){return n.isWGS84||e(n)||r(n)||t(n)}var X;!function(e){e[e.TO_PCPF=0]="TO_PCPF",e[e.FROM_PCPF=1]="FROM_PCPF"}(X||(X={}));const ee=y(),re=y(),te=c(),ne=a();function oe(e,r,t){return U(r.spatialReference,t)?function(e,r,t){const n=r.spatialReference,o=ue(r,t,ge),a=new Float64Array(e.position.length),i=function(e,r,t,n){return V(n,e,r),q(n,new Float64Array(e.length),t)}(e.position,o,n,a),s=T(he,o),l=function(e,r,t,n,o){if(null==t)return null;const a=new Float32Array(t.length);return b(a,t,n),$(a,e,r,o,a),a}(i,a,e.normal,s,n),f=function(e,r,t,n,o){if(null==t)return null;const a=new Float32Array(t.length);b(a,t,n,4);for(let e=3;e<a.length;e+=4)a[e]=t[e];return Z(a,e,r,o,a),a}(i,a,e.tangent,s,n);return{position:i,normal:l,tangent:f}}(e,r,t):function(e,r,t){const n=new Float64Array(e.position.length),o=e.position,a=r.x,i=r.y,s=r.z??0,l=me(t?t.unit:null,r.spatialReference);for(let e=0;e<o.length;e+=3)n[e]=o[e]*l+a,n[e+1]=o[e+1]*l+i,n[e+2]=o[e+2]*l+s;return{position:n,normal:e.normal,tangent:e.tangent}}(e,r,t)}function ae(e,r=p){const{position:t,normal:n,tangent:o}=e;return{position:V(new Float64Array(t.length),t,r),normal:null!=n?D(n,new Float32Array(n.length),r):null,tangent:null!=o?I(o,new Float32Array(o.length),r):null}}function ie(e,r,t,n){const{position:o,normal:a,tangent:i}=e;return r.isRelative?oe(ae(e,t?.localMatrix),r.getOriginPoint(n),{geographic:!r.isGeoreferenced}):{position:o,normal:a,tangent:i}}function se(e,r,t){if(t?.useTransform){const{position:n,normal:o,tangent:a}=e,{x:i,y:s,z:l}=r,f=P(i,s,l??0);return{vertexAttributes:{position:n,normal:o,tangent:a},vertexSpace:t.geographic??1?new O({origin:f}):new _({origin:f}),transform:new S}}return{vertexAttributes:oe(e,r,t),vertexSpace:new x,transform:null}}function le(e,r,t){return U(r.spatialReference,t)?function(e,r,t){const n=r.spatialReference;ue(r,t,ge);const o=l(ye,ge),a=new Float64Array(e.position.length),i=function(e,r,t,n){const o=k(e,r,n),a=new Float64Array(o.length);return V(a,o,t),a}(e.position,n,o,a),s=T(he,o),f=function(e,r,t,n,o){if(null==e)return null;const a=Y(e,r,t,n,new Float32Array(e.length));return b(a,a,o),a}(e.normal,e.position,a,n,s),c=function(e,r,t,n,o){if(null==e)return null;const a=Q(e,r,t,n,new Float32Array(e.length));return b(a,a,o,4),a}(e.tangent,e.position,a,n,s);return{position:i,normal:f,tangent:c}}(e,r,t):pe(e,r,t)}function fe(e,r,t,n,o){if(!r.isRelative)return le(e,n,o);const{spatialReference:a}=n,i=ie(e,r,t,a);return n.equals(r.getOriginPoint(a))?pe(i,n,o):le(i,n,o)}function ce({positions:e,transform:r,vertexSpace:t,inSpatialReference:n,outSpatialReference:o,outPositions:a,localMode:l}){const f=t.isRelative?t.origin:h,c=t.isRelative?r?.localMatrix??p:p;if(t.isGeoreferenced){const r=a??M(e.length);if(i(c,p)?C(r,e):V(r,e,c),!g(f,h)){const[e,t,n]=f;for(let o=0;o<r.length;o+=3)r[o]+=e,r[o+1]+=t,r[o+2]+=n}return w(r,n,0,r,o,0,r.length/3),r}let u=n;const m=j(n);u=o.isWebMercator&&l||!R(n,m)?u:m,v(n,f,ge,u),s(ge,ge,c);const y=a??M(e.length);return V(y,e,ge),w(y,u,0,y,o,0,y.length/3),y}function pe(e,r,t){const n=new Float64Array(e.position.length),o=e.position,a=r.x,i=r.y,s=r.z??0,l=me(t?t.unit:null,r.spatialReference);for(let e=0;e<o.length;e+=3)n[e]=(o[e]-a)/l,n[e+1]=(o[e+1]-i)/l,n[e+2]=(o[e+2]-s)/l;return{position:n,normal:e.normal,tangent:e.tangent}}function ue(e,r,t){v(e.spatialReference,[e.x,e.y,e.z??0],t,j(e.spatialReference));const n=me(r?r.unit:null,e.spatialReference);return f(t,t,[n,n,n]),t}function me(e,r){if(null==e)return 1;const t=n(r);return 1/o(t,"meters",e)}const ge=c(),ye=c(),he=a(),Pe=Object.freeze(Object.defineProperty({__proto__:null,applyTransform:ae,georeference:oe,georeferenceApplyTransform:ie,georeferenceByTransform:se,project:ce,ungeoreference:le,ungeoreferenceByTransform:fe},Symbol.toStringTag,{value:"Module"}));export{k as a,Y as b,Q as c,q as d,$ as e,Z as f,oe as g,se as h,U as i,ie as j,I as k,fe as l,ae as m,Pe as n,ce as p,D as t,le as u,W as v};
