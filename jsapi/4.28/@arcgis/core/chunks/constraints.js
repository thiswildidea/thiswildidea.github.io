/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{i as t,l as e}from"./typedArrayUtil.js";import{a as n,b as s,d as r,c as i,f as o,g as u,l as c,h as a,s as f}from"./vec2.js";import{c as h,Z as l,a as d,f as p}from"./vec2f64.js";import{c as L,f as m,h as P,b as g,i as k,s as A,j as y,k as E,m as N,d as v,e as q,a as T,n as x,o as M}from"./vec3.js";import{c as j,a as w,f as z,U as I}from"./vec3f64.js";import{c as b,f as R,d as Y,i as Z,a as H,b as U,e as F,s as S,p as _,n as G,g as O}from"./plane.js";import{c as C}from"./vector.js";import{i as D,f as V,e as B,p as J}from"./sphere.js";import{d as K,j as Q,g as W}from"./snappingUtils.js";import{f as X}from"./mathUtils.js";import{t as $}from"./mathUtils2.js";import{L as tt,i as et}from"./geometry2dUtils.js";function nt({start:t,end:e,type:o},u,c){const a=[],f=n(yt,e,t),l=n(Et,t,u),d=s(f),p=2*r(f,l),L=p*p-4*d*(s(l)-c*c);if(0===L){const e=-p/(2*d);(o===mt.PLANE||e>=0)&&a.push(i(h(),t,f,e))}else if(L>0){const e=Math.sqrt(L),n=(-p+e)/(2*d);(o===mt.PLANE||n>=0)&&a.push(i(h(),t,f,n));const s=(-p-e)/(2*d);(o===mt.PLANE||s>=0)&&a.push(i(h(),t,f,s))}return a}function st(t,e){const s=t.start,i=t.end,o=n(yt,i,s),c=A(Et,-o[1],o[0],0),a=e.start,f=e.end,h=y(Nt,f,a),l=k(h,c),d=A(vt,s[0],s[1],0),p=y(qt,d,a),L=k(p,c);if(Math.abs(l)<gt)return Math.abs(L),[];const P=m(Tt,a,h,L/l);if(e.type===tt.RAY){const t=y(xt,P,a);if(k(t,h)<-gt)return[]}if(t.type===mt.HALF_PLANE){const t=u(xt,P,s);if(r(t,o)<-gt)return[]}return[w(P)]}function rt(t,e){const n=ft(lt(jt,0,t),lt(wt,0,e)),s=[];for(const t of n)s.push(d(t));return s}function it(t,e){return ut(t,lt(jt,t[2],e))}function ot(t,e,s){const r=n(yt,t,e),o=s/a(r),u=i(j(),e,r,o);return u[2]=t[2],u}function ut(t,{start:e,end:n,type:s}){const r=y(yt,t,e),i=y(Et,n,e),o=k(r,i)/k(i,i);return m(j(),e,i,s===tt.RAY?Math.max(o,0):o)}const ct=(()=>{const t=j(),e=j(),n=j();return({start:s,end:r},{center:i,radius:u,normal:c,slicePlane:a})=>{const f=j(),h=R(i,c,Mt);if(pt(Y(h,s),0)&&pt(Y(h,r),0)){$(c,t,e);const f=(s,r)=>(g(n,r,i),o(s,k(n,t),k(n,e)),s),h=et({start:f(kt,s),end:f(At,r),type:tt.LINE},l,u),d=[];for(const[n,s]of h){const r=L(j(),i);m(r,r,t,n),m(r,r,e,s),a&&!Lt(a,r)||d.push(r)}return d}return Z(h,s,r,f)?!pt(P(f,i),u)||a&&!Lt(a,f)?[]:[f]:[]}})();function at({start:t,end:e,type:i},o,u){const c=[],a=g(yt,e,t),f=n(Et,t,o),h=s(a),l=2*r(a,f),d=l*l-4*h*(s(f)-u*u);if(0===d){const e=-l/(2*h);(i===tt.LINE||e>=0)&&c.push(m(j(),t,a,e))}else if(d>0){const e=Math.sqrt(d),n=(-l+e)/(2*h);(i===tt.LINE||n>=0)&&c.push(m(j(),t,a,n));const s=(-l-e)/(2*h);(i===tt.LINE||s>=0)&&c.push(m(j(),t,a,s))}return c}function ft(t,e){const n=t.start,s=t.end,r=e.start,i=e.end,o=y(yt,s,n),u=y(Et,i,r),c=y(Nt,r,n),a=E(vt,o,u),f=k(c,a);if(!X(f,0,gt))return[];const h=N(a);if(X(h,0,gt))return[];const l=E(qt,c,u),d=k(l,a)/h,p=m(Tt,n,o,d);if(t.type===tt.RAY){const t=y(xt,p,n);if(k(o,t)<-gt)return[]}if(e.type===tt.RAY){const t=y(xt,p,r);if(k(u,t)<-gt)return[]}return[w(p)]}function ht(t,e,n,s){const[r,i]=t,[o,u]=n,a=o-r,f=u-i,h=a*a+f*f,l=Math.sqrt(h);if(l>e+s)return[];if(l<Math.abs(e-s))return[];if(pt(l,0)&&pt(e,s))return[];const d=(e*e-s*s+h)/(2*l),L=Math.sqrt(e*e-d*d),m=L*f/l,P=L*a/l,[g,k]=c(kt,t,n,d/l);return pt(m,P)?[p(g,k)]:[p(g+m,k-P),p(g-m,k+P)]}function lt(t,e,{start:n,end:s,type:r}){return A(t.start,n[0],n[1],e),A(t.end,s[0],s[1],e),t.type=Pt[r],t}function dt(t,e){return pt(t[2],e[2])}function pt(t,e){return Math.abs(t-e)<gt}function Lt(t,e){return H(t,e)}var mt;!function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"}(mt||(mt={}));const Pt={[mt.PLANE]:tt.LINE,[mt.HALF_PLANE]:tt.RAY},gt=1e-6,kt=h(),At=h(),yt=j(),Et=j(),Nt=j(),vt=j(),qt=j(),Tt=j(),xt=j(),Mt=b(),jt={start:j(),end:j(),type:tt.LINE},wt={start:j(),end:j(),type:tt.LINE};class zt{intersect(t){return $t(this,t)}closestPoints(t){return[this.closestTo(t)]}}class It extends zt{constructor(t){super(),this.point=t}equals(t){return this===t||le(t)&&q(this.point,t.point)}closestTo(){return Q(this.point)}}class bt extends zt{constructor(t,e,n){super(),this.start=t,this.end=e,this.lineLike={start:t,end:e,type:n}}equals(t){return this===t||de(t)&&this.lineLike.type===t.lineLike.type&&q(this.start,t.start)&&q(this.end,t.end)}closestTo(t){const e=ut(t,this.lineLike);return K(e)}}class Rt extends bt{constructor(t,e){super(t,e,tt.LINE)}}class Yt extends bt{constructor(t,e){super(t,e,tt.RAY)}}class Zt extends zt{constructor(t){super(),this.constraints=t}equals(t){return this===t||he(t)&&e(this.constraints,t.constraints,((t,e)=>t.equals(e)))}closestTo(t){let e,n=1/0;for(const s of this.constraints){const r=s.closestTo(t),i=T(t,r);i<n&&(n=i,e=r)}return e?Q(e):t}closestPoints(t){return this.constraints.flatMap((e=>e===this?[]:e.closestPoints(t)))}}class Ht extends zt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||me(t)&&this.center[0]===t.center[0]&&this.center[1]===t.center[1]&&this.radius===t.radius}closestTo(t){const e=ot(t,this.center,this.radius);return K(e)}}class Ut extends zt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||Pe(t)&&q(this.center,t.center)&&this.radius===t.radius}closestTo(t){const e=ot(t,this.center,this.radius);return e[2]=this.center[2],K(e)}asCircle(){return new Ft(Q(this.center),this.radius,W(0,0,1))}}class Ft extends zt{constructor(t,e,n,s=void 0){super(),this.center=t,this.radius=e,this.normal=n,this.slicePlane=s}equals(t){return this===t||ge(t)&&q(this.center,t.center)&&q(this.normal,t.normal)&&this.radius===t.radius}closestTo(t){const{center:e,radius:n}=this;_(this.getPlane(_t),t,St);const s=y(St,St,e),r=x(s);if(pt(r,0))return Q(t);const i=n/Math.sqrt(r),o=m(j(),e,s,i),{slicePlane:u}=this;if(u&&!Lt(u,o)){const e=ee(u,this);return e?.closestTo(t)??Q(t)}return K(o)}getPlane(t=b()){return R(this.center,this.normal,t)}}const St=j(),_t=b();class Gt extends zt{constructor(t){super(),this.z=t}equals(t){return this===t||pe(t)&&this.z===t.z}closestTo(t){return K(z(t[0],t[1],this.z))}getPlane(t=b()){return A(Ot,0,0,this.z),R(Ot,I,t)}}const Ot=j();class Ct extends zt{constructor(t,e,n){super(),this.start=t,this.end=e,this.planeLike={start:t,end:e,type:n}}equals(t){return this===t||Le(t)&&this.planeLike.type===t.planeLike.type&&q(this.start,t.start)&&q(this.end,t.end)}closestTo(t){return K(it(t,this.planeLike))}closestEndTo(t){const{start:e,end:s}=this;return Math.sign(r(n(Dt,s,e),n(Vt,t,e)))>0?s:e}getPlane(t=b()){const e=L(Bt,this.end);return e[2]+=1,O(this.start,this.end,e,t)}getSlicePlane(t=b()){const{start:e,end:n,type:s}=this.planeLike;if(s===mt.PLANE)return;const r=A(Bt,e[0],e[1],0),i=A(Jt,n[0],n[1],0),o=g(Jt,i,r);return R(r,o,t),t}}const Dt=h(),Vt=h(),Bt=j(),Jt=j();class Kt extends Ct{constructor(t,e){super(t,e,mt.HALF_PLANE)}}class Qt extends Ct{constructor(t,e){super(t,e,mt.PLANE)}}class Wt extends zt{constructor(t,e){super(),this.sphere=V(t,e)}equals(t){return this===t||ke(t)&&B(this.sphere,t.sphere)}closestTo(t){const e=J(this.sphere,t,j());return K(e)}get center(){return this.sphere}get radius(){return this.sphere[3]}}class Xt extends zt{constructor(t,e,n){super(),this.start=t,this.end=e,this.getZ=n,this.planeLike={start:t,end:e,type:mt.PLANE}}equals(t){return this===t||Ae(t)&&q(this.start,t.start)&&q(this.end,t.end)&&this.getZ===t.getZ}closestTo(t){return function(t,e){const n=it(e,t.planeLike);return n[2]=t.getZ(n[0],n[1])??ye,K(n)}(this,t)}addIfOnTheGround(t,e){for(const n of e){const e=this.getZ(n[0],n[1])??0;pt(n[2],e)&&(n[2]=e,t.push(n))}}}function $t(t,e){if(he(t)){const n=[];for(const s of t.constraints){const t=s.intersect(e);t&&n.push(t)}return fe(n)}if(he(e))return $t(e,t);if(Ae(t))return oe(t,e);if(Ae(e))return oe(e,t);if(le(t)){const{point:n}=t,s=e.closestTo(n);return M(s,n)?t:void 0}if(de(t)){if(le(e))return $t(e,t);if(de(e))return ce(ft(t.lineLike,e.lineLike));if(pe(e))return te(t,e);if(Le(e))return ce(st(e.planeLike,t.lineLike));if(me(e))return ce(at(t.lineLike,e.center,e.radius));if(ge(e))return ce(ct(t.lineLike,e));if(Pe(e))return function({lineLike:t},{center:e,radius:n}){const s=e[2];return ce(at(t,e,n).filter((t=>pt(t[2],s))))}(t,e);if(ke(e))return function({lineLike:t},{sphere:e}){return ce(D(e,t.start,t.end))}(t,e)}else if(pe(t)){if(le(e)||de(e))return $t(e,t);if(pe(e))return function(t,e){return pt(t.z,e.z)?t:void 0}(t,e);if(Le(e))return function({z:t},{planeLike:e}){const[n,s]=e.start,[r,i]=e.end,o=W(n,s,t),u=W(r,i,t);return e.type===mt.PLANE?new Rt(o,u):new Yt(o,u)}(t,e);if(me(e))return function(t,e){const[n,s]=e.center;return new Ut(W(n,s,t.z),e.radius)}(t,e);if(ge(e))return ne(t,e);if(Pe(e))return n=t,pt((s=e).center[2],n.z)?s:void 0;if(ke(e))return function(t,{center:e,radius:n}){const s=Math.abs(e[2]-t.z);if(s>n&&!pt(s,n))return;const r=W(e[0],e[1],t.z),i=Math.sqrt(n**2-s**2);return pt(i,0)?void 0:new Ut(r,i)}(t,e)}else if(Le(t)){if(le(e)||de(e)||pe(e))return $t(e,t);if(Le(e))return ue(rt(t.planeLike,e.planeLike));if(me(e))return ue(nt(t.planeLike,e.center,e.radius));if(ge(e))return re(t,e);if(Pe(e))return se(t,e);if(ke(e))return ie(t,e)}else if(me(t)){if(le(e)||de(e)||pe(e)||Le(e))return $t(e,t);if(me(e))return ue(ht(t.center,t.radius,e.center,e.radius));if(ge(e))return;if(Pe(e))return function(t,e){return pt(f(t.center,e.center),0)&&pt(t.radius,e.radius)?e:ae(ht(t.center,t.radius,e.center,e.radius),e.center[2])}(t,e);if(ke(e))return}else if(ge(t)){if(le(e)||de(e)||pe(e)||Le(e)||me(e))return $t(e,t);if(ge(e))return;if(Pe(e))return void e.asCircle();if(ke(e))return}else if(Pe(t)){if(le(e)||de(e)||pe(e)||Le(e)||me(e)||ge(e))return $t(e,t);if(Pe(e))return function(t,e){if(dt(t.center,e.center))return pt(f(t.center,e.center),0)&&pt(t.radius,e.radius)?t:ae(ht(t.center,t.radius,e.center,e.radius),t.center[2])}(e,t);if(ke(e))return}else if(ke(t)){if(le(e)||de(e)||pe(e)||Le(e)||me(e)||Pe(e))return $t(e,t);if(ke(e))return}var n,s}const te=(()=>{const t=b();return(e,n)=>{const{start:s,end:r}=e;if(dt(s,r)&&pt(s[2],n.z))return e;const i=j();return Z(n.getPlane(t),s,r,i)?new It(K(i)):void 0}})(),ee=(()=>{const t=C(),e=b(),n={start:j(),end:j(),type:tt.LINE};return(s,r,i)=>{const{normal:o,center:u,radius:c}=r,a=k(o,G(s)),f=pt(Y(s,u),0);if(pt(a,1))return f?r:void 0;if(r.getPlane(e),f&&pt(a,0)&&U(s)&&U(e)){if(pt(c,0))return!i||Lt(i,u)?new It(Q(u)):void 0;const t=w(u);t[2]+=c;const e=w(u);e[2]-=c;const n=[];return i&&!Lt(i,t)||n.push(t),i&&!Lt(i,e)||n.push(e),ce(n)}if(!F(s,e,t))return;L(n.start,t.origin),v(n.end,t.origin,t.direction);const h=ct(n,r);return ce(i?function(t,e){return e.filter((e=>Lt(t,e)))}(i,h):h)}})(),ne=(()=>{const t=b();return(e,n)=>ee(e.getPlane(t),n)})(),se=(()=>{const t=b();return(e,{center:n,radius:s})=>{const r=nt(e.planeLike,n,s),i=n[2];e.getSlicePlane(t);const o=[];for(const[e,n]of r){const s=[e,n,i];Lt(t,s)&&o.push(s)}return ce(o)}})(),re=(()=>{const t=b(),e=b();return(n,s)=>ee(n.getPlane(t),s,n.getSlicePlane(e))})(),ie=(()=>{const t=b();return(e,{center:n,radius:s})=>{const r=e.getPlane(t),i=S(r,n),o=Math.abs(i);if(o>s&&!pt(o,s))return;const u=w(G(r)),c=m(j(),n,u,i),a=Math.sqrt(s**2-i**2);return pt(a,0)?new It(K(_(r,n,j()))):new Ft(K(c),a,u,e.getSlicePlane())}})();function oe(t,e){const{planeLike:n,getZ:s}=t,r=[];if(le(e))t.addIfOnTheGround(r,(i=n,o=e.point,function({start:t,end:e,type:n},s){const r=y(yt,s,t),i=y(Et,e,t),o=E(Nt,i,r);if(N(o)/N(i)<gt)switch(n){case tt.LINE:return[w(s)];case tt.RAY:return k(i,r)<-gt?[]:[w(s)]}return[]}(lt(jt,o[2],i),o)));else if(de(e))t.addIfOnTheGround(r,st(n,e.lineLike));else if(me(e))for(const[t,i]of nt(n,e.center,e.radius)){const e=s(t,i);null!=e&&r.push(z(t,i,e))}else if(Le(e)||Ae(e))for(const[t,i]of rt(n,e.planeLike)){const e=s(t,i)??ye;r.push(z(t,i,e))}var i,o;return ce(r)}function ue(t){return fe(t.map((([t,e])=>{const n=W(t,e,0),s=W(t,e,1);return new Rt(n,s)})))}function ce(t){return fe(t.map((t=>t?new It(K(t)):void 0)))}function ae(t,e){return ce(t.map((([t,n])=>[t,n,e])))}function fe(e){if(0!==e.length)return 1===e.length?e[0]??void 0:new Zt(e.filter(t))}function he(t){return t instanceof Zt}function le(t){return t instanceof It}function de(t){return t instanceof bt}function pe(t){return t instanceof Gt}function Le(t){return t instanceof Ct}function me(t){return t instanceof Ht}function Pe(t){return t instanceof Ut}function ge(t){return t instanceof Ft}function ke(t){return t instanceof Wt}function Ae(t){return t instanceof Xt}const ye=0;export{Xt as D,Gt as H,Rt as L,It as P,Wt as S,Kt as V,Qt as a,Ht as b,gt as e,ut as p};
