/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{e,d as i,B as a,u as o,j as n,m as s}from"./colorUtils2.js";import{m as r,h as l,r as p,d as h,b as c}from"./handleUtils.js";import{d as u,r as d}from"./maybe.js";import{watch as m,on as g,syncAndInitial as _,when as f,initial as y,sync as v}from"../core/reactiveUtils.js";import{property as M}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{h as b,o as S,i as x}from"./typedArrayUtil.js";import{subclass as w}from"../core/accessorSupport/decorators/subclass.js";import{o as j,s as E,d as O,q as T,w as A,b as D,p as G,i as I,k as R,F as C,n as L,l as P,g as U,a as V,c as z,f as H}from"./vec3.js";import{c as k,f as F,a as N}from"./vec3f64.js";import{d as X,m as Y,n as Z,j as B,k as W,c as q}from"./elevationInfoUtils.js";import{E as Q}from"./ElevationInfo.js";import{a as J,b as K}from"./screenUtils.js";import"./Logger.js";import"../core/Error.js";import $ from"../Color.js";import tt from"../core/Accessor.js";import{c as et}from"./asyncUtils.js";import{throwIfAborted as it}from"../core/promiseUtils.js";import{h as at}from"./quantityFormatUtils.js";import{s as ot,f as nt,n as st,j as rt,l as lt,i as pt}from"./vec2.js";import{c as ht,f as ct}from"./vec2f64.js";import{i as ut,n as dt}from"../geometry/Polygon.js";import{f as mt}from"./messages.js";import{g as gt}from"./getDefaultUnitForView.js";import{T as _t}from"./TextOverlayItem.js";import{d as ft,c as yt,T as vt,S as Mt,a as bt,e as St,f as xt}from"./automaticLengthMeasurementUtils.js";import{a as wt}from"./viewUtils.js";import{S as jt}from"./SnappingVisualizer3D.js";import{M as Et}from"./interfaces6.js";import{S as Ot,O as Tt}from"./OutlineVisualElement.js";import{E as At}from"./ExtendedLineVisualElement.js";import{V as Dt}from"./VerticesVisualElement.js";import{e as Gt,E as It}from"./ElevationContext.js";import{G as Rt}from"./GraphicState.js";import{R as Ct}from"./Material.js";import{D as Lt,g as Pt,m as Ut,a as Vt,c as zt,u as Ht}from"./editPlaneUtils.js";import{D as kt,S as Ft,E as Nt}from"./drawSurfaces.js";import{getDrawMeshHelpMessage as Xt}from"./helpMessageUtils3d.js";import Yt from"../core/Collection.js";import Zt from"../core/Evented.js";import{z as Bt,A as Wt,c as qt,s as Qt,B as Jt}from"./unitFormatUtils.js";import{U as Kt}from"./UpdatingHandles.js";import{m as $t}from"./dehydratedPoint.js";import{M as te,R as ee,c as ie,g as ae,d as oe,p as ne,a as se}from"./manipulatorUtils.js";import{e as re}from"./constraints.js";import{b as le,S as pe,g as he,i as ce}from"./isSupportedGraphic.js";import{c as ue}from"./manipulatorUtils2.js";import{d as de,c as me,r as ge}from"./mathUtils.js";import{signal as _e}from"../core/signal.js";import{L as fe}from"./LaserlineVisualElement.js";import{p as ye}from"./projectPointToVector.js";import{p as ve}from"./projectVectorToVector.js";import{c as Me,m as be,G as Se}from"./aaBoundingBox.js";import{h as xe}from"./aaBoundingRect.js";import{P as we}from"./PointVisualElement.js";import je from"../core/Handles.js";import{d as Ee,z as Oe,m as Te,f as Ae,y as De,p as Ge,n as Ie,c as Re,w as Ce,r as Le}from"./mat4.js";import{a as Pe,f as Ue,I as Ve}from"./mat4f64.js";import{s as ze,b as He,w as ke,i as Fe}from"./vector.js";import{b as Ne,c as Xe,d as Ye,e as Ze,f as Be,g as We,s as qe}from"./dragEventPipeline3D.js";import{d as Qe,b as Je,c as Ke,e as $e,f as ti,g as ei,E as ii,h as ai,I as oi,i as ni,j as si,s as ri,k as li}from"./dragEventPipeline.js";import{C as pi}from"./basicInterfaces.js";import{o as hi,t as ci,k as ui,p as di,e as mi,a as gi,f as _i}from"./GeometryUtil.js";import{C as fi}from"./ColorMaterial.js";import{a as yi,M as vi}from"./interfaces5.js";import{G as Mi}from"./GraphicManipulator.js";import{E as bi,P as Si,O as xi,A as wi,b as ji}from"./EditGeometryOperations.js";import Ei from"../views/interactive/sketch/SketchTooltipOptions.js";import{S as Oi}from"./SnappingContext.js";import{c as Ti}from"./SnappingDragPipelineStep.js";import{T as Ai,a as Di,b as Gi,c as Ii,d as Ri,e as Ci}from"./TranslateTooltipInfos.js";import{v as Li,g as Pi,h as Ui}from"./euclideanLengthMeasurementUtils.js";import"../geometry.js";import{g as Vi,R as zi,ae as Hi}from"./unitUtils.js";import ki from"../geometry/Polyline.js";import{n as Fi,f as Ni,c as Xi,p as Yi,o as Zi}from"./plane.js";import{l as Bi}from"./utils8.js";import{M as Wi}from"./IViewEvents.js";import{a as qi}from"./automaticAreaMeasurementUtils.js";import Qi from"../geometry/SpatialReference.js";import Ji from"../views/interactive/sketch/SketchLabelOptions.js";import Ki from"../geometry/Point.js";import{V as $i}from"./ViewingMode.js";import{b as ta}from"./Cyclical.js";import{addFrameTask as ea}from"../core/scheduling.js";import{c as ia,d as aa,g as oa,e as na,a as sa}from"./axisAngleDegrees.js";import ra from"../geometry/support/MeshTransform.js";import{S as la,O as pa,I as ha,R as ca,k as ua,l as da,d as ma,v as ga,F as _a,G as fa,q as ya,H as va,J as Ma}from"./ShiftManipulator.js";import{a as ba,c as Sa,u as xa}from"./boundedPlane.js";import{g as wa}from"./Factory.js";import{a as ja}from"./ray.js";import{E as Ea,a as Oa}from"./ExtentTooltipInfos.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"../config.js";import"../core/lang.js";import"./utils.js";import"./metadata.js";import"./tracking.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./nextTick.js";import"./PooledArray.js";import"./time.js";import"./shared.js";import"./SimpleObservable.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./Ellipsoid.js";import"./jsonMap.js";import"../core/JSONSupport.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./assets.js";import"./arcadeOnDemand.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./Axis.js";import"./extentUtils.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./colorUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./projector.js";import"./widgetUtils.js";import"./themeUtils.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"../widgets/Widget.js";import"./domUtils.js";import"./uuid.js";import"./dom.js";import"./index.js";import"./legacyIcon.js";import"./memoize.js";import"./keybindings.js";import"./messageBundle.js";import"../geometry/geometryEngine.js";import"./geometryEngineBase.js";import"./_commonjsHelpers.js";import"./hydrated.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectVectorToWGS84ComparableLonLat.js";import"../geometry/support/geodesicUtils.js";import"./vec4f32.js";import"./EngineVisualElement.js";import"../core/Identifiable.js";import"./RenderGeometry.js";import"./FloatsPassUniform.js";import"./mat3.js";import"./mat3f64.js";import"./interfaces3.js";import"./ShaderBuilder.js";import"./Util.js";import"./OverlayCompositing.glsl.js";import"./ScreenSpacePass.glsl.js";import"./VertexAttribute.js";import"./FloatPassUniform.js";import"./IntegerPassUniform.js";import"./Texture2DPassUniform.js";import"./SceneLighting.js";import"./MemCache.js";import"./enums3.js";import"./FramebufferObject.js";import"./BufferObject.js";import"./Texture.js";import"./contextUtils.js";import"./ShaderOutput.js";import"./VertexNormal.glsl.js";import"./compilerUtils.js";import"./ForwardLinearDepth.glsl.js";import"./View.glsl.js";import"./Float3PassUniform.js";import"./Matrix4PassUniform.js";import"./Matrix3PassUniform.js";import"./Float2PassUniform.js";import"./EvaluateAmbientLighting.glsl.js";import"./PiUtils.glsl.js";import"./RgbaFloat16Encoding.glsl.js";import"./Float4PassUniform.js";import"./Texture2DDrawUniform.js";import"./WaterSurface.glsl.js";import"./Slice.glsl.js";import"./Transform.glsl.js";import"./ObjectAndLayerIdColor.glsl.js";import"./OutputHighlight.glsl.js";import"./ColorConversion.glsl.js";import"./ReadLinearDepth.glsl.js";import"./NormalUtils.glsl.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"./enumeration.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./RenderState.js";import"./BooleanPassUniform.js";import"./AlphaCutoff.js";import"./TransparencyPassType.js";import"./TextureOnly.glsl.js";import"./NestedMap.js";import"./ShaderTechniqueConfiguration.js";import"./RenderPlugin.js";import"./Camera.js";import"./frustum.js";import"./VertexElementDescriptor.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./Attribute.js";import"./ContentObject.js";import"./Geometry.js";import"./Indices.js";import"./triangle.js";import"./lineSegment.js";import"./doublePrecisionUtils.js";import"./TriangleMaterial.js";import"./sphere.js";import"./mathUtils2.js";import"./Octree.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./types.js";import"./DefaultBufferWriter.js";import"./RenderSlot.js";import"./MarkerSizing.glsl.js";import"./VisualVariables.glsl.js";import"./floatRGBA.js";import"./Texture2.js";import"./InstancedDoublePrecision.glsl.js";import"./requestImageUtils.js";import"./RibbonLine.glsl.js";import"./OutputDepth.glsl.js";import"./Program2.js";import"./OrderIndependentTransparency.js";import"./renderState2.js";import"./MultipassGeometryTest.glsl.js";import"./Intersector.js";import"./Intersector2.js";import"./verticalOffsetUtils.js";import"./orientedBoundingBox.js";import"./quat.js";import"./quatf64.js";import"./glUtil.js";import"./DefaultLayouts.js";import"./Scheduler.js";import"./debugFlags.js";import"./VisualElement.js";import"./RightAngleQuadVisualElement.js";import"./snappingUtils.js";import"./timeUtils.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./FullTextSearch.js";import"../core/Clonable.js";import"./QuantizationParameters.js";import"../rest/support/StatisticDefinition.js";import"./InputManager.js";import"./Queue.js";import"./PropertiesPool.js";import"./Settings.js";import"./LineSnappingHint.js";import"./lineStippleUtils.js";import"./DoubleArray.js";import"./line.js";import"./line2.js";import"./triangulationUtils.js";import"./earcut.js";import"./deduplicate.js";import"./Object3DVisualElement.js";import"./computeTranslationToOriginAndRotation.js";import"./dehydratedFeatureUtils.js";import"./graphicUtils.js";import"../geometry/projection.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./hydratedFeatures.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"./Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./ElevationProvider.js";import"../layers/GraphicsLayer.js";import"./GraphicsCollection.js";import"../layers/Layer.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"../layers/mixins/ScaleRangeLayer.js";import"../geometry/Circle.js";import"./surfaceCoordinateSystems.js";import"./mat2d.js";import"./mat2df64.js";import"./helpMessageUtils.js";import"./coordinateSystem.js";import"./spatialReferenceEllipsoidUtils.js";import"./projectVectorToPoint.js";import"./measurementUtils2.js";import"./diffUtils.js";import"./dehydratedFeatureComparison.js";import"./SnappingOperation.js";import"./ByteSizeUnit.js";import"./ShadedColorMaterial.glsl.js";import"./geometry2dUtils.js";import"./LaserlinePath.glsl.js";import"./Laserline.glsl.js";import"./CameraSpace.glsl.js";import"./Laserlines.glsl.js";import"./HUDMaterial.js";import"./HUDVisibility.glsl.js";import"./VerticalOffset.glsl.js";import"./GLTextureMaterial.js";import"./HUDMaterial.glsl.js";import"./drawUtils.js";import"./vec3f32.js";import"./ColorMaterial.glsl.js";import"./VertexColor.glsl.js";import"./defaults.js";import"./defaultsJSON.js";import"./drapedUtils.js";import"./IntersectionSnappingHint.js";import"./PointSnappingHint.js";import"../symbols/support/cimSymbolUtils.js";import"./utils9.js";import"./LRUCache.js";import"./euclideanAreaMeasurementUtils.js";import"./ImageMaterial.js";import"./ImageMaterial.glsl.js";import"../analysis/SlicePlane.js";import"./persistable.js";import"./MD5.js";import"./multiOriginJSONSupportUtils.js";import"./resourceExtension.js";import"./LineVisualElement.js";import"./RenderCoordsHelper.js";import"./projectVectorToDehydratedPoint.js";const Ta={default:15,far:25};let Aa=class extends tt{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=et((async t=>{const e=await mt("esri/core/t9n/Units");it(t),this._messagesUnits=e}));this.addHandles([m((()=>[null!=this.context&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((t=>g((()=>this.context?.editGeometryOperations),t,(()=>this._update())))),r((()=>t.abort())),m((()=>this._colors),(t=>this._updateStyle(t)))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return null==this._messagesUnits}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((t=>t.label.text))}}get _edgeDistancePixels(){return Ta[this.edgeDistance]}get _colors(){const t=this.context?.view.effectiveTheme.textColor??$.fromArray([255,255,255]);return{textColor:t,backgroundColor:e(i(t,a.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const t=this.context;if(null==t)return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:a}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const o=e.length;for(let n=0;n<o;++n){const s=[];if(e[n].iterateVertices((t=>{s.push(a.toXYZ(t.pos))})),0===n&&null!=this.stagedVertex&&s.push(a.toXYZ(this.stagedVertex)),s.length<2)continue;const r=s[0],l=s[s.length-1];"polygon"===i.type&&s.length>2&&!j(r,l)&&s.push(r);const p=1===o&&!ut(s);let h=Ia,c=Ra;this.toScreenPointArray(t,r,h);for(let e=1;e<s.length;++e){const i=s[e-1],a=s[e];this.toScreenPointArray(t,a,c),this._addLabel(t,i,h,a,c,p),[h,c]=[c,h]}}this._destroyUnusedLabels()}_updateStyle({textColor:t,backgroundColor:e}){const i=this._nextLabelIndex,a=this._labelInfos;for(let o=0;o<i;++o){const{label:i}=a[o];i.textColor=t,i.backgroundColor=e}}_addLabel(t,e,i,a,o,n){const{label:s}=this._getOrCreateLabel(t);if(!this.visible||ot(i,o)<3025)return void(s.visible=!1);const r=null!=t.graphicState?t.graphicState.isDraped?"on-the-ground":"absolute-height":X(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:l}=t.editGeometryOperations.data,p=ft(e,a,l,r),h=this._messagesUnits,c=gt(t.view);s.text=null!=h&&null!=p?at(h,p,c):"",s.visible=!0;const u=o[0]-i[0],d=o[1]-i[1];n?nt(Da,-d,u):nt(Da,d,-u),st(Da,Da),rt(Da,Da,this._edgeDistancePixels),lt(Ga,i,o,.5),pt(Ga,Ga,Da),s.position=[Ga[0],Ga[1]],Math.abs(Da[0])>Math.abs(Da[1])?s.anchor=Da[0]>0?"left":"right":s.anchor=-Da[1]<0?"top":"bottom"}_getOrCreateLabel(t){const e=this._labelInfos.length>this._nextLabelIndex,{textColor:i,backgroundColor:a}=this._colors;if(e){const t=this._labelInfos[this._nextLabelIndex++],{label:e}=t;return e.textColor=i,e.backgroundColor=a,t}const o=new _t({anchor:"center",fontSize:10,textColor:i,backgroundColor:a});t.view.overlay?.items.add(o);const n={label:o};return this._labelInfos.push(n),this._nextLabelIndex=this._labelInfos.length,n}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){this.context?.view.overlay?.items.remove(t),t.destroy()}};t([M()],Aa.prototype,"context",void 0),t([M()],Aa.prototype,"stagedVertex",void 0),t([M()],Aa.prototype,"visible",void 0),t([M()],Aa.prototype,"edgeDistance",void 0),t([M()],Aa.prototype,"updating",null),t([M()],Aa.prototype,"_messagesUnits",void 0),t([M()],Aa.prototype,"_edgeDistancePixels",null),t([M()],Aa.prototype,"_colors",null),Aa=t([w("esri.views.interactive")],Aa);const Da=ht(),Ga=ht(),Ia=J(),Ra=J();let Ca=class extends Aa{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,o=J()){const{spatialReference:n}=i.data.coordinateHelper;return wt(a,n,e,t,La),t.state.camera.projectToScreen(La,o),o}};Ca=t([w("esri.views.3d.interactive.SegmentLabels3D")],Ca);const La=k();function Pa(t){const{graphic:e}=t;return[m((()=>t.displaying),(t=>{t?function(t){const{geometry:e}=t;Va(e)&&t.notifyMeshTransformChanged({action:Et.EnableFastUpdates})}(e):Ua(e)}),{..._}),r((()=>Ua(e)))]}function Ua(t){const{geometry:e}=t;Va(e)&&t.notifyMeshTransformChanged({action:Et.DisableFastUpdates})}function Va(t){return"mesh"===t?.type&&!t.vertexSpace.isGeoreferenced}let za=class extends Lt{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new Ot({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Q({mode:t,offset:e})}normalizeCtorArgs(t){if(!t.elevationInfo){const e=t.hasZ??!0;return{...t,elevationInfo:Y(e)}}return t}initializeGraphic(t){const{view:e}=this,i=this._createGraphicState=new Rt({graphic:t});return l([e.maskOccludee(t),e.trackGraphicState(i),m((()=>({element:this._outlineVisualElement,isDraped:i.isDraped})),(({element:t,isDraped:e})=>{t&&(t.isDraped=e)}),_),this._setupLoadingIndicator(i),...Pa(i)])}updateDrawMeshTooltipInfo(t){const{graphic:e,tooltipOptions:i,view:a}=this;t.tooltipOptions=i,t.viewType=a.type,t.helpMessage=Xt(e,this.view),this.updateElevation(t.elevation)}makeDrawOperation(){const{geometryType:t}=this,e="circle"!==t&&"rectangle"!==t;return new kt({view:this.view,manipulators:this.manipulators,geometryType:Pt(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Ft(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Nt(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new jt,segmentLabels:e?new Ca:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===Z(this.hasZ,this.elevationInfo),cursor:this.cursor})}onActiveVertexChanged(t){const{view:e}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[t],this._updateVerticalLineVisualElement(t),r();const i=this._settings,a=i.manipulators.vertex,n=new Dt({view:e,spatialReference:e.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=n;const s=i.visualElements.zVerticalLine,p=new At({view:e,extensionType:s.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Ct.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=p;const h=l([m((()=>i.visualElements.zVerticalLine),(t=>t.apply(p)),y),m((()=>({selectedColor:o(i.colors.selected),outlineColor:o(i.manipulators.vertex.outlineColor)})),(({selectedColor:t,outlineColor:e})=>{n.color=t,n.outlineColor=e}),y),r((()=>{this._activeVertexVisualElement=u(this._activeVertexVisualElement),this._verticalLineVisualElement=u(this._verticalLineVisualElement)}))]);return n.attached=!0,h}_updateVerticalLineVisualElement(t){const e=this._verticalLineVisualElement;if(!e)return;const{renderCoordsHelper:i,elevationProvider:a}=this.view;E(ka,t[0],t[1],t[2]),Ha.setFromElevationInfo(this.elevationInfo),ka[2]=Gt(ka,a,Ha,i),i.toRenderCoords(ka,this.view.spatialReference,ka)?(e.setStartEndFromWorldDownAtLocation(ka),e.attached=!0):e.attached=!1}onOutlineChanged(t){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=t,r();const e=this.internalGraphicsLayer.elevationInfo,{view:i}=this,a=this._settings,o=new Tt({view:i,geometry:t,elevationInfo:e,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===Z(this.hasZ,e),attached:!1,isDecoration:!0});this._outlineVisualElement=o;const n=l([m((()=>a.visualElements.lineGraphics.outline),(t=>t.apply(o)),y),m((()=>a.visualElements.lineGraphics.shadowStyle),(t=>t.apply(o)),y),r((()=>{this._outlineVisualElement=u(this._outlineVisualElement)}))]);return o.attached=!0,o.laserlineEnabled=!0,n}onRegularVerticesChanged(t){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=t,r();const{view:e}=this,i=this._settings,a=i.manipulators.vertex,n=new Dt({view:e,spatialReference:e.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0}),s=l([m((()=>({color:o(i.manipulators.vertex.color),outlineColor:o(i.manipulators.vertex.outlineColor)})),(({color:t,outlineColor:e})=>{n.color=t,n.outlineColor=e}),y),r((()=>{this._verticesVisualElement=u(this._verticesVisualElement)}))]);return n.attached=!0,this._verticesVisualElement=n,s}updateGraphicGeometry(t,e){if("mesh"===this.geometryType&&"point"===e?.type){const i=this.geometryToPlace;return i&&i.centerAt(e),void(i&&t.geometry===i?i.vertexSpace.isGeoreferenced?t.notifyGeometryChanged():t.notifyMeshTransformChanged():t.geometry=i)}super.updateGraphicGeometry(t,e)}_setupLoadingIndicator(t){const{drawOperation:e}=this;if(!this.geometryToPlace)return e.loading=!1,null;e.loading=!0;const i=r((()=>{e.loading=!1}));let a;const o=()=>a&&cancelAnimationFrame(a);return l([f((()=>t.displaying),(()=>{o(),a=requestAnimationFrame((()=>i.remove()))}),{..._,once:!0}),r(o),i])}};t([M({constructOnly:!0})],za.prototype,"elevationInfo",void 0),t([M({constructOnly:!0})],za.prototype,"geometryType",void 0),t([M()],za.prototype,"type",void 0),t([M({constructOnly:!0})],za.prototype,"view",void 0),za=t([w("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],za);const Ha=new It,ka=k();function Fa(t){if(null==t||"polyline"!==t.type&&"polygon"!==t.type)return 0;const e="polyline"===t.type?t.paths:t.rings;for(const t of e)for(let e=0;e<t.length-1;e++){const i=t[e],a=t[e+1],o=i[0]-a[0],n=i[1]-a[1];if(o*o+n*n>re)return Math.atan2(a[1]-i[1],a[0]-i[0])}return 0}var Na,Xa;!function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"}(Na||(Na={})),function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"}(Xa||(Xa={}));class Ya{constructor(){this.grabbingState=Na.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=Na.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator(((t,e)=>{if(e===Xa.TRANSLATE_Z&&(this.zManipulator=t),t instanceof te&&(t.selected&&(0===this.numSelected&&(this.firstSelected=t),this.numSelected++),null==this.firstGrabbedXY&&t.grabbing&&e===Xa.TRANSLATE_XY&&(this.firstGrabbedXY=t)),t.grabbing)switch(this.grabbingState|=Na.ANY,e){case Xa.TRANSLATE_Z:this.grabbingState|=Na.Z;break;case Xa.TRANSLATE_XY:this.grabbingState|=Na.XY}}))}}function Za(t){return null!=t.geometry&&("polygon"===t.geometry.type||"polyline"===t.geometry.type)}const Ba=k();function Wa(t){const{view:e,graphic:i}=t,a=new Rt({graphic:i}),o=[],n=function(t,e,i){const{view:a,graphic:o}=t,n=new we({view:a,geometry:qa(o),elevationInfo:B(o),isDecoration:!0});return function(t,e,i,a){const o=new Ot({getTheme:()=>t.view.effectiveTheme});(function(t,e,i,a){const{view:o,graphic:n}=t;let s=null;const r=()=>{const t=qa(n);(t=>{null!=s&&(s.remove(),s=null),i.isDraped&&null!=t&&(s=function(i,a,o){const n=i.elevationProvider.spatialReference;ye(a,Qa,n);const s=Qa[0],r=Qa[1];return i.elevationProvider.on("elevation-change",(i=>{xe(i.extent,s,r)&&(e.geometry=t)}))}(o,t))})(t),e.geometry=t};a.push(i.on("changed",r),c((()=>s))),r()})(t,e,i,a),o.visualElements.pointGraphics.outline.apply(e),a.push(m((()=>i.displaying),(()=>{e.attached=i.displaying}),y))}(t,n,e,i),i.push(h(n)),n}(t,a,o);return function(t,e,i,a){const{view:o,graphic:n}=t,s=new Ot({getTheme:()=>o.effectiveTheme}),r=new At({view:o,extensionType:s.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Ct.OccludeAndTransparent,isDecoration:!0});i.push(m((()=>s.visualElements.zVerticalLine),(t=>t.apply(r)),y));const l=new fe({view:o,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),p=de(s.visualElements.heightPlaneAngleCutoff),c=new fe({view:o,attached:!1,angleCutoff:p,isDecoration:!0}),u=B(t.graphic),d=It.fromElevationInfo(u),g="on-the-ground"===u.mode||!u.offset&&"absolute-height"!==u.mode,_=new Ya,f=_e(1);i.push(m((()=>({heightPlane:s.visualElements.heightPlane,alpha:f.value})),(({heightPlane:t,alpha:e})=>t.apply(c,e)),y));const v=_e(1);i.push(m((()=>({shadowStyle:s.visualElements.pointGraphics.shadowStyle,alpha:v.value})),(({shadowStyle:t,alpha:e})=>t.apply(l,e)),y));const M=()=>{_.update(t);const i=qa(n),p=g&&(e.isDraped||null==i||!i.hasZ);let h=!0;if(p||null==i)h=!1;else{const t=Gt(i,o.elevationProvider,d,o.renderCoordsHelper);E(Qa,i.x,i.y,t),ve(Qa,i.spatialReference,Qa,o.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(Qa),l.intersectsWorldUpAtLocation=Qa}const u=_.grabbingState&Na.Z?s.visualElements.laserlineAlphaMultiplier:1;f.value=u;const m=be(Ja);!p&&e.displaying&&a.calculateMapBounds(m)&&ve(Se(m,Qa),o.spatialReference,Qa,o.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=Qa,c.attached=!0):c.attached=!1;const y=_.grabbingState&Na.XY?s.visualElements.laserlineAlphaMultiplier:1;v.value=y;const M=h&&e.displaying&&!p;l.attached=M,r.attached=M};i.push(m((()=>[e.displaying,e.isDraped]),M),e.on("changed",M)),t.forEachManipulator((t=>{i.push(t.events.on("grab-changed",M))})),i.push(h(l)),i.push(h(r)),i.push(h(c)),M()}(t,a,o,n),o.push(e.trackGraphicState(a)),{visualElement:n,remove:()=>p(o)}}function qa(t){const e=t.geometry;return null==e?null:"point"===e.type?e:"mesh"===e.type?e.anchor.clone():null}const Qa=k(),Ja=Me();function Ka(t){switch(t.graphic.geometry.type){case"point":case"mesh":return Wa(t);case"polygon":case"polyline":return function(t){const{view:e,graphic:i}=t,a=new Rt({graphic:i}),o=function(t,e){const{view:i,graphic:a}=t,o=new Tt({view:i,geometry:Za(a)?a.geometry:null,elevationInfo:B(a),attached:!1,isDecoration:!0}),n=new Ot({getTheme:()=>i.effectiveTheme}),s=()=>{o.attached=e.displaying},r=l([m((()=>n.visualElements.lineGraphics.outline),(t=>t.apply(o)),y),m((()=>n.visualElements.lineGraphics.shadowStyle),(t=>t.apply(o)),y),m((()=>e.displaying),s),m((()=>e.isDraped),(t=>{o.isDraped=t})),e.on("changed",(()=>o.geometry=Za(a)?a.geometry:null)),h(o)]);return s(),{visualElement:o,remove:()=>r.remove()}}(t,a),n=function(t,e,i){const{graphic:a,view:o}=t,n=[],s=B(a),r="on-the-ground"===s.mode||!s.offset&&"absolute-height"!==s.mode,u=new Ya,d=new Ot({getTheme:()=>o.effectiveTheme}),g=d.visualElements,_=new At({view:o,extensionType:g.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Ct.OccludeAndTransparent,isDecoration:!0}),f=de(g.heightPlaneAngleCutoff),v=new fe({view:o,attached:!1,angleCutoff:f,isDecoration:!0}),M=_e(1);n.push(m((()=>({lineShadowStyle:d.visualElements.lineGraphics.shadowStyle,pointShadowStyle:d.visualElements.pointGraphics.shadowStyle,alpha:M.value})),(({lineShadowStyle:t,pointShadowStyle:i,alpha:a})=>{t.apply(e,a),i.apply(_,a)}),y));const b=_e(1);n.push(m((()=>({heightPlane:d.visualElements.heightPlane,alpha:b.value})),(({heightPlane:t,alpha:e})=>t.apply(v,e)),y));const S=()=>{if(u.update(t),!i.displaying||r&&(i.isDraped||!Za(a)||!a.geometry.hasZ))return e.laserlineEnabled=!1,_.attached=!1,void(v.attached=!1);e.laserlineEnabled=!0;const o=u.grabbingState&Na.XY?g.laserlineAlphaMultiplier:1;M.value=o;const n=u.grabbingState&Na.Z?g.laserlineAlphaMultiplier:1;b.value=n,function(t,e){const i=1===e.numSelected?e.firstSelected:e.numSelected>1&&null!=e.firstGrabbedXY?e.firstGrabbedXY:null;null!=i?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}(_,u),function(t,e,i,a){if(a.numSelected>0){E(Ba,0,0,0);let e=0;t.forEachManipulator(((t,i)=>{i===Xa.TRANSLATE_XY&&t.selected&&t instanceof te&&(O(Ba,Ba,t.renderLocation),e++)})),e>0?(i.heightManifoldTarget=T(Ba,Ba,1/e),i.attached=!0):i.attached=!1}else{const a=e.attachmentOrigin;null!=a&&t.view.renderCoordsHelper.toRenderCoords(a,Ba)?(i.heightManifoldTarget=Ba,i.attached=!0):i.attached=!1}}(t,e,v,u)};n.push(m((()=>d.visualElements.zVerticalLine),(t=>t.apply(_)),y)),n.push(i.on("changed",S),m((()=>i.displaying),S),e.events.on("attachment-origin-changed",S),h(_),h(v));const x=[],w=()=>{p(x),x.length=0,t.forEachManipulator((t=>x.push(t.events.on("grab-changed",S)))),t.forEachManipulator((t=>x.push(t.events.on("select-changed",S)))),S()};return w(),n.push(t.onManipulatorsChanged(w),c((()=>l(x)))),l(n)}(t,o.visualElement,a),s=[o,n,e.maskOccludee(i),e.trackGraphicState(a)];return{visualElement:o.visualElement,remove:()=>p(s)}}(t);default:return null}}const $a=70,to=Math.ceil($a/3*2),eo=5*Math.PI/12,io=1*Math.PI/3;class ao{constructor(){this._available=!0}set location(t){this._forEachManipulator3D((e=>e.location=t))}set elevationAlignedLocation(t){this._forEachManipulator3D((e=>e.elevationAlignedLocation=t))}set elevationInfo(t){this._forEachManipulator3D((e=>e.elevationInfo=t))}get renderLocation(){let t;return this._forEachManipulator3D((e=>{t||(t=e.renderLocation)})),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D((e=>e.available=t))}get hovering(){return this.someManipulator((t=>t.hovering))}get grabbing(){return this.someManipulator((t=>t.grabbing))}get dragging(){return this.someManipulator((t=>t.dragging))}hasManipulator(t){return this.someManipulator((e=>e===t))}someManipulator(t){let e=!1;return this.forEachManipulator((i=>{!e&&t(i)&&(e=!0)})),e}_forEachManipulator3D(t){this.forEachManipulator(((e,i)=>{e instanceof te&&t(e,i)}))}}function oo(t,e,i,a){const o=(i,a)=>e({action:i,graphic:t,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY});return i(((e,i,n)=>(i.next((t=>("start"===t.action&&o("start",t),t))).next(Qe(t,a)).next((t=>{switch(t.action){case"start":case"update":(t.translationX||t.translationY||t.translationZ)&&o("update",t);break;case"end":o("end",t)}return t})),{steps:i,cancel:n=n.next(Je(t)).next((t=>(o("end",{screenDeltaX:0,screenDeltaY:0}),t)))})))}function no(t){if(null==t?.axis)return 1;const{mapStart:e,mapEnd:i,axis:a}=t,o=[i.x-e.x,i.y-e.y];return o[0]*a[0]+o[1]*a[1]>0?1:-1}class so extends ao{constructor(t){super(),this._handles=new je,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=$a,this._updateAfterDrag=!1,this.events=new Zt,this._tool=t.tool,this._view=t.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),null!=t.radius&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=u(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:e}of this._arrowManipulatorInfos)t(e,Xa.TRANSLATE_XY)}createGraphicDragPipeline(t,e,i){const a=e.graphic,o=B(a),n=a.geometry.spatialReference;return oo(a,i,(e=>this.createDragPipeline(((i,a,o,n,s)=>(({steps:a,cancel:o}=t(i,a,o,n,s)),e(i,a,o))),o,n,a)),this._view.state.viewingMode)}createDragPipeline(t,e,i,a){return l(this._arrowManipulatorInfos.map((({manipulator:o},n)=>Ke(o,((o,s,r,l,p)=>{const h=s.next((t=>({...t,manipulatorType:Xa.TRANSLATE_XY}))).next($e(this._view,o.elevationAlignedLocation)).next(Ne(this._view,o.elevationAlignedLocation,e,i,a)).next(ti(o.location,this.angle+(n+1)*Math.PI*.5)).next(ei());t(o,h,r,l,p)})))))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:e},i){const a=this._radius/$a,o=54*a,n=o*Math.sqrt(3)/2,s=hi(this._opaqueMaterial,n,o/2,o/2,.02);ci(s,Ee(He.get(),E(ze.get(),0,-n/3,0))),t.renderObjects=[new ee(s,yi.Focused),new ee(s.instantiate({material:this._transparentMaterial}),yi.Unfocused)],t.radius=n/3*2*1.2;const r=Oe(He.get(),i*Math.PI/2),l=Ee(He.get(),E(ze.get(),0,100*a,0));Te(e,r,l)}_createManipulators(){for(let t=0;t<4;t++){const e=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(e)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,e=Ae(He.get(),t,F(0,0,1));if(null==e)return;const i=De(He.get(),E(ze.get(),this.displayScale,this.displayScale,this.displayScale)),a=Te(He.get(),i,e);for(const t of this._arrowManipulatorInfos){const e=Te(He.get(),a,t.transform);t.manipulator.modelTransform=e}}_createArrowManipulator(t){const e=new te({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:F(0,0,1)}}),i={manipulator:e,transform:Pe()};return this._updateArrowManipulator(i,t),this._handles.add(e.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}_createMaterial(t=1){const e=new fi({cullFace:pi.Back,renderOccluded:Ct.Transparent,isDecoration:!0});return this._handles.add(m((()=>$.toUnitRGBA(this._view.effectiveTheme.accentColor)),(i=>{i[3]*=t,e.setParameters({color:i})}),y)),e}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:t})=>t))}}}class ro{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const e=this._lastDragEvent.mapEnd,i=this._snap(this._lastDragEvent.screenEnd);if(null!=i){const a={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:!0===t?i:e,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(a)}}this._enabled=t}_snap(t){const e=null!=this._view?this._view.toMap(t,{exclude:[]}):null;return null!=e&&null!=this._view&&(e.z=W(e,this._view,this._elevationInfo)),e}createDragEventPipelineStep(t,e){this._view=t,this._elevationInfo=e,this._lastDragEvent=null;const i=new ii;return this._next=i,[t=>{if(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled){const e=this._snap(t.screenEnd);return null!=e?{action:t.action,mapStart:t.mapStart,mapEnd:e,screenStart:t.screenStart,screenEnd:t.screenEnd}:null}return{action:t.action,mapStart:t.mapStart,mapEnd:t.mapEnd,screenStart:t.screenStart,screenEnd:t.screenEnd}},i]}}class lo extends ao{constructor(t){super(),this._handles=new je,this._snapToScene=new ro,this._scale=1,this._radius=$a,this._view=t.view,this._tool=t.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),null!=t.snapToScene&&(this.snapToScene=t.snapToScene),null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles=u(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,Xa.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,e,i){const a=e.graphic,o=B(a),n=a.geometry.spatialReference;return oo(a,i,(e=>this.createDragPipeline(((i,a,o,n,s)=>(({steps:a,cancel:o}=t(i,a,o,n,s)),e(i,a,o))),o,n,a)),this._view.state.viewingMode)}createDragPipeline(t,e,i,a){const o=this._view;return Ke(this._manipulator,((n,s,r,l,p)=>{const h=s.next($e(o,n.elevationAlignedLocation)).next(Ne(o,n.elevationAlignedLocation,e,i,a)).next(...this._snapToScene.createDragEventPipelineStep(o,e)).next((t=>({...t,manipulatorType:Xa.TRANSLATE_XY}))).next(ei());t(n,h,r,l,p)}))}_updateManipulatorTransform(){const t=De(He.get(),E(ze.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new te({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:F(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=ui(this._discMaterial,.02,1,128,F(0,0,1),F(0,0,0));t.transformation=De(Pe(),F(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new ee(t,yi.Focused),new ee(t.instantiate({material:this._discMaterialTransparent}),yi.Unfocused)],this._manipulator.radius=this._radius/$a*80}_createMaterial(t=1){const e=new fi({cullFace:pi.Back,renderOccluded:Ct.Transparent,isDecoration:!0});return this._handles.add(m((()=>$.toUnitRGBA(this._view.effectiveTheme.accentColor)),(i=>{i[3]*=t,e.setParameters({color:i})}),y)),e}get test(){return{discManipulator:this._manipulator}}}class po extends ao{constructor(t){super(),this._radius=$a,this.events=new Zt,this._tool=t.tool,this._view=t.view;const e=new Ot({getTheme:()=>this._view.effectiveTheme});this._settings=e,null!=t.radius&&(this._radius=t.radius);const i=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:ie(this._createDarkenedColor(i,1,.25),Ct.Occlude),materialFocused:ie(this._createDarkenedColor(i,1,0),Ct.Occlude),materialOccludedUnfocused:ie(this._createDarkenedColor(i,.7,0),e.zManipulator.renderOccluded),materialOccludedFocused:ie(this._createDarkenedColor(i,.85,0),e.zManipulator.renderOccluded)},this._themeHandle=m((()=>this._view.effectiveTheme.accentColor),(t=>{const e=this._createDarkenedColor(t,1,.25),i=this._createDarkenedColor(t,1,0),a=this._createDarkenedColor(t,.7,0),o=this._createDarkenedColor(t,.85,0),{materialUnfocused:n,materialFocused:s,materialOccludedUnfocused:r,materialOccludedFocused:l}=this._materials;n.setParameters({color:e}),s.setParameters({color:i}),r.setParameters({color:a}),l.setParameters({color:o})})),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._themeHandle=d(this._themeHandle),this._manipulator.applyObjectTransform=mo,this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,Xa.TRANSLATE_Z)}createGraphicDragPipeline(t,e,i){const a=e.graphic.geometry.spatialReference;return oo(e.graphic,i,(e=>this.createDragPipeline(((i,a,o,n,s)=>(({steps:a,cancel:o}=t(i,a,o,n,s)),e(i,a,o))),a)),this._view.state.viewingMode)}createDragPipeline(t,e){const i=this._view;return Ke(this._manipulator,((a,o,n,s,r)=>{const l=o.next((t=>({...t,manipulatorType:Xa.TRANSLATE_Z}))).next(Xe(i,a.renderLocation,e)).next(ei());t(a,l,n,s,r)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,e=this._radius/$a,i=t.zManipulator.height*e,a=t.zManipulator.coneHeight*e,o=t.zManipulator.coneWidth*e,n=t.zManipulator.width*e,s=[F(0,0,0),F(0,0,i)],r=[F(0,0,0),F(0,0,i+a)],l=(t=>{const e=Pe();return Ge(e,e,[0,0,i]),Ie(e,e,Math.PI/2),e})(),{materialUnfocused:p,materialFocused:h,materialOccludedUnfocused:c,materialOccludedFocused:u}=this._materials,d=di(p,s,n/2,16,!1),m=mi(p,a,o/2,16,!1);m.transformation=l,this._manipulator.renderObjects=[new ee(m,yi.Unfocused),new ee(d,yi.Unfocused),new ee(m.instantiate({material:h}),yi.Focused),new ee(d.instantiate({material:h}),yi.Focused),new ee(m.instantiate({material:c}),yi.Unfocused),new ee(d.instantiate({material:c}),yi.Unfocused),new ee(m.instantiate({material:u}),yi.Focused),new ee(d.instantiate({material:u}),yi.Focused)],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[r]}}_createManipulator(){const t=this._view,e=new te({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const i=t.state.camera,a=ho;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const o=A(i.eye,a),n=i.computeRenderPixelSizeAtDist(o),s=D(co,a,i.eye);G(s,s);const r=uo;t.renderCoordsHelper.worldUpAtPosition(ho,r);const l=Math.abs(I(s,r)),p=R(co,s,r),h=R(co,p,r),c=me(l,.01,1),u=1-Math.sqrt(1-c*c)/c/i.fullWidth,d=this._settings,m=this._radius/$a,g=d.zManipulator.width*m;T(h,G(h,h),(1/u-1)*o+n*g),e[12]-=co[0],e[13]-=co[1],e[14]-=co[2]},this._manipulator=e,this._updateManipulator()}_createDarkenedColor(t,e,i){const a=n(t,i);return a.a*=e,$.toUnitRGBA(a)}get test(){return{manipulator:this._manipulator}}}const ho=k(),co=k(),uo=k(),mo=()=>{};class go extends ao{constructor(t){super(),this._handles=new je,this._interactive=!0;const{tool:e,view:i,snapToScene:a,radius:o}=t;this._view=i,this.xyManipulation=new lo({tool:e,view:i,snapToScene:a,radius:o}),this.xyAxisManipulation=new so({tool:e,view:i,radius:o}),this.zManipulation=new po({tool:e,view:i,radius:o}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator((t=>this._handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,e,i){return l([this.xyManipulation.createGraphicDragPipeline(((e,i,a,o,n)=>t(fo.XY,e,i,a,o,n)),e,i),this.xyAxisManipulation.createGraphicDragPipeline(((e,i,a,o,n)=>t(fo.XY_AXIS,e,i,a,o,n)),e,i),this.zManipulation.createGraphicDragPipeline(((e,i,a,o,n)=>t(fo.Z,e,i,a,o,n)),e,i)])}createDragPipeline(t,e,i,a){return l([this.xyManipulation.createDragPipeline(((e,i,a,o,n)=>t(fo.XY,e,i,a,o,n)),e,i,a),this.xyAxisManipulation.createDragPipeline(((e,i,a,o,n)=>t(fo.XY_AXIS,e,i,a,o,n)),e,i,a),this.zManipulation.createDragPipeline(((e,i,a,o,n)=>t(fo.Z,e,i,a,o,n)),i)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator((e=>t(e,Xa.TRANSLATE_XY))),this.xyAxisManipulation.forEachManipulator((e=>t(e,Xa.TRANSLATE_XY))),this.zManipulation.forEachManipulator((e=>t(e,Xa.TRANSLATE_Z)))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator((t=>t.focused))||this.xyAxisManipulation.someManipulator((t=>t.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(b("esri-mobile"))return;const i=[];e.forEachManipulator((t=>i.push(t))),t.forEachManipulator((t=>i.push(t)));const a=()=>{const e=[];this._xyAxisVisible||t.forEachManipulator((t=>e.push(t.disableDisplay()))),this._handles.remove(_o),this._handles.add(e,_o)};for(const t of i)this._handles.add(t.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(f((()=>this._view.inputManager?.latestPointerType),a)),a()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator((e=>{e.interactive=!t&&this._interactive||e.grabbing}))}static radiusForSymbol(t){const e=null!=t&&"point-3d"===t.type&&t.symbolLayers;return e&&e.some((t=>"icon"===t.type))?to:$a}}const _o="disable-xy-axis-display";var fo;!function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"}(fo||(fo={}));class yo extends ao{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,Xa.TRANSLATE_XY)}createGraphicDragPipeline(t){return oo(this._graphicState.graphic,t,(t=>this.createDragPipeline(t)),this._view.state.viewingMode)}createDragPipeline(t){const e=this._view,i=this._graphicState.graphic,a=null!=i.geometry?i.geometry.spatialReference:null;return Ke(this._manipulator,((o,n,s,r,l)=>{const p=n.next(Ye(l,e,i,a)).next(ai()).next(ei());t(o,p,s,r,l)}))}_createManipulator(){const t=this._view,e=this._graphicState.graphic;this._manipulator=new Mi({graphic:e,view:t,selectable:!0,cursor:"move"})}}class vo{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class Mo{constructor(t,e,i){this.dx=t,this.dy=e,this.allGraphics=i,this.type="graphic-move"}}class bo{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const So="manipulators";let xo=class extends(Zt.EventedMixin(oi)){constructor(t){super(t),this._infos=new Map,this.graphics=new Yt,this.enableZ=!0,this.tooltipOptions=new Ei,this.type="move-3d",this._updatingHandles=new Kt,this._moveManipulation=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:t}=this;this.addHandles([this.graphics.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateGraphicInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),m((()=>this.tooltipOptions.enabled),(e=>{this._tooltip=e?new vt({view:t}):u(this._tooltip)}),_)]);const e=this.graphics.toArray();this._updateGraphicInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=u(this._tooltip),this._moveManipulation=u(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:t,removed:e}){for(const e of t){if(le(e)!==pe.SUPPORTED)continue;const t=new wo(e),i=this.view.trackGraphicState(t.state);this._infos.set(t.graphic,{info:t,handle:i})}for(const t of e)this._infos.get(t)?.handle.remove(),this._infos.delete(t)}_setupFastTransformUpdates(t){for(const e of t){const{info:t}=this._infos.get(e);this.addHandles(Pa(t.state),e)}}_refreshManipulators(){if(this.removeHandles(So),this._moveManipulation=u(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values(),(({info:t})=>t));this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new yo({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:i}=this;null!=i&&("start"===t?(this._translateGraphicTooltipInfo??=new Ai({tooltipOptions:e}),i.info=this._translateGraphicTooltipInfo,i.info.tooltipOptions=e,i.info.distance=Bt):i.clear())}))],So))),this.addHandles(e.manipulationXY.createDragPipeline(((e,i,a,o)=>this._buildDragEventPipeline(t,fo.XY,e,i,a,o))),So)}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new go({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?go.radiusForSymbol(t[0].graphic.symbol):$a});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(i=>{e.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.at(0)}),i.stopPropagation()})),So)}));const i=e=>i=>{this.addHandles(i.events.on("focus-changed",(({action:i})=>{const a=this._tooltip;null!=a&&("focus"===i?this._updateMoveTooltip(t,e):a.clear())})),So)};this._moveManipulation.xyManipulation.forEachManipulator(i(fo.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(fo.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(fo.Z));const a=()=>this._updateMoveManipulation(t);for(const e of t)this.addHandles([e.state.on("changed",a),m((()=>e.state.displaying),a)],So);const o=t[t.length-1];this.addHandles(o.state.on("changed",(()=>this._updateMoveManipulationAngle(o))),So),this.addHandles(e.createDragPipeline(((e,i,a,o,n)=>this._buildDragEventPipeline(t,e,i,a,o,n)),B(o.graphic),o.graphic.geometry.spatialReference,o.graphic),So),this._updateMoveManipulationAngle(o)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=Ka({view:this.view,graphic:i,forEachManipulator:t=>{e.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>r()});null!=a&&(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof Tt&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",(()=>{e.state.isDraped||this._updateMoveManipulation(t)})),m((()=>e.state.isDraped),(()=>this._updateMoveManipulation(t)))],So),this.addHandles(a,So))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=Fa(t.graphic.geometry))}_updateMoveManipulation(t){const e=$t(0,0,0,this.view.spatialReference);let i=0,a=!1;const o=this._moveManipulation;if(o){for(const o of t){if(!o.state.displaying)continue;const t=o.state.graphic;this.enableZ&&ue(t)&&(a=!0);const n=o.geometryRepresentation instanceof Tt&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:ae(this.view,t);if(null!=n){const{x:t,y:a,z:o}=n;e.x+=t,e.y+=a,o&&(e.z??=0,e.z+=o),i++}}i>0?(e.x/=i,e.y/=i,e.z??=0,e.z/=i,o.location=e,o.xyManipulation.available=!0,o.xyAxisManipulation.available=!0,o.zManipulation.available=a):o.available=!1}}_buildDragEventPipeline(t,e,i,a,o,n){const s=[],r=[];let l=null,p=null;const h=()=>{for(const t of s)t.dragging=!1;s.length=0,r.length=0,l=null,p=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&e===fo.XY){const e=t[0].graphic;({steps:a,cancel:o}=this._buildSnappingPipelineSteps(e,B(e),a,o,n))}return o=o.next((t=>p?.(t))).next((()=>(this.emit("graphic-move-stop",new bo(r)),this.destroyed||h(),null))),{steps:a=a.next((e=>{if("start"===e.action){s.length=0,r.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(i)&&e.manipulationXY?.grabbing||(s.push(e),r.push(e.graphic),e.dragging=!0);if(0!==r.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=ni(r,this.view.state.viewingMode),p=si(r),this.emit("graphic-move-start",new vo(r)),this.destroyed))return null}return 0!==r.length?e:null})).next((t=>l?.(t))).next((i=>(this._updateMoveTooltip(t,e,i),i))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),a=i.x-e.x,o=i.y-e.y;if(this.emit("graphic-move",new Mo(a,o,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new bo(r)),this.destroyed)return null;h()}return null})),cancel:o}}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:o}=this;if(null==o)return;o.clear();const n=0===t.length?"absolute-height":t[0].state.isDraped?"on-the-ground":"absolute-height";switch(e){case fo.XY:o.info=this._translateGraphicTooltipInfo??=new Ai({tooltipOptions:a}),this._updateMoveTooltipDistance(o.info,i,((t,e)=>yt(t,e,n)));break;case fo.XY_AXIS:o.info=this._translateGraphicXYTooltipInfo??=new Gi({tooltipOptions:a}),this._updateMoveTooltipDistance(o.info,i,((t,e)=>{const a=yt(t,e,n);return Wt(a,no(i))}));break;case fo.Z:o.info=this._translateGraphicZTooltipInfo??=new Di({tooltipOptions:a}),this._updateMoveTooltipDistance(o.info,i,Li)}o.info.tooltipOptions=a}_updateMoveTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:o}=e,n=i(a,o);t.distance=null!=n?n:Bt}else t.distance=Bt}_buildSnappingPipelineSteps(t,e,i,a,o){const n=t.geometry;if(null==n||"point"!==n.type&&"mesh"!==n.type)return{steps:i,cancel:a};const s=("point"===n.type?n:n.anchor).clone(),r=new Oi({elevationInfo:e,pointer:o,editGeometryOperations:bi.fromGeometry(s,this.view.state.viewingMode),visualizer:new jt,excludeFeature:t}),l=this.snappingManager,{snappingStep:p,cancelSnapping:h}=Ti({snappingContext:r,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(h),{steps:i=i.next((e=>(s.z=q(this.view,s,B(t),{mode:"absolute-height",offset:0}),{...e,snapOrigin:r.coordinateHelper.pointToVector(s)}))).next(...p),cancel:a}}get test(){return{tooltip:this._tooltip}}};t([M({constructOnly:!0,nonNullable:!0})],xo.prototype,"view",void 0),t([M()],xo.prototype,"graphics",void 0),t([M({constructOnly:!0,nonNullable:!0})],xo.prototype,"enableZ",void 0),t([M({constructOnly:!0,type:Ei})],xo.prototype,"tooltipOptions",void 0),t([M({constructOnly:!0})],xo.prototype,"snappingManager",void 0),t([M()],xo.prototype,"type",void 0),t([M()],xo.prototype,"updating",null),xo=t([w("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],xo);class wo{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Rt({graphic:t})}get graphic(){return this.state.graphic}}function jo(t,e,i){const a="on-the-ground"===i.mode?Si.XY:Si.XYZ;return new xi(t,a,e,0)}function Eo(t,e,i){const a=k();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const o=Oo(t,e,Fi(i.plane)),n=Oo(t,e,i.edgeDirection);if(null==o||null==n)return null;const s=R(k(),o,n);return Ni(a,s,Xi())}function Oo(t,e,i){const a=$t(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),o=k(),n=k();return t.renderCoordsHelper.toRenderCoords(e,o)&&t.renderCoordsHelper.toRenderCoords(a,n)?C(n,o,n):null}let To=class extends Mt{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=Bt,this.area=null,this.totalLength=null}};t([M()],To.prototype,"type",void 0),t([M()],To.prototype,"distance",void 0),t([M()],To.prototype,"area",void 0),t([M()],To.prototype,"totalLength",void 0),To=t([w("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],To);let Ao=class extends(Zt.EventedMixin(tt)){constructor(t){super(t),this._selectedIndex=0,this._manipulatorHandles=new je,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=Lo.NONE,this._updatingHandles=new Kt,this._recreatingManipulators=!1,this._settings=new Ot({getTheme:()=>this.view.effectiveTheme}),this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null,this._translateVertexTooltipInfo=null,this._translateVertexXYTooltipInfo=null,this._translateVertexZTooltipInfo=null,this._edgeOffsetTooltipInfo=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._settings.manipulators,a=i.vertex;this._vertexManipulatorMaterial=ie(o(a.color),a.renderOccluded),this._vertexManipulatorOutlineMaterial=oe(o(a.outlineColor),a.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=oe(o(a.hoverOutlineColor),a.renderOccluded);const n=i.edge;this._edgeManipulatorMaterial=ie(o(n.color),n.renderOccluded),this._edgeManipulatorOutlineMaterial=oe(o(n.outlineColor),n.renderOccluded);const s=i.edgeOffset;this._edgeOffsetManipulatorMaterial=ie(o(s.color),s.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=ie(o(s.hoverColor),s.renderOccluded,!1);const r=i.selected;this._selectedManipulatorMaterial=ie(o(r.color),r.renderOccluded),this._selectedManipulatorOutlineMaterial=oe(o(r.outlineColor),r.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=oe(o(r.hoverOutlineColor),r.renderOccluded);const l=this._graphicState=new Rt({graphic:t});this._tooltip=new vt({view:e}),this.addHandles([m((()=>{const t=this._settings.manipulators;return{vertexSettings:t.vertex,edgeSettings:t.edge,edgeOffsetSettings:t.edgeOffset,selectedSettings:t.selected}}),(({vertexSettings:t,edgeSettings:e,edgeOffsetSettings:i,selectedSettings:a})=>{t.applyColor(this._vertexManipulatorMaterial),t.applyOutline(this._vertexManipulatorOutlineMaterial),t.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),e.applyColor(this._edgeManipulatorMaterial),e.applyOutline(this._edgeManipulatorOutlineMaterial),i.applyColor(this._edgeOffsetManipulatorMaterial),i.applyHover(this._edgeOffsetManipulatorHoverMaterial),a.applyColor(this._selectedManipulatorMaterial),a.applyOutline(this._selectedManipulatorOutlineMaterial),a.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)})),m((()=>l.displaying),(t=>{for(const e of this._manipulatorInfos)e.manipulator.available=t})),m((()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset})),(({labels:t,enabled:e,edgeOffsetEnabled:i})=>{null!=t&&(t.visible=e,t.edgeDistance=i?"far":"default")}),y),f((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),y),this.view.trackGraphicState(l)])}destroy(){this._segmentLabels=u(this._segmentLabels),this._tooltip=u(this._tooltip),this._removeManipulators(),this._updatingHandles.destroy()}get inputGeometry(){return null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}removeSelectedVertices(){const t=this._manipulatorInfos.filter((t=>t.manipulator.selected&&"vertex"===t.type));this._removeVertices(t)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=u(this._moveManipulation),this._graphicMoveManipulation=u(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(t){if(null==this._editGeometryOperations)return;const e=B(this.graphic);for(const i of this._editGeometryOperations.data.components){const a=t?.byComponentIndex.get(i.index);for(const t of i.vertices){const i=a?.has(t.index);this._createVertexOrEdgeManipulator(t,e,i)}for(const t of i.edges)this._createVertexOrEdgeManipulator(t,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canRedo}get canUndo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canUndo}redo(){if(null==this._editGeometryOperations)return null;const t=this._editGeometryOperations.redo();return null!=t&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(null==this._editGeometryOperations)return null;this.emit("undo");const t=this._editGeometryOperations.undo();return null!=t&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(t){const e={byComponentIndex:new Map};if(null!=t&&null!=this.inputGeometry&&dt(t,this.inputGeometry))for(const t of this._manipulatorInfos)if("vertex"===t.type&&t.manipulator.selected){const{index:i,component:{index:a}}=t.handle,{byComponentIndex:o}=e,n=o.get(a)||new Set;n.add(i),o.set(a,n)}if(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=u(this._editGeometryOperations),this._segmentLabels=u(this._segmentLabels),null==t)return void(this._recreatingManipulators=!1);const i="mesh"===t.type?t.anchor:t;this._editGeometryOperations=bi.fromGeometry(i,this.view.state.viewingMode),this._createManipulators(e),this._segmentLabels=new Ca({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:B(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(t,e){if("end"===e.action)return e;let i=0;const a=[],o=this._manipulatorInfos.some((t=>"vertex"===t.type&&t.manipulator.selected)),n=t===Po.SELECTED_OR_ALL&&o;for(const t of this._manipulatorInfos)"vertex"===t.type&&(t.manipulator.grabbing||n&&!t.manipulator.selected||a.push(t),i++);if(0===a.length)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(Lo.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(Lo.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){return this._manipulatorInfos.reduce(((t,e)=>"vertex"===e.type&&e.manipulator.selected?t+1:t),0)>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(Lo.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const o=[];for(const e of this._manipulatorInfos)"vertex"===e.type&&(e.manipulator.selected&&!e.manipulator.grabbing||e===t.info)&&o.push(e);this._moveVertices(o,t,wi.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case Lo.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case Lo.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case Lo.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case Lo.MOVING:switch(this._reshapeEventState){case Lo.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case Lo.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case Lo.RESHAPING:switch(this._reshapeEventState){case Lo.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case Lo.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulation(){const{tool:t,view:e}=this,i=this._graphicState;if(this._graphicMoveManipulation=new yo({tool:t,view:e,graphicState:i}),this.enableMoveGraphic){let t=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,i,a)=>{i.next((t=>this._trackNumDragging(t))).next((e=>("start"===e.action&&(t=this._editGeometryOperations.createUndoGroup()),e))).next((t=>this._perGraphicManipulatorDragAction(Po.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(fo.XY,t),t))).next((e=>{"end"===e.action&&(this._tooltip.clear(),t=d(t))})),a.next((()=>this._onDragCancel(!0,(()=>t=d(t)))))}))),this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(t,!1))))}else this._graphicMoveManipulation.forEachManipulator((t=>{t.grabbable=!1,t.cursor=null}));this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add(t.events.on("immediate-click",(t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()})))))}_createMoveManipulation(t){const{graphic:e,tool:i,view:a}=this,o=this._graphicState;this._moveManipulation=new go({tool:i,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&ue(e),snapToScene:!1,radius:go.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(i=>{this._moveManipulation.zManipulation.hasManipulator(t)||this._manipulatorInfos.some((t=>t.manipulator.selected))||this.emit("immediate-click",{...i,graphic:e}),i.stopPropagation()})),this._watchAndUpdateGrabState(t,!1)])));const n=t=>e=>{this.addHandles(e.events.on("focus-changed",(({action:e})=>{"focus"===e&&this._tooltipOptions.enabled?this._updateTranslateTooltip(t):this._tooltip.clear()})))};this._moveManipulation.xyManipulation.forEachManipulator(n(fo.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(n(fo.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(n(fo.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const s=e.geometry.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline(((a,o,n,s,r)=>{const{snappingStep:l,cancelSnapping:p}=Ti({predicate:t=>!!t.info,snappingManager:i.snappingManager,snappingContext:new Oi({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:r,excludeFeature:e,visualizer:new jt}),updatingHandles:this._updatingHandles,useZ:!1});return s=s.next((t=>(this._onDragCancel(),t))).next(p),{steps:n=n.next((t=>this._trackNumDragging(t))).next((t=>{const e=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));return t.manipulatorType===Xa.TRANSLATE_XY&&1===e.length?{...t,info:e[0],snapOrigin:e[0].handle.pos}:t})).next(ri(this.view,t,e)).next(...l).next(ai()).next((t=>this._perGraphicManipulatorDragAction(Po.SELECTED_OR_ALL,t))).next((t=>(this._updateTranslateTooltip(a,t),t))),cancel:s}}),t,s,e),m((()=>o.displaying),(()=>this._updateMoveManipulationPosition()),y),o.on("changed",(()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()})),m((()=>o.isDraped),(t=>{this._updateMoveManipulationPosition();const e="align-move-manipulation";t?this.addHandles(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.removeHandles(e)}),y)])}_createVisualElements(){const{graphic:t,view:e}=this,i=Ka({view:e,graphic:t,forEachManipulator:t=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(t),this._moveManipulation.forEachManipulator(t);for(const e of this._manipulatorInfos)t(e.manipulator,Xa.TRANSLATE_XY)}},onManipulatorsChanged:t=>this.on("manipulators-changed",t)});null!=i&&(this._outlineVisualElement=i.visualElement instanceof Tt?i.visualElement:null),null!=this._outlineVisualElement&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}))),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(t,e=B(this.graphic)){const i=this._settings.manipulators.edgeOffset,a=i.size/2,o=a+i.collisionPadding,n=a/o,s=n*Math.sqrt(3)/2;null==this._edgeOffsetManipulatorGeometryInside&&(this._edgeOffsetManipulatorGeometryInside=hi(this._edgeOffsetManipulatorMaterial,s,n/2,n/2,i.height,i.offset)),null==this._edgeOffsetManipulatorGeometryOutside&&(this._edgeOffsetManipulatorGeometryOutside=hi(this._edgeOffsetManipulatorMaterial,-s,n/2,n/2,i.height,-i.offset));const r=[new ee(this._edgeOffsetManipulatorGeometryInside.instantiate(),yi.Unfocused),new ee(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),yi.Focused),new ee(this._edgeOffsetManipulatorGeometryOutside.instantiate(),yi.Unfocused),new ee(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),yi.Focused)],p=new te({view:this.view,renderObjects:r,elevationInfo:"on-the-ground"!==e.mode||Bi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:o,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionType:{type:"disc",direction:F(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),h=new te({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),c={manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(c,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(c);const u=[];for(const t of[c.handle.leftVertex,c.handle.rightVertex]){const e=this._getManipulatorInfoFromHandle(t);null!=e&&u.push(e.manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))))}c.locationUpdateHandle=l(u),this._manipulatorHandles.add(c.locationUpdateHandle,p),this._manipulatorHandles.add([this._watchAndUpdateGrabState(p,!0),this._watchAndUpdateGrabState(h,!0)],p),this._manipulatorHandles.add(Ke(p,this._createEdgeOffsetPipeline(c,e)),p),this._manipulatorHandles.add(Ke(h,((t,i,a,o)=>{if("touch"===o)this._createEdgeOffsetPipeline(c,e)(t,i,a);else if(this.enableMoveGraphic){const o=this.graphic,n=null!=o.geometry?o.geometry.spatialReference:null;i.next((t=>this._trackNumDragging(t))).next($e(this.view,t.elevationAlignedLocation)).next(Ne(this.view,t.elevationAlignedLocation,e,n,o)).next(ei()).next(ai()).next((t=>this._perGraphicManipulatorDragAction(Po.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(fo.XY,t),t))).next((t=>{"end"===t.action&&this._tooltip.clear()})),a.next((()=>this._onDragCancel(!t.metadata.deleting)))}})),p);const d=t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()};return this._manipulatorHandles.add([p.events.on("immediate-click",d),h.events.on("immediate-click",d),p.events.on("focus-changed",(({action:t})=>{const{_tooltipOptions:e,_tooltip:i}=this;"focus"===t&&e.enabled?(i.info=this._edgeOffsetTooltipInfo??=new To({tooltipOptions:e}),i.info.distance=Bt,i.info.tooltipOptions=e,this._updateTooltipAreaOrTotalLength(i.info)):i.clear()}))],p),this._manipulatorInfos.push(c),this.manipulators.add(p),this.manipulators.add(h),this.emit("manipulators-changed"),c}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,a=t.edgeManipulator,o=()=>{t.visibilityHandle=d(t.visibilityHandle);const o=this._getManipulatorInfoFromHandle(t.handle.leftVertex),n=this._getManipulatorInfoFromHandle(t.handle.rightVertex),s=null!=o&&null!=n&&function(t,e,i){const a=i.projectToRenderScreen(t,K()),o=i.projectToRenderScreen(e,K());return null!=a&&null!=o?L(D(a,a,o)):0}(o.manipulator.renderLocation,n.manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||s)&&(i.grabbable=!s,a.grabbable=!s,t.visibilityHandle=l([i.disableDisplay(),r((()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}))]))};this._manipulatorHandles.add([i.events.on("focus-changed",o),a.events.on("focus-changed",o),r((()=>{d(t.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)}))],i),o()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const{coordinateHelper:e}=this._editGeometryOperations.data,i=Eo(this.view,t.manipulator.elevationAlignedLocation,jo(e,t.handle,t.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex),o=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(null==a||null==o)return;const n=a.manipulator.renderLocation,s=o.manipulator.renderLocation,r=null!=i?function(t,e,i){const a=Fi(t),o=C(k(),e,i),n=R(k(),o,a),s=R(k(),o,n);return Ue(o[0],o[1],o[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],0,0,0,0,1)}(i,n,s):Ve;t.manipulator.modelTransform=r,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=r;const l=P(D(Io,n,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,o)=>{this._clearSelection();const{step:n,cleanup:s}=this._initializeEdgeOffset(t,e);a.next((t=>this._trackNumDragging(t))).next($e(this.view,i.elevationAlignedLocation)).next(n).next(Ze(this.view)).next(Be(this.view,this._editGeometryOperations.data.spatialReference)).next(ai()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next((t=>{"end"===t.action&&s()})),o.next((()=>{i.metadata.deleting||(s(),this._onDragCancel())}))}}_initializeEdgeOffset(t,e){const{view:i}=this,a=this._editGeometryOperations,n=jo(a.data.coordinateHelper,t.handle,e),s=a.createUndoGroup(),r=Eo(i,t.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const e=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);null!=e&&this._splitEdgeManipulator(e,1)}if(n.requiresSplitEdgeRight){const e=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);null!=e&&this._splitEdgeManipulator(e,0)}const p=()=>new ki({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:a.data.spatialReference}),c=this._settings,u=new Tt({view:i,isDraped:this._graphicState.isDraped,geometry:p(),elevationInfo:t.elevationInfo,width:c.visualElements.lineGraphics.outline.width,attached:!1,isDecoration:!0});let g;const _=()=>{this._cleanEdgeOffsetCollapsedEdges(t),g=d(g)},f=this.on("undo",_);return g=l([m((()=>o(this._accentColor)),(t=>u.color=t),y),h(u),m((()=>this._graphicState.isDraped),(t=>u.isDraped=t)),this._graphicState.on("changed",(()=>u.geometry=p())),s,f]),u.attached=!0,{step:t=>null==n||null==r?(_(),null):{...t,operation:n,plane:r},cleanup:_}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||null==e.operation)return e;this._updateEventState(Lo.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:o}=e;return(i||a||o)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;return null==e||null==i?t:("start"===t.action&&e.selectArrowFromStartPoint(i),{...t,signedDistance:e.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,{_tooltip:o,_tooltipOptions:n}=this;return n.enabled&&null!=i?(o.info=this._edgeOffsetTooltipInfo??=new To({tooltipOptions:n}),o.info.tooltipOptions=n,o.info.distance="end"===t.action?Bt:function(t,e,i,a,o){if(t){const t=o.toXYZ(o.pointToVector(i)),n=Yi(a,t,ze.get()),s=St(n,t,o.spatialReference);if(null!=s)return qt(s.value*Math.sign(e),s.unit)}return qt(e*Vi(i.spatialReference),"meters")}(this._graphicState.isDraped,i*a.selectedArrow,e,a.plane,this._editGeometryOperations.data.coordinateHelper),this._updateTooltipAreaOrTotalLength(o.info),t):(o.clear(),t)}}_cleanEdgeOffsetCollapsedEdges(t){const e=t.handle.leftVertex.leftEdge?.leftVertex,i=t.handle.leftVertex,a=t.handle.rightVertex.rightEdge?.rightVertex,o=t.handle.rightVertex,n=this._editGeometryOperations.data.coordinateHelper,s=[];if(e&&n.distance(e.pos,i.pos)<Ro){const t=this._getManipulatorInfoFromHandle(i);null!=t&&s.push(t)}if(n.distance(i.pos,o.pos)<Ro||a&&n.distance(a.pos,o.pos)<Ro){const t=this._getManipulatorInfoFromHandle(o);null!=t&&s.push(t)}s.length&&this._removeVertices(s)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=B(this.graphic),i=!1){const{view:a}=this,o=this._settings;if("edge"===t.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(null==this._vertexManipulatorGeometry||null==this._vertexManipulatorOutlineGeometry){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.vertex);this._vertexManipulatorGeometry=gi(this._vertexManipulatorMaterial,t,16,16),this._vertexManipulatorOutlineGeometry=gi(this._vertexManipulatorOutlineMaterial,e,16,16)}if(null==this._edgeManipulatorGeometry||null==this._edgeManipulatorOutlineGeometry){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.edge);this._edgeManipulatorGeometry=gi(this._edgeManipulatorMaterial,t,16,16),this._edgeManipulatorOutlineGeometry=gi(this._edgeManipulatorOutlineMaterial,e,16,16)}const{geometry:n}=this.graphic,s=n?.type,r="point"===s||"mesh"===s?[]:[new ee(this._vertexManipulatorGeometry.instantiate(),Co.Vertex|yi.Unselected),new ee(this._vertexManipulatorOutlineGeometry.instantiate(),Co.Vertex|yi.Unfocused|yi.Unselected),new ee(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Co.Vertex|yi.Focused|yi.Unselected),new ee(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),yi.Selected),new ee(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),yi.Selected|yi.Unfocused),new ee(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),yi.Selected|yi.Focused)];this.enableMidpoints&&r.push(new ee(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),Co.Edge|yi.Focused|yi.Unselected),new ee(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Co.Edge|yi.Focused|yi.Unselected),new ee(this._edgeManipulatorGeometry.instantiate(),Co.Edge|yi.Unfocused|yi.Unselected),new ee(this._edgeManipulatorOutlineGeometry.instantiate(),Co.Edge|yi.Unfocused|yi.Unselected));const p=new te({view:a,renderObjects:r,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),metadata:{deleting:!1}});p.selected=i,this._setTypeSpecificManipulatorSettings(p,t,e);const h="edge"===t.type?{manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:p,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(h),this.manipulators.add(p),this._updateManipulatorPosition(h),"edge"===h.type){const t=[];for(const e of[h.handle.leftVertex,h.handle.rightVertex]){const i=this._getManipulatorInfoFromHandle(e);null!=i&&t.push(i.manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(h))))}h.locationUpdateHandle=l(t),this._manipulatorHandles.add(h.locationUpdateHandle,p)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(p,!0),p);const c=Ke(p,((t,i,a,o)=>{let n=null;const{snappingStep:s,cancelSnapping:r}=Ti({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Oi({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:o,excludeFeature:this.graphic,visualizer:new jt}),updatingHandles:this._updatingHandles,useZ:!1});a=a.next((e=>(this._onDragCancel(!t.metadata.deleting,(()=>n=d(n))),e))).next(r),i.next((t=>this._trackNumDragging(t))).next((t=>{if("start"===t.action&&(n=this._editGeometryOperations.createUndoGroup()),"edge"===h.type){const e=this._splitEdgeManipulator(h);return{...t,info:e,snapOrigin:e.handle.pos}}return{...t,info:h,snapOrigin:h.handle.pos}})).next($e(this.view,t.elevationAlignedLocation)).next(We(this.view,this.graphic,t.elevationAlignedLocation,t.location.spatialReference,this.graphic)).next(ri(this.view,e,this.graphic)).next(...s).next(ai()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(n=d(n)),this._updateTranslateVertexTooltip(t,fo.XY,e)}))}));return this._manipulatorHandles.add([c,p.events.on("immediate-click",(t=>this._manipulatorClickCallback(t,h))),p.events.on("select-changed",(()=>{h.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})),p.events.on("focus-changed",(({action:t})=>{"focus"===t&&"edge"!==h.type?this._updateTranslateVertexTooltip(p,fo.XY):this._tooltip.clear()}))],p),this.emit("manipulators-changed"),h}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&(this.undo(),this.outputGeometry=null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null),null!=this.tool.snappingManager&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case Lo.NONE:break;case Lo.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case Lo.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(Lo.NONE)}_setTypeSpecificManipulatorSettings(t,e,i){const{graphic:a}=this,o=this._settings;switch(e.type){case"vertex":{t.state=Co.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2;const{size:e,collisionPadding:n}=o.manipulators.vertex;t.radius=e/2+n,t.elevationInfo=i;const{geometry:s}=a,r=s?.type;t.interactive=null!=r&&"point"!==r&&"mesh"!==r;break}case"edge":{t.state=Co.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1;const{size:e,collisionPadding:n}=o.manipulators.edge;t.radius=e/2+n,t.elevationInfo="on-the-ground"!==i.mode||Bi(a.symbol)?{mode:"absolute-height",offset:0}:i;break}}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",(i=>this._onGrabStateChanged(t,e,i.action,i.pointerType)))}_onGrabStateChanged(t,e,i,a="mouse"){if(!this._recreatingManipulators){if("start"===i)e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(Lo.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==a||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((t=>{const{manipulator:e}=t,{geometry:i}=this.graphic,a=i?.type;e.interactive=e.grabbing||!this._numGrabbing&&null!=a&&"point"!==a&&"mesh"!==a,"edgeManipulator"in t&&(t.edgeManipulator.interactive=t.edgeManipulator.grabbing||!this._numGrabbing)})),this._graphicMoveManipulation.forEachManipulator((t=>{t.interactive=t.grabbing||!this._numGrabbing})))}}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){null!=t&&(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),S(this._manipulatorInfos,t),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t)for(const e of this._manipulatorInfos)if(t===e.handle)return e;return null}_updateManipulatorPosition(t){if(null==t)return;const e=this._editGeometryOperations;if("vertex"===t.type)t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,Go),t.manipulator.grabbing&&null!=this._vertexLaserLineVisualElement&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if("edge"===t.type){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex),a=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(null==i||null==a)return;const o=i.manipulator,n=a.manipulator;if(null!=t.manipulator.elevationInfo&&"on-the-ground"===t.manipulator.elevationInfo.mode){const i=o.location,a=n.location,s=.5,r=i.x+s*(a.x-i.x),l=i.y+s*(a.y-i.y),p=i.hasZ&&a.hasZ?0:void 0;t.manipulator.location=$t(r,l,p,e.data.spatialReference)}else U(Io,o.renderLocation,n.renderLocation,.5),t.manipulator.renderLocation=Io}}_splitEdgeManipulator(t,e=.5){const i=this._editGeometryOperations,a=i.splitEdge(t.handle,e).createdVertex;t.locationUpdateHandle=d(t.locationUpdateHandle);const o=B(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(t),n=this._createVertexOrEdgeManipulator(a)):(n=t,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,o)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this.enableEdgeOffset||this._updateTranslateVertexTooltip(n.manipulator,fo.XY),this._updateSelection(t.manipulator);const s=this._updateEventState(Lo.RESHAPING),r=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:a.index}],added:r}),s&&this._updateEventState(Lo.NONE),n}_updateMoveManipulationPosition(){const t=E(Io,0,0,0);let e=0,i=!1,a=null,o=null;for(const n of this._manipulatorInfos)"vertex"===n.type&&(n.manipulator.selected?(e++,O(t,t,n.manipulator.renderLocation),null==a||n.selectedIndex>a.selectedIndex?(o=a,a=n):(null==o||n.selectedIndex>o.selectedIndex)&&(o=n)):i=!0);if(0===e){const t=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t,this._moveManipulation.zManipulation.available=t&&this.enableZShape&&ue(this.graphic),this._moveManipulation.angle=Fa(this.graphic.geometry),this._moveManipulation.radius=go.radiusForSymbol(this.graphic.symbol)}else{const t=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.zManipulation.available=t&&this.enableZVertex&&ue(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t&&1!==e;let i=0;if(null!=a){const t=a.handle.pos,e=null!=o?o.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,n=null==o&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;e&&n?this._moveManipulation.xyAxisManipulation.available=!1:e?i=Do(e,t):n&&(i=Do(t,n))}this._moveManipulation.angle=i,this._moveManipulation.radius=to}0!==e&&i?(T(t,t,1/e),Go.spatialReference=this._editGeometryOperations.data.spatialReference,Go.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,Go),this._moveManipulation.elevationAlignedLocation=Go):null==this._outlineVisualElement||this._graphicState.isDraped||null==this._outlineVisualElement.attachmentOrigin?ne(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(t){const e=new Array,i=this._editGeometryOperations;for(const a of t)if("vertex"===a.type&&i.canRemoveVertex(a.handle.component)){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const t=i.removeVertices([a.handle]),o=t.removedVertices?.[0].createdEdge;o&&this._createVertexOrEdgeManipulator(o)}if(e.length>0){const t=e.map((t=>{const e=i.data.components.indexOf(t.component);return{coordinates:i.data.coordinateHelper.vectorToArray(t.pos),componentIndex:e,vertexIndex:t.index}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(Lo.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:t.map((t=>t.coordinates)),vertices:t}),this.destroyed)return;if(a&&(this._updateEventState(Lo.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=("start"===e.action?wi.NEW_STEP:wi.ACCUMULATE_STEPS)){const a=this._editGeometryOperations;a.moveVertices(t.map((t=>t.handle)),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const e of t)this._updateManipulatorPosition(e)}_offsetEdge(t,e){if(null==e.operation||null==e.signedDistance)return;const i=this._editGeometryOperations,a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),"vertex"===e.type&&(e.manipulator.selected=!e.manipulator.selected,t.button===Wi.Right&&this._removeVertices([e])),"edge"===e.type&&t.button===Wi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));1===i.length?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const{_tooltipOptions:i,_tooltip:a}=this;if(!i.enabled)return;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case fo.XY:a.info=this._translateGraphicTooltipInfo??=new Ai({tooltipOptions:i}),this._updateTranslateTooltipDistance(a.info,e,((t,e)=>yt(t,e,o)));break;case fo.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??=new Gi({tooltipOptions:i}),this._updateTranslateTooltipDistance(a.info,e,((t,i)=>{const a=yt(t,i,o);return Wt(a,no(e))}));break;case fo.Z:a.info=this._translateGraphicZTooltipInfo??=new Di({tooltipOptions:i}),this._updateTranslateTooltipDistance(a.info,e,Li)}a.info.tooltipOptions=i}_updateTranslateVertexTooltip(t,e,i){const{_tooltipOptions:a,_tooltip:o}=this;if(!a.enabled)return;const n=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case fo.XY:o.info=this._translateVertexTooltipInfo??=new Ci({tooltipOptions:a}),this._updateTranslateTooltipDistance(o.info,i,((t,e)=>yt(t,e,n))),this._updateTooltipAreaOrTotalLength(o.info);break;case fo.XY_AXIS:o.info=this._translateVertexXYTooltipInfo??=new Ri({tooltipOptions:a}),this._updateTranslateTooltipDistance(o.info,i,((t,e)=>{const a=yt(t,e,n);return Wt(a,no(i))})),this._updateTooltipAreaOrTotalLength(o.info);break;case fo.Z:o.info=this._translateVertexZTooltipInfo??=new Ii({tooltipOptions:a}),this._updateTranslateTooltipDistance(o.info,i,Li)}const s=Pi(t.elevationAlignedLocation);null!=s&&(o.info.elevation=Ut({actual:s})),o.info.tooltipOptions=a}_updateTranslateTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:o}=e,n=i(a,o);t.distance=null!=n?n:Bt}else t.distance=Bt}_updateTooltipAreaOrTotalLength(t){const{geometry:e}=this.graphic;if(null==e)return t.area=null,void(t.totalLength=null);const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";t.area="polygon"===e.type?qi(e,i):null,t.totalLength="polyline"===e.type?bt(e,i):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function Do(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}t([M()],Ao.prototype,"_editGeometryOperations",void 0),t([M()],Ao.prototype,"_segmentLabels",void 0),t([M({constructOnly:!0})],Ao.prototype,"tool",void 0),t([M()],Ao.prototype,"_tooltip",void 0),t([M()],Ao.prototype,"inputGeometry",null),t([M()],Ao.prototype,"outputGeometry",void 0),t([M({readOnly:!0})],Ao.prototype,"updating",null),t([M()],Ao.prototype,"manipulators",null),t([M()],Ao.prototype,"view",null),t([M()],Ao.prototype,"graphic",null),t([M()],Ao.prototype,"enableZShape",null),t([M()],Ao.prototype,"enableZVertex",null),t([M()],Ao.prototype,"enableMoveGraphic",null),t([M()],Ao.prototype,"enableMidpoints",null),t([M()],Ao.prototype,"enableEdgeOffset",null),t([M()],Ao.prototype,"_labelOptions",null),t([M()],Ao.prototype,"_tooltipOptions",null),t([M()],Ao.prototype,"_accentColor",null),Ao=t([w("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],Ao);const Go=$t(0,0,void 0,Qi.WGS84),Io=k(),Ro=1e-6;var Co,Lo,Po;!function(t){t.Vertex=vi.Custom1,t.Edge=vi.Custom2}(Co||(Co={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(Lo||(Lo={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Po||(Po={}));let Uo=class extends(Zt.EventedMixin(oi)){constructor(t){super(t),this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Ji,this.tooltipOptions=new Ei,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new Ao({tool:this});this.addHandles([t.on("reshape",(t=>{"reshape"===t.type&&this._onReshapeGeometryChanged(),this.emit("reshape",t)})),t.on("move",(t=>{"move"===t.type&&this._onReshapeGeometryChanged(),this.emit("move",t)})),t.on("vertex-add",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)})),t.on("vertex-remove",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)})),t.on("immediate-click",(t=>this.emit("immediate-click",t))),this.view.on("pointer-down",["Shift"],(t=>t.stopPropagation())),m((()=>this.graphic),(()=>this._updateGraphic()),_)]),this.finishToolCreation()}destroy(){this._reshapeOperation=u(this._reshapeOperation)}get updating(){return this._reshapeOperation?.updating??!1}_updateGeometry(){const t=he(this.graphic);this._reshapeOperation.inputGeometry=null!=t?t.clone():null}_updateGraphic(){if(this.removeHandles("onGraphicGeometryChange"),this._updateGeometry(),ce(this.graphic)!==pe.SUPPORTED)return;const t=m((()=>this.graphic?.geometry),(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),v);this.addHandles(t,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0;const{graphic:e}=this,{geometry:i}=e;"mesh"===i?.type&&"point"===t.type?(e.geometry=i.centerAt(t),e.notifyGeometryChanged()):e.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:t}=this._reshapeOperation;null!=this.graphic&&t&&this._updateGeometryInternally(t.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){null!=this.snappingManager&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.undo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){null!=this.snappingManager&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.redo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}onInputEvent(t){"key-down"!==t.type||"Delete"!==t.key&&"Backspace"!==t.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};t([M()],Uo.prototype,"_reshapeOperation",void 0),t([M({constructOnly:!0,nonNullable:!0})],Uo.prototype,"view",void 0),t([M({constructOnly:!0})],Uo.prototype,"graphic",void 0),t([M({constructOnly:!0,nonNullable:!0})],Uo.prototype,"enableZShape",void 0),t([M({constructOnly:!0,nonNullable:!0})],Uo.prototype,"enableZVertex",void 0),t([M({constructOnly:!0,nonNullable:!0})],Uo.prototype,"enableMoveGraphic",void 0),t([M({constructOnly:!0,nonNullable:!0})],Uo.prototype,"enableMidpoints",void 0),t([M({constructOnly:!0,nonNullable:!0})],Uo.prototype,"enableEdgeOffset",void 0),t([M()],Uo.prototype,"type",void 0),t([M({constructOnly:!0,type:Ji})],Uo.prototype,"labelOptions",void 0),t([M({constructOnly:!0,type:Ei})],Uo.prototype,"tooltipOptions",void 0),t([M({constructOnly:!0})],Uo.prototype,"snappingManager",void 0),t([M()],Uo.prototype,"updating",null),t([M()],Uo.prototype,"automaticManipulatorSelection",void 0),Uo=t([w("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Uo);let Vo=class extends Mt{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};t([M()],Vo.prototype,"type",void 0),t([M()],Vo.prototype,"rotation",void 0),t([M()],Vo.prototype,"rotationPrecision",void 0),t([M()],Vo.prototype,"orientation",void 0),t([M()],Vo.prototype,"orientationPrecision",void 0),t([M()],Vo.prototype,"rotationType",void 0),Vo=t([w("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],Vo);let zo=class extends Mt{constructor(t){super(t),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};t([M()],zo.prototype,"type",void 0),t([M()],zo.prototype,"scale",void 0),t([M()],zo.prototype,"size",void 0),t([M()],zo.prototype,"sizeUnit",void 0),t([M()],zo.prototype,"sizePrecision",void 0),zo=t([w("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],zo);let Ho=class extends Mt{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};var ko;t([M()],Ho.prototype,"type",void 0),t([M()],Ho.prototype,"orientation",void 0),t([M()],Ho.prototype,"orientationPrecision",void 0),t([M()],Ho.prototype,"rotationType",void 0),t([M()],Ho.prototype,"size",void 0),t([M()],Ho.prototype,"sizePrecision",void 0),t([M()],Ho.prototype,"sizeUnit",void 0),Ho=t([w("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],Ho),function(t){t.ScaleIn=vi.Custom2,t.ScaleOut=vi.Custom3,t.RotateLeft=vi.Custom4,t.RotateRight=vi.Custom5,t.Unlocked=vi.Custom7,t.DelayedFocused=vi.Custom8,t.TouchInput=vi.Custom12}(ko||(ko={}));let Fo=class extends tt{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}get updating(){return!!this._activeAnimation}constructor(t){super(t),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=200,this._absoluteTooltipInfo=null,this._scaleTooltipInfo=null,this._rotateTooltipInfo=null,this.events=new Zt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this.adapter.scale:1}initialize(){this._tooltip=new vt({view:this.tool.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([f((()=>!this.tooltipOptions.enabled),(()=>this._tooltip.clear()),y),m((()=>{const{adapter:t}=this,{info:e}=this._tooltip;return e===this._absoluteTooltipInfo&&this.getFocused()?[e,t.size,t.orientationClockwise]:[null]}),(([t])=>{t&&this._updateFocusTooltip()}))])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=u(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=ea({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=u(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,Xa.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.graphicState.graphic,i=Ke(t,((t,i,a)=>{this._scaleRotateDragData=null;const o=this.adapter.startInteraction(),n={mode:"none",origin:N(t.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=n,this._updateDragState();const s=ze.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,s),i.next(qe(this.tool.view,Ni(t.renderLocation,s,Xi()))).next((t=>{const i=Fi(t.plane),a=se(t.renderStart,t.renderEnd,n.origin,i),s=ta.shortestSignedDiff(n.angle,a);n.angleDir=me(n.angleDir+s,-.3,.3),n.angle=a;const r=function(t,e){const i=D(ze.get(),e.renderStart,t.origin),a=D(ze.get(),e.renderEnd,t.origin),o=P(i),n=P(a);return 0===o?0:n/o}(n,t),l=r-this.adapter.scale;if(n.scaleDir=me(n.scaleDir+l,-.2,.2),this._onScaleChanged(),"none"===n.mode){const i=this.mode||function(t,e,i,a){const{renderStart:o,renderEnd:n}=t,s=No(o,a,ze.get()),r=No(n,a,ze.get());if(V(s,r)<100)return null;const l=D(ze.get(),o,i),p=R(ze.get(),l,Fi(e)),h=o,c=O(ze.get(),h,p),u=No(i,a,ze.get()),d=s,m=No(c,a,ze.get()),g=D(ze.get(),m,d),_=D(ze.get(),s,u),f=ke(d,g),y=ke(u,_);return Fe(f,r)<Fe(y,r)?"rotate":"scale"}(t,t.plane,n.origin,this.tool.view.state.camera);if(null!=i){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:e,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:e,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}n.mode=i}}switch(n.mode){case"rotate":o.state.angle=n.initialAngle+a;break;case"scale":o.state.scale=r,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:e,angle:ge(n.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:e,xScale:r,yScale:r})}break;case"end":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:ge(n.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:r,yScale:r})}}return"end"===t.action&&(this.startAnimation(Yo(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),o.done()),t})).next(this._updateTooltipPipelineStep(n)),a.next((()=>{if(o.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:1,yScale:1})}this.startAnimation(Yo(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this.addHandles([i,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(function(t,e,i){let a=0,o=null;const n=()=>!1;return{start:()=>{o=t.getFocused,t.getFocused=n,a=0,e()},update:t=>(a+=t,!o?.()||a>=i.delayMs?Xo.STOP:Xo.CONTINUE),destroy:()=>{o&&(t.getFocused=o),e()}}}(this,(()=>this._updateDelayedFocusedState()),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),m((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),y)])}_updateTooltipPipelineStep(t){return e=>{const i=this.tooltipOptions;if(!i.enabled)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const a=this._tooltip,o=this.tooltipOptions.visualVariables;switch(t.mode){case"scale":{a.info=this._scaleTooltipInfo??=new zo({tooltipOptions:i});const{size:t,scale:e}=this.adapter,n=o?.size,s=a.info;s.tooltipOptions=i,s.scale={value:e},s.size=null!=t?qt(t,"meters"):void 0,s.sizePrecision=Zo(n?.valueType),s.sizeUnit=n?.unit;break}case"rotate":{a.info=this._rotateTooltipInfo??=new Vo({tooltipOptions:i});const{orientationClockwise:t,relativeAngleClockwise:e}=this.adapter,n=o?.rotation,s=Zo(n?.valueType),r=a.info;r.tooltipOptions=i,r.rotation=null!=e?Qt(e,"radians","geographic"):void 0,r.rotationPrecision=s,r.rotationType=n?.rotationType??"geographic",r.orientation=null!=t?Qt(t,"radians","geographic"):void 0,r.orientationPrecision=s;break}}return e}}_updateFocusTooltip(){const{tooltipOptions:t,_tooltip:e}=this;if(t.enabled)if(this.getFocused()){const i=t.visualVariables,a=i?.rotation,o=i?.size,n=this.mode,{size:s,orientationClockwise:r}=this.adapter,l=null!=r&&(null==n||"rotate"===n),p=null!=s&&(null==n||"scale"===n);e.info=this._absoluteTooltipInfo??=new Ho({tooltipOptions:t});const h=e.info;h.tooltipOptions=t,h.orientation=l?Qt(r,"radians","geographic"):void 0,h.orientationPrecision=Zo(a?.valueType),h.rotationType=a?.rotationType??"geographic",h.size=p?qt(s,"meters"):void 0,h.sizeUnit=o?.unit,h.sizePrecision=Zo(o?.valueType)}else e.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(ko.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(ko.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(ko.ScaleIn|ko.ScaleOut,!1),this._ringManipulator.updateStateEnabled(ko.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(ko.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(ko.RotateLeft|ko.RotateRight,!1),this._ringManipulator.updateStateEnabled(ko.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(ko.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(ko.ScaleIn|ko.ScaleOut|ko.RotateLeft|ko.RotateRight,!1)}_updateManipulatorTransform(){const t=Ae(He.get(),this.adapter.angle,F(0,0,1));if(null==t)return;const e=this.getScale(),i=De(He.get(),E(ze.get(),e,e,e));this._ringManipulator.modelTransform=Te(He.get(),i,t)}_createRingManipulator(){const t=(t,e,i)=>{const a=[],o=Math.ceil(128*(e-t)/(2*Math.PI));for(let n=0;n<o+1;n++){const s=t+n*(e-t)/o;a.push(F(i*Math.cos(s),i*Math.sin(s),0))}return a},e=e=>t(0,2*Math.PI,e),i=this._createMaterial(1),a=(t,e,a=i)=>_i(a,(t=>[[-t/2,0],[t/2,0],[t/2,.25],[-t/2,.25]])(e),t,[],[],!1),o=e(160),n=a(o,24),s={left:new Array,right:new Array},r=[];for(let e=0;e<2;e++){const o=e*Math.PI-Math.PI/4,n=Math.PI/2-eo,l=o+n,p=o+Math.PI/2-n,h=t(l,p,190),c=a(h,9);r.push(h),r.push(t(l,p,201)),s.left.push(c),s.right.push(c.instantiate());for(let t=0;t<2;t++){const e=0===t,a=Pe();if(e){Re(a,a,[1,-1,1]),Ce(a,a,-l,[0,0,1]);const t=Math.round(.2*(h.length-1));a[12]=h[t][0],a[13]=h[t][1],a[14]=h[t][2]}else{Ce(a,a,p,[0,0,1]);const t=Math.round(.8*(h.length-1));a[12]=h[t][0],a[13]=h[t][1],a[14]=h[t][2]}const o=hi(i,60,0,23,.5);ci(o,a),(e?s.left:s.right).push(o)}}const l=[];for(let e=0;e<2;e++){const i=e*Math.PI-Math.PI/4,o=Math.PI/2-io,n=i+o,s=i+Math.PI/2-o,r=t(n,s,213);l.push(a(r,9))}const p=this._createMaterial(.66),h=this._createMaterial(.5),c=this._createMaterial(.33),u=e(190),d=e(213),m=a(u,9,p),g=a(d,9,c),_=e(130),f=e(107),y=a(_,9,p),v=a(f,9,c);let M=[new ee(n,ko.DelayedFocused),new ee(n.instantiate({material:h}),yi.None)];this.mode&&"scale"!==this.mode||(M=M.concat([...l.map((t=>new ee(t,ko.DelayedFocused|ko.Unlocked))),new ee(m,ko.DelayedFocused|ko.ScaleIn),new ee(g,ko.DelayedFocused|ko.ScaleIn),new ee(y,ko.DelayedFocused|ko.ScaleOut),new ee(v,ko.DelayedFocused|ko.ScaleOut)])),this.mode&&"rotate"!==this.mode||(M=M.concat([...s.right.map((t=>new ee(t.instantiate(),ko.DelayedFocused|ko.Unlocked))),...s.left.map((t=>new ee(t,ko.DelayedFocused|ko.RotateLeft))),...s.right.map((t=>new ee(t,ko.DelayedFocused|ko.RotateRight)))]));const b=[o,...r];return new te({view:this.tool.view,renderObjects:M,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:B(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:b,direction:F(0,0,1)}})}_createMaterial(t){const e=new fi({cullFace:pi.Back,renderOccluded:Ct.Transparent,isDecoration:!0});return this.addHandles(m((()=>({color:s(this.tool.view.effectiveTheme.accentColor,t)})),(t=>e.setParameters(t)),y)),e}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}};function No(t,e,i){return e.projectToScreen(t,Bo),E(i,Bo[0],Bo[1],0)}var Xo;function Yo(t,e){let i=null,a=1;const o=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=o,e()},update:t=>(a+=((a+1)/2-a)*Math.min(3*t,1),e(),Math.abs(a-1)<.01?Xo.STOP:Xo.CONTINUE),destroy:()=>{i&&(t.getScale=i),e()}}}function Zo(t){switch(t){case"integer":case"long":return 0;default:return null}}t([M({constructOnly:!0})],Fo.prototype,"tool",void 0),t([M({constructOnly:!0})],Fo.prototype,"adapter",void 0),t([M({constructOnly:!0})],Fo.prototype,"tooltipOptions",void 0),t([M()],Fo.prototype,"mode",void 0),t([M()],Fo.prototype,"_activeAnimation",void 0),t([M()],Fo.prototype,"updating",null),Fo=t([w("esri.views.3d.interactive.editingTools.transformGraphic.GraphicScaleRotateTransform")],Fo),function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(Xo||(Xo={}));const Bo=J();function Wo(t){return null!=t.geometry&&"mesh"===t.geometry.type?(e=t.geometry).vertexSpace.isRelative?function(t,e,i){let a=e?.clone(),o=N(i.origin),n=null,s=null;return{undo:e=>{n=t.transform?.clone(),s=N(i.origin),t.transform=a,t.vertexSpace.origin=o,e.notifyMeshTransformChanged()},redo:e=>{a=t.transform?.clone(),o=N(i.origin),t.transform=n,t.vertexSpace.origin=s,e.notifyMeshTransformChanged()}}}(e,e.transform,e.vertexSpace):function(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}(e):function(t){let e=t.geometry,i=null;return{undo(t){i=t.geometry,t.geometry=e},redo(t){e=t.geometry,t.geometry=i}}}(t);var e}let qo=class extends tt{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([f((()=>{const t=this._interactionState;return t&&t.angle!==t.previousAngle?{interactionState:t,angle:t.state.angle}:null}),(({interactionState:t})=>{this._updateMeshRotation(t)}),v),f((()=>{const t=this._interactionState;return t&&t.scale!==t.previousScale?{interactionState:t,scale:t.state.scale}:null}),(({interactionState:t})=>{this._updateMeshSize(t)}),v)])}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){const t=this.geometry.transform;if(null==t)return this._interactionState?.angle??0;const e=aa(t.rotation)[2];return Math.abs(e)>.999999?de(oa(t.rotation))*Math.sign(e):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}startInteraction(){const t=new Qo({angle:this.angle});this._interactionState=t;const e=()=>{this._interactionState=null};return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return Wo(this.graphic)}_updateMeshRotation(t){const{angle:e,previousAngle:i}=t;t.previousAngle=e;const{geometry:a}=this,{vertexSpace:o}=a,n=ge(e-i);if(o.isGeoreferenced){const t=!o.isRelative&&this.viewingMode===$i.Global,e=this.geometry.anchor;this.geometry.rotate(0,0,n,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{a.transform??=new ra;const{transform:t}=a,e=na(0,0,n,Jo);t.rotation=sa(t.rotation,e,t.rotation),this.graphic.notifyMeshTransformChanged()}}_updateMeshSize(t){const{scale:e,previousScale:i}=t;t.previousScale=e;const{geometry:a}=this,{vertexSpace:o}=a,n=e/i;if(o.isGeoreferenced){const t=!o.isRelative&&this.viewingMode===$i.Global,e=this.geometry.anchor;this.geometry.scale(n,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{a.transform??=new ra;const{transform:t}=a;t.scale=T(t.scale,t.scale,n),this.graphic.notifyMeshTransformChanged()}}};t([M({constructOnly:!0})],qo.prototype,"graphic",void 0),t([M({constructOnly:!0})],qo.prototype,"geometry",void 0),t([M({constructOnly:!0})],qo.prototype,"viewingMode",void 0),t([M()],qo.prototype,"initialAngle",null),t([M()],qo.prototype,"angle",null),t([M()],qo.prototype,"angleClockwise",null),t([M()],qo.prototype,"relativeAngle",null),t([M()],qo.prototype,"relativeAngleClockwise",null),t([M()],qo.prototype,"scale",null),t([M()],qo.prototype,"_interactionState",void 0),qo=t([w("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],qo);let Qo=class extends tt{get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};t([M()],Qo.prototype,"angle",void 0),t([M()],Qo.prototype,"initialAngle",void 0),t([M()],Qo.prototype,"previousAngle",void 0),t([M()],Qo.prototype,"previousScale",void 0),t([M()],Qo.prototype,"scale",void 0),t([M()],Qo.prototype,"state",null),Qo=t([w("InteractionState")],Qo);const Jo=ia();let Ko=class extends tt{constructor(t){super(t),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(f((()=>null!=this._interactionState?this._interactionState.state:null),(t=>{this._updateSymbol(t)}),v))}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){return null!=this._interactionState?this._interactionState.angle:null!=this._orientationReferenceSymbolLayer?(t=this._orientationReferenceSymbolLayer.heading??0,-de(t)):0;var t}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}get size(){const t=this._sizeReferenceSymbolLayer;if(null==t)return null;const e=this.findLayerView(),i=this._graphicSymbol;if(null==e||null==i||"point-3d"!==i.type)return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&null!=a.size)return a.size;const o=this.sizeAxis;return!("width"in a)||null==a.width||null!=o&&"width"!==o&&"all"!==o&&"width-and-depth"!==o?!("depth"in a)||null==t.depth||null!=o&&"depth"!==o&&"all"!==o&&"width-and-depth"!==o?!("height"in a)||null==t.height||null!=o&&"height"!==o&&"all"!==o?null:a.height:a.depth:a.width}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return null==t||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type))}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return null==t||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type&&null!=t.heading))}get _graphicSymbol(){return null!=this.graphic?.symbol&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(null!=this._interactionState||null==t||null==e)return $o;const i=t.symbolLayers.map((i=>"object"===i.type?e.getSymbolLayerSize(t,i):null)).toArray(),a=t.clone(),o=this.angle,n=new tn({originalSymbol:a,angle:o,initialSizes:i});this._interactionState=n;const s=()=>{this._interactionState=null};return{state:n,done:s,cancel:()=>{this._graphicSymbol=a,s()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const o=this._graphicSymbol;if(null==o||"point-3d"!==o.type)return;const n=o.clone(),s=-ge(e-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,n,((e,i,o)=>{const n=(e.heading??0)+s;i.heading!==n&&(i.heading=n,r=!0);const l=a[o];if(null!=l&&"width"in l){l.width=this.sizeFilter(l.width),l.height=this.sizeFilter(l.height),l.depth=this.sizeFilter(l.depth);const e=l.width*t;i.width!==e&&(i.width=e,r=!0);const a=l.depth*t;i.depth!==a&&(i.depth=a,r=!0);const o=l.height*t;i.height!==o&&(i.height=o,r=!0)}})),r&&(this._graphicSymbol=n)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach(((t,a)=>{const o=e.symbolLayers.at(a);"object"===t.type&&"object"===o.type&&i(t,o,a)}))}};t([M()],Ko.prototype,"initialAngle",null),t([M()],Ko.prototype,"angle",null),t([M()],Ko.prototype,"angleClockwise",null),t([M()],Ko.prototype,"orientation",null),t([M()],Ko.prototype,"orientationClockwise",null),t([M()],Ko.prototype,"relativeAngle",null),t([M()],Ko.prototype,"relativeAngleClockwise",null),t([M()],Ko.prototype,"scale",null),t([M()],Ko.prototype,"size",null),t([M()],Ko.prototype,"sizeAxis",void 0),t([M({constructOnly:!0})],Ko.prototype,"graphic",void 0),t([M()],Ko.prototype,"_interactionState",void 0),t([M({constructOnly:!0})],Ko.prototype,"findLayerView",void 0),t([M({constructOnly:!0})],Ko.prototype,"sizeFilter",void 0),t([M()],Ko.prototype,"_sizeReferenceSymbolLayer",null),t([M()],Ko.prototype,"_orientationReferenceSymbolLayer",null),t([M()],Ko.prototype,"_graphicSymbol",null),Ko=t([w("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],Ko);const $o={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let tn=class extends tt{get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:o}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:o}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}};t([M()],tn.prototype,"originalSymbol",void 0),t([M()],tn.prototype,"angle",void 0),t([M()],tn.prototype,"initialAngle",void 0),t([M()],tn.prototype,"initialSizes",void 0),t([M()],tn.prototype,"scale",void 0),t([M()],tn.prototype,"state",null),tn=t([w("InteractionState")],tn);let en=class extends(Zt.EventedMixin(oi)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Ei,this.type="transform-3d",this._updatingHandles=new Kt,this._scaleRotate=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new Rt({graphic:t}),this.addHandles(m((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new vt({view:e}):u(this._tooltip)}),_)),this._moveManipulation=new go({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&ue(t),radius:go.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((e=>this.addHandles(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:t}),e.stopPropagation()})))));const i=t=>e=>{this.addHandles(e.events.on("focus-changed",(({action:e})=>{const i=this._tooltip;null!=i&&("focus"===e?this._updateMoveTooltip(t):i.clear())})))};this._moveManipulation.xyManipulation.forEachManipulator(i(fo.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(fo.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(fo.Z));const a=B(t);this._moveManipulation.elevationInfo=a,this.addHandles(Pa(this.graphicState));const{geometry:o}=t;if(this._moveManipulation.createGraphicDragPipeline(((i,n,s,r,l)=>{if(null!=o&&i===fo.XY){const{snappingStep:i,cancelSnapping:n}=Ti({snappingContext:new Oi({elevationInfo:a,pointer:l,editGeometryOperations:bi.fromGeometry(new Ki({spatialReference:o.spatialReference}),e.state.viewingMode),visualizer:new jt,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});r=r.next(n),s=s.next(li(this.view,a)).next(...i)}return{steps:s=s.next((t=>(this._updateMoveTooltip(i,t),t))),cancel:r}}),this.graphicState,(t=>{const{action:e,graphic:i,dxScreen:a,dyScreen:o}=t,n={graphic:i,dxScreen:a,dyScreen:o};switch(e){case"start":this.emit("graphic-translate-start",n),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this._moveManipulation.angle=null!=this._scaleRotate?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(m((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Fo({tool:this,mode:t,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.addHandles([Ka({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>r()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),m((()=>e.scale),(()=>this._updateMoveAngle()))].filter(x)),this.addHandles(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof te&&this.addHandles(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}destroy(){this._tooltip=u(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=u(this._scaleRotate),this._scaleRotateAdapter=u(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){null!=this._scaleRotate&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return null!=this.graphic.geometry&&"mesh"===this.graphic.geometry.type?new qo({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new Ko({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer)),sizeAxis:this.tooltipOptions?.visualVariables?.size?.axis??null})}_forEachManipulator(t){this._moveManipulation?.forEachManipulator(t),this._scaleRotate?.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return m((()=>this.graphicState.displaying),(t=>{this._forEachManipulator((e=>e.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&ue(this.graphic)}))}_createGeometryUndoRecord(){return Wo(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}set location(t){this._moveManipulation.location=t,this._scaleRotate&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){null!=this._scaleRotate&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===$i.Local||this.view.scale<1e6?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){ne(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(t,e){const{tooltipOptions:i,_tooltip:a}=this;if(null==a)return;a.clear();const o=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case fo.XY:a.info=this._translateGraphicTooltipInfo??=new Ai({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,((t,e)=>yt(t,e,o)));break;case fo.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??=new Gi({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,((t,i)=>{const a=yt(t,i,o);return Wt(a,no(e))}));break;case fo.Z:a.info=this._translateGraphicZTooltipInfo??=new Di({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,Li)}a.info.tooltipOptions=i}_updateMoveTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:o}=e,n=i(a,o);t.distance=null!=n?n:Bt}else t.distance=Bt}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:null!=this._scaleRotate?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:t=>null!=this._scaleRotate?this._scaleRotate.test.setRingIndicatorDelayMs(t):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};t([M({constructOnly:!0,nonNullable:!0})],en.prototype,"view",void 0),t([M({constructOnly:!0,nonNullable:!0})],en.prototype,"graphic",void 0),t([M({constructOnly:!0,nonNullable:!0})],en.prototype,"enableZ",void 0),t([M()],en.prototype,"enableRotation",void 0),t([M()],en.prototype,"enableScaling",void 0),t([M({constructOnly:!0,type:Ei})],en.prototype,"tooltipOptions",void 0),t([M()],en.prototype,"graphicState",void 0),t([M({value:!1})],en.prototype,"snapToScene",null),t([M({constructOnly:!0})],en.prototype,"snappingManager",void 0),t([M({readOnly:!0})],en.prototype,"type",void 0),t([M({readOnly:!0})],en.prototype,"updating",null),en=t([w("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],en);class an{constructor(t,e,i,a){this._tool=t,this._graphicState=e,this._editGeometryOperations=i,this._bounds=a,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const o=this._tool,n=o.view;this.moveXYGraphicManipulation=new yo({view:n,tool:o,graphicState:this._graphicState}),o.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new la(n,pa.CENTER_ON_CALLOUT),this.moveZManipulator.state|=ha,o.manipulators.add(this.moveZManipulator),o.addHandles([this._createMoveZDragPipeline()]),o.addHandles([o.on("graphic-translate-stop",(()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,Xa.TRANSLATE_Z)}updateManipulators(t,e){const i=this.moveZManipulator,a=Le(He.get(),t,Math.PI);a[12]=0,a[13]=0,a[14]=0,i.modelTransform=a,i.renderLocation=D(ze.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool.tooltipOptions;return this._moveXYTooltipInfo??=new Ai({tooltipOptions:t})}_computeMoveZTooltipInfo(){const t=this._tool,e=t.tooltipOptions,i=this._moveZTooltipInfo??=new Di({tooltipOptions:e});if(this.moveZManipulator.dragging){const t=this._bounds,e=t.mapBoundsStart.origin,a=t.mapBounds.origin,o=Ui(e,a,this._tool.view.spatialReference);if(null==o)return null;i.distance=o}else i.distance=qt(0,t.moveUnit);return i}_updateMoveTooltip(t,e){if(e===fo.XY||e===fo.XY_AXIS){const e=yt(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");null!=e&&null!=this._moveXYTooltipInfo&&(this._moveXYTooltipInfo.distance=e)}return t}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline(((t,e,i)=>this._applyGraphicMoveSteps(e,i,fo.XY)))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return Ke(this.moveZManipulator,((e,i,a)=>{const o=N(e.renderLocation),n=i.next(Xe(this._tool.view,o,t)).next(ei());this._applyGraphicMoveSteps(n,a,fo.Z)}))}_applyGraphicMoveSteps(t,e,i){const a=this._tool,o=a.graphic,n=t.next((t=>("start"===t.action&&(a.inputState={type:"move"},this._bounds.backupMapBounds(),a.emit("graphic-translate-start",{graphic:o,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(ai()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:o,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||(t.mapEnd.z??0)-(t.mapStart.z??0))&&a.emit("graphic-translate",e);break;case"end":a.inputState=null,a.emit("graphic-translate-stop",e)}return t})).next((t=>this._updateMoveTooltip(t,i)));return e.next((()=>{null!=a.inputState&&a.emit("graphic-translate-stop",{graphic:o,dxScreen:0,dyScreen:0}),a.cancel()})),n}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(null==t.inputState||"move"!==t.inputState.type)return e;const i=[];for(const t of this._editGeometryOperations.data.components)i.push(...t.vertices);const a="start"===e.action?wi.NEW_STEP:wi.ACCUMULATE_STEPS,o=this._editGeometryOperations.moveVertices(i,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a);return Vt(o,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,e}}}class on{constructor(t,e,i){this._tool=t,this._editGeometryOperations=e,this._bounds=i,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;const a=this._tool,o=a.view,n=!o._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this.rotateManipulator=new ca(o,((t,e)=>wa(o.textures,{accentColor:t,contrastColor:e,preMultiplyAlpha:n}))),a.addHandles([this.rotateManipulator.events.on("grab-changed",(t=>this._onRotateGrab(t))),this._createRotateDragPipeline(this.rotateManipulator)]),a.manipulators.add(this.rotateManipulator),a.addHandles([a.on("graphic-rotate-start",(t=>{this._startAngle=t.angle})),a.on("graphic-rotate",(t=>{this._endAngle=t.angle})),a.on("graphic-rotate-stop",(()=>{this._startAngle=0,this._endAngle=0}))])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(t){t(this.rotateManipulator,Xa.ROTATE)}updateManipulators(t,e){const i=this._bounds.mapBounds.plane[2]<0?Math.PI:0,a=Ie(He.get(),t,i);a[12]=0,a[13]=0,a[14]=0,this.rotateManipulator.modelTransform=a,this.rotateManipulator.renderLocation=O(ze.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){const t=this._tool.tooltipOptions,e=this._rotateTooltipInfo??=new Ea({tooltipOptions:t});return e.angle=this._startAngle-this._endAngle,e}_onRotateGrab({action:t,screenPoint:e}){const i=this._tool,a=this._bounds;if("start"!==t||!e)return;const o=ua(a.displayBounds,i.view.renderCoordsHelper,da.HEADING,Xi()),n=ja(i.view.state.camera,e);Zi(o,n,ze.get())&&(a.backupMapBounds(),i.inputState={type:"rotate",rotatePlane:o})}_createRotateDragPipeline(t){const e=this._tool,i=e.graphic;return Ke(t,((t,a,o)=>{const n=e.inputState;null!=n&&(a.next((t=>("start"===t.action&&e.emit("graphic-rotate-start",{graphic:i,angle:0}),t))).next(qe(e.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdateGeometry()).next((t=>{const a={graphic:i,angle:ge(t.rotateAngle)};switch(t.action){case"start":case"update":e.emit("graphic-rotate",a);break;case"end":e.inputState=null,e.emit("graphic-rotate-stop",a)}return t})),o.next((()=>{null!=e.inputState&&e.emit("graphic-rotate-stop",{graphic:i,angle:0}),e.cancel()})))}))}_rotateDragRenderPlaneToRotate(t){return e=>{const i=Fi(t.rotatePlane),a=se(e.renderStart,e.renderEnd,this._bounds.displayBounds.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){const t=this._tool,e=this._bounds;return i=>{const a=z(k(),e.mapBoundsStart.origin),o=[];for(const t of this._editGeometryOperations.data.components)o.push(...t.vertices);const n="start"===i.action?wi.NEW_STEP:wi.ACCUMULATE_STEPS,s=this._editGeometryOperations.rotateVertices(o,a,i.rotateAngle,n,ji.REPLACE);return ba(e.mapBoundsStart,e.mapBounds),Vt(s,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,i}}}class nn{constructor(t,e,i){this._tool=t,this._onDisplayBoundsChanged=e,this.mapBounds=Sa(),this.mapBoundsStart=Sa(),this.displayBounds=Sa(),this._calculateMapBounds(i)}get displayBoundsMargin(){const{view:t,graphic:e}=this._tool,i=t.pointsOfInterest?.centerOnSurfaceFrequent.location??e.geometry?.extent?.center;return i?sn*t.pixelSizeAt(i):0}backupMapBounds(){ba(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged()}_calculateMapBounds(t){const{view:e,attachmentOrigin:i}=this._tool,a=t.geometry,o=function(t){const e=Fa(t);return ct(Math.cos(e),Math.sin(e))}(a);rt(o,o,-1);const n=e.spatialReference,s=a.spatialReference,r=i?e.pixelSizeAt(i)*zi(n)/Vi(s):0;zt(o,t,rn*r,this.mapBounds)}_calculateDisplayBounds(){const{view:t,attachmentOrigin:e,graphic:i}=this._tool;if(!i.geometry)return;const a=e?.z??Gt(this.mapBounds.origin,t.elevationProvider,It.fromElevationInfo(B(i)),t.renderCoordsHelper),o=ba(this.mapBounds);o.origin[2]=a??0,function(t,e,i,a=0,o){o||(o=Sa()),e.toRenderCoords(t.origin,i,o.origin);const n=ze.get();O(n,t.origin,t.basis1),O(n,n,t.basis2),e.toRenderCoords(n,i,n);const s=ze.get();O(s,t.origin,t.basis1),D(s,s,t.basis2),e.toRenderCoords(s,i,s);const r=ze.get();D(r,t.origin,t.basis1),D(r,r,t.basis2),e.toRenderCoords(r,i,r);const l=ze.get();D(l,t.origin,t.basis1),O(l,l,t.basis2),e.toRenderCoords(l,i,l);const p=U(ze.get(),n,s,.5);D(p,p,o.origin);const h=U(ze.get(),r,l,.5);D(h,o.origin,h),U(o.basis1,p,h,.5);const c=U(ze.get(),l,n,.5);D(c,c,o.origin);const u=U(ze.get(),s,r,.5);D(u,o.origin,u),U(o.basis2,c,u,.5);const d=R(ze.get(),o.basis1,o.basis2),m=R(d,d,o.basis1);G(m,m),T(o.basis2,m,I(o.basis2,m)),T(o.basis1,o.basis1,1+a/P(o.basis1)),T(o.basis2,o.basis2,1+a/P(o.basis2)),xa(o)}(o,t.renderCoordsHelper,i.geometry.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const sn=10,rn=80;function ln(t,e,i,a){const o=ze.get();D(o,D(o,t.origin,t.basis1),t.basis2);const n=ze.get();H(n,o,t.basis1,2);const s=ze.get();H(s,n,t.basis2,2);const r=ze.get();H(r,o,t.basis2,2),o[2]=n[2]=s[2]=r[2]=e;const l=a?"on-the-ground":"absolute-height",p=Jt(xt(o,n,i,l),xt(r,s,i,l)),h=Jt(xt(n,s,i,l),xt(o,r,i,l));return null==h||null==p?null:[p,h]}class pn{get zMax(){if(!this._zMaxDirty)return this._zMax;const t=this._editGeometryOperations.data;if(t.geometry.hasZ){const e=t.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const i of t.components)for(const t of i.vertices){const i=e.getZ(t.pos)??0;this._zMax=Math.max(i,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(t,e,i,a,o){this._tool=t,this._graphicState=e,this._editGeometryOperations=i,this._bounds=a,this._preserveAspectRatioStep=o,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._scaleTooltipInfo=null,this._displayBoundsStart=Sa(),this._displayBoundsMarginStart=0,this._startScale=ht(),this._endScale=ht(),this._sizeStart=null,this._zMax=0,this._zMaxDirty=!0;const n=this._tool,s=n.view;this.resizeManipulators=this._resizeHandles.map((t=>{const e=new ma(s,t);return n.addHandles([e.events.on("grab-changed",(t=>this._onResizeGrab(t))),this._createResizeDragPipeline(e,t)]),e})),n.manipulators.addMany(this.resizeManipulators),n.addHandles([n.on("graphic-scale-start",(t=>{nt(this._startScale,t.xScale,t.yScale),nt(this._endScale,t.xScale,t.yScale)})),n.on("graphic-scale",(t=>{nt(this._endScale,t.xScale,t.yScale)})),n.on("graphic-scale-stop",(()=>{nt(this._startScale,0,0),nt(this._endScale,0,0)})),this._graphicState.on("changed",(()=>{"resize"!==n.inputState?.type&&(this._zMaxDirty=!0)}))])}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){this.resizeManipulators.forEach((e=>t(e,Xa.SCALE)))}updateManipulators(t,e){this.resizeManipulators.forEach(((i,a)=>{ga(i,this._resizeHandles[a],t,e)}))}getUpdatedTooltipInfo(){return this.resizeManipulators.some((t=>t.focused))?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){const t=this._tool,e=t.tooltipOptions,i=this._scaleTooltipInfo??=new Oa({tooltipOptions:e}),a=t.graphic.geometry;if(null==a)return null;const o=ln(this._bounds.mapBounds,this.zMax,a.spatialReference,this._graphicState.isDraped);return null==o?null:(i.xSize=o[0],i.ySize=o[1],null!=this._sizeStart&&this.resizeManipulators.some((t=>t.dragging))?(i.xScale=o[0].value/this._sizeStart[0].value,i.yScale=o[1].value/this._sizeStart[1].value):(i.xScale=1,i.yScale=1),i)}_onResizeGrab({action:t,screenPoint:e}){const i=this._tool,a=this._bounds;if("start"!==t||!e||!i.graphic.geometry)return;const o=ja(i.view.state.camera,e);Zi(a.displayBounds.plane,o,ze.get())&&(a.backupMapBounds(),ba(a.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=a.displayBoundsMargin,this._sizeStart=ln(a.mapBoundsStart,this.zMax,i.graphic.geometry.spatialReference,this._graphicState.isDraped),i.inputState={type:"resize"})}_createResizeDragPipeline(t,e){const i=this._tool,a=i.graphic;return Ke(t,((t,o,n)=>{null!=i.inputState&&(o.next((t=>("start"===t.action&&i.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),t))).next(qe(i.view,this._displayBoundsStart.plane)).next((t=>({...t,handle:e}))).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next((t=>{const e={graphic:a,xScale:t.factor1,yScale:t.factor2};switch(t.action){case"start":case"update":i.emit("graphic-scale",e);break;case"end":i.inputState=null,i.emit("graphic-scale-stop",e)}return t})),n.next((()=>{null!=i.inputState&&i.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1}),i.cancel()})))}))}_resizeDragRenderPlaneToFactors(){const t=this._bounds;return e=>{const i=this._displayBoundsStart,a=e.handle.direction,o=t.displayBoundsMargin,n=this._displayBoundsMarginStart,s=z(ze.get(),i.origin);H(s,s,i.basis1,-a[0]),H(s,s,i.basis2,-a[1]);const r=D(ze.get(),e.renderEnd,s),l=D(ze.get(),e.renderStart,s),p=_a(e.handle),h=fa(i),c=fa(t.displayBounds)/h,u=(t,e)=>{if(0===t)return 1;let i=P(e),a=.5*t*I(e,r)/i;const s=a<0?-1:1;p&&(a+=(i-.5*t*I(e,l)/i)*s*c);const h=i<1.5*n?1:hn;return i=Math.max(i-n,hn),s>0&&(a-=o),s*Math.max(s*(a/i),h)};return{...e,factor1:u(a[0],i.basis1),factor2:u(a[1],i.basis2)}}}_resizeDragUpdateGeometry(){const t=this._tool,e=this._bounds;return i=>{const a=z(k(),e.mapBoundsStart.origin);H(a,a,e.mapBoundsStart.basis1,-i.handle.direction[0]),H(a,a,e.mapBoundsStart.basis2,-i.handle.direction[1]);const o=nt(ht(),e.mapBoundsStart.basis1[0],e.mapBoundsStart.basis1[1]);st(o,o);const n=[];for(const t of this._editGeometryOperations.data.components)n.push(...t.vertices);const s="start"===i.action?wi.NEW_STEP:wi.ACCUMULATE_STEPS,r=this._editGeometryOperations.scaleVertices(n,a,o,i.factor1,i.factor2,s,ji.REPLACE);return ba(e.mapBoundsStart,e.mapBounds),Vt(r,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,i}}}const hn=1e-6;class cn{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const e={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(e),this._next.execute(e)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new ii;return this._next=t,[t=>(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled&&this._adjustScaleFactors(t),t),t]}_adjustScaleFactors(t){const e=_a(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):0===t.handle.direction[0]?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-e:e,t.factor2=t.factor2<0?-e:e}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let un=class extends(Zt.EventedMixin(oi)){constructor(t){super(t),this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.tooltipOptions=new Ei,this._preserveAspectRatio=new cn,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:t,graphic:e}=this,i=this._graphicState=new Rt({graphic:e}),a=e.geometry,o=this._editGeometryOperations=bi.fromGeometry(a,t.state.viewingMode),n=this._bounds=new nn(this,(()=>this._updateManipulators()),o.data);this._extentMove=new an(this,i,o,n),this._extentScale=new pn(this,i,o,n,(()=>this._preserveAspectRatio.createDragEventPipelineStep())),this._extentRotate=new on(this,o,n),this.addHandles([m((()=>this.enableZ),(()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,Xa.TRANSLATE_Z))),m((()=>this.enableScaling),(()=>this._extentScale.forEachManipulator((t=>this._updateManipulatorAvailability(t,Xa.SCALE))))),m((()=>this.enableRotation),(()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,Xa.ROTATE)))]),this._updateAllManipulatorAvailability();const s=Ka({view:t,graphic:e,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>r()});if(null!=s){const{visualElement:t}=s;t instanceof Tt&&(this._outlineVisualElement=t,this.addHandles(t.events.on("attachment-origin-changed",(()=>this._bounds.updateDisplayBounds())))),this.addHandles(s)}this.addHandles([i.on("changed",(()=>this._onGeometryChanged())),m((()=>i.displaying),(()=>this._updateAllManipulatorAvailability())),m((()=>i.isDraped),(()=>this._graphicDrapedChanged()),y),m((()=>t.pointsOfInterest?.centerOnSurfaceFrequent.location),(()=>n.updateDisplayBounds())),t.trackGraphicState(i)]),this._forEachManipulator((t=>{this.addHandles(t.events.on("grab-changed",(()=>{this.grabbing=t.grabbing,this._updateAllManipulatorAvailability()})))})),this._forEachManipulator(((t,i)=>{this.addHandles(t.events.on("immediate-click",(t=>{i===Xa.TRANSLATE_XY&&this.emit("immediate-click",{...t,graphic:e}),t.stopPropagation()})))})),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{view:t}=this,e=this._tooltip=new vt({view:t}),i=()=>{e.info=this._getUpdatedTooltipInfo()};this.addHandles([this.on("graphic-translate-start",i),this.on("graphic-translate",i),this.on("graphic-translate-stop",(()=>{this._tooltip.clear()})),this.on("graphic-rotate-start",i),this.on("graphic-rotate",i),this.on("graphic-rotate-stop",i),this.on("graphic-scale-start",i),this.on("graphic-scale",i),this.on("graphic-scale-stop",i)]),this._forEachManipulator((t=>{this.addHandles([t.events.on("focus-changed",i),t.events.on("grab-changed",i),t.events.on("drag",(t=>{"cancel"===t.action?this._tooltip.clear():i()}))])}))}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(dn),this._bounds.updateDisplayBounds(),this._graphicState.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",(t=>{null!=this._attachmentOrigin&&xe(t.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()})),dn)}_updateManipulators(){if(!this.visible)return;const t=this._bounds.displayBounds,e=ya(t,He.get());this._extentMove.updateManipulators(e,t),this._extentScale.updateManipulators(e,t),this._extentRotate.updateManipulators(e,t)}_updateAllManipulatorAvailability(){this._forEachManipulator(((t,e)=>this._updateManipulatorAvailability(t,e)))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof te){const a=this._graphicState.displaying,o=this.enableZ&&ue(this.graphic);switch(e){case Xa.ROTATE:t.available=a&&this.enableRotation;break;case Xa.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||o),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?va:Ma;break;case Xa.TRANSLATE_Z:t.available=a&&o;break;default:t.available=a}}}_forEachManipulator(t){this._extentMove.forEachManipulator(t),this._extentScale.forEachManipulator(t),this._extentRotate.forEachManipulator(t)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get moveUnit(){return Hi(this.view.spatialReference)??"meters"}get attachmentOrigin(){const t=this.graphic.geometry,e=this._graphicState.isDraped?null:this._outlineVisualElement?.attachmentOrigin;return this._attachmentOrigin=e??ae(this.view,this.graphic)??t?.extent?.center,this._attachmentOrigin}reset(){}cancel(){if(this.canUndo){const t=this._editGeometryOperations.undo();Ht(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}this.inputState=null}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(null!=this.inputState)this.view.activeTool=null;else if(this.canUndo){const t=this._editGeometryOperations.undo();Ht(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this._editGeometryOperations.redo();Vt(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get test(){return{moveZManipulator:this._extentMove.moveZManipulator,resizeManipulators:this._extentScale.resizeManipulators,rotateManipulator:this._extentRotate.rotateManipulator,tooltip:this._tooltip}}};t([M({constructOnly:!0,nonNullable:!0})],un.prototype,"view",void 0),t([M({constructOnly:!0,nonNullable:!0})],un.prototype,"graphic",void 0),t([M()],un.prototype,"enableZ",void 0),t([M()],un.prototype,"enableScaling",void 0),t([M()],un.prototype,"enableRotation",void 0),t([M({constructOnly:!0,type:Ei})],un.prototype,"tooltipOptions",void 0),t([M()],un.prototype,"preserveAspectRatio",null),t([M()],un.prototype,"moveUnit",null),t([M()],un.prototype,"grabbing",void 0),t([M()],un.prototype,"inputState",void 0),t([M({readOnly:!0})],un.prototype,"type",void 0),un=t([w("esri.views.3d.interactive.editingTools.transformGraphic.ExtentTransformTool")],un);const dn="draped-elevation-changes";export{za as DrawGraphicTool3D,un as ExtentTransformTool,xo as GraphicMoveTool,Uo as GraphicReshapeTool,en as GraphicTransformTool};
