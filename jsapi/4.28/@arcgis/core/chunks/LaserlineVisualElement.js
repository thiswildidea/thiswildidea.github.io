/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{s as e,b as t,c as i,d as s}from"./vec3.js";import{c as n,f as r,a}from"./vec3f64.js";import{c as l,b as h,e as o}from"./lineSegment.js";import{V as c}from"./VisualElement.js";import{_ as d}from"./tslib.es6.js";import{c as _,f as u}from"./maybe.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./typedArrayUtil.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{b as g,d as m,e as P,g as b,h as V}from"./frustum.js";import{w as L}from"./vector.js";import{V as E}from"./ViewingMode.js";import{n as y}from"./DoubleArray.js";import{g as R}from"./glUtil.js";import{n as D}from"./InterleavedLayout.js";import{V as S}from"./VertexArrayObject2.js";import{V as v}from"./VertexAttribute.js";import{S as C,P as M,R as q}from"./Program2.js";import{L as T}from"./LaserlinePath.glsl.js";import{f as w,e as A,U as j}from"./enums3.js";import{m as I,b as x,a as O}from"./renderState2.js";import{B as H}from"./BufferObject.js";import{S as B,C as N}from"./RenderPlugin.js";import{R as U}from"./RenderSlot.js";import{D as W,u as z}from"./Material.js";import{p as X,S as G}from"./ShaderTechniqueConfiguration.js";import{d as F}from"./mathUtils.js";import{N as k}from"./interfaces3.js";import{L as J,d as K}from"./Laserlines.glsl.js";class Q extends C{initializeProgram(e){return new M(e.rctx,Q.shader.get().build(this.configuration),Y)}initializePipeline(){return I({blending:x(w.ONE,w.ONE_MINUS_SRC_ALPHA),colorWrite:O})}}Q.shader=new q(T,(()=>import("./LaserlinePath.glsl.js").then((e=>e.L))));const Y=new Map([[v.START,0],[v.END,1],[v.UP,2],[v.EXTRUDE,3]]);class Z{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=n(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const t=y(3*e.length);let i=0;for(const s of e)t[i++]=s[0],t[i++]=s[1],t[i++]=s[2];this.buffers=[t]}set buffers(t){if(this._buffers=t,this._buffers.length>0){const t=this._buffers[0],i=3*Math.floor(t.length/3/2);e(this._origin,t[i],t[i+1],t[i+2])}else e(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const t=this._ensureVAO(e);null!=t&&(e.bindVAO(t),e.drawArrays(A.TRIANGLES,0,this._count))}dispose(){null!=this._vao&&this._vao.dispose()}_ensureVAO(e){return null==this._buffers?null:(null==this._vao&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,t){const i=this._createDataBuffer(t);return this._dirty=!1,new S(e,Y,{data:R(te)},{data:H.createVertex(e,j.STATIC_DRAW,i)})}_ensureVertexData(e,t){if(!this._dirty)return;const i=this._createDataBuffer(t);e.vertexBuffers.data?.setData(i),this._dirty=!1}_numberOfRenderVertices(e){return 2*(e.length/3-1)*3}_createDataBuffer(i){const s=i.reduce(((e,t)=>e+this._numberOfRenderVertices(t)),0);this._count=s;const n=te.createBuffer(s),r=this._origin;let a=0,l=0;for(const s of i){for(let i=0;i<s.length;i+=3){const h=e(ee,s[i],s[i+1],s[i+2]);0===i?l=this._renderCoordsHelper.getAltitude(h):this._renderCoordsHelper.setAltitude(h,l);const o=this._renderCoordsHelper.worldUpAtPosition(h,$),c=a+2*i,d=t(ee,h,r);if(i<s.length-3){n.up.setVec(c,o),n.up.setVec(c+3,o),n.up.setVec(c+5,o);for(let e=0;e<6;e++)n.start.setVec(c+e,d);n.extrude.setValues(c,0,-1),n.extrude.setValues(c+1,1,-1),n.extrude.setValues(c+2,1,1),n.extrude.setValues(c+3,0,-1),n.extrude.setValues(c+4,1,1),n.extrude.setValues(c+5,0,1)}if(i>0){n.up.setVec(c-2,o),n.up.setVec(c-4,o),n.up.setVec(c-5,o);for(let e=-6;e<0;e++)n.end.setVec(c+e,d)}}a+=this._numberOfRenderVertices(s)}return n.buffer}}const $=n(),ee=n(),te=D().vec3f(v.START).vec3f(v.END).vec3f(v.UP).vec2f(v.EXTRUDE);class ie extends G{constructor(){super(...arguments),this.contrastControlEnabled=!1}}d([X()],ie.prototype,"contrastControlEnabled",void 0);class se extends k{constructor(){super(...arguments),this.innerColor=r(1,1,1),this.innerWidth=1,this.glowColor=r(1,.5,0),this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.75,this.globalAlphaContrastBoost=2,this.angleCutoff=F(6),this.pointDistanceOrigin=n(),this.pointDistanceTarget=n(),this.lineVerticalPlaneSegment=l(),this.intersectsLineSegment=l(),this.intersectsLineRadius=3,this.heightManifoldTarget=n(),this.lineStartWorld=n(),this.lineEndWorld=n()}}class ne extends C{initializeProgram(e){return new M(e.rctx,ne.shader.get().build(this.configuration),W)}initializePipeline(){return I({blending:x(w.ONE,w.ONE_MINUS_SRC_ALPHA),colorWrite:O})}}ne.shader=new q(J,(()=>import("./Laserlines.glsl.js").then((e=>e.L))));class re extends ie{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.spherical=!1}}d([X()],re.prototype,"heightManifoldEnabled",void 0),d([X()],re.prototype,"pointDistanceEnabled",void 0),d([X()],re.prototype,"lineVerticalPlaneEnabled",void 0),d([X()],re.prototype,"intersectsLineEnabled",void 0),d([X()],re.prototype,"spherical",void 0);let ae=class extends B{constructor(e){super(e),this._technique=null,this._heightManifoldEnabled=!1,this._pointDistanceEnabled=!1,this._lineVerticalPlaneEnabled=!1,this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._viewingMode=E.Local,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this._passParameters=new se,this.produces=new Map([[U.LASERLINES,()=>!this.contrastControlEnabled],[U.LASERLINES_CONTRAST_CONTROL,()=>this.contrastControlEnabled]])}initialize(){this._passParameters.renderCoordsHelper=this.renderCoordsHelper}consumes(){return N}get isDecoration(){return this._isDecoration}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._passParameters.heightManifoldTarget}set heightManifoldTarget(e){i(this._passParameters.heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._passParameters.pointDistanceTarget}set pointDistanceTarget(e){i(this._passParameters.pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._passParameters.pointDistanceOrigin}set pointDistanceOrigin(e){i(this._passParameters.pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._passParameters.lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){h(e,this._passParameters.lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._passParameters.intersectsLineSegment}set intersectsLineSegment(e){h(e,this._passParameters.intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._passParameters.intersectsLineRadius}set intersectsLineRadius(e){e!==this._passParameters.intersectsLineRadius&&(this._passParameters.intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get viewingMode(){return this._viewingMode}set viewingMode(e){e!==this._viewingMode&&(this._viewingMode=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,null!=this._pathVerticalPlaneData&&this._requestRender())}set pathVerticalPlaneVertices(e){null==this._pathVerticalPlaneData&&(this._pathVerticalPlaneData=new Z(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){null==this._pathVerticalPlaneData&&(this._pathVerticalPlaneData=new Z(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){z(this._passParameters,e)&&this._requestRender()}initializeRenderContext(e){this._context=e,this._techniqueRepository=e.techniqueRepository,this._techniqueConfig=new re;const t=new ie;t.contrastControlEnabled=this.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(Q,t)}uninitializeRenderContext(){this._technique=_(this._technique),this._pathVerticalPlaneData=u(this._pathVerticalPlaneData),this._pathTechnique=_(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this.contrastControlEnabled,this._techniqueConfig.spherical=this._viewingMode===E.Global,this._technique=this._techniqueRepository.releaseAndAcquire(ne,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}renderNode(e,t){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,t),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,t){const i=e.rctx;this._updatePassParameters(e),i.bindTechnique(t,this._passParameters,e.bindParameters),i.screen.draw()}_renderPath(e){if(null==this._pathVerticalPlaneData||null==this._pathTechnique)return;const t=e.rctx,i=this._pathTechnique;t.bindTechnique(i,{...this._passParameters,origin:this._pathVerticalPlaneData.origin},e.bindParameters),this._pathVerticalPlaneData.draw(e.rctx)}_updatePassParameters(e){if(!this._intersectsLineEnabled)return;const t=e.bindParameters.camera;if(this._intersectsLineInfinite){if(m(L(this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector),le),le.c0=-Number.MAX_VALUE,!P(t.frustum,le))return;b(le,this._passParameters.lineStartWorld),V(le,this._passParameters.lineEndWorld)}else i(this._passParameters.lineStartWorld,this._passParameters.intersectsLineSegment.origin),s(this._passParameters.lineEndWorld,this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector)}_requestRender(){this._context&&this._context.requestRender()}get test(){return{passParameters:this._passParameters}}};d([p({constructOnly:!0})],ae.prototype,"contrastControlEnabled",void 0),d([p({constructOnly:!0})],ae.prototype,"_isDecoration",void 0),d([p({constructOnly:!0})],ae.prototype,"renderCoordsHelper",void 0),ae=d([f("esri.views.3d.support.LaserLineRenderer")],ae);const le=g();class he extends c{constructor(e){super(e),this._angleCutoff=K,this._style={},this._heightManifoldTarget=n(),this._heightManifoldEnabled=!1,this._intersectsLine=l(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProperties(e)}get testData(){return this._renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){null!=e?(i(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(null==e)return void(this.intersectsLine=null);const t=this.view.renderCoordsHelper.worldUpAtPosition(e,oe);this.intersectsLine=o(e,t),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){null!=e?(h(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=null!=e?h(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=null!=e?{origin:a(e.origin),target:e.target?a(e.target):null}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||null!=this._pointDistanceLine||null!=this._pathVerticalPlaneBuffers)?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){null==this._renderer&&(this._renderer=new ae({renderCoordsHelper:this.view.renderCoordsHelper,contrastControlEnabled:!0,_isDecoration:this.isDecoration}),this._renderer.viewingMode=this.view.state.viewingMode,this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this._renderer))}_syncStyle(){null!=this._renderer&&(this._renderer.setParameters(this._style),null!=this._style.intersectsLineRadius&&(this._renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){null!=this._renderer&&this._renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){null!=this._renderer&&(this._renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this._renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){null!=this._renderer&&(this._renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this._renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){null!=this._renderer&&(this._renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){null!=this._renderer&&(this._renderer.pathVerticalPlaneEnabled=null!=this._pathVerticalPlaneBuffers&&this.visible,null!=this._pathVerticalPlaneBuffers&&(this._renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){null!=this._renderer&&(this._renderer.lineVerticalPlaneEnabled=null!=this._lineVerticalPlaneSegment&&this.visible,null!=this._lineVerticalPlaneSegment&&(this._renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){if(null==this._renderer)return;const e=this._pointDistanceLine,t=null!=e;this._renderer.pointDistanceEnabled=t&&null!=e.target&&this.visible,t&&(this._renderer.pointDistanceOrigin=e.origin,null!=e.target&&(this._renderer.pointDistanceTarget=e.target))}_disposeRenderer(){null!=this._renderer&&this.view._stage&&(this.view._stage.removeRenderPlugin(this._renderer),this._renderer=null)}}const oe=n();export{he as L};
