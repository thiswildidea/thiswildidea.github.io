/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{u as t}from"./originUtils.js";import r from"../portal/Portal.js";import a from"../portal/PortalItem.js";import{a as o}from"./jsonContext.js";import{b as i,T as s}from"./portalItemUtils.js";import{v as n}from"./saveAPIKeyUtils.js";function l(t,r,a){const o=a(t);if(!o.isValid)throw new e(`${r}:invalid-parameters`,o.errorMessage,{layer:t})}async function p(e){const{layer:t,errorNamePrefix:r,validateLayer:a}=e;await t.load(),l(t,r,a)}function m(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function d(t){const{item:r,itemType:a,errorNamePrefix:o,layer:i,validateItem:s}=t;if(n(r),r.type!==a)throw new e(`${o}:portal-item-wrong-type`,`Portal item type should be "${a}"`,{item:r,layer:i});if(s){const t=s(r);if(!t.isValid)throw new e(`${o}:invalid-parameters`,t.errorMessage,{layer:i})}}function u(t){const{layer:r,errorNamePrefix:a}=t,{portalItem:o}=r;if(!o)throw new e(`${a}:portal-item-not-set`,m(r,"requires the portalItem property to be set"));if(!o.loaded)throw new e(`${a}:portal-item-not-loaded`,m(r,"cannot be saved to a portal item that does not exist or is inaccessible"));d({...t,item:o})}function c(e){const{newItem:t,itemType:o}=e;let i=a.from(t);return i.id&&(i=i.clone(),i.id=null),i.type??=o,i.portal??=r.getDefault(),d({...e,item:i}),i}async function f(t,r,a){"beforeSave"in t&&"function"==typeof t.beforeSave&&await t.beforeSave();const o=t.write({},r);return await Promise.all(r.resources?.pendingOperations??[]),function(t,r){let a=(t.messages??[]).filter((({type:e})=>"error"===e)).map((({name:t,message:r,details:a})=>new e(t,r,a)));if(t.blockedRelativeUrls&&(a=a.concat(t.blockedRelativeUrls.map((t=>new e("url:unsupported",`Relative url '${t}' is not supported`))))),r?.ignoreUnsupported&&(a=a.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),a.length>0)throw new e("layer-write:unsupported","Failed to save layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a})}(r,a),o}function y(e){i(e,s.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}async function w(e,t,r){const a=e.portal;await a.signIn(),await(a.user?.addItem({item:e,data:t,folder:r?.folder}))}async function v(e,r){const{layer:a,createItemData:i,createJSONContext:s,saveResources:n}=e;await p(e),u(e);const l=a.portalItem,m=s?s(l):o(l),d=await f(a,m,r),c=await i({layer:a,layerJSON:d},l);return y(l),await l.update({data:c}),t(m),await(n?.(l,m)),l}async function I(e,r){const{layer:a,createItemData:i,createJSONContext:s,setItemProperties:n,saveResources:l}=e;await p(e);const m=c(e),d=s?s(m):o(m),u=await f(a,d,r),v=await i({layer:a,layerJSON:u},m);return await n(a,m),y(m),await w(m,v,r),a.portalItem=m,t(d),await(l?.(m,d)),m}export{y as a,I as b,c,w as d,l as e,u as f,f as g,m as h,v as s};
