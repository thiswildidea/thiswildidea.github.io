/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{L as e,r as t}from"./Logger.js";import{f as n,c as r}from"./date.js";import{formatNumber as i,convertNumberFormatToIntlOptions as o}from"../intl.js";import{featureHasFields as a,isTimeOnlyField as l,isRasterPixelValueField as s}from"../layers/support/fieldUtils.js";import{g as u}from"./layerUtils2.js";import{i as f,f as c}from"./utils2.js";import{l as d}from"./arcadeOnDemand.js";import{g as p}from"./timeZoneUtils.js";const m=e.getLogger("esri.widgets.Feature.support.featureUtils"),y=/href=(""|'')/gi,g=/(\{([^\{\r\n]+)\})/g,I=/\'/g,h=/^\s*expression\//i,b=/(\n)/gi,T=/[\u00A0-\u9999<>\&]/gim,w=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,F=/^(?:mailto:|tel:)/,N="relationships/",j=r("short-date-short-time");function Z(e){if(null!=e)return(e.sourceLayer||e.layer)??void 0}async function E(e,t){return"function"==typeof e?e(t):e}function x(e=""){if(e)return!F.test(e.trim().toLowerCase())}function q(e){return!!e&&h.test(e)}function v(e,t){const n=function(e,t){if(!q(t)||!e)return null;const n=t.replace(h,"").toLowerCase();let r=null;return e.some((e=>e.name.toLowerCase()===n&&(r=e,!0))),r}(t,e?.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function C(e,t){const n=A(t,e);return n?n.name:e}function U(e,t){return e&&e.map((e=>C(e,t)))}function A(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function L(e){return`${e}`.trim()}function M({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:i,fieldInfoMap:o}){return r?R({formattedAttributes:t,template:k(r,{...t,...i,...e},n),fieldInfoMap:o}):""}function R({formattedAttributes:e,template:n,fieldInfoMap:r}){return L((i=t(t(n,(e=>function(e,t){const n=t.get(e.toLowerCase());return`{${n?.fieldName||e}}`}(e,r))),e),i.replaceAll(y,"")));var i}function $(e,t){return e.replaceAll(g,((e,n,r)=>{const i=A(t,r);return i?`{${i.name}}`:n}))}function k(e,n,r){const i=$(e,r);return i?i.replaceAll(w,((e,r,i)=>function(e,n,r){const i=(n=L(n))&&"{"!==n[0];return t(e,function(e,t=!1){const n={...e};return Object.keys(n).forEach((e=>function(e,t,n=!1){const r=t[e];if("string"==typeof r){const i="%27",o=(n?encodeURIComponent(r):r).replaceAll(I,i);t[e]=o}}(e,n,t))),n}(r,i||!1))}(e,r||i,n))):i}function D(e){return function(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type)&&"when"in e}(e)&&function(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}(e)}function z(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&D(e.sourceLayer)}function O(e,t,n,r){return e.trim().split(t).map((e=>i(Number(e),o(r)))).join(n)}function G(e,t){if(e?.length&&t)return e.find((e=>e.fieldName?.toLowerCase()===t.toLowerCase()))}function S(e,t,r,i){const{creatorField:o,creationDateField:a,editorField:l,editDateField:s}=e;if(!t)return;const u=p(i&&"preferredTimeZone"in i?i.preferredTimeZone:null,!(!i||!("datesInUnknownTimezone"in i)||!i.datesInUnknownTimezone),r,j,"date"),f={...j,...u},c=t[s];if("number"==typeof c){const e=t[l];return{type:"edit",date:n(c,f),user:e}}const d=t[a];if("number"==typeof d){const e=t[o];return{type:"create",date:n(d,f),user:e}}return null}function P(e,t){const n=new Map;return e?(e.forEach((e=>{const r=C(e.fieldName,t);e.fieldName=r,n.set(r.toLowerCase(),e)})),n):n}function Q(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)?(r.forEach((e=>{if("fields"===e.type){const n=e?.fieldInfos;n&&t.push(...n)}})),t):t}function _(e){return e.replaceAll(T,(e=>`&#${e.charCodeAt(0)};`))}function H(e){return"string"==typeof e?e.replaceAll(b,'<br class="esri-text-new-line" />'):e}function B(e){const{value:t,fieldName:n,fieldInfos:r,fieldInfoMap:a,layer:u,graphic:d,timeZone:p}=e;if(null==t)return"";const m=function({fieldName:e,value:t,graphic:n,layer:r}){if(W(e))return null;if(!r||"function"!=typeof r.getFieldDomain)return null;const i=n&&r.getFieldDomain(e,{feature:n});return i&&"coded-value"===i.type?i.getName(t):null}({fieldName:n,value:t,graphic:d,layer:u});if(m)return m;const y=function({fieldName:e,graphic:t,layer:n}){if(W(e))return null;if(!n||"function"!=typeof n.getFeatureType)return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const i=n.getFeatureType(t);return i?i.name:null}({fieldName:n,graphic:d,layer:u});if(y)return y;if(a.get(n.toLowerCase()))return function(e,t){const{fieldInfos:n,fieldName:r,preventPlacesFormatting:a,layer:l,timeZone:u}=t,f=G(n,r),d=A(l,r);if(f&&!s(r)){const t=d?.type,n=f.format?.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||n)return c(e,{format:n,fieldType:t,timeZoneOptions:{layerTimeZone:l&&"preferredTimeZone"in l?l.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!l||!("datesInUnknownTimezone"in l)||!l.datesInUnknownTimezone)}})}const p=f?.format;return"string"==typeof e&&s(r)&&p?function(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?O(e,",",", ",t):e.includes(";")?O(e,";","; ",t):e.includes(" ")?O(e," "," ",t):i(Number(e),o(t))}(e,p):(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,p),"string"==typeof e||null==e||null==p?H(e):i(e,a?{...o(p),minimumFractionDigits:0,maximumFractionDigits:20}:o(p)))}(t,{fieldInfos:r||Array.from(a.values()),fieldName:n,layer:u,timeZone:p});const g=u?.fieldsIndex?.get(n);return g&&(f(g)||l(g))?c(t,{fieldType:g.type,timeZoneOptions:{layerTimeZone:u&&"preferredTimeZone"in u?u.preferredTimeZone:null,viewTimeZone:p,datesInUnknownTimezone:!(!u||!("datesInUnknownTimezone"in u)||!u.datesInUnknownTimezone)}}):H(t)}function J({fieldInfos:e,attributes:t,layer:n,graphic:r,fieldInfoMap:i,relatedInfos:o,timeZone:a}){const l={};return o?.forEach((t=>function({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}){e&&t&&(t.relatedFeatures?.forEach((a=>X({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}))),t.relatedStatsFeatures?.forEach((a=>X({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}))))}({attributes:l,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:n,timeZone:a}))),t&&Object.keys(t).forEach((o=>{const s=t[o];l[o]=B({fieldName:o,fieldInfos:e,fieldInfoMap:i,layer:n,value:s,graphic:r,timeZone:a})})),l}async function K(e,t){const{layer:n,graphic:r,outFields:i,objectIds:o,returnGeometry:a,spatialReference:l}=e,s=o[0];if("number"!=typeof s&&"string"!=typeof s){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:n,graphic:r,objectId:s,requiredFields:i};return m.warn(e,t),null}if(!u(n)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:n,graphic:r,requiredFields:i,returnGeometry:a};return m.warn(e,t),null}const f=n.createQuery();return f.objectIds=o,f.outFields=i?.length?i:[n.objectIdField],f.returnGeometry=!!a,f.returnZ=!!a,f.returnM=!!a,f.outSpatialReference=l,(await n.queryFeatures(f,t)).features[0]}async function V({graphic:e,popupTemplate:t,layer:n,spatialReference:r},i){if(!n||!t)return;if("function"==typeof n.load&&await n.load(i),!e.attributes)return;const o=e.attributes[n.objectIdField];if(null==o)return;const l=[o],s=await t.getRequiredFields(n.fieldsIndex),u=a(s,e),f=u?[]:s,c=t.returnGeometry||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await d(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}(t);if(u&&!c)return;const p=await K({layer:n,graphic:e,outFields:f,objectIds:l,returnGeometry:c,spatialReference:r},i);p&&(p.geometry&&(e.geometry=p.geometry),p.attributes&&(e.attributes={...e.attributes,...p.attributes}))}function W(e=""){return!!e&&e.includes(N)}function X({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:i,layer:o,timeZone:a}){e&&t&&n&&Object.keys(t.attributes).forEach((l=>{const s=(u={layerId:n.relation.id.toString(),fieldName:l})?`${N}${u.layerId}/${u.fieldName}`:"";var u;const f=t.attributes[l];e[s]=B({fieldName:s,fieldInfos:r,fieldInfoMap:i,layer:o,value:f,graphic:t,timeZone:a})}))}const Y=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},ee=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const i=null!=n.where?n.where:null,o=null!=n.geometry?n.geometry:null;Y(r)||Y(i)||"extent"===o?.type||"tile"===n.resultType||(n.cacheHint=!0)},te=({query:e,layer:t,method:n})=>{ee({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},ne=({queryPayload:e,layer:t,method:n})=>{ee({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})};function re(e,t,n){return e&&t&&n?ie(e.allLayers,t,n)||ie(e.allTables,t,n):null}function ie(e,t,n){const r="scene"===t.type&&t.associatedLayer?t.associatedLayer.url:t.url;return e.filter(D).find((e=>e!==t&&e.url===r&&e.layerId===n.relatedTableId))}function oe(e){const t=e.getObjectId();return null!=t?`oid:${t}`:`uid:${e.uid}`}export{Z as a,D as b,C as c,E as d,v as e,re as f,oe as g,W as h,z as i,M as j,$ as k,R as l,U as m,q as n,G as o,H as p,_ as q,P as r,x as s,Q as t,K as u,S as v,V as w,J as x,te as y,ne as z};
