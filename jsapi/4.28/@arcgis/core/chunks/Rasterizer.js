/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{h as e}from"./mathUtils.js";import{s as a,C as t,R as r}from"./CIMSymbolHelper.js";import{r as i,a as n}from"./rasterizingUtils.js";import{g as s,b as o}from"./cimAnalyzer.js";import{D as l}from"./utils9.js";class m{constructor(e){this._resourceManager=e,this._lazyRasterizationCanvas=null}dispose(){this._lazyRasterizationCanvas=null}get _rasterizationCanvas(){return null==this._lazyRasterizationCanvas&&(this._lazyRasterizationCanvas=document.createElement("canvas"),this._lazyRasterizationCanvas.getContext("2d",{willReadFrequently:!0})),this._lazyRasterizationCanvas}rasterizeJSONResource(l,m,c){if("simple-fill"===l.type||"esriSFS"===l.type){const[a,t,r]=i(this._rasterizationCanvas,l.style,m);return{size:[t,r],image:new Uint32Array(a.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:e(Math.ceil(m))}}if("simple-line"===l.type||"esriSLS"===l.type||"line"===l.type&&l.dashTemplate){let e,t;if("simple-line"===l.type||"esriSLS"===l.type)switch(e=a(l.style,l.cap),l.cap){case"butt":t="Butt";break;case"square":t="Square";break;default:t="Round"}else e=l.dashTemplate,t=l.cim.capStyle;const[r,i,s]=n(e,t);return{size:[i,s],image:new Uint32Array(r.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let f,h=null,y=null,p=1;if("simple-marker"===l.type||"esriSMS"===l.type||"line-marker"===l.type?(f=t.fromSimpleMarker(l),y=s(f)):l.cim&&"CIMHatchFill"===l.cim.type?(f=t.fromCIMHatchFill(l.cim,m),h=new r(f.frame.xmin,-f.frame.ymax,f.frame.xmax-f.frame.xmin,f.frame.ymax-f.frame.ymin),p=m):l.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===l.cim.markerPlacement.type?(f=t.fromCIMInsidePolygon(l.cim),h=new r(f.frame.xmin,-f.frame.ymax,f.frame.xmax-f.frame.xmin,f.frame.ymax-f.frame.ymin)):(f=l.cim,l.avoidSDFRasterization||(y=s(f))),y&&!c){const[e,a,t]=o(y);return e?{size:[a,t],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:p}:null}const[u,z,d,C,g]=t.rasterize(this._rasterizationCanvas,f,h,this._resourceManager,!c);return u?{size:[z,d],image:new Uint32Array(u.buffer),sdf:!1,simplePattern:!1,anchorX:C,anchorY:g}:null}rasterizeImageResource(e,a,t,r){this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=a;const i=this._rasterizationCanvas.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):(t.setAttribute("width",`${e}px`),t.setAttribute("height",`${a}px`),i.drawImage(t,0,0,e,a));const n=i.getImageData(0,0,e,a),s=new Uint8Array(n.data);if(r)for(const e of r)if(e&&e.oldColor&&4===e.oldColor.length&&e.newColor&&4===e.newColor.length){const[a,t,r,i]=e.oldColor,[n,o,l,m]=e.newColor;if(a===n&&t===o&&r===l&&i===m)continue;for(let e=0;e<s.length;e+=4)a===s[e]&&t===s[e+1]&&r===s[e+2]&&i===s[e+3]&&(s[e]=n,s[e+1]=o,s[e+2]=l,s[e+3]=m)}let o;for(let e=0;e<s.length;e+=4)o=s[e+3]/255,s[e]=s[e]*o,s[e+1]=s[e+1]*o,s[e+2]=s[e+2]*o;let m=s,c=e,f=a;const h=512;if(c>=h||f>=h){const t=c/f;t>1?(c=h,f=Math.round(h/t)):(f=h,c=Math.round(h*t)),m=new Uint8Array(4*c*f);const r=new Uint8ClampedArray(m.buffer);l(s,e,a,r,c,f,!1)}return{size:[c,f],image:new Uint32Array(m.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}export{m as R};
