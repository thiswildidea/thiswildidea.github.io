/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../Color.js";import{g as t}from"./fontUtils.js";import{clone as i}from"../core/lang.js";import{n as r,L as o}from"./Logger.js";import{d as n,p as a}from"./screenUtils.js";import{a as s,A as l}from"./arcadeOnDemand.js";import{R as c,g as f,S as m,c as u,C as h,O as p,d as y,e as d,f as v,h as g,i as S}from"./CIMSymbolHelper.js";import{A as O,C as _,J as M}from"./enums.js";import{p as k}from"./floatRGBA.js";import{isExtent as b}from"../geometry/support/jsonUtils.js";import{C as N,B as P}from"./definitions.js";import{f as C,A as L,g as z,l as F,o as x,n as I,B as w,e as A,h as R,C as X,x as H,y as J,j as E,k as Y}from"./utils9.js";import{G}from"./labelPoint.js";import{h as T}from"../geometry/Polygon.js";import{c as $}from"./callExpressionWithFeature.js";const j=new Set(["StartTimeOffset","Duration","RepeatDelay"]);function D(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&1===t.length?D(t[0]):null}case"CIMVectorMarker":{const t=e.markerGraphics;if(!t||1!==t.length)return null;const i=t[0];if(!i)return null;const r=i.geometry;if(!r)return null;const o=i.symbol;return!o||"CIMPolygonSymbol"!==o.type&&"CIMLineSymbol"!==o.type||o.symbolLayers?.some((e=>!!e.effects))?null:{geom:r,asFill:"CIMPolygonSymbol"===o.type}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function U(e){let t=1/0,i=-1/0,r=1/0,o=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>i&&(i=e[0]),e[1]<r&&(r=e[1]),e[1]>o&&(o=e[1]);return[t,r,i,o]}function W(e){return e?e.rings?U(e.rings):e.paths?U(e.paths):b(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function V(e,t,i,r,o){const[n,a,s,l]=e;if(s<n||l<a)return[0,0,0];const c=s-n,f=l-a,m=N,u=Math.floor(.5*(64-m)),h=(128-2*(u+m))/Math.max(c,f),p=Math.round(c*h)+2*u,y=Math.round(f*h)+2*u;let d=1;t&&(d=y/h/(t.ymax-t.ymin));let v=0,g=0,S=1;r&&(o?t&&i&&t.ymax-t.ymin>0&&(S=(t.xmax-t.xmin)/(t.ymax-t.ymin),v=r.x/(i*S),g=r.y/i):(v=r.x,g=r.y)),t&&(v=.5*(t.xmax+t.xmin)+v*(t.xmax-t.xmin),g=.5*(t.ymax+t.ymin)+g*(t.ymax-t.ymin)),v-=n,g-=a,v*=h,g*=h,v+=u,g+=u;let O=v/p-.5,_=g/y-.5;return o&&i&&(O*=i*S,_*=i),[d,O,_]}function B(e){const t=(i=e.geom)?i.rings?i.rings:i.paths?i.paths:void 0!==i.xmin&&void 0!==i.ymin&&void 0!==i.xmax&&void 0!==i.ymax?[[[i.xmin,i.ymin],[i.xmin,i.ymax],[i.xmax,i.ymax],[i.xmax,i.ymin],[i.xmin,i.ymin]]]:null:null;var i;const r=function(e){let t=1/0,i=-1/0,r=1/0,o=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>i&&(i=e[0]),e[1]<r&&(r=e[1]),e[1]>o&&(o=e[1]);return new c(t,r,i-t,o-r)}(t),o=N,n=Math.floor(.5*(64-o)),a=(128-2*(n+o))/Math.max(r.width,r.height),s=Math.round(r.width*a)+2*n,l=Math.round(r.height*a)+2*n,f=[];for(const i of t)if(i&&i.length>1){const t=[];for(const o of i){let[i,s]=o;i-=r.x,s-=r.y,i*=a,s*=a,i+=n-.5,s+=n-.5,e.asFill?t.push([i,s]):t.push([Math.round(i),Math.round(s)])}if(e.asFill){const e=t.length-1;t[0][0]===t[e][0]&&t[0][1]===t[e][1]||t.push(t[0])}f.push(t)}const m=function(e,t,i,r){const o=t*i,n=new Array(o),a=r*r+1;for(let e=0;e<o;++e)n[e]=a;for(const o of e){const e=o.length;for(let a=1;a<e;++a){const e=o[a-1],s=o[a];let l,c,f,m;e[0]<s[0]?(l=e[0],c=s[0]):(l=s[0],c=e[0]),e[1]<s[1]?(f=e[1],m=s[1]):(f=s[1],m=e[1]);let u=Math.floor(l)-r,h=Math.floor(c)+r,p=Math.floor(f)-r,y=Math.floor(m)+r;u<0&&(u=0),h>t&&(h=t),p<0&&(p=0),y>i&&(y=i);const d=s[0]-e[0],v=s[1]-e[1],g=d*d+v*v;for(let r=u;r<h;r++)for(let o=p;o<y;o++){let a,l,c=(r-e[0])*d+(o-e[1])*v;c<0?(a=e[0],l=e[1]):c>g?(a=s[0],l=s[1]):(c/=g,a=e[0]+c*d,l=e[1]+c*v);const f=(r-a)*(r-a)+(o-l)*(o-l),m=(i-o-1)*t+r;f<n[m]&&(n[m]=f)}}}for(let e=0;e<o;++e)n[e]=Math.sqrt(n[e]);return n}(f,s,l,n);return e.asFill&&function(e,t,i,r,o){for(const n of e){const e=n.length;for(let a=1;a<e;++a){const e=n[a-1],s=n[a];let l,c,f,m;e[0]<s[0]?(l=e[0],c=s[0]):(l=s[0],c=e[0]),e[1]<s[1]?(f=e[1],m=s[1]):(f=s[1],m=e[1]);let u=Math.floor(l),h=Math.floor(c)+1,p=Math.floor(f),y=Math.floor(m)+1;u<r&&(u=r),h>t-r&&(h=t-r),p<r&&(p=r),y>i-r&&(y=i-r);for(let n=p;n<y;++n){if(e[1]>n==s[1]>n)continue;const a=(i-n-1)*t;for(let t=u;t<h;++t)t<(s[0]-e[0])*(n-e[1])/(s[1]-e[1])+e[0]&&(o[a+t]=-o[a+t]);for(let e=r;e<u;++e)o[a+e]=-o[a+e]}}}}(f,s,l,n,m),[q(m,n),s,l]}function q(e,t){const i=2*t,r=e.length,o=new Uint8Array(4*r);for(let t=0;t<r;++t){const r=.5-e[t]/i;k(r,o,4*t)}return o}class K{static executeEffects(e,t,i,r){const o=f(e);let n=new m(t);for(const t of e){const e=u(t);e&&(n=e.execute(n,t,1.3333333333333333,i,r,o))}return n}static applyEffects(e,t,i){if(!e)return t;const r=f(e);let o,n=new m(G.fromJSONCIM(t));for(const t of e){const e=u(t);e&&(n=e.execute(n,t,1,null,i,r))}const a=[];let s=null;for(;o=n.next();)a.push(...T(o)),s=o.geometryType;return 0===a.length||null===s?null:"esriGeometryPolygon"===s?{rings:a}:{paths:a}}}function Q(e,t){let i;if("string"==typeof e)i=r(e+`-seed(${t})`);else{let r=12;i=e^t;do{i=107*(i>>8^i)+r|0}while(0!=--r)}return(1+i/(1<<31))/2}function Z(e){return Math.floor(Q(e,ee)*te)}const ee=53290320,te=10,ie=o.getLogger("esri.symbols.cim.cimAnalyzer");function re(e){switch(e){case"Butt":return _.BUTT;case"Square":return _.SQUARE;default:return _.ROUND}}function oe(e){switch(e){case"Bevel":return M.BEVEL;case"Miter":return M.MITER;default:return M.ROUND}}function ne(e){const t=e.markerPlacement;return t&&t.angleToLine?O.MAP:O.SCREEN}class ae{constructor(e,t){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],this._resourceManager=e,this._info=t}async analyzeSymbolReference(e,t,i){if(this._cimLayers=i??[],!e)return this._cimLayers;if(e.primitiveOverrides){this._primitiveOverrides=e.primitiveOverrides,this._poMap={};const t=[],i=this._info;for(const e of this._primitiveOverrides){const r=e.valueExpressionInfo;if(r&&i){const o=r.expression,n=s(o,i.spatialReference,i.fields).then((t=>{null!=t&&this._setPoMap(e.primitiveName,e.propertyName,t)}));t.push(n)}else null!=e.value&&this._setPoMap(e.primitiveName,e.propertyName,e.value);t.length>0&&await Promise.all(t)}}const r=e.symbol,o=[];return h.fetchResources(r,this._resourceManager,o),o.length>0&&await Promise.all(o),this._analyzeSymbol(r,t),this._cimLayers}_analyzeSymbol(e,t){switch(e?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(e,t,1,0,0,0)}}_analyzeMultiLayerSymbol(e,t,i,r,o,n){const a=e?.symbolLayers;if(!a)return;const s=e.effects;let l=O.SCREEN;const c=h.getSize(e)??0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(l=O.MAP);const f="CIMPolygonSymbol"===e.type;let m=a.length;for(;m--;){const u=a[m];if(!u||!1===u.enable)continue;let h;s?.length&&(h=[...s]);const y=u.effects;y?.length&&(s?h.push(...y):h=[...y]);const d=[];let v;p.findEffectOverrides(h,this._primitiveOverrides,d),v=d.length>0?this._createEffectsOverrideFunction(h,d):h;const g=[];switch(p.findApplicableOverrides(u,this._primitiveOverrides,g),u.type){case"CIMSolidFill":this._analyzeSolidFill(u,v);break;case"CIMPictureFill":this._analyzePictureFill(u,v);break;case"CIMHatchFill":this._analyzeHatchFill(u,v);break;case"CIMGradientFill":this._analyzeGradientFill(u,v);break;case"CIMSolidStroke":this._analyzeSolidStroke(u,v,f,c);break;case"CIMPictureStroke":this._analyzePictureStroke(u,v,f,c);break;case"CIMGradientStroke":this._analyzeGradientStroke(u,v,f,c);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"===e.type&&(l=ne(u));const a=[],s=u.primitiveName;s&&a.push(s),this._analyzeMarker(u,v,null,a,l,c,1,t,i,r,o,n);break}default:ie.error("Cannot analyze CIM layer",u.type)}}}_analyzeSolidFill(e,t){const i=e.primitiveName,o=C(e.color),[n,a]=this._analyzePrimitiveOverrides(i,t,null,null),s=r(JSON.stringify(e)+a).toString();this._cimLayers.push({type:"fill",templateHash:s,materialHash:n?()=>s:s,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,color:this._createOverrideFunction(i,"Color",o,le),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t,applyRandomOffset:!1,sampleAlphaOnly:!0})}_analyzePictureFill(e,t){const i=e.primitiveName,o=L(e),[n,a]=this._analyzePrimitiveOverrides(i,t,null,null),s=r(JSON.stringify(e)+a).toString(),l=r(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),c=z(e.height,y);let f=z(e.scaleX,1);if("width"in e&&"number"==typeof e.width){const t=e.width;let i=1;const r=this._resourceManager.getResource(e.url);null!=r&&(i=r.width/r.height),f/=i*(c/t)}this._cimLayers.push({type:"fill",templateHash:s,materialHash:n?()=>l:l,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(i,"TintColor",o,le),height:this._createOverrideFunction(i,"Height",c),scaleX:this._createOverrideFunction(i,"ScaleX",f),angle:this._createOverrideFunction(i,"Rotation",z(e.rotation)),offsetX:this._createOverrideFunction(i,"OffsetX",z(e.offsetX)),offsetY:this._createOverrideFunction(i,"OffsetY",z(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeHatchFill(e,t){const i=e.primitiveName,o=this._analyzeMaterialOverrides(i,["Rotation","OffsetX","OffsetY"]);let[n,a]=this._analyzePrimitiveOverrides(i,t,null,null);const s=r(JSON.stringify(e)+a).toString(),l=r(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let c={r:255,g:255,b:255,a:1},f=!1;const m=e.lineSymbol?.symbolLayers?.find((e=>"CIMSolidStroke"===e.type&&null!=this._poMap[e.primitiveName]?.Color));if(m){c=C(m.color),c=this._createOverrideFunction(m.primitiveName,"Color",c,le);const e="function"==typeof c;n=n||e,f=null!=m.color||e}this._cimLayers.push({type:"fill",templateHash:s,materialHash:n&&o?this._createMaterialHashFunction(l,o):l,cim:e,materialOverrides:o,colorLocked:!!e.colorLocked,effects:t,color:c,height:this._createOverrideFunction(i,"Separation",z(e.separation,d)),scaleX:1,angle:this._createOverrideFunction(i,"Rotation",z(e.rotation)),offsetX:this._createOverrideFunction(i,"OffsetX",z(e.offsetX)),offsetY:this._createOverrideFunction(i,"OffsetY",z(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!f})}_analyzeGradientFill(e,t){const i=e.primitiveName,[o,n]=this._analyzePrimitiveOverrides(i,t,null,null),a=r(JSON.stringify(e)+n).toString();this._cimLayers.push({type:"fill",templateHash:a,materialHash:o?()=>a:a,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeSolidStroke(e,t,i,o){const n=e.primitiveName,a=C(e.color),s=z(e.width,v),l=re(e.capStyle),c=oe(e.joinStyle),f=e.miterLimit,[m,u]=this._analyzePrimitiveOverrides(n,t,null,null),h=r(JSON.stringify(e)+u).toString();let p,y;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();p=e.dashTemplate,y=e.scaleDash}}this._cimLayers.push({type:"line",templateHash:h,materialHash:m?()=>h:h,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(n,"Color",a,le),width:this._createOverrideFunction(n,"Width",s),cap:this._createOverrideFunction(n,"CapStyle",l),join:this._createOverrideFunction(n,"JoinStyle",c),miterLimit:f&&this._createOverrideFunction(n,"MiterLimit",f),referenceWidth:o,zOrder:se(e.name),dashTemplate:p,scaleDash:y,sampleAlphaOnly:!0})}_analyzePictureStroke(e,t,i,o){const n=r(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),a=e.primitiveName,s=L(e),l=z(e.width,v),c=re(e.capStyle),f=oe(e.joinStyle),m=e.miterLimit,[u,h]=this._analyzePrimitiveOverrides(a,t,null,null),p=r(JSON.stringify(e)+h).toString();this._cimLayers.push({type:"line",templateHash:p,materialHash:u?()=>n:n,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(a,"TintColor",s,le),width:this._createOverrideFunction(a,"Width",l),cap:this._createOverrideFunction(a,"CapStyle",c),join:this._createOverrideFunction(a,"JoinStyle",f),miterLimit:m&&this._createOverrideFunction(a,"MiterLimit",m),referenceWidth:o,zOrder:se(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})}_analyzeGradientStroke(e,t,i,o){const n=e.primitiveName,a=z(e.width,v),s=re(e.capStyle),l=oe(e.joinStyle),c=e.miterLimit,[f,m]=this._analyzePrimitiveOverrides(n,t,null,null),u=r(JSON.stringify(e)+m).toString();this._cimLayers.push({type:"line",templateHash:u,materialHash:f?()=>u:u,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:this._createOverrideFunction(n,"Width",a),cap:this._createOverrideFunction(n,"CapStyle",s),join:this._createOverrideFunction(n,"JoinStyle",l),miterLimit:c&&this._createOverrideFunction(n,"MiterLimit",c),referenceWidth:o,zOrder:se(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(e,t,i,r,o,n,a,s,l,c,f,m,u=!1){if(this._analyzeMarkerInsidePolygon(e,t))return;const h=z(e.size,g),p=z(e.rotation),y=z(e.offsetX),d=z(e.offsetY);let v=this._createOverrideFunction(e.primitiveName,"Size",h),S=this._createOverrideFunction(e.primitiveName,"Rotation",p),O=this._createOverrideFunction(e.primitiveName,"OffsetX",y),_=this._createOverrideFunction(e.primitiveName,"OffsetY",d);v=this._transformSize(v,a),S=this._transformRotation(S,!!e.rotateClockwise,c);const M=this._transformOffsetX(O,_,c,a,f),k=this._transformOffsetY(O,_,c,a,m);switch(O=M,_=k,e.type){case"CIMPictureMarker":this._analyzePictureMarker(e,t,i,r,o,n,v,S,O,_,e.colorLocked||u);break;case"CIMVectorMarker":this._analyzeVectorMarker(e,t,i,r,o,n,a,s,v,S,O,_,e.colorLocked||u)}}_analyzeMarkerInsidePolygon(e,t){const{markerPlacement:i,type:o}=e;if(!i||"CIMMarkerPlacementInsidePolygon"!==i.type)return!1;if("CIMVectorMarker"===o||"CIMPictureMarker"===o){const r=e.primitiveName;if(r){const[e,i]=this._analyzePrimitiveOverrides([r],t,null,null);if(e)return!1}const n=i.primitiveName;if(n){const[e,i]=this._analyzePrimitiveOverrides([n],t,null,null);if(e)return!1}if("CIMVectorMarker"===o){const{markerGraphics:t}=e;if(t)for(const e of t){const{symbol:t}=e;if("CIMPolygonSymbol"===t?.type&&t.symbolLayers){const{symbolLayers:e}=t;for(const t of e)if("CIMSolidStroke"===t.type)return!1}}}else{const{animatedSymbolProperties:t}=e;if(t)return!1}}const n=i,s=Math.abs(n.stepX),l=Math.abs(n.stepY);if(0===s||0===l)return!0;const c=new Set(["Rotation","OffsetX","OffsetY"]),f=this._primitiveOverrides.filter((t=>t.primitiveName!==e.primitiveName||!c.has(t.propertyName))),m="url"in e&&"string"==typeof e.url?e.url:void 0,u=r(JSON.stringify(e)).toString();let h,p,y=null;if("Random"===i.gridType){const e=a(P),t=Math.max(Math.floor(e/s),1),i=Math.max(Math.floor(e/l),1);h=l*i,y=e=>e?e*i:0,p=t*s/h}else i.shiftOddRows?(h=2*l,y=e=>e?2*e:0,p=s/l*.5):(h=l,y=null,p=s/l);const d=L(e);return this._cimLayers.push({type:"fill",templateHash:u,materialHash:u,cim:e,materialOverrides:f,colorLocked:!!e.colorLocked,effects:t,color:d,height:this._createOverrideFunction(n.primitiveName,"StepY",h,y),scaleX:p,angle:n.gridAngle,offsetX:z(n.offsetX),offsetY:z(n.offsetY),url:m,applyRandomOffset:"Random"===i.gridType,sampleAlphaOnly:!m,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(e,t,i,o,n,a,s,l,c,f,m){let u=z(e.scaleX,1);const h=L(e),p=r(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString();i||(i=this._createMarkerPlacementOverrideFunction(e.markerPlacement));const y=this._createAnimatedSymbolPropertiesOverrideFunction(e.animatedSymbolProperties),[d,v]=this._analyzePrimitiveOverrides(o,t,i,y),g=r(JSON.stringify(e)+v).toString(),S=e.anchorPoint??{x:0,y:0};if("width"in e&&"number"==typeof e.width){const t=e.width;let i=1;const r=this._resourceManager.getResource(e.url);null!=r&&(i=r.width/r.height),u/=i*(z(e.size)/t)}function O(e,t){return null!=y?J(y,e,t):null}const _=e.animatedSymbolProperties&&!0===e.animatedSymbolProperties.randomizeStartTime?(e,t,i,r)=>{const o=Z(r??0),n=O(e,t);return p+`-MATERIALGROUP(${o})`+`-ASP(${JSON.stringify(n)})`}:d?(e,t)=>{const i=O(e,t);return p+`-ASP(${JSON.stringify(i)})`}:p;this._cimLayers.push({type:"marker",templateHash:g,materialHash:_,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked||!!m,effects:t,scaleSymbolsProportionally:!1,alignment:n,size:s,scaleX:this._createOverrideFunction(e.primitiveName,"ScaleX",u),rotation:l,offsetX:c,offsetY:f,color:this._createOverrideFunction(e.primitiveName,"TintColor",h,le),anchorPoint:{x:S.x,y:S.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:!1,referenceSize:a,sizeRatio:1,markerPlacement:i,url:e.url,animatedSymbolProperties:y})}_analyzeVectorMarker(e,t,i,r,o,n,a,s,l,c,f,m,u){const h=e.markerGraphics;if(!h)return;const p=e.frame;let y=0,d=1;e.scaleSymbolsProportionally&&p&&(y=p.ymax-p.ymin,d=this._transformSize(l,1/y)),d=this._transformSize(d,a),i||(i=this._createMarkerPlacementOverrideFunction(e.markerPlacement));for(const a of h)if(a){const h=a.symbol;if(!h)continue;const v=a.primitiveName;v&&r.push(v);let g=f,S=m;if(("CIMPointSymbol"===h.type||"CIMTextSymbol"===h.type)&&p){let t=0,i=0;const r=a.geometry;"x"in r&&"y"in r&&(t+=r.x-.5*(p.xmin+p.xmax),i+=r.y-.5*(p.ymin+p.ymax));const o=e.anchorPoint;o&&("Absolute"===e.anchorPointUnits?(t-=o.x,i-=o.y):p&&(t-=(p.xmax-p.xmin)*o.x,i-=(p.ymax-p.ymin)*o.y)),g=this._transformOffsetX(t,i,c,d,f),S=this._transformOffsetY(t,i,c,d,m)}switch(h.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":s||ue(h)?this._analyzeMultiLayerGraphicNonSDF(e,t,i,null,a,r,o,n,y,!!u||!!e.colorLocked):this._analyzeMultiLayerGraphic(e,t,i,null,a,r,o,n,y,d,l,c,g,S,!!u||!!e.colorLocked);break;case"CIMTextSymbol":this._analyzeTextGraphic(e,t,i,a,r,o,n,y,d,l,c,g,S,!!u||!!e.colorLocked)}v&&r.pop()}}_analyzeMultiLayerGraphic(e,t,i,o,n,a,s,l,c,f,m,u,h,p,y){const d=n.symbol,v=d.symbolLayers;if(!v)return;let g=v.length;if(me(v))return void this._analyzeCompositeMarkerGraphic(e,t,i,o,n,v,a,s,l,c,m,u,h,p,!!y||!!e.colorLocked);const S=this._resourceManager.geometryEngine,O=K.applyEffects(d.effects,n.geometry,S);if(O)for(;g--;){const d=v[g];if(!d||!1===d.enable)continue;const _=d.primitiveName;switch(_&&a.push(_),d.type){case"CIMSolidFill":case"CIMSolidStroke":{const f=K.applyEffects(d.effects,O,S),v=W(f);if(!v)continue;const g="Relative"!==e.anchorPointUnits,[M,k,b]=V(v,e.frame,e.size,e.anchorPoint,g),N="CIMSolidFill"===d.type,P={type:"sdf",geom:f,asFill:N},L=d.path,z=N?C(F(d)):null==L?C(x(d)):{r:0,g:0,b:0,a:0},A=N?{r:0,g:0,b:0,a:0}:C(x(d)),R=I(d)??0;if(!N&&!R)break;const X=n.primitiveName;let H=null;N&&!d.colorLocked&&(H=this._createOverrideFunction(X,"FillColor",z,le));let J=null;N||d.colorLocked||(J=this._createOverrideFunction(X,"StrokeColor",A,le));const E=this._createOverrideFunction(X,"StrokeWidth",R);let Y=!1,G="";for(const e of this._primitiveOverrides)a.includes(e.primitiveName)&&(null!=e.value?G+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(Y=!0));(null!=t&&"function"==typeof t||null!=i&&"function"==typeof i)&&(Y=!0),(w(m)||w(u)||w(h)||w(p))&&(Y=!0);const T=JSON.stringify({...e,markerGraphics:null}),$=r(JSON.stringify(P)+L).toString(),j=r(JSON.stringify(n)+JSON.stringify(d)+T+G).toString();this._cimLayers.push({type:"marker",templateHash:j,materialHash:Y?()=>$:$,cim:P,materialOverrides:null,colorLocked:!!d.colorLocked||!!y,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:k,y:b},isAbsoluteAnchorPoint:g,size:m,rotation:u,offsetX:h,offsetY:p,scaleX:1,frameHeight:c,rotateClockwise:!1,referenceSize:l,sizeRatio:M,color:w(H)?H:this._createOverrideFunction(_,"Color",z,le),outlineColor:w(J)?J:this._createOverrideFunction(_,"Color",A,le),outlineWidth:w(E)?E:this._createOverrideFunction(_,"Width",R),markerPlacement:i,animatedSymbolProperties:o,path:L});break}case"CIMVectorMarker":d.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(e,t,i,o,n,a,s,l,c,!!y||!!d.colorLocked):this._analyzeMarker(d,t,i,a,s,l,f,!1,m,u,h,p,!!y||!!e.colorLocked);break;default:this._analyzeMultiLayerGraphicNonSDF(e,t,i,o,n,a,s,l,c,!!y||!!e.colorLocked)}_&&a.pop()}}_analyzeTextGraphic(e,i,o,n,a,s,l,c,f,m,u,h,y,d){p.findApplicableOverrides(n,this._primitiveOverrides,[]);const g=n.geometry;if(!("x"in g)||!("y"in g))return;const O=n.symbol,_=A(O),M=R(O.fontStyleName),k=t(O.fontFamilyName);O.font={family:k,decoration:_,...M};let b=z(O.height,S),N=z(O.angle),P=z(O.offsetX),L=z(O.offsetY);b=this._transformSize(b,f),N=this._transformRotation(N,!1,u);const G=this._transformOffsetX(P,L,u,f,h),T=this._transformOffsetY(P,L,u,f,y);P=G,L=T;const $=C(F(O));let j=C(x(O)),D=I(O)??0;D||(j=C(F(O.haloSymbol)),D=z(O.haloSize)),D=this._transformSize(D,f);let U=!1;if(O.symbol?.symbolLayers)for(const e of O.symbol.symbolLayers)null!=F(e)&&(U=!!e.colorLocked);const W=n.primitiveName;let V=null;U||(V=this._createOverrideFunction(W,"Color",$,le));let B=null,q=null,K=0;if(O.callout&&"CIMBackgroundCallout"===O.callout.type){const e=O.callout;if(e.backgroundSymbol){const t=e.backgroundSymbol.symbolLayers;if(t)for(const e of t)"CIMSolidFill"===e.type?B=C(e.color):"CIMSolidStroke"===e.type&&(q=C(e.color),K=z(e.width,v))}}const[Q,Z]=this._analyzePrimitiveOverrides(a,i,o,null),ee=JSON.stringify(e.effects)+Number(e.colorLocked||d).toString()+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement)+e.size.toString(),te=r(JSON.stringify(n)+ee+Z).toString();let ie=this._createOverrideFunction(n.primitiveName,"TextString",n.textString??"",X,O.textCase);if(null==ie)return;const{fontStyleName:re}=O,oe=k+(re?"-"+re.toLowerCase():"-regular"),ne=oe;"string"==typeof ie&&ie.includes("[")&&O.fieldMap&&(ie=H(O.fieldMap,ie,O.textCase)),this._cimLayers.push({type:"text",templateHash:te,materialHash:Q||"function"==typeof ie||/\[(.*?)\]/.test(ie)?(e,t,i)=>ne+"-"+J(ie,e,t,i):ne+"-"+r(ie),cim:O,materialOverrides:null,colorLocked:!!d||!!U,effects:i,alignment:s,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:oe,decoration:_,weight:M.weight,style:M.style,size:b,angle:N,offsetX:P,offsetY:L,horizontalAlignment:E(O.horizontalAlignment),verticalAlignment:Y(O.verticalAlignment),text:ie,color:w(V)?V:$,outlineColor:j,outlineSize:D,backgroundColor:B,borderLineColor:q,borderLineWidth:K,lineWidth:null,referenceSize:l,sizeRatio:1,markerPlacement:o})}_analyzeMultiLayerGraphicNonSDF(e,t,i,o,a,s,l,c,f,m){const u=this._buildSimpleMarker(e,a),p=e.primitiveName,y=this._analyzeMaterialOverrides(p,["Rotation","OffsetX","OffsetY"]),[d,v]=this._analyzePrimitiveOverrides(s,null,null,null),[S,O,_]=h.getTextureAnchor(u,this._resourceManager),M=z(e.rotation),k=z(e.offsetX),b=z(e.offsetY),N=r(JSON.stringify(u)+v).toString(),P=y&&y.length>0||null!=t&&"function"==typeof t;this._cimLayers.push({type:"marker",templateHash:N,materialHash:P&&y?this._createMaterialHashFunction(N,y):N,cim:u,materialOverrides:y,colorLocked:!!e.colorLocked||!!m,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:l,anchorPoint:{x:S,y:O},isAbsoluteAnchorPoint:!1,size:z(e.size,g),rotation:this._createOverrideFunction(p,"Rotation",M),offsetX:this._createOverrideFunction(p,"OffsetX",k),offsetY:this._createOverrideFunction(p,"OffsetY",b),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:f,rotateClockwise:!!e.rotateClockwise,referenceSize:c,sizeRatio:_/n(e.size),markerPlacement:i,animatedSymbolProperties:o,avoidSDFRasterization:!0})}_buildSimpleMarker(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}_analyzeCompositeMarkerGraphic(e,t,i,o,n,a,s,l,c,f,m,u,h,p,y){const d=n.geometry,g=a[0],S=a[1],O=W(d);if(!O)return;const _="Relative"!==e.anchorPointUnits,[M,k,b]=V(O,e.frame,e.size,e.anchorPoint,_),N={type:"sdf",geom:d,asFill:!0},P=S.path,L=S.primitiveName,F=g.primitiveName,x=C(S.color),I=C(g.color),A=z(g.width,v),R=n.primitiveName;let X=null;S.colorLocked||y||(X=this._createOverrideFunction(R,"FillColor",x,le));let H=null;g.colorLocked||y||(H=this._createOverrideFunction(R,"StrokeColor",I,le));const J=this._createOverrideFunction(R,"StrokeWidth",A);let E=!1,Y="";for(const e of this._primitiveOverrides)(e.primitiveName===L||e.primitiveName===F||s.includes(e.primitiveName))&&(null!=e.value?Y+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(E=!0));null!=i&&"function"==typeof i&&(E=!0),(w(m)||w(u)||w(h)||w(p))&&(E=!0);const G=JSON.stringify({...e,markerGraphics:null}),T=r(JSON.stringify(N)+P).toString(),$=r(JSON.stringify(n)+JSON.stringify(S)+JSON.stringify(g)+G+Y).toString();this._cimLayers.push({type:"marker",templateHash:$,materialHash:E?()=>T:T,cim:N,materialOverrides:null,colorLocked:!!y,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:l,anchorPoint:{x:k,y:b},isAbsoluteAnchorPoint:_,size:m,rotation:u,offsetX:h,offsetY:p,scaleX:1,frameHeight:f,rotateClockwise:!1,referenceSize:c,sizeRatio:M,color:w(X)?X:this._createOverrideFunction(L,"Color",x,le),outlineColor:w(H)?H:this._createOverrideFunction(F,"Color",I,le),outlineWidth:w(J)?J:this._createOverrideFunction(F,"Width",A),markerPlacement:i,path:P,animatedSymbolProperties:o})}_createMaterialHashFunction(e,t){const i=this._info?.geometryType;if(i){const e=this._poMap;for(const r of t)if(r.valueExpressionInfo){const t=e[r.primitiveName]&&e[r.primitiveName][r.propertyName];t instanceof l&&(r.fn=(e,r,o)=>$(t,e,{$view:o},i,r))}}return(i,o,n)=>{for(const e of t)e.fn&&(e.value=e.fn(i,o,n));return r(e+p.buildOverrideKey(t)).toString()}}_setPoMap(e,t,i){let r;this._poMap[e]?r=this._poMap[e]:(r={},this._poMap[e]=r),r[t]=i}_createOverrideFunction(e,t,i,r,o){if(null==e)return i;const n=this._poMap[e];if(null==n)return i;const a=n[t];if("string"==typeof a||"number"==typeof a||a instanceof Array)return r?r.call(null,a,o):a;const s=this._info?.geometryType;return null!=a&&a instanceof l&&null!=s?(e,t,n)=>{let l=$(a,e,{$view:n},s,t);return null!==l&&r&&(l=r.call(null,l,o)),null!==l?l:i}:i}_createEffectsOverrideFunction(e,t){const r=this._poMap,o=this._info?.geometryType;for(const e of t)if(e.valueExpressionInfo&&o){const t=r[e.primitiveName]&&r[e.primitiveName][e.propertyName];t instanceof l&&(e.fn=(e,i,r)=>$(t,e,{$view:r},o,i))}return(r,o,n)=>{for(const e of t)e.fn&&(e.value=e.fn(r,o,n));const a=[];for(let r of e){const e=r?.primitiveName;if(e){let o=!1;for(const n of t)if(n.primitiveName===e){const e=ce(n.propertyName);null!=n.value&&n.value!==r[e]&&(o||(r=i(r),o=!0),r[e]=n.value)}}a.push(r)}return a}}_createMarkerPlacementOverrideFunction(e){const t=[];if(p.findApplicableOverrides(e,this._primitiveOverrides,t),null==e||0===t.length)return e;const r=this._poMap,o=this._info?.geometryType;for(const e of t)if(e.valueExpressionInfo&&o){const t=r[e.primitiveName]&&r[e.primitiveName][e.propertyName];t instanceof l&&(e.fn=(e,i,r)=>$(t,e,{$view:r},o,i))}return(r,o,n)=>{for(const e of t)e.fn&&(e.value=e.fn(r,o,n));const a=i(e),s=e.primitiveName;for(const e of t)if(e.primitiveName===s){const t=ce(e.propertyName);null!=e.value&&e.value!==a[t]&&(a[t]=e.value)}return a}}_createAnimatedSymbolPropertiesOverrideFunction(e){const t=[];if(p.findApplicableOverrides(e,this._primitiveOverrides,t),null==e||0===t.length)return e;const r=this._info?.geometryType;if(r){const e=this._poMap;for(const i of t)if(i.valueExpressionInfo){const t=e[i.primitiveName]&&e[i.primitiveName][i.propertyName];t instanceof l&&(i.fn=(e,i,o)=>$(t,e,{$view:o},r,i))}}return(r,o,n)=>{for(const e of t)e.fn&&(e.value=e.fn(r,o,n));const a=i(e),s=e.primitiveName;for(const e of t)if(e.primitiveName===s){const t=ce(e.propertyName);if(null!=e.value){const i=(l=e.value,c=e.propertyName,f=void 0,j.has(c)?(f=l,.05*Math.max(Math.round(f/.05),1)):l);i!==a[t]&&(a[t]=i)}}var l,c,f;return a}}_analyzePrimitiveOverrides(e,t,i,r){let o=!1,n="";"string"==typeof e&&(e=[e]);for(const t of this._primitiveOverrides)e?.includes(t.primitiveName)&&(null!=t.value?n+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`:t.valueExpressionInfo&&(o=!0));return null!=t&&"function"==typeof t&&(o=!0),null!=i&&"function"==typeof i&&(o=!0),null!=r&&"function"==typeof r&&(o=!0),[o,n]}_analyzeMaterialOverrides(e,t){return this._primitiveOverrides.filter((i=>i.primitiveName!==e||!t.includes(i.propertyName)))}_transformSize(e,t){return w(e)||w(t)?(i,r,o)=>(w(e)?e(i,r,o):e)*(w(t)?t(i,r,o):t):e*t}_transformRotation(e,t,i){return w(e)||w(i)?(r,o,n)=>{const a=w(e)?e(r,o,n):e,s=w(i)?i(r,o,n):i;return t?s-a:s+a}:t?i-e:i+e}_transformOffsetX(e,t,i,r,o){if(!(w(e)||w(t)||w(i)||w(r)||w(o))){const n=i*Math.PI/180;if(n){const i=Math.cos(n),a=Math.sin(n);return(i*e-a*t)*r+o}return e*r+o}return(n,a,s)=>{let l=w(i)?i(n,a,s):i;const c=w(r)?r(n,a,s):r,f=w(e)?e(n,a,s):e,m=w(o)?o(n,a,s):o;return l?(l*=Math.PI/180,(Math.cos(l)*f-Math.sin(l)*(w(t)?t(n,a,s):t))*c+m):f*c+m}}_transformOffsetY(e,t,i,r,o){if(!(w(e)||w(t)||w(i)||w(r)||w(o))){const n=i*Math.PI/180;if(n){const i=Math.cos(n);return(Math.sin(n)*e+i*t)*r+o}return t*r+o}return(n,a,s)=>{let l=w(i)?i(n,a,s):i;const c=w(r)?r(n,a,s):r,f=w(t)?t(n,a,s):t,m=w(o)?o(n,a,s):o;if(l){l*=Math.PI/180;const t=Math.cos(l);return(Math.sin(l)*(w(e)?e(n,a,s):e)+t*f)*c+m}return f*c+m}}}function se(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function le(t){if(!t||0===t.length)return null;const i=new e(t).toRgba();return{r:i[0],g:i[1],b:i[2],a:i[3]}}function ce(e){return e?e.charAt(0).toLowerCase()+e.substr(1):e}function fe(e,t){if(!t||0===t.length)return e;const r=i(e);return p.applyOverrides(r,t),r}const me=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&null==e[0].path&&null==e[1].path&&!e[0].effects&&!e[1].effects;function ue(e){const t=e.symbolLayers;if(!t||2!==t.length)return!1;const i=t.find((e=>e.effects?.find((e=>"CIMGeometricEffectDashes"===e.type)))),r=t.find((e=>e.effects?.find((e=>"CIMGeometricEffectAddControlPoints"===e.type))));return!!i&&!!r}export{ae as C,fe as a,B as b,Z as c,Q as d,K as e,D as g};
