/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{g as t}from"./assets.js";import{t as s,c as e}from"./colorUtils2.js";import"./typedArrayUtil.js";import o from"../core/Error.js";import{L as r}from"./Logger.js";import{d as l}from"./screenUtils.js";import{j as i,k as a,l as m,m as p,n}from"./utils8.js";import{d as c}from"../symbols/IconSymbol3DLayer.js";import{d as y}from"../symbols/ObjectSymbol3DLayer.js";import{S as u,a as j,g as h,b,s as f,c as d,d as S,e as g,f as k,h as L,i as v,j as M}from"./previewUtils.js";import{t as x,f as w}from"./renderUtils.js";import{resolveWebStyleSymbol as U}from"./webStyleSymbolUtils.js";import"../config.js";import"../core/lang.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./time.js";import"../Color.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./vec4.js";import"./vec4f64.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./messages.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./Ellipsoid.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./persistableUrlUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./Symbol3DAnchorPosition2D.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./mat4.js";import"./_commonjsHelpers.js";import"../symbols/support/cimSymbolUtils.js";import"./utils9.js";import"./LRUCache.js";import"./MemCache.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./devEnvironmentUtils.js";import"../symbols/support/jsonUtils.js";import"./layerUtils2.js";import"./styleUtils.js";const D=u.size,P=u.maxSize,z=u.maxOutlineSize,O=u.lineWidth,C=u.tallSymbolWidth;function E(t){const s=t.outline,e=null!=t.material?t.material.color:null,o=null!=e?e.toHex():null;if(null==s||"pattern"in s&&null!=s.pattern&&"style"===s.pattern.type&&"none"===s.pattern.style)return"fill"===t.type&&"#ffffff"===o?{color:"#bdc3c7",width:.75}:null;const r=l(s.size)||0;return{color:"rgba("+(null!=s.color?s.color.toRgba():"255,255,255,1")+")",width:Math.min(r,z),style:"pattern"in s&&null!=s.pattern&&"style"===s.pattern.type?p(s.pattern.style):null,join:"butt",cap:"patternCap"in s?s.patternCap:"butt"}}function F(t,o=1){const r=t.a,l=s(t),i=l.h,a=l.s/o,m=100-(100-l.v)/o,{r:p,g:n,b:c}=e({h:i,s:a,v:m});return[p,n,c,r]}function R(t){return"water"===t.type?null==t.color?null:t.color:null==t.material?.color?null:t.material.color}function T(t,s=0){const e=R(t);if(!e){if("fill"===t.type)return null;const e=i.r,o=j(e,s);return[o,o,o,100]}const o=e.toRgba();for(let t=0;t<3;t++)o[t]=j(o[t],s);return o}async function A(s,e){const o=s.style;return"none"===o?null:{type:"pattern",x:0,y:0,src:await a(t(`esri/symbols/patterns/${o}.png`),e.toCss(!0)),width:5,height:5}}function W(t){return t.outline?E(t):{color:"rgba(0, 0, 0, 1)",width:1.5}}function q(t,s){const e=R(t);if(!e)return null;let o="rgba(";return o+=j(e.r,s)+",",o+=j(e.g,s)+",",o+=j(e.b,s)+",",o+e.a+");"}function B(t,s){const e=q(t,s);return e?"pattern"in t&&null!=t.pattern&&"style"===t.pattern.type&&"none"===t.pattern.style?null:{color:e,width:Math.min(t.size?l(t.size):.75,z),style:"pattern"in t&&null!=t.pattern&&"style"===t.pattern.type?p(t.pattern.style):null,cap:"cap"in t?t.cap:null,join:"join"in t?"miter"===t.join?l(2):t.join:null}:{}}function H(t,s,e){const o=null!=e?.75*e:0;return{type:"linear",x1:o?.25*o:0,y1:o?.5*o:0,x2:o||4,y2:o?.5*o:4,colors:[{color:t,offset:0},{color:s,offset:1}]}}function I(t){const s="number"==typeof t?.size?t?.size:null;return s?l(s):null}function Z(s,e){if(0===s.symbolLayers.length)return Promise.reject(new o("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));switch(s.type){case"point-3d":return async function(s,e){const o=I(e),i=e?.maxSize?l(e.maxSize):null,a=e?.disableUpsampling??!1,m=s.symbolLayers,p=[];let u=0,j=0;const h=m.at(-1);let b;h&&"icon"===h.type&&(b=h.size&&l(h.size)),m.forEach((r=>{if("icon"!==r.type&&"object"!==r.type)return;const m="icon"===r.type?r.size&&l(r.size):0,h=o||m?Math.ceil(Math.min(o||m,i||P)):D;if(r?.resource?.href){const e=async function(s,e){if(s.thumbnail?.url)return s.thumbnail.url;if("icon"===e.type){const t=e?.resource?.href;if(t)return n(e)}const o=t("esri/images/Legend/legend3dsymboldefault.png");if(s.styleOrigin&&(s.styleOrigin.styleName||s.styleOrigin.styleUrl)){const t=await U(s.styleOrigin,{portal:s.styleOrigin.portal},"webRef").catch((()=>null));if(t&&"thumbnail"in t&&t.thumbnail?.url)return t.thumbnail.url}return o}(s,r).then((t=>{const s=r?.material?.color,e=function(t){return"icon"===t.type?"multiply":"tint"}(r);return x(t,h,s,e,a)})).then((t=>{const s=t.width,e=t.height;return u=Math.max(u,s),j=Math.max(j,e),[{shape:{type:"image",x:0,y:0,width:s,height:e,src:t.url},fill:null,stroke:null}]}));p.push(e)}else{let t=h;"icon"===r.type&&b&&o&&(t=h*(m/b));const s="tall"===e?.symbolConfig||e?.symbolConfig?.isTall||"object"===r.type&&function(t){const s=t.depth,e=t.height,o=t.width;return 0!==o&&0!==s&&0!==e&&o===s&&null!=o&&null!=e&&o<e}(r);u=Math.max(u,s?C:t),j=Math.max(j,t),p.push(Promise.resolve(function(t,s,e){const o=[];if(!t)return o;switch(t.type){case"icon":{const e=0,r=0,l=s,i=s;switch(t.resource&&t.resource.primitive||c){case"circle":o.push({shape:{type:"circle",cx:0,cy:0,r:.5*s},fill:T(t,0),stroke:E(t)});break;case"square":o.push({shape:{type:"path",path:[{command:"M",values:[e,i]},{command:"L",values:[e,r]},{command:"L",values:[l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:T(t,0),stroke:E(t)});break;case"triangle":o.push({shape:{type:"path",path:[{command:"M",values:[e,i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:T(t,0),stroke:E(t)});break;case"cross":o.push({shape:{type:"path",path:[{command:"M",values:[.5*l,r]},{command:"L",values:[.5*l,i]},{command:"M",values:[e,.5*i]},{command:"L",values:[l,.5*i]}]},stroke:W(t)});break;case"x":o.push({shape:{type:"path",path:[{command:"M",values:[e,r]},{command:"L",values:[l,i]},{command:"M",values:[l,r]},{command:"L",values:[e,i]}]},stroke:W(t)});break;case"kite":o.push({shape:{type:"path",path:[{command:"M",values:[e,.5*i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,.5*i]},{command:"L",values:[.5*l,i]},{command:"Z",values:[]}]},fill:T(t,0),stroke:E(t)})}break}case"object":switch(t.resource&&t.resource.primitive||y){case"cone":{const r=H(T(t,0),T(t,-.6),e?C:s),l=v(s,e);o.push({shape:l[0],fill:r},{shape:l[1],fill:r});break}case"inverted-cone":{const e=T(t,0),r=H(e,T(t,-.6),s),l=L(s);o.push({shape:l[0],fill:r},{shape:l[1],fill:e});break}case"cube":{const r=k(s,e);o.push({shape:r[0],fill:T(t,0)},{shape:r[1],fill:T(t,-.3)},{shape:r[2],fill:T(t,-.5)});break}case"cylinder":{const r=H(T(t,0),T(t,-.6),e?C:s),l=g(s,e);o.push({shape:l[0],fill:r},{shape:l[1],fill:r},{shape:l[2],fill:T(t,0)});break}case"diamond":{const e=S(s);o.push({shape:e[0],fill:T(t,-.3)},{shape:e[1],fill:T(t,0)},{shape:e[2],fill:T(t,-.3)},{shape:e[3],fill:T(t,-.7)});break}case"sphere":{const e=H(T(t,0),T(t,-.6));e.x1=0,e.y1=0,e.x2=.25*s,e.y2=.25*s,o.push({shape:{type:"circle",cx:0,cy:0,r:.5*s},fill:e});break}case"tetrahedron":{const e=d(s);o.push({shape:e[0],fill:T(t,-.3)},{shape:e[1],fill:T(t,0)},{shape:e[2],fill:T(t,-.6)});break}}}return o}(r,t,s)))}}));const f=await Promise.allSettled(p),M=[];return f.forEach((t=>{"fulfilled"===t.status?M.push(t.value):t.reason&&r.getLogger("esri.symbols.support.previewSymbol3D").warn("error while building swatchInfo!",t.reason)})),w(M,[u,j],{node:e?.node,scale:!1,opacity:e?.opacity,ariaLabel:e?.ariaLabel})}(s,e);case"line-3d":return function(t,s){const e=t.symbolLayers,o=[],r=m(t),i=I(s),a=(s?.maxSize?l(s.maxSize):null)||z;let p,n=0,c=0;return e.forEach(((t,s)=>{if(!t)return;if("line"!==t.type&&"path"!==t.type)return;const e=[];switch(t.type){case"line":{const o=B(t,0);if(null==o)break;const r=o?.width||0;0===s&&(p=r);const l=Math.min(i||r,a),m=0===s?l:i?l*(r/p):l,y=m>O/2?2*m:O;c=Math.max(c,m),n=Math.max(n,y),o.width=m,e.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[n,.5*c]}]},stroke:o});break}case"path":{const s=Math.min(i||D,a),o=T(t,0),r=T(t,-.2),l=q(t,-.4),m=l?{color:l,width:1}:{};if("quad"===t.profile){const s=t.width,l=t.height,i=h(s&&l?s/l:1,0===l,0===s),a={...m,join:"bevel"};e.push({shape:i[0],fill:r,stroke:a},{shape:i[1],fill:r,stroke:a},{shape:i[2],fill:o,stroke:a})}else e.push({shape:f.pathSymbol3DLayer[0],fill:r,stroke:m},{shape:f.pathSymbol3DLayer[1],fill:o,stroke:m});c=Math.max(c,s),n=c}}o.push(e)})),Promise.resolve(w(o,[n,c],{node:s?.node,scale:r,opacity:s?.opacity,ariaLabel:s?.ariaLabel}))}(s,e);case"polygon-3d":case"mesh-3d":return async function(t,s){const e="mesh-3d"===t.type,o=t.symbolLayers,r=I(s),i=s?.maxSize?l(s.maxSize):null,a=r||D,m=[];let p=0,n=0,c=!1;for(let t=0;t<o.length;t++){const s=o.at(t),r=[];if(!e||"fill"===s.type){switch(s.type){case"fill":{const t=Math.min(a,i||P);if(p=Math.max(p,t),n=Math.max(n,t),c=!0,e){const t=f.meshSymbol3DFill,e=q(s,-.4),o=e?{color:e,width:1,join:"round"}:{};r.push({shape:t[0],fill:T(s,0),stroke:o},{shape:t[1],fill:T(s,-.2),stroke:o},{shape:t[2],fill:T(s,-.6),stroke:o})}else{let t=T(s,0);const e="pattern"in s?s.pattern:null,o=E(s),l=R(s);null!=e&&"style"===e.type&&"solid"!==e.style&&l&&(t=await A(e,l)),r.push({shape:f.fill[0],fill:t,stroke:o})}break}case"line":{const t=B(s,0);if(null==t)break;const e={stroke:t,shape:f.fill[0]};p=Math.max(p,D),n=Math.max(n,D),r.push(e);break}case"extrude":{const t={join:"round",width:1,...B(s,-.4)},e=T(s,0),o=T(s,-.2),l=Math.min(a,i||P),m=b(l);t.width=1,r.push({shape:m[0],fill:o,stroke:t},{shape:m[1],fill:o,stroke:t},{shape:m[2],fill:e,stroke:t});const c=D,y=.7*D+.5*l;p=Math.max(p,c),n=Math.max(n,y);break}case"water":{const t=R(s),e=F(t),o=F(t,2),l=F(t,3),m=M();c=!0,r.push({shape:m[0],fill:e},{shape:m[1],fill:o},{shape:m[2],fill:l});const y=Math.min(a,i||P);p=Math.max(p,y),n=Math.max(n,y);break}}m.push(r)}}return w(m,[p,n],{node:s?.node,scale:c,opacity:s?.opacity,ariaLabel:s?.ariaLabel})}(s,e)}return Promise.reject(new o("symbolPreview: swatchInfo3D","symbol not supported."))}export{A as getPatternDescriptor,I as getSizeFromOptions,T as getSymbolLayerFill,Z as previewSymbol3D};
