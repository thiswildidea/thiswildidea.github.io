/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import t from"../Color.js";import{l as o}from"./colorUtils2.js";import s from"../core/Error.js";import{l as e}from"./fontUtils.js";import{d as r,p as i}from"./screenUtils.js";import{f as l,e as m,k as a}from"./utils8.js";import{S as p,s as n,k as c}from"./previewUtils.js";import{f as j}from"./renderUtils.js";import{b as y}from"../symbols/Font.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ensureType.js";import"./typedArrayUtil.js";import"./Logger.js";import"../config.js";import"../core/lang.js";import"./vec4.js";import"./vec4f64.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./time.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./messages.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./assets.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./Ellipsoid.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"./Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./mat4.js";import"./_commonjsHelpers.js";import"../symbols/support/cimSymbolUtils.js";import"./utils9.js";import"./LRUCache.js";import"./MemCache.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";const u="picture-fill",h="picture-marker",b="simple-fill",d="simple-line",f="simple-marker",g="text",S="Aa",w=p.size,L=p.maxSize,v=p.maxOutlineSize,k=p.lineWidth,x=225,M=document.createElement("canvas");function U(t,o){const s=M.getContext("2d"),e=[];return o&&(o.weight&&e.push(o.weight),o.size&&e.push(o.size+"px"),o.family&&e.push(o.family)),s.font=e.join(" "),s.measureText(t).width}const D=7.2/2.54,z=72/2.54;function P(t){const o=t?.size;return{width:null!=o&&"object"==typeof o&&"width"in o?r(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?r(o.height):null}}function C(t,o){return t>o?"dark":"light"}function F(t,o){const s="number"==typeof o?.size?o?.size:null,e=null!=s?r(s):null,a=null!=o?.maxSize?r(o.maxSize):null,p=null!=o?.rotation?o.rotation:"angle"in t?t.angle:null,c=l(t);let j=m(t);"dark"!==O(t,245)||o?.ignoreWhiteSymbols||(j={width:.75,...j,color:"#bdc3c7"});const y={shape:null,fill:c,stroke:j,offset:[0,0]};j?.width&&(j.width=Math.min(j.width,v));const x=j?.width||0;let M=null!=o?.size&&(null==o?.scale||o?.scale),C=0,F=0,E=!1;switch(t.type){case f:{const s=t.style,{width:i,height:l}=P(o),m=i===l&&null!=i?i:null!=e?e:Math.min(r(t.size),a||L);switch(C=m,F=m,s){case"circle":y.shape={type:"circle",cx:0,cy:0,r:.5*m},M||(C+=x,F+=x);break;case"cross":y.shape={type:"path",path:[{command:"M",values:[0,.5*F]},{command:"L",values:[C,.5*F]},{command:"M",values:[.5*C,0]},{command:"L",values:[.5*C,F]}]};break;case"diamond":y.shape={type:"path",path:[{command:"M",values:[0,.5*F]},{command:"L",values:[.5*C,0]},{command:"L",values:[C,.5*F]},{command:"L",values:[.5*C,F]},{command:"Z",values:[]}]},M||(C+=x,F+=x);break;case"square":y.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"Z",values:[]}]},M||(C+=x,F+=x),p&&(E=!0);break;case"triangle":y.shape={type:"path",path:[{command:"M",values:[.5*C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"Z",values:[]}]},M||(C+=x,F+=x),p&&(E=!0);break;case"x":y.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,F]},{command:"M",values:[C,0]},{command:"L",values:[0,F]}]},p&&(E=!0);break;case"path":y.shape={type:"path",path:t.path||""},M||(C+=x,F+=x),p&&(E=!0),M=!0}break}case d:{const{width:t,height:s}=P(o),r=null!=s?s:null!=e?e:x,i=null!=t?t:k;j&&(j.width=r),C=i,F=r;const l=y?.stroke?.cap||"butt",m="round"===l;M=!0,y.stroke&&(y.stroke.cap="butt"===l?"square":l),y.shape={type:"path",path:[{command:"M",values:[m?r/2:0,F/2]},{command:"L",values:[m?C-r/2:C,F/2]}]};break}case u:case b:{const t="object"==typeof o?.symbolConfig&&!!o?.symbolConfig?.isSquareFill,{width:s,height:r}=P(o);C=!t&&s!==r||null==s?null!=e?e:w:s,F=!t&&s!==r||null==r?C:r,M||(C+=x,F+=x),M=!0,y.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:n.fill[0];break}case h:{const s=Math.min(r(t.width),a||L),i=Math.min(r(t.height),a||L),{width:l,height:m}=P(o),n=l===m&&null!=l?l:null!=e?e:Math.max(s,i),c=s/i;C=c<=1?Math.ceil(n*c):n,F=c<=1?n:Math.ceil(n/c),y.shape={type:"image",x:-Math.round(C/2),y:-Math.round(F/2),width:C,height:F,src:t.url||""},p&&(E=!0);break}case g:{const s=t,l=o?.overrideText||s.text||S,m=s.font,{width:p,height:n}=P(o),c=null!=n?n:null!=e?e:Math.min(r(m.size),a||L),j=U(l,{weight:m.weight,size:c,family:m.family}),u=/[\uE600-\uE6FF]/.test(l);C=p??(u?c:j),F=c;let h=.25*function(t){if(0===t.length)return 0;if(t.length>2){const o=i(1),s=parseFloat(t);switch(t.slice(-2)){case"px":return s;case"pt":return s*o;case"in":return 72*s*o;case"pc":return 12*s*o;case"mm":return s*D*o;case"cm":return s*z*o}}return parseFloat(t)}((m?c:0).toString());u&&(h+=5),y.shape={type:"text",text:l,x:s.xoffset||0,y:s.yoffset||h,align:"middle",alignBaseline:s.verticalAlignment,decoration:m&&m.decoration,rotated:s.rotated,kerning:s.kerning},y.font=m&&{size:c,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:y,size:[C,F],renderOptions:{node:o?.node,scale:M,opacity:o?.opacity,rotation:p,useRotationSize:E,effectView:o?.effectView,ariaLabel:o?.ariaLabel}}}async function E(t,o){const{shapeDescriptor:i,size:l,renderOptions:m}=F(t,o);if(!i.shape)throw new s("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,o){const s=o.fill,e=t.color;if("pattern"===s?.type&&e&&t.type!==u){const t=await a(s.src,e.toCss(!0));s.src=t,o.fill=s}}(t,i),await async function(t,o,s,r){if(!("font"in t)||!t.font||"text"!==o.shape.type)return;try{await e(t.font)}catch{}const{width:i}=P(r),l=/[\uE600-\uE6FF]/.test(o.shape.text);null!=i||l||(s[0]=U(o.shape.text,{weight:o.font?.weight,size:o.font?.size,family:o.font?.family}))}(t,i,l,o);const p=[[i]];if("object"==typeof o?.symbolConfig&&o?.symbolConfig?.applyColorModulation){const t=.6*l[0];p.unshift([{...i,offset:[-t,0],fill:c(i.fill,-.3)}]),p.push([{...i,offset:[t,0],fill:c(i.fill,.3)}]),l[0]+=2*t,m.scale=!1}return"text"===t.type&&function(t,o,s,e,i){if(null!=t.haloColor&&null!=t.haloSize){i.masking??=s.map((()=>[]));const l=r(t.haloSize);e[0]+=l,e[1]+=l,s.unshift([{...o,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),i.masking.unshift([{shape:{type:"rect",x:0,y:0,width:e[0]+2*y,height:e[1]+2*y},fill:[255,255,255],stroke:null},{...o,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(e[0]+=2*y,e[1]+=2*y,s.unshift([{shape:{type:"rect",x:0,y:0,width:e[0],height:e[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:r(t.borderLineSize)}}]),i.masking?.unshift([]))}(t,i,p,l,m),j(p,l,m)}function O(s,e=x){const r=l(s),i=m(s),a=!r||"type"in r?null:new t(r),p=i?.color?new t(i?.color):null,n=a?C(o(a),e):null,c=p?C(o(p),e):null;return c?n?n===c?n:e>=x?"light":"dark":c:n}export{O as getContrastingBackgroundTheme,F as getRenderSymbolParameters,E as previewSymbol2D};
