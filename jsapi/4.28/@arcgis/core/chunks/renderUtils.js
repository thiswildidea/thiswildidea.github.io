/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{id as t}from"../kernel.js";import e from"../request.js";import{t as i,c as n}from"./colorUtils2.js";import r from"../core/Error.js";import{h as o}from"./typedArrayUtil.js";import{c as a}from"./projector.js";import s from"../Color.js";import{b as l}from"./maybe.js";import{c as h}from"./mat2df32.js";import{m as c,t as f,i as d,s as u,r as y}from"./mat2d.js";import"./widgetUtils.js";import{t as g}from"./jsxFactory.js";import{d as p}from"./utils8.js";const m="http://www.w3.org/2000/svg";let x=0,w=0;const k=o("android"),b=o("chrome")||k&&k>=4?"auto":"optimizeLegibility",j={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7,z:0},v=/([A-DF-Za-df-z])|([-+]?\d*[.]?\d+(?:[eE][-+]?\d+)?)/g;let M={},A={};const $={solid:"none",shortdash:[4,1],shortdot:[1,1],shortdashdot:[4,1,1,1],shortdashdotdot:[4,1,1,1,1,1],dot:[1,3],dash:[4,3],longdash:[8,3],dashdot:[4,3,1,3],longdashdot:[8,3,1,3],longdashdotdot:[8,3,1,3,1,3]},S=Math.PI;let I=1;function N(t,e){const i=t*(S/180);return Math.abs(e*Math.sin(i))+Math.abs(e*Math.cos(i))}function G(t){return t.map((t=>`${t.command} ${t.values.join(" ")}`)).join(" ").trim()}function U(t,e,i,n){if(t){if("circle"===t.type)return g("circle",{cx:t.cx,cy:t.cy,fill:e,"fill-rule":"evenodd",r:t.r,stroke:i.color,"stroke-dasharray":i.dashArray,"stroke-dashoffset":i.dashOffset,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-miterlimit":"4","stroke-width":i.width});if("ellipse"===t.type)return g("ellipse",{cx:t.cx,cy:t.cy,fill:e,"fill-rule":"evenodd",rx:t.rx,ry:t.ry,stroke:i.color,"stroke-dasharray":i.dashArray,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-miterlimit":"4","stroke-width":i.width});if("rect"===t.type)return g("rect",{fill:e,"fill-rule":"evenodd",height:t.height,stroke:i.color,"stroke-dasharray":i.dashArray,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-miterlimit":"4","stroke-width":i.width,width:t.width,x:t.x,y:t.y});if("image"===t.type)return g("image",{height:t.height,href:t.src,preserveAspectRatio:"none",width:t.width,x:t.x,y:t.y});if("path"===t.type){const n="string"!=typeof t.path?G(t.path):t.path;return g("path",{d:n,fill:e,"fill-rule":"evenodd",stroke:i.color,"stroke-dasharray":i.dashArray,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-miterlimit":"4","stroke-width":i.width})}if("text"===t.type)return l(n),g("text",{"dominant-baseline":n.dominantBaseline,fill:e,"fill-rule":"evenodd","font-family":n.font.family,"font-size":n.font.size,"font-style":n.font.style,"font-variant":n.font.variant,"font-weight":n.font.weight,kerning:n.kerning,rotate:n.rotate,stroke:i.color,"stroke-dasharray":i.dashArray,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-miterlimit":"4","stroke-width":i.width,"text-anchor":n.align,"text-decoration":n.decoration,"text-rendering":b,x:t.x,y:t.y},t.text)}return null}function z(t){const e={fill:"none",pattern:null,linearGradient:null};if(t)if("type"in t&&"pattern"===t.type){const i="patternId-"+ ++x;e.fill=`url(#${i})`,e.pattern={id:i,x:t.x,y:t.y,width:t.width,height:t.height,image:{x:0,y:0,width:t.width,height:t.height,href:t.src}}}else if("type"in t&&"linear"===t.type){const i="linearGradientId-"+ ++w;e.fill=`url(#${i})`,e.linearGradient={id:i,x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2,stops:t.colors.map((t=>({offset:t.offset,color:t.color&&new s(t.color).toString()})))}}else if(t){const i=new s(t);e.fill=i.toString()}return e}function B(t){const e={color:"none",width:1,cap:"butt",join:"4",dashArray:"none",dashOffset:"0"};if(t&&(null!=t.width&&(e.width=t.width),t.cap&&(e.cap=t.cap),t.join&&(e.join=t.join.toString()),t.color&&(e.color=new s(t.color).toString()),t.dashArray&&(e.dashArray=t.dashArray),t.dashArray&&(e.dashOffset=t.dashoffset),t.style)){let i=null;if(t.style in $&&(i=$[t.style]),Array.isArray(i)){i=i.slice(0);const e=t.width??0;for(let t=0;t<i.length;++t)i[t]*=e;if("butt"!==t.cap){for(let t=0;t<i.length;t+=2)i[t]-=e,i[t]<1&&(i[t]=1);for(let t=1;t<i.length;t+=2)i[t]+=e}i=i.join(",")}e.dashArray=i}return e}function D(t,e){const i={align:null,decoration:null,kerning:null,rotate:null,font:{style:null,variant:null,weight:null,size:null,family:null}};if(t){const n=t.alignBaseline,r="baseline"===n?"auto":"top"===n?"text-top":"bottom"===n?"hanging":n;i.align=t.align,i.dominantBaseline=r,i.decoration=t.decoration,i.kerning=t.kerning?"auto":"0",i.rotate=t.rotated?"90":"0",l(e),i.font.style=e.style||"normal",i.font.variant=e.variant||"normal",i.font.weight=e.weight||"normal",i.font.size=e.size&&e.size.toString()||"10pt",i.font.family=e.family||"serif"}return i}function E(t){const{pattern:e,linearGradient:i}=t;if(e)return g("pattern",{height:e.height,id:e.id,patternUnits:"userSpaceOnUse",width:e.width,x:e.x,y:e.y},g("image",{height:e.image.height,href:e.image.href,width:e.image.width,x:e.image.x,y:e.image.y}));if(i){const t=i.stops.map(((t,e)=>g("stop",{key:`${e}-stop`,offset:t.offset,"stop-color":t.color})));return g("linearGradient",{gradientUnits:"userSpaceOnUse",id:i.id,x1:i.x1,x2:i.x2,y1:i.y1,y2:i.y2},t)}return null}function F(t,e){if(!t||0===t.length)return null;const i=[];for(const e of t){const{shape:t,fill:n,stroke:r,font:o}=e,a=z(n),s=B(r),l="text"===t.type?D(t,o):null,h=U(t,a.fill,s,l);h&&i.push(h)}return g("mask",{id:e,maskUnits:"userSpaceOnUse"},g("g",null,i))}function O(t,e,i){return f(t,d(t),[e,i])}function T(t,e,i,n,r){return u(t,d(t),[e,i]),t[4]=t[4]*e-n*e+n,t[5]=t[5]*i-r*i+r,t}function V(t,e){M&&"left"in M?(null!=M.left&&M.left>t&&(M.left=t),(null==M.right||M.right<t)&&(M.right=t),(null==M.top||M.top>e)&&(M.top=e),(null==M.bottom||M.bottom<e)&&(M.bottom=e)):M={left:t,bottom:e,right:t,top:e}}function C(t){const e=t.args,i=e.length;let n;switch(t.action){case"M":case"L":case"C":case"S":case"Q":case"T":for(n=0;n<i;n+=2)V(e[n],e[n+1]);A.x=e[i-2],A.y=e[i-1];break;case"H":for(n=0;n<i;++n)V(e[n],A.y);A.x=e[i-1];break;case"V":for(n=0;n<i;++n)V(A.x,e[n]);A.y=e[i-1];break;case"m":{let t=0;"x"in A||(V(A.x=e[0],A.y=e[1]),t=2);for(n=t;n<i;n+=2)V(A.x+=e[n],A.y+=e[n+1]);break}case"l":case"t":for(n=0;n<i;n+=2)V(A.x+=e[n],A.y+=e[n+1]);break;case"h":for(n=0;n<i;++n)V(A.x+=e[n],A.y);break;case"v":for(n=0;n<i;++n)V(A.x,A.y+=e[n]);break;case"c":for(n=0;n<i;n+=6)V(A.x+e[n],A.y+e[n+1]),V(A.x+e[n+2],A.y+e[n+3]),V(A.x+=e[n+4],A.y+=e[n+5]);break;case"s":case"q":for(n=0;n<i;n+=4)V(A.x+e[n],A.y+e[n+1]),V(A.x+=e[n+2],A.y+=e[n+3]);break;case"A":for(n=0;n<i;n+=7)V(e[n+5],e[n+6]);A.x=e[i-2],A.y=e[i-1];break;case"a":for(n=0;n<i;n+=7)V(A.x+=e[n+5],A.y+=e[n+6])}}function R(t,e,i){const n=j[t.toLowerCase()];let r;"number"==typeof n&&(n?e.length>=n&&(r={action:t,args:e.slice(0,e.length-e.length%n)},i.push(r),C(r)):(r={action:t,args:[]},i.push(r),C(r)))}function L(t){const e={x:0,y:0,width:0,height:0};if("circle"===t.type)e.x=t.cx-t.r,e.y=t.cy-t.r,e.width=2*t.r,e.height=2*t.r;else if("ellipse"===t.type)e.x=t.cx-t.rx,e.y=t.cy-t.ry,e.width=2*t.rx,e.height=2*t.ry;else if("image"===t.type||"rect"===t.type)e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height;else if("path"===t.type){const i=function(t){const e=("string"!=typeof t.path?G(t.path):t.path).match(v),i=[];if(M={},A={},!e)return null;let n="",r=[];const o=e.length;for(let t=0;t<o;++t){const o=e[t],a=parseFloat(o);isNaN(a)?(n&&R(n,r,i),r=[],n=o):r.push(a)}R(n,r,i);const a={x:0,y:0,width:0,height:0};return M&&"left"in M&&(a.x=M.left,a.y=M.top,a.width=M.right-M.left,a.height=M.bottom-M.top),a}(t);e.x=i.x,e.y=i.y,e.width=i.width,e.height=i.height}return e}function q(t){const e={x:0,y:0,width:0,height:0};let i=null,n=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(const o of t)i?(i.x=Math.min(i.x,o.x),i.y=Math.min(i.y,o.y),n=Math.max(n,o.x+o.width),r=Math.max(r,o.y+o.height)):(i=e,i.x=o.x,i.y=o.y,n=o.x+o.width,r=o.y+o.height);return i&&(i.width=n-i.x,i.height=r-i.y),i}function P(t,e,i,n,r,o,a,s,l){let f=(a&&o?N(o,e):e)/2,u=(a&&o?N(o,i):i)/2;if(l){const t=l[0],e=l[1];f=(a&&o?N(o,t):t)/2,u=(a&&o?N(o,e):e)/2}const g=t.width+n,p=t.height+n,m=h(),x=h();let w=!1;if(r&&0!==g&&0!==p){const t=e!==i?e/i:g/p,n=e>i?e:i;let r=1,o=1;isNaN(n)||(t>1?(r=n/g,o=n/t/p):(o=n/p,r=n*t/g)),c(x,x,T(m,r,o,f,u)),w=!0}const k=t.x+(g-n)/2,b=t.y+(p-n)/2;if(c(x,x,O(m,f-k,u-b)),!w&&(g>e||p>i)){const t=g/e>p/i,n=(t?e:i)/(t?g:p);c(x,x,T(m,n,n,k,b))}return o&&c(x,x,function(t,e,i,n){const r=e%360*Math.PI/180;y(t,d(t),r);const o=Math.cos(r),a=Math.sin(r),s=t[4],l=t[5];return t[4]=s*o-l*a+n*a-i*o+i,t[5]=l*o+s*a-i*a-n*o+n,t}(m,o,k,b)),s&&c(x,x,O(m,s[0],s[1])),`matrix(${x[0]},${x[1]},${x[2]},${x[3]},${x[4]},${x[5]})`}function Y(t,e,i,n={}){const r=[],o=[],a=++I,s=function(t,e,i){const n=t?.effects.find((t=>"bloom"===t.type));if(!n)return null;const{strength:r,radius:o}=n,a=r>0?o:0,s=(r+a)*e,l=4*r+1;return g("filter",{filterUnits:"userSpaceOnUse",height:"300%",id:`bloom${i}`,width:"300%",x:"-100%",y:"-100%"},g("feMorphology",{in:"SourceGraphic",operator:"dilate",radius:(r+.5*a)*(5**(e/100)*(.4+e/100)),result:"dilate"}),g("feGaussianBlur",{in:"dilate",result:"blur",stdDeviation:s/25}),g("feGaussianBlur",{in:"blur",result:"intensityBlur",stdDeviation:s/50}),g("feComponentTransfer",{in:"SourceGraphic",result:"intensityBrightness"},g("feFuncR",{slope:l,type:"linear"}),g("feFuncG",{slope:l,type:"linear"}),g("feFuncB",{slope:l,type:"linear"})),g("feMerge",null,g("feMergeNode",{in:"intensityBlur"}),g("feMergeNode",{in:"intensityBrightness"}),g("feGaussianBlur",{stdDeviation:r/10})))}(n.effectView,e,a);let h=null;if(s){const t=n.effectView?.effects.find((t=>"bloom"===t.type)),r=(t.strength?t.strength+t.radius/2:0)/3,o=e+e*r,a=i+i*r;h=[Math.max(o,10),Math.max(a,10)]}for(let a=0;a<t.length;a++){const s=t[a],l=[],c=[];let f=0,d=0,u=0;for(const t of s){const{shape:e,fill:i,stroke:o,font:a,offset:s}=t;n.ignoreStrokeWidth||"text"===e.type||(f+=o?.width||0);const h=z(i),y=B(o),g="text"===e.type?D(e,a):null;r.push(E(h)),l.push(U(e,h.fill,y,g)),c.push(L(e)),s&&(d+=s[0],u+=s[1])}const y=P(q(c),e,i,f,n.scale??!1,n.rotation,n.useRotationSize??!1,[d,u],h);let p=null;if(n.masking){const t=`mask-${a}`,e=n.masking[a];r.push(F(e,t)),p=`url(#${t})`}o.push(p?g("g",{mask:p},g("g",{transform:y},l)):g("g",{transform:y},l))}return n.useRotationSize&&n.rotation&&(e=N(n.rotation,e),i=N(n.rotation,i)),s&&(l(h),e=h[0],i=h[1]),g("svg",{"aria-labelledby":n.ariaLabel,focusable:!1,height:i,role:"img",style:"display: block;",width:e,xmlns:m},s,g("defs",null,r),s?g("g",{filter:`url(#bloom${a})`},o):o)}const _=a();function H(t,e){_.append(t,e),_.detach(e)}function Q(t,e,i){const n=Math.ceil(e[0]),r=Math.ceil(e[1]);if(!t.some((t=>!!t.length)))return null;const o=i?.node||document.createElement("div");return null!=i.opacity&&(o.style.opacity=i.opacity.toString()),null!=i.effectView&&(o.style.filter=p(i.effectView)),H(o,(()=>Y(t,n,r,i))),o}function W(t,e,r,o,a){switch(a){case"multiply":t[e]*=r[0],t[e+1]*=r[1],t[e+2]*=r[2],t[e+3]*=r[3];break;default:{const a=i({r:t[e],g:t[e+1],b:t[e+2]});a.h=o.h,a.s=o.s,a.v=a.v/100*o.v;const s=n(a);t[e]=s.r,t[e+1]=s.g,t[e+2]=s.b,t[e+3]*=r[3];break}}}function Z(n,a,s,l,h){return function(t,i,n){return t?e(t,{responseType:"image"}).then((t=>{const e=t.data,r=e.width,o=e.height,a=r/o;let s=i;if(n){const t=Math.max(r,o);s=Math.min(s,t)}return{image:e,width:a<=1?Math.ceil(s*a):s,height:a<=1?s:Math.ceil(s/a)}})):Promise.reject(new r("renderUtils: imageDataSize","href not provided."))}(n,a,h).then((e=>{const r=e.width??a,h=e.height??a;if(e.image&&function(t,e){return!(!t||"ignore"===e||"multiply"===e&&255===t.r&&255===t.g&&255===t.b&&1===t.a)}(s,l)){let t=e.image.width,a=e.image.height;o("edge")&&/\.svg$/i.test(n)&&(t-=1,a-=1);const c=function(t,e){t=Math.ceil(t),e=Math.ceil(e);const i=document.createElement("canvas");i.width=t,i.height=e,i.style.width=t+"px",i.style.height=e+"px";const n=i.getContext("2d");return n.clearRect(0,0,t,e),n}(r,h);c.drawImage(e.image,0,0,t,a,0,0,r,h);const f=c.getImageData(0,0,r,h),d=[s.r/255,s.g/255,s.b/255,s.a],u=i(s);for(let t=0;t<f.data.length;t+=4)W(f.data,t,d,u,l);c.putImageData(f,0,0),n=c.canvas.toDataURL("image/png")}else{const e=t?.findCredential(n);if(e?.token){const t=n.includes("?")?"&":"?";n=`${n}${t}token=${e.token}`}}return{url:n,width:r,height:h}})).catch((()=>({url:n,width:a,height:a})))}export{B as a,U as b,L as c,q as d,P as e,Q as f,z as g,H as h,Y as i,E as r,Z as t};
