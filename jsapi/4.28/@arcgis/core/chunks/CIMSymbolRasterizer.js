/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{throwIfAborted as r}from"../core/promiseUtils.js";import{d as i}from"./screenUtils.js";import{C as o,a}from"./cimAnalyzer.js";import{C as s}from"./CIMResourceManager.js";import{T as n,O as l,C as m,a as c,b as h}from"./CIMSymbolHelper.js";import{R as p}from"./Rasterizer.js";import{m as g,x as u,y as d,z as f}from"./utils9.js";import{scaleCIMMarker as y}from"../symbols/support/cimSymbolUtils.js";import{S as j}from"./Symbol3DAnchorPosition2D.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ensureType.js";import"./typedArrayUtil.js";import"./Logger.js";import"../config.js";import"../core/lang.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../core/accessorSupport/decorators/property.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./time.js";import"./fontUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./Ellipsoid.js";import"./assets.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./enums.js";import"./floatRGBA.js";import"./definitions.js";import"./labelPoint.js";import"./OptimizedGeometry.js";import"./callExpressionWithFeature.js";import"./quantizationUtils.js";import"./imageUtils.js";import"./shapingUtils.js";import"./BidiEngine.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./vec2f32.js";import"./alignmentUtils.js";import"./number.js";import"./Rect.js";import"../symbols/Font.js";import"./GeometryUtils.js";import"./rasterizingUtils.js";const w=t=>t?.scaleFactor?t.scaleFactor:1;class C{constructor(t,e){this._spatialReference=t,this._avoidSDF=e,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new n,this._cimResourceManager=new s,this._rasterizer=new p(this._cimResourceManager)}get _imageDataCanvas(){return this._lazyImageDataCanvas??=document.createElement("canvas"),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,e,r,i,o,a,s,n,p){if(!t)return null;const{data:u}=t;if(!u||"CIMSymbolReference"!==u.type||!u.symbol)return null;const{symbol:d}=u;a||(a=g(d));const f=await l.resolveSymbolOverrides(u,e,this._spatialReference,o,a,s,n),y=this._imageDataCanvas,j=this._cimResourceManager,w=[];m.fetchResources(f,j,w),m.fetchFonts(f,j,w),w.length>0&&await Promise.all(w);const{width:C,height:b}=r,z=function(t,e,r,i){const o=-e/2+1,a=e/2-1,s=r/2-1,n=-r/2+1;switch(t){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[o,0],[0,0],[a,0]]]};default:return"legend"===i?{rings:[[[o,s],[a,0],[a,n],[o,n],[o,s]]]}:{rings:[[[o,s],[a,s],[a,n],[o,n],[o,s]]]}}}(a,C,b,i),M=m.getEnvelope(f,z,j);if(!M)return null;const _=1.3333333333333333*(window.devicePixelRatio||1);let x=1,R=0,I=0;switch(d.type){case"CIMPointSymbol":case"CIMTextSymbol":{let t=1;M.width>C&&(t=C/M.width);let e=1;M.height>b&&(e=b/M.height),"preview"===i&&(M.width<C&&(t=C/M.width),M.height<b&&(e=b/M.height)),x=Math.min(t,e),R=M.x+M.width/2,I=M.y+M.height/2}break;case"CIMLineSymbol":{(p||M.height>b)&&(x=b/M.height),I=M.y+M.height/2;const t=M.x*x+C/2,e=(M.x+M.width)*x+C/2,{paths:r}=z;r[0][0][0]-=t/x,r[0][2][0]-=(e-C)/x}break;case"CIMPolygonSymbol":{R=M.x+M.width/2,I=M.y+M.height/2;const t=M.x*x+C/2,e=(M.x+M.width)*x+C/2,r=M.y*x+b/2,i=(M.y+M.height)*x+b/2,{rings:o}=z;t<0&&(o[0][0][0]-=t,o[0][3][0]-=t,o[0][4][0]-=t),r<0&&(o[0][0][1]+=r,o[0][1][1]+=r,o[0][4][1]+=r),e>C&&(o[0][1][0]-=e-C,o[0][2][0]-=e-C),i>b&&(o[0][2][1]+=i-b,o[0][3][1]+=i-b)}}y.width=C*_,y.height=b*_,y.width+=2,y.height+=2;const v=this._imageDataContext,P=h.createIdentity();return P.translate(-R,-I),P.scale(x*_,-x*_),P.translate(C*_/2+1,b*_/2+1),v.clearRect(0,0,y.width,y.height),new c(v,j,P,!0).drawSymbol(f,z),v.getImageData(0,0,y.width,y.height)}async analyzeCIMSymbol3D(t,e,i,a,s){const n=[],l=e?{geometryType:a,spatialReference:this._spatialReference,fields:e}:null,c=[];m.fetchFonts(t.data.symbol,this._cimResourceManager,c),await Promise.all(c);const h=new o(this._cimResourceManager,l);let p;await h.analyzeSymbolReference(t.data,this._avoidSDF,n),r(s);for(const t of n)"CIMPictureMarker"!==t.cim.type&&"CIMPictureFill"!==t.cim.type&&"CIMPictureStroke"!==t.cim.type||(p||(p=[]),p.push(this._fetchPictureMarkerResource(t,s))),i&&"text"===t.type&&"string"==typeof t.text&&t.text.includes("[")&&(t.text=u(i,t.text,t.cim.textCase));return p&&await Promise.all(p),n}rasterizeCIMSymbol3D(t,e,r,i,o,a){const s=[];for(const n of t){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(e,o,a));const t=this._getRasterizedResource(n,e,r,i,o,a);if(!t)continue;let l=0,m=t.anchorX||0,c=t.anchorY||0,h=!1,p=0,g=0;if("esriGeometryPoint"===r){const t=w(i);if(p=d(n.offsetX,e,o,a)*t||0,g=d(n.offsetY,e,o,a)*t||0,"marker"===n.type)l=d(n.rotation,e,o,a)||0,h=n.rotateClockwise??!1;else if("text"===n.type){if(l=d(n.angle,e,o,a)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case"left":m=-.5;break;case"right":m=.5;break;default:m=0}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case"top":c=.5;break;case"bottom":c=-.5;break;case"baseline":c=-.25;break;default:c=0}}}null!=t&&s.push({angle:l,rotateClockWise:h,anchorX:m,anchorY:c,offsetX:p,offsetY:g,rasterizedResource:t})}return this.getSymbolImage(s)}getSymbolImage(t){const e=document.createElement("canvas"),r=e.getContext("2d");let o=0,a=0,s=0,n=0;const l=[];for(let e=0;e<t.length;e++){const m=t[e],c=m.rasterizedResource;if(!c)continue;const h=c.size,p=m.offsetX,g=m.offsetY,u=m.anchorX,d=m.anchorY,f=m.rotateClockWise||!1;let y=m.angle,j=i(p)-h[0]*(.5+u),w=i(g)-h[1]*(.5+d),C=j+h[0],b=w+h[1];if(y){f&&(y=-y);const t=Math.sin(y*Math.PI/180),e=Math.cos(y*Math.PI/180),r=j*e-w*t,i=j*t+w*e,o=j*e-b*t,a=j*t+b*e,s=C*e-b*t,n=C*t+b*e,l=C*e-w*t,m=C*t+w*e;j=Math.min(r,o,s,l),w=Math.min(i,a,n,m),C=Math.max(r,o,s,l),b=Math.max(i,a,n,m)}o=j<o?j:o,a=w<a?w:a,s=C>s?C:s,n=b>n?b:n;const z=r.createImageData(c.size[0],c.size[1]);z.data.set(new Uint8ClampedArray(c.image.buffer));const M={offsetX:p,offsetY:g,rotateClockwise:f,angle:y,rasterizedImage:z,anchorX:u,anchorY:d};l.push(M)}e.width=s-o,e.height=n-a;const m=-o,c=n;for(let t=0;t<l.length;t++){const e=l[t],o=this._imageDataToCanvas(e.rasterizedImage),a=e.rasterizedImage.width,s=e.rasterizedImage.height,n=m-a*(.5+e.anchorX),h=c-s*(.5-e.anchorY);if(e.angle){const t=(360-e.angle)*Math.PI/180;r.save(),r.translate(i(e.offsetX),-i(e.offsetY)),r.translate(m,c),r.rotate(t),r.translate(-m,-c),r.drawImage(o,n,h),r.restore()}else r.drawImage(o,n+i(e.offsetX),h-i(e.offsetY))}const h=new j({x:m/e.width-.5,y:c/e.height-.5});return{imageData:0!==e.width&&0!==e.height?r.getImageData(0,0,e.width,e.height):r.createImageData(1,1),anchorPosition:h}}async _fetchPictureMarkerResource(t,r){const i=t.materialHash;if(!this._pictureMarkerCache.get(i)){const o=(await e(t.cim.url,{responseType:"image",signal:r?.signal})).data;this._pictureMarkerCache.set(i,o)}}_imageDataToCanvas(t){const e=this._imageDataCanvas,r=this._imageDataContext;return e.width=t.width,e.height=t.height,r.putImageData(t,0,0),e}_imageTo32Array(e,r,i,o){const a=this._imageDataCanvas,s=this._imageDataContext;if(a.width=r,a.height=i,s.drawImage(e,0,0,r,i),o){s.save();const a=new t(o);s.fillStyle=a.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,r,i),s.globalCompositeOperation="destination-atop",s.drawImage(e,0,0,r,i),s.restore()}return new Uint32Array(s.getImageData(0,0,r,i).data.buffer)}_getRasterizedResource(t,e,r,i,o,s){let n,l,m;if("text"===t.type)return this._rasterizeTextResource(t,e,i,o,s);({analyzedCIM:n,hash:l}=function(t,e,r,i){let o,s;return"function"==typeof t.materialHash?(o=(0,t.materialHash)(e,r,i),s=a(t.cim,t.materialOverrides)):(o=t.materialHash,s=t.cim),{analyzedCIM:s,hash:o}}(t,e,o,s));const c=w(i);if("CIMPictureMarker"===t.cim.type){const r=d(t.size,e,o,s)*c,{image:i,width:a,height:n}=this._getPictureResource(t,r,d(t.color,e,o,s));return m={image:i,size:[a,n],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},m}y(n,c,{preserveOutlineWidth:!1});const h=n;l+=r,i&&(l+=JSON.stringify(i));const p=this._resourceCache;return p.has(l)?p.get(l):(m=this._rasterizer.rasterizeJSONResource({cim:h,type:t.type,url:t.url,mosaicHash:l,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),p.set(l,m),m)}_rasterizeTextResource(t,e,r,i,o){const a=w(r),s=d(t.text,e,i,o);if(!s||0===s.length)return null;const n=t.cim,l=d(n?.fontFamilyName||t.fontName,e,i,o),m=d(n?.font?.style||t.style,e,i,o),c=d(n?.font?.weight||t.weight,e,i,o),h=d(n?.font?.decoration||t.decoration,e,i,o),p=d(t.size,e,i,o)*a,g=d(t.horizontalAlignment,e,i,o),u=d(t.verticalAlignment,e,i,o),y=f(d(t.color,e,i,o)),j=f(d(t.outlineColor,e,i,o)),C=d(t.outlineSize,e,i,o),b=null!=t.backgroundColor?f(t.backgroundColor):null,z=null!=t.borderLineColor?f(t.borderLineColor):null,M=null!=t.borderLineWidth?t.borderLineWidth:null,_={color:y,size:p,horizontalAlignment:g,verticalAlignment:u,font:{family:l,style:m,weight:c,decoration:h},halo:{size:C||0,color:j,style:m},backgroundColor:b,borderLine:null!=z&&null!=M?{color:z,size:M}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(s,_)}_getPictureResource(t,e,r){const o=this._pictureMarkerCache.get(t.materialHash);if(!o)return null;const a=o.height/o.width,s=e?a>1?i(e):i(e)/a:o.width,n=e?a>1?i(e)*a:i(e):o.height;return{image:this._imageTo32Array(o,s,n,r),width:s,height:n}}}export{C as CIMSymbolRasterizer};
