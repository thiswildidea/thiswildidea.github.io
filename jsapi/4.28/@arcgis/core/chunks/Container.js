/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{c as e}from"./mat3f32.js";import{E as t}from"./EffectView.js";import{D as i}from"./DisplayObject.js";import{L as s}from"./Logger.js";import{a as o}from"./definitions.js";import{T as h}from"./enums3.js";import{T as r,a as n}from"./Texture.js";const l=1,a=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],c=s.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),u=[0,0,0,0];class f{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:0,outlineWidth:1.3,innerHaloWidth:.4,outerHaloWidth:.4},this._shadeTexChanged=!0,this._texelData=new Uint8Array(1024),this._minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;var i,s;i=e,(s=t).fillColor[0]=i.color.r/255,s.fillColor[1]=i.color.g/255,s.fillColor[2]=i.color.b/255,s.fillColor[3]=i.color.a,i.haloColor?(s.outlineColor[0]=i.haloColor.r/255,s.outlineColor[1]=i.haloColor.g/255,s.outlineColor[2]=i.haloColor.b/255,s.outlineColor[3]=i.haloColor.a):(s.outlineColor[0]=s.fillColor[0],s.outlineColor[1]=s.fillColor[1],s.outlineColor[2]=s.fillColor[2],s.outlineColor[3]=s.fillColor[3]),s.fillColor[3]*=i.fillOpacity,s.outlineColor[3]*=i.haloOpacity,s.fillColor[0]*=s.fillColor[3],s.fillColor[1]*=s.fillColor[3],s.fillColor[2]*=s.fillColor[3],s.outlineColor[0]*=s.outlineColor[3],s.outlineColor[1]*=s.outlineColor[3],s.outlineColor[2]*=s.outlineColor[3],s.outlineWidth=1.3,s.outerHaloWidth=.4,s.innerHaloWidth=.4,s.outlinePosition=0;const o=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,h=t.outlinePosition-t.outlineWidth/2,r=t.outlinePosition+t.outlineWidth/2,n=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,l=1*Math.sqrt(Math.PI/2),a=Math.abs(o)>l?Math.round(10*(Math.abs(o)-l))/10:0,d=Math.abs(n)>l?Math.round(10*(Math.abs(n)-l))/10:0;let f;a&&!d?c.error("The outer rim of the highlight is "+a+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!a&&d?c.error("The inner rim of the highlight is "+d+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):a&&d&&c.error("The highlight is "+Math.max(a,d)+"px away from the edge of the feature; consider reducing some width values.");const g=[void 0,void 0,void 0,void 0];function p(e,t,i){g[0]=(1-i)*e[0]+i*t[0],g[1]=(1-i)*e[1]+i*t[1],g[2]=(1-i)*e[2]+i*t[2],g[3]=(1-i)*e[3]+i*t[3]}const{_texelData:_}=this;for(let e=0;e<256;++e)f=o+e/255*(n-o),f<o?(g[0]=0,g[1]=0,g[2]=0,g[3]=0):f<h?p(u,t.outlineColor,(f-o)/(h-o)):f<r?[g[0],g[1],g[2],g[3]]=t.outlineColor:f<n?p(t.outlineColor,t.fillColor,(f-r)/(n-r)):[g[0],g[1],g[2],g[3]]=t.fillColor,_[4*e]=255*g[0],_[4*e+1]=255*g[1],_[4*e+2]=255*g[2],_[4*e+3]=255*g[3];this._minMaxDistance[0]=o,this._minMaxDistance[1]=n,this._shadeTexChanged=!0}applyHighlightOptions(e,t){if(!this._shadeTex){const t=new r;t.wrapMode=h.CLAMP_TO_EDGE,t.width=256,t.height=1,this._shadeTex=new n(e,t)}this._shadeTexChanged&&(this._shadeTex.updateData(0,0,0,256,1,this._texelData),this._shadeTexChanged=!1),e.bindTexture(this._shadeTex,o),t.setUniform2fv("u_minMaxDistance",this._minMaxDistance)}destroy(){this._shadeTex?.dispose(),this._shadeTex=null}}class g extends i{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this.children=[],this._effectView=null,this._highlightOptions=null,this._highlightGradient=null}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.requestRender()}get clips(){return this._clips}set clips(e){this._clips=e,this.children.forEach((t=>t.clips=e))}get computedEffects(){return this._effectView?.effects??null}get effect(){return this._effectView?.effect??""}set effect(e){(this._effectView||e)&&(this._effectView||(this._effectView=new t),this._effectView.effect=e,this.requestRender())}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){if(!e)return this._highlightOptions=null,void(this._highlightGradient&&(this._highlightGradient.destroy(),this._highlightGradient=null,this.requestRender()));this._highlightOptions&&this._highlightOptions.equals(e)||(this._highlightOptions=e,this._highlightGradient||(this._highlightGradient=new f),this._highlightGradient.setHighlightOptions(e),this.requestRender())}get hasBlending(){return!!this.blendMode}get hasHighlight(){return this.children.some((e=>e.hasHighlight))}get hasLabels(){return this.children.some((e=>e.hasLabels))}get requiresDedicatedFBO(){return this.children.some((e=>"blendMode"in e&&e.blendMode&&"normal"!==e.blendMode))}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._effectView&&(this._effectView.transitionStep(e,t),this._effectView.transitioning&&this.requestRender())}doRender(e){const t=this.createRenderParams(e),{painter:i}=t;i.beforeRenderLayer(t,this._clips?.length?255:0,this.computedOpacity),this.renderChildren(t),i.afterRenderLayer(t,this.computedOpacity)}addChild(e){return this.addChildAt(e,this.children.length)}addChildAt(e,t=this.children.length){if(!e)return e;if(this.contains(e))return e;this._needsSort=!0;const i=e.parent;return i&&i!==this&&i.removeChild(e),t>=this.children.length?this.children.push(e):this.children.splice(t,0,e),this._childrenSet.add(e),e.parent=this,e.stage=this.stage,this!==this.stage&&(e.clips=this.clips),this.requestRender(),e}contains(e){return this._childrenSet.has(e)}endTransitions(){super.endTransitions(),this._effectView&&(this._effectView.endTransitions(),this.requestRender())}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const e of this.children)this!==this.stage&&(e.clips=null),e.stage=null,e.parent=null;this.children.length=0}removeChild(e){return this.contains(e)?this.removeChildAt(this.children.indexOf(e)):e}removeChildAt(e){if(e<0||e>=this.children.length)return null;this._needsSort=!0;const t=this.children.splice(e,1)[0];return this._childrenSet.delete(t),this!==this.stage&&(t.clips=null),t.stage=null,t.parent=null,t}sortChildren(e){this._needsSort&&(this.children.sort(e),this._needsSort=!1)}beforeRender(e){super.beforeRender(e);for(const t of this.children)t.beforeRender(e)}afterRender(e){super.afterRender(e);for(const t of this.children)t.afterRender(e)}_createTransforms(){return{dvs:e()}}onAttach(){super.onAttach();const e=this.stage;for(const t of this.children)t.stage=e}onDetach(){super.onDetach();for(const e of this.children)e.stage=null}renderChildren(e){for(const t of this.children)t.processRender(e)}createRenderParams(e){return{...e,requireFBO:this.requiresDedicatedFBO,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:e.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition,highlightGradient:this._highlightGradient||e.highlightGradient}}}export{g as C,a,d as r,l as s};
