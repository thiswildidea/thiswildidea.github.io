/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{i as s}from"./typedArrayUtil.js";import{createResolver as t}from"../core/promiseUtils.js";import{initializeProjection as n,projectMany as r}from"../geometry/projection.js";import{j as e}from"./json.js";import{m as i,f as o,b as a}from"./unitUtils.js";import{lngLatToXY as m,xyToLngLat as u,canProject as c}from"../geometry/support/webMercatorUtils.js";const h=[0,0];function p(s,t){if(!t)return null;if("x"in t){const n={x:0,y:0};return[n.x,n.y]=s(t.x,t.y,h),null!=t.z&&(n.z=t.z),null!=t.m&&(n.m=t.m),n}if("xmin"in t){const n={xmin:0,ymin:0,xmax:0,ymax:0};return[n.xmin,n.ymin]=s(t.xmin,t.ymin,h),[n.xmax,n.ymax]=s(t.xmax,t.ymax,h),t.hasZ&&(n.zmin=t.zmin,n.zmax=t.zmax,n.hasZ=!0),t.hasM&&(n.mmin=t.mmin,n.mmax=t.mmax,n.hasM=!0),n}return"rings"in t?{rings:l(t.rings,s),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:l(t.paths,s),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:f(t.points,s),hasM:t.hasM,hasZ:t.hasZ}:null}function l(s,t){const n=[];for(const r of s)n.push(f(r,t));return n}function f(s,t){const n=[];for(const r of s){const s=t(r[0],r[1],[0,0]);n.push(s),r.length>2&&s.push(r[2]),r.length>3&&s.push(r[3])}return n}async function x(t,r){if(!t||!r)return;const e=Array.isArray(t)?t.map((s=>null!=s.geometry?s.geometry.spatialReference:null)).filter(s):[t];await n(e.map((s=>({source:s,dest:r}))))}const y=p.bind(null,m),g=p.bind(null,u);function j(s,t,n,m){if(!s)return s;if(n||(n=t,t=s.spatialReference),!i(t)||!i(n)||o(t,n))return s;if(c(t,n)){const t=a(n)?y(s):g(s);return t.spatialReference=n,t}return r(e,[s],t,n,null,m)[0]}const _=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(s,n,r,e){if(!s?.length||!n||!r||o(n,r))return s;const i={geometries:s,inSpatialReference:n,outSpatialReference:r,geographicTransformation:e,resolve:t()};return this._jobs.push(i),this._timer??=setTimeout(this._process,10),i.resolve.promise}_process(){this._timer=null;const s=this._jobs.shift();if(!s)return;const{geometries:t,inSpatialReference:n,outSpatialReference:i,resolve:o,geographicTransformation:m}=s;c(n,i)?a(i)?o(t.map(y)):o(t.map(g)):o(r(e,t,n,i,m,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};function M(s,t,n,r){return _.push(s,t,n,r)}export{M as a,x as c,j as p};
