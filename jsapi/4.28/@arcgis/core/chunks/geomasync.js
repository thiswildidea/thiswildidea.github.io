/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{version as n}from"../kernel.js";import{K as t,p as e,L as r,M as i,O as o,y as a,A as s,E as l,o as c,q as u,C as f,t as m,P as p,Q as d,T as w,U as y,w as h,V as j,W as g,X as v,Y as P,F as A,Z as I,_ as F,$ as b}from"./arcadeUtils.js";import{a as R,b as x,d as N}from"./TimeOnly.js";import{g as O}from"./portalUtils.js";import{g as S}from"./unitUtils.js";import U from"../geometry/Extent.js";import D from"../geometry/Geometry.js";import{disjoint as k,intersects as C,touches as T,crosses as M,within as Z,contains as z,overlaps as L,equals as E,relate as J,intersect as q,union as B,difference as Q,symmetricDifference as W,clip as G,cut as V,planarArea as H,geodesicArea as K,planarLength as X,geodesicLength as Y,distance as $,densify as _,geodesicDensify as nn,generalize as tn,buffer as en,geodesicBuffer as rn,offset as on,rotate as an,simplify as sn,isSimple as ln,convexHull as cn,nearestCoordinate as un,nearestVertex as fn}from"../geometry/geometryEngineAsync.js";import mn from"../geometry/Multipoint.js";import pn from"../geometry/Point.js";import dn from"../geometry/Polygon.js";import wn from"../geometry/Polyline.js";import{fromJSON as yn}from"../geometry/support/jsonUtils.js";import hn from"../portal/Portal.js";import{l as jn}from"./utils19.js";import"./typedArrayUtil.js";import"../core/urlUtils.js";import"../config.js";import"../core/lang.js";import"../core/Error.js";import"./Logger.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./time.js";import"../geometry.js";import"../geometry/SpatialReference.js";import"./writer.js";import"./jsonMap.js";import"./Ellipsoid.js";import"./assets.js";import"../request.js";import"./typeUtils.js";import"../geometry/support/webMercatorUtils.js";import"./reader.js";import"./zmUtils.js";import"../core/accessorSupport/decorators/cast.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ImmutableArray.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./datetime.js";import"./number2.js";import"./locale.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./OptimizedGeometry.js";import"../layers/support/FieldsIndex.js";import"./UnknownTimeZone.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./timeZoneUtils.js";import"./messages.js";import"./arcadeOnDemand.js";import"./hash.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"./SimpleObservable.js";import"../core/workers/RemoteClient.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";function gn(t){return 0===n.indexOf("4.")?dn.fromExtent(t):new dn({spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]})}function vn(n,t,r){if(e(n,2,2,t,r),n[0]instanceof D&&n[1]instanceof D);else if(n[0]instanceof D&&null===n[1]);else if(n[1]instanceof D&&null===n[0]);else if(null!==n[0]||null!==n[1])throw new s(t,l.InvalidParameter,r)}async function Pn(n,t){if("polygon"!==n.type&&"polyline"!==n.type&&"extent"!==n.type)return 0;let e=1;(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid)&&(e=F(n.spatialReference)/S(n.spatialReference));let r=0;if("polyline"===n.type)for(const t of n.paths)for(let n=1;n<t.length;n++)r+=b(t[n],t[n-1],e);else if("polygon"===n.type)for(const t of n.rings){for(let n=1;n<t.length;n++)r+=b(t[n],t[n-1],e);(t[0][0]!==t[t.length-1][0]||t[0][1]!==t[t.length-1][1]||void 0!==t[0][2]&&t[0][2]!==t[t.length-1][2])&&(r+=b(t[0],t[t.length-1],e))}else"extent"===n.type&&(r+=2*b([n.xmin,n.ymin,0],[n.xmax,n.ymin,0],e),r+=2*b([n.xmin,n.ymin,0],[n.xmin,n.ymax,0],e),r*=2,r+=4*Math.abs(p(n.zmax,0)*e-p(n.zmin,0)*e));const i=new wn({hasZ:!1,hasM:!1,spatialReference:n.spatialReference,paths:[[0,0],[0,r]]});return X(i,t)}function An(n){"async"===n.mode&&(n.functions.disjoint=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null===o[0]||null===o[1]||k(o[0],o[1]))))},n.functions.intersects=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&C(o[0],o[1]))))},n.functions.touches=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&T(o[0],o[1]))))},n.functions.crosses=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&M(o[0],o[1]))))},n.functions.within=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&Z(o[0],o[1]))))},n.functions.contains=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&z(o[0],o[1]))))},n.functions.overlaps=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&L(o[0],o[1]))))},n.functions.equals=function(t,a){return n.standardFunctionAsync(t,a,((n,s,l)=>(e(l,2,2,t,a),l[0]===l[1]||(l[0]instanceof D&&l[1]instanceof D?E(l[0],l[1]):(r(l[0])&&r(l[1])||!!(i(l[0])&&i(l[1])||o(l[0])&&o(l[1])))&&l[0].equals(l[1])))))},n.functions.relate=function(r,i){return n.standardFunctionAsync(r,i,((n,o,c)=>{if(c=t(c),e(c,3,3,r,i),c[0]instanceof D&&c[1]instanceof D)return J(c[0],c[1],a(c[2]));if(c[0]instanceof D&&null===c[1])return!1;if(c[1]instanceof D&&null===c[0])return!1;if(null===c[0]&&null===c[1])return!1;throw new s(r,l.InvalidParameter,i)}))},n.functions.intersection=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null===o[0]||null===o[1]?null:q(o[0],o[1]))))},n.functions.union=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>{const a=[];if(0===(o=t(o)).length)throw new s(e,l.WrongNumberOfParameters,r);if(1===o.length)if(c(o[0])){const n=t(o[0]);for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof D))throw new s(e,l.InvalidParameter,r);a.push(n[t])}}else{if(!u(o[0])){if(o[0]instanceof D)return f(R(o[0]),e.spatialReference);if(null===o[0])return null;throw new s(e,l.InvalidParameter,r)}{const n=t(o[0].toArray());for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof D))throw new s(e,l.InvalidParameter,r);a.push(n[t])}}}else for(let n=0;n<o.length;n++)if(null!==o[n]){if(!(o[n]instanceof D))throw new s(e,l.InvalidParameter,r);a.push(o[n])}return 0===a.length?null:B(a)}))},n.functions.difference=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null!==o[0]&&null===o[1]?R(o[0]):null===o[0]?null:Q(o[0],o[1]))))},n.functions.symmetricdifference=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(vn(o=t(o),e,r),null===o[0]&&null===o[1]?null:null===o[0]?R(o[1]):null===o[1]?R(o[0]):W(o[0],o[1]))))},n.functions.clip=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[1]instanceof U)&&null!==a[1])throw new s(r,l.InvalidParameter,i);if(null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return null===a[1]?null:G(a[0],a[1])}))},n.functions.cut=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[1]instanceof wn)&&null!==a[1])throw new s(r,l.InvalidParameter,i);if(null===a[0])return[];if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return null===a[1]?[R(a[0])]:V(a[0],a[1])}))},n.functions.area=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(e(a,1,2,r,i),null===(a=t(a))[0])return 0;if(m(a[0])){const n=await a[0].sumArea(x(p(a[1],-1)),!1,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(a[0])||u(a[0])){const n=d(a[0],r.spatialReference);return null===n?0:H(n,x(p(a[1],-1)))}if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return H(a[0],x(p(a[1],-1)))}))},n.functions.areageodetic=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(e(a,1,2,r,i),null===(a=t(a))[0])return 0;if(m(a[0])){const n=await a[0].sumArea(x(p(a[1],-1)),!0,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(a[0])||u(a[0])){const n=d(a[0],r.spatialReference);return null===n?0:K(n,x(p(a[1],-1)))}if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return K(a[0],x(p(a[1],-1)))}))},n.functions.length=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(e(a,1,2,r,i),null===(a=t(a))[0])return 0;if(m(a[0])){const n=await a[0].sumLength(N(p(a[1],-1)),!1,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(a[0])||u(a[0])){const n=w(a[0],r.spatialReference);return null===n?0:X(n,N(p(a[1],-1)))}if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return X(a[0],N(p(a[1],-1)))}))},n.functions.length3d=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(e(a,1,2,r,i),null===(a=t(a))[0])return 0;if(c(a[0])||u(a[0])){const n=w(a[0],r.spatialReference);return null===n?0:!0===n.hasZ?Pn(n,N(p(a[1],-1))):X(n,N(p(a[1],-1)))}if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return!0===a[0].hasZ?Pn(a[0],N(p(a[1],-1))):X(a[0],N(p(a[1],-1)))}))},n.functions.lengthgeodetic=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(e(a,1,2,r,i),null===(a=t(a))[0])return 0;if(m(a[0])){const n=await a[0].sumLength(N(p(a[1],-1)),!0,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(a[0])||u(a[0])){const n=w(a[0],r.spatialReference);return null===n?0:Y(n,N(p(a[1],-1)))}if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return Y(a[0],N(p(a[1],-1)))}))},n.functions.distance=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{a=t(a),e(a,2,3,r,i);let f=a[0];(c(a[0])||u(a[0]))&&(f=y(a[0],r.spatialReference));let m=a[1];if((c(a[1])||u(a[1]))&&(m=y(a[1],r.spatialReference)),!(f instanceof D))throw new s(r,l.InvalidParameter,i);if(!(m instanceof D))throw new s(r,l.InvalidParameter,i);return $(f,m,N(p(a[2],-1)))}))},n.functions.distancegeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{a=t(a),e(a,2,3,r,i);const c=a[0],u=a[1];if(!(c instanceof pn))throw new s(r,l.InvalidParameter,i);if(!(u instanceof pn))throw new s(r,l.InvalidParameter,i);const f=new wn({paths:[],spatialReference:c.spatialReference});return f.addPath([c,u]),Y(f,N(p(a[2],-1)))}))},n.functions.densify=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=h(a[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);if(c<=0)throw new s(r,l.InvalidParameter,i);return a[0]instanceof dn||a[0]instanceof wn?_(a[0],c,N(p(a[2],-1))):a[0]instanceof U?_(gn(a[0]),c,N(p(a[2],-1))):a[0]}))},n.functions.densifygeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=h(a[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);if(c<=0)throw new s(r,l.InvalidParameter,i);return a[0]instanceof dn||a[0]instanceof wn?nn(a[0],c,N(p(a[2],-1))):a[0]instanceof U?nn(gn(a[0]),c,N(p(a[2],-1))):a[0]}))},n.functions.generalize=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,4,r,i),null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=h(a[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);return tn(a[0],c,j(p(a[2],!0)),N(p(a[3],-1)))}))},n.functions.buffer=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=h(a[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);return 0===c?R(a[0]):en(a[0],c,N(p(a[2],-1)))}))},n.functions.buffergeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=h(a[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);return 0===c?R(a[0]):rn(a[0],c,N(p(a[2],-1)))}))},n.functions.offset=function(r,i){return n.standardFunctionAsync(r,i,((n,o,c)=>{if(c=t(c),e(c,2,6,r,i),null===c[0])return null;if(!(c[0]instanceof dn||c[0]instanceof wn))throw new s(r,l.InvalidParameter,i);const u=h(c[1]);if(isNaN(u))throw new s(r,l.InvalidParameter,i);const f=h(p(c[4],10));if(isNaN(f))throw new s(r,l.InvalidParameter,i);const m=h(p(c[5],0));if(isNaN(m))throw new s(r,l.InvalidParameter,i);return on(c[0],u,N(p(c[2],-1)),a(p(c[3],"round")).toLowerCase(),f,m)}))},n.functions.rotate=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{a=t(a),e(a,2,3,r,i);let c=a[0];if(null===c)return null;if(!(c instanceof D))throw new s(r,l.InvalidParameter,i);c instanceof U&&(c=dn.fromExtent(c));const u=h(a[1]);if(isNaN(u))throw new s(r,l.InvalidParameter,i);const f=p(a[2],null);if(null===f)return an(c,u);if(f instanceof pn)return an(c,u,f);throw new s(r,l.InvalidParameter,i)}))},n.functions.centroid=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,1,1,r,i),null===a[0])return null;let m=a[0];if((c(a[0])||u(a[0]))&&(m=y(a[0],r.spatialReference)),null===m)return null;if(!(m instanceof D))throw new s(r,l.InvalidParameter,i);return m instanceof pn?f(R(a[0]),r.spatialReference):m instanceof dn?m.centroid:m instanceof wn?g(m):m instanceof mn?v(m):m instanceof U?m.center:null}))},n.functions.multiparttosinglepart=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{a=t(a),e(a,1,1,r,i);const c=[];if(null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);if(a[0]instanceof pn)return[f(R(a[0]),r.spatialReference)];if(a[0]instanceof U)return[f(R(a[0]),r.spatialReference)];const u=await sn(a[0]);if(u instanceof dn){const n=[],t=[];for(let e=0;e<u.rings.length;e++)if(u.isClockwise(u.rings[e])){const t=yn({rings:[u.rings[e]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(t)}else t.push({ring:u.rings[e],pt:u.getPoint(e,0)});for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++)if(n[r].contains(t[e].pt)){n[r].addRing(t[e].ring);break}return n}if(u instanceof wn){const n=[];for(let t=0;t<u.paths.length;t++){const e=yn({paths:[u.paths[t]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(e)}return n}if(a[0]instanceof mn){const n=f(R(a[0]),r.spatialReference);for(let t=0;t<n.points.length;t++)c.push(n.getPoint(t));return c}return null}))},n.functions.issimple=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,1,1,r,i),null===a[0])return!0;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return ln(a[0])}))},n.functions.simplify=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,1,1,r,i),null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return sn(a[0])}))},n.functions.convexhull=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,1,1,r,i),null===a[0])return null;if(!(a[0]instanceof D))throw new s(r,l.InvalidParameter,i);return cn(a[0])}))},n.functions.getuser=function(t,r){return n.standardFunctionAsync(t,r,(async(n,i,o)=>{e(o,0,2,t,r);let c=p(o[1],""),u=!0===c;if(c=!0===c||!1===c?"":a(c),0===o.length||o[0]instanceof P){let n=null;n=t.services?.portal?t.services.portal:hn.getDefault(),o.length>0&&(n=O(o[0],n));const e=await jn(n,c,u);if(e){const n=JSON.parse(JSON.stringify(e));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return A.convertObjectToArcadeDictionary(n,I(t))}return null}let f=null;if(m(o[0])&&(f=o[0]),f){if(u=!1,c)return null;await f.load();const n=await f.getOwningSystemUrl();if(!n){if(!c){const n=await f.getIdentityUser();return n?A.convertObjectToArcadeDictionary({username:n},I(t)):null}return null}let e=null;e=t.services?.portal?t.services.portal:hn.getDefault(),e=O(new P(n),e);const r=await jn(e,c,u);if(r){const n=JSON.parse(JSON.stringify(r));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return A.convertObjectToArcadeDictionary(n,I(t))}return null}throw new s(t,l.InvalidParameter,r)}))}),n.functions.nearestcoordinate=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[0]instanceof D||null===a[0]))throw new s(r,l.InvalidParameter,i);if(!(a[1]instanceof pn||null===a[1]))throw new s(r,l.InvalidParameter,i);if(null===a[0]||null===a[1])return null;const c=await un(a[0],a[1]);return null===c?null:A.convertObjectToArcadeDictionary({coordinate:c.coordinate,distance:c.distance},I(r),!1,!0)}))},n.functions.nearestvertex=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[0]instanceof D||null===a[0]))throw new s(r,l.InvalidParameter,i);if(!(a[1]instanceof pn||null===a[1]))throw new s(r,l.InvalidParameter,i);if(null===a[0]||null===a[1])return null;const c=await fn(a[0],a[1]);return null===c?null:A.convertObjectToArcadeDictionary({coordinate:c.coordinate,distance:c.distance},I(r),!1,!0)}))}}export{An as registerFunctions};
