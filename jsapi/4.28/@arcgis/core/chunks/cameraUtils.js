/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../Camera.js";import{C as t,a as n}from"./Cyclical.js";import{L as r}from"./Logger.js";import{r as i,b as a,d as o,a as s}from"./mathUtils.js";import{throwIfAborted as c}from"../core/promiseUtils.js";import{c as l,a as u,q as f,b as m,d as p,i as d,l as h,p as y,k as g,t as M,E as v,w as T}from"./vec3.js";import{c as R,f as w,a as x}from"./vec3f64.js";import{j as b}from"./unitUtils.js";import j from"../geometry/Point.js";import{projectWithZConversion as S,project as C}from"../geometry/projection.js";import z from"../geometry/SpatialReference.js";import{p as P}from"./projectPointToVector.js";import{p as H}from"./projectPointToVectorWithEngine.js";import{p as A}from"./projectVectorToPoint.js";import{p as E}from"./projectVectorToVector.js";import{V as D}from"./ViewingMode.js";import{s as U}from"./aaBoundingRect.js";import{a as G}from"./Intersector2.js";import{z as q,n as I,f as L,w as O}from"./mat4.js";import{a as k}from"./mat4f64.js";import W from"../geometry/Extent.js";import{geographicToWebMercator as F}from"../geometry/support/webMercatorUtils.js";import{g as _,a as V}from"./earthUtils.js";import{g as J}from"./ElevationProvider.js";import{i as X}from"./spatialReferenceSupport.js";async function K(e,t,n,r){const i=A(e,t,n);if(null!=i)return i;const a=new j({x:e[0],y:e[1],z:e[2],spatialReference:t,hasZ:!0});return S(a,n,r)}function Y(e,t,n,r){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,$,r)&&U(n,$)}function Z(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function B(e,t,n,r){const i=e.state.camera.clone();t&&n&&r&&(i.eye=t,i.center=n,i.up=r),function(e,t,n){let r=Q[e.viewingMode];r||(r=G(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Q[e.viewingMode]=r);const{isGlobal:i}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,n)||N(e,t.origin,n))||!(!e.renderCoordsHelper.intersectManifold(t,0,n)||N(e,t.origin,n))||!!i&&function(e,t,n){const r=d(e.origin,e.origin)-n*n,i=r>0?Math.sqrt(r)/3:1;return f(t,e.direction,i/h(e.direction)),p(t,t,e.origin),!0}(t,n,b(e.spatialReference).radius)}(e,i.ray,ee)||l(ee,i.center);const a=e.state.constraints,o=a.minimumPoiDistance;if(u(i.eye,ee)<o){const t=a.collision.enabled;l(te,i.viewForward),f(te,te,o),t?i.eye=m($,ee,te):p(ee,i.eye,te);const n=e.renderCoordsHelper,r=n.getAltitude(i.eye),s=a.collision.elevationMargin;t&&r<s&&(m(te,ee,i.eye),i.eye=n.setAltitude($,s,i.eye),p(ee,i.eye,te))}return i.center=ee,i}function N(e,t,n){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const r=Z(e,t),i=e.stateManager.constraintsManager.nearFarHeuristic,{far:a}=i.compute(t,n,e.renderDataExtent,r,ne),o=a*a;return u(t,n)>o}const Q={},$=R(),ee=R(),te=R(),ne={near:0,far:0},re=R(),ie=R();function ae(){return{direction:R(),up:R()}}function oe(e,t,n,r,o){let s=y(re,e),c=d(s,r);const u=c>0;c=Math.abs(c),c>.99&&(c=Math.abs(d(t,r)),c<.99?(l(s,t),u&&f(s,s,-1)):s=null);let p=0;if(s){f(ie,r,d(r,s)),m(s,s,ie);const e=d(s,o)/(h(s)*h(o));g(ie,s,o),p=(d(ie,r)>0?1:-1)*i(a(e))}const M=i(a(-d(r,e)/h(e)));return n?(n.heading=p,n.tilt=M,n):{heading:p,tilt:M}}const se=w(0,1,0),ce=w(0,0,1),le=k(),ue=R(),fe=R();function me(e,t,n,r=ae()){const{direction:i,up:a}=r;return q(le,-o(t)),I(le,le,o(n)),M(i,ce,le),f(i,i,-1),M(a,se,le),r}function pe(e,t,n,r,i){const a=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return P(t,ue,a),P(t,fe,a),ue[0]-=n/2,fe[0]+=n/2,ue[1]-=r/2,fe[1]+=r/2,E(ue,a,ue,o),E(fe,a,fe,o),i?(i.xmin=ue[0],i.ymin=ue[1],i.xmax=fe[0],i.ymax=fe[1],i.spatialReference=o):i=new W(ue[0],ue[1],fe[0],fe[1],o),i}const de=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){return oe(t,n,r,ce,se)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i=me(0,n,r),a=R();return f(a,i.direction,-t),p(a,a,e),{up:i.up,eye:a,heading:n,tilt:r}},eyeTiltToLookAtTilt:function(e){return o(e)},headingTiltToDirectionUp:me,lookAtTiltToEyeTilt:function(e){return i(e)},toExtent:pe},Symbol.toStringTag,{value:"Module"})),he=w(0,0,1),ye=y(R(),w(1,1,1)),ge=new t(-180,180),Me=k(),ve=R(),Te=R();function Re(e,t,n,r=ae()){g(ve,e,he),0===d(ve,ve)&&g(ve,e,ye),L(Me,-o(t),e),O(Me,Me,-o(n),ve);const{up:i,direction:a}=r;return g(i,ve,e),y(i,i),M(i,i,Me),y(a,e),v(a,a),M(a,a,Me),r}function we(e){const t=e[1];e[1]=-e[2],e[2]=t}function xe(e,t){const n=Re(t,e.heading,e.tilt);return e.up=n.up,e}function be(e,t,r,a,s){let c,l,u,f;const m=t.latitude,p=b(e.spatialReference).radius,d=t.longitude,h=_(m,r,p)/2;c=d-h,l=d+h;const y=o(m),g=(1+Math.sin(y))/(1-Math.sin(y)),M=(g+1)*Math.tan(a/p/2),v=M*M;function T(e){const t=Math.PI/2;return(e=n.normalize(e,-t))>t&&(e=Math.PI-e),e}if(u=1.5*Math.PI-2*Math.atan(.5*(M+Math.sqrt(4*g+v))),f=u+a/p,u=T(u),f=T(f),f<u){const e=f;f=u,u=e}if(u=Math.max(i(u),-90),f=Math.min(i(f),90),l=ge.monotonic(c,l),l-c>180){const e=(l-c-180)/2;c+=e,l-=e}const R=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:z.WGS84;return s?(s.xmin=c,s.ymin=u,s.xmax=l,s.ymax=f,s.spatialReference=R):s=new W(c,u,l,f,R),e.spatialReference&&e.spatialReference.isWebMercator&&F(s,!1,s),s}const je=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){const i=ve,a=Te;return y(i,e),g(Te,i,he),0===d(Te,Te)&&g(Te,i,ye),g(a,Te,i),oe(t,n,r,i,a)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i={eye:R(),up:null,tilt:r,heading:n},a=ve;a[0]=e[0],a[1]=e[2],a[2]=-e[1];const c=t,l=o(n),u=o(r),m=Math.sin(l),p=Math.cos(l),d=Math.sin(u),y=Math.cos(u),g=h(a);let M;if(Math.abs(u)<1e-8)M=c+g;else{const e=g/d,t=s(c/e),n=Math.PI-u-t;M=e*Math.sin(n)}const v=y*c,T=c*c*(d*d),w=p*p*T,x=M-v,b=x*x,j=w*(w+b-a[1]*a[1]);if(j<0)return f(i.eye,a,M/g),i.tilt=0,xe(i,e);const S=Math.sqrt(j),C=a[1]*x,z=w+b;let P;if(P=p>0?-S+C:S+C,Math.abs(z)<1e-8)return g<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=c):f(i.eye,a,M/g),i.tilt=0,we(i.eye),xe(i,e);i.eye[1]=P/z;const H=m*m*T,A=d*c,E=p*A*i.eye[1],D=i.eye[1]*i.eye[1],U=1-D,G=Math.sqrt(U),q=w*D+H-2*E*G*x+U*b;return Math.abs(q)<1e-8?(f(i.eye,a,M/g),i.tilt=0,we(i.eye),xe(i,e)):(i.eye[0]=(U*(M*a[0]-v*a[0])-A*G*(a[0]*i.eye[1]*p+a[2]*m))/q,i.eye[2]=(U*(M*a[2]-v*a[2])-A*G*(a[2]*i.eye[1]*p-a[0]*m))/q,f(i.eye,i.eye,M),we(i.eye),xe(i,e))},eyeTiltToLookAtTilt:function(e,t,n){const r=o(e),i=h(t);return s(n/(i/Math.sin(r)))+r},headingTiltToDirectionUp:Re,lookAtTiltToEyeTilt:function(e,t,n){const r=h(t),a=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),o=s(n/(a/Math.sin(e)));return i(e-o)},toExtent:be},Symbol.toStringTag,{value:"Module"})),Se=r.getLogger("esri.views.3d.support.cameraUtils"),Ce=39.37,ze=96,Pe=1,He=8,Ae=5,Ee=1,De=R(),Ue={heading:0,tilt:0},Ge=R(),qe=new t(-20037508.342788905,20037508.342788905),Ie=new t(-180,180);var Le;function Oe(e){return e.spatialReference??z.WGS84}function ke(e){return"global"===e.viewingMode?je:de}function We(e,t,n,r,i){return ke(e).headingTiltToDirectionUp(t,n,r,i)}function Fe(e,t){if(null==t)return null;const n=e.renderSpatialReference,r=ke(e).headingTiltToDirectionUp,i=R();if(!P(t.position,i,n))return null;const a=r(i,t.heading,t.tilt);f(a.direction,a.direction,e.state.camera.distance),p(a.direction,a.direction,i);const s=B(e,i,a.direction,a.up);return s.fov=o(t.fov),s}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(Le||(Le={}));const _e=R();function Ve(t,n,r){const a=t.renderSpatialReference,o=Be(t,n.eye,n.viewForward,n.up,Ue);let s=Oe(t);return E(n.eye,a,_e,s)||(s=z.WGS84,E(n.eye,a,_e,s)),null==r?new e(new j(_e,s),o.heading,o.tilt,i(n.fov)):(r.position.x=_e[0],r.position.y=_e[1],r.position.z=_e[2],r.position.spatialReference=s,r.heading=o.heading,r.tilt=o.tilt,r.fov=i(n.fov),r)}function Je(e,t,n){const r=e.state.camera,i=r.width/2/r.pixelRatio;return e.renderCoordsHelper.viewingMode===D.Global&&null!=n&&(t*=Math.cos(o(n))),t/=e.renderCoordsHelper.unitInMeters,i/(ze*Ce/t)/Math.tan(r.fovX/2)}function Xe(e,t,n){const r=e.state.camera,i=t*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let s=ze*Ce/(a/i);return e.renderCoordsHelper.viewingMode===D.Global&&null!=n&&(s/=Math.cos(o(n))),s*e.renderCoordsHelper.unitInMeters}async function Ke(e,t,n,r,i,a){return Ze(e,t,Je(e,n,t.latitude),r,i,a)}function Ye(e,t,n,r,i,a){return dt(e,Qe(e,r.heading,r.tilt,t,n,i),r.fov,a)}async function Ze(e,t,n,r,i,a){const o=await $e(e,r.heading,r.tilt,t,n,i,a);return c(a),ht(e,o,r.fov,a)}function Be(e,t,n,r,i){return ke(e).directionToHeadingTilt(t,n,r,i)}function Ne(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Ge,e.spatialReference)&&e.elevationProvider&&(J(e.elevationProvider,Ge)??0)>Ge[2]-Ee)}function Qe(e,t,n,r,i,a){const o=r instanceof j?r:null,s=function(e,t){const n=R();if(null==t)return l(n,e.state.camera.center);if(t instanceof j){if(!P(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:i}=e;if(null==t.z&&null!=r&&null!=i){const r=J(i,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return l(n,t)}(e,r);return et(e,t,n,o,s,i,a)}async function $e(e,t,n,r,i,a,o){const s=r instanceof j?r:null,u=await async function(e,t,n){const r=R();if(null==t)return l(r,e.state.camera.center);if(t instanceof j){const{renderSpatialReference:i,basemapTerrain:a,elevationProvider:o}=e,s=t.spatialReference;if(await H(t,r,i,0,{signal:n}),c(n),null==t.z&&null!=a&&null!=o){const i=await o.queryElevation(t.x,t.y,t.z??0,s,"ground",n);c(n),null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return l(r,t)}(e,r,o);return c(o),tt(e,t,n,s,u,i,a,o)}function et(e,t,n,r,i,a,o){if(null==i)return null;if(r??=A(i,e.renderSpatialReference,Oe(e)),null==r)return null;const s=nt(e,t,n,i,a,o);if(rt(e,n,o)&&Ne(e,s.eye)){const{tilt:o,mode:s}=it(e,n,i,a);return et(e,t,o,r,i,a,s)}return at(s,i)}async function tt(e,t,n,r,i,a,o,s){r??=await K(i,e.renderSpatialReference,Oe(e),{signal:s}),c(s);const l=nt(e,t,n,i,a,o);if(rt(e,n,o)&&await async function(e,t,n){if(Ne(e,t))return!0;const{elevationProvider:r,spatialReference:i,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(t,Ge,i))return!1;const[o,s,l]=Ge,u=await r.queryElevation(o,s,l,i,"ground",n)??0;return c(n),u>l-Ee}(e,l.eye,s)){c(s);const{tilt:o,mode:l}=it(e,n,i,a);return tt(e,t,o,r,i,a,l,s)}return at(l,i)}function nt(e,t,n,r,i,a){const o=function(e,t,n,r,i,a){let o=0;return a===Le.ADJUST&&function(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>He)return!0;const i=e.renderSpatialReference,a=Oe(e),o=A(t,i,a),s=A(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a);if(null==o||null==s)return!1;const c=Math.tan(.5*e.state.camera.fov)*r;return s.distance(o)/c>Ae}(e,r,i)?(t=0,o=function(e,t,n,r){const i=pt(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);const o=a.min*(1-ft)+a.max*ft;return Math.min(i,o)}(e,i,n,r)):o=pt(e,r,i,n),o=e.state.constraints.clampTilt(i,o),{heading:t,tilt:n=mt(e,r,i,o)}}(e,t,n,r,i=Math.max(i,e.state.constraints.minimumPoiDistance),a);return(0,ke(e).eyeForCenterWithHeadingTilt)(r,i,o.heading,o.tilt)}function rt(e,t,n){const r=e.map.ground.navigationConstraint;return n===Le.ADJUST&&"global"===e.viewingMode&&t>0&&(null==r||"stay-above"===r.type)}function it(e,t,n,r){const i=mt(e,n,r,function(e,t,n,r){let i=pt(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);return i=Math.min(i,.5*Math.PI),a.min*(1-ft)+i*ft}(e,r,t,n));return{tilt:i,mode:t-i<1?Le.LOCKED:Le.ADJUST}}function at(e,t){return{...e,center:x(t)}}function ot(e,t){const{state:n,spatialReference:r}=e,i=t.spatialReference;return n.isGlobal&&X(i,D.Global)||n.isLocal&&r.equals(i)}function st(e,t){let n,r,i;if(e.state.isGlobal){const e=new j(t.xmin,t.ymin,t.spatialReference),a=new j(t.xmax,t.ymax,t.spatialReference),o=t.spatialReference.isGeographic?Ie:qe;n=new j({x:o.center(e.x,a.x),y:(a.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const s=b(t.spatialReference),c=V(n,e,a);r=c.lon,i=c.lat,o.diff(e.x,a.x)>o.range/2&&(r+=s.halfCircumference),r=Math.min(r,s.halfCircumference),i=Math.min(i,s.halfCircumference)}else{const a=e.renderSpatialReference??t.spatialReference;a.equals(t.spatialReference)||(t=C(t,a)),r=t.xmax-t.xmin,i=t.ymax-t.ymin;const o=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new j({x:t.xmin+.5*r,y:t.ymin+.5*i,z:o,spatialReference:a})}const a=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,o=e.state.camera,s=1/Math.tan(o.fovX/2),c=1/Math.tan(o.fovY/2),l=1/Math.tan(o.fov/2);return{center:n,distance:Math.max(.5*r*s,.5*i*c,.5*a*l)/Pe}}async function ct(e,t,n,r,i,a){const o=ot(e,t)?t:await S(t,e.spatialReference,{signal:a});c(a);const{center:s,distance:l}=st(e,o),u=await $e(e,n,r,s,l,i,a);return c(a),ht(e,u,e.camera.fov,a)}function lt(e,t,n,r,i,a){let o;try{o=ot(e,t)?t:C(t,e.spatialReference)}catch(e){return null}const{center:s,distance:c}=st(e,o),l=Qe(e,n,r,s,c,i);return null==l?null:dt(e,l,e.camera.fov,a)}function ut(e,t,n){const r=e.renderSpatialReference,i=A(n,r,Oe(e));if(null==i)return null;const a=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),s=T(t.eye,n),c=2*s*a*Pe,l=2*s*o*Pe;return"global"===e.viewingMode?be(e,i,c,l):pe(e,i,c,l)}const ft=.7;function mt(e,t,n,r){return ke(e).lookAtTiltToEyeTilt(r,t,n)}function pt(e,t,n,r){return ke(e).eyeTiltToLookAtTilt(r,t,n)}function dt(t,n,r,i){if(null==n)return null;const a=t.renderSpatialReference,o=A(n.eye,a,Oe(t));return null==o?null:(i??=new e,i.position=o,i.heading=n.heading,i.tilt=n.tilt,i.fov=r,i)}async function ht(t,n,r,i){const a=t.renderSpatialReference,o=await K(n.eye,a,Oe(t),{signal:i});return c(i),new e(o,n.heading,n.tilt,r)}function yt(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);Se.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function gt(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);Se.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Mt(e,t){return E(t.center,e.renderSpatialReference,De,z.WGS84),Xe(e,t.distance,De[1])}export{Le as O,Fe as a,yt as b,B as c,Xe as d,Y as e,lt as f,Qe as g,Je as h,Ve as i,We as j,ae as k,Be as l,Oe as m,ct as n,Ye as o,Ze as p,Mt as q,Ke as r,Z as s,ut as t,gt as z};
