/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Evented.js";import{s}from"./ensureType.js";import{c as r,f as i,d as a}from"./maybe.js";import{P as n}from"./PooledArray.js";import{watch as o,syncAndInitial as h,on as l}from"../core/reactiveUtils.js";import c,{g as d,s as u}from"../core/Accessor.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import{h as p,o as g,C as f}from"./typedArrayUtil.js";import{subclass as _}from"../core/accessorSupport/decorators/subclass.js";import{p as y,m as v,i as w,q as x,t as R,u as b,d as C,j as T}from"./mat4.js";import{b as S,e as O,c as M,E as A,t as E,s as D}from"./vec3.js";import{f as I,c as P}from"./vec3f64.js";import{V as L}from"./ViewingMode.js";import{d as j}from"./FloatsPassUniform.js";import{O as H,a as V,b as N}from"./OverlayCompositing.glsl.js";import{c as W,o as G,k as F,l as U,w as B,m as q}from"./aaBoundingRect.js";import{C as z,S as k,D as Q,M as Y,A as X}from"./SceneLighting.js";import{S as Z}from"./ShaderOutput.js";import{a as $,f as J}from"./vec4f64.js";import{V as K,a as ee}from"./VertexNormal.glsl.js";import{P as te,a as se,b as re}from"./EvaluateAmbientLighting.glsl.js";import{W as ie,C as ae,a as ne}from"./WaterSurface.glsl.js";import{U as oe,B as he}from"./ShaderBuilder.js";import{F as le}from"./FloatPassUniform.js";import{g as ce}from"./interfaces3.js";import{T as de}from"./Texture2DPassUniform.js";import{T as ue,a as me}from"./TextureOnly.glsl.js";import{N as pe}from"./NestedMap.js";import{S as ge,p as fe}from"./ShaderTechniqueConfiguration.js";import{S as _e,a as ye}from"./RenderPlugin.js";import{C as ve}from"./Camera.js";import{L as we}from"./Logger.js";import{a as xe,l as Re,v as be,b as Ce,s as Te}from"./Util.js";import{D as Se,R as Oe,A as Me,M as Ae}from"./Material.js";import{V as Ee}from"./VertexAttribute.js";import{D as De,c as Ie,U as Pe,a as Le,i as je,f as He}from"./enums3.js";import{V as Ve}from"./VertexElementDescriptor.js";import{V as Ne}from"./VertexArrayObject2.js";import{B as We}from"./BufferObject.js";import{T as Ge,a as Fe}from"./Texture.js";import{p as Ue}from"./projectBuffer.js";import{A as Be}from"./Attribute.js";import{C as qe}from"./ContentObject.js";import{G as ze}from"./Geometry.js";import{R as ke,W as Qe,O as Ye,T as Xe,U as Ze}from"./TriangleMaterial.js";import{M as $e,s as Je}from"./time.js";import{a as Ke,I as et}from"./mat4f64.js";import{c as tt,f as st}from"./vec2f64.js";import{M as rt,H as it}from"./MultipassGeometryTest.glsl.js";import{M as at}from"./ColorConversion.glsl.js";import{D as nt,R as ot}from"./basicInterfaces.js";import{R as ht}from"./RenderSlot.js";import{T as lt}from"./TransparencyPassType.js";import{c as ct,l as dt,b as ut,n as mt}from"./mathUtils.js";import{a as pt}from"./mat3f64.js";import{f as gt,i as ft,j as _t,l as yt,s as vt,a as wt,d as xt,k as Rt,n as bt,o as Ct}from"./vec2.js";import{s as Tt,t as St}from"./vec4.js";import{a as Ot,D as Mt}from"./Texture2.js";import{O as At}from"./Intersector.js";import{S as Et,n as Dt,I as It}from"./Intersector2.js";import{g as Pt}from"./glUtil.js";import{c as Lt,o as jt,a as Ht,b as Vt,g as Nt,d as Wt}from"./OrderIndependentTransparency.js";import{G as Gt,D as Ft}from"./DefaultBufferWriter.js";import{a as Ut,P as Bt}from"./DefaultLayouts.js";import{R as qt,S as zt,P as kt}from"./Program2.js";import{m as Qt,d as Yt,a as Xt,s as Zt,b as $t}from"./renderState2.js";import{m as Jt}from"./MemCache.js";import{T as Kt,n as es}from"./Scheduler.js";import{N as ts,c as ss}from"./sphere.js";import{b as rs}from"./mathUtils2.js";var is,as,ns,os,hs,ls,cs,ds;!function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(is||(is={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(as||(as={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(ns||(ns={})),function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(os||(os={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(hs||(hs={}));class us{constructor(e,t){this.vec3=e,this.id=t}}function ms(e,t,s,r){return new us(I(e,t,s),r)}class ps{constructor(){this._extent=W(),this.resolution=0,this.renderLocalOrigin=ms(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new gs}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];G(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];G(this._extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,F(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class gs{constructor(){this.extents=[W(),W(),W()],this.numViews=0}}!function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(ls||(ls={}));class fs{constructor(e,t){this._fbos=e,this._format=t}get valid(){return null!=this._handle}dispose(){this._handle=r(this._handle)}get texture(){return this._handle?.colorTexture}bind(e,t,s){this._handle&&this._handle.fbo.width===t&&this._handle.fbo.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(this._format,t,s)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.colorTexture?.descriptor?.hasMipmap&&this._handle?.colorTexture?.generateMipmap()}}class _s{constructor(e,t,s,r=z.RGBA_MIPMAP){this.output=t,this.content=s,this.fbo=new fs(e,r)}get valid(){return this.fbo.valid}}class ys{constructor(e){this.targets=[new _s(e,Z.Color,ls.Color),new _s(e,Z.Color,ls.ColorNoRasterImage),new _s(e,Z.Highlight,ls.Highlight,z.RGBA4),new _s(e,Z.Normal,ls.WaterNormal),new _s(e,Z.Color,ls.Occluded)],p("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new _s(e,Z.ObjectAndLayerIdColor,ls.ObjectAndLayerIdColor))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,s)=>t.valid?e|=1<<s:e),0)}}class vs extends K{constructor(){super(...arguments),this.slicePlaneLocalOrigin=P(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}}!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}(cs||(cs={}));class ws extends vs{constructor(){super(...arguments),this.identifier=cs.Material,this.output=Z.Color,this.transparent=!1}}class xs extends vs{constructor(){super(...arguments),this.identifier=cs.ShadowMap}}class Rs extends vs{constructor(){super(...arguments),this.identifier=cs.Highlight}}class bs extends oe{constructor(e,t){super(e,"vec4",he.Draw,((s,r,i)=>s.setUniform4fv(e,t(r,i))))}}function Cs(e,t){const{vertex:s,fragment:r}=e;s.uniforms.add(new bs("overlayTexOffset",((e,t)=>function(e,t){const s=t.overlay?.overlays[H.INNER]?.extent;U(s)&&(As[0]=e.toMapSpace[0]/B(s)-s[0]/B(s),As[1]=e.toMapSpace[1]/q(s)-s[1]/q(s));const r=t.overlay?.overlays[H.OUTER]?.extent;return U(r)&&(As[2]=e.toMapSpace[0]/B(r)-r[0]/B(r),As[3]=e.toMapSpace[1]/q(r)-r[1]/q(r)),As}(e,t))),new bs("overlayTexScale",((e,t)=>function(e,t){const s=t.overlay?.overlays[H.INNER]?.extent;U(s)&&(As[0]=e.toMapSpace[2]/B(s),As[1]=e.toMapSpace[3]/q(s));const r=t.overlay?.overlays[H.OUTER]?.extent;return U(r)&&(As[2]=e.toMapSpace[2]/B(r),As[3]=e.toMapSpace[3]/q(r)),As}(e,t)))),r.constants.add("overlayOpacity","float",1),r.uniforms.add(new de("ovColorTex",((e,t)=>Ms(e,t)))),Os(e,t)}function Ts(e,t){const{vertex:s,fragment:r}=e;s.uniforms.add(new Ss("overlayTexOffset"),new Ss("overlayTexScale")),r.uniforms.add(new le("overlayOpacity",(e=>e.overlayOpacity)),new de("ovColorTex",((e,t)=>t.overlay?.getTexture(e.overlayContent)))),Os(e,t)}!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(ds||(ds={}));class Ss extends oe{constructor(e){super(e,"vec4")}}function Os(e,t){t.pbrMode!==te.Water&&t.pbrMode!==te.WaterOnIntegratedMesh&&t.pbrMode!==te.TerrainWithWater||e.include(ie,t);const{vertex:s,fragment:r}=e;e.varyings.add("vtcOverlay","vec4"),s.code.add(ce`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),r.code.add(ce`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),r.code.add(ce`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),r.code.add(ce`vec4 getOverlayColorTexel(vec4 texCoords) {
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),t.pbrMode!==te.Water&&t.pbrMode!==te.WaterOnIntegratedMesh&&t.pbrMode!==te.TerrainWithWater||(se(r),re(r),r.code.add(ce`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function Ms(e,t){return e.identifier===cs.Material&&e.output===Z.Color?t.overlay?.getTexture(ls.ColorNoRasterImage):e.identifier===cs.Material&&e.output===Z.ObjectAndLayerIdColor?t.overlay?.getTexture(ls.ObjectAndLayerIdColor):e.identifier===cs.Highlight?t.overlay?.getTexture(ls.Highlight):null}const As=$();class Es{constructor(e){this._context=e,this._perConstructorInstances=new pe,this._frameCounter=0,this._keepAliveFrameCount=Is}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=Ps){const s=t.key;let r=this._perConstructorInstances.get(e,s);if(null==r){const i=new e(this._context,t,(()=>this.release(i)));r=new Ds(i),this._perConstructorInstances.set(e,s,r)}return++r.refCount,r.technique}releaseAndAcquire(e,t,s){if(null!=s){if(t.key===s.key)return s;this.release(s)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Is&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,s)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,s))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,s)=>{e.push((async(e,t)=>{const s=t.shader;s&&(await s.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,s))})),await Promise.all(e)}}class Ds{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const Is=-1,Ps=new ge;class Ls{constructor(e,t,s,r){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=s,this.requestRender=r,this._id2glMaterialRef=new pe}dispose(){this._textureRepository.destroy()}acquire(e,t,s){if(this._ownMaterial(e),!e.produces(t,s))return null;let r=this._id2glMaterialRef.get(s,e.id);if(null==r){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRepository:this._textureRepository,output:s});r=new js(t),this._id2glMaterialRef.set(s,e.id,r)}return r.ref(),r.glMaterial}release(e,t){const s=this._id2glMaterialRef.get(t,e.id);null!=s&&(s.unref(),s.referenced||(i(s.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&we.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class js{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,xe(this._refCnt>=0)}get referenced(){return this._refCnt>0}}new Ve(Ee.POSITION,3,De.FLOAT,0,12),new Ve(Ee.POSITION,3,De.FLOAT,0,20),new Ve(Ee.UV0,2,De.FLOAT,12,20),new Ve(Ee.POSITION,3,De.FLOAT,0,32),new Ve(Ee.NORMAL,3,De.FLOAT,12,32),new Ve(Ee.UV0,2,De.FLOAT,24,32),new Ve(Ee.POSITION,3,De.FLOAT,0,16),new Ve(Ee.COLOR,4,De.UNSIGNED_BYTE,12,16);const Hs=[new Ve(Ee.POSITION,2,De.FLOAT,0,8)],Vs=[new Ve(Ee.POSITION,2,De.FLOAT,0,16),new Ve(Ee.UV0,2,De.FLOAT,8,16)];function Ns(e,t=Hs,s=Se,r=-1,i=1){let a=null;return a=t===Vs?new Float32Array([r,r,0,0,i,r,1,0,r,i,0,1,i,i,1,1]):new Float32Array([r,r,i,r,r,i,i,i]),new Ne(e,s,{geometry:t},{geometry:We.createVertex(e,Pe.STATIC_DRAW,a)})}function Ws(e,t=Hs,s=Se){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new Ne(e,s,{geometry:t},{geometry:We.createVertex(e,Pe.STATIC_DRAW,r)})}function Gs(e){const t=new Ge(4);return t.samplingMode=Ie.NEAREST,new Fe(e,t)}class Fs{constructor(e){this._originSR=e,this._rootOriginId="root/"+d(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=ms(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,t),t}const s=this._gridSize,r=Math.round(e[0]/s),i=Math.round(e[1]/s),a=Math.round(e[2]/s),n=`${r}/${i}/${a}`;let o=this._origins.get(n);const h=.5*s;if(S(Us,e,t.vec3),Us[0]=Math.abs(Us[0]),Us[1]=Math.abs(Us[1]),Us[2]=Math.abs(Us[2]),Us[0]<h&&Us[1]<h&&Us[2]<h){if(o){const t=Math.max(...Us);if(S(Us,e,o.vec3),Us[0]=Math.abs(Us[0]),Us[1]=Math.abs(Us[1]),Us[2]=Math.abs(Us[2]),Math.max(...Us)<t)return o}return t}return o||(o=ms(r*s,i*s,a*s,n),this._origins.set(n,o)),o}_drawOriginBox(e,t=J(1,1,0,1)){const s=window.view,r=s._stage,i=t.toString();if(!this._objects.has(i)){this._material=new ke({width:2,color:t}),r.add(this._material);const e=new Qe(r,{pickable:!1}),s=new Ye({castShadow:!1});r.add(s),e.add(s),this._objects.set(i,s)}const a=this._objects.get(i),n=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=n.length,h=new Array(3*o),l=new Array,c=.5*this._gridSize;for(let t=0;t<o;t++)h[3*t]=e[0]+(1&n[t]?c:-c),h[3*t+1]=e[1]+(2&n[t]?c:-c),h[3*t+2]=e[2]+(4&n[t]?c:-c),t>0&&l.push(t-1,t);Ue(h,this._originSR,0,h,s.renderSpatialReference,0,o);const d=new ze(this._material,[[Ee.POSITION,new Be(h,l,3,!0)]],null,qe.Line);r.add(d),a.addGeometry(d)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}}const Us=P();class Bs{constructor(e,t){this.shadowMap=e,this.slicePlane=t,this.slot=ht.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=lt.NONE,this.alignPixelEnabled=!1,this.decorations=nt.ON,this.overlayStretch=1,this._camera=new ve,this._inverseViewport=tt(),this.oldLighting=new k,this.newLighting=new k,this._fadedLighting=new k,this._lighting=this.newLighting,this.ssr=new qs,this.multipassEnabled=!1,this.multipassTerrain=new at,this.multipassGeometry=new rt,this.hudRenderStyle=it.Occluded,this.cloudsFade=new ae}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:s}=this;e>=1?this._lighting=s:(this._fadedLighting.lerpLighting(t,s,e),this._lighting=this._fadedLighting)}}class qs{constructor(){this.fadeFactor=1,this.reprojectionMatrix=Ke()}}class zs{constructor(e,t,s=null){this.rctx=e,this.sliceHelper=s,this.lastFrameCamera=new ve,this.output=Z.Color,this.renderOccludedMask=Qs,this.bindParameters=new Bs(t,null!=s?s.plane:null),this.bindParameters.alignPixelEnabled=!0}resetRenderOccludedMask(){this.renderOccludedMask=Qs}}class ks extends zs{constructor(e,t,s,r){super(e,s,r),this.offscreenRenderingHelper=t,this.sliceHelper=r,this.time=$e(0)}}const Qs=Oe.Occlude|Oe.OccludeAndTransparent|Oe.OccludeAndTransparentStencil;let Ys=class extends ve{constructor(){super(...arguments),this._projectionMatrix=Ke()}get projectionMatrix(){return this._projectionMatrix}};var Xs;e([m()],Ys.prototype,"_projectionMatrix",void 0),e([m({readOnly:!0})],Ys.prototype,"projectionMatrix",null),Ys=e([_("esri.views.3d.webgl-engine.lib.CascadeCamera")],Ys),function(e){e[e.Highlight=0]="Highlight",e[e.Default=1]="Default"}(Xs||(Xs={}));class Zs{constructor(){this.camera=new Ys,this.lightMat=Ke()}}class $s{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class Js{get depthTexture(){return this._handle?.colorTexture}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Tt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,t){this._fbos=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new $s,this._projectionView=Ke(),this._projectionViewInverse=Ke(),this._modelViewLight=Ke(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=$(),this._cascades=[new Zs,new Zs,new Zs,new Zs],this._lastOrigin=null,this._maxTextureWidth=Math.min(p("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=r(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=ct(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)hr[e]=this._cascades[e];return hr.length=this._numCascades,hr}start(e,t,s,r,i){xe(this.enabled);const{near:a,far:n}=this._clampNearFar(s);this._computeCascadeDistances(a,n,r),this._textureHeight=this._computeTextureHeight(e,i,r),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:h}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,h,o,t);this._lastOrigin=null,this.clear()}finish(){xe(this.enabled),this._handle?.releaseDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!O(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||P(),M(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){y(lr,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)cr[16*t+e]=lr[e]}}return cr}moveSnapshot(e){xe(this.enabled),this._handle?.releaseDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null}copySnapshot(e){const t=this._handle?.colorTexture?.descriptor;if(!this.enabled||!t)return;this._snapshots[e]?.release();const{width:s,height:r}=t;this._snapshots[e]=this._fbos.acquire(z.RGBA4,s,r);const i=this._fbos.rctx;this._bindFbo();const a=i.bindTexture(this._snapshots[e]?.colorTexture,Fe.TEXTURE_UNIT_FOR_UPDATES);i.gl.copyTexSubImage2D(Le.TEXTURE_2D,0,0,0,0,0,s,r),i.bindTexture(a,Fe.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.colorTexture:null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(je.COLOR_BUFFER_BIT|je.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,t,s){const r=Math.min(window.devicePixelRatio,t)/e.pixelRatio,i=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,a=Ot(Math.floor(Math.max(e.fullWidth,e.fullHeight)*r*i));return Math.min(this._maxTextureWidth,this._numCascades*a)/this._numCascades}_ensureFbo(){this._handle?.fbo.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(z.RGBA4,this._textureWidth,this._textureHeight)),this._handle.acquireDepth(Q.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=r(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,s,r){const i=this._cascades[e],a=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),h=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);xe(o<h);for(let e=0;e<8;++e){Tt(er,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:h,1);const t=tr[e];St(t,er,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}A(or,tr[0]),i.camera.viewMatrix=y(Ks,this._modelViewLight,or);for(let e=0;e<8;++e)E(tr[e],tr[e],i.camera.viewMatrix);let l=tr[0][2],c=tr[0][2];for(let e=1;e<8;++e)l=Math.min(l,tr[e][2]),c=Math.max(c,tr[e][2]);l-=200,c+=200,i.camera.near=-c,i.camera.far=-l,function(e,t,s,r,i){const a=1/tr[0][3],n=1/tr[4][3];xe(a<n);let o=a+Math.sqrt(a*n);const h=Math.sin(ut(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=h,function(e,t,s,r,i,a,n,o){gt(dr,0,0);for(let t=0;t<4;++t)ft(dr,dr,e[t]);_t(dr,dr,.25),gt(ur,0,0);for(let t=4;t<8;++t)ft(ur,ur,e[t]);_t(ur,ur,.25),yt(mr[0],e[4],e[5],.5),yt(mr[1],e[5],e[6],.5),yt(mr[2],e[6],e[7],.5),yt(mr[3],e[7],e[4],.5);let h=0,l=vt(mr[0],dr);for(let e=1;e<4;++e){const t=vt(mr[e],dr);t<l&&(l=t,h=e)}wt(pr,mr[h],e[h+4]);const c=pr[0];let d,u;pr[0]=-pr[1],pr[1]=c,wt(gr,ur,dr),xt(gr,pr)<0&&Rt(pr,pr),yt(pr,pr,gr,s),bt(pr,pr),d=u=xt(wt(fr,e[0],dr),pr);for(let t=1;t<8;++t){const s=xt(wt(fr,e[t],dr),pr);s<d?d=s:s>u&&(u=s)}Ct(r,dr),_t(fr,pr,d-t),ft(r,r,fr);let m=-1,p=1,g=0,f=0;for(let t=0;t<8;++t){wt(_r,e[t],r),bt(_r,_r);const s=pr[0]*_r[1]-pr[1]*_r[0];s>0?s>m&&(m=s,g=t):s<p&&(p=s,f=t)}be(m>0,"leftArea"),be(p<0,"rightArea"),_t(yr,pr,d),ft(yr,yr,dr),_t(vr,pr,u),ft(vr,vr,dr),wr[0]=-pr[1],wr[1]=pr[0];const _=Ce(r,e[f],vr,ft(fr,vr,wr),1,i),y=Ce(r,e[g],vr,fr,1,a),v=Ce(r,e[g],yr,ft(fr,yr,wr),1,n),w=Ce(r,e[f],yr,fr,1,o);be(_,"rayRay"),be(y,"rayRay"),be(v,"rayRay"),be(w,"rayRay")}(tr,o,h,sr,rr,ir,ar,nr),function(e,t,s,r,i){wt(Cr,s,r),_t(Cr,Cr,.5),Tr[0]=Cr[0],Tr[1]=Cr[1],Tr[2]=0,Tr[3]=Cr[1],Tr[4]=-Cr[0],Tr[5]=0,Tr[6]=Cr[0]*Cr[0]+Cr[1]*Cr[1],Tr[7]=Cr[0]*Cr[1]-Cr[1]*Cr[0],Tr[8]=1,Tr[xr(0,2)]=-xt(br(Tr,0),e),Tr[xr(1,2)]=-xt(br(Tr,1),e);let a=xt(br(Tr,0),s)+Tr[xr(0,2)],n=xt(br(Tr,1),s)+Tr[xr(1,2)],o=xt(br(Tr,0),r)+Tr[xr(0,2)],h=xt(br(Tr,1),r)+Tr[xr(1,2)];a=-(a+o)/(n+h),Tr[xr(0,0)]+=Tr[xr(1,0)]*a,Tr[xr(0,1)]+=Tr[xr(1,1)]*a,Tr[xr(0,2)]+=Tr[xr(1,2)]*a,a=1/(xt(br(Tr,0),s)+Tr[xr(0,2)]),n=1/(xt(br(Tr,1),s)+Tr[xr(1,2)]),Tr[xr(0,0)]*=a,Tr[xr(0,1)]*=a,Tr[xr(0,2)]*=a,Tr[xr(1,0)]*=n,Tr[xr(1,1)]*=n,Tr[xr(1,2)]*=n,Tr[xr(2,0)]=Tr[xr(1,0)],Tr[xr(2,1)]=Tr[xr(1,1)],Tr[xr(2,2)]=Tr[xr(1,2)],Tr[xr(1,2)]+=1,a=xt(br(Tr,1),t)+Tr[xr(1,2)],n=xt(br(Tr,2),t)+Tr[xr(2,2)],o=xt(br(Tr,1),s)+Tr[xr(1,2)],h=xt(br(Tr,2),s)+Tr[xr(2,2)],a=-.5*(a/n+o/h),Tr[xr(1,0)]+=Tr[xr(2,0)]*a,Tr[xr(1,1)]+=Tr[xr(2,1)]*a,Tr[xr(1,2)]+=Tr[xr(2,2)]*a,a=xt(br(Tr,1),t)+Tr[xr(1,2)],n=xt(br(Tr,2),t)+Tr[xr(2,2)],o=-n/a,Tr[xr(1,0)]*=o,Tr[xr(1,1)]*=o,Tr[xr(1,2)]*=o,i[0]=Tr[0],i[1]=Tr[1],i[2]=0,i[3]=Tr[2],i[4]=Tr[3],i[5]=Tr[4],i[6]=0,i[7]=Tr[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Tr[6],i[13]=Tr[7],i[14]=0,i[15]=Tr[8]}(sr,rr,ar,nr,i.projectionMatrix),i.projectionMatrix[10]=2/(s-r),i.projectionMatrix[14]=-(s+r)/(s-r)}(s,r,l,c,i.camera),v(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const d=this._textureHeight;i.camera.viewport=[e*d,0,d,d]}_setupMatrices(e,t){v(this._projectionView,e.projectionMatrix,e.viewMatrix),w(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===L.Global?e.eye:D(or,0,0,1);x(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],s)}_clampNearFar(e){let{near:t,far:s}=e;return t<2&&(t=2),s<2&&(s=2),t>=s&&(t=2,s=4),{near:t,far:s}}_computeCascadeDistances(e,t,s){const r=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Re(t/e,4)),r);const i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades);let n=e,o=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=dt(n,o,this.settings.splitSchemeLambda),n*=a,o+=i}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const Ks=Ke(),er=$(),tr=[];for(let e=0;e<8;++e)tr.push($());const sr=tt(),rr=tt(),ir=tt(),ar=tt(),nr=tt(),or=P(),hr=[],lr=Ke(),cr=et.concat(et,et,et,et),dr=tt(),ur=tt(),mr=[tt(),tt(),tt(),tt()],pr=tt(),gr=tt(),fr=tt(),_r=tt(),yr=tt(),vr=tt(),wr=tt();function xr(e,t){return 3*t+e}const Rr=tt();function br(e,t){return gt(Rr,e[t],e[t+3]),Rr}const Cr=tt(),Tr=pt();class Sr{constructor(){this.adds=new n,this.removes=new n,this.updates=new n({allocator:e=>e||new Or,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class Or{}class Mr{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function Ar(e){const t=new Map,s=e=>{let s=t.get(e);return s||(s=new Mr,t.set(e,s)),s};return e.removes.forAll((e=>{Er(e)&&s(e.material).removes.push(e)})),e.adds.forAll((e=>{Er(e)&&s(e.material).adds.push(e)})),e.updates.forAll((e=>{Er(e.renderGeometry)&&s(e.renderGeometry.material).updates.push(e)})),t}function Er(e){return e.geometry.indexCount>=1}class Dr{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,s){if(!this._material.produces(t,s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,t,s));const r=this._map.get(s);if(null!=r){if(r.ensureResources(e)===ot.LOADED)return r;this._repository.requestRender()}return null}}class Ir extends ee{constructor(e=P()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}class Pr extends zt{initializeConfiguration(e,t){t.spherical=e.viewingMode===L.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new kt(e.rctx,Pr.shader.get().build(this.configuration),Se)}_setPipelineState(e){const t=this.configuration,s=e===lt.NONE,r=e===lt.FrontFace;return Qt({blending:t.output!==Z.Normal&&t.output!==Z.Highlight&&t.output!==Z.ObjectAndLayerIdColor&&t.transparent?s?Lt:jt(e):null,depthTest:{func:Ht(e)},depthWrite:s?t.writeDepth?Yt:null:Vt(e),colorWrite:Xt,polygonOffset:s||r?null:Nt(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}Pr.shader=new qt(ne,(()=>import("./WaterSurface.glsl.js").then((e=>e.a))));class Lr extends Mt{constructor(){super(...arguments),this.output=Z.Color,this.transparencyPassType=lt.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.isDraped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}}e([fe({count:Z.COUNT})],Lr.prototype,"output",void 0),e([fe({count:lt.COUNT})],Lr.prototype,"transparencyPassType",void 0),e([fe()],Lr.prototype,"spherical",void 0),e([fe()],Lr.prototype,"receiveShadows",void 0),e([fe()],Lr.prototype,"hasSlicePlane",void 0),e([fe()],Lr.prototype,"transparent",void 0),e([fe()],Lr.prototype,"enableOffset",void 0),e([fe()],Lr.prototype,"writeDepth",void 0),e([fe()],Lr.prototype,"hasScreenSpaceReflections",void 0),e([fe()],Lr.prototype,"doublePrecisionRequiresObfuscation",void 0),e([fe()],Lr.prototype,"hasCloudsReflections",void 0),e([fe()],Lr.prototype,"objectAndLayerIdColorInstanced",void 0),e([fe()],Lr.prototype,"isDraped",void 0),e([fe()],Lr.prototype,"multipassEnabled",void 0),e([fe()],Lr.prototype,"cullAboveGround",void 0),e([fe({constValue:!1})],Lr.prototype,"occlusionPass",void 0),e([fe({constValue:te.Water})],Lr.prototype,"pbrMode",void 0),e([fe({constValue:!0})],Lr.prototype,"useCustomDTRExponentForWater",void 0),e([fe({constValue:!0})],Lr.prototype,"highStepCount",void 0),e([fe({constValue:!1})],Lr.prototype,"useFillLights",void 0);class jr extends Gt{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){const t=null!=e.ssr.lastFrameColor;t!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:t})}_updateCloudsReflectionState(e){const t=null!=e.cloudsFade.data;t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===Z.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(Pr,e)}}class Hr extends Xe{constructor(e){super(e,new Vr),this._configuration=new Lr,this._animation=new Me}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Wt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Nr;const s=this._animation.advance(e);return this.setParameters({timeElapsed:Je(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&s}produces(e,t){switch(t){case Z.Normal:return e===ht.DRAPED_WATER;case Z.Color:if(this.parameters.isDraped)return e===ht.DRAPED_MATERIAL;break;case Z.Alpha:break;case Z.Highlight:case Z.ObjectAndLayerIdColor:return e===ht.OPAQUE_MATERIAL||e===ht.DRAPED_MATERIAL;default:return!1}let s=ht.OPAQUE_MATERIAL;return this.parameters.transparent&&(s=this.parameters.writeDepth?ht.TRANSPARENT_MATERIAL:ht.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===s}createGLMaterial(e){return new jr(e)}createBufferWriter(){return new Ft(p("enable-feature:objectAndLayerId-rendering")?Ut:Bt)}get test(){return{animationEnabled:this._animation.enabled}}}class Vr extends Ae{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=st(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=J(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=P(),this.modelTransformation=null}}const Nr=35e3;class Wr{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function Gr(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let s=!0;for(;s;)s=!1,e.forEach((r=>{const i=t.get(r.to);i&&(r.to=i.to,t.delete(i.from),e.removeUnordered(i),s=!0)}))}class Fr extends Wr{constructor(e,t,s){super(t,s),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class Ur{constructor(){this.first=0,this.count=0}}class Br{constructor(){this._numElements=0,this._instances=new Map,this.holes=new n({allocator:e=>e||new Wr,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=qr(),this.drawCommandsHighlight=qr(),this.drawCommandsOccludees=qr(),this.drawCommandsShadowHighlightRest=qr()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,s){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=s,this._numElements+=r.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),s=this.holes.front();return null!=this.vao&&1===this.holes.length&&s.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=s.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const e of t)e.isVisible&&(zr(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e),zr(e.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,e))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function qr(){return new n({allocator:e=>e||new Ur,deallocator:e=>e})}function zr(e,t){const s=e.back();if(null==s){const s=e.pushNew();return s.first=t.from,void(s.count=t.numElements)}if(i=t,(r=s).first+r.count>=i.from){const e=t.from-s.first+t.numElements;s.count=e}else{const s=e.pushNew();s.first=t.from,s.count=t.numElements}var r,i}class kr{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}const Qr=Jt+1;class Yr{constructor(e,t,s){this._rctx=e,this._locations=t,this._layout=s,this._cache=new Y(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let s=this._cache.pop(t);return s||(s=new Ne(this._rctx,this._locations,{geometry:this._layout},{geometry:We.createVertex(this._rctx,Pe.STATIC_DRAW)}),s.vertexBuffers.geometry.setSize(e),s)}deleteVao(e){if(null==e)return;const t=e.byteSize.toString();this._cache.put(t,e,Qr)}}let Xr=class extends _e{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this.priority=0,this.produces=new Map}dispose(){this._glMaterials=i(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=i(this._vaoCache)}initializeRenderContext(e,t){const{rctx:s}=e.renderContext;this._glMaterials=new Dr(this.material,t??e.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new Yr(s,this.material.vertexAttributeLocations,Pt(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof Hr}get isDecoration(){return this.material.parameters.isDecoration}get rendersOccluded(){return!this.isEmpty&&this.material.parameters.renderOccluded!==Oe.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const s=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,i=this._dataByOrigin.get(e.localOrigin.id),a=i?.findBuffer(e.id);if(null==a)return;const n=a.instances.get(e.id);if(r.updateType&(hs.GEOMETRY|hs.TRANSFORMATION)){const r=hi(t.elementCount(n.geometry.geometry)*s),i=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,i,0),a.vao.vertexBuffers.geometry.setSubData(r,n.from*s,0,n.numElements*s)}r.updateType&(hs.HIGHLIGHT|hs.OCCLUDEE|hs.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,t){const s=new pe;for(const t of e){const e=t.localOrigin;if(null==e)continue;let r=s.get(e.id,null);null==r&&(r=new Zr(e.vec3),s.set(e.id,null,r)),r.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const r=this._dataByOrigin.get(t.id),i=r?.findBuffer(e.id);if(null==i)continue;let a=s.get(t.id,i);null==a&&(a=new Zr(t.vec3),s.set(t.id,i,a)),a.changes.push(e)}return s}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:s,_dataByOrigin:r}=this,i=s.vertexBufferLayout.stride/4,a=this._computeDeltas(e,t);a.forEach(((e,t)=>{const n=e.get(null),o=null!=n?n.changes:[];a.delete(t,null);let h=r.get(t);if(e.forEach(((e,n)=>{if(a.delete(t,n),null==n)return void xe(!1,"No VAO for removed geometries");if(n.instances.size===e.changes.length)return this._vaoCache.deleteVao(n.vao),g(h.buffers,n),void(0===h.buffers.length&&0===o.length&&r.delete(t));const l=n.numElements,c=n.vao.byteSize/4,d=o.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),u=e.changes.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),m=Math.min((l+d-u)*i,ni),p=m>c;m>si&&m<c/2?(e.changes.forEach((({id:e})=>n.deleteInstance(e))),n.instances.forEach((({geometry:e})=>o.push(e))),this._vaoCache.deleteVao(n.vao),g(h.buffers,n)):p?this._applyAndRebuild(n,o,e):this._applyRemoves(n,e)})),o.length>0)for(null==h&&(h=new kr(n.origin),r.set(t,h)),h.buffers.forEach((e=>this._applyAdds(e,o)));o.length>0;)h.buffers.push(this._applyAndRebuild(new Br,o,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,s(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,s){if(null!=s)for(const t of s.changes)e.deleteInstance(t.id);const r=this._bufferWriter,i=r.vertexBufferLayout.stride,a=i/4,n=Math.floor(ni/a);let o=e.numElements;for(;t.length>0;){const s=t.pop(),i=r.elementCount(s.geometry);if(o+i>n&&o>0){t.push(s);break}o+=i;const a=new Fr(s,0,0);xe(null==e.instances.get(s.id)),e.addInstance(s.id,a)}const h=o*a,l=hi(h),c=r.vertexBufferLayout.createView(l.buffer);let d=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,s)=>{this._writeGeometry(t.geometry,c,d);const i=d;d+=r.elementCount(t.geometry.geometry),e.updateInstance(s,i,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(li(h)),e.vao.vertexBuffers.geometry.setSubData(l,0,0,d*a),e.holes.clear();const u=e.holes.pushNew();return u.from=d,u.to=Math.floor(e.vao.byteSize/i),e.updateDrawCommands(i),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const s of t.changes){const t=s.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const i=ti.back();if(i){if(i.to===r.from){i.to=r.to;continue}if(i.from===r.to){i.from=r.from;continue}}const a=ti.pushNew();a.from=r.from,a.to=r.to}Gr(ti);const s=this._bufferWriter.vertexBufferLayout.stride/4,r=ti.reduce(((e,t)=>Math.max(e,t.numElements)),0)*s,i=hi(r);i.fill(0,0,r);const a=e.vao.vertexBuffers.geometry;ti.forAll((e=>a.setSubData(i,e.from*s,0,e.numElements*s))),e.holes.pushArray(ti.data,ti.length),ti.forAll(((e,t)=>ti.data[t]=null)),ti.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const s=this._bufferWriter,r=s.vertexBufferLayout.stride/4,i=e.numElements,a=t.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),n=Math.min((i+a)*r,ni),o=4*n;if(e.vao.byteSize<li(ni-si)&&o>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);Gr(e.holes);const h=new Array;for(const r of t){const t=s.elementCount(r.geometry),i=$r(e.holes,t);h.push(i)}const l=e.vao.vertexBuffers.geometry;let c=0,d=0,u=0;const m=hi(n),p=s.vertexBufferLayout.createView(m.buffer);t.forEach(((t,i)=>{const a=h[i];if(null==a)return;if(u!==a){const e=u-d;e>0&&l.setSubData(m,d*r,0,e*r),d=a,c=0}const n=s.elementCount(t.geometry);this._writeGeometry(t,p,c),c+=n,u=a+n;const o=new Fr(t,a,a+n);xe(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const g=u-d;g>0&&l.setSubData(m,d*r,0,g*r),f(t,((e,t)=>null==h[t]))}_writeGeometry(e,t,s){if(null===this._bufferWriter)return;const r=e.localOrigin.vec3;Te(Jr,-r[0],-r[1],-r[2]);const i=v(Kr,Jr,e.transformation);w(ei,i),R(ei,ei),this._bufferWriter.write(i,ei,e.geometry,t,s)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:s}=e;if(!this.material.produces(s.slot,t))return null;const r=t===Z.Highlight||t===Z.ShadowHighlight;if(r&&!this._hasHighlights)return null;const i=t===Z.ShadowExcludeHighlight,a=!(r||i);for(const n of this._dataByOrigin.values())for(const o of n.buffers){if(r&&!o.hasHighlights)continue;const n=(r?o.drawCommandsHighlight:i&&o.needsMultipleCommands()?o.drawCommandsShadowHighlightRest:o.drawCommandsDefault)||null,h=a&&o.drawCommandsOccludees||null;if(n?.length||h?.length){const r=this._glMaterials.load(e.rctx,s.slot,t),i=null!=r?r.beginSlot(s):null;if(null!=i)return i}}return null}renderNode(e,t){const{output:s,bindParameters:r}=e,i=s===Z.Highlight||s===Z.ShadowHighlight,a=s===Z.ShadowExcludeHighlight,n=!(i||a),o=e.rctx,h=e.bindParameters.slot===ht.OCCLUDER_MATERIAL,l=e.bindParameters.slot===ht.TRANSPARENT_OCCLUDER_MATERIAL;o.runAppleAmdDriverHelper(),o.bindTechnique(t,this.material.parameters,r);for(const e of this._dataByOrigin.values())for(const s of e.buffers){if(i&&!s.hasHighlights)continue;const c=(i?s.drawCommandsHighlight:a&&s.needsMultipleCommands()?s.drawCommandsShadowHighlightRest:s.drawCommandsDefault)||null,d=n&&s.drawCommandsOccludees||null;(c?.length||d?.length)&&(t.program.bindDraw(new Ir(e.origin),r,this.material.parameters),t.ensureAttributeLocations(s.vao),o.bindVAO(s.vao),c?.length&&(o.setPipelineState(t.getPipeline(!1,h,l)),c.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),d?.length&&(o.setPipelineState(t.getPipeline(!0,h,l)),d.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};e([m({constructOnly:!0})],Xr.prototype,"material",void 0),Xr=e([_("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Xr);class Zr{constructor(e){this.origin=e,this.changes=new Array}}function $r(e,t){let s;if(!e.some((e=>!(e.numElements<t||(s=e,0)))))return null;const r=s.from;return s.from+=t,s.from>=s.to&&e.removeUnordered(s),r}const Jr=Ke(),Kr=Ke(),ei=Ke(),ti=new n({allocator:e=>e||new Wr,deallocator:null}),si=65536,ri=4*si,ii=1024,ai=16777216,ni=ai/4;let oi=new Float32Array(si);function hi(e){return oi.length<e&&(oi=new Float32Array(e)),oi}function li(e){const t=4*e;return t<=ii?ii:t<ri?mt(t):Math.max(Math.min(Math.ceil(1.5*t/ri)*ri,ai),t)}let ci=class extends c{constructor(e){super(e),this._pending=new di,this._changes=new Sr,this._materialRenderers=new n,this._sortedMaterialRenderers=new n,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._materialRenderers.some((e=>e.rendersOccluded))}get isEmpty(){return!this.updating&&0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(e){if(null==e)return 0;const t=this._materialRenderers.find((t=>t.material===e));return t?.usedMemory??0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=Ar(this._changes);let t=!1,s=!1,r=!1;return e.forEach(((e,i)=>{let a=this._materialRenderers.find((e=>e.material===i));if(!a&&e.adds.length>0){const e=new Xr({material:i});e.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),a=e,this._materialRenderers.push(a),t=!0,s=!0,r=!0}if(!a)return;const n=s||a.hasHighlights,o=r||a.hasWater;a.modify(e),s=s||n!==a.hasHighlights,r=r||o!==a.hasWater,a.isEmpty&&(this._materialRenderers.removeUnordered(a),a.dispose(),t=!0)})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),s&&(this._hasHighlights=this._materialRenderers.some((e=>e.hasHighlights))),r&&(this._hasWater=this._materialRenderers.some((e=>e.hasWater))),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const s=this._validateRenderGeometries(e);for(const e of s)this._geometries.set(e.id,e);const r=this._pending.empty;for(const e of s)this._pending.adds.add(e);r&&this.notifyChange("updating"),t===os.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const s=this._pending.empty,r=this._pending.adds;for(const t of e)r.has(t)?(this._pending.removed.add(t),r.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);s&&!this._pending.empty&&this.notifyChange("updating"),t===os.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const s=0===this._changes.updates.length;for(const s of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(s),e.updateType=t}switch(s&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case hs.TRANSFORMATION:case hs.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case hs.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((s=>t=s.updateAnimation(e)||t)),t}shouldRender(e){return this._sortedMaterialRenderers.some((t=>t.prepareTechnique(e)))}render(e){this._sortedMaterialRenderers.forAll((t=>{const s=t.prepareTechnique(e);null!=s&&t.renderNode(e,s)}))}intersect(e,t,s,r,i){return this._geometries.forEach((a=>{if(r&&!r(a))return;this._intersectRenderGeometry(a,s,t,0,e,i);const n=this.rendererContext.longitudeCyclical;n&&(a.boundingSphere[0]-a.boundingSphere[3]<n.min&&this._intersectRenderGeometry(a,s,t,n.range,e,i),a.boundingSphere[0]+a.boundingSphere[3]>n.max&&this._intersectRenderGeometry(a,s,t,-n.range,e,i)),i++})),i}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll(((e,t)=>{e.priority=t,this._sortedMaterialRenderers.push(e)})),this._sortedMaterialRenderers.sort(((e,t)=>t.material.renderPriority===e.material.renderPriority?e.priority-t.priority:t.material.renderPriority-e.material.renderPriority))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,s,r,i,a){if(!e.visible)return;let n=0;r+=e.transformation[12],n=e.transformation[13],ui[0]=s[0]-r,ui[1]=s[1]-n,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,i,ui,((s,r,n)=>{!function(e,t,s,r,i,a,n){const o=new At(a,n,t),h=t=>{t.set(It.OVERLAY,o,e.dist,e.normal,e.transformation,s,r)};if((null==i.results.min.drapedLayerOrder||s>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&h(i.results.min),i.options.store!==Et.MIN&&(null==i.results.max.drapedLayerOrder||s<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&h(i.results.max),i.options.store===Et.ALL){const e=Dt(i.ray);h(e),i.results.all.push(e)}}(t,n,e.material.renderPriority,a,i,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const s of e){const e=s.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const s of e){const e=s.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};e([m()],ci.prototype,"drapeSource",void 0),e([m()],ci.prototype,"updating",null),e([m()],ci.prototype,"rctx",null),e([m({constructOnly:!0})],ci.prototype,"rendererContext",void 0),e([m()],ci.prototype,"_materialRepository",null),e([m()],ci.prototype,"_localOriginFactory",null),e([m({readOnly:!0})],ci.prototype,"isEmpty",null),e([m()],ci.prototype,"_materialRenderers",void 0),e([m()],ci.prototype,"_geometries",void 0),ci=e([_("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],ci);class di{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const ui=tt();class mi extends zt{initializeProgram(e){return new kt(e.rctx,mi.shader.get().build(),Se)}initializePipeline(){return this.configuration.hasAlpha?Qt({blending:Zt(He.SRC_ALPHA,He.ONE,He.ONE_MINUS_SRC_ALPHA,He.ONE_MINUS_SRC_ALPHA),colorWrite:Xt}):Qt({colorWrite:Xt})}}mi.shader=new qt(ue,(()=>import("./TextureOnly.glsl.js").then((e=>e.T))));class pi extends ge{constructor(){super(...arguments),this.hasAlpha=!1}}e([fe()],pi.prototype,"hasAlpha",void 0);class gi extends zt{initializeProgram(e){return new kt(e.rctx,gi.shader.get().build(),Se)}initializePipeline(){return Qt({blending:$t(He.ONE,He.ONE_MINUS_SRC_ALPHA),colorWrite:Xt})}}gi.shader=new qt(V,(()=>import("./OverlayCompositing.glsl.js").then((e=>e.a))));let fi=class extends ye{get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new N,this.hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new n,this._passParameters=new me,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new ve,this.worldToPCSRatio=1,this.events=new t,this.longitudeCyclical=null,this.produces=new Map([[ht.DRAPED_MATERIAL,e=>e!==Z.Highlight||this.hasHighlights],[ht.DRAPED_WATER,()=>!0]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,t=this.view._stage.renderView,{waterTextureRepository:s,stippleTextureRepository:r,markerTextureRepository:i}=t;this._shaderTechniqueRepository=new Es({rctx:this._rctx,viewingMode:L.Local,stippleTextureRepository:r,markerTextureRepository:i,waterTextureRepository:s}),this._renderContext=new zs(this._rctx,new Js(e,this.view.state.viewingMode),null),this.addHandles([o((()=>s.updating),(()=>this.events.emit("content-changed")),h),o((()=>this.spatialReference),(e=>this._localOriginFactory=new Fs(e)),h),l((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new Ls(t.textureRepository,this._shaderTechniqueRepository,(e=>{(e.parameters.renderOccluded&wi)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=ht.DRAPED_MATERIAL,this._bindParameters.mainDepth=function(e){const t=new Ge(1);return t.samplingMode=Ie.NEAREST,new Fe(e,t,new Uint8Array([255,255,255,255]))}(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=lt.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new X(I(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(Kt.STAGE,this))}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=r(this._debugTextureTechnique),this._passParameters.texture=i(this._passParameters.texture),this._bindParameters.mainDepth=i(this._bindParameters.mainDepth),this._shaderTechniqueRepository=a(this._shaderTechniqueRepository),this.disposeOverlays()}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||s(this._renderers,(e=>e.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMemoryForMaterial(e){return Array.from(this._renderers.values()).reduce(((t,s)=>t+s.getMemoryForMaterial(e)),0)}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,ci)}createDrapeSourceRenderer(e,t,s){const r=this._renderers.get(e);null!=r&&r.destroy();const i=new t({...s,rendererContext:this,drapeSource:e});return this._renderers.set(e,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(o((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),i}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&u(e,(e=>e.drapeTargetType===ns.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=u(e,(e=>e.drapeSourceType===is.Features)),this._hasDrapedRasterSource=u(e,(e=>e.drapeSourceType===is.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,s=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new ys(this.view._stage.renderer.fboCache),this._overlays=[new ps,new ps]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=s}disposeOverlays(){this._overlays=null,this._renderTargets=i(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){if(null!=e)return e===ls.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(ls.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let r=!1;for(const[s,i]of this._renderers){if(e.done)break;(s.destroyed||t(s))&&i.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=s(this._renderers,(e=>e.hasHighlights)),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(es,(e=>e.updatePolicy===Ze.SYNC))}get isEmpty(){return!j.OVERLAY_DRAW_DEBUG_TEXTURE&&!s(this._renderers,(e=>!e.isEmpty))}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}get mode(){return this.isEmpty?ds.Disabled:this._renderTargets?.getTexture(ls.WaterNormal)?ds.EnabledWithWater:this._renderTargets?.getTexture(ls.Color)?ds.Enabled:ds.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((s=>t=s.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(const t of this._renderTargets.targets)(t.content!==ls.ColorNoRasterImage||this._needsColorWithoutRasterImage)&&(this._drawTarget(H.INNER,t,e),this._drawTarget(H.OUTER,t,e))}}_drawTarget(e,t,s){const r=this._overlays[e],i=r.canvasGeometries;if(0===i.numViews)return;const{alignPixelEnabled:a,contentPixelRatio:n}=s;this._screenToWorldRatio=n*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const o=t.output;if(this.isEmpty||o===Z.Highlight&&!this.hasHighlights||o===Z.Normal&&!this.hasWater||!r.hasSomeSizedView())return;const h=this._rctx;this._camera.pixelRatio=r.pixelRatio*n,this._renderContext.output=o,this._bindParameters.alignPixelEnabled=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=o===Z.Normal?ht.DRAPED_WATER:ht.DRAPED_MATERIAL;const l=j.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==ls.Occluded;if(!l&&!this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext))))return;const c=r.resolution;this._rctx.setViewport(e===H.INNER?0:c,0,c,c);const d=2*r.resolution,u=r.resolution,m=t.fbo;if(m.bind(h,d,u),e===H.INNER&&(h.setClearColor(0,0,0,0),h.clearSafe(je.COLOR_BUFFER_BIT)),t.content===ls.Occluded&&(this._renderContext.renderOccludedMask=wi),l)for(let t=0;t<i.numViews;t++)this._setViewParameters(i.extents[t],r),this._ensureDebugPatternResources(r.resolution,yi[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._passParameters,null),this._rctx.screen.draw();this._sortedRenderers.forAll((({drapeSource:s,renderer:a})=>{if(t.content===ls.ColorNoRasterImage&&s.drapeSourceType===is.RasterImage)return;const{fullOpacity:n}=s,l=null!=n&&n<1&&o===Z.Color?this.bindTemporaryFramebuffer(d,u):null;for(let e=0;e<i.numViews;e++)this._setViewParameters(i.extents[e],r),a.render(this._renderContext);if(l){m.bind(h,d,u),this._overlayParameters.texture=l.colorTexture,this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=e;const t=this.pluginContext.techniqueRepository.acquire(gi);this._rctx.bindTechnique(t,this._overlayParameters,this._renderContext.bindParameters),this._rctx.screen.draw(),t.release(),l.release()}})),h.bindFramebuffer(null),e===H.OUTER&&m.generateMipMap(),this._renderContext.resetRenderOccludedMask()}bindTemporaryFramebuffer(e,t){const s=this.view._stage.renderer.fboCache,r=s.acquire(z.RGBA,e,t);return s.rctx.bindFramebuffer(r.fbo),s.rctx.clearSafe(je.COLOR_BUFFER_BIT),r}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,s,r){let i=0;for(const a of this._renderers.values())i=a.intersect?.(e,t,s,r,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers;this._renderers.forEach(((t,s)=>{const r=e.indexOf(s.layer),i=r>=0,a=this._renderers.size*(s.renderGroup??(i?as.MapLayer:as.ViewLayer))+(i?r:0);this._sortedRenderers.push(new _i(s,t,a))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const s=this._camera;s.viewport=[0,0,t.resolution,t.resolution],b(s.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],s.near,s.far),C(s.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=s(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateRendersOccluded(){const e=s(this._renderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_ensureDebugPatternResources(e,t){if(D(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const s=new Uint8Array(e*e*4);let r=0;for(let t=0;t<e;t++)for(let i=0;i<e;i++){const a=Math.floor(i/10),n=Math.floor(t/10);a<2||n<2||10*a>e-20||10*n>e-20?(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=255):(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=1&a&&1&n?1&i^1&t?0:255:1&a^1&n?0:128)}const i=new Ge(e);i.samplingMode=Ie.NEAREST,this._passParameters.texture=new Fe(this._rctx,i,s);const a=new pi;a.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(mi,a)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};e([m()],fi.prototype,"hasHighlights",void 0),e([m()],fi.prototype,"_sortedDrapeSourceRenderersDirty",void 0),e([m({autoDestroy:!0})],fi.prototype,"_shaderTechniqueRepository",void 0),e([m({constructOnly:!0})],fi.prototype,"view",void 0),e([m()],fi.prototype,"worldToPCSRatio",void 0),e([m()],fi.prototype,"spatialReference",void 0),e([m({type:Boolean,readOnly:!0})],fi.prototype,"updating",null),e([m()],fi.prototype,"isEmpty",null),fi=e([_("esri.views.3d.terrain.OverlayRenderer")],fi);class _i{constructor(e,t,s){this.drapeSource=e,this.renderer=t,this.index=s}}const yi=[[1,.5,.5],[.5,.5,1]],vi=-2,wi=Oe.OccludeAndTransparent;class xi{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=Ke(),this._shaderTransformation=null,this._boundingSphere=null,this.id=d(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,null!=t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){T(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=Ke(),v(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=ss(),E(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*rs(this.shaderTransformation)),this._boundingSphere):ts}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return null==this._shaderTransformation?this.transformation:this._shaderTransformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}export{Dr as A,Bs as B,Sr as C,is as D,Hr as E,bs as F,Fs as G,Rs as H,ns as I,ws as M,fi as O,Vs as P,xi as R,ci as S,mi as T,Vr as W,as as a,os as b,Ns as c,vi as d,ds as e,ms as f,Ts as g,ls as h,Gs as i,Ir as j,hs as k,Cs as l,Ms as m,cs as n,wi as o,Hs as p,xs as q,Xs as r,Js as s,ks as t,Ar as u,Xr as v,Ws as w,pi as x,Es as y,Ls as z};
