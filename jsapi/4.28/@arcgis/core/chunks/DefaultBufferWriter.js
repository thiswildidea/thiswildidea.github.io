/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{p as e,q as t}from"./typedArrayUtil.js";import{R as s,S as r}from"./basicInterfaces.js";import{g as i,h as n}from"./enums3.js";import{V as o}from"./VertexAttribute.js";import{k as f,l as a}from"./mat4.js";import{b as u,c,d as l,e as d,f as E,B as p}from"./BufferView.js";import{a as h}from"./Util.js";function y(t,s=!1){return t<=e?s?new Array(t).fill(0):new Array(t):new Float32Array(t)}function m(s){return t(s)?s.length<e?s:new Float32Array(s):s.length<e?Array.from(s):s}function A(s){return(t(s)?s.length:s.byteLength/8)<=e?Array.from(s):new Float32Array(s)}function g(e,t,s){return Array.isArray(e)?e.slice(t,t+s):e.subarray(t,t+s)}class O{constructor(e){this._material=e.material,this._techniqueRepository=e.techniqueRep,this._output=e.output}dispose(){this._techniqueRepository.release(this._technique)}get technique(){return this._technique}get _stippleTextureRepository(){return this._techniqueRepository.constructionContext.stippleTextureRepository}get _markerTextureRepository(){return this._techniqueRepository.constructionContext.markerTextureRepository}ensureTechnique(e,t){return this._technique=this._techniqueRepository.releaseAndAcquire(e,this._material.getConfiguration(this._output,t),this._technique),this._technique}ensureResources(e){return s.LOADED}}const R={func:i.LESS},P={func:i.ALWAYS},B={mask:255},L={mask:0},k=e=>({function:{func:i.NOTEQUAL,ref:e,mask:e},operation:{fail:n.KEEP,zFail:n.KEEP,zPass:n.KEEP}}),b=e=>({function:{func:i.ALWAYS,ref:e,mask:e},operation:{fail:n.KEEP,zFail:n.KEEP,zPass:n.REPLACE}}),z={function:{func:i.ALWAYS,ref:r.OutlineVisualElementMask,mask:r.OutlineVisualElementMask},operation:{fail:n.KEEP,zFail:n.KEEP,zPass:n.ZERO}},S={function:{func:i.ALWAYS,ref:r.OutlineVisualElementMask,mask:r.OutlineVisualElementMask},operation:{fail:n.KEEP,zFail:n.KEEP,zPass:n.REPLACE}},F={function:{func:i.EQUAL,ref:r.OutlineVisualElementMask,mask:r.OutlineVisualElementMask},operation:{fail:n.KEEP,zFail:n.KEEP,zPass:n.KEEP}},q={function:{func:i.NOTEQUAL,ref:r.OutlineVisualElementMask,mask:r.OutlineVisualElementMask},operation:{fail:n.KEEP,zFail:n.KEEP,zPass:n.KEEP}};function N(e,t,s,r=1){const{data:i,indices:n}=e,o=t.typedBuffer,f=t.typedBufferStride,a=n.length;if(s*=f,1===r)for(let e=0;e<a;++e)o[s]=i[n[e]],s+=f;else for(let e=0;e<a;++e){const t=i[n[e]];for(let e=0;e<r;e++)o[s]=t,s+=f}}function T(e,t,s){const{data:r,indices:i}=e,n=t.typedBuffer,o=t.typedBufferStride,f=i.length;s*=o;for(let e=0;e<f;++e){const t=2*i[e];n[s]=r[t],n[s+1]=r[t+1],s+=o}}function w(e,t,s,r){const{data:i,indices:n}=e,o=t.typedBuffer,f=t.typedBufferStride,a=n.length;if(s*=f,null==r||1===r)for(let e=0;e<a;++e){const t=3*n[e];o[s]=i[t],o[s+1]=i[t+1],o[s+2]=i[t+2],s+=f}else for(let e=0;e<a;++e){const t=3*n[e];for(let e=0;e<r;++e)o[s]=i[t],o[s+1]=i[t+1],o[s+2]=i[t+2],s+=f}}function M(e,t,s,r=1){const{data:i,indices:n}=e,o=t.typedBuffer,f=t.typedBufferStride,a=n.length;if(s*=f,1===r)for(let e=0;e<a;++e){const t=4*n[e];o[s]=i[t],o[s+1]=i[t+1],o[s+2]=i[t+2],o[s+3]=i[t+3],s+=f}else for(let e=0;e<a;++e){const t=4*n[e];for(let e=0;e<r;++e)o[s]=i[t],o[s+1]=i[t+1],o[s+2]=i[t+2],o[s+3]=i[t+3],s+=f}}function _(e,t,s){const r=e.typedBuffer,i=e.typedBufferStride;t*=i;for(let e=0;e<s;++e)r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=0,t+=i}function I(e,t,s,r,i=1){if(!t)return void w(e,s,r,i);const{data:n,indices:o}=e,a=s.typedBuffer,u=s.typedBufferStride,c=o.length,l=t[0],d=t[1],E=t[2],p=t[4],h=t[5],y=t[6],m=t[8],A=t[9],g=t[10],O=t[12],R=t[13],P=t[14];r*=u;let B=0,L=0,k=0;const b=f(t)?e=>{B=n[e]+O,L=n[e+1]+R,k=n[e+2]+P}:e=>{const t=n[e],s=n[e+1],r=n[e+2];B=l*t+p*s+m*r+O,L=d*t+h*s+A*r+R,k=E*t+y*s+g*r+P};if(1===i)for(let e=0;e<c;++e)b(3*o[e]),a[r]=B,a[r+1]=L,a[r+2]=k,r+=u;else for(let e=0;e<c;++e){b(3*o[e]);for(let e=0;e<i;++e)a[r]=B,a[r+1]=L,a[r+2]=k,r+=u}}function K(e,t,s,r,i=1){if(!t)return void w(e,s,r,i);const{data:n,indices:o}=e,u=t,c=s.typedBuffer,l=s.typedBufferStride,d=o.length,E=u[0],p=u[1],h=u[2],y=u[4],m=u[5],A=u[6],g=u[8],O=u[9],R=u[10],P=!a(u),B=1e-6,L=.999999;r*=l;let k=0,b=0,z=0;const S=f(u)?e=>{k=n[e],b=n[e+1],z=n[e+2]}:e=>{const t=n[e],s=n[e+1],r=n[e+2];k=E*t+y*s+g*r,b=p*t+m*s+O*r,z=h*t+A*s+R*r};if(1===i)if(P)for(let e=0;e<d;++e){S(3*o[e]);const t=k*k+b*b+z*z;if(t<L&&t>B){const e=1/Math.sqrt(t);c[r]=k*e,c[r+1]=b*e,c[r+2]=z*e}else c[r]=k,c[r+1]=b,c[r+2]=z;r+=l}else for(let e=0;e<d;++e)S(3*o[e]),c[r]=k,c[r+1]=b,c[r+2]=z,r+=l;else for(let e=0;e<d;++e){if(S(3*o[e]),P){const e=k*k+b*b+z*z;if(e<L&&e>B){const t=1/Math.sqrt(e);k*=t,b*=t,z*=t}}for(let e=0;e<i;++e)c[r]=k,c[r+1]=b,c[r+2]=z,r+=l}}function v(e,t,s,r,i=1){const{data:n,indices:o}=e,f=s.typedBuffer,a=s.typedBufferStride,u=o.length;if(r*=a,t!==n.length||4!==t)if(1!==i)if(4!==t)for(let e=0;e<u;++e){const t=3*o[e];for(let e=0;e<i;++e)f[r]=n[t],f[r+1]=n[t+1],f[r+2]=n[t+2],f[r+3]=255,r+=a}else for(let e=0;e<u;++e){const t=4*o[e];for(let e=0;e<i;++e)f[r]=n[t],f[r+1]=n[t+1],f[r+2]=n[t+2],f[r+3]=n[t+3],r+=a}else{if(4===t){for(let e=0;e<u;++e){const t=4*o[e];f[r]=n[t],f[r+1]=n[t+1],f[r+2]=n[t+2],f[r+3]=n[t+3],r+=a}return}for(let e=0;e<u;++e){const t=3*o[e];f[r]=n[t],f[r+1]=n[t+1],f[r+2]=n[t+2],f[r+3]=255,r+=a}}else{f[r]=n[0],f[r+1]=n[1],f[r+2]=n[2],f[r+3]=n[3];const e=new Uint32Array(s.typedBuffer.buffer,s.start),t=a/4,o=e[r/=4];r+=t;const c=u*i;for(let s=1;s<c;++s)e[r]=o,r+=t}}function C(e,t,s,r,i=1){const n=t.typedBuffer,o=t.typedBufferStride;if(r*=o,1===i)for(let t=0;t<s;++t)n[r]=e[0],n[r+1]=e[1],n[r+2]=e[2],n[r+3]=e[3],r+=o;else for(let t=0;t<s;++t)for(let t=0;t<i;++t)n[r]=e[0],n[r+1]=e[1],n[r+2]=e[2],n[r+3]=e[3],r+=o}function V(e,t,s,r,i,n){for(const f of t.fields.keys()){const t=e.attributes.get(f),a=t?.indices;if(t&&a)U(f,t,s,r,i,n);else if(f===o.OBJECTANDLAYERIDCOLOR&&null!=e.objectAndLayerIdColor){const t=e.attributes.get(o.POSITION)?.indices;if(t){const s=t.length,r=i.getField(f,u);C(e.objectAndLayerIdColor,r,s,n)}}}}function U(e,t,s,r,i,n){switch(e){case o.POSITION:{h(3===t.size);const r=i.getField(e,p);h(!!r,`No buffer view for ${e}`),r&&I(t,s,r,n);break}case o.NORMAL:{h(3===t.size);const s=i.getField(e,p);h(!!s,`No buffer view for ${e}`),s&&K(t,r,s,n);break}case o.NORMALCOMPRESSED:{h(2===t.size);const s=i.getField(e,E);h(!!s,`No buffer view for ${e}`),s&&T(t,s,n);break}case o.UV0:{h(2===t.size);const s=i.getField(e,d);h(!!s,`No buffer view for ${e}`),s&&T(t,s,n);break}case o.COLOR:case o.SYMBOLCOLOR:{const s=i.getField(e,u);h(!!s,`No buffer view for ${e}`),h(3===t.size||4===t.size),!s||3!==t.size&&4!==t.size||v(t,t.size,s,n);break}case o.COLORFEATUREATTRIBUTE:{const s=i.getField(e,l);h(!!s,`No buffer view for ${e}`),h(1===t.size),s&&1===t.size&&function(e,t,s){const{data:r,indices:i}=e,n=t.typedBuffer,o=t.typedBufferStride,f=i.length,a=r[0];s*=o;for(let e=0;e<f;++e)n[s]=a,s+=o}(t,s,n);break}case o.TANGENT:{h(4===t.size);const s=i.getField(e,c);h(!!s,`No buffer view for ${e}`),s&&function(e,t,s,r,i=1){if(!t)return void M(e,s,r,i);const{data:n,indices:o}=e,f=t,u=s.typedBuffer,c=s.typedBufferStride,l=o.length,d=f[0],E=f[1],p=f[2],h=f[4],y=f[5],m=f[6],A=f[8],g=f[9],O=f[10],R=!a(f),P=1e-6,B=.999999;if(r*=c,1===i)for(let e=0;e<l;++e){const t=4*o[e],s=n[t],i=n[t+1],f=n[t+2],a=n[t+3];let l=d*s+h*i+A*f,L=E*s+y*i+g*f,k=p*s+m*i+O*f;if(R){const e=l*l+L*L+k*k;if(e<B&&e>P){const t=1/Math.sqrt(e);l*=t,L*=t,k*=t}}u[r]=l,u[r+1]=L,u[r+2]=k,u[r+3]=a,r+=c}else for(let e=0;e<l;++e){const t=4*o[e],s=n[t],f=n[t+1],a=n[t+2],l=n[t+3];let L=d*s+h*f+A*a,k=E*s+y*f+g*a,b=p*s+m*f+O*a;if(R){const e=L*L+k*k+b*b;if(e<B&&e>P){const t=1/Math.sqrt(e);L*=t,k*=t,b*=t}}for(let e=0;e<i;++e)u[r]=L,u[r+1]=k,u[r+2]=b,u[r+3]=l,r+=c}}(t,r,s,n);break}case o.PROFILERIGHT:case o.PROFILEUP:case o.PROFILEVERTEXANDNORMAL:case o.FEATUREVALUE:{h(4===t.size);const s=i.getField(e,c);h(!!s,`No buffer view for ${e}`),s&&M(t,s,n)}}}class j{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.attributes.get(o.POSITION).indices.length}write(e,t,s,r,i){V(s,this.vertexBufferLayout,e,t,r,i)}}export{j as D,O as G,S as a,z as b,q as c,P as d,L as e,F as f,R as g,A as h,I as i,K as j,v as k,M as l,_ as m,y as n,C as o,N as p,U as q,k as r,B as s,b as t,g as u,m as v,V as w};
