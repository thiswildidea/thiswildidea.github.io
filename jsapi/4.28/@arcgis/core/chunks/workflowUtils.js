/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import{O as t}from"./typedArrayUtil.js";import{c as a}from"./asyncUtils.js";import{m as i,h as n}from"./handleUtils.js";import{clone as r}from"../core/lang.js";import{throwIfAborted as s,debounce as l,whenOrAbort as o}from"../core/promiseUtils.js";import{watch as c,whenOnce as u}from"../core/reactiveUtils.js";import{p}from"./screenUtils.js";import{d as y}from"./diffUtils.js";import{featureHasFields as d,fixFields as f,getDisplayFieldName as m}from"../layers/support/fieldUtils.js";import{c as h,a as g}from"./drapedUtils.js";import{m as b}from"./lengthUtils.js";import{c as w,a as v,T as S,d as j}from"./visualVariableUtils.js";import{s as U,i as I}from"./styleUtils.js";import{t as V}from"../symbols/support/jsonUtils.js";import{getDisplayedSymbol as L}from"../symbols/support/symbolUtils.js";import{G as z}from"./GraphicState.js";import{h as F,a as T}from"./hitTestSelectUtils.js";import{g as x}from"./templateUtils.js";function k(e){const t=e.sourceLayer;if(!t||"feature"!==t.type||!function(e){switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}(t.renderer))return{rotation:null,size:null};let a=null,i=null;const n=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&null!=w(t,e)));1===n.length&&(a=function(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,n=t.fields&&t.fields.filter((e=>e.name===i)),r=n&&1===n.length?n[0].type:"double",s={initial:0,current:0};return{field:i,fieldType:r,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-a*e,A((s.current+360)%360,r)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}(n[0],t));const r=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&v(t)===S.RealWorldSize&&null!=j(t,e)));return 1===r.length&&(i=function(e,t){const a=e.field,i=e.axis,n=t.fields&&t.fields.filter((e=>e.name===a)),r=n&&1===n.length?n[0].type:"double",s={updating:!1,initial:0,current:0},l=b[e.valueUnit]??1;let o;return o="area"===e.valueRepresentation?e=>(e*l/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*l/2:e=>e*l,{field:a,fieldType:r,getDefault:async(e,t)=>A(o(await async function(e,t,a){if(null==t)return 0;const{symbol:i}=V(t);if(null==i||"web-style"===i.type||"cim"===i.type)return 0;const n=i.symbolLayers.at(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("./symbolLayerUtils.js");return n.size||Math.min(H.icon,(await e(n,H.icon))[0])||H.icon}case"text":return n.size||H.text;case"line":return n.size||H.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await t(n,e.scale/H.viewScaleSizeFactor),a)}case"path":return(null!=n.width?n.width:n.height)||e.scale/H.viewScaleSizeFactor;case"extrude":return n.size||e.scale/H.viewScaleSizeFactor;default:return 0}}(t,e,i)),r),getValue:(e,t)=>(s.initial||(s.initial=t.pixelSizeAt(t.center)),s.current=s.initial*e,A(s.current,r)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,displayUnit:N(e.valueUnit),axis:e.axis}}(r[0],t)),{rotation:a,size:i}}function A(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function E(e,t,a){const i=await L(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t,scale:a});null!=y(e.symbol,i)&&(e.symbol=i)}async function O(e,t,a,r){(await M(e,t,r)).remove();const s=e.on("create",(async i=>{if("cancel"===i.state&&(await M(e,t,r)).remove(),"complete"===i.state){const n=i.graphic;n.sourceLayer||(n.sourceLayer=t.layer),n.attributes||(n.attributes={...t.template?.prototype.attributes});const s="2d"===e.view?.type?e.view?.scale:null;await E(n,r,s),a(n)}}));return n([s,i((()=>e.cancel()))])}async function M(e,t,a){const n=t.layer,r={...t.template?.prototype.attributes,...t.attributeOverrides};let s=null;const{view:o}=e,u="2d"===o?.type;if(await C(e,n,r,a,u?o.scale:null),u){const t=l((t=>C(e,n,r,a,t)));s=c((()=>o.scale),(e=>t(e)))}const{data:p,editing:y}=n.capabilities;return e.layer.elevationInfo=n.elevationInfo,await e.create(function(e){if(!e)throw new Error("no geometry type");return"multipatch"===e?"mesh":e}(n.geometryType),{graphicProperties:{attributes:r,sourceLayer:n},hasZ:p.supportsZ,defaultZ:(u?y.zDefault:null)??e.defaultCreateOptions.defaultZ,geometryToPlace:t.geometryToPlace??void 0}),s??i()}async function C(t,a,i,n,r){const s=new e({sourceLayer:a,attributes:i}),{rotation:l,size:o}=k(s);let c=await L(s,{useSourceLayer:!0,webStyleCache:n,scale:r}),u=!1;for(const e of[o,l])null!=e&&null==i[e.field]&&(i[e.field]=await e.getDefault(c,t.view),u=!0);switch(u&&(c=await L(s,{useSourceLayer:!0,webStyleCache:n,scale:r})),c?.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=c;break;case"simple-line":case"line-3d":t.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":t.pointSymbol=c;break;case"mesh-3d":t.meshSymbol=c}P(t.tooltipOptions,o,l)}function P(e,t,a){e.visualVariables=null!=t||null!=a?{size:null!=t?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:null!=a?{valueType:a.fieldType,rotationType:a.rotationType??"geographic"}:null}:null}function R(e,t){return e?e.find((e=>e.layer===t)):void 0}async function G(e,a,i,n){switch(a.type){case"3d":return async function(e,a,i,n){if(0===e.length)return[];const{updatable:r,graphicsByLayer:s}=await i.async((async()=>{const{results:t}=await o(F(a,i),n),r=new Map;T(t).forEach((({graphic:e})=>(e=>{const t=e.layer,a=r.get(t);if(!a){const e=new Array;return r.set(t,e),e}return a})(e).push(e)));const s=e.filter((({supports:e,layer:t})=>e.includes("update")&&r.has(t)));return 0!==s.length&&i.stopPropagation(),{updatable:s,graphicsByLayer:r}}));return o(Promise.allSettled(r.map((async({layer:e})=>{const a=s.get(e),i=D(e);if(a.every((e=>d(i,e))))return a;const r=[];for(const e of a){r.push(e.getObjectId());const a=Object.keys(e.attributes);t(i,a)}const l=e.createQuery();return l.returnGeometry=!1,l.objectIds=r,l.outFields=f(e.fieldsIndex,i),e.queryFeatures(l,{signal:n}).then((({features:e})=>e))}))),n)}(e,a,i,n);case"2d":return async function(e,t,a,i){if(0===e.length)return[];let n=null;const r=await a.async((async()=>{const{results:r}=await o(t.hitTest(a),i);if(0===r.length)return[];const s=new Set;n=T(r),n.forEach((({graphic:e})=>e&&s.add(e.layer)));const l=e.items.filter((({layer:e,supports:t,attachmentsOnUpdateEnabled:a})=>s.has(e)&&(t.includes("update")||t.includes("delete")||a)));return l.length>0&&a.stopPropagation(),l}));return o(Promise.allSettled(r.map((async({layer:e})=>{const r=e.createQuery();r.returnGeometry=!1,r.outFields=D(e);const s="renderer"in e?h({renderer:e.renderer,event:a}):0;r.geometry=g(a.mapPoint,s,t),r.outSpatialReference=t.spatialReference;const{features:l}=await e.queryFeatures(r,{signal:i});return n?.forEach((({graphic:t})=>{t.layer!==e||l.some((e=>e.getObjectId()===t.getObjectId()))||l.push(t)})),l}))),i)}(e,a,i,n)}}function D(e){return f(e.fieldsIndex,[e.objectIdField,m({displayField:"displayField"in e?e.displayField:null,fields:e.fields})])}async function Z(e,t,a){const{sourceLayer:i}=e,n=i.createQuery();n.objectIds=[e.getAttribute(i.objectIdField)],n.outFields=["*"],n.outSpatialReference=t,n.returnM=i.capabilities.data.supportsM,n.returnZ=i.capabilities.data.supportsZ,U()&&I()&&"scene"===i.type&&null!=i.infoFor3D&&(n.returnGeometry=!0,n.formatOf3DObjects="3D_glb");const r=await i.queryFeatures(n,{signal:a});return s(a),r.features[0]}async function q(e){const{graphic:t,sketchViewModel:a,sourceLayer:i,visualVariables:n,webStyleCache:r}=e;let s=!1;const{rotation:l,size:o}=n;if([l,o].forEach((async e=>{if(null==e)return;const i=t.getAttribute(e.field);if(null!=i)e.initValue(i);else{const i=await e.getDefault(t.symbol,a.view);e.initValue(i),t.setAttribute(e.field,i),s=!0}})),s){const e="2d"===a.view?.type?a.view.scale:null;await E(t,r,e)}const c={multipleSelectionEnabled:!1};return"point"===i.geometryType&&(c.enableRotation=null!=l,c.enableScaling=null!=o),P(a.tooltipOptions,o,l),a.layer.elevationInfo=i.elevationInfo,a.update(t,c)}async function Q(e,t,a,i,n){if(null==t.geometry||"point"!==t.geometry?.type)return;const r=i.rotation,s=null==(l=a.toolEventInfo)||"rotate-start"!==l.type&&"rotate"!==l.type&&"rotate-stop"!==l.type?null:l;var l;if(null!=r&&null!=s)if("rotate-stop"===s.type)r.isUpdatingInteractively=!1,r.initValue();else{r.isUpdatingInteractively=!0;const{field:a,getValue:i}=r;t.setAttribute(a,i(s.angle,e))}const o=i.size,c=function(e){return null==e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}(a.toolEventInfo);if(null!=o&&null!=c)if("scale-stop"===c.type)o.isUpdatingInteractively=!1,o.initValue();else{o.isUpdatingInteractively=!0;const{field:a,getValue:i}=o;t.setAttribute(a,i(c.xScale,e))}await E(t,n,"2d"===e.type?e.scale:null)}async function B({feature:e,featureClone:t,visualVariableAttributes:a,sketchViewModel:r,view:s,onUpdate:o,webStyleCache:u}){await E(t,u,"2d"===s.type?s.scale:null);let p=null;if("2d"===r?.view?.type){const e=l((e=>E(t,u,e)));p=c((()=>r?.view?.scale),(t=>e(t)))}s.map.add(r.layer);const y=t.sourceLayer,d=ee(s,y);await q({graphic:t,sketchViewModel:r,sourceLayer:y,visualVariables:a,webStyleCache:u});let f=null;d.then((e=>f=e)).catch((()=>{}));const m=a.size,h=a.rotation,g=c((()=>e.attributes),(async e=>{let a=!1;for(const i in e){const n=e[i];n!==t.getAttribute(i)&&(t.setAttribute(i,n),null==m||m.isUpdatingInteractively||m.field!==i||m.initValue(n),null==h||h.isUpdatingInteractively||h.field!==i||h.initValue(n),(null==f||f.requiredFields.includes(i))&&(a=!0))}a&&await E(t,u,"2d"===s.type?s.scale:null)})),b=r.on("update",(async e=>{const t=e.graphics[0];if("complete"===e.state)return q({graphic:t,sketchViewModel:r,sourceLayer:y,visualVariables:a,webStyleCache:u});await Q(s,t,e,a,u),o(ae(t),e)})),w=r.on(["undo","redo"],(async e=>{o(ae(e.graphics[0]),e)}));return n([w,b,i((()=>r.cancel())),g,p])}async function W(e,t,r){const l=e.view;e.layer.add(r);const o=t.sourceLayer,c=t.layer,p=t.getAttribute(c.objectIdField);let y=null;function d(e){y?.abort(),y=a((async t=>{const a=await ee(l,o);s(t),a.setVisibility?.(p,e)}))}return await async function(e,t){if("3d"===e.type){const a=new z({graphic:t}),i=e.trackGraphicState(a);await u((()=>a.displaying)),i.remove()}else await u((()=>t.visible))}(l,r),d(!1),n([_(l,r,(e=>d(!e))),i((async()=>{d(!0);try{const e=await ee(l,o);await u((()=>!e.updating))}finally{e.layer.remove(r)}}))])}function _(e,t,a){if("3d"===e.type){const i=new z({graphic:t});return n([e.trackGraphicState(i),c((()=>i.displaying),a)])}return c((()=>t.visible),a)}const H={icon:p(24),text:p(12),line:p(1),viewScaleSizeFactor:100};function J(e,t,a){let i=!1;return e.filter((e=>!!i||(i=e===t,i))).map((e=>a[e]()))}function K(e,t){e.viewModel.syncFeatureTemplates();const a=e.creationInfo;if("awaiting-feature-creation-info"===t[0].id&&a){const e=a.layer,i=x(e);1===i.length&&"scene"!==e.type&&(a.template=i[0],t.shift())}return t}function N(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}function X(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}function Y(e){const{creationInfo:t,viewModel:a}=e;if(!t)return!1;const{layer:i}=t,n=a.editableItems.find((e=>e.layer===i));if(n)return n.attachmentsOnCreateEnabled;const r=i.capabilities?.data,s=a.layerInfos?.find((e=>e.layer===i));return!(!(r&&"supportsAttachment"in r&&r.supportsAttachment)||s&&(!1===s.allowAttachments||!1===s.attachmentsOnUpdateEnabled))}const $=e=>/-stop/.test(e)||/vertex-/.test(e),ee=(e,t)=>{const a="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(a)};function te(e){return"createInteractiveEditSession"in e}function ae(e){const t=e.geometry;if("mesh"===t?.type){const a=e.cloneShallow();return a.attributes=r(e.attributes),a.geometry=t.cloneShallow(),a.geometry.transform=t.transform?.clone()??null,a}return e.clone()}function ie(e){const t=e.cursor;return e.cursor="progress",i((()=>e.cursor=t))}export{Y as a,M as b,q as c,J as d,K as e,R as f,k as g,O as h,$ as i,Z as j,te as k,B as l,W as m,ae as n,G as o,X as p,ie as s,E as u,Q as v,ee as w};
