/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{c as t}from"./maybe.js";import{m as e,R as s}from"./MemCache.js";import{P as i}from"./PooledArray.js";import{P as r,S as h,T as n,b as a,c,R as o,j as l}from"./enums3.js";import{a as _,F as u,R as p}from"./FramebufferObject.js";import{T as m,a as d}from"./Texture.js";import{c as g,l as f}from"./mathUtils.js";import{s as E,c as y,E as T,q as F,d as w,g as L}from"./vec3.js";import{c as M,f as C}from"./vec3f64.js";class R{constructor(t,e){this._cache=t(e,((t,e)=>this._remove(t,e)))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}pop(t){const e=this._cache.peek(t);if(!e)return;const s=e.pop();if(e.length>0){const s=e.reduce(((t,e)=>t+e.usedMemory),0);this._cache.updateSize(t,e,s)}else this._cache.pop(t);return s}put(t,s,i=e){const r=this._cache.peek(t);if(!r)return void this._cache.put(t,[s],s.usedMemory,i);r.push(s);const h=r.reduce(((t,e)=>t+e.usedMemory),0);this._cache.updateSize(t,r,h)}_remove(t,e){switch(e){case s.ALL:return t.forEach((t=>t.dispose())),0;case s.SOME:return t.shift()?.dispose(),t.reduce(((t,e)=>t+e.usedMemory),0)}}}class b{constructor(t,e){this._last=new i,this._incarnation=0,this._cache=new R(t,e)}destroy(){this._last?.forAll((t=>t.dispose())),this._last=null,this._cache.destroy()}set interactive(t){t&&!this._last?this._last=new i:t||(this._last?.forAll((t=>t.dispose())),this._last=null)}clean(){this._last?.filterInPlace((t=>!(t.incarnation<this._incarnation&&(this._cache.put(t.key,t),1))))}frame(){++this._incarnation}pop(t){if(this._last){const e=this._last.find((e=>e.key===t));if(e)return this._last.removeUnordered(e),e}return this._cache.pop(t)}put(t){t.incarnation=this._incarnation,this._last?this._last.push(t):this._cache.put(t.key,t)}get usedMemory(){return this._last?.reduce(((t,e)=>t+e.usedMemory),0)??0}}class D{constructor(t){this.rctx=t,this._acquired=new Set,this._cache=new b(t.newCache,"FBOCache"),this._depthCache=new b(t.newCache,"DepthAttachmentCache"),this._colorCache=new b(t.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frame(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame()}get usedMemory(){return Array.from(this._acquired.values()).reduce(((t,e)=>t+("colorTexture"in e?e.colorTexture?.gpuMemoryUsage??0:e.usedMemory)),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(t){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=t}acquire(t,e,s){const i=x(t,e,s),r=this._cache.pop(i)||new S(i,new u(this.rctx,{...k[t],width:e,height:s}),(t=>(r.releaseDepth(),r.depth=this._acquireDepth(t,r.fbo.width,r.fbo.height),r.fbo.attachDepthStencil(r.depth.attachment),r)),((t,i)=>{const h=this._acquireColor(t,e,s);return r.colors??=new Map,r.colors.set(i,h),r.fbo.attachColorTexture(h.attachment,i),r}));return r.release=()=>{this._acquired.delete(r),r.releaseDepth(),this._cache.put(r),r.release=()=>console.log(`Double FBO release in ${(new Error).stack}`)},this.rctx.unbindTexture(r.fbo.colorTexture),this._trackHandle(r)}acquireDepth(t,e,s){return this._acquireDepth(t,e,s)}_acquireDepth(t,e,s){const i=x(t,e,s),r=this._depthCache.pop(i);if(r)return this._trackHandle(r);const h=t===j.DEPTH_STENCIL_TEXTURE?new H(i,new d(this.rctx,{...$[t],width:e,height:s}),(()=>{this._acquired.delete(h),this._depthCache.put(h)})):new H(i,new p(this.rctx,{...$[t],width:e,height:s}),(()=>{this._acquired.delete(h),this._depthCache.put(h)}));return this._trackHandle(h)}_acquireColor(t,e,s){const i=x(t,e,s),r=this._colorCache.pop(i);if(r)return this._trackHandle(r);const h=new P(i,new d(this.rctx,{...k[t],width:e,height:s}),(()=>{this._acquired.delete(h),this._colorCache.put(h)}));return this._trackHandle(h)}_trackHandle(t){return this._acquired.add(t),t}}class S{constructor(t,e,s,i){this.key=t,this.fbo=e,this.acquireDepth=s,this.acquireColor=i,this.release=()=>{},this.incarnation=0}dispose(){this.fbo.dispose()}releaseDepth(){this.fbo.detachDepthStencilTexture(),this.fbo.detachDepthStencilBuffer(),this.depth=t(this.depth)}detachDepth(){const t=this.depth;return this.depth=void 0,this.fbo.detachDepthStencilTexture(),this.fbo.detachDepthStencilBuffer(),t}attachDepth(t){return this.releaseDepth(),t&&(this.fbo.attachDepthStencil(t.attachment),this.depth=t),this}releaseColor(e){this.fbo.detachColorTexture(e);const s=this.colors?.get(e);this.colors?.delete(e),t(s)}get colorTexture(){return this.fbo?.colorTexture}getColorTexture(t=l.COLOR_ATTACHMENT0){return this.fbo?.getColorTexture(t)}get usedMemory(){return this.fbo.gpuMemoryUsage}}class A{constructor(t,e,s){this.key=t,this.attachment=e,this.release=s,this.incarnation=0}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.gpuMemoryUsage}}class H extends A{}class P extends A{constructor(t,e,s){super(t,e,s),this.attachment=e,this.release=s}}function x(t,e,s){return`${t}x${e}x${s}`}var B;!function(t){t[t.RED=0]="RED",t[t.RG=1]="RG",t[t.RGBA4=2]="RGBA4",t[t.RGBA=3]="RGBA",t[t.RGBA_MIPMAP=4]="RGBA_MIPMAP",t[t.R16F=5]="R16F",t[t.RGBA16F=6]="RGBA16F"}(B||(B={}));const G=new m;G.pixelFormat=r.RED,G.internalFormat=h.R8,G.wrapMode=n.CLAMP_TO_EDGE;const v=new m;v.pixelFormat=r.RG,v.internalFormat=h.RG8,v.wrapMode=n.CLAMP_TO_EDGE;const N=new m;N.internalFormat=h.RGBA4,N.dataType=a.UNSIGNED_SHORT_4_4_4_4,N.wrapMode=n.CLAMP_TO_EDGE;const I=new m;I.wrapMode=n.CLAMP_TO_EDGE;const O=new m;O.wrapMode=n.CLAMP_TO_EDGE,O.samplingMode=c.LINEAR_MIPMAP_LINEAR,O.hasMipmap=!0,O.maxAnisotropy=8;const U=new m;U.pixelFormat=r.RED,U.dataType=a.HALF_FLOAT,U.internalFormat=h.R16F,U.samplingMode=c.NEAREST;const q=new m;q.dataType=a.HALF_FLOAT,q.internalFormat=h.RGBA16F,q.samplingMode=c.NEAREST;const k={[B.RED]:G,[B.RG]:v,[B.RGBA4]:N,[B.RGBA]:I,[B.RGBA_MIPMAP]:O,[B.R16F]:U,[B.RGBA16F]:q};var j;!function(t){t[t.DEPTH_STENCIL_TEXTURE=0]="DEPTH_STENCIL_TEXTURE",t[t.DEPTH_STENCIL_BUFFER=1]="DEPTH_STENCIL_BUFFER",t[t.DEPTH24_BUFFER=2]="DEPTH24_BUFFER",t[t.DEPTH16_BUFFER=3]="DEPTH16_BUFFER"}(j||(j={}));const X=new m;X.pixelFormat=r.DEPTH_STENCIL,X.dataType=a.UNSIGNED_INT_24_8,X.samplingMode=c.NEAREST,X.wrapMode=n.CLAMP_TO_EDGE;const $={[j.DEPTH_STENCIL_TEXTURE]:X,[j.DEPTH_STENCIL_BUFFER]:new _(o.DEPTH24_STENCIL8,4),[j.DEPTH24_BUFFER]:new _(o.DEPTH_COMPONENT24,4),[j.DEPTH16_BUFFER]:new _(o.DEPTH_COMPONENT16,4)};class z{constructor(t=M()){this.intensity=t}}class J{constructor(t=M(),e=C(.57735,.57735,.57735)){this.intensity=t,this.direction=e}}class K{constructor(t=M(),e=C(.57735,.57735,.57735),s=!0,i=1,r=1){this.intensity=t,this.direction=e,this.castShadows=s,this.specularStrength=i,this.environmentStrength=r}}class Q{constructor(){this.r=[0],this.g=[0],this.b=[0]}}function V(t,e,s){(s=s||t).length=t.length;for(let i=0;i<t.length;i++)s[i]=t[i]*e[i];return s}function W(t,e,s){(s=s||t).length=t.length;for(let i=0;i<t.length;i++)s[i]=t[i]*e;return s}function Y(t,e,s){(s=s||t).length=t.length;for(let i=0;i<t.length;i++)s[i]=t[i]+e[i];return s}function Z(t){return(t+1)*(t+1)}function tt(t,e,s){const i=t[0],r=t[1],h=t[2],n=s||[];return n.length=Z(e),e>=0&&(n[0]=.28209479177),e>=1&&(n[1]=.4886025119*i,n[2]=.4886025119*h,n[3]=.4886025119*r),e>=2&&(n[4]=1.09254843059*i*r,n[5]=1.09254843059*r*h,n[6]=.31539156525*(3*h*h-1),n[7]=1.09254843059*i*h,n[8]=.54627421529*(i*i-r*r)),n}const et=[],st=[],it=[],rt=[0],ht=[0],nt=M(),at=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class ct{constructor(){this.color=M(),this.intensity=1}}class ot{constructor(){this.direction=M(),this.ambient=new ct,this.diffuse=new ct}}const lt=.4;class _t{constructor(){this._shOrder=2,this._legacy=new ot,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new Q,this._mainLight=new K(M(),C(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(t){(function(t,e,s,i){!function(t,e){const s=Z(t),i=e||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=s;for(let t=0;t<s;t++)i.r[t]=i.g[t]=i.b[t]=0}(e,i),E(s.intensity,0,0,0);let r=!1;const h=et,n=st,a=it;h.length=0,n.length=0,a.length=0;for(const e of t)e instanceof K&&!r?(y(s.direction,e.direction),y(s.intensity,e.intensity),s.specularStrength=e.specularStrength,s.environmentStrength=e.environmentStrength,s.castShadows=e.castShadows,r=!0):e instanceof K||e instanceof J?h.push(e):e instanceof z?n.push(e):e instanceof Q&&a.push(e);(function(t,e){const s=(i=e.r.length,g(Math.floor(Math.sqrt(i)-1),0,2));var i;for(const i of t)T(nt,i.direction),tt(nt,s,rt),V(rt,at),W(rt,i.intensity[0],ht),Y(e.r,ht),W(rt,i.intensity[1],ht),Y(e.g,ht),W(rt,i.intensity[2],ht),Y(e.b,ht)})(h,i),function(t,e){tt(nt,0,rt);for(const s of t)e.r[0]+=rt[0]*at[0]*s.intensity[0]*4*Math.PI,e.g[0]+=rt[0]*at[0]*s.intensity[1]*4*Math.PI,e.b[0]+=rt[0]*at[0]*s.intensity[2]*4*Math.PI}(n,i);for(const t of a)Y(i.r,t.r),Y(i.g,t.g),Y(i.b,t.b)})(t,this._shOrder,this._mainLight,this._sphericalHarmonics),y(this._legacy.direction,this._mainLight.direction);const e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,F(this._legacy.diffuse.color,this._mainLight.intensity,e),y(ut,this._legacy.diffuse.color),F(ut,ut,.4*this.globalFactor),w(this._legacy.ambient.color,this._legacy.ambient.color,ut)}copyFrom(t){this._sphericalHarmonics.r=Array.from(t.sh.r),this._sphericalHarmonics.g=Array.from(t.sh.g),this._sphericalHarmonics.b=Array.from(t.sh.b),y(this._mainLight.direction,t.mainLight.direction),y(this._mainLight.intensity,t.mainLight.intensity),this._mainLight.castShadows=t.mainLight.castShadows,this._mainLight.specularStrength=t.mainLight.specularStrength,this._mainLight.environmentStrength=t.mainLight.environmentStrength,this.globalFactor=t.globalFactor,this.noonFactor=t.noonFactor}lerpLighting(t,e,s){if(L(this._mainLight.intensity,t.mainLight.intensity,e.mainLight.intensity,s),this._mainLight.environmentStrength=f(t.mainLight.environmentStrength,e.mainLight.environmentStrength,s),this._mainLight.specularStrength=f(t.mainLight.specularStrength,e.mainLight.specularStrength,s),y(this._mainLight.direction,e.mainLight.direction),this._mainLight.castShadows=e.mainLight.castShadows,this.globalFactor=f(t.globalFactor,e.globalFactor,s),this.noonFactor=f(t.noonFactor,e.noonFactor,s),t.sh.r.length===e.sh.r.length)for(let i=0;i<e.sh.r.length;i++)this._sphericalHarmonics.r[i]=f(t.sh.r[i],e.sh.r[i],s),this._sphericalHarmonics.g[i]=f(t.sh.g[i],e.sh.g[i],s),this._sphericalHarmonics.b[i]=f(t.sh.b[i],e.sh.b[i],s);else for(let t=0;t<e.sh.r.length;t++)this._sphericalHarmonics.r[t]=e.sh.r[t],this._sphericalHarmonics.g[t]=e.sh.g[t],this._sphericalHarmonics.b[t]=e.sh.b[t]}}const ut=M();export{z as A,B as C,j as D,J as F,R as M,_t as S,K as a,D as b,lt as c};
