/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{j as e,m as t,k as s}from"./mat4.js";import{I as i,a as r}from"./mat4f64.js";import{g as a,t as n,h as o,s as h,d as l,e as c,c as d,b as m,i as u,q as p,l as f}from"./vec3.js";import{f as _,c as g}from"./vec3f64.js";import{c as T}from"./sphere.js";import{b}from"./mathUtils2.js";import{O as A}from"./basicInterfaces.js";import{a as v,C as E}from"./ContentObject.js";import{O,a as S,r as y}from"./Geometry.js";import{a as R,i as I}from"./Util.js";import{a as j,V as L}from"./VertexAttribute.js";import P from"../core/Evented.js";import C from"../core/Handles.js";import{d as N}from"./maybe.js";import{P as U}from"./PooledArray.js";import{O as x}from"./Octree.js";import{h as w}from"./typedArrayUtil.js";import{L as B}from"./Logger.js";import{c as M}from"./mathUtils.js";import{b as D}from"./screenUtils.js";import{o as F}from"./vec2.js";import{O as W}from"./vec4f64.js";import{P as V}from"./frustum.js";import{c as G,d as J,f as k,a as z}from"./lineSegment.js";import{c as H,g as Y,s as X,n as Z}from"./plane.js";import{n as Q}from"./InterleavedLayout.js";import{S as q}from"./ShaderOutput.js";import{s as K,a as $,b as ee,d as te,c as se,e as ie,f as re,g as ae,G as ne}from"./DefaultBufferWriter.js";import{a as oe,R as he,i as le}from"./Material.js";import{R as ce}from"./RenderSlot.js";import{V as de}from"./FloatsPassUniform.js";import{L as me}from"./MarkerSizing.glsl.js";import{R as ue,a as pe,C as fe,r as _e}from"./RibbonLine.glsl.js";import{S as ge,P as Te,R as be}from"./Program2.js";import{c as Ae,o as ve,a as Ee,b as Oe,O as Se}from"./OrderIndependentTransparency.js";import{T as ye}from"./TransparencyPassType.js";import{e as Re}from"./enums3.js";import{m as Ie,d as je,a as Le}from"./renderState2.js";class Pe extends v{get geometries(){return this._geometries}get transformation(){return this._transformation??i}set transformation(t){this._transformation=e(this._transformation??r(),t),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(t){this._shaderTransformation=t?e(this._shaderTransformation??r(),t):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=E.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Ce),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){R(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("geometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,s=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:s}),j(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new O(A.MaskOccludee);for(const t of this._geometries)t.occludees=S(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=y(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new O(A.Highlight);for(const t of this._geometries)t.highlights=S(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=y(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,s){return t(s,this.transformation,e.transformation)}getCombinedShaderTransformation(e,s=r()){return t(s,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Ne,this._validateBoundingVolume(this._bvWorldSpace,De.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Ne,this._validateBoundingVolume(this._bvObjectSpace,De.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){const s=t===De.ObjectSpace;for(const t of this._geometries){const i=t.boundingInfo;i&&Ue(i,e,s?t.transformation:this.getCombinedShaderTransformation(t))}a(e.bounds,e.min,e.max,.5);for(const t of this._geometries){const i=t.boundingInfo;if(null==i)continue;const r=s?t.transformation:this.getCombinedShaderTransformation(t),a=b(r);n(Me,i.center,r);const h=o(Me,e.bounds),l=i.radius*a;e.bounds[3]=Math.max(e.bounds[3],h+l)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,t){this._parentLayer&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}}class Ce{constructor(){this.min=_(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=_(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Ne extends Ce{constructor(){super(...arguments),this.bounds=T()}}function Ue(e,t,i){const r=e.bbMin,a=e.bbMax;if(s(i)){const e=h(xe,i[12],i[13],i[14]);l(we,r,e),l(Be,a,e);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],we[e]),t.max[e]=Math.max(t.max[e],Be[e])}else if(n(we,r,i),c(r,a))for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],we[e]),t.max[e]=Math.max(t.max[e],we[e]);else{n(Be,a,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],we[e],Be[e]),t.max[e]=Math.max(t.max[e],we[e],Be[e]);for(let e=0;e<3;++e){d(we,r),d(Be,a),we[e]=a[e],Be[e]=r[e],n(we,we,i),n(Be,Be,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],we[e],Be[e]),t.max[e]=Math.max(t.max[e],we[e],Be[e])}}}const xe=g(),we=g(),Be=g(),Me=g();var De,Fe;!function(e){e[e.WorldSpace=0]="WorldSpace",e[e.ObjectSpace=1]="ObjectSpace"}(De||(De={})),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(Fe||(Fe={}));const We=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];class Ve extends v{get objects(){return this._objects}constructor(e,t,s=""){super(),this.stage=e,this.apiLayerUid=s,this.type=E.Layer,this.events=new P,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new U,this._objectsAdded=new U,this._handles=new C,this.apiLayerUid=s,this.visible=t?.visible??!0,this.pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??Fe.ASYNC,this._disableOctree=t?.disableOctree??!1,e.add(this);for(const t of We)this._handles.add(this.events.on(t,(s=>e.handleEvent(t,s))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),null!=this._octree&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),null!=this._octree&&this._objectsAdded.pushArray(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),null!=this._octree){for(let e=0;e<t.length;)this._objectsAdded.removeUnordered(t[e])?(t[e]=t[t.length-1],t.length-=1):++e;this._octree.remove(t)}}}sync(){this.updatePolicy!==Fe.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.length>50&&!this._disableOctree?(this._octree=new x((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=N(this._octree),this._objectsAdded.clear()}}function Ge(e){return null!=e&&e.type===E.Layer}const Je=new Map([[L.POSITION,0],[L.SUBDIVISIONFACTOR,1],[L.UV0,2],[L.AUXPOS1,3],[L.AUXPOS2,4],[L.COLOR,5],[L.COLORFEATUREATTRIBUTE,5],[L.SIZE,6],[L.SIZEFEATUREATTRIBUTE,6],[L.OPACITYFEATUREATTRIBUTE,7],[L.OBJECTANDLAYERIDCOLOR,8]]);class ke extends ge{initializeProgram(e){return new Te(e.rctx,ke.shader.get().build(this.configuration),Je)}_makePipelineState(e,t){const s=this.configuration,i=e===ye.NONE,r=e===ye.FrontFace;return Ie({blending:s.output===q.Color||s.output===q.Alpha?i?Ae:ve(e):null,depthTest:{func:Ee(e)},depthWrite:i?s.writeDepth?je:null:Oe(e),colorWrite:Le,stencilWrite:s.hasOccludees?K:null,stencilTest:s.hasOccludees?t?$:ee:null,polygonOffset:i||r?s.hasPolygonOffset?ze:null:Se})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?ze:null;this._occluderPipelineTransparent=Ie({blending:Ae,polygonOffset:t,depthTest:te,depthWrite:null,colorWrite:Le,stencilWrite:null,stencilTest:se}),this._occluderPipelineOpaque=Ie({blending:Ae,polygonOffset:t,depthTest:te,depthWrite:null,colorWrite:Le,stencilWrite:ie,stencilTest:re}),this._occluderPipelineMaskWrite=Ie({blending:null,polygonOffset:t,depthTest:ae,depthWrite:null,colorWrite:null,stencilWrite:K,stencilTest:$})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Re.LINES:Re.TRIANGLE_STRIP}getPipeline(e,t,s){return e?this._occludeePipelineState:this.configuration.occluder?s?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}ke.shader=new be(ue,(()=>import("./RibbonLine.glsl.js").then((e=>e.R))));const ze={factor:0,units:-4};var He;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(He||(He={}));class Ye extends oe{constructor(e){super(e,new Ze),this._configuration=new pe,this._vertexAttributeLocations=Je}getConfiguration(e,t){this._configuration.output=e,this._configuration.draped=t.slot===ce.DRAPED_MATERIAL;const s=null!=this.parameters.stipplePattern&&e!==q.Highlight;var i;return this._configuration.stippleEnabled=s,this._configuration.stippleOffColorEnabled=s&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=s&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&(i=this.parameters.markerParameters).anchor===me.Tip&&i.hideOnShortSegments&&"begin-end"===i.placement&&i.worldSpace,this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===he.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,s,i,r,a){if(!s.options.selectionMode)return;const n=e.attributes.get(L.POSITION).data,o=e.attributes.get(L.SIZE);let h=this.parameters.width;if(this.parameters.vvSize){const t=e.attributes.get(L.SIZEFEATUREATTRIBUTE).data[0];h*=M(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(h*=o.data[0]);const l=i[0],c=i[1],d=(h/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,u=0;for(let e=0;e<n.length-5;e+=3){const t=n[e],s=n[e+1],i=l-t,r=c-s,a=n[e+3]-t,o=n[e+4]-s,h=M((a*i+o*r)/(a*a+o*o),0,1),d=a*h-i,p=o*h-r,f=d*d+p*p;f<m&&(m=f,u=e/3)}m<d*d&&r(a.dist,a.normal,u,!1)}intersect(e,t,s,i,r,a){if(!s.options.selectionMode||!e.visible)return;if(!I(t))return void B.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const n=e.attributes,c=n.get(L.POSITION).data;let _=this.parameters.width;if(this.parameters.vvSize){const e=n.get(L.SIZEFEATUREATTRIBUTE).data[0];_*=M(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else n.has(L.SIZE)&&(_*=n.get(L.SIZE).data[0]);const g=s.camera,T=it;F(T,s.point);const b=_*g.pixelRatio/2+4*g.pixelRatio;h(ut[0],T[0]-b,T[1]+b,0),h(ut[1],T[0]+b,T[1]+b,0),h(ut[2],T[0]+b,T[1]-b,0),h(ut[3],T[0]-b,T[1]-b,0);for(let e=0;e<4;e++)if(!g.unprojectFromRenderScreen(ut[e],pt[e]))return;Y(g.eye,pt[0],pt[1],ft),Y(g.eye,pt[1],pt[2],_t),Y(g.eye,pt[2],pt[3],gt),Y(g.eye,pt[3],pt[0],Tt);let A=Number.MAX_VALUE,v=0;const E=Ke(this.parameters,n)?c.length-2:c.length-5;for(let e=0;e<E;e+=3){$e[0]=c[e]+t[12],$e[1]=c[e+1]+t[13],$e[2]=c[e+2]+t[14];const s=(e+3)%c.length;if(et[0]=c[s]+t[12],et[1]=c[s+1]+t[13],et[2]=c[s+2]+t[14],X(ft,$e)<0&&X(ft,et)<0||X(_t,$e)<0&&X(_t,et)<0||X(gt,$e)<0&&X(gt,et)<0||X(Tt,$e)<0&&X(Tt,et)<0)continue;if(g.projectToRenderScreen($e,rt),g.projectToRenderScreen(et,at),rt[2]<0&&at[2]>0){m(tt,$e,et);const e=g.frustum,t=-X(e[V.NEAR],$e)/u(tt,Z(e[V.NEAR]));p(tt,tt,t),l($e,$e,tt),g.projectToRenderScreen($e,rt)}else if(rt[2]>0&&at[2]<0){m(tt,et,$e);const e=g.frustum,t=-X(e[V.NEAR],et)/u(tt,Z(e[V.NEAR]));p(tt,tt,t),l(et,et,tt),g.projectToRenderScreen(et,at)}else if(rt[2]<0&&at[2]<0)continue;rt[2]=0,at[2]=0;const i=J(k(rt,at,ht),T);i<A&&(A=i,d(nt,$e),d(ot,et),v=e/3)}const O=s.rayBegin,S=s.rayEnd;if(A<b*b){let e=Number.MAX_VALUE;if(z(k(nt,ot,ht),k(O,S,lt),st)){m(st,st,O);const t=f(st);p(st,st,1/t),e=t/o(O,S)}a(e,st,v,!1)}}get _layout(){const e=Q().vec3f(L.POSITION).f32(L.SUBDIVISIONFACTOR).vec2f(L.UV0).vec3f(L.AUXPOS1).vec3f(L.AUXPOS2);return this.parameters.vvSize?e.f32(L.SIZEFEATUREATTRIBUTE):e.f32(L.SIZE),this.parameters.vvColor?e.f32(L.COLORFEATUREATTRIBUTE):e.vec4f(L.COLOR),this.parameters.vvOpacity&&e.f32(L.OPACITYFEATUREATTRIBUTE),w("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(L.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Qe(this._layout,this.parameters)}produces(e,t){return!(t!==q.Color&&t!==q.Alpha&&t!==q.Highlight&&t!==q.Depth&&t!==q.ObjectAndLayerIdColor||e!==ce.DRAPED_MATERIAL&&(this.parameters.renderOccluded===he.OccludeAndTransparentStencil?e!==ce.OPAQUE_MATERIAL&&e!==ce.OCCLUDER_MATERIAL&&e!==ce.TRANSPARENT_OCCLUDER_MATERIAL:t===q.Color||t===q.Alpha?e!==(this.parameters.writeDepth?ce.TRANSPARENT_MATERIAL:ce.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e!==ce.OPAQUE_MATERIAL))}createGLMaterial(e){return new Xe(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}}class Xe extends ne{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==q.Color&&this._output!==q.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(ke,e)}}class Ze extends de{constructor(){super(...arguments),this.width=0,this.color=W,this.join="miter",this.cap=fe.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class Qe{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t,this.numJoinSubdivisions=0;const s=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=s;break;case"round":this.numJoinSubdivisions=_e+s}}_isClosed(e){return Ke(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.attributes.get(L.POSITION).indices.length/2+1,s=this._isClosed(e);let i=s?2:4;return i+=((s?t:t-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this._parameters.wireframe&&(i=2+4*(i-2)),i}write(e,t,s,i,r){const a=ct,l=dt,c=mt,m=s.attributes.get(L.POSITION),u=m.indices,p=m.data.length/3,f=s.attributes.get(L.DISTANCETOSTART)?.data;u&&u.length!==2*(p-1)&&console.warn("RibbonLineMaterial does not support indices");let _=1,g=0;const T=this.vertexBufferLayout.fields.has(L.SIZEFEATUREATTRIBUTE);T?g=s.attributes.get(L.SIZEFEATUREATTRIBUTE).data[0]:s.attributes.has(L.SIZE)&&(_=s.attributes.get(L.SIZE).data[0]);let b=[1,1,1,1],A=0;const v=this.vertexBufferLayout.fields.has(L.COLORFEATUREATTRIBUTE);v?A=s.attributes.get(L.COLORFEATUREATTRIBUTE).data[0]:s.attributes.has(L.COLOR)&&(b=s.attributes.get(L.COLOR).data);const E=w("enable-feature:objectAndLayerId-rendering")?s.objectAndLayerIdColor:null;let O=0;const S=this.vertexBufferLayout.fields.has(L.OPACITYFEATUREATTRIBUTE);S&&(O=s.attributes.get(L.OPACITYFEATUREATTRIBUTE).data[0]);const y=new Float32Array(i.buffer),R=w("enable-feature:objectAndLayerId-rendering")?new Uint8Array(i.buffer):null,I=this.vertexBufferLayout.stride/4;let j=r*I;const P=j;let C=0;const N=f?(e,t,s)=>C=f[s]:(e,t,s)=>C+=o(e,t),U=w("enable-feature:objectAndLayerId-rendering"),x=(e,t,s,i,r,a,n)=>{if(y[j++]=t[0],y[j++]=t[1],y[j++]=t[2],y[j++]=i,y[j++]=n,y[j++]=r,y[j++]=e[0],y[j++]=e[1],y[j++]=e[2],y[j++]=s[0],y[j++]=s[1],y[j++]=s[2],y[j++]=T?g:_,v)y[j++]=A;else{const e=Math.min(4*a,b.length-4);y[j++]=b[e],y[j++]=b[e+1],y[j++]=b[e+2],y[j++]=b[e+3]}S&&(y[j++]=O),U&&(null!=E&&(R[4*j]=E[0],R[4*j+1]=E[1],R[4*j+2]=E[2],R[4*j+3]=E[3]),j++)};j+=I,h(l,m.data[0],m.data[1],m.data[2]),e&&n(l,l,e);const B=this._isClosed(s);if(B){const t=m.data.length-3;h(a,m.data[t],m.data[t+1],m.data[t+2]),e&&n(a,a,e)}else h(c,m.data[3],m.data[4],m.data[5]),e&&n(c,c,e),x(l,l,c,1,He.LEFT_CAP_START,0,0),x(l,l,c,1,He.RIGHT_CAP_START,0,0),d(a,l),d(l,c);const M=B?0:1,D=B?p:p-1;for(let t=M;t<D;t++){const s=(t+1)%p*3;h(c,m.data[s],m.data[s+1],m.data[s+2]),e&&n(c,c,e),N(a,l,t),x(a,l,c,0,He.LEFT_JOIN_END,t,C),x(a,l,c,0,He.RIGHT_JOIN_END,t,C);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const s=(e+1)/(i+1);x(a,l,c,s,He.LEFT_JOIN_END,t,C),x(a,l,c,s,He.RIGHT_JOIN_END,t,C)}x(a,l,c,1,He.LEFT_JOIN_START,t,C),x(a,l,c,1,He.RIGHT_JOIN_START,t,C),d(a,l),d(l,c)}B?(h(c,m.data[3],m.data[4],m.data[5]),e&&n(c,c,e),C=N(a,l,D),x(a,l,c,0,He.LEFT_JOIN_END,M,C),x(a,l,c,0,He.RIGHT_JOIN_END,M,C)):(C=N(a,l,D),x(a,l,l,0,He.LEFT_CAP_END,D,C),x(a,l,l,0,He.RIGHT_CAP_END,D,C)),qe(y,P+I,y,P,I),j=qe(y,j-I,y,j,I),this._parameters.wireframe&&this._addWireframeVertices(i,P,j,I)}_addWireframeVertices(e,t,s,i){const r=new Float32Array(e.buffer,s*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,s-t);let n=0;const o=e=>n=qe(a,e,r,n,i);for(let e=0;e<a.length-1;e+=2*i)o(e),o(e+2*i),o(e+1*i),o(e+2*i),o(e+1*i),o(e+3*i)}}function qe(e,t,s,i,r){for(let a=0;a<r;a++)s[i++]=e[t++];return i}function Ke(e,t){return!!e.isClosed&&t.get(L.POSITION).indices.length>2}const $e=g(),et=g(),tt=g(),st=g(),it=g(),rt=D(),at=D(),nt=g(),ot=g(),ht=G(),lt=G(),ct=g(),dt=g(),mt=g(),ut=[D(),D(),D(),D()],pt=[g(),g(),g(),g()],ft=H(),_t=H(),gt=H(),Tt=H();class bt extends oe{intersect(e,t,s,i,r,a){return le(e,s,i,r,void 0,a)}}export{Pe as O,Ye as R,bt as T,Fe as U,Ve as W,Ge as i};
