/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import e from"../request.js";import{d as t,f as r,h as a,s as n,t as o}from"./typedArrayUtil.js";import s from"../core/Error.js";import{a as i}from"./mat3.js";import{a as l}from"./mat3f64.js";import{i as c}from"./mat4.js";import{a as u}from"./mat4f64.js";import{c as f,m as p,a as h}from"./quat.js";import{a as m}from"./quatf64.js";import{s as d,c as y,j as b,x as g,q as S,d as w,t as M}from"./vec3.js";import{c as T}from"./vec3f64.js";import{j as E,r as v}from"./unitUtils.js";import{canProjectWithoutEngine as I}from"../geometry/projection.js";import R from"../geometry/SpatialReference.js";import{g as x}from"./spatialReferenceEllipsoidUtils.js";import{c as j}from"./computeTranslationToOriginAndRotation.js";import{p as q}from"./projectBuffer.js";import{p as C}from"./projectVectorToVector.js";import{c as N,e as U,a as z,i as W}from"./aaBoundingRect.js";import k from"../rest/support/Query.js";import{r as D}from"./I3SBinaryReader.js";import{c as A,a as F}from"./edgeUtils.js";import{p as O,C as _}from"./symbolColorUtils.js";import{c as L,a as G,b as B}from"./orientedBoundingBox.js";import{V as K}from"./Attribute.js";function P(e,t,r,a){const n=Q(e,t,r),o=u();return j(r,n,o,a),o}const V=1,$=5-V;function Q(e,t,r){const a=T(),n=e[3],o=2**(Math.ceil(Math.log(n)*Math.LOG2E/$)*$+V);if(r.isGeographic){const t=o/E(r).radius*180/Math.PI,n=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,n*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;a[0]=l,a[1]=s}else{const t=Math.round(e[0]/o),r=Math.round(e[1]/o);a[0]=t*o,a[1]=r*o}const s=e[2]+t,i=Math.round(s/o);return a[2]=i*o,a}function Z(e){return e?parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10):void 0}function H(e){if(a("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function J(e,t,r,a){r.traverse(t,(t=>{const r=t.mbs;return(null!=r&&ae(e,r))!==re.OUTSIDE&&(a(t),!0)}))}function X(e,t,r){let a=0,n=0;for(let o=0;o<t.length&&a<e.length;o++)e[a]===t[o]&&(r(o)&&(e[n]=e[a],n++),a++);e.length=n}function Y(e,t,r){let a=0,o=0;for(;a<r.length;)n(e,r[a])>=0===t&&(r[o]=r[a],o++),a++;r.length=o}const ee=N();function te(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return ee[0]=(e[0]-t.position[0])/t.rotationScale[0],ee[1]=(e[1]-t.position[1])/t.rotationScale[4],ee[2]=(e[2]-t.position[0])/t.rotationScale[0],ee[3]=(e[3]-t.position[1])/t.rotationScale[4],ee}var re;function ae(e,t){const r=t[0],a=t[1],n=t[3],o=e[0]-r,s=r-e[2],i=e[1]-a,l=a-e[3],c=Math.max(o,s,0),u=Math.max(i,l,0),f=c*c+u*u;return f>n*n?re.OUTSIDE:f>0?re.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,s,i,l)>n?re.INSIDE:re.INTERSECTS_CENTER_INSIDE}function ne(e,t,r){const a=[],n=r?.missingFields,o=r?.originalFields;for(const r of e){const e=r.toLowerCase();let s=!1;for(const n of t)if(e===n.name.toLowerCase()){a.push(n.name),s=!0,o&&o.push(r);break}!s&&n&&n.push(r)}return a}async function oe(e,t,r,a,n){if(0===t.length)return[];const o=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,a){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const n=t.map((e=>e.attributes[r])),o=[],s=ne(a,e.fields,{originalFields:o}),i=await se(e,n,s);for(let e=0;e<t.length;e++){const r=t[e],a=i[e],n={};if(r.attributes)for(const e in r.attributes)n[e]=r.attributes[e];for(let e=0;e<o.length;e++)n[o[e]]=a[s[e]];r.attributes=n}return t}(e.associatedLayer,t,r,a)}catch(t){if(e.associatedLayer.loaded)throw t}if(o){const i=function(e,t,r){const a=new Map,n=[],o=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<o.length;t++){const s=o[t],i=s.featureIds.indexOf(e);if(i>=0){let e=a.get(s.node);e||(e={node:s.node,indices:[],graphics:[]},n.push(e),a.set(s.node,e)),e.indices.push(i),e.graphics.push(r);for(let e=t;e>0;e--)o[e]=o[e-1];o[0]=s;break}}}return n}(t,r,n);if(null==i)throw new s("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const l=e.parsedUrl.path,c=await Promise.all(i.map((e=>function(e,t,r,a,n){return ie(e,t,r.resources.attributes,a,n)}(l,o,e.node,e.indices,a).then((t=>{for(let r=0;r<e.graphics.length;r++){const a=e.graphics[r],n=t[r];if(a.attributes)for(const e in a.attributes)e in n||(n[e]=a.attributes[e]);a.attributes=n}return e.graphics})))));return c.flat()}throw new s("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function se(e,t,r){const a=e.capabilities.query.maxRecordCount;if(null!=a&&t.length>a){const n=o(t,a);return Promise.all(n.map((t=>se(e,t,r)))).then((e=>e.flat()))}const n=new k({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(n).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new s("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}async function ie(t,r,a,n,o){const s=[];for(const e of r)if(e&&o.includes(e.name)){const r=`${t}/nodes/${a}/attributes/${e.key}/0`;s.push({url:r,storageInfo:e})}const i=await Promise.allSettled(s.map((t=>e(t.url,{responseType:"array-buffer"}).then((e=>D(t.storageInfo,e.data)))))),l=[];for(const e of n){const t={};for(let r=0;r<i.length;r++){const a=i[r];if("fulfilled"===a.status){const n=a.value;t[s[r].storageInfo.name]=ue(n,e)}}l.push(t)}return l}!function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"}(re||(re={}));const le=-32768,ce=-(2**31);function ue(e,a){if(!e)return null;const n=e[a];return t(e)?n===le?null:n:r(e)?n===ce?null:n:n!=n?null:n}function fe(e){const t=e.store,r=t.indexCRS||t.geographicCRS,a=void 0===r?t.indexWKT:void 0;if(a){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(a!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new R(Z(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function pe(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,a=void 0===r?t.vertexWKT:void 0;if(a){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(a!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new R(Z(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function he(e,t){return null==t?"@null":t===x(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function me(e,t,r){if(!I(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function de(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new s("layerview:recycle-failed")}function ye(e,t,r){const a=fe(e),n=pe(e);me(a,t,r),me(n,t,r)}function be(e){if(null==e.store?.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes?.position)throw new s("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function ge(e,t){ye(e,t.spatialReference,t.viewingMode)}function Se(e){if(null==e.store?.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes?.position)throw new s("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function we(e,t){me(e.spatialReference,t.spatialReference,t.viewingMode)}function Me(e){return"mesh-3d"===e.type}function Te(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!Me(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material?.color||"replace"!==t.material.colorMixMode)return!0}return!1}const Ee=A({color:[0,0,0,0],opacity:0});class ve{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function Ie(e){const t=new ve;let r=!1,a=!1;for(const n of e.symbolLayers.items)if("fill"===n.type&&n.enabled){const e=n.material,o=n.edges;if(null!=e&&!r){const a=e.color,o=O(e.colorMixMode);t.material=null!=a?{color:[a.r/255,a.g/255,a.b/255],alpha:a.a,colorMixMode:o}:{color:[1,1,1],alpha:1,colorMixMode:_.Multiply},t.castShadows=n.castShadows,r=!0}null==o||a||(t.edgeMaterial=F(o,{}),a=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:_.Multiply}),t}function Re(e,t){return(0|e)+(0|t)|0}function xe(e,t,r,a,n=0){a===x(a)?t.isGeographic?function(e,t,r,a){const n=E(r),o=1+Math.max(0,a)/(n.radius+e.center[2]);d(t.center,e.center[0],e.center[1],e.center[2]+a),q(t.center,r,0,t.center,x(r),0,1),f(t.quaternion,e.quaternion),h(_e,e.quaternion),d(Pe,0,0,1),g(Pe,Pe,_e),d(Pe,e.halfSize[0]*Math.abs(Pe[0]),e.halfSize[1]*Math.abs(Pe[1]),e.halfSize[2]*Math.abs(Pe[2])),S(Pe,Pe,n.inverseFlattening),w(t.halfSize,e.halfSize,Pe),S(t.halfSize,t.halfSize,o)}(e,r,t,n):function(e,t,r,a){B(e,Le),d(t.center,e.center[0],e.center[1],e.center[2]+a),j(r,t.center,Oe,x(r)),d(t.center,Oe[12],Oe[13],Oe[14]);const n=2*Math.sqrt(1+Oe[0]+Oe[5]+Oe[10]);_e[0]=(Oe[6]-Oe[9])/n,_e[1]=(Oe[8]-Oe[2])/n,_e[2]=(Oe[1]-Oe[4])/n,_e[3]=.25*n,p(t.quaternion,_e,e.quaternion),h(_e,t.quaternion);let o=0,s=0,i=0;for(const e of Le)e[2]+=a,q(e,r,0,e,x(r),0,1),b(Pe,e,t.center),g(Pe,Pe,_e),o=Math.max(o,Math.abs(Pe[0])),s=Math.max(s,Math.abs(Pe[1])),i=Math.max(i,Math.abs(Pe[2]));d(t.halfSize,o,s,i)}(e,r,t,n):t.isWGS84&&(a.isWebMercator||v(a))?function(e,t,r,a,n){y(Ne,t.center),Ne[2]+=n;const o=x(r);q(Ne,e,0,Ne,o,0,1),ze(o,t,Ne,r,a)}(t,e,a,r,n):t.isWebMercator&&v(a)?function(e,t,r,a,n){y(Ne,t.center),Ne[2]+=n,ze(e,t,Ne,r,a)}(t,e,a,r,n):e===r?(r.center[2]+=n,q(r.center,t,0,r.center,a,0,1)):(d(r.center,e.center[0],e.center[1],e.center[2]+n),q(r.center,t,0,r.center,a,0,1),f(r.quaternion,e.quaternion),y(r.halfSize,e.halfSize))}const je=new Array(24),qe=new K(je,3),Ce=T(),Ne=T(),Ue=l();function ze(e,t,r,a,n){const o=i(Ue,t.quaternion);for(let e=0;e<8;++e){for(let r=0;r<3;++r)Ce[r]=t.halfSize[r]*(0!=(e&1<<r)?-1:1);for(let t=0;t<3;++t){let a=r[t];for(let e=0;e<3;++e)a+=Ce[e]*o[3*e+t];je[3*e+t]=a}}q(je,e,0,je,a,0,8),G(qe,n)}function We(e,t,r,a,n,o){if(!o||0===o.length||null==t||!e.mbs)return null;const s=P(e.mbs,n,r,t);c($e,s);let i=null,l=1/0,u=-1/0;if(o.forEach((o=>(o=>{if("replace"!==o.type)return;const s=o.geometry;if(!s?.hasZ)return;U(Ge);const c=s.spatialReference||a,f=s.rings.reduce(((e,r)=>r.reduce(((e,r)=>(C(r,c,Pe,t),M(Pe,Pe,$e),z(Ge,Pe),Math.min(Pe[2],e))),e)),1/0);(()=>{if(!i)if(i=Le,U(Be),null!=e.serviceObb){xe(e.serviceObb,r,Ke,t,n),B(Ke,i);for(const e of i)M(e,e,$e),z(Be,e)}else{const a=e.mbs;if(!a)return;const o=a[3];C(a,r,Pe,t),M(Pe,Pe,$e),Pe[2]+=n;for(let e=0;e<8;++e){const t=1&e?o:-o,r=2&e?o:-o,a=4&e?o:-o,n=i[e];y(n,[Pe[0]+t,Pe[1]+r,Pe[2]+a]),z(Be,n)}}})(),W(Be,Ge)&&(l=Math.min(l,f),u=Math.max(u,f))})(o))),l===1/0)return null;for(let e=0;e<8;++e)f=Ve.data,p=3*e,h=i[e],M(Pe,h,s),f[p]=Pe[0],f[p+1]=Pe[1],f[p+2]=Pe[2],p+=24,h[2]=l,M(Pe,h,s),f[p]=Pe[0],f[p+1]=Pe[1],f[p+2]=Pe[2],p+=24,h[2]=u,M(Pe,h,s),f[p]=Pe[0],f[p+1]=Pe[1],f[p+2]=Pe[2];var f,p,h;return G(Ve)}function ke(e){return null!=e&&e.halfSize[0]>=0}function De(e){return e[3]>=0}function Ae(e){null!=e&&(e.halfSize[0]=-1)}function Fe(e){null!=e&&(e[3]=-1)}const Oe=u(),_e=m(),Le=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Ge=N(),Be=N(),Ke=L(),Pe=T(),Ve={data:new Array(72),size:3,exclusive:!0,stride:3},$e=u();export{J as A,Se as B,we as C,de as D,ye as E,H as F,re as M,De as a,be as b,me as c,ge as d,he as e,ne as f,fe as g,P as h,ke as i,We as j,Q as k,X as l,ue as m,ae as n,Re as o,Ie as p,ie as q,Te as r,te as s,Ee as t,Y as u,Fe as v,oe as w,Ae as x,xe as y,pe as z};
