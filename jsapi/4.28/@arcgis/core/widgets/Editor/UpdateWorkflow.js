/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import o from"../../core/Error.js";import{a as s,m as i}from"../../chunks/handleUtils.js";import{L as r}from"../../chunks/Logger.js";import{a}from"../../chunks/maybe.js";import{isAborted as n,onAbort as l,createAbortError as p,throwIfAborted as c,debounce as d}from"../../core/promiseUtils.js";import{Q as u}from"../../chunks/Queue.js";import{watch as m,whenOnce as h,sync as w}from"../../core/reactiveUtils.js";import y,{m as f}from"../../core/Accessor.js";import{property as k}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as j}from"../../core/accessorSupport/decorators/subclass.js";import{i as g}from"../../chunks/editableLayers.js";import{g as b,j as v,e as S,u as C}from"../../chunks/layerUtils2.js";import M from"../../views/draw/support/HighlightHelper.js";import _ from"./CreateFeaturesWorkflow.js";import{h as F}from"../../chunks/layerViewUtils.js";import{Edits as U}from"./Edits.js";import{f as I,w as W,j as E,k as A,g as D,l as P,i as V,m as x,n as L,d as H,o as R}from"../../chunks/workflowUtils.js";import{s as T,i as O}from"../../chunks/styleUtils.js";import G from"./Workflow.js";import B from"./UpdateWorkflowData.js";import{i as N}from"../../chunks/featureUtils.js";import{g as z}from"../../chunks/templateUtils.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../core/lang.js";import"../../chunks/utils.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/time.js";import"../../config.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/Ellipsoid.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/messages.js";import"../../chunks/arcadeOnDemand.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/Symbol3DAnchorPosition2D.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../chunks/asyncUtils.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/infoFor3D.js";import"../../chunks/layerUtils.js";import"../../chunks/utils2.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/utils3.js";import"../../chunks/mat4.js";import"../../chunks/uuid.js";import"../../chunks/helpMessageUtils.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./CreateFeaturesWorkflowData.js";import"../../chunks/diffUtils.js";import"../../chunks/drapedUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../symbols/support/jsonUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils8.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/_commonjsHelpers.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils9.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/previewUtils.js";import"../../chunks/renderUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/previewSymbol3D.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/GraphicState.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/UpdatingHandles.js";var q;let Q=q=class extends y{constructor(t){super(t),this.attachmentsCapabilities=null,this.editableItem=null,this.edits=null,this.formTemplate=null,this.parent=null,this.viewModel=null}static async create(t){const e=q._makeConstructorProps(t);return new q(e)}static _makeConstructorProps(t){const{feature:e,parent:s,viewModel:i}=t,r=i.editableItems.find((t=>t.layer===e.layer));if(!r)throw new o("no-editableItem-found","The EditorViewModel provided did not have an EditableItem associated with the specified Graphic's layer");const a=I(i.layerInfos,e.sourceLayer),n=r.supports,l=n.includes("create"),p=n.includes("update");return{attachmentsCapabilities:{editing:!0,operations:{add:l||p,update:p,delete:p}},editableItem:r,edits:new U({feature:e}),formTemplate:a?.formTemplate,parent:s,viewModel:i}}};t([k()],Q.prototype,"attachmentsCapabilities",void 0),t([k()],Q.prototype,"editableItem",void 0),t([k()],Q.prototype,"edits",void 0),t([k()],Q.prototype,"formTemplate",void 0),t([k()],Q.prototype,"parent",void 0),t([k()],Q.prototype,"viewModel",void 0),Q=q=t([j("esri.widgets.Editor.UpdateRecordWorkflowData")],Q);const J=Q;var K;let Z=K=class extends J{constructor(t){super(t)}static async create(t){const{feature:e,viewModel:s}=t,{view:i}=s;if(!i)throw new o("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const r=await W(i,e.layer);return new K({...K._makeConstructorProps(t),layerView:r})}};t([k()],Z.prototype,"layerView",void 0),Z=K=t([j("esri.widgets.Editor.UpdateFeatureWorkflowData")],Z);const $=Z;var X;const Y={exit:Symbol()};let tt=X=class extends G{constructor(t){super(t),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:t}=this,{edits:e}=t,{view:r}=t.viewModel,a=e.feature,l=new AbortController;this.addHandles(s(l)),this._updatingHandles.addPromise(E(a,t.viewModel.view.spatialReference,l.signal).then((t=>{n(l)||this._onFullFeatureLoaded(t)}),(t=>this.cancel({force:!0,error:new o("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:t}})})))),r&&(this._highlightHelper=new M({view:r}),this.addHandles(i((()=>this._highlightHelper?.removeAll()))))}get editableItem(){return this.data.editableItem}get hasPendingEdits(){return this.data.edits.modified}get parent(){return this.data.parent}get shouldShowAttachments(){return this.editableItem.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return this.editableItem.supports.includes("update")}get reliesOnOwnerAdminPrivileges(){const{layer:t}=this.editableItem,e=t.capabilities?.operations.supportsUpdate,o=b(t)?.operations.supportsUpdate;return v(t)&&!t.editingEnabled||!!o&&!e}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel(),this._configureFeatureFormViewModel()}exit(t){this.removeHandles(Y.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:t,fullFeature:e}=this,{attachmentsCapabilities:o,viewModel:s}=t,{attachmentsViewModel:r}=s;r.set({capabilities:o,graphic:e,filesEnabled:!1,mode:"view"}),this.addHandles([i((()=>r.fileInfos.removeAll())),m((()=>r.mode),(t=>{switch(t){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}))],Y.exit)}_configureFeatureFormViewModel(){const{edits:t,formTemplate:e,viewModel:{featureFormViewModel:o,view:s}}=this.data;o.set({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:e,highlightHelper:this._highlightHelper,map:s?.map,spatialReference:s.spatialReference});const{initialFeature:i}=t;i&&o.overrideInitialFeature(i),this.addHandles(o.on("value-change",(()=>{t.updateAttributes(o.getValues()),this.fullFeature.attributes=t.feature.attributes})),Y.exit)}_onFullFeatureLoaded(t){this.fullFeature=t;const{edits:e}=this.data;e.updateAttributes(t.attributes),e.trackChanges()}static async create(t){const e=new X({data:await J.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}static _createWorkflowSteps(t){const{attachmentsViewModel:e}=t.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){e.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){e.mode="view"}}]}};var et;tt._onCommitFactory=t=>async e=>{const{edits:o}=e,{feature:s}=o;if(!s)return;const i=s.sourceLayer,r=s.clone();if(!o.attributesModified||o.stagedForDelete){const t=i.objectIdField;if(r.attributes={[t]:s.getAttribute(t)},T()&&O()&&"scene"===i.type&&null!=i.infoFor3D){const t=i.associatedLayer?.globalIdField;null!=t&&r.setAttribute(t,s.getAttribute(t))}}o.geometryModified&&!o.stagedForDelete||(r.geometry=null);const a=o.stagedForDelete?"deleteFeatures":"updateFeatures";await t(i,{[a]:[r]})},t([k()],tt.prototype,"editableItem",null),t([k()],tt.prototype,"fullFeature",void 0),t([k()],tt.prototype,"hasPendingEdits",null),t([k()],tt.prototype,"parent",null),t([k()],tt.prototype,"shouldShowAttachments",null),t([k()],tt.prototype,"shouldAllowAttachmentEditing",null),t([k()],tt.prototype,"reliesOnOwnerAdminPrivileges",null),tt=X=t([j("esri.widgets.Editor.UpdateRecordWorkflow")],tt);const ot={...Y,highlights:Symbol(),sketch:Symbol()};let st=et=class extends tt{constructor(t){super(t),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._webStyleCache=new Map}initialize(){const{edits:{feature:t},layerView:e}=this.data;A(e)&&(this._layerViewEditSession=e.createInteractiveEditSession(t))}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(ot.sketch);try{const t=this.data.edits.stagedForDelete;await super.commit();const e=this._layerViewEditSession;t?e?.rollback():e?.commit()}catch(t){throw await this._configureSketchViewModel(),new o("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:t})}}async start(){return await super.start(),this._initializeSketchViewModel()}_configureFeatureFormViewModel(){super._configureFeatureFormViewModel();const{_layerViewEditSession:t}=this,{viewModel:e}=this.data;this.addHandles(e.featureFormViewModel.on("value-change",(e=>{t?.setAttribute(e.fieldName,e.value)})),ot.exit)}_configureHighlight(){const{edits:t,layerView:e}=this.data;F(e)&&this.addHandles(e.highlight(t.feature),ot.highlights)}async _configureSketchViewModel(){const{data:t,_sketchGraphicClone:e}=this,{edits:o,viewModel:s}=t,i=o.feature,{featureFormViewModel:r,sketchViewModel:a,view:n}=s;a.allowDeleteKey=!1;const l=D(i),p=await P({feature:i,featureClone:e,visualVariableAttributes:l,sketchViewModel:a,view:n,onUpdate:({geometry:t,attributes:e},s)=>{if(o.updateAttributes(e),o.updateGeometry(t),r.feature.geometry=t,null!=l.rotation){const{field:t}=l.rotation;r.setValue(t,e[t])}if(null!=l.size){const{field:t}=l.size;r.setValue(t,e[t])}("undo"===s.type||"redo"===s.type||"update"===s.type&&null!=s.toolEventInfo&&V(s.toolEventInfo.type))&&r.notifyFeatureGeometryChanged()},webStyleCache:this._webStyleCache});this.addHandles(p,ot.sketch)}async _initializeSketchViewModel(){const{data:t,_sketchGraphicClone:e}=this,o=t.edits.feature,{sketchViewModel:s}=t.viewModel,{geometryUpdatesEnabled:r}=t.editableItem,a=s.updateOnGraphicClick;s.updateOnGraphicClick=!1,this.addHandles([i((()=>{s.updateOnGraphicClick=a}))]),r&&this.addHandles([await x(s,o,e)]);const{highlights:n,sketch:l}=ot;return{enter:async()=>{!this.hasHandles(l)&&r?await this._configureSketchViewModel():this.hasHandles(n)||this._configureHighlight()},exit:()=>this.removeHandles([l,n])}}_onFullFeatureLoaded(t){super._onFullFeatureLoaded(t),this._sketchGraphicClone=L(t);const{edits:e}=this.data;e.updateGeometry(t.geometry),e.trackChanges()}static async create(t){const e=new et({data:await $.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}};var it;t([k()],st.prototype,"_layerViewEditSession",void 0),t([k()],st.prototype,"_sketchGraphicClone",void 0),st=et=t([j("esri.widgets.Editor.UpdateFeatureWorkflow")],st);const rt="esri.widgets.Editor.UpdateWorkflow",at=r.getLogger(rt);let nt=it=class extends G{constructor(t){super(t),this._workflowStack=new u(f),this._sketchStack=new u(f),this.type="update"}get activeEditableItem(){return this.activeWorkflow?.data.editableItem??void 0}get activeWorkflow(){return this._workflowStack.last()}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditableItem?.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return!!this.activeEditableItem?.supports.includes("update")}get hasPendingEdits(){return Array.from(this._workflowStack).some((t=>t.hasPendingEdits))}get helpMessage(){return this.activeWorkflow?.helpMessage?this.activeWorkflow.helpMessage:"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditableItem?.hasInvalidFormTemplate}get hasUnsupportedFields(){return!!this.activeEditableItem?.hasUnsupportedFields}async back(t=(()=>Promise.resolve(!0))){const{featureFormViewModel:e}=this.data.viewModel;if(null==e.relationshipId)if(this.activeWorkflow){if(this.activeWorkflow.hasPendingEdits&&!await t())return;this.activeWorkflow.hasPreviousStep?await this.activeWorkflow.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else e.relationshipId=null}async cancelActiveWorkflow(t){await(this.activeWorkflow?.cancel(t)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack((t=>t.commit())),await super.commit()}static create(t){const{viewModel:e,startAt:o,addAttachmentsCallback:s,applyEditsCallback:i}=t,r=new it({data:new B({addAttachmentsCallback:s,applyEditsCallback:i,viewModel:e}),onCommit:async()=>{}});return r._set("steps",this._createWorkflowSteps(r,o)),r}async save(){this.nestedWorkflowCount>1?(await(this.activeWorkflow?.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(t){try{const e=await this._createNestedCreateFeaturesWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new o("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(t){try{const e=await this._createNestedUpdateWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new o("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:t})}}async deleteActiveFeature(){const{activeWorkflow:t}=this;if(!t)throw new o("editor:nothing-to-delete","There is no feature to delete");pt(t)?await t.deleteAndCommit():await t.cancel(),1===this.nestedWorkflowCount?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack((t=>t.cancel({force:!0})))}async _createNestedCreateFeaturesWorkflow(t){const{relatedLayer:e}=t,{addAttachmentsCallback:s,applyEditsCallback:i,viewModel:r}=this.data;if(!g(e))throw new o("editor:unsupported-layer","Editing is not supported on the provided layer");const a=this._getCreationInfoForNestedCreateFeaturesWorkflow(t),n=a.template||a.initialFeature?"creating-features":"awaiting-feature-creation-info",l="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0;return _.create({addAttachmentsCallback:s,applyEditsCallback:i,creationInfo:a,isNested:!0,parent:l,startAt:n,viewModel:r})}_getCreationInfoForNestedCreateFeaturesWorkflow(t){const{relatedLayer:s}=t;if(!g(s)||S(s))throw new o("editor:unsupported-layer","Editing is not supported on the provided layer");const i={layer:s,maxFeatures:1},r=this._makeRelatedRecordAttributes(t),a=z(s);return a?.length>0?(i.attributeOverrides=r,1===a.length&&(i.template=a[0])):i.initialFeature=new e({sourceLayer:s,attributes:r}),i}async _createNestedUpdateWorkflow(t){const e=C(t.sourceLayer)?tt:st,{applyEditsCallback:o,viewModel:s}=this.data,i="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,r=await e.create({feature:t,parent:i,viewModel:s,applyEdits:o});return await h((()=>!r.updating)),r}async _drainWorkflowStack(t){const e=this._workflowStack,o=[];for(;e.length>0;){const s=e.pop();this._sketchStack.pop();const i=t(s).then((()=>s.destroy()));this._updatingHandles.addPromise(i),o.push(i)}await Promise.all(o)}_makeRelatedRecordAttributes(t){const{parentFeature:e,relatedLayer:o,relationshipId:s}=t;if(!N(e))return;const i=o.relationships?.find((t=>t.id===s));if(!i)return void lt("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===i.role)return void lt("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const r=e.sourceLayer;i.relatedTableId!==r.layerId&&lt("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const a=r.relationships?.find((t=>t.id===s));if(!a)return void lt("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const n=e.getAttribute(a.keyField);return n||lt("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[i.keyField]:n}}async _popWorkflow(){this._workflowStack.pop()?.destroy(),this._sketchStack.pop();const t=await this._reconcileWorkflowStack();if(t.failureCount>0)throw new o("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",t)}async _pushWorkflow(t){const e=this._workflowRequiresSketchViewModel(t);this.activeWorkflow?.exit({removeSketchHandles:e});const s=this._sketchStack,i=await(t?.start()),r=s.peek();i?(r?.exit(),s.push(i)):s.push(this._cloneSketchController(r)),this._workflowStack.push(t);const a=await this._reconcileWorkflowStack();if(a.failureCount>0)throw new o("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",a)}async _reconcileWorkflowStack(){const t=this._workflowStack,e=this._sketchStack;try{const o=t.peek();return await(o?.enter()),await(e.peek()?.enter()),{activeWorkflow:o,failureCount:0}}catch(o){t.pop().destroy(),e.pop();const{activeWorkflow:s,failureCount:i}=await this._reconcileWorkflowStack();return{activeWorkflow:s,failureCount:i+1}}}_cloneSketchController(t){return{enter:t?.enter??(async()=>{}),exit:t?.exit??(async()=>{})}}_workflowRequiresSketchViewModel(t){const{type:e}=t;return"update-feature"===e||"create-features"===e&&!C(t.data.creationInfo?.layer)}static _createWorkflowSteps(t,e="awaiting-feature-to-update"){const{data:s}=t;return H(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:e}=s.viewModel,o=s.viewModel.view;let r=null;t.addHandles(i((()=>{r=a(r)})),this.id),s.rootFeature=null,s.candidates=[];const n=o.on("immediate-click",(async i=>{i.stopPropagation(),e.location=i.mapPoint,e.visible=!0,r?.abort();const{editableItems:a}=s.viewModel;r=new AbortController;const n=await new Promise(((t,e)=>{l(r?.signal,(()=>e(p()))),t(R(a,o,i,r?.signal))}));c(r),s.candidates=n.filter((t=>"fulfilled"===t.status)).flatMap((t=>t.value)),e.visible=1===s.candidates.length,0!==s.candidates.length&&(1===s.candidates.length?(s.rootFeature=s.candidates[0],t.go("editing-existing-feature").catch((()=>{})).then((()=>e.visible=!1))):t.next())}));o.focus(),t.addHandles(n,this.id)},async tearDown(){0===s.candidates.length&&(s.viewModel.spinnerViewModel.visible=!1),t.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){s.rootFeature=null;const{view:e}=s.viewModel;if(!e)return;const o=new M({view:e});t.addHandles([m((()=>s.rootFeature),((t,e)=>{o.remove(e),o.add(t)}),w),i((()=>o.removeAll()))],this.id)},async tearDown(){t.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:e,viewModel:r}=t.data;if(!e)throw new o("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await t.startUpdating(e),r.spinnerViewModel.visible=!1;const a=d((async()=>{await h((()=>!t.updating)),t.previous()})),{featureFormViewModel:n}=s.viewModel,l=n.relatedRecordCallbacks;n.relatedRecordCallbacks={addRelatedRecord:async e=>{await t.startCreatingRelatedRecord(e),n.relationshipId=null},editRelatedRecord:async({relatedFeature:e})=>{await t.startUpdating(e),n.relationshipId=null},showAllRelatedRecords:t=>n.relationshipId=t.relationshipId},t.addHandles([i((()=>n.relatedRecordCallbacks=l)),m((()=>t.nestedWorkflowCount),((t,e)=>{0===t&&0!==e&&a()}),w)],this.id)},async tearDown(){await t.cancelAll(),t.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){s.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){s.viewModel.attachmentsViewModel.mode="view"}})})}};t([k()],nt.prototype,"activeEditableItem",null),t([k()],nt.prototype,"activeWorkflow",null),t([k()],nt.prototype,"nestedWorkflowCount",null),t([k()],nt.prototype,"shouldShowAttachments",null),t([k()],nt.prototype,"shouldAllowAttachmentEditing",null),t([k()],nt.prototype,"hasPendingEdits",null),t([k()],nt.prototype,"helpMessage",null),t([k()],nt.prototype,"reliesOnOwnerAdminPrivileges",null),t([k()],nt.prototype,"hasInvalidFormTemplate",null),t([k()],nt.prototype,"hasUnsupportedFields",null),nt=it=t([j(rt)],nt);const lt=(t,e)=>at.warn(`editor:${t}`,e,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),pt=t=>!!t&&/update-/.test(t.type),ct=nt;export{ct as default};
