/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import{r as s,i as o}from"../../chunks/typedArrayUtil.js";import{m as i,h as r}from"../../chunks/handleUtils.js";import{r as a,d as n}from"../../chunks/maybe.js";import{throwIfAborted as l,debounce as p}from"../../core/promiseUtils.js";import{watch as c,whenOnce as m,syncAndInitial as u}from"../../core/reactiveUtils.js";import{a as d}from"../../chunks/uuid.js";import{property as h}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{subclass as y}from"../../core/accessorSupport/decorators/subclass.js";import{g as j,j as f,u as g}from"../../chunks/layerUtils2.js";import{g as b}from"../../chunks/helpMessageUtils.js";import k from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as w}from"./CreateFeaturesWorkflowData.js";import{s as v,a as M,b as S,f as _,u as I,i as F,g as U,c as C,d as A,e as D,v as H,p as V}from"../../chunks/workflowUtils.js";import P from"./Workflow.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../chunks/Logger.js";import"../../config.js";import"../../core/lang.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/time.js";import"../../core/Error.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/Ellipsoid.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/messages.js";import"../../chunks/arcadeOnDemand.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/Symbol3DAnchorPosition2D.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../chunks/asyncUtils.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/diffUtils.js";import"../../chunks/drapedUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../chunks/styleUtils.js";import"../../symbols/support/jsonUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils8.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/utils3.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils9.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/previewUtils.js";import"../../chunks/renderUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/previewSymbol3D.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/GraphicState.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/templateUtils.js";import"../../chunks/UpdatingHandles.js";function E(t){const e=t?.layer;return"scene"===e?.type}var L;const x=Symbol(),O=Symbol(),T=Symbol(),G=Symbol();let R=L=class extends P{constructor(t){super(t),this.type="create-features",this.createFeatureState="create-new",this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=p(((t,e,s)=>I(t,e,s)))}initialize(){this.isNested&&(this._isActive=!1)}get hasPendingEdits(){if(this.numPendingFeatures>0)return!0;const{data:t}=this,{sketchViewModel:e}=t.viewModel,{activeComponent:s}=e,o=e.createGraphic?.geometry;if(("polyline"===o?.type||"polygon"===o?.type||"multipoint"===o?.type)&&("draw-2d"===s?.type||"draw-3d"===s?.type)&&s.drawOperation.committedVertices.length>0)return!0;const{upload:i}=t;return!(!i||"pending"!==i.state&&"success"!==i.state)||!!t.creationInfo?.geometryToPlace}get helpMessage(){const{creationInfo:t,viewModel:e}=this.data;if("creating-features"!==this.stepId||!t)return;const s=t.layer.geometryType,o=e.sketchViewModel.createGraphic;if("mesh"===s){this._getDrawMeshHelpMessage||import("../../chunks/helpMessageUtils3d.js").then((t=>{this._getDrawMeshHelpMessage=t.getDrawMeshHelpMessage}));const{view:t}=e;return"3d"===t?.type?this._getDrawMeshHelpMessage?.(o,t):void 0}return b(s,o?.geometry)}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){const{creationInfo:t}=this.data;if(!t)return!1;const{layer:e}=t,s=e.capabilities?.operations.supportsAdd,o=j(e)?.operations.supportsAdd;return f(e)&&!e.editingEnabled||!!o&&!s}get shouldShowAttachments(){return!(!this.data.creationInfo||!this.data.viewModel)&&M(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get test(){return{addAttachment:(t,e)=>{this._attachmentFileInfos.set(t,e)}}}async enter(){this._isActive=!0;const{featureFormViewModel:t}=this.data.viewModel,e=t.relatedRecordCallbacks;t.relatedRecordCallbacks=null,this.addHandles(i((()=>{t.relatedRecordCallbacks=e})),O),"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([O,G])}async updatePendingFeature(t,e){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),s(this._lastActiveGraphics,t),this._startUpdating(t,e)}async start(){return await super.start(),g(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{}}}static create(t){const{addAttachmentsCallback:e,applyEditsCallback:s,isNested:o,creationInfo:i,parent:r,startAt:a,viewModel:n}=t,l=new L({data:new w({creationInfo:i,parent:r,viewModel:n}),isNested:o,onCommit:async t=>{const{creationInfo:o}=t;if(!o)return;const i=t.pendingFeatures.toArray(),{layer:r}=o,a=r.capabilities?.editing.supportsGlobalId&&"globalIdField"in r,n=l._attachmentFileInfos;if(a){const t=function(t,e,s){const o=[],i=e.globalIdField;return t.forEach(((e,r)=>{t[r].attributes[i]??=d(),(s?.get(e)||[]).forEach((({file:t})=>o.push({feature:e,attachment:{globalId:d(),data:t}})))})),o.length?{addFeatures:t,addAttachments:o}:{addFeatures:t}}(i,r,n);return void await s(r,t,{globalIdUsed:!0})}const p=await s(r,{addFeatures:i});if(n.size>0){const t=p?.addFeatureResults??[];await e(r,function(t,e,s,o){const i=[];return e.forEach(((e,r)=>{if(!e.error){const a=t[r],n=o.get(a)||[];a.attributes[s.objectIdField]=e.objectId,n.forEach((({form:t})=>i.push({feature:a,attachment:t})))}})),i}(i,t,r,n))}}});return l._set("steps",this._createWorkflowSteps(l,a)),l}_fadeExistingFeatures(t){if("effect"in t){const e=t.effect;return t.effect="saturate(0.6) opacity(0.8)",i((()=>t.effect=e))}const e=t.opacity;return t.opacity=.7,i((()=>t.opacity=e))}_highlight(t){const e=this.data.viewModel.view;"3d"===e?.type&&this._highlightHandles.set(t,e.highlight(t))}_removeHighlight(t){a(this._highlightHandles.get(t)),this._highlightHandles.delete(t)}async _startCreating(t){this.removeHandles(T);const{data:e}=this,{creationInfo:s}=e;if(!s)return;this.createFeatureState="create-new";const o=await S(e.viewModel.sketchViewModel,s,t);this.addHandles(o,T)}async _startUpdating(t,e){const{pendingFeatures:s}=this;s.includes(t)||s.add(t);const{creationInfo:o,viewModel:i}=this.data,{attachmentsViewModel:n,editableItems:l,featureFormViewModel:p,layerInfos:m,sketchViewModel:u,view:d}=i;if(!d||!o)return;const h=o.layer,y=_(m,h),j=y?.formTemplate,f=d.spatialReference;if(this.data.editableItem=l.find((t=>t.layer===h)),p.set({arcadeEditType:"INSERT",feature:t,formTemplate:j,spatialReference:f,map:d.map}),"add"!==n.mode&&"edit"!==n.mode||i.activeWorkflow?.previous(),n.graphic=t,n.fileInfos.removeAll(),n.mode="view",(this._attachmentFileInfos.get(t)||[]).forEach((({file:t,form:e})=>n.addFile(t,e))),this._removeHighlight(t),await I(t,e,"2d"===d.type?d.scale:null),this.removeHandles(T),a(this._featureFormHandle),"2d"===d.type){const s=c((()=>d.scale),(s=>this._updateGraphicDebounced(t,e,s)));this.addHandles(s,T)}return this._featureFormHandle=r([p.on("value-change",(async()=>{t.attributes=p.getValues(),await I(t,e,"2d"===d.type?d.scale:null)})),u.on(["update","undo","redo"],(t=>{("undo"===t.type||"redo"===t.type||"update"===t.type&&null!=t.toolEventInfo&&F(t.toolEventInfo.type))&&p.notifyFeatureGeometryChanged()}))]),this.createFeatureState="update-pending",this._visualVariableAttributes=U(t),g(h)?void 0:C({graphic:t,sketchViewModel:u,sourceLayer:h,visualVariables:this._visualVariableAttributes,webStyleCache:e})}static _createWorkflowSteps(t,e="awaiting-feature-creation-info"){const{data:s}=t,o={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:e,viewModel:o}=s,{view:a}=o;a&&(E(e)?t.addHandles(await async function({view:t,data:e,signal:s,next:o,cancel:a}){const{creationInfo:n}=e;if(!n)return i();if(!E(n))return i();const{layer:p}=n,m=null!=n.geometryToPlace;if(n.geometryToPlace=null,m)return a(),i();const{Upload:u}=await import("../../chunks/Upload.js");l(s);const d=new u;e.upload=d;let h=null;const y=()=>h?.remove(),j=r([c((()=>d.state),(e=>{switch(e){case"default":case"error":y();break;case"pending":y(),h=v(t);break;case"success":n.maxFeatures=1,n.geometryToPlace=d.result,y(),o()}})),i((()=>{d.cancel(),y()}))]);return d.uploadTo(p),j}({view:a,data:s,next:()=>t.next(),cancel:()=>o.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(s.parent&&e&&(t.addHandles(o.lockFeatureTemplatesViewModel(),this.id),o.featureTemplatesViewModel.layers=[e.layer]),t.addHandles(o.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(s.creationInfo={...s.creationInfo,layer:e.layer,template:e.template},t.next())})),this.id)))},async tearDown(){t.removeHandles([this.id,T])}}),"creating-features":()=>({id:"creating-features",async setUp(){t._isActive&&await t._setUpCreatingFeaturesStep()},async tearDown(e){const{viewModel:o}=s;e.canceled&&(t.removeHandles([G,x,T]),o.attachmentsViewModel.fileInfos.removeAll(),t._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:e}=s.viewModel,{graphic:o,fileInfos:i}=e;t._attachmentFileInfos.set(o,i.toArray()),e.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:e}=s.viewModel,{graphic:o,fileInfos:i}=e;t._attachmentFileInfos.set(o,i.toArray()),e.mode="view"}})},a=A(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],e,o);return D(s,a)}static _configureSketchViewModel(t,e){const{data:o}=t,{viewModel:a}=o,{view:l}=a,p=a.sketchViewModel;let d=null;const h=[];if(!l)return{beforeCommit:i(),afterCommit:i()};const y=p.updateOnGraphicClick;return p.updateOnGraphicClick=!1,"2d"===l.type&&o.creationInfo&&h.push(t._fadeExistingFeatures(o.creationInfo.layer)),h.push(p.on("create",(async s=>{if("cancel"===s.state){if(t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);if(t._lastActiveGraphics.length<1)return t._startCreating(e);const s=t._lastActiveGraphics.pop();return t._startUpdating(s,e)}if("complete"===s.state&&s.graphic)return t._startUpdating(s.graphic,e)})),p.on("update",(async s=>{const{viewModel:i}=o,{attachmentsViewModel:r,featureFormViewModel:a}=i,n=s.graphics[0];if("complete"===s.state){if(n!==d&&(t._lastActiveGraphics.push(n),t._highlight(n)),d=null,t.numPendingFeatures===o.creationInfo?.maxFeatures){const s=t._lastActiveGraphics.pop();return t._startUpdating(s,e)}if("add"!==r.mode&&"edit"!==r.mode||i.activeWorkflow?.previous(),s.aborted&&t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);t.addHandles([v(l),l.on("click",(t=>t.preventDefault()))],x),await m((()=>!a.updating)),t.removeHandles(x),t._startCreating(e)}"start"===s.state&&t._removeHighlight(n);const p=t._visualVariableAttributes;await H(l,n,s,p,e);const c=n.attributes,{rotation:u,size:h}=p;if(null!=u){const{field:t}=u;a.setValue(t,c[t])}if(null!=h){const{field:t}=h;a.setValue(t,c[t])}})),p.on("delete",(async e=>{const o=e.graphics[0];t.pendingFeatures.remove(o),s(t._lastActiveGraphics,o),d=o})),l.on("immediate-click",(async s=>{if(E(o.creationInfo))return;const{results:i}=await l.hitTest(s,{include:p.layer}),r=i.find((t=>"graphic"===t.type&&t.graphic.sourceLayer===o.creationInfo?.layer));if(!r)return;const a=r.graphic;if("transform"===p.activeTool||"reshape"===p.activeTool){if(p.updateGraphics.at(0)===a)return;await t.updatePendingFeature(a,e)}})),i((()=>{t._preventDefaultActionOnCancel=!0,p.cancel()})),function(t,e){let s=null;const o=()=>t.snappingOptions.featureSources,a=()=>{null!=s&&(o().remove(s),s=n(s))};return r([c((()=>{const t=e.creationInfo?.layer,s=o().find((e=>e.layer===t));return{hasFeatureLayerSource:!!s,enabled:s?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:i})=>{if(!e)return a();s??=(s=new k({layer:t.layer}),o().add(s),s),s.enabled=i}),u),i(a)])}(p,o)),{beforeCommit:r(h),afterCommit:i((()=>{p.updateOnGraphicClick=y}))}}async _setUpCreatingFeaturesStep(){if(this.hasHandles(G))return;const{creationInfo:t,viewModel:s}=this.data,{attachmentsViewModel:r,view:n}=s;if(!n)return;const l=new Map,p=[],m=[];this._lastActiveGraphics=[],this._featureFormHandle=a(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},V(r),p.push(c((()=>r.mode),(t=>{switch(t){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})));const u=v(n);p.push(u);const d=g(t?.layer);try{if(E(t)&&m.push(i((()=>s.cancelWorkflow({warnIfNoWorkflow:!1})))),d){const s=t?.initialFeature??new e({attributes:{...t?.template?.prototype.attributes,...t?.attributeOverrides},sourceLayer:t?.layer});await this._startUpdating(s,l)}else{const e=L._configureSketchViewModel(this,l);p.push(e.beforeCommit),m.push(e.afterCommit),t?.initialFeature?(s.sketchViewModel.layer.add(t.initialFeature),await this._startUpdating(t.initialFeature,l)):await this._startCreating(l)}}finally{u.remove()}const h=i((()=>this.pendingFeatures.drain((t=>s.sketchViewModel.layer.remove(t)))));p.push(this._featureFormHandle),this.addHandles(p.filter(o),this._handleKeys.beforeCommit),this.addHandles([i((()=>r.fileInfos.removeAll())),...p,...m,h].filter(o),G)}};t([h({constructOnly:!0})],R.prototype,"isNested",void 0),t([h()],R.prototype,"hasPendingEdits",null),t([h()],R.prototype,"_getDrawMeshHelpMessage",void 0),t([h()],R.prototype,"helpMessage",null),t([h()],R.prototype,"parent",null),t([h()],R.prototype,"keyboardCancellationEnabled",null),t([h()],R.prototype,"reliesOnOwnerAdminPrivileges",null),t([h()],R.prototype,"shouldShowAttachments",null),t([h()],R.prototype,"shouldAllowAttachmentEditing",null),R=L=t([y("esri.widgets.Editor.CreateFeaturesWorkflow")],R);const W=R;export{W as default,E as i};
