/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.28/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{L as e}from"../../chunks/Logger.js";import{watch as i}from"../../core/reactiveUtils.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import{c as n}from"../../chunks/date.js";import{convertNumberFormatToIntlOptions as s,formatNumber as a}from"../../intl.js";import l from"../../layers/support/CodedValueDomain.js";import{i as u}from"../../chunks/editableLayers.js";import{isNumericField as p,o as m,a as d,validateFieldValue as c,isStringField as h}from"../../layers/support/fieldUtils.js";import{g as j}from"../../chunks/layerUtils2.js";import g from"../FeatureForm/FieldInput.js";import y from"./Grid/EditorColumn.js";import f from"../support/DatePicker.js";import{l as k}from"../../chunks/legacyIcon.js";import v from"../support/TimePicker.js";import{r as b}from"../../chunks/widgetUtils.js";import"../../config.js";import"../../core/lang.js";import"../../chunks/asyncUtils.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../core/Error.js";import"../../chunks/time.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../chunks/assets.js";import"../../chunks/enumeration.js";import"../../layers/support/Domain.js";import"../../chunks/unitUtils.js";import"../../chunks/Ellipsoid.js";import"../../chunks/infoFor3D.js";import"../../core/sql.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/utils2.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/collectionUtils.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../chunks/loadAll.js";import"../../portal/Portal.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/utils3.js";import"../../chunks/colorUtils.js";import"../../chunks/screenUtils.js";import"../../chunks/mat4.js";import"../../chunks/featureUtils.js";import"../FeatureForm/EditableInput.js";import"../../chunks/featureFormUtils.js";import"../../chunks/compilerUtils.js";import"../FeatureForm/InputBase.js";import"./Grid/Column.js";import"./Grid/support/ButtonMenu.js";import"../Widget.js";import"../../chunks/domUtils.js";import"../../chunks/uuid.js";import"../../chunks/projector.js";import"../../chunks/dom.js";import"../../chunks/index.js";import"../../chunks/jsxWidgetSupport.js";import"./Grid/support/ButtonMenuViewModel.js";import"./Grid/support/ButtonMenuItem.js";import"../../chunks/globalCss.js";import"../../chunks/jsxFactory.js";import"../../chunks/uriUtils.js";import"../support/DatePickerViewModel.js";import"../support/DateTimeElementViewModel.js";import"../../chunks/Popover.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../support/TimePickerViewModel.js";const F="esri-field-column",_={headerContent:`${F}__header-content`,headerLabel:`${F}__header-label`,input:`${F}__cell-input`,inputContainer:`${F}__cell__input-container`,dateInputContainer:`${F}__cell__date-input-container`,dateInputWrapper:`${F}__cell__date-input-wrapper`,button:`${F}__button`},D=n("short-date-short-time"),E=n("short-date"),C={useGrouping:!0,maximumFractionDigits:20};let w=class extends y{constructor(t){super(t),this._inputField=null,this.cellValueFormatFunction=({rowData:t,value:e})=>{if(this.formatFunction){const{template:t,field:i}=this;return this.formatFunction({template:t,field:i,value:b.sanitize(e)})}if(null===e)return"&nbsp;";const{field:i}=this,r=t?.item?.feature,o=this._getDomainForFeature(r);if(o){const t=this._getComputedDomain(e,o);if("date"===i.type&&"range"===o.type)return this._formatDateValueForDisplay(i,t);if(p(i)&&"range"===o.type){const t=this.template?.format,i=t?s(t):C;return a(parseFloat(e),i)}return m.has(i.type)?"range"===o.type?b.sanitize(d(i,t)):b.sanitize(t):t}if("date"===i.type||m.has(i.type))return this._formatDateValueForDisplay(i,e);if(p(i)){const t=this.template?.format,i=t?s(t):C;return a(parseFloat(e),i)}return b.sanitize(e)},this.cellValueValidatorFunction=({oldValue:t,value:i})=>{const{_inputField:r,field:o}=this;return!(r&&!r.valid||this.required&&(null==i||""===i)||(p(o)&&c(o,i)?(e.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),1):t===i))},this.editingEnabled=!1,this.expressionInfos=null,this.field=null,this.formatFunction=null,this.headerRenderFunction=t=>{const{root:e}=t,{editable:i,editingEnabled:r,headerMenuEnabled:o,sortable:n}=this;if(this.removeCellContent(e),e.classList.add(_.headerContent),r&&!i&&e.appendChild(this.createLockedElement()),n)this.headerSorterRenderFunction(t);else{const t=document.createElement("div");t.classList.add(_.headerLabel),t.textContent=this.label,e.appendChild(t)}o&&this.headerMenuRenderFunction(t)},this.inputRenderFunction=({root:t,column:i,rowData:r})=>{if(this.activeEditInfo?.updating||!this.editable)return;const o=this.getCellValue(i,r),{field:n}=this;if(p(n)&&c(n,o))return void e.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value.");const s=this.createInputElement({root:t,column:i,rowData:r,value:o});if(this._set("activeEditInfo",{column:i,input:s,root:t,rowData:r,updating:!0,oldValue:o}),"date"===this.field.type)return void this._renderDateEditors(o,t,s);const a=this.createInputContainer();a.appendChild(s),this.removeCellContent(t),t.appendChild(a),s.focus(),s instanceof HTMLInputElement&&s.select(),this.grid?.notifyResize()},this.layer=null,this.parseInputValueFunction=({input:t})=>{const e=this._inputField;if(!e)return null;const i=t.value,{dataType:r,required:o}=e;return o||""!==i?"number"===r||"date"===r?parseFloat(i):"text"===r?i.trim():i:null},this.store=null,this.template=null,this.updateRowItemFunction=({rowData:t,column:e,value:i})=>{t&&(t.item.feature.attributes[e.path]=i)},this.updateStoreItemFunction=async({rowData:t,column:e,value:i})=>{if(!t||!this.store)return;const r=t.item.objectId,o=this.store.getObjectIdIndex(r)??t.index;await this.store.updateItem({index:o,name:e.path,value:i})}}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.field?.description??null}get editable(){const{editingEnabled:t,field:e,layer:i,template:r}=this;if(null==e||null==i)return!1;const o=u(i),n=j(i),s=n?.operations.supportsUpdate;return!(!(e.editable&&o&&s)||m.has(e.type)||(t?!1===r?.editable:!r?.editable))}get header(){return this.template?.label||this.alias||this.path||null}get hidden(){const{template:t}=this;return!1===t?.visible||this._get("hidden")||!1}set hidden(t){this._set("hidden",t)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const{field:t,template:e}=this,i=t?.length??-1,r=e?.input&&"maxLength"in e.input?e.input.maxLength:null;return null!=r&&!isNaN(r)&&r>=-1&&(-1===i||r<=i)?r:i}get minLength(){const{template:t,maxLength:e}=this,i=t?.input&&"minLength"in t.input?t.input.minLength:null;return e&&i<=e?i:null}get name(){return this.field?.name}get nullable(){return this.field?.nullable??!1}get path(){return this.field?.name}get required(){const{field:t,template:e}=this,i=t?.nullable,r=e?.required;return this.editable&&(!i||!0===r)}get sortable(){return!(!1===this.template?.sortable)}createInputElement({rowData:t,value:e}){const i=t?.item;if(!i?.feature)return null;this._inputField=this._setUpInputField(i.feature,e);const{field:r,maxLength:o,minLength:n,required:s}=this,{domain:a}=this._inputField;let l;"coded-value"===a?.type?(l=this._createSelectElement(e,a.codedValues.map((({code:t,name:e})=>({value:t,name:e}))),this._inputField),l.onchange=()=>{l.onblur=null,m()}):(l=document.createElement("input"),l.type=p(r)?"number":"text",o>-1&&(l.maxLength=o),n>0&&(l.minLength=n)),l.classList.add(_.input),l.value=e,l.required=s;let u=!1;l.onkeydown=t=>{u="Escape"===t.key},l.onblur=()=>{l.onblur=null,m()};const m=()=>{u?this.cancel():this.submit(),this._inputField=null};return l}createInputContainer(){const t=document.createElement("div");return t.classList.add(_.inputContainer),t}createLockedElement(){const t=document.createElement("div");return t.classList.add(k.locked),t}getCellValue({path:t},e){return e?.item?.feature?.attributes?.[t]??null}_formatDateValueForDisplay(t,e){const{timeZone:i,timeZoneName:r}=this;return null!=e?d(t,e,{...this._getDateFormatOptions(),timeZone:i??void 0,timeZoneName:r??void 0}):null}_renderDateEditors(t,e,r){const{messagesCommon:o,template:n,timeZone:s}=this,a=t?new Date(t):new Date(Date.now()),l=new f({dateInputEnabled:!0,timeZone:s,value:a}),u=new v({timeZone:s,value:a});r.value=a.getTime().toString();let p=!t;const m=()=>{p=!0;const t=this._getCombinedDateTime(l.value,u.value);r.value=t.getTime().toString()},d=()=>{p?this.submit():this.cancel()},c=()=>{r.value=null,this.submit()};i((()=>[l.value,u.value]),(()=>m()));const h=document.createElement("div"),j=document.createElement("div");l.container=h,u.container=j;const g=document.createElement("button");g.classList.add(_.button,k.save),g.onclick=()=>d(),g.title=o?.save;const y=document.createElement("button");y.classList.add(_.button,k.trash),y.onclick=()=>c(),y.title=o?.clear;const b=document.createElement("div");b.classList.add(_.dateInputWrapper),b.appendChild(h),(!n||n?.input&&"datetime-picker"===n.input.type&&!1!==n.input.includeTime)&&b.appendChild(j);const F=document.createElement("div");F.classList.add(_.dateInputContainer),F.appendChild(b),F.appendChild(g),F.appendChild(y),l.when((()=>{const t=l._inputOrButtonNode;t&&(t.onblur=t=>{const e=t.relatedTarget;e&&e.className.includes("esri-date-picker")||l.close(!1)}),this.grid?.notifyResize()})),u.when((()=>this.grid?.notifyResize())),this.removeCellContent(e),e.appendChild(F),this.grid?.notifyResize()}_createSelectElement(t,e,i){let r=!1;const o=e.map((e=>{e.value===t&&(r=!0);const i=document.createElement("option");return i.text=e.name,i.value=e.value,i}));if(null!=t&&""!==t&&!r){const e=document.createElement("option");e.text=t,e.value=t,o.unshift(e)}if(!i.required&&null==i.value){const t=document.createElement("option");t.value="",o.unshift(t)}const n=document.createElement("select");return o.forEach((t=>n.add(t))),n.value=t,n}_setUpInputField(t,e){const{field:i,layer:r}=this,o=new g({feature:t,initialFeature:t.clone(),field:i,layer:r});return o.set("value",e),o}_isDomainCompatible(t){const{field:e}=this;if(t&&"coded-value"===t.type){const i=typeof t.codedValues[0].code;if("string"===i&&h(e)||"number"===i&&p(e))return!0}return!(!t||"range"!==t.type||!p(e))}_getDomainForFeature(t){const{layer:e,name:i,template:r}=this;if(!e)return null;if("wfs"===e.type||"geojson"===e.type||"csv"===e.type)return null;if(r?.domain&&this._isDomainCompatible(r.domain))return r.domain;const{typeIdField:o}=e,n=o===i,s=this.field.domain;return n&&!s?new l({name:"__internal-type-based-coded-value-domain__",codedValues:e.types?.map((({id:t,name:e})=>({code:t,name:e})))}):o&&null!=i&&e.getFieldDomain(i,{feature:t})||s}_getComputedDomain(t,e){if(!e)return null;if("range"===e.type)return t;if("coded-value"===e.type){const i=e.codedValues.filter((e=>e.hasOwnProperty("code")&&e.code===t));return i&&i.length?i[0].name:t}return null}_getCombinedDateTime(t,e){return new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),e.getSeconds())}_getDateFormatOptions(){const{template:t}=this,e=t?.format?.dateFormat;return e?n(e):t?.input&&"includeTime"in t.input&&!1===t.input.includeTime?E:D}};t([r({readOnly:!0})],w.prototype,"alias",null),t([r()],w.prototype,"cellValueFormatFunction",void 0),t([r()],w.prototype,"cellValueValidatorFunction",void 0),t([r({readOnly:!0})],w.prototype,"defaultValue",null),t([r({readOnly:!0})],w.prototype,"description",null),t([r({readOnly:!0})],w.prototype,"editable",null),t([r()],w.prototype,"editingEnabled",void 0),t([r()],w.prototype,"expressionInfos",void 0),t([r()],w.prototype,"field",void 0),t([r()],w.prototype,"formatFunction",void 0),t([r({readOnly:!0})],w.prototype,"header",null),t([r()],w.prototype,"hidden",null),t([r()],w.prototype,"headerRenderFunction",void 0),t([r()],w.prototype,"inputRenderFunction",void 0),t([r()],w.prototype,"layer",void 0),t([r({readOnly:!0})],w.prototype,"loadingMessage",null),t([r()],w.prototype,"maxLength",null),t([r()],w.prototype,"minLength",null),t([r({readOnly:!0})],w.prototype,"name",null),t([r({readOnly:!0})],w.prototype,"nullable",null),t([r()],w.prototype,"parseInputValueFunction",void 0),t([r({readOnly:!0})],w.prototype,"path",null),t([r({readOnly:!0})],w.prototype,"required",null),t([r()],w.prototype,"sortable",null),t([r()],w.prototype,"store",void 0),t([r()],w.prototype,"template",void 0),t([r()],w.prototype,"updateRowItemFunction",void 0),t([r()],w.prototype,"updateStoreItemFunction",void 0),w=t([o("esri.widgets.FeatureTable.FieldColumn")],w);const I=w;export{I as default};
