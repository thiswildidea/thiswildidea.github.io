// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","../../../core/jsonMap","../PixelBlock","./mirror"],function(ea,ia,ma,ja,na){function oa(z,r){const {fillNoDataOnly:P}=r,{band:U,width:L,height:Q,mask:v,outBand:H}=z;if(P&&!v)H.set(U);else{var {kernelRows:ba,kernelCols:V}=r;z=Math.floor(ba/2);r=Math.floor(V/2);var W=H.slice(),X=new Uint32Array(L*Q);for(var M=z;M<Q-z;M++){var w=M*L;for(var q=r;q<L-r;q++){if(P&&v&&v[w+q])continue;const I=[];for(let R=0;R<ba;R++)for(let x=0;x<V;x++){const Y=w+q+(R-z)*L+x-r;v&&!v[Y]||
I.push(U[Y])}I.length&&(I.sort((R,x)=>R-x),v?(W[w+q]=I[Math.floor((I.length-1)/2)],X[w+q]=I.length):H[w+q]=I[Math.floor((I.length-1)/2)])}}if(v)for(M=z;M<Q-z;M++)for(w=M*L,q=r;q<L-r;q++)!X[w+q]||P&&v[w+q]||(H[w+q]=W[w+q],v[w+q]=255)}}ia=new ma.JSONMap({1:"min",2:"max",3:"mean",4:"stddev",5:"median",6:"majority",7:"minority"},{useNumericKeys:!0});ea.computeFocalStatistics=function(z,r){const {mask:P}=z,{fillNoDataOnly:U}=r;if(U&&!P)return z;const {pixels:L,width:Q,height:v,bandMasks:H,pixelType:ba}=
z,V=L.length,W=Q*v,X=[],{kernelRows:M,kernelCols:w,statisticsType:q,mirrorEdges:I}=r;if(U&&!P)return z;const R=r.outputPixelType??ba,x=[];for(let S=0;S<V;S++){const Z=L[S],N=ja.createEmptyBand(R,W);U&&N.set(Z);const fa=(H?.[S]??P)?.slice()??null,ca={band:Z,width:Q,height:v,mask:fa,outBand:N};switch(q){case "min":case "max":a:{var Y=r;const {fillNoDataOnly:O}=Y,{band:p,width:d,height:A,mask:c,outBand:B}=ca;if(O&&!c){B.set(p);break a}const {kernelRows:T,kernelCols:D,statisticsType:y}=Y,m=Math.floor(T/
2),t=Math.floor(D/2),J="min"===y,E=B.slice(),F=new Uint32Array(d*A);for(let n=m;n<A-m;n++){const e=n*d;for(let a=t;a<d-t;a++){let u=J?Number.MAX_VALUE:-Number.MAX_VALUE,C=0;for(let G=0;G<T;G++)for(let f=0;f<D;f++){const b=e+a+(G-m)*d+f-t;if(!c||c[b])u=J?Math.min(u,p[b]):Math.max(u,p[b]),C++}c?(E[e+a]=0===C?0:u,F[e+a]=C):B[e+a]=0===C?0:u}}if(c)for(let n=m;n<A-m;n++){const e=n*d;for(let a=t;a<d-t;a++)!F[e+a]||O&&c[e+a]||(B[e+a]=E[e+a],c[e+a]=255)}}break;case "mean":case "stddev":a:{var ka=r;const {fillNoDataOnly:O}=
ka,{band:p,width:d,height:A,mask:c,outBand:B}=ca;if(O&&!c){B.set(p);break a}const {statisticsType:T,kernelRows:D,kernelCols:y}=ka,m="stddev"===T,t=d*A,J=new Float64Array(t),E=new Float64Array(t),F=new Uint32Array(t);for(let f=0;f<A;f++){const b=f*d;let g=0,l=0,h=0;for(let k=0;k<y;k++)if(!c||c[b+k])g+=p[b+k],m&&(l+=p[b+k]**2),h++;J[b]=g;E[b]=l;F[b]=h;for(let k=1;k<=d-y;k++){const K=b+k-1,aa=K+y;c?(c[K]&&(h--,g-=p[K],m&&(l-=p[K]**2)),c[aa]&&(h++,g+=p[aa],m&&(l+=p[aa]**2))):(g-=p[K],g+=p[aa],m&&(l-=
p[K]**2,l+=p[aa]**2));J[b+k]=g;F[b+k]=h;m&&(E[b+k]=l)}}const n=new Float64Array(t),e=new Float64Array(t),a=new Uint32Array(t),u=D*d;for(let f=0;f<=d-y;f++){let b=0,g=0,l=0;for(let h=0;h<D;h++){const k=h*d+f;b+=J[k];l+=F[k];m&&(g+=E[k])}n[f]=b;e[f]=g;a[f]=l;for(let h=1;h<=A-D;h++){const k=(h-1)*d+f,K=k+u;b-=J[k];b+=J[K];l-=F[k];l+=F[K];m&&(g-=E[k],g+=E[K]);n[h*d+f]=b;e[h*d+f]=g;a[h*d+f]=l}}const C=Math.floor(D/2),G=Math.floor(y/2);for(let f=C;f<A-C;f++){const b=f*d;for(let g=G;g<d-G;g++){const l=(f-
C)*d+g-G,h=a[l];if(0===h||O&&(!c||c[b+g]))continue;const k=n[l]/h;B[b+g]=m?Math.sqrt((e[l]-n[l]*k)/h):k;c&&(c[b+g]=255)}}}break;case "median":oa(ca,r);break;case "majority":case "minority":a:{var ha=r;const {fillNoDataOnly:O}=ha,{band:p,width:d,height:A,mask:c,outBand:B}=ca;if(O&&!c){B.set(p);break a}const {kernelRows:T,kernelCols:D}=ha,y=Math.floor(T/2),m=Math.floor(D/2),t="majority"===ha.statisticsType,J=T*D,E=B.slice(),F=new Uint32Array(d*A);for(let n=y;n<A-y;n++){const e=n*d;for(let a=m;a<d-m;a++){if(O&&
c&&c[e+a])continue;const u=new Map;for(let b=0;b<T;b++)for(let g=0;g<D;g++){const l=e+a+(b-y)*d+g-m;if(c&&!c[l])continue;const h=p[l];u.set(h,u.has(h)?u.get(h)+1:1)}if(0===u.size)continue;let C=0,G=0,f=t?0:J+1;for(const b of u.keys())G=u.get(b),t===G>f&&(f=G,C=b);c?(E[e+a]=C,F[e+a]=u.size):B[e+a]=C}}if(c)for(let n=y;n<A-y;n++){const e=n*d;for(let a=m;a<d-m;a++)!F[e+a]||O&&c[e+a]||(B[e+a]=E[e+a],c[e+a]=255)}}}I&&!U&&na.mirror(N,Q,v,M,w);X.push(N);fa&&x.push(fa)}let da=x[0]??P;x.length!==V&&(x.length=
0);if(1<V&&H?.length){da=new Uint8Array(W);da.set(x[0]);for(let S=1;S<H.length;S++){const Z=H[S];for(let N=0;N<Z.length;N++)0===Z[N]&&(da[N]=0)}}const la=new ja({pixelType:R,width:Q,height:v,pixels:X,bandMasks:H&&x.length?x:null,mask:da});la.updateStatistics();return la};ea.statisticsTypeMap=ia;Object.defineProperty(ea,Symbol.toStringTag,{value:"Module"})});