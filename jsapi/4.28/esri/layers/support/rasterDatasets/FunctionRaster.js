// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/Error ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./BaseRaster ../rasterFunctions/pixelUtils ../../../rest/support/FeatureSet".split(" "),function(q,u,r,n,z,A,v,w,x,y){n=class extends w{constructor(){super(...arguments);this.datasetFormat="Function";this.tileType="Raster";this.rasterFunction=null}async open(p){await this.init();
const {rasterFunction:b}=this;this.primaryRasters?.rasters?.length?b.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=b.getPrimaryRasters(),this.rasterJobHandler&&this.primaryRasters.rasters?.forEach(a=>a.rasterJobHandler=this.rasterJobHandler));const {rasters:h,rasterIds:c}=this.primaryRasters;var f=h.map(a=>a.rasterInfo?void 0:a.open(p));await Promise.all(f);f=h.map(({rasterInfo:a})=>a);var k=b.bind({rasterInfos:f,rasterIds:c});if(!k.success||0===f.length)throw new u("raster-function:open",
`cannot bind the function: ${k.error??""}`);k="Table"===b.functionName?b:b.functionArguments?.raster;"Table"===k?.functionName&&(b.rasterInfo.attributeTable=y.fromJSON(k.functionArguments.attributeTableAsRecordSet));await this.syncJobHandler();const d=f[0];this.hasUniqueSourceStorageInfo=1===f.length||f.slice(1).every(a=>this._hasSameStorageInfo(a,d));this.set("sourceJSON",h[0].sourceJSON);this.set("rasterInfo",b.rasterInfo)}async syncJobHandler(){return this.rasterJobHandler?.updateRasterFunction(this.rasterFunction)}async fetchPixels(p,
b,h,c={}){const {rasters:f,rasterIds:k}=this.primaryRasters;var d=!1,{interpolation:a}=c,e=this.rasterFunction.flatWebGLFunctionChain?.hasFocalFunction;!c.requestRawData&&"bilinear"!==a&&e&&(d=1===f.length&&!c.skipRasterFunction,c={...c,interpolation:"bilinear",requestRawData:d});e=f.map(l=>l.fetchPixels(p,b,h,c));e=await Promise.all(e);var g=e.map(l=>l.pixelBlock),m=d||c.requestRawData?e.map(l=>l.srcTilePixelSize):null;if(c.skipRasterFunction||g.every(l=>null==l))return e[0];const t=e.find(l=>null!=
l.pixelBlock)?.extent??p;g=this.rasterJobHandler?await this.rasterJobHandler.process({extent:t,primaryPixelBlocks:g,primaryPixelSizes:m,primaryRasterIds:k}):this.rasterFunction.process({extent:t,primaryPixelBlocks:g,primaryPixelSizes:m,primaryRasterIds:k});({transformGrid:m}=e[0]);if(!d||null==g||null==m)return{...e[0],pixelBlock:g};d={rows:m.spacing[0],cols:m.spacing[1]};a=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[g],srcMosaicSize:{width:g.width,height:g.height},
destDimension:{width:b,height:h},coefs:m.coefficients,sampleSpacing:d,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:a,alignmentInfo:void 0,blockWidths:null},c)).pixelBlock:x.approximateTransform(g,{width:b,height:h},m.coefficients,d,a);return{extent:p,srcExtent:e[0].srcExtent,pixelBlock:a}}_hasSameStorageInfo(p,b){const {storageInfo:h,pixelSize:c,spatialReference:f,extent:k}=p,{storageInfo:d,pixelSize:a,spatialReference:e,extent:g}=b;return c.x===a.x&&c.y===a.y&&f.equals(e)&&k.equals(g)&&
h.blockHeight===d.blockHeight&&h.blockWidth===d.blockWidth&&h.maximumPyramidLevel===d.maximumPyramidLevel}};q.__decorate([r.property({type:String,json:{write:!0}})],n.prototype,"datasetFormat",void 0);q.__decorate([r.property()],n.prototype,"tileType",void 0);q.__decorate([r.property()],n.prototype,"rasterFunction",void 0);q.__decorate([r.property()],n.prototype,"primaryRasters",void 0);return n=q.__decorate([v.subclass("esri.layers.support.rasterDatasets.FunctionRaster")],n)});