// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/has ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ./BaseRaster ./InMemoryRaster ./pamParser ../rasterFormats/RasterCodec ../rasterFunctions/stretchUtils ../rasterTransforms/PolynomialTransform ../../../geometry/SpatialReference ../../../geometry/Extent".split(" "),function(l,
g,m,q,n,r,E,F,t,u,v,w,x,y,z,A,B){g=class extends u{async open(b){await this.init();var a=await this._fetchData(b);let {spatialReference:c,statistics:d,histograms:f,transform:e}=await this._fetchAuxiliaryData(b);(b=!c)&&(c=new A({wkid:3857}));f?.length&&null==d&&(d=y.estimateStatisticsFromHistograms(f));const {width:C,height:D}=a;let h=new B({xmin:-.5,ymin:.5-D,xmax:C-.5,ymax:.5,spatialReference:c});const p=e?e.forwardTransform(h):h;var k=!0;e&&(k=(k=e.forwardCoefficients)&&0===k[1]&&0===k[2])&&(e=
null,h=p);a=new v({data:{extent:p,nativeExtent:h,transform:e,pixelBlock:a,statistics:d,histograms:f,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:b}});await a.open();a.data=null;this._set("rasterInfo",a.rasterInfo);this._inMemoryRaster=a}fetchRawTile(b,a,c,d={}){return this._inMemoryRaster.fetchRawTile(b,a,c,d)}async _fetchData(b){({data:b}=await this.request(this.url,{responseType:"array-buffer",signal:b?.signal}));var a=x.getFormat(b).toUpperCase();if("JPG"===a||"PNG"===a||"GIF"===
a||"BMP"===a)this._set("datasetFormat",a);else throw new m("image-aux-raster:open","the data is not a supported format");a=a.toLowerCase();const c="gif"===a||"bmp"===a||!q("ios");b=await this.decodePixelBlock(b,{format:a,useCanvas:c,hasNoZlibMask:!0});if(null==b)throw new m("image-aux-raster:open","the data cannot be decoded");return b}async _fetchAuxiliaryData(b){b=b?.signal;var a=this.ioConfig.skipExtensions??[],c=a.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:b}),
d=this.datasetFormat;a=(d="JPG"===d?"jgw":"PNG"===d?"pgw":"BMP"===d?"bpw":null)&&a.includes(d)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+d,{responseType:"text",signal:b});c=await n.eachAlways([c,a]);if(b?.aborted)throw n.createAbortError();b=w.parsePAMInfo(c[0].value?.data);b.transform||(c=c[1].value?c[1].value.data.split("\n").slice(0,6).map(f=>Number(f)):null,b.transform=6===c?.length?new z({forwardCoefficients:[c[4],c[5],c[0],-c[1],c[2],-c[3]]}):null);return b}};l.__decorate([r.property({type:String,
json:{write:!0}})],g.prototype,"datasetFormat",void 0);return g=l.__decorate([t.subclass("esri.layers.support.rasterDatasets.ImageAuxRaster")],g)});