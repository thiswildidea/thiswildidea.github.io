// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require ../chunks/tslib.es6 ../core/Clonable ../core/Collection ../core/Error ../core/loadAll ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/sql ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/PropertyOrigin ./Layer ./mixins/APIKeyMixin ./mixins/ArcGISService ./mixins/BlendLayer ./mixins/CustomParametersMixin ./mixins/EditBusLayer ./mixins/FeatureLayerBase ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/featureLayerUtils ./support/fieldProperties ./support/fieldUtils ./support/SubtypeSublayer ./support/TimeInfo ./support/versionUtils ../rest/support/Query ../webdoc/interfaces".split(" "),
function(v,f,d,q,l,z,A,r,w,B,x,g,m,Z,aa,C,D,t,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,h,S,T,n,U,V,W,p){function y(a,b){return new l("layer:unsupported",`Layer (${a.title}, ${a.id}) of type '${a.declaredClass}' ${b}`,{layer:a})}m=S.defineFieldProperties();d=class extends K.FeatureLayerBase(J.EditBusLayer(H.BlendLayer(P.TemporalLayer(O.ScaleRangeLayer(N.RefreshableLayer(G.ArcGISService(L.OperationalLayer(M.PortalLayer(A.MultiOriginJSONMixin(I.CustomParametersMixin(F.APIKeyMixin(d.ClonableMixin(E))))))))))))){constructor(...a){super(...a);
this._sublayersCollectionChanged=!1;this._sublayerLookup=new Map;this.outFields=this.fieldsIndex=this.fields=null;this.sublayers=new (q.ofType(n));this.timeInfo=null;this.title="Layer";this.type="subtype-group";this._debouncedSaveOperations=r.debounce(async(b,c,e)=>{const {save:k,saveAs:u}=await new Promise((X,Y)=>v(["./save/featureLayerUtils"],X,Y));switch(b){case p.SaveOperationType.SAVE:return k(this,c);case p.SaveOperationType.SAVE_AS:return u(this,e,c)}});this.addHandles(w.watch(()=>this.sublayers,
(b,c)=>this._handleSublayersChange(b,c),w.sync))}destroy(){this.source?.destroy()}normalizeCtorArgs(a,b){return"string"===typeof a?{url:a,...b}:a}load(a){const b=null!=a?a.signal:null,c=this.loadFromPortal({supportedTypes:["Feature Service"]},a).catch(r.throwIfAbortError).then(async()=>{if(!this.url)throw new l("subtype-grouplayer:missing-url-or-source","SubtypeGroupLayer must be created with either a url or a portal item");if(null==this.layerId)throw new l("subtype-grouplayer:missing-layerid","layerId is required for a SubtypeGroupLayer created with url");
return this._initLayerProperties(await this.createGraphicsSource(b))}).then(()=>h.ensureLayerCredential(this,"load",a));this.addResolvingPromise(c);return Promise.resolve(this)}get createQueryVersion(){this.commitProperty("definitionExpression");this.commitProperty("timeExtent");this.commitProperty("timeOffset");this.commitProperty("geometryType");this.commitProperty("gdbVersion");this.commitProperty("historicMoment");this.commitProperty("returnZ");this.commitProperty("capabilities");this.commitProperty("returnM");
return(this._get("createQueryVersion")??0)+1}get editingEnabled(){return this.loaded&&null!=this.capabilities&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}get effectiveEditingEnabled(){return h.computeEffectiveEditingEnabled(this)}get parsedUrl(){const a=x.urlToObject(this.url);null!=a&&null!=this.layerId&&(a.path=x.join(a.path,this.layerId.toString()));return a}set source(a){this._get("source")!==a&&this._set("source",a)}readTitleFromService(a,{name:b}){return this.url?
Q.titleFromUrlAndName(this.url,b):b}async addAttachment(a,b){return h.addAttachment(this,a,b,"SubtypeGroupLayer")}async updateAttachment(a,b,c){return h.updateAttachment(this,a,b,c,"SubtypeGroupLayer")}async applyEdits(a,b){return h.applyEdits(this,a,b)}on(a,b){return super.on(a,b)}async createGraphicsSource(a){const {default:b}=await r.whenOrAbort(new Promise((c,e)=>v(["./graphics/sources/FeatureLayerSource"],k=>c(Object.freeze(Object.defineProperty({__proto__:null,default:k},Symbol.toStringTag,
{value:"Module"}))),e)),a);return(new b({layer:this})).load({signal:a})}createQuery(){const a=h.createQuery(this),b=this.sublayers.map(c=>c.subtypeCode);a.where=B.sqlAnd(`${this.subtypeField} IN (${b.join(",")})`,this.definitionExpression);return a}async deleteAttachments(a,b){return h.deleteAttachments(this,a,b,"SubtypeGroupLayer")}async fetchRecomputedExtents(a){return h.fetchRecomputedExtents(this,a,"SubtypeGroupLayer")}findSublayerForFeature(a){const b=this.fieldsIndex.get(this.subtypeField);
return this.findSublayerForSubtypeCode(a.attributes[b.name])}findSublayerForSubtypeCode(a){return this._sublayerLookup.get(a)}getFieldDomain(a,b){return this._getLayerDomain(a)}getField(a){return this.fieldsIndex.get(a)}loadAll(){return z.loadAll(this,a=>{a(this.sublayers)})}async queryAttachments(a,b){return h.queryAttachments(this,a,b,"SubtypeGroupLayer")}async queryFeatures(a,b){const c=await this.load();a=W.from(a)??c.createQuery();const e=a.outFields??[];e.includes(this.subtypeField)||(e.push(this.subtypeField),
a.outFields=e);b=await c.source.queryFeatures(a,b);if(b?.features)for(const k of b.features)k.layer=k.sourceLayer=this.findSublayerForFeature(k);return b}async queryObjectIds(a,b){return h.queryObjectIds(this,a,b,"SubtypeGroupLayer")}async queryFeatureCount(a,b){return h.queryFeatureCount(this,a,b,"SubtypeGroupLayer")}async queryExtent(a,b){return h.queryExtent(this,a,b,"SubtypeGroupLayer")}async queryRelatedFeatures(a,b){return h.queryRelatedFeatures(this,a,b,"SubtypeGroupLayer")}async queryRelatedFeaturesCount(a,
b){return h.queryRelatedFeaturesCount(this,a,b,"SubtypeGroupLayer")}async save(a){return this._debouncedSaveOperations(p.SaveOperationType.SAVE,a)}async saveAs(a,b){return this._debouncedSaveOperations(p.SaveOperationType.SAVE_AS,b,a)}write(a,b){const {origin:c,layerContainerType:e,messages:k}=b;if(this.isTable){if("web-scene"===c||"web-map"===c&&"tables"!==e)return k?.push(y(this,"using a table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&"web-map"===c&&"tables"===
e)return k?.push(y(this,"using a non-table source cannot be written to tables in web maps")),null;return this.sublayers?.length?super.write(a,b):(k?.push(new l("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)}serviceSupportsSpatialReference(a){return this.loaded?V.serviceSupportsSpatialReference(this,a):!1}_getLayerDomain(a){return(a=
this.fieldsIndex.get(a))?a.domain:null}async _initLayerProperties(a){this._set("source",a);({sourceJSON:a}=a);a&&(this.sourceJSON=a,this.read(a,{origin:"service",url:this.parsedUrl}));if(this.isTable)throw new l("subtype-grouplayer:unsupported-source","SubtypeGroupLayer cannot be created using a layer with table source");if(!this.subtypes?.length)throw new l("subtype-grouplayer:missing-subtypes","SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields();T.fixTimeInfoFields(this.timeInfo,
this.fieldsIndex)}async hasDataChanged(){return h.hasDataChanged(this)}_verifyFields(){const a=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+a+")");this.isTable||-1!==a.search(/\/FeatureServer\//i)||this.fields?.some(b=>"geometry"===b.type)||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+
a+")")}_handleSublayersChange(a,b){b&&(b.forEach(c=>{c.parent=null}),this.removeHandles("sublayers-owner"),this._sublayerLookup.clear());a&&(a.forEach(c=>{c.parent=this;this._sublayerLookup.set(c.subtypeCode,c)}),this._sublayersCollectionChanged=!1,this.addHandles([a.on("after-add",({item:c})=>{c.parent=this;this._sublayerLookup.set(c.subtypeCode,c)}),a.on("after-remove",({item:c})=>{c.parent=null;this._sublayerLookup.delete(c.subtypeCode)}),a.on("after-changes",()=>{this._sublayersCollectionChanged=
!0})],"sublayers-owner"))}};f.__decorate([g.property({readOnly:!0})],d.prototype,"createQueryVersion",null);f.__decorate([g.property({readOnly:!0})],d.prototype,"editingEnabled",null);f.__decorate([g.property({readOnly:!0})],d.prototype,"effectiveEditingEnabled",null);f.__decorate([g.property({...m.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],d.prototype,"fields",void 0);f.__decorate([g.property(m.fieldsIndex)],d.prototype,"fieldsIndex",void 0);f.__decorate([g.property(R.id)],
d.prototype,"id",void 0);f.__decorate([g.property({type:["show","hide","hide-children"],json:{origins:{"portal-item":{read:!1,write:!1}}}})],d.prototype,"listMode",void 0);f.__decorate([g.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"],json:{origins:{"portal-item":{name:"layerType",write:{enabled:!0,ignoreOrigin:!0}}}}})],d.prototype,"operationalLayerType",void 0);f.__decorate([g.property(m.outFields)],d.prototype,"outFields",void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,
"parsedUrl",null);f.__decorate([g.property({clonable:!1})],d.prototype,"source",null);f.__decorate([g.property({type:q.ofType(n),json:{origins:{service:{read:{source:"subtypes",reader:(a,b,c)=>{a=a.map(({code:e})=>{e=new n({subtypeCode:e});e.read(b,c);return e});return new (q.ofType(n))(a)}}}},name:"layers",write:{overridePolicy(a,b,c){b=this.originOf("sublayers");const e=t.OriginId.PORTAL_ITEM;let k=!0;t.nameToId(b)===e&&t.nameToId(c.origin)>e&&(a=a.some(u=>u.hasUserOverrides()),k=this._sublayersCollectionChanged||
a);return{enabled:k,ignoreOrigin:!0}}}}})],d.prototype,"sublayers",void 0);f.__decorate([g.property({type:U})],d.prototype,"timeInfo",void 0);f.__decorate([g.property({json:{origins:{"portal-item":{write:{enabled:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],d.prototype,"title",void 0);f.__decorate([C.reader("service","title",["name"])],d.prototype,"readTitleFromService",null);f.__decorate([g.property({json:{read:!1}})],d.prototype,"type",void 0);return d=f.__decorate([D.subclass("esri.layers.SubtypeGroupLayer")],
d)});