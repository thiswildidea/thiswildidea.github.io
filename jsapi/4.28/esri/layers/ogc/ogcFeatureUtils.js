// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../geometry ../../request ../../core/Error ../../core/Logger ../../geometry/support/spatialReferenceUtils ../../geometry/support/webMercatorUtils ../graphics/featureConversionUtils ../graphics/OptimizedFeatureSet ../graphics/sources/geojson/geojson ../graphics/sources/support/clientSideDefaults ../support/FieldsIndex ../support/fieldType ../../time/timeZoneUtils ../../geometry/SpatialReference".split(" "),function(l,Z,t,q,J,K,G,A,L,B,M,N,O,P,u){async function H(b,a,c){const {collection:e,
layerDefinition:f,maxRecordCount:h,queryParameters:{apiKey:n,customParameters:k},spatialReference:d,supportedCrs:r}=b;({links:b}=e);var g=p(b,"items","application/geo+json")||p(b,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==g)throw new q("ogc-feature-layer:missing-items-page","Missing items url");const {geometry:Q,num:R,start:C,timeExtent:S,where:w}=a;if(a.objectIds)throw new q("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");
b=u.fromJSON(d);a=a.outSpatialReference??b;b=a.isWGS84?null:I(a,r);var x=T(Q,r);const V=U(S);({data:g}=await t(g.href,{...c,query:{...k,...x,crs:b,datetime:V,query:null!=w&&w&&"1\x3d1"!==w?w:null,limit:R??(null!=C&&void 0!==C?10:h),startindex:C,token:n},headers:{accept:"application/geo+json"}}));c=!1;g.links&&(c=!!g.links.find(W=>"next"===W.rel));!c&&Number.isInteger(g.numberMatched)&&Number.isInteger(g.numberReturned)&&(c=g.numberReturned<g.numberMatched);const {fields:X,geometryType:y,hasZ:D,objectIdField:E}=
f;g=B.createOptimizedFeatures(g,{geometryType:y,hasZ:D,objectIdField:E});if(!b&&a.isWebMercator)for(var v of g)null!=v.geometry&&null!=y&&(x=A.convertToGeometry(v.geometry,y,D,!1),x.spatialReference=u.WGS84,v.geometry=A.convertFromGeometry(G.project(x,a)));for(var m of g)m.objectId=m.attributes[E];v=b||!b&&a.isWebMercator?a.toJSON():K.WGS84;m=new L;m.exceededTransferLimit=c;m.features=g;m.fields=X;m.geometryType=y;m.hasZ=D;m.objectIdFieldName=E;m.spatialReference=v;return m}function I(b,a){const {isWebMercator:c,
wkid:e}=b;return e?(b=c?a[3857]??a[102100]??a[102113]??a[900913]:a[b.wkid])?`${"http://www.opengis.net/def/crs/"}${b}`:null:null}function F(b){if(null==b)return"";const {xmin:a,ymin:c,xmax:e,ymax:f}=b;return`${a},${c},${e},${f}`}function U(b){if(null==b)return null;const {start:a,end:c}=b;return`${null!=a?a.toISOString():".."}/${null!=c?c.toISOString():".."}`}function T(b,a){if(null==b||"extent"!==b.type)return null;const {spatialReference:c}=b;if(!c||c.isWGS84)return{bbox:F(b)};a=I(c,a);return null!=
a?{bbox:F(b),"bbox-crs":a}:c.isWebMercator?{bbox:F(G.project(b,u.WGS84))}:null}function Y(b){b=b.extent?.spatial;if(!b)return null;var a=b.bbox[0],c=4===a.length;b=a[0];const e=a[1],f=c?void 0:a[2],h=c?a[2]:a[3],n=c?a[3]:a[4];a=c?void 0:a[5];c=u.WGS84.toJSON();return{xmin:b,ymin:e,xmax:h,ymax:n,zmin:f,zmax:a,spatialReference:c}}function p(b,a,c){return b.find(e=>e.rel===a&&e.type===c)||b.find(e=>e.rel===a&&!e.type)}const z=J.getLogger("esri.layers.graphics.sources.ogcfeature");l.crsDefault="http://www.opengis.net/def/crs/OGC/1.3/CRS84";
l.crsPrefix="http://www.opengis.net/def/crs/";l.getCollectionDefinition=async function(b,a,c={},e=5){var {links:f}=b;f=p(f,"items","application/geo+json")||p(f,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==f)throw new q("ogc-feature-layer:missing-items-page","Missing items url");({data:c}=await t(f.href,{signal:c.signal,query:{limit:e,...c.customParameters,token:c.apiKey},headers:{accept:"application/geo+json"}}));B.validateGeoJSON(c);const h=B.inferLayerProperties(c,
{geometryType:a.geometryType});c=a.fields||h.fields||[];e=null!=a.hasZ?a.hasZ:h.hasZ;f=h.geometryType;const n=a.objectIdField||h.objectIdFieldName||"OBJECTID";a=a.timeInfo;var k=c.find(({name:g})=>g===n);if(k)k.editable=!1,k.nullable=!1;else{if(!h.objectIdFieldType)throw new q("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");c.unshift({name:n,alias:n,type:"number"===h.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}n!==
h.objectIdFieldName&&(k=c.find(({name:g})=>g===h.objectIdFieldName))&&(k.type="esriFieldTypeInteger");c===h.fields&&0<h.unknownFields.length&&z.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:h.unknownFields}});for(var d of c){null==d.name&&(d.name=d.alias);null==d.alias&&(d.alias=d.name);"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&(d.editable=null==d.editable||!!d.editable,
d.nullable=null==d.nullable||!!d.nullable);if(!d.name)throw new q("ogc-feature-layer:invalid-field-name","field name is missing",{field:d});if(!O.kebabDict.jsonValues.includes(d.type))throw new q("ogc-feature-layer:invalid-field-type",`invalid type for field "${d.name}"`,{field:d});}if(a){var r;d=new N(c);a.startTimeField&&((k=d.get(a.startTimeField))?(a.startTimeField=k.name,k.type="esriFieldTypeDate"):a.startTimeField=null);a.endTimeField&&((k=d.get(a.endTimeField))?(a.endTimeField=k.name,k.type=
"esriFieldTypeDate"):a.endTimeField=null);a.trackIdField&&((d=d.get(a.trackIdField))?a.trackIdField=d.name:(a.trackIdField=null,z.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:a}})));(r=a).timeReference||(r.timeReference={timeZoneIANA:P.utc});a.startTimeField||a.endTimeField||(z.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:a}}),a=null)}r=f?M.createDrawingInfo(f):
null;b=Y(b);return{drawingInfo:r,extent:b,geometryType:f,fields:c,hasZ:!!e,objectIdField:n,timeInfo:a}};l.getServerCollections=async function(b,a={}){({links:b}=b);b=p(b,"data","application/json")||p(b,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==b)throw new q("ogc-feature-layer:missing-collections-page","Missing collections url");const {apiKey:c,customParameters:e,signal:f}=a;({data:a}=await t(b.href,{signal:f,headers:{accept:"application/json"},query:{...e,token:c}}));
return a};l.getServerConformance=async function(b,a={}){({links:b}=b);b=p(b,"conformance","application/json")||p(b,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(null==b)throw new q("ogc-feature-layer:missing-conformance-page","Missing conformance url");const {apiKey:c,customParameters:e,signal:f}=a;({data:a}=await t(b.href,{signal:f,headers:{accept:"application/json"},query:{...e,token:c}}));return a};l.getServerLandingPage=async function(b,a={}){const {apiKey:c,customParameters:e,
signal:f}=a;({data:b}=await t(b,{signal:f,headers:{accept:"application/json"},query:{...e,token:c}}));return b};l.getServerOpenApi=async function(b,a={}){b=p(b.links,"service-desc","application/vnd.oai.openapi+json;version\x3d3.0");if(null==b)return z.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const {apiKey:c,customParameters:e,signal:f}=a;({data:a}=await t(b.href,{signal:f,headers:{accept:"application/vnd.oai.openapi+json;version\x3d3.0"},
query:{...e,token:c}}));return a};l.getSpatialReferenceWkid=function(b){b=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(b)?.groups;if(!b)return null;const {authority:a,code:c}=b;switch(a.toLowerCase()){case "ogc":switch(c.toLowerCase()){case "crs27":return u.GCS_NAD_1927.wkid;case "crs83":return 4269;case "crs84":case "crs84h":return u.WGS84.wkid;default:return null}case "esri":case "epsg":return b=Number.parseInt(c,10),Number.isNaN(b)?null:b;default:return null}};
l.queryFeatureSetJSON=async function(b,a,c){b=await H(b,a,c);return A.convertToFeatureSet(b)};l.queryOptimizedFeatureSet=H;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});