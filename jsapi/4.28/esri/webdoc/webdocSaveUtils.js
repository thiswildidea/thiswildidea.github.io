// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require exports ../core/Error ../core/MultiOriginJSONSupport ../core/reactiveUtils ../core/urlUtils ../core/accessorSupport/originUtils ../geometry/SpatialReference ../geometry/support/spatialReferenceUtils ../geometry/support/webMercatorUtils ../layers/support/arcgisLayerUrl ../layers/support/layerUtils ../portal/Portal ../portal/PortalItem ../portal/support/portalItemUtils ../rest/geometryService/project ../rest/support/ProjectParameters ../support/basemapUtils ./saveAPIKeyUtils ./support/saveUtils".split(" "),
function(E,m,k,F,n,p,G,H,I,J,K,q,t,L,f,M,N,r,u,l){function O(b,a){if(!a.portalItem)throw new k(`${b.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");u.validateSaveAPIKey(a.portalItem);v(b,a.portalItem)}function v(b,a){if(a.type!==b.itemType)throw new k(`${b.name}:portal-item-wrong-type`,`Portal item needs to have type "${b.itemType}"`);}async function w(b,a){if(!a.basemap?.baseLayers.length)throw new k(`${b.name}:save`,"Map does not have a valid basemap with a base layer.");
let c=null;await n.whenOnce(()=>{const d=r.findSpatialReference(a.initialViewProperties,a.basemap);c=d.spatialReference;return!d.updating});if(!I.equals(c,a.initialViewProperties.spatialReference))throw new k(`${b.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:a.initialViewProperties.spatialReference,actual:c});}function P(b,a){a=L.from(a);a.id&&(a=a.clone(),a.id=null);a.type||(a.type=b.itemType);a.portal||(a.portal=t.getDefault());u.validateSaveAPIKey(a);
v(b,a);return a}function x(b){const a=[];b.basemap&&a.push(b.basemap.load());b.ground&&a.push(b.ground.load());return Promise.allSettled(a).then(()=>{})}function y(b,a,c){let d=(a.messages??[]).filter(e=>"error"===e.type).map(e=>new k(e.name,e.message,e.details));a.blockedRelativeUrls&&(d=d.concat(a.blockedRelativeUrls.map(e=>new k("url:unsupported",`Relative url '${e}' is not supported in Web Map`))));c.ignoreUnsupported&&(d=d.filter(e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&
"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name));if(0<d.length)throw new k(`${b.name}:save`,"Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:d});}async function z(b,a){a.extent=await Q(b.portalItem,b.initialViewProperties.viewpoint.targetGeometry);await R(b,a)}async function S(b,a){f.removeTypeKeyword(a,"CollectorDisabled");f.removeTypeKeyword(a,"FieldMapsDisabled");f.removeTypeKeyword(a,
f.TypeKeyword.METADATA);f.removeTypeKeyword(a,"OfflineDisabled");f.removeTypeKeyword(a,"Offline Map Areas");f.removeTypeKeyword(a,"Workforce Dispatcher");f.removeTypeKeyword(a,"Workforce Project");f.removeTypeKeyword(a,"Workforce Worker");await z(b,a)}async function R(b,a){f.addTypeKeyword(a,T);await U(b);V(b,a);W(b,a);X(b,a);Y(b,a);Z(b,a);a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter((c,d,e)=>e.indexOf(c)===d))}function U(b){b=b.allLayers.concat(b.allTables).map(a=>a.load()).toArray();return Promise.allSettled(b).then(()=>
{})}function A(b){return b.allLayers.concat(b.allTables).some(a=>a.loaded&&q.isLayerWithFeatureLayerSource(a)&&a.capabilities.operations.supportsEditing&&a.editingEnabled&&("subtype-group"!==a.type||a.sublayers.some(c=>c.editingEnabled)))}function aa(b){return b.allLayers.concat(b.allTables).filter(a=>"group"!==a.type).every(a=>{var c;if(c=a.loaded)(c=q.isLayerWithFeatureLayerSource(a)&&a.capabilities.operations.supportsSync)||(c=(q.isFeatureCollectionLayer(a)||"map-notes"===a.type||"route"===a.type)&&
!a.portalItem),c=c||("tile"===a.type||"vector-tile"===a.type)&&(a.capabilities.operations.supportsExportTiles||ba(a)||r.isDeveloperBasemapLayer(a))&&a.spatialReference.equals(b.initialViewProperties.spatialReference);return c})}function V(b,a){f.hasTypeKeyword(a,"CollectorDisabled")||f.hasTypeKeyword(a,"Workforce Project")||f.hasTypeKeyword(a,"Workforce Worker")||f.hasTypeKeyword(a,"Workforce Dispatcher")||!A(b)?f.removeTypeKeyword(a,"Collector"):f.addTypeKeyword(a,"Collector")}function W(b,a){A(b)?
f.addTypeKeyword(a,"Data Editing"):f.removeTypeKeyword(a,"Data Editing")}function X(b,a){!f.hasTypeKeyword(a,"OfflineDisabled")&&aa(b)?f.addTypeKeyword(a,"Offline"):f.removeTypeKeyword(a,"Offline")}function Y(b,a){r.hasDeveloperBasemapLayer(b.basemap)?f.addTypeKeyword(a,B):f.removeTypeKeyword(a,B)}function Z(b,a){b.utilityNetworks?.length?f.addTypeKeyword(a,"UtilityNetwork"):f.removeTypeKeyword(a,"UtilityNetwork")}async function Q(b,a){a=a.clone().normalize();let c;if(1<a.length)for(const d of a)c?
d.width>c.width&&(c=d):c=d;else c=a[0];return ca(b,c)}async function ca(b,a){var c=a.spatialReference;if(c.isWGS84)return a.clone();if(c.isWebMercator)return J.webMercatorToGeographic(a);({getGeometryServiceURL:c}=await new Promise((d,e)=>E(["../portal/support/geometryServiceUtils"],d,e)));b=await c(b);c=new N;c.geometries=[a];c.outSpatialReference=H.WGS84;return(await M.project(b,c))[0]}function ba(b){return"tile"===b.type?K.isServerOrServicesAGOLUrl(b.url)&&da.some(a=>b.url?.toLowerCase().includes("/"+
a+"/")):!1}async function ea(b,a,c,d,e){await c.update({data:d});C(b,a,c,d,e)}async function fa(b,a,c,d,e,h){var g=a.portalItem;g={item:g,authenticated:!(!g?.id||!g.portal.user)};const D=c.portal;await D.signIn();const {copyAllowed:ha,itemReloaded:ia}=await ja(g,D);g.authenticated||(g.authenticated=ia);if(!ha)throw new k(`${b.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");h=await ka(c,g,d,h);a.portalItem=c;C(b,a,c,d,e);return h}async function ja(b,a){const {item:c,
authenticated:d}=b;if(c?.id&&c.typeKeywords?.includes("useOnly")){if(c.portal.portalHostname!==a.portalHostname)return{copyAllowed:!1,itemReloaded:!1};d||await c.reload();return{copyAllowed:"admin"===c.itemControl||"update"===c.itemControl,itemReloaded:!0}}return{copyAllowed:!0,itemReloaded:!1}}async function ka(b,a,c,d){var e=b.portal;({item:a}=a);const {folder:h,copyAllResources:g}=d;d=!1;g&&a?.id&&p.hasSameCanonicalPortal(a.portal.url,e.url)&&2023<=parseInt(a.portal.currentVersion,10)&&({total:d}=
await a.fetchResources(),d=!!d);d?(e=await a.copy({copyResources:"all",folder:h}),b.id=e.id,b.portal=e.portal,e=b.toJSON(),await b.load(),b.read(e),await b.update({data:c})):await e.user?.addItem({item:b,folder:h,data:c});return d}function C(b,a,c,d,e){F.MultiOriginJSONSupport.prototype.read.call(a,{version:d.version,authoringApp:d.authoringApp,authoringAppVersion:d.authoringAppVersion},{origin:b.origin,ignoreDefaults:!0,url:c.itemUrl?p.urlToObject(c.itemUrl):void 0});G.updateOrigins(e);a.resourceInfo=
d}const da="NatGeo_World_Map Ocean_Basemap USA_Topo_Maps World_Imagery World_Street_Map World_Terrain_Base World_Topo_Map World_Hillshade Canvas/World_Light_Gray_Base Canvas/World_Light_Gray_Reference Canvas/World_Dark_Gray_Base Canvas/World_Dark_Gray_Reference Ocean/World_Ocean_Base Ocean/World_Ocean_Reference Reference/World_Boundaries_and_Places Reference/World_Reference_Overlay Reference/World_Transportation".split(" ").map(b=>b.toLowerCase()),T=f.TypeKeyword.JSAPI,B=f.TypeKeyword.DEVELOPER_BASEMAP;
m.save=async function(b,a,c){c??(c={});O(b,a);await n.whenOnce(()=>!a.updatingFromView);await a.load();await x(a);await l.beforeSave(a);await w(b,a);const d=a.portalItem;var e=p.urlToObject(d.itemUrl);e={origin:"web-map",messages:[],writtenProperties:[],url:e,portal:d.portal||t.getDefault(),portalItem:d,verifyItemRelativeUrls:e?{rootPath:e.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}};const h=a.write({},e);await Promise.all(e.resources.pendingOperations);
y(b,e,c);await z(a,d);await ea(b,a,d,h,e);await Promise.all([a.updateItemThumbnail(),l.saveResources(a.resourceReferences,e,null)]);return d};m.saveAs=async function(b,a,c,d){d??(d={});c=P(b,c);await n.whenOnce(()=>!a.updatingFromView);await a.load();await x(a);await l.beforeSave(a);await w(b,a);const e={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:c.portal,portalItem:c,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},h=a.write({},e);await Promise.all(e.resources.pendingOperations);
y(b,e,d);await S(a,c);const g=a.getThumbnailState();await fa(b,a,c,h,e,d)&&(a.resourceReferences.portalItem=c);a.restoreThumbnailFromState(g);await Promise.all([a.updateItemThumbnail(),l.saveResources(a.resourceReferences,e,null)]);return c};Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});