// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../core/asyncUtils ../../core/Error ../../core/promiseUtils ../../core/uuid ../../portal/support/resourceUtils".split(" "),function(h,m,u,k,v,l){async function n(a,b,d=null){if(b?.resources){var e=b.portalItem===a.portalItem?new Set(a.paths):new Set;a.paths.length=0;a.portalItem=b.portalItem;var f=new Set(b.resources.toKeep.map(c=>c.resource.path)),p=new Set,g=[];f.forEach(c=>{e.delete(c);a.paths.push(c)});for(const c of b.resources.toUpdate)if(e.delete(c.resource.path),f.has(c.resource.path)||
p.has(c.resource.path)){const {resource:w,content:x,finish:y,error:z}=c,q=l.getSiblingOfSameTypeI(w,v.generateUUID());a.paths.push(q.path);g.push(r({resource:q,content:x,compress:c.compress,finish:y,error:z},d))}else a.paths.push(c.resource.path),g.push(A(c,d)),p.add(c.resource.path);for(const c of b.resources.toAdd)a.paths.push(c.resource.path),e.has(c.resource.path)?e.delete(c.resource.path):g.push(r(c,d));if(0===g.length)return e;b=await k.allSettledErrors(g);k.throwIfAborted(d);if(0<b.length)throw new u("save:resources",
"Failed to save one or more resources",{errors:b});return e}}async function t(a,b,d=null){if(a&&b.portalItem){var e=[];for(const f of a)a=b.portalItem.resourceFromPath(f),e.push(a.portalItem.removeResource(a,d));await k.eachAlways(e)}}async function r(a,b){b={...(null!=b?b:{}),compress:a.compress};b=await m.result(a.resource.portalItem.addResource(a.resource,await l.contentToBlob(a.content),b));if(!0===b.ok)a.finish?.(a.resource);else throw a.error?.(b.error),b.error;}async function A(a,b){b=await m.result(a.resource.update(await l.contentToBlob(a.content),
b));if(!0===b.ok)a.finish?.(a.resource);else throw a.error?.(b.error),b.error;}h.beforeSave=async function(a){const b=[];for(const d of a.allLayers)"beforeSave"in d&&"function"===typeof d.beforeSave&&(a=d.beforeSave())&&b.push(a);await Promise.allSettled(b)};h.saveResources=async function(a,b,d=null){a=await n(a,b,d);await t(a,b,d)};h.updateItemWithResources=async function(a,b,d,e,f=null){d=await n(d,e,f);await a.update({data:b});await t(d,e,f)};Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});