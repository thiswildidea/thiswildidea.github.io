// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../Color ../../../request ../../../core/MapUtils ../../../core/mathUtils ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../MeshComponent ../MeshMaterialMetallicRoughness ../MeshTexture ../MeshTextureTransform ../MeshVertexAttributes ../buffer/BufferView ../../../chunks/vec32 ../../../chunks/vec42 ../buffer/utils ./georeference ../../../views/3d/glTF/DefaultLoadingContext ../../../views/3d/glTF/loader ../../../views/3d/glTF/internal/indexUtils ../../../views/3d/glTF/internal/resourceUtils ../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../../views/webgl/enums ../../../chunks/vec33 ../../../chunks/vec43 ../../../chunks/vec22".split(" "),
function(F,G,N,H,C,I,J,O,P,Q,R,S,T,U,m,x,A,y,V,W,X,Y,Z,aa,D,K,B,L){function ba(a){const c=a?.resolveFile,g=a?.requestFile;return c||g?{busy:!1,request:async(b,f,d)=>{b=c?.(b)??b;if(g){const e=await g(b,f,d?.signal);if(void 0!==e)return e}return(await N(b,{responseType:"image"===f?"image":"binary"===f?"array-buffer":"json",signal:null!=d?d.signal:null})).data}}:null}function z(a,c){if(null==a)return"-";a=a.typedBuffer;return`${H.getOrCreateMapValue(c,a.buffer,()=>c.size)}/${a.byteOffset}/${a.byteLength}`}
function ca(a){return null!=a?a.toString():"-"}function da(a){let c=0;var g=!1,b=!1,f=!1,d=!1;const e=new Map,u=new Map,q=[];for(const l of a.parts){const {attributes:{position:k,normal:v,color:h,tangent:p,texCoord0:t}}=l;a=`\n      ${z(k,e)}/\n      ${z(v,e)}/\n      ${z(h,e)}/\n      ${z(p,e)}/\n      ${z(t,e)}/\n      ${ca(l.transform)}\n    `;let n=!1;a=H.getOrCreateMapValue(u,a,()=>{n=!0;return{start:c,length:k.count}});n&&(c+=k.count);v&&(f=!0);h&&(g=!0);p&&(b=!0);t&&(d=!0);q.push({gltf:l,writeVertices:n,
region:a})}return{vertexAttributes:{position:y.createBuffer(m.BufferViewVec3f64,c),normal:f?y.createBuffer(m.BufferViewVec3f,c):null,tangent:b?y.createBuffer(m.BufferViewVec4f,c):null,color:g?y.createBuffer(m.BufferViewVec4u8,c):null,texCoord0:d?y.createBuffer(m.BufferViewVec2f,c):null},parts:q,components:[]}}function ea(a,c){const g=new G(fa(a.color,a.opacity)),b=a.emissiveFactor?new G(ha(a.emissiveFactor)):null,f=k=>k?new T({scale:k.scale?[k.scale[0],k.scale[1]]:[1,1],rotation:C.rad2deg(k.rotation??
0),offset:k.offset?[k.offset[0],k.offset[1]]:[0,0]}):null;var d=c.get(a.textureColor),e=c.get(a.textureNormal),u=c.get(a.textureEmissive),q=c.get(a.textureOcclusion);a:{switch(a.alphaMode){case "OPAQUE":var l="opaque";break a;case "MASK":l="mask";break a;case "BLEND":l="blend";break a}l=void 0}return new R({color:g,colorTexture:d,normalTexture:e,emissiveColor:b,emissiveTexture:u,occlusionTexture:q,alphaMode:l,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,metallic:a.metallicFactor,roughness:a.roughnessFactor,
metallicRoughnessTexture:c.get(a.textureMetallicRoughness),colorTextureTransform:f(a.colorTextureTransform),normalTextureTransform:f(a.normalTextureTransform),occlusionTextureTransform:f(a.occlusionTextureTransform),emissiveTextureTransform:f(a.emissiveTextureTransform),metallicRoughnessTextureTransform:f(a.metallicRoughnessTextureTransform)})}function ia(a,c,g){if(c.writeVertices){const {position:v,normal:h,tangent:p,color:t,texCoord0:n}=a.vertexAttributes;var b=c.region.start;const {attributes:r,
transform:E}=c.gltf;var f=r.position.count;x.transformMat4View(v.slice(b,f),r.position,E);if(null!=r.normal&&null!=h){var d=I.normalFromMat4(J.create(),E),e=h.slice(b,f);x.transformMat3View(e,r.normal,d);C.hasScaling(d)&&x.normalizeView(e,e)}else null!=h&&K.fill(h,0,0,1,{dstIndex:b,count:f});null!=r.tangent&&null!=p?(d=I.normalFromMat4(J.create(),E),e=p.slice(b,f),A.transformMat3View(e,r.tangent,d),C.hasScaling(d)&&A.normalize(e,e)):null!=p&&B.fill(p,0,0,1,1,{dstIndex:b,count:f});null!=r.texCoord0&&
null!=n?L.normalizeIntegerBufferView(n.slice(b,f),r.texCoord0):null!=n&&L.fill(n,0,0,{dstIndex:b,count:f});null!=r.color&&null!=t?(d=r.color,b=t.slice(b,f),4===d.elementCount?d instanceof m.BufferViewVec4f?A.scaleView(b,d,255):d instanceof m.BufferViewVec4u8?B.copyView(b,d):d instanceof m.BufferViewVec4u16&&A.scaleView(b,d,1/256):(B.fill(b,255,255,255,255),b=m.BufferViewVec3u8.fromTypedArray(b.typedBuffer,b.typedBufferStride),d instanceof m.BufferViewVec3f?x.scaleView(b,d,255):d instanceof m.BufferViewVec3u8?
K.copyView(b,d):d instanceof m.BufferViewVec3u16&&x.scaleView(b,d,1/256))):null!=t&&B.fill(t.slice(b,f),255,255,255,255)}const {indices:u,attributes:q,primitiveType:l,material:k}=c.gltf;b=Y.convertPrimitiveToTriangles(u||q.position.count,l);if(f=c.region.start){d=new Uint32Array(b);for(e=0;e<b.length;e++)d[e]+=f;b=d}a.components.push(new Q({name:c.gltf.name,faces:b,material:g.get(k),shading:q.normal?"source":"flat",trustSourceNormals:!0}))}function M(a){switch(a){case D.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";
case D.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case D.TextureWrapMode.REPEAT:return"repeat"}}function w(a){return 255*a**(1/aa.colorGamma)}function fa(a,c){return P.fromValues(w(a[0]),w(a[1]),w(a[2]),c)}function ha(a){return O.fromValues(w(a[0]),w(a[1]),w(a[2]))}F.loadGLTFMesh=async function(a,c,g){g={...g,useTransform:g?.useTransform??!0};var b=new W.DefaultLoadingContext(ba(g));c=(await X.loadGLTF(b,c,g,!0)).model;b=c.lods.shift();const f=new Map,d=new Map;c.textures.forEach((h,p)=>{var t=
f.set;var n=(Z.isEncodedMeshTexture(h.data),h.data);h=h.parameters.wrap;h={horizontal:M(h.s),vertical:M(h.t)};n=new S({data:n,wrap:h});return t.call(f,p,n)});c.materials.forEach((h,p)=>d.set(p,ea(h,f)));c=da(b);for(var e of c.parts)ia(c,e,d);const {position:u,normal:q,tangent:l,color:k,texCoord0:v}=c.vertexAttributes;e={position:u.typedBuffer,normal:null!=q?q.typedBuffer:null,tangent:null!=l?l.typedBuffer:null,uv:null!=v?v.typedBuffer:null,color:null!=k?k.typedBuffer:null};g=V.georeferenceByTransform(e,
a,g);return{transform:g.transform,vertexSpace:g.vertexSpace,components:c.components,spatialReference:a.spatialReference,vertexAttributes:new U.MeshVertexAttributes({position:g.vertexAttributes.position,normal:g.vertexAttributes.normal,tangent:g.vertexAttributes.tangent,color:e.color,uv:e.uv})}};Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});