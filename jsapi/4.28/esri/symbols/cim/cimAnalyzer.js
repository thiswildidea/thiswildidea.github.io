// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../Color ../../core/fontUtils ../../core/lang ../../core/Logger ../../core/screenUtils ../../core/string ../../support/arcadeOnDemand ./CIMSymbolDrawHelper ./CIMSymbolHelper ./enums ./quantizeTime ./SDFHelper ./utils ./effects/CIMEffectHelper ../../views/2d/arcade/callExpressionWithFeature ../../views/2d/engine/webgl/definitions ../../views/2d/engine/webgl/grouping".split(" "),function(X,ha,ia,V,ja,da,B,R,K,L,M,ka,W,h,ea,U,la,ma){function Y(a){switch(a){case "Butt":return M.CapType.BUTT;
case "Square":return M.CapType.SQUARE;default:return M.CapType.ROUND}}function Z(a){switch(a){case "Bevel":return M.JoinType.BEVEL;case "Miter":return M.JoinType.MITER;default:return M.JoinType.ROUND}}function aa(a){return a&&0===a.indexOf("Level_")&&(a=parseInt(a.substr(6),10),!isNaN(a))?a:0}function F(a){if(!a||0===a.length)return null;a=(new ha(a)).toRgba();return{r:a[0],g:a[1],b:a[2],a:a[3]}}function ba(a){return a?a.charAt(0).toLowerCase()+a.substr(1):a}function na(a){var d=a.symbolLayers;if(!d||
2!==d.length)return!1;a=d.find(c=>c.effects?.find(g=>"CIMGeometricEffectDashes"===g.type));d=d.find(c=>c.effects?.find(g=>"CIMGeometricEffectAddControlPoints"===g.type));return!!a&&!!d}const oa=ja.getLogger("esri.symbols.cim.cimAnalyzer");class pa{constructor(a,d){this._cimLayers=[];this._poMap={};this._primitiveOverrides=[];this._resourceManager=a;this._info=d}async analyzeSymbolReference(a,d,c){this._cimLayers=c??[];if(!a)return this._cimLayers;if(a.primitiveOverrides){this._primitiveOverrides=
a.primitiveOverrides;this._poMap={};c=[];const b=this._info;for(const e of this._primitiveOverrides){var g=e.valueExpressionInfo;g&&b?(g=R.createRendererExpression(g.expression,b.spatialReference,b.fields).then(k=>{null!=k&&this._setPoMap(e.primitiveName,e.propertyName,k)}),c.push(g)):null!=e.value&&this._setPoMap(e.primitiveName,e.propertyName,e.value);0<c.length&&await Promise.all(c)}}a=a.symbol;c=[];L.CIMSymbolHelper.fetchResources(a,this._resourceManager,c);0<c.length&&await Promise.all(c);this._analyzeSymbol(a,
d);return this._cimLayers}_analyzeSymbol(a,d){switch(a?.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":this._analyzeMultiLayerSymbol(a,d,1,0,0,0)}}_analyzeMultiLayerSymbol(a,d,c,g,b,e){const k=a?.symbolLayers;if(k){var f=a.effects,l=M.Alignment.SCREEN,p=L.CIMSymbolHelper.getSize(a)??0;"CIMPointSymbol"===a.type&&"Map"===a.angleAlignment&&(l=M.Alignment.MAP);for(var r="CIMPolygonSymbol"===a.type,n=k.length;n--;){const t=k[n];if(!t||!1===t.enable)continue;let q;f?.length&&(q=
[...f]);var m=t.effects;m?.length&&(f?q.push(...m):q=[...m]);m=[];L.OverrideHelper.findEffectOverrides(q,this._primitiveOverrides,m);m=0<m.length?this._createEffectsOverrideFunction(q,m):q;L.OverrideHelper.findApplicableOverrides(t,this._primitiveOverrides,[]);switch(t.type){case "CIMSolidFill":this._analyzeSolidFill(t,m);break;case "CIMPictureFill":this._analyzePictureFill(t,m);break;case "CIMHatchFill":this._analyzeHatchFill(t,m);break;case "CIMGradientFill":this._analyzeGradientFill(t,m);break;
case "CIMSolidStroke":this._analyzeSolidStroke(t,m,r,p);break;case "CIMPictureStroke":this._analyzePictureStroke(t,m,r,p);break;case "CIMGradientStroke":this._analyzeGradientStroke(t,m,r,p);break;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":"CIMLineSymbol"===a.type&&(l=(l=t.markerPlacement)&&l.angleToLine?M.Alignment.MAP:M.Alignment.SCREEN);const v=[],u=t.primitiveName;u&&v.push(u);this._analyzeMarker(t,m,null,v,l,p,1,d,c,g,b,e);break;default:oa.error("Cannot analyze CIM layer",
t.type)}}}}_analyzeSolidFill(a,d){const c=a.primitiveName,g=h.fromCIMColor(a.color),[b,e]=this._analyzePrimitiveOverrides(c,d,null,null),k=B.numericHash(JSON.stringify(a)+e).toString();this._cimLayers.push({type:"fill",templateHash:k,materialHash:b?()=>k:k,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked,color:this._createOverrideFunction(c,"Color",g,F),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:d,applyRandomOffset:!1,sampleAlphaOnly:!0})}_analyzePictureFill(a,d){const c=a.primitiveName,
g=h.getTintColor(a),[b,e]=this._analyzePrimitiveOverrides(c,d,null,null),k=B.numericHash(JSON.stringify(a)+e).toString(),f=B.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}`).toString(),l=h.getValue(a.height,K.defaultPictureFillHeight);let p=h.getValue(a.scaleX,1);if("width"in a&&"number"===typeof a.width){const r=a.width;let n=1;const m=this._resourceManager.getResource(a.url);null!=m&&(n=m.width/m.height);p/=l/r*n}this._cimLayers.push({type:"fill",templateHash:k,materialHash:b?()=>
f:f,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked,effects:d,color:this._createOverrideFunction(c,"TintColor",g,F),height:this._createOverrideFunction(c,"Height",l),scaleX:this._createOverrideFunction(c,"ScaleX",p),angle:this._createOverrideFunction(c,"Rotation",h.getValue(a.rotation)),offsetX:this._createOverrideFunction(c,"OffsetX",h.getValue(a.offsetX)),offsetY:this._createOverrideFunction(c,"OffsetY",h.getValue(a.offsetY)),url:a.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeHatchFill(a,
d){const c=a.primitiveName,g=this._analyzeMaterialOverrides(c,["Rotation","OffsetX","OffsetY"]);let [b,e]=this._analyzePrimitiveOverrides(c,d,null,null);const k=B.numericHash(JSON.stringify(a)+e).toString(),f=B.numericHash(`${a.separation}${JSON.stringify(a.lineSymbol)}`).toString();let l={r:255,g:255,b:255,a:1};var p=!1;const r=a.lineSymbol?.symbolLayers?.find(n=>"CIMSolidStroke"===n.type&&null!=this._poMap[n.primitiveName]?.Color);r&&(l=h.fromCIMColor(r.color),l=this._createOverrideFunction(r.primitiveName,
"Color",l,F),p="function"===typeof l,b=b||p,p=null!=r.color||p);this._cimLayers.push({type:"fill",templateHash:k,materialHash:b&&g?this._createMaterialHashFunction(f,g):f,cim:a,materialOverrides:g,colorLocked:!!a.colorLocked,effects:d,color:l,height:this._createOverrideFunction(c,"Separation",h.getValue(a.separation,K.defaultHatchFillSeparation)),scaleX:1,angle:this._createOverrideFunction(c,"Rotation",h.getValue(a.rotation)),offsetX:this._createOverrideFunction(c,"OffsetX",h.getValue(a.offsetX)),
offsetY:this._createOverrideFunction(c,"OffsetY",h.getValue(a.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!p})}_analyzeGradientFill(a,d){const [c,g]=this._analyzePrimitiveOverrides(a.primitiveName,d,null,null),b=B.numericHash(JSON.stringify(a)+g).toString();this._cimLayers.push({type:"fill",templateHash:b,materialHash:c?()=>b:b,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked,effects:d,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,
applyRandomOffset:!1,sampleAlphaOnly:!1})}_analyzeSolidStroke(a,d,c,g){const b=a.primitiveName,e=h.fromCIMColor(a.color),k=h.getValue(a.width,K.defaultStrokeWidth),f=Y(a.capStyle),l=Z(a.joinStyle),p=a.miterLimit,[r,n]=this._analyzePrimitiveOverrides(b,d,null,null),m=B.numericHash(JSON.stringify(a)+n).toString();let t;if(d&&d instanceof Array&&0<d.length){const v=d[d.length-1];if("CIMGeometricEffectDashes"===v.type&&"NoConstraint"===v.lineDashEnding&&null===v.offsetAlongLine){d=[...d];var q=d.pop();
t=q.dashTemplate;q=q.scaleDash}}this._cimLayers.push({type:"line",templateHash:m,materialHash:r?()=>m:m,cim:a,materialOverrides:null,isOutline:c,colorLocked:!!a.colorLocked,effects:d,color:this._createOverrideFunction(b,"Color",e,F),width:this._createOverrideFunction(b,"Width",k),cap:this._createOverrideFunction(b,"CapStyle",f),join:this._createOverrideFunction(b,"JoinStyle",l),miterLimit:p&&this._createOverrideFunction(b,"MiterLimit",p),referenceWidth:g,zOrder:aa(a.name),dashTemplate:t,scaleDash:q,
sampleAlphaOnly:!0})}_analyzePictureStroke(a,d,c,g){const b=B.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}`).toString(),e=a.primitiveName,k=h.getTintColor(a),f=h.getValue(a.width,K.defaultStrokeWidth),l=Y(a.capStyle),p=Z(a.joinStyle),r=a.miterLimit,[n,m]=this._analyzePrimitiveOverrides(e,d,null,null),t=B.numericHash(JSON.stringify(a)+m).toString();this._cimLayers.push({type:"line",templateHash:t,materialHash:n?()=>b:b,cim:a,materialOverrides:null,isOutline:c,colorLocked:!!a.colorLocked,
effects:d,color:this._createOverrideFunction(e,"TintColor",k,F),width:this._createOverrideFunction(e,"Width",f),cap:this._createOverrideFunction(e,"CapStyle",l),join:this._createOverrideFunction(e,"JoinStyle",p),miterLimit:r&&this._createOverrideFunction(e,"MiterLimit",r),referenceWidth:g,zOrder:aa(a.name),dashTemplate:null,scaleDash:!1,url:a.url,sampleAlphaOnly:!1})}_analyzeGradientStroke(a,d,c,g){const b=a.primitiveName,e=h.getValue(a.width,K.defaultStrokeWidth),k=Y(a.capStyle),f=Z(a.joinStyle),
l=a.miterLimit,[p,r]=this._analyzePrimitiveOverrides(b,d,null,null),n=B.numericHash(JSON.stringify(a)+r).toString();this._cimLayers.push({type:"line",templateHash:n,materialHash:p?()=>n:n,cim:a,materialOverrides:null,isOutline:c,colorLocked:!!a.colorLocked,effects:d,color:{r:128,g:128,b:128,a:1},width:this._createOverrideFunction(b,"Width",e),cap:this._createOverrideFunction(b,"CapStyle",k),join:this._createOverrideFunction(b,"JoinStyle",f),miterLimit:l&&this._createOverrideFunction(b,"MiterLimit",
l),referenceWidth:g,zOrder:aa(a.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(a,d,c,g,b,e,k,f,l,p,r,n,m=!1){if(!this._analyzeMarkerInsidePolygon(a,d)){l=h.getValue(a.size,K.defaultMarkerSize);var t=h.getValue(a.rotation),q=h.getValue(a.offsetX),v=h.getValue(a.offsetY);l=this._createOverrideFunction(a.primitiveName,"Size",l);t=this._createOverrideFunction(a.primitiveName,"Rotation",t);q=this._createOverrideFunction(a.primitiveName,"OffsetX",q);v=this._createOverrideFunction(a.primitiveName,
"OffsetY",v);l=this._transformSize(l,k);t=this._transformRotation(t,!!a.rotateClockwise,p);r=this._transformOffsetX(q,v,p,k,r);p=this._transformOffsetY(q,v,p,k,n);q=r;v=p;switch(a.type){case "CIMPictureMarker":this._analyzePictureMarker(a,d,c,g,b,e,l,t,q,v,a.colorLocked||m);break;case "CIMVectorMarker":this._analyzeVectorMarker(a,d,c,g,b,e,k,f,l,t,q,v,a.colorLocked||m)}}}_analyzeMarkerInsidePolygon(a,d){const {markerPlacement:c,type:g}=a;if(!c||"CIMMarkerPlacementInsidePolygon"!==c.type)return!1;
if("CIMVectorMarker"===g||"CIMPictureMarker"===g){var b=a.primitiveName;if(b&&([b]=this._analyzePrimitiveOverrides([b],d,null,null),b))return!1;if(b=c.primitiveName)if([b]=this._analyzePrimitiveOverrides([b],d,null,null),b)return!1;if("CIMVectorMarker"===g){if({markerGraphics:b}=a,b)for(var e of b)if({symbol:b}=e,"CIMPolygonSymbol"===b?.type&&b.symbolLayers){({symbolLayers:b}=b);for(var k of b)if("CIMSolidStroke"===k.type)return!1}}else if({animatedSymbolProperties:e}=a,e)return!1}var f=Math.abs(c.stepX),
l=Math.abs(c.stepY);if(0===f||0===l)return!0;const p=new Set(["Rotation","OffsetX","OffsetY"]);e=this._primitiveOverrides.filter(m=>m.primitiveName!==a.primitiveName||!p.has(m.propertyName));k="url"in a&&"string"===typeof a.url?a.url:void 0;b=B.numericHash(JSON.stringify(a)).toString();let r=null;if("Random"===c.gridType){var n=da.px2pt(la.randomInsidePolygonTextureSize);const m=Math.max(Math.floor(n/f),1),t=Math.max(Math.floor(n/l),1);n=l*t;r=q=>q?q*t:0;f=m*f/n}else c.shiftOddRows?(n=2*l,r=m=>m?
2*m:0,f=f/l*.5):(n=l,r=null,f/=l);l=h.getTintColor(a);this._cimLayers.push({type:"fill",templateHash:b,materialHash:b,cim:a,materialOverrides:e,colorLocked:!!a.colorLocked,effects:d,color:l,height:this._createOverrideFunction(c.primitiveName,"StepY",n,r),scaleX:f,angle:c.gridAngle,offsetX:h.getValue(c.offsetX),offsetY:h.getValue(c.offsetY),url:k,applyRandomOffset:"Random"===c.gridType,sampleAlphaOnly:!k,hasUnresolvedReplacementColor:!0});return!0}_analyzePictureMarker(a,d,c,g,b,e,k,f,l,p,r){let n=
h.getValue(a.scaleX,1);const m=h.getTintColor(a),t=B.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}${JSON.stringify(a.animatedSymbolProperties)}`).toString();c||(c=this._createMarkerPlacementOverrideFunction(a.markerPlacement));const q=this._createAnimatedSymbolPropertiesOverrideFunction(a.animatedSymbolProperties),[v,u]=this._analyzePrimitiveOverrides(g,d,c,q);g=B.numericHash(JSON.stringify(a)+u).toString();const w=a.anchorPoint??{x:0,y:0};if("width"in a&&"number"===typeof a.width){const x=
a.width;let z=1;var y=this._resourceManager.getResource(a.url);null!=y&&(z=y.width/y.height);y=h.getValue(a.size);n/=y/x*z}this._cimLayers.push({type:"marker",templateHash:g,materialHash:a.animatedSymbolProperties&&!0===a.animatedSymbolProperties.randomizeStartTime?(x,z,C,E)=>{C=ma.getMaterialGroup(E??0);x=null!=q?h.evaluateValueOrFunction(q,x,z):null;return t+`-MATERIALGROUP(${C})`+`-ASP(${JSON.stringify(x)})`}:v?(x,z)=>{x=null!=q?h.evaluateValueOrFunction(q,x,z):null;return t+`-ASP(${JSON.stringify(x)})`}:
t,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked||!!r,effects:d,scaleSymbolsProportionally:!1,alignment:b,size:k,scaleX:this._createOverrideFunction(a.primitiveName,"ScaleX",n),rotation:f,offsetX:l,offsetY:p,color:this._createOverrideFunction(a.primitiveName,"TintColor",m,F),anchorPoint:{x:w.x,y:w.y},isAbsoluteAnchorPoint:"Relative"!==a.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:!1,referenceSize:e,sizeRatio:1,markerPlacement:c,url:a.url,
animatedSymbolProperties:q})}_analyzeVectorMarker(a,d,c,g,b,e,k,f,l,p,r,n,m){var t=a.markerGraphics;if(t){var q=a.frame,v=0,u=1;a.scaleSymbolsProportionally&&q&&(v=q.ymax-q.ymin,u=this._transformSize(l,1/v));u=this._transformSize(u,k);c||(c=this._createMarkerPlacementOverrideFunction(a.markerPlacement));for(const x of t)if(x&&(k=x.symbol)){(t=x.primitiveName)&&g.push(t);var w=r,y=n;if(("CIMPointSymbol"===k.type||"CIMTextSymbol"===k.type)&&q){let z=y=0;w=x.geometry;"x"in w&&"y"in w&&(y+=w.x-.5*(q.xmin+
q.xmax),z+=w.y-.5*(q.ymin+q.ymax));if(w=a.anchorPoint)"Absolute"===a.anchorPointUnits?(y-=w.x,z-=w.y):q&&(y-=(q.xmax-q.xmin)*w.x,z-=(q.ymax-q.ymin)*w.y);w=this._transformOffsetX(y,z,p,u,r);y=this._transformOffsetY(y,z,p,u,n)}switch(k.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":f||na(k)?this._analyzeMultiLayerGraphicNonSDF(a,d,c,null,x,g,b,e,v,!!m||!!a.colorLocked):this._analyzeMultiLayerGraphic(a,d,c,null,x,g,b,e,v,u,l,p,w,y,!!m||!!a.colorLocked);break;case "CIMTextSymbol":this._analyzeTextGraphic(a,
d,c,x,g,b,e,v,u,l,p,w,y,!!m||!!a.colorLocked)}t&&g.pop()}}}_analyzeMultiLayerGraphic(a,d,c,g,b,e,k,f,l,p,r,n,m,t,q){var v=b.symbol;const u=v.symbolLayers;if(u){var w=u.length;if(u&&2===u.length&&u[0].enable&&u[1].enable&&"CIMSolidStroke"===u[0].type&&"CIMSolidFill"===u[1].type&&null==u[0].path&&null==u[1].path&&!u[0].effects&&!u[1].effects)this._analyzeCompositeMarkerGraphic(a,d,c,g,b,u,e,k,f,l,r,n,m,t,!!q||!!a.colorLocked);else{var y=this._resourceManager.geometryEngine;if(v=ea.CIMEffectHelper.applyEffects(v.effects,
b.geometry,y))for(;w--;){const A=u[w];if(!A||!1===A.enable)continue;const I=A.primitiveName;I&&e.push(I);switch(A.type){case "CIMSolidFill":case "CIMSolidStroke":var x=ea.CIMEffectHelper.applyEffects(A.effects,v,y),z=W.getExtent(x);if(!z)continue;const P="Relative"!==a.anchorPointUnits,[D,N,G]=W.getSDFMetrics(z,a.frame,a.size,a.anchorPoint,P);var C="CIMSolidFill"===A.type;x={type:"sdf",geom:x,asFill:C};z=A.path;const O=C?h.fromCIMColor(h.getFillColor(A)):null==z?h.fromCIMColor(h.getStrokeColor(A)):
{r:0,g:0,b:0,a:0},Q=C?{r:0,g:0,b:0,a:0}:h.fromCIMColor(h.getStrokeColor(A)),S=h.getStrokeWidth(A)??0;if(!C&&!S)break;var E=b.primitiveName;let H=null;C&&!A.colorLocked&&(H=this._createOverrideFunction(E,"FillColor",O,F));let ca=null;C||A.colorLocked||(ca=this._createOverrideFunction(E,"StrokeColor",Q,F));C=this._createOverrideFunction(E,"StrokeWidth",S);E=!1;var J="";for(const T of this._primitiveOverrides)e.includes(T.primitiveName)&&(null!=T.value?J+=`-${T.primitiveName}-${T.propertyName}-${JSON.stringify(T.value)}`:
T.valueExpressionInfo&&(E=!0));if(null!=d&&"function"===typeof d||null!=c&&"function"===typeof c)E=!0;if(h.isFeatureValueFn(r)||h.isFeatureValueFn(n)||h.isFeatureValueFn(m)||h.isFeatureValueFn(t))E=!0;const qa=JSON.stringify({...a,markerGraphics:null}),fa=B.numericHash(JSON.stringify(x)+z).toString();J=B.numericHash(JSON.stringify(b)+JSON.stringify(A)+qa+J).toString();this._cimLayers.push({type:"marker",templateHash:J,materialHash:E?()=>fa:fa,cim:x,materialOverrides:null,colorLocked:!!A.colorLocked||
!!q,effects:d,scaleSymbolsProportionally:!!a.scaleSymbolsProportionally,alignment:k,anchorPoint:{x:N,y:G},isAbsoluteAnchorPoint:P,size:r,rotation:n,offsetX:m,offsetY:t,scaleX:1,frameHeight:l,rotateClockwise:!1,referenceSize:f,sizeRatio:D,color:h.isFeatureValueFn(H)?H:this._createOverrideFunction(I,"Color",O,F),outlineColor:h.isFeatureValueFn(ca)?ca:this._createOverrideFunction(I,"Color",Q,F),outlineWidth:h.isFeatureValueFn(C)?C:this._createOverrideFunction(I,"Width",S),markerPlacement:c,animatedSymbolProperties:g,
path:z});break;case "CIMVectorMarker":A.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(a,d,c,g,b,e,k,f,l,!!q||!!A.colorLocked):this._analyzeMarker(A,d,c,e,k,f,p,!1,r,n,m,t,!!q||!!a.colorLocked);break;default:this._analyzeMultiLayerGraphicNonSDF(a,d,c,g,b,e,k,f,l,!!q||!!a.colorLocked)}I&&e.pop()}}}}_analyzeTextGraphic(a,d,c,g,b,e,k,f,l,p,r,n,m,t){L.OverrideHelper.findApplicableOverrides(g,this._primitiveOverrides,[]);f=g.geometry;if("x"in f&&"y"in f){f=g.symbol;p=h.fromCIMFontDecoration(f);var q=
h.fromCIMFontStyle(f.fontStyleName),v=ia.getFontFamily(f.fontFamilyName);f.font={family:v,decoration:p,...q};var u=h.getValue(f.height,K.defaultTextHeight),w=h.getValue(f.angle),y=h.getValue(f.offsetX),x=h.getValue(f.offsetY);u=this._transformSize(u,l);w=this._transformRotation(w,!1,r);n=this._transformOffsetX(y,x,r,l,n);x=this._transformOffsetY(y,x,r,l,m);y=n;r=h.fromCIMColor(h.getFillColor(f));m=h.fromCIMColor(h.getStrokeColor(f));n=h.getStrokeWidth(f)??0;n||(m=h.fromCIMColor(h.getFillColor(f.haloSymbol)),
n=h.getValue(f.haloSize));n=this._transformSize(n,l);l=!1;if(f.symbol?.symbolLayers)for(var z of f.symbol.symbolLayers)null!=h.getFillColor(z)&&(l=!!z.colorLocked);var C=g.primitiveName;z=null;l||(z=this._createOverrideFunction(C,"Color",r,F));var E=C=null,J=0;if(f.callout&&"CIMBackgroundCallout"===f.callout.type){var A=f.callout;if(A.backgroundSymbol&&(A=A.backgroundSymbol.symbolLayers))for(const G of A)"CIMSolidFill"===G.type?C=h.fromCIMColor(G.color):"CIMSolidStroke"===G.type&&(E=h.fromCIMColor(G.color),
J=h.getValue(G.width,K.defaultStrokeWidth))}var [I,P]=this._analyzePrimitiveOverrides(b,d,c,null);b=JSON.stringify(a.effects)+Number(a.colorLocked||t).toString()+JSON.stringify(a.anchorPoint)+a.anchorPointUnits+JSON.stringify(a.markerPlacement)+a.size.toString();b=B.numericHash(JSON.stringify(g)+b+P).toString();var D=this._createOverrideFunction(g.primitiveName,"TextString",g.textString??"",h.adjustTextCase,f.textCase);if(null!=D){({fontStyleName:g}=f);var N=v+(g?"-"+g.toLowerCase():"-regular");"string"===
typeof D&&D.includes("[")&&f.fieldMap&&(D=h.createLabelOverrideFunction(f.fieldMap,D,f.textCase));this._cimLayers.push({type:"text",templateHash:b,materialHash:I||"function"===typeof D||/\[(.*?)\]/.test(D)?(G,O,Q)=>N+"-"+h.evaluateValueOrFunction(D,G,O,Q):N+"-"+B.numericHash(D),cim:f,materialOverrides:null,colorLocked:!!t||!!l,effects:d,alignment:e,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:"Relative"!==a.anchorPointUnits,fontName:N,decoration:p,weight:q.weight,style:q.style,size:u,angle:w,offsetX:y,
offsetY:x,horizontalAlignment:h.fromCIMHorizontalAlignment(f.horizontalAlignment),verticalAlignment:h.fromCIMVerticalAlignment(f.verticalAlignment),text:D,color:h.isFeatureValueFn(z)?z:r,outlineColor:m,outlineSize:n,backgroundColor:C,borderLineColor:E,borderLineWidth:J,lineWidth:null,referenceSize:k,sizeRatio:1,markerPlacement:c})}}}_analyzeMultiLayerGraphicNonSDF(a,d,c,g,b,e,k,f,l,p){b=this._buildSimpleMarker(a,b);const r=a.primitiveName,n=this._analyzeMaterialOverrides(r,["Rotation","OffsetX","OffsetY"]);
var [,m]=this._analyzePrimitiveOverrides(e,null,null,null);const [t,q,v]=L.CIMSymbolHelper.getTextureAnchor(b,this._resourceManager);e=h.getValue(a.rotation);const u=h.getValue(a.offsetX),w=h.getValue(a.offsetY);m=B.numericHash(JSON.stringify(b)+m).toString();this._cimLayers.push({type:"marker",templateHash:m,materialHash:(n&&0<n.length||null!=d&&"function"===typeof d)&&n?this._createMaterialHashFunction(m,n):m,cim:b,materialOverrides:n,colorLocked:!!a.colorLocked||!!p,effects:d,scaleSymbolsProportionally:!!a.scaleSymbolsProportionally,
alignment:k,anchorPoint:{x:t,y:q},isAbsoluteAnchorPoint:!1,size:h.getValue(a.size,K.defaultMarkerSize),rotation:this._createOverrideFunction(r,"Rotation",e),offsetX:this._createOverrideFunction(r,"OffsetX",u),offsetY:this._createOverrideFunction(r,"OffsetY",w),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:l,rotateClockwise:!!a.rotateClockwise,referenceSize:f,sizeRatio:v/da.pt2px(a.size),markerPlacement:c,animatedSymbolProperties:g,avoidSDFRasterization:!0})}_buildSimpleMarker(a,
d){return{type:a.type,enable:!0,name:a.name,colorLocked:a.colorLocked,primitiveName:a.primitiveName,anchorPoint:a.anchorPoint,anchorPointUnits:a.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:a.rotateClockwise,rotation:0,size:a.size,billboardMode3D:a.billboardMode3D,depth3D:a.depth3D,frame:a.frame,markerGraphics:[d],scaleSymbolsProportionally:a.scaleSymbolsProportionally,respectFrame:a.respectFrame,clippingPath:a.clippingPath}}_analyzeCompositeMarkerGraphic(a,d,c,g,b,e,k,f,l,p,r,n,m,t,q){var v=
b.geometry;const u=e[0],w=e[1];var y=W.getExtent(v);if(y){e="Relative"!==a.anchorPointUnits;var [x,z,C]=W.getSDFMetrics(y,a.frame,a.size,a.anchorPoint,e);v={type:"sdf",geom:v,asFill:!0};y=w.path;var E=w.primitiveName,J=u.primitiveName,A=h.fromCIMColor(w.color),I=h.fromCIMColor(u.color),P=h.getValue(u.width,K.defaultStrokeWidth),D=b.primitiveName,N=null;w.colorLocked||q||(N=this._createOverrideFunction(D,"FillColor",A,F));var G=null;u.colorLocked||q||(G=this._createOverrideFunction(D,"StrokeColor",
I,F));D=this._createOverrideFunction(D,"StrokeWidth",P);var O=!1,Q="";for(const H of this._primitiveOverrides)if(H.primitiveName===E||H.primitiveName===J||k.includes(H.primitiveName))null!=H.value?Q+=`-${H.primitiveName}-${H.propertyName}-${JSON.stringify(H.value)}`:H.valueExpressionInfo&&(O=!0);null!=c&&"function"===typeof c&&(O=!0);if(h.isFeatureValueFn(r)||h.isFeatureValueFn(n)||h.isFeatureValueFn(m)||h.isFeatureValueFn(t))O=!0;k=JSON.stringify({...a,markerGraphics:null});var S=B.numericHash(JSON.stringify(v)+
y).toString();b=B.numericHash(JSON.stringify(b)+JSON.stringify(w)+JSON.stringify(u)+k+Q).toString();this._cimLayers.push({type:"marker",templateHash:b,materialHash:O?()=>S:S,cim:v,materialOverrides:null,colorLocked:!!q,effects:d,scaleSymbolsProportionally:!!a.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:z,y:C},isAbsoluteAnchorPoint:e,size:r,rotation:n,offsetX:m,offsetY:t,scaleX:1,frameHeight:p,rotateClockwise:!1,referenceSize:l,sizeRatio:x,color:h.isFeatureValueFn(N)?N:this._createOverrideFunction(E,
"Color",A,F),outlineColor:h.isFeatureValueFn(G)?G:this._createOverrideFunction(J,"Color",I,F),outlineWidth:h.isFeatureValueFn(D)?D:this._createOverrideFunction(J,"Width",P),markerPlacement:c,path:y,animatedSymbolProperties:g})}}_createMaterialHashFunction(a,d){const c=this._info?.geometryType;if(c){const g=this._poMap;for(const b of d)if(b.valueExpressionInfo){const e=g[b.primitiveName]&&g[b.primitiveName][b.propertyName];e instanceof R.ArcadeExpression&&(b.fn=(k,f,l)=>U(e,k,{$view:l},c,f))}}return(g,
b,e)=>{for(const k of d)k.fn&&(k.value=k.fn(g,b,e));return B.numericHash(a+L.OverrideHelper.buildOverrideKey(d)).toString()}}_setPoMap(a,d,c){let g;this._poMap[a]?g=this._poMap[a]:(g={},this._poMap[a]=g);g[d]=c}_createOverrideFunction(a,d,c,g,b){if(null==a)return c;a=this._poMap[a];if(null==a)return c;const e=a[d];if("string"===typeof e||"number"===typeof e||e instanceof Array)return g?g.call(null,e,b):e;const k=this._info?.geometryType;return null!=e&&e instanceof R.ArcadeExpression&&null!=k?(f,
l,p)=>{f=U(e,f,{$view:p},k,l);null!==f&&g&&(f=g.call(null,f,b));return null!==f?f:c}:c}_createEffectsOverrideFunction(a,d){const c=this._poMap,g=this._info?.geometryType;for(const b of d)if(b.valueExpressionInfo&&g){const e=c[b.primitiveName]&&c[b.primitiveName][b.propertyName];e instanceof R.ArcadeExpression&&(b.fn=(k,f,l)=>U(e,k,{$view:l},g,f))}return(b,e,k)=>{for(var f of d)f.fn&&(f.value=f.fn(b,e,k));b=[];for(let l of a){if(e=l?.primitiveName){k=!1;for(const p of d)p.primitiveName===e&&(f=ba(p.propertyName),
null!=p.value&&p.value!==l[f]&&(k||(l=V.clone(l),k=!0),l[f]=p.value))}b.push(l)}return b}}_createMarkerPlacementOverrideFunction(a){const d=[];L.OverrideHelper.findApplicableOverrides(a,this._primitiveOverrides,d);if(null==a||0===d.length)return a;const c=this._poMap,g=this._info?.geometryType;for(const b of d)if(b.valueExpressionInfo&&g){const e=c[b.primitiveName]&&c[b.primitiveName][b.propertyName];e instanceof R.ArcadeExpression&&(b.fn=(k,f,l)=>U(e,k,{$view:l},g,f))}return(b,e,k)=>{for(const f of d)f.fn&&
(f.value=f.fn(b,e,k));b=V.clone(a);e=a.primitiveName;for(const f of d)f.primitiveName===e&&(k=ba(f.propertyName),null!=f.value&&f.value!==b[k]&&(b[k]=f.value));return b}}_createAnimatedSymbolPropertiesOverrideFunction(a){const d=[];L.OverrideHelper.findApplicableOverrides(a,this._primitiveOverrides,d);if(null==a||0===d.length)return a;const c=this._info?.geometryType;if(c){const g=this._poMap;for(const b of d)if(b.valueExpressionInfo){const e=g[b.primitiveName]&&g[b.primitiveName][b.propertyName];
e instanceof R.ArcadeExpression&&(b.fn=(k,f,l)=>U(e,k,{$view:l},c,f))}}return(g,b,e)=>{for(var k of d)k.fn&&(k.value=k.fn(g,b,e));g=V.clone(a);b=a.primitiveName;for(const f of d)f.primitiveName===b&&(e=ba(f.propertyName),null!=f.value&&(k=ka.quantizeIfNeeded(f.value,f.propertyName),k!==g[e]&&(g[e]=k)));return g}}_analyzePrimitiveOverrides(a,d,c,g){let b=!1,e="";"string"===typeof a&&(a=[a]);for(const k of this._primitiveOverrides)a?.includes(k.primitiveName)&&(null!=k.value?e+=`-${k.primitiveName}-${k.propertyName}-${JSON.stringify(k.value)}`:
k.valueExpressionInfo&&(b=!0));null!=d&&"function"===typeof d&&(b=!0);null!=c&&"function"===typeof c&&(b=!0);null!=g&&"function"===typeof g&&(b=!0);return[b,e]}_analyzeMaterialOverrides(a,d){return this._primitiveOverrides.filter(c=>c.primitiveName!==a||!d.includes(c.propertyName))}_transformSize(a,d){return h.isFeatureValueFn(a)||h.isFeatureValueFn(d)?(c,g,b)=>{const e=h.isFeatureValueFn(a)?a(c,g,b):a;c=h.isFeatureValueFn(d)?d(c,g,b):d;return e*c}:a*d}_transformRotation(a,d,c){return h.isFeatureValueFn(a)||
h.isFeatureValueFn(c)?(g,b,e)=>{const k=h.isFeatureValueFn(a)?a(g,b,e):a;g=h.isFeatureValueFn(c)?c(g,b,e):c;return d?g-k:g+k}:d?c-a:c+a}_transformOffsetX(a,d,c,g,b){if(!(h.isFeatureValueFn(a)||h.isFeatureValueFn(d)||h.isFeatureValueFn(c)||h.isFeatureValueFn(g)||h.isFeatureValueFn(b))){const e=c*Math.PI/180;return e?(Math.cos(e)*a-Math.sin(e)*d)*g+b:a*g+b}return(e,k,f)=>{var l=h.isFeatureValueFn(c)?c(e,k,f):c;const p=h.isFeatureValueFn(g)?g(e,k,f):g,r=h.isFeatureValueFn(a)?a(e,k,f):a,n=h.isFeatureValueFn(b)?
b(e,k,f):b;if(l){l*=Math.PI/180;const m=Math.cos(l);l=Math.sin(l);e=h.isFeatureValueFn(d)?d(e,k,f):d;return(m*r-l*e)*p+n}return r*p+n}}_transformOffsetY(a,d,c,g,b){if(!(h.isFeatureValueFn(a)||h.isFeatureValueFn(d)||h.isFeatureValueFn(c)||h.isFeatureValueFn(g)||h.isFeatureValueFn(b))){const e=c*Math.PI/180;return e?(Math.sin(e)*a+Math.cos(e)*d)*g+b:d*g+b}return(e,k,f)=>{var l=h.isFeatureValueFn(c)?c(e,k,f):c;const p=h.isFeatureValueFn(g)?g(e,k,f):g,r=h.isFeatureValueFn(d)?d(e,k,f):d,n=h.isFeatureValueFn(b)?
b(e,k,f):b;if(l){l*=Math.PI/180;const m=Math.cos(l);l=Math.sin(l);e=h.isFeatureValueFn(a)?a(e,k,f):a;return(l*e+m*r)*p+n}return r*p+n}}}X.CIMAnalyzer=pa;X.analyzeCIMResource=function(a,d){if(!d||0===d.length)return a;a=V.clone(a);L.OverrideHelper.applyOverrides(a,d);return a};Object.defineProperty(X,Symbol.toStringTag,{value:"Module"})});