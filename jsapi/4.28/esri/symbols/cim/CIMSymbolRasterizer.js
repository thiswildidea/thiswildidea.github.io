// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../Color ../../request ../../core/promiseUtils ../../core/screenUtils ./cimAnalyzer ./CIMResourceManager ./CIMSymbolDrawHelper ./CIMSymbolHelper ./Rasterizer ./TextRasterizer ./utils ../support/cimSymbolUtils ../support/Symbol3DAnchorPosition2D".split(" "),function(A,M,N,O,v,B,P,C,z,Q,R,r,S,T){const U=96/72;class V{constructor(a,b){this._spatialReference=a;this._avoidSDF=b;this._resourceCache=new Map;this._lazyImageDataCanvas=null;this._pictureMarkerCache=new Map;this._textRasterizer=
new R;this._cimResourceManager=new P;this._rasterizer=new Q(this._cimResourceManager)}get _imageDataCanvas(){this._lazyImageDataCanvas??(this._lazyImageDataCanvas=document.createElement("canvas"));return this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(a,b,e,c,d,h,k,f,l){if(!a)return null;var {data:m}=a;if(!m||"CIMSymbolReference"!==m.type||!m.symbol)return null;
({symbol:a}=m);h||(h=r.mapCIMSymbolToGeometryType(a));b=await z.OverrideHelper.resolveSymbolOverrides(m,b,this._spatialReference,d,h,k,f);d=this._imageDataCanvas;k=this._cimResourceManager;f=[];z.CIMSymbolHelper.fetchResources(b,k,f);z.CIMSymbolHelper.fetchFonts(b,k,f);0<f.length&&await Promise.all(f);const {width:n,height:p}=e;a:{e=-n/2+1;f=n/2-1;m=p/2-1;var t=-p/2+1;switch(h){case "esriGeometryPoint":h={x:0,y:0};break a;case "esriGeometryPolyline":h={paths:[[[e,0],[0,0],[f,0]]]};break a;default:h=
"legend"===c?{rings:[[[e,m],[f,0],[f,t],[e,t],[e,m]]]}:{rings:[[[e,m],[f,m],[f,t],[e,t],[e,m]]]}}}var g=z.CIMSymbolHelper.getEnvelope(b,h,k);if(!g)return null;e=(window.devicePixelRatio||1)*U;f=1;t=m=0;switch(a.type){case "CIMPointSymbol":case "CIMTextSymbol":l=1;g.width>n&&(l=n/g.width);a=1;g.height>p&&(a=p/g.height);"preview"===c&&(g.width<n&&(l=n/g.width),g.height<p&&(a=p/g.height));f=Math.min(l,a);m=g.x+g.width/2;t=g.y+g.height/2;break;case "CIMLineSymbol":if(l||g.height>p)f=p/g.height;t=g.y+
g.height/2;c=g.x*f+n/2;l=(g.x+g.width)*f+n/2;({paths:a}=h);a[0][0][0]-=c/f;a[0][2][0]-=(l-n)/f;break;case "CIMPolygonSymbol":m=g.x+g.width/2;t=g.y+g.height/2;c=g.x*f+n/2;l=(g.x+g.width)*f+n/2;a=g.y*f+p/2;g=(g.y+g.height)*f+p/2;const {rings:q}=h;0>c&&(q[0][0][0]-=c,q[0][3][0]-=c,q[0][4][0]-=c);0>a&&(q[0][0][1]+=a,q[0][1][1]+=a,q[0][4][1]+=a);l>n&&(q[0][1][0]-=l-n,q[0][2][0]-=l-n);g>p&&(q[0][2][1]+=g-p,q[0][3][1]+=g-p)}d.width=n*e;d.height=p*e;d.width+=2;d.height+=2;c=this._imageDataContext;l=C.Transformation.createIdentity();
l.translate(-m,-t);l.scale(f*e,-f*e);l.translate(n*e/2+1,p*e/2+1);c.clearRect(0,0,d.width,d.height);(new C.CanvasDrawHelper(c,k,l,!0)).drawSymbol(b,h);return c.getImageData(0,0,d.width,d.height)}async analyzeCIMSymbol3D(a,b,e,c,d){const h=[];b=b?{geometryType:c,spatialReference:this._spatialReference,fields:b}:null;c=[];z.CIMSymbolHelper.fetchFonts(a.data.symbol,this._cimResourceManager,c);await Promise.all(c);await (new B.CIMAnalyzer(this._cimResourceManager,b)).analyzeSymbolReference(a.data,this._avoidSDF,
h);O.throwIfAborted(d);let k;for(const f of h){if("CIMPictureMarker"===f.cim.type||"CIMPictureFill"===f.cim.type||"CIMPictureStroke"===f.cim.type)k||(k=[]),k.push(this._fetchPictureMarkerResource(f,d));e&&"text"===f.type&&"string"===typeof f.text&&f.text.includes("[")&&(f.text=r.createLabelOverrideFunction(e,f.text,f.cim.textCase))}k&&await Promise.all(k);return h}rasterizeCIMSymbol3D(a,b,e,c,d,h){const k=[];for(const l of a){c&&"function"===typeof c.scaleFactor&&(c.scaleFactor=c.scaleFactor(b,d,
h));a=this._getRasterizedResource(l,b,e,c,d,h);if(!a)continue;let m=0,n=a.anchorX||0,p=a.anchorY||0,t=!1,g=0;var f=0;if("esriGeometryPoint"===e)if(f=c?.scaleFactor?c.scaleFactor:1,g=r.evaluateValueOrFunction(l.offsetX,b,d,h)*f||0,f=r.evaluateValueOrFunction(l.offsetY,b,d,h)*f||0,"marker"===l.type)m=r.evaluateValueOrFunction(l.rotation,b,d,h)||0,t=l.rotateClockwise??!1;else if("text"===l.type){m=r.evaluateValueOrFunction(l.angle,b,d,h)||0;if(void 0!==l.horizontalAlignment)switch(l.horizontalAlignment){case "left":n=
-.5;break;case "right":n=.5;break;default:n=0}if(void 0!==l.verticalAlignment)switch(l.verticalAlignment){case "top":p=.5;break;case "bottom":p=-.5;break;case "baseline":p=-.25;break;default:p=0}}null!=a&&k.push({angle:m,rotateClockWise:t,anchorX:n,anchorY:p,offsetX:g,offsetY:f,rasterizedResource:a})}return this.getSymbolImage(k)}getSymbolImage(a){const b=document.createElement("canvas"),e=b.getContext("2d");var c=0,d=0,h=0,k=0,f=[];for(var l=0;l<a.length;l++){var m=a[l],n=m.rasterizedResource;if(!n)continue;
var p=n.size,t=m.offsetX;const D=m.offsetY,E=m.anchorX,F=m.anchorY,G=m.rotateClockWise||!1;m=m.angle;var g=v.pt2px(t)-p[0]*(.5+E);let w=v.pt2px(D)-p[1]*(.5+F),y=g+p[0];var q=w+p[1];if(m){G&&(m=-m);var u=Math.sin(m*Math.PI/180);const x=Math.cos(m*Math.PI/180);p=g*x-w*u;const H=g*u+w*x,I=g*x-q*u,J=g*u+q*x,K=y*x-q*u;q=y*u+q*x;const L=y*x-w*u;u=y*u+w*x;g=Math.min(p,I,K,L);w=Math.min(H,J,q,u);y=Math.max(p,I,K,L);q=Math.max(H,J,q,u)}c=g<c?g:c;d=w<d?w:d;h=y>h?y:h;k=q>k?q:k;g=e.createImageData(n.size[0],
n.size[1]);g.data.set(new Uint8ClampedArray(n.image.buffer));f.push({offsetX:t,offsetY:D,rotateClockwise:G,angle:m,rasterizedImage:g,anchorX:E,anchorY:F})}b.width=h-c;b.height=k-d;a=-c;for(c=0;c<f.length;c++)d=f[c],h=this._imageDataToCanvas(d.rasterizedImage),l=a-d.rasterizedImage.width*(.5+d.anchorX),n=k-d.rasterizedImage.height*(.5-d.anchorY),d.angle?(t=(360-d.angle)*Math.PI/180,e.save(),e.translate(v.pt2px(d.offsetX),-v.pt2px(d.offsetY)),e.translate(a,k),e.rotate(t),e.translate(-a,-k),e.drawImage(h,
l,n),e.restore()):e.drawImage(h,l+v.pt2px(d.offsetX),n-v.pt2px(d.offsetY));f=new T.Symbol3DAnchorPosition2D({x:a/b.width-.5,y:k/b.height-.5});return{imageData:0!==b.width&&0!==b.height?e.getImageData(0,0,b.width,b.height):e.createImageData(1,1),anchorPosition:f}}async _fetchPictureMarkerResource(a,b){const e=a.materialHash;this._pictureMarkerCache.get(e)||(a=(await N(a.cim.url,{responseType:"image",signal:b?.signal})).data,this._pictureMarkerCache.set(e,a))}_imageDataToCanvas(a){const b=this._imageDataCanvas,
e=this._imageDataContext;b.width=a.width;b.height=a.height;e.putImageData(a,0,0);return b}_imageTo32Array(a,b,e,c){const d=this._imageDataCanvas,h=this._imageDataContext;d.width=b;d.height=e;h.drawImage(a,0,0,b,e);c&&(h.save(),c=new M(c),h.fillStyle=c.toHex(),h.globalCompositeOperation="multiply",h.fillRect(0,0,b,e),h.globalCompositeOperation="destination-atop",h.drawImage(a,0,0,b,e),h.restore());return new Uint32Array(h.getImageData(0,0,b,e).data.buffer)}_getRasterizedResource(a,b,e,c,d,h){if("text"===
a.type)return this._rasterizeTextResource(a,b,c,d,h);if("function"===typeof a.materialHash){var k=a.materialHash;k=k(b,d,h);var f=B.analyzeCIMResource(a.cim,a.materialOverrides)}else k=a.materialHash,f=a.cim;({analyzedCIM:f,hash:k}={analyzedCIM:f,hash:k});const l=c?.scaleFactor?c.scaleFactor:1;if("CIMPictureMarker"===a.cim.type){e=r.evaluateValueOrFunction(a.size,b,d,h)*l;const {image:m,width:n,height:p}=this._getPictureResource(a,e,r.evaluateValueOrFunction(a.color,b,d,h));return a={image:m,size:[n,
p],sdf:!1,simplePattern:!1,anchorX:a.anchorPoint?a.anchorPoint.x:0,anchorY:a.anchorPoint?a.anchorPoint.y:0}}S.scaleCIMMarker(f,l,{preserveOutlineWidth:!1});b=f;k+=e;c&&(k+=JSON.stringify(c));e=this._resourceCache;if(e.has(k))return e.get(k);a=this._rasterizer.rasterizeJSONResource({cim:b,type:a.type,url:a.url,mosaicHash:k,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF);e.set(k,a);return a}_rasterizeTextResource(a,b,e,c,d){var h=e?.scaleFactor?e.scaleFactor:1;e=r.evaluateValueOrFunction(a.text,
b,c,d);if(!e||0===e.length)return null;var k=a.cim;const f=r.evaluateValueOrFunction(k?.fontFamilyName||a.fontName,b,c,d),l=r.evaluateValueOrFunction(k?.font?.style||a.style,b,c,d),m=r.evaluateValueOrFunction(k?.font?.weight||a.weight,b,c,d);k=r.evaluateValueOrFunction(k?.font?.decoration||a.decoration,b,c,d);h*=r.evaluateValueOrFunction(a.size,b,c,d);const n=r.evaluateValueOrFunction(a.horizontalAlignment,b,c,d),p=r.evaluateValueOrFunction(a.verticalAlignment,b,c,d),t=r.colorToArray(r.evaluateValueOrFunction(a.color,
b,c,d)),g=r.colorToArray(r.evaluateValueOrFunction(a.outlineColor,b,c,d));b=r.evaluateValueOrFunction(a.outlineSize,b,c,d);c=null!=a.backgroundColor?r.colorToArray(a.backgroundColor):null;d=null!=a.borderLineColor?r.colorToArray(a.borderLineColor):null;a=null!=a.borderLineWidth?a.borderLineWidth:null;return this._textRasterizer.rasterizeText(e,{color:t,size:h,horizontalAlignment:n,verticalAlignment:p,font:{family:f,style:l,weight:m,decoration:k},halo:{size:b||0,color:g,style:l},backgroundColor:c,
borderLine:null!=d&&null!=a?{color:d,size:a}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF})}_getPictureResource(a,b,e){a=this._pictureMarkerCache.get(a.materialHash);if(!a)return null;const c=a.height/a.width,d=b?1<c?v.pt2px(b):v.pt2px(b)/c:a.width;b=b?1<c?v.pt2px(b)*c:v.pt2px(b):a.height;return{image:this._imageTo32Array(a,d,b,e),width:d,height:b}}}A.CIMSymbolRasterizer=V;Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});