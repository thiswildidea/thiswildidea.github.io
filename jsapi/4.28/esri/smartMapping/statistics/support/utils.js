// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../core/Error ../../../core/screenUtils ../../../core/timeUtils ../../../geometry/SpatialReference ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../../../layers/support/fieldUtils ../../../renderers/support/heatmapUtils ../../support/utils ../../../statistics/utils ../../../support/arcadeOnDemand ../../../geometry/Point".split(" "),function(n,U,x,L,D,M,N,H,E,I,O,A,P,Q){function J(a){a=R.exec(a);if(!a)return null;
const {hh:b,mm:c,ss:d,ms:f}=a.groups;return Number(b)*D.millisecondsPerTimeUnit.hours+Number(c)*D.millisecondsPerTimeUnit.minutes+Number(d)*D.millisecondsPerTimeUnit.seconds+Number(f||0)}function K(a,b){a=null!=a?a:"";null!=b&&b&&(a=a?"("+a+") AND ("+b+")":b);return a}function S(a){const b=a.layer;return a.fields.filter(c=>!b.getField(c))}function T(a){const b=a.layer;return a.fields.filter(c=>{c=b.getFieldUsageInfo(c);return!c||!c.supportsStatistics})}let w=null;const R=/^(?<hh>([0-1][0-9])|([2][0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?([.](?<ms>\d+))?$/;
n.calculateHeatmapStats=function(a,b=18,c,d,f,v){const p=new Float64Array(f*v);b=Math.round(L.pt2px(b));let g=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY;var e=0;let q=0,m=0,k=0;c=I.createValueFunction(d,c);for(const {geometry:F,attributes:G}of a){const {x:y,y:z}=F;a=Math.max(0,y-b);e=Math.max(0,z-b);d=Math.min(v,z+b);const B=Math.min(f,y+b),C=+c(G);for(let t=e;t<d;t++)for(let r=a;r<B;r++){e=t*f+r;const h=I.evaluateDensityKernel(r-y,t-z,b);var u=p[e];e=p[e]+=h*C;u=e-u;q+=u;m+=u*u;e<g&&(g=
e);e>l&&(l=e);k++}}return k?{mean:q/k,stdDev:Math.sqrt((m-q*q/k)/k),min:g,max:l,mid:(l-g)/2,count:k}:{mean:0,stddev:0,min:0,max:0,mid:0,count:0}};n.getDataValues=async function(a,b,c=!0){if(!b)return[];const {field:d,field2:f,field3:v,fieldDelimiter:p,fieldInfos:g,timeZone:l}=a;var e=d&&g?.find(t=>t.name.toLowerCase()===d.toLowerCase());const q=e?E.isTimeOnlyField(e):!1,m=e?O.isAnyDateField(e):!1,k=a.valueExpression,u=a.normalizationType,F=a.normalizationField,G=a.normalizationTotal,y=[];e=a.viewInfoParams;
let z=null,B=null;if(k){if(!w){const {arcadeUtils:t}=await P.loadArcade();w=t}w.hasGeometryOperations(k)&&await w.enableGeometryOperations();z=w.createFunction(k);B=e?w.getViewInfo({viewingMode:e.viewingMode,scale:e.scale,spatialReference:new M(e.spatialReference)}):null}a=a.fieldInfos;const C=b[0]&&"declaredClass"in b[0]&&"esri.Graphic"===b[0].declaredClass||!a?null:{fields:a};b.forEach(t=>{var r=t.attributes;if(k){var h=w.createExecContext(C?{...t,layer:C}:t,B,l);h=w.executeFunction(z,h)}else r&&
(h=r[d],f?(h=`${A.processNullValue(h)}${p}${A.processNullValue(r[f])}`,v&&(h=`${h}${p}${A.processNullValue(r[v])}`)):"string"===typeof h&&c&&(m?h=h?(new Date(h)).getTime():null:q&&(h=h?J(h):null)));u&&"number"===typeof h&&isFinite(h)&&(r=r&&parseFloat(r[F]),h=A.getNormalizedValue(h,u,r,G));y.push(h)});return y};n.getRangeExpr=function(a,b,c){b=null!=b?a+" \x3e\x3d "+b:"";a=null!=c?a+" \x3c\x3d "+c:"";c="";return(c=b&&a?K(b,a):b||a)?"("+c+")":""};n.getSQLFilterForNormalization=function(a){const b=
a.field,c=a.normalizationType;a=a.normalizationField;let d;if("field"===c)d="(NOT "+a+" \x3d 0)";else if("log"===c||"natural-log"===c||"square-root"===c)d=`(${b} > 0)`;return d};n.getSumOfAttributesExpr=function(a,b,c){const d=[],f=[],v=[],p=[],g=[];a.forEach((q,m)=>{const k=q.field?"field":"expression",u=q.field||q.valueExpression;q.field?(g.push(u),f.push(`var ${k}${m} = Number($feature["${u}"]);`)):(d.push(`function getValueForExpr${m}() {\n  ${u} \n}`),f.push(`var ${k}${m} = Number(getValueForExpr${m}());`));
c||v.push(`${k}${m} = IIf(${k}${m} < 0, 0, ${k}${m});`);p.push(`${k}${m}`)});a="return sum;";const l=d.length?null:g.reduce((q,m)=>`${q} + ${m}`);let e=null;b||c?b?c||(a="return IIf(sum \x3e\x3d 0, sum, null);",l&&(e=`(( ${l} ) >= 0)`)):(a="return IIf(sum !\x3d 0, sum, null);",l&&(e=`(( ${l} ) <> 0)`)):(a="return IIf(sum \x3e 0, sum, null);",l&&(e=`(( ${l} ) > 0)`));return{valueExpression:[d.length?d.join("\n"):"",f.join("\n"),v.join("\n"),`var sum = ${p.join(" + ")};`,a].filter(Boolean).join("\n\n"),
sqlExpression:l,sqlWhere:e}};n.mergeWhereClauses=K;n.quantizeFeatures=function(a,b,c,d){const f=H.isWrappable(c)?H.getInfo(c):null,v=f?Math.round((f.valid[1]-f.valid[0])/b.scale[0]):null;return a.map(p=>{const g=new Q(p.geometry);N.quantizePoint(b,g,g,g.hasZ,g.hasM);if(f){var l=v??0,e=d[0];0>g.x?g.x+=l:g.x>e&&(g.x-=l)}p.geometry=g;return p})};n.timeOnlyToMilliseconds=J;n.verifyBasicFieldValidity=function(a,b,c){const d=S({layer:a,fields:b});if(d.length)return new x(c,"Unknown fields: "+d.join(", ")+
". You can only use fields defined in the layer schema");a=T({layer:a,fields:b});if(a.length)return new x(c,"Unsupported fields: "+a.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true")};n.verifyFieldType=function(a,b,c,d){let f;b?b.name!==a.objectIdField&&d.includes(b.type)||(f=new x(c,"'field' should be one of these types: "+d.join(","))):f=new x(c,"'field' is not defined in the layer schema");return f};n.verifyFilterValidty=function(a,
b){if(a&&"intersects"!==a.spatialRelationship)return new x(b,"Only 'intersects' spatialRelationship is supported for featureFilter")};n.verifyNumericField=function(a,b,c){let d;b?b.name!==a.objectIdField&&E.isNumericField(b)||(d=new x(c,"'field' should be one of these numeric types: "+E.numericTypes.join(","))):d=new x(c,"'field' is not defined in the layer schema");return d};Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});