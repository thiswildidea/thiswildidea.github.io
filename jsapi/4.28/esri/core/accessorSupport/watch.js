// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../ArrayPool ../handleUtils ../lang ../ReentrantObjectPool ../scheduling ../SetUtils ../uid ./get ./trackingUtils ./utils".split(" "),function(k,D,r,x,E,F,G,y,A,t,B){function u(a){h.delete(a);h.add(a);v||(v=F.schedule(C))}function H(a){if(!a.removed){var c=a.oldValue,d=a.getValue();a.equals(c,d)||(a.oldValue=d,a.notify(d,c))}}function C(){let a=10;for(;v&&a--;){v=null;const c=I(),d=w.acquire();for(const b of c){const e=b.uid;H(b);e===b.uid&&b.removed&&d.push(b)}for(const b of h)b.removed&&
(d.push(b),h.delete(b));for(const b of d)n.pool.release(b);w.release(d);w.release(c);z.forEach(b=>b())}}function I(){const a=w.acquire();a.length=h.size;let c=0;for(const d of h)a[c]=d,++c;h.clear();return a}function J(a,c,d){let b=B.parse(a,c,d,(e,g,l)=>{let f,m,p=t.reactionDeferred(()=>A.valueOf(e,g),(K,L)=>{e.__accessor__.destroyed||f&&f.uid!==m?b.remove():(f||(f=n.acquireUntracked(K,l,L,e,g),m=f.uid),u(f))});return r.makeHandle(()=>{p.remove();f&&(f.uid!==m||f.removed||(f.removed=!0,u(f)),f=null);
b=p=null})});return b}function M(a,c,d){const b=B.parse(a,c,d,(e,g,l)=>{let f=!1;return t.reaction(()=>A.valueOf(e,g),(m,p)=>{e.__accessor__.destroyed?b.remove():f||(f=!0,x.equals(p,m)||l.call(e,m,p,g,e),f=!1)})});return b}function N(a,c,d){let b,e,g=t.reactionDeferred(a,(l,f)=>{b&&b.uid!==e?g.remove():(b||(b=n.acquireTracked(l,c,f,d),e=b.uid),u(b))});return r.makeHandle(()=>{g.remove();b&&(b.uid!==e||b.removed||(b.removed=!0,u(b)),b=null);g=null})}function O(a,c,d){let b=!1;return t.reaction(a,(e,
g)=>{b||(b=!0,d(g,e)||c(e,g),b=!1)})}var q;(function(a){a[a.Untracked=0]="Untracked";a[a.Tracked=1]="Tracked"})(q||(q={}));class n{constructor(){this.uid=y.generateUID();this.removed=!1;this.equals=this.path=this.target=this.getValue=this.callback=this.oldValue=this.type=null}static acquireUntracked(a,c,d,b,e){return this.pool.acquire(q.Untracked,a,c,d,b,e,x.equals)}static acquireTracked(a,c,d,b){return this.pool.acquire(q.Tracked,a,c,d,null,null,b)}notify(a,c){this.type===q.Untracked?this.callback.call(this.target,
a,c,this.path,this.target):this.callback.call(null,a,c,void 0,void 0)}acquire(a,c,d,b,e,g,l){this.uid=y.generateUID();this.removed=!1;this.type=a;this.oldValue=c;this.callback=d;this.getValue=b;this.target=e;this.path=g;this.equals=l}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null;this.uid=y.generateUID();this.removed=!0}}n.pool=new E.ReentrantObjectPool(n);const w=new D,h=new Set;let v;const z=new Set;k.afterDispatch=function(a){z.add(a);return r.makeHandle(()=>z.delete(a))};
k.dispatch=C;k.isValueInUse=function(a){return G.someSet(h,c=>c.oldValue===a)};k.removeTarget=function(a){for(const c of h.values())c.target===a&&(c.removed=!0)};k.watch=function(a,c,d,b=!1){return!a.__accessor__||a.__accessor__.destroyed?r.makeHandle():b?M(a,c,d):J(a,c,d)};k.watchTracked=function(a,c,d=!1,b=x.equalsShallow){return d?O(a,c,b):N(a,c,b)};Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});