// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require ../chunks/tslib.es6 ../config ../kernel ../request ../core/Error ../core/JSONSupport ../core/Loadable ../core/maybe ../core/promiseUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../geometry/Extent ../intl/locale ./portalDefault ./PortalGroup ./PortalQueryParams ./PortalQueryResult ./PortalUser ../support/apiKeyUtils".split(" "),
function(y,c,u,t,F,z,b,G,v,q,e,H,Q,R,r,I,J,A,K,L,w,M,C,N){function O(a){const d=t.id;return()=>{const f=a.deref();f&&d.findCredential(f.restUrl)&&f.signIn().catch(()=>{})}}const B=a=>Object.freeze(Object.defineProperty({__proto__:null,default:a},Symbol.toStringTag,{value:"Module"}));var m;let x;const D={PortalGroup:()=>Promise.resolve({default:L}),PortalItem:()=>new Promise((a,d)=>y(["./PortalItem"],f=>a(B(f)),d)),PortalUser:()=>Promise.resolve({default:C})};b=m=class extends b.JSONSupportMixin(G){constructor(a){super(a);
this.access=this._esriIdCredentialCreateHandle=null;this.allSSL=!1;this.authMode="auto";this.bingKey=this.basemapGalleryGroupQuery3D=this.basemapGalleryGroupQuery=this.authorizedCrossOriginDomains=null;this.canProvisionDirectPurchase=this.canListPreProvisionedItems=this.canListData=this.canListApps=!1;this.canSearchPublic=!0;this.canSignInIDP=this.canSignInArcGIS=this.canSharePublic=this.canShareBingPublic=!1;this.colorSetsGroupQuery=null;this.commentsEnabled=!1;this.livingAtlasGroupQuery=this.galleryTemplatesGroupQuery=
this.featuredItemsGroupQuery=this.featuredGroups=this.eueiEnabled=this.devBasemapGalleryGroupQuery=this.description=this.defaultVectorBasemap=this.defaultExtent=this.defaultDevBasemap=this.defaultBasemap=this.customBaseUrl=this.culture=this.created=null;this.hasCategorySchema=!1;this.ipCntryCode=this.id=this.httpsPort=this.httpPort=this.homePageFeaturedContentCount=this.homePageFeaturedContent=this.helperServices=null;this.isReadOnly=this.isPortal=!1;this.rotatorPanels=this.region=this.portalProperties=
this.portalMode=this.portalHostname=this.name=this.modified=this.maxTokenExpirationMinutes=this.layerTemplatesGroupQuery=null;this.showHomePageDescription=!1;this.sourceJSON=null;this.supportsHostedServices=!1;this.units=this.templatesGroupQuery=this.symbolSetsGroupQuery=null;this.url=u.portalUrl;this.user=this.urlKey=null;this.use3dBasemaps=!0;this.useVectorBasemaps=this.useStandardizedQuery=!1;this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(a){return"string"===typeof a?{url:a}:a}destroy(){E.unregister(this);
this.defaultBasemap=v.destroyMaybe(this.defaultBasemap);this.defaultDevBasemap=v.destroyMaybe(this.defaultDevBasemap);this.defaultVectorBasemap=v.destroyMaybe(this.defaultVectorBasemap);this._esriIdCredentialCreateHandle=v.removeMaybe(this._esriIdCredentialCreateHandle)}readAuthorizedCrossOriginDomains(a){if(a)for(const d of a)u.request.trustedServers.includes(d)||u.request.trustedServers.push(d);return a}readDefaultBasemap(a){return this._readBasemap(a)}readDefaultDevBasemap(a){return this._readBasemap(a)}readDefaultVectorBasemap(a){return this._readBasemap(a)}get extraQuery(){const a=
!this.user?.orgId||this.canSearchPublic;return this.id&&!a?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get itemPageUrl(){return this.url?`${this.url}/home/item.html`:null}get restUrl(){let a=this.url;if(a){const d=a.indexOf("/sharing");a=0<d?a.substring(0,d):this.url.replace(/\/+$/,"");a+="/sharing/rest"}return a}get thumbnailUrl(){const a=this.restUrl,d=this.thumbnail;return a&&d?this._normalizeSSL(a+"/portals/self/resources/"+d):null}readUrlKey(a){return a?a.toLowerCase():
a}readUser(a){let d=null;a&&(d=C.fromJSON(a),d.portal=this);return d}load(a){const d=(new Promise((f,g)=>y(["../Basemap"],h=>f(B(h)),g))).then(({default:f})=>{q.throwIfAborted(a);x=f}).then(()=>this.sourceJSON?this.sourceJSON:this.fetchSelf(this.authMode,!1,a)).then(f=>{if(t.id){const g=t.id;this.credential=g.findCredential(this.restUrl);this.credential||this.authMode!==m.AUTH_MODE_AUTO||(this._esriIdCredentialCreateHandle?.remove(),this._esriIdCredentialCreateHandle=g.on("credential-create",O(new WeakRef(this))),
E.register(this,this._esriIdCredentialCreateHandle,this))}this.sourceJSON=f;this.read(f)});this.addResolvingPromise(d);return Promise.resolve(this)}async createElevationLayers(){await this.load();const a=this._getHelperService("defaultElevationLayers"),d=(await new Promise((f,g)=>y(["../layers/ElevationLayer"],h=>f(B(h)),g))).default;return a?a.map(f=>new d({id:f.id,url:f.url})):[]}async fetchBasemaps(a,d){const f=await this._fetchBasemaps(a,d);!0===d?.include3d&&!1!==this.use3dBasemaps&&(a=await this._fetchBasemaps3D(a,
d),f.unshift(...a));return f}fetchCategorySchema(a){return this.hasCategorySchema?this.request(this.restUrl+"/portals/self/categorySchema",a).then(d=>d.categorySchema):q.isAborted(a)?Promise.reject(q.createAbortError()):Promise.resolve([])}fetchFeaturedGroups(a){const d=this.featuredGroups,f=new w;f.num=100;f.sortField="title";if(d&&d.length){const g=[];for(const h of d)g.push(`(title:"${h.title}" AND owner:${h.owner})`);f.query=g.join(" OR ");return this.queryGroups(f,a).then(h=>h.results)}return q.isAborted(a)?
Promise.reject(q.createAbortError()):Promise.resolve([])}fetchRegions(a){const d=this.user?.culture||this.culture||A.getLocale();return this.request(this.restUrl+"/portals/regions",{...a,query:{culture:d}})}fetchSettings(a){const d=this.user?.culture||this.culture||A.getLocale();return this.request(this.restUrl+"/portals/self/settings",{...a,query:{culture:d}})}static getDefault(){return K.ensureDefaultPortalInstance(()=>new m)}queryGroups(a,d){return this.queryPortal("/community/groups",a,"PortalGroup",
d)}queryItems(a,d){return this.queryPortal("/search",a,"PortalItem",d)}queryUsers(a,d){a.sortField||(a.sortField="username");return this.queryPortal("/community/users",a,"PortalUser",d)}fetchSelf(a=this.authMode,d=!1,f){const g=this.restUrl+"/portals/self";a={authMode:a,query:{culture:A.getLocale().toLowerCase()},...f};"auto"===a.authMode&&(a.authMode="no-prompt");d&&(a.query.default=!0);return this.request(g,a)}queryPortal(a,d,f,g){const h=H.ensureType(w,d),p=k=>this.request(this.restUrl+a,{...h.toRequestOptions(this),
...g}).then(l=>{const n=h.clone();n.start=l.nextStart;return new M({nextQueryParams:n,queryParams:h,total:l.total,results:m._resultsToTypedArray(k,{portal:this},l,g)})}).then(l=>Promise.all(l.results.map(n=>"function"===typeof n.when?n.when():l)).then(()=>l,n=>{q.throwIfAbortError(n);return l}));return f&&D[f]?D[f]().then(({default:k})=>{q.throwIfAborted(g);return p(k)}):p()}signIn(){if(this.authMode===m.AUTH_MODE_ANONYMOUS)return Promise.reject(new z("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));
if("failed"===this.loadStatus)return Promise.reject(this.loadError);const a=d=>Promise.resolve().then(()=>{if("not-loaded"===this.loadStatus)return d||(this.authMode="immediate"),this.load().then(()=>null);if("loading"===this.loadStatus)return this.load().then(()=>{if(this.credential)return null;this.credential=d;return this.fetchSelf("immediate")});if(this.user&&this.credential===d)return null;this.credential=d;return this.fetchSelf("immediate")}).then(f=>{f&&(this.sourceJSON=f,this.read(f))});return t.id?
t.id.getCredential(this.restUrl).then(d=>a(d)):a(this.credential)}normalizeUrl(a){const d=this.credential?.token;return this._normalizeSSL(d?a+(a.includes("?")?"\x26":"?")+"token\x3d"+d:a)}requestToTypedArray(a,d,f){return this.request(a,d).then(g=>{const h=m._resultsToTypedArray(f,{portal:this},g);return Promise.all(h.map(p=>"function"===typeof p.when?p.when():g)).then(()=>h,()=>h)})}request(a,d={}){const f={f:"json",...d.query},{authMode:g=this.authMode===m.AUTH_MODE_ANONYMOUS?"anonymous":"auto",
body:h=null,cacheBust:p=!1,method:k="auto",responseType:l="json",signal:n}=d;d={authMode:g,body:h,cacheBust:p,method:k,query:f,responseType:l,timeout:0,signal:n};return F(this._normalizeSSL(a),d).then(P=>P.data)}toJSON(){throw new z("internal:not-yet-implemented","Portal.toJSON is not yet implemented");}static fromJSON(a){if(!a)return null;if(a.declaredClass)throw Error("JSON object is already hydrated");return new m({sourceJSON:a})}_getHelperService(a){const d=this.helperServices&&this.helperServices[a];
if(!d)throw new z("portal:service-not-found",`The \`helperServices\` do not include an entry named "${a}"`);return d}async _fetchBasemaps(a,d){const f=new w;f.query=a||(u.apiKey&&N.supportsApiKey(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery);f.disableExtraQuery=!0;a=await this.queryGroups(f,d);if(!a.total)return[];a=a.results[0];f.num=100;f.query='type:"Web Map" -type:"Web Application"';f.sortField=a.sortField||
"name";f.sortOrder=a.sortOrder||"desc";d=await a.queryItems(f,d);return d.total?d.results.filter(g=>"Web Map"===g.type).map(g=>new x({portalItem:g})):[]}async _fetchBasemaps3D(a,d){a=a||this.basemapGalleryGroupQuery3D;if(!a)return[];a=new w({query:a,disableExtraQuery:!0});var f=await this.queryGroups(a,d);if(!f.total)return[];f=f.results[0];a.num=100;a.query='type:"Web Scene"';a.sortField=f.sortField||"name";a.sortOrder=f.sortOrder||"desc";d=await f.queryItems(a,d);return d.total?d.results.filter(g=>
"Web Scene"===g.type).map(g=>new x({portalItem:g})):[]}_normalizeSSL(a){return a.replace(/^http:/i,"https:").replace(":7080",":7443")}_readBasemap(a){return a?(a=x.fromJSON(a),a.portalItem={portal:this},a):null}static _resultsToTypedArray(a,d,f,g){let h=[];if(f){const p=null!=g?g.signal:null;h=f.listings||f.notifications||f.userInvitations||f.tags||f.items||f.groups||f.comments||f.provisions||f.results||f.relatedItems||f;if(a||d)h=h.map(k=>{k=Object.assign(a?a.fromJSON(k):k,d);"function"===typeof k.load&&
k.load(p);return k})}else h=[];return h}};b.AUTH_MODE_ANONYMOUS="anonymous";b.AUTH_MODE_AUTO="auto";b.AUTH_MODE_IMMEDIATE="immediate";c.__decorate([e.property()],b.prototype,"access",void 0);c.__decorate([e.property()],b.prototype,"allSSL",void 0);c.__decorate([e.property()],b.prototype,"authMode",void 0);c.__decorate([e.property()],b.prototype,"authorizedCrossOriginDomains",void 0);c.__decorate([r.reader("authorizedCrossOriginDomains")],b.prototype,"readAuthorizedCrossOriginDomains",null);c.__decorate([e.property()],
b.prototype,"basemapGalleryGroupQuery",void 0);c.__decorate([e.property({json:{name:"3DBasemapGalleryGroupQuery"}})],b.prototype,"basemapGalleryGroupQuery3D",void 0);c.__decorate([e.property()],b.prototype,"bingKey",void 0);c.__decorate([e.property()],b.prototype,"canListApps",void 0);c.__decorate([e.property()],b.prototype,"canListData",void 0);c.__decorate([e.property()],b.prototype,"canListPreProvisionedItems",void 0);c.__decorate([e.property()],b.prototype,"canProvisionDirectPurchase",void 0);
c.__decorate([e.property()],b.prototype,"canSearchPublic",void 0);c.__decorate([e.property()],b.prototype,"canShareBingPublic",void 0);c.__decorate([e.property()],b.prototype,"canSharePublic",void 0);c.__decorate([e.property()],b.prototype,"canSignInArcGIS",void 0);c.__decorate([e.property()],b.prototype,"canSignInIDP",void 0);c.__decorate([e.property()],b.prototype,"colorSetsGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"commentsEnabled",void 0);c.__decorate([e.property({type:Date})],
b.prototype,"created",void 0);c.__decorate([e.property()],b.prototype,"credential",void 0);c.__decorate([e.property()],b.prototype,"culture",void 0);c.__decorate([e.property()],b.prototype,"currentVersion",void 0);c.__decorate([e.property()],b.prototype,"customBaseUrl",void 0);c.__decorate([e.property()],b.prototype,"defaultBasemap",void 0);c.__decorate([r.reader("defaultBasemap")],b.prototype,"readDefaultBasemap",null);c.__decorate([e.property()],b.prototype,"defaultDevBasemap",void 0);c.__decorate([r.reader("defaultDevBasemap")],
b.prototype,"readDefaultDevBasemap",null);c.__decorate([e.property({type:J})],b.prototype,"defaultExtent",void 0);c.__decorate([e.property()],b.prototype,"defaultVectorBasemap",void 0);c.__decorate([r.reader("defaultVectorBasemap")],b.prototype,"readDefaultVectorBasemap",null);c.__decorate([e.property()],b.prototype,"description",void 0);c.__decorate([e.property()],b.prototype,"devBasemapGalleryGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"eueiEnabled",void 0);c.__decorate([e.property({readOnly:!0})],
b.prototype,"extraQuery",null);c.__decorate([e.property()],b.prototype,"featuredGroups",void 0);c.__decorate([e.property()],b.prototype,"featuredItemsGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"galleryTemplatesGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"livingAtlasGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"hasCategorySchema",void 0);c.__decorate([e.property()],b.prototype,"helpBase",void 0);c.__decorate([e.property()],b.prototype,"helperServices",
void 0);c.__decorate([e.property()],b.prototype,"helpMap",void 0);c.__decorate([e.property()],b.prototype,"homePageFeaturedContent",void 0);c.__decorate([e.property()],b.prototype,"homePageFeaturedContentCount",void 0);c.__decorate([e.property()],b.prototype,"httpPort",void 0);c.__decorate([e.property()],b.prototype,"httpsPort",void 0);c.__decorate([e.property()],b.prototype,"id",void 0);c.__decorate([e.property()],b.prototype,"ipCntryCode",void 0);c.__decorate([e.property({readOnly:!0})],b.prototype,
"isOrganization",null);c.__decorate([e.property()],b.prototype,"isPortal",void 0);c.__decorate([e.property()],b.prototype,"isReadOnly",void 0);c.__decorate([e.property({readOnly:!0})],b.prototype,"itemPageUrl",null);c.__decorate([e.property()],b.prototype,"layerTemplatesGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"maxTokenExpirationMinutes",void 0);c.__decorate([e.property({type:Date})],b.prototype,"modified",void 0);c.__decorate([e.property()],b.prototype,"name",void 0);c.__decorate([e.property()],
b.prototype,"portalHostname",void 0);c.__decorate([e.property()],b.prototype,"portalMode",void 0);c.__decorate([e.property()],b.prototype,"portalProperties",void 0);c.__decorate([e.property()],b.prototype,"region",void 0);c.__decorate([e.property({readOnly:!0})],b.prototype,"restUrl",null);c.__decorate([e.property()],b.prototype,"rotatorPanels",void 0);c.__decorate([e.property()],b.prototype,"showHomePageDescription",void 0);c.__decorate([e.property()],b.prototype,"sourceJSON",void 0);c.__decorate([e.property()],
b.prototype,"staticImagesUrl",void 0);c.__decorate([e.property({json:{name:"2DStylesGroupQuery"}})],b.prototype,"stylesGroupQuery2d",void 0);c.__decorate([e.property({json:{name:"stylesGroupQuery"}})],b.prototype,"stylesGroupQuery3d",void 0);c.__decorate([e.property()],b.prototype,"supportsHostedServices",void 0);c.__decorate([e.property()],b.prototype,"symbolSetsGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"templatesGroupQuery",void 0);c.__decorate([e.property()],b.prototype,"thumbnail",
void 0);c.__decorate([e.property({readOnly:!0})],b.prototype,"thumbnailUrl",null);c.__decorate([e.property()],b.prototype,"units",void 0);c.__decorate([e.property()],b.prototype,"url",void 0);c.__decorate([e.property()],b.prototype,"urlKey",void 0);c.__decorate([r.reader("urlKey")],b.prototype,"readUrlKey",null);c.__decorate([e.property()],b.prototype,"user",void 0);c.__decorate([r.reader("user")],b.prototype,"readUser",null);c.__decorate([e.property()],b.prototype,"use3dBasemaps",void 0);c.__decorate([e.property()],
b.prototype,"useStandardizedQuery",void 0);c.__decorate([e.property()],b.prototype,"useVectorBasemaps",void 0);c.__decorate([e.property()],b.prototype,"vectorBasemapGalleryGroupQuery",void 0);c=b=m=c.__decorate([I.subclass("esri.portal.Portal")],b);const E=new FinalizationRegistry(a=>{a.remove()});return c});