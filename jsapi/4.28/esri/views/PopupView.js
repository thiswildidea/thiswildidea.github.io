// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require exports ../chunks/tslib.es6 ../core/asyncUtils ../core/deprecate ../core/Error ../core/Logger ../core/promiseUtils ../core/reactiveUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/subclass ./input/InputManager".split(" "),function(q,r,k,y,t,z,l,u,m,v,C,D,E,A,B){function g(f){return null!=f&&"open"in f&&"declaredClass"in f}function w(f){return null!=f&&"declaredClass"in f&&"dockOptions"in
f}const x=f=>Object.freeze(Object.defineProperty({__proto__:null,default:f},Symbol.toStringTag,{value:"Module"}));r.PopupView=f=>{f=class extends f{constructor(){super(...arguments);this._popupSetupTask=null;this.popup={};this.popupEnabled=!0}initialize(){this.addHandles([m.watch(()=>[this.ui,this.popup],([a,b],d)=>{if(d){const [e,c]=d;e&&g(c)&&(c.view=null,w(c)&&e.remove(c,"popup"))}a&&g(b)&&(b.view=this,w(b)&&a.add(b,{key:"popup",position:"manual",internal:!0}))},m.initial),this.on("click",a=>{this.popup&&
this.popupEnabled&&("mouse"!==a.pointerType||0===a.button)&&(!g(this.popup)&&"autoOpenEnabled"in this.popup&&!1===this.popup.autoOpenEnabled||(g(this.popup)?this.popup.viewModel.handleViewClick(a):a.async(async()=>{await this.setupPopup();g(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(a)})))},B.ViewEventPriorities.WIDGET)]);m.whenOnce(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>{new Promise((a,b)=>q(["../widgets/Popup"],d=>a(x(d)),
b))})}destroy(){this.destroyed||this.closePopup()}async openPopup(a){if(g(this.popup))return this.popup.open(a);try{await this.setupPopup(),this.popup?this.popup.open(a):l.getLogger(this).error(new z("view:null-popup","Popup is null and can't be opened"))}catch{}}closePopup(){this._popupSetupTask?.abort();g(this.popup)&&this.popup.close()}async fetchPopupFeatures(a,b){await this.when();const {location:d,queryArea:e,layerViewsAndGraphics:c,clientOnlyGraphics:h}=await this._prepareFetchPopupFeatures(a,
b);a=Promise.resolve(h);b=this._queryLayerPopupFeatures(e,c,b);const p=b.map(n=>n.promise);a=u.eachAlwaysValues([a,...p]).then(n=>Array.from(new Set(n.flat())));return{location:d,clientOnlyGraphics:h,allGraphicsPromise:a,promisesPerLayerView:b}}async setupPopup(){this._popupSetupTask?.abort();if(this.popup&&!g(this.popup))return this._popupSetupTask=y.createTask(async a=>{const {default:b}=await new Promise((d,e)=>q(["../widgets/Popup"],c=>d(x(c)),e));u.throwIfAborted(a);this.popup&&!g(this.popup)&&
(a=this.popup,delete a.open,delete a.close,this.popup=new b(a))}),this._popupSetupTask.promise}_queryLayerPopupFeatures(a,b,d){return b.map(({layerView:e,graphics:c})=>{c=e.fetchPopupFeatures(a,{clientGraphics:c,event:null!=d?d.event:void 0,signal:null!=d?d.signal:void 0,defaultPopupTemplateEnabled:null!=d?!!d.defaultPopupTemplateEnabled:!1});return{layerView:e,promise:c}})}_isValidPopupGraphic(a,b){return a&&!!a.getEffectivePopupTemplate(null!=b&&b.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(a,
b){const {clientGraphics:d,queryArea:e,location:c}=await this._popupHitTestGraphics(a,b);a=this._getFetchPopupLayerViews();const {layerViewsAndGraphics:h,clientOnlyGraphics:p}=this._graphicsPerFetchPopupLayerView(d,a);return{clientOnlyGraphics:p,layerViewsAndGraphics:h,queryArea:e,location:c}}async _popupHitTestGraphics(a,b){var d=await this.popupHitTest(a);a=d.mapPoint;d=d.results.filter(c=>"graphic"===c.type&&this._isValidPopupGraphic(c.graphic,b));const e=d.length?d[0].mapPoint:null;return{clientGraphics:d.map(c=>
c.graphic),queryArea:a,location:a||e}}_getFetchPopupLayerViews(){const a=[];this.allLayerViews.forEach(b=>{this._isValidPopupLayerView(b)&&a.push(b)});null!=this.graphicsView&&this._isValidPopupLayerView(this.graphicsView)&&a.push(this.graphicsView);return a.reverse()}_isValidPopupLayerView(a){return null!=a&&(!("layer"in a)||!a.suspended)&&"fetchPopupFeatures"in a}_graphicsPerFetchPopupLayerView(a,b){const d=[],e=new Map;b=b.map(c=>{const h=[];"layer"in c?e.set(c.layer,h):e.set(c.graphics,h);return{layerView:c,
graphics:h}});for(const c of a)(a=e.get(c.layer)||e.get(c.sourceLayer)||null)?a.push(c):d.push(c);return{layerViewsAndGraphics:b,clientOnlyGraphics:d}}};k.__decorate([v.property({cast(a){if(!a||g(a))return a;"object"===typeof a&&(a.open=b=>{t.deprecated(l.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"});return this.openPopup(b)},a.close=()=>{t.deprecated(l.getLogger(this),
"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"});return this.closePopup()});return a}})],f.prototype,"popup",void 0);k.__decorate([v.property()],f.prototype,"popupEnabled",void 0);return f=k.__decorate([A.subclass("esri.views.PopupView")],f)};Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});