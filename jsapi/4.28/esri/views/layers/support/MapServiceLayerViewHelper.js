// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/handleUtils ../../../core/has ../../../core/MapUtils ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/scaleUtils ../../../layers/support/fieldUtils ../../../layers/support/floorFilterUtils ../../../renderers/support/clickToleranceUtils ../../../rest/identify ../../../rest/support/IdentifyParameters ../../../support/arcadeOnDemand ../../../symbols/SimpleMarkerSymbol ./popupUtils".split(" "),
function(C,p,q,D,E,w,F,x,u,G,H,I,J,K,r,X,L,M,N,O,P,y,Q,R,S,z,A){function B(a,d,c){const f=[];if(!a)return f;const e=g=>{var b=0===g.minScale||d<=g.minScale;const h=0===g.maxScale||d>=g.maxScale;g.visible&&b&&h&&(g.sublayers?g.sublayers.forEach(e):g.popupEnabled&&(b=A.getFetchPopupTemplate(g,{...c,defaultPopupTemplateEnabled:!1}),null!=b&&f.unshift({sublayer:g,popupTemplate:b})))};a.map(e);return f}function T(a){return a.expressionInfos?.length||Array.isArray(a.content)&&a.content.some(d=>"expression"===
d.type)?S.loadArcade():Promise.resolve()}async function U(a,d){if(a.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(d.map(({sublayer:c})=>c.load().then(()=>c.capabilities.operations.supportsQuery)))}catch{return!1}}async function V(a,d){const c=a.renderer;c&&"defaultSymbol"in c&&!c.defaultSymbol&&(d=c.valueExpression?await Promise.all(d.map(f=>c.getSymbolAsync(f).then(e=>e?f:null))).then(f=>f.filter(e=>null!=e)):d.filter(f=>null!=c.getSymbol(f)));return d}let v=null;
p.MapServiceLayerViewHelper=class extends E{constructor(a){super(a);this._featuresResolutions=new WeakMap;this.highlightGraphicUpdated=this.highlightGraphics=null;this.updateHighlightedFeatures=I.debounce(async d=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(d).catch(()=>{}))})}initialize(){const a=d=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(d).catch(()=>{}));this.updateHighlightedFeatures(this._highlightGeometriesResolution)};
this.addHandles([J.on(()=>this.highlightGraphics,"change",d=>a(d.added),{onListenerAdd:d=>a(d)})])}async fetchPopupFeatures(a,d){const {layerView:{layer:c,view:{scale:f}}}=this;if(!a)throw new x("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:c});const e=B(c.sublayers,f,d);if(!e.length)return[];const g=await U(c,e);if(!((c.capabilities?.operations?.supportsIdentify??!0)&&10.5<=c.version||g))throw new x("fetchPopupFeatures:not-supported","query operation is disabled for this service",
{layer:c});return g?this._fetchPopupFeaturesUsingQueries(a,e,d):this._fetchPopupFeaturesUsingIdentify(a,e,d)}clearHighlights(){this.highlightGraphics?.removeAll()}highlight(a){const d=this.highlightGraphics;if(!d)return u.makeHandle();let c=null;a instanceof D?c=[a]:F.isCollection(a)&&0<a.length?c=a.toArray():Array.isArray(a)&&0<a.length&&(c=a);c=c?.filter(w.isSome);if(!c?.length)return u.makeHandle();for(const f of c)a=f.sourceLayer,null!=a&&"geometryType"in a&&"point"===a.geometryType&&(f.visible=
!1);d.addMany(c);return u.makeHandle(()=>d.removeMany(c??[]))}async _updateHighlightedFeaturesSymbols(a){const {layerView:{view:d},highlightGraphics:c,highlightGraphicUpdated:f}=this;if(c&&f)for(const e of a){const g=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer;e.sourceLayer&&"geometryType"in e.sourceLayer&&"point"===e.sourceLayer.geometryType&&g&&"getSymbolAsync"in g&&g.getSymbolAsync(e).then(async b=>{b||(b=new z);let h=null;const l="visualVariables"in g?g.visualVariables?.find(k=>
"size"===k.type):void 0;l&&(v||(v=(await new Promise((k,n)=>C(["../../../renderers/visualVariables/support/visualVariableUtils"],k,n))).getSize),h=v(l,e,{view:d.type,scale:d.scale,shape:"simple-marker"===b.type?b.style:null}));h||(h="width"in b&&"height"in b&&null!=b.width&&null!=b.height?Math.max(b.width,b.height):"size"in b?b.size:16);c.includes(e)&&(e.symbol=new z({style:"square",size:h,xoffset:"xoffset"in b?b.xoffset:0,yoffset:"yoffset"in b?b.yoffset:0}),f(e,"symbol"),e.visible=!0)})}}async _updateHighlightedFeaturesGeometries(a){const {layerView:{layer:d,
view:c},highlightGraphics:f,highlightGraphicUpdated:e}=this;this._highlightGeometriesResolution=a;if(e&&f?.length&&d.capabilities.operations.supportsQuery){var g=this._getTargetResolution(a);a=new Map;for(var b of f)(!this._featuresResolutions.has(b)||this._featuresResolutions.get(b)>g)&&H.getOrCreateMapValue(a,b.sourceLayer,()=>new Map).set(b.getObjectId(),b);b=Array.from(a,([h,l])=>{const k=h.createQuery();k.objectIds=[...l.keys()];k.outFields=[h.objectIdField];k.returnGeometry=!0;k.maxAllowableOffset=
g;k.outSpatialReference=c.spatialReference;return h.queryFeatures(k)});b=await Promise.all(b);if(!this.destroyed)for(const {features:h}of b)for(const l of h)(b=a.get(l.sourceLayer).get(l.getObjectId()))&&f.includes(b)&&(b.geometry=l.geometry,e(b,"geometry"),this._featuresResolutions.set(b,g))}}_getTargetResolution(a){const d=a*K.getMetersPerUnitForSR(this.layerView.view.spatialReference),c=d/16;return 10>=c?0:a/d*c}async _fetchPopupFeaturesUsingIdentify(a,d,c){a=await this._createIdentifyParameters(a,
d,c);if(null==a)return[];({results:a}=await Q.identify(this.layerView.layer.parsedUrl,a));return a.map(f=>f.feature)}async _createIdentifyParameters(a,d,c){const {floors:f,layer:e,timeExtent:g,view:{spatialReference:b,scale:h}}=this.layerView,l=null!=c?c.event:null;if(!d.length)return null;await Promise.all(d.map(({sublayer:m})=>m.load().catch(()=>{})));d=Math.min(G("mapservice-popup-identify-max-tolerance"),e.allSublayers.reduce((m,t)=>t.renderer?y.calculateTolerance({renderer:t.renderer,event:l}):
m,2));var k=this.createFetchPopupFeaturesQueryGeometry(a,d);const n=N.getResolutionForScale(h,b);c=Math.round(k.width/n);k=new M({xmin:k.center.x-n*c,ymin:k.center.y-n*c,xmax:k.center.x+n*c,ymax:k.center.y+n*c,spatialReference:k.spatialReference});return new R({floors:f,gdbVersion:"gdbVersion"in e?e.gdbVersion:void 0,geometry:a,height:c,layerOption:"popup",mapExtent:k,returnGeometry:!0,spatialReference:b,sublayers:e.sublayers,timeExtent:g,tolerance:d,width:c})}async _fetchPopupFeaturesUsingQueries(a,
d,c){const {layerView:{floors:f,timeExtent:e}}=this,g=null!=c?c.event:null;d=d.map(async({sublayer:b,popupTemplate:h})=>{await b.load().catch(()=>{});if(b.capabilities&&!b.capabilities.operations.supportsQuery)return[];var l=b.createQuery(),k=y.calculateTolerance({renderer:b.renderer,event:g}),n=this.createFetchPopupFeaturesQueryGeometry(a,k),m=new Set;const [t]=await Promise.all([A.getRequiredFields(b,h),b.renderer?.collectRequiredFields(m,b.fieldsIndex)]);O.collectFields(m,b.fieldsIndex,t);m=Array.from(m).sort();
l.geometry=n;l.outFields=m;l.timeExtent=e;f&&(m=f.clone(),m=P.getLayerFloorFilterClause(m,b),null!=m&&(l.where=l.where?`(${l.where}) AND (${m})`:m));k=this._getTargetResolution(n.width/k);n=await T(h);h="point"===b.geometryType||n&&n.arcadeUtils.hasGeometryOperations(h);h||(l.maxAllowableOffset=k);({features:l}=await b.queryFeatures(l));h=h?0:k;l=await V(b,l);for(const W of l)this._featuresResolutions.set(W,h);return l});return(await Promise.allSettled(d)).reduce((b,h)=>"fulfilled"===h.status?[...b,
...h.value]:b,[]).filter(w.isSome)}};q.__decorate([r.property({constructOnly:!0})],p.MapServiceLayerViewHelper.prototype,"createFetchPopupFeaturesQueryGeometry",void 0);q.__decorate([r.property({constructOnly:!0})],p.MapServiceLayerViewHelper.prototype,"layerView",void 0);q.__decorate([r.property({constructOnly:!0})],p.MapServiceLayerViewHelper.prototype,"highlightGraphics",void 0);q.__decorate([r.property({constructOnly:!0})],p.MapServiceLayerViewHelper.prototype,"highlightGraphicUpdated",void 0);
q.__decorate([r.property({constructOnly:!0})],p.MapServiceLayerViewHelper.prototype,"updatingHandles",void 0);p.MapServiceLayerViewHelper=q.__decorate([L.subclass("esri.views.layers.support.MapService")],p.MapServiceLayerViewHelper);p.collectPopupProviders=B;p.isMapServiceLayerView=function(a,d){return"tile"===d.type||"map-image"===d.type};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});