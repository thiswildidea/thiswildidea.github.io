// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define(["exports","./util"],function(r,p){class w{constructor(b,a,c){this.tileCoordRange=b;this._visibleTiles=a;this._createUnique=c;this._tiles=new Map;this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray());return this._uniqueSymbolLayerArray}add(b,a){this._uniqueSymbolLayerArray=null;let c=this._tiles.get(b.id);c||(c={symbols:new Map},this._tiles.set(b.id,c));var d=new Map;if(a)for(var e of a)c.symbols.has(e)&&
(d.set(e,c.symbols.get(e)),c.symbols.delete(e));else for(var [f]of b.layerData)c.symbols.has(f)&&(d.set(f,c.symbols.get(f)),c.symbols.delete(f));this._removeSymbols(d);a=b.symbols;d=new Map;for(const [g,h]of a)if(e=h.length,32<=e){f=this.tileCoordRange;do f/=2,e/=4;while(8<e&&64<f);e=new p.GridIndex(this.tileCoordRange,this.tileCoordRange,f);d.set(g,{flat:h,index:e});c.symbols.set(g,{flat:h,index:e});for(const k of h)e.getCell(k.xTile,k.yTile).push(k)}else d.set(g,{flat:h}),c.symbols.set(g,{flat:h});
this._addSymbols(b.key,a)}deleteStyleLayers(b){this._uniqueSymbolLayerArray=null;for(const [a,c]of this._tiles){const d=new Map;for(const e of b)c.symbols.has(e)&&(d.set(e,c.symbols.get(e)),c.symbols.delete(e));this._removeSymbols(d);0===c.symbols.size&&this._tiles.delete(a)}}removeTile(b){this._uniqueSymbolLayerArray=null;const a=this._tiles.get(b.id);if(a){var c=new Map;for(const [d]of b.symbols)a.symbols.has(d)&&(c.set(d,a.symbols.get(d)),a.symbols.delete(d));this._removeSymbols(c);0===a.symbols.size&&
this._tiles.delete(b.id)}}_removeSymbols(b){for(const [c,{flat:d}]of b)for(const e of d){b=e.unique;var a=b.tileSymbols;const f=a.length-1;for(let g=0;g<f;g++)if(a[g]===e){a[g]=a[f];break}a.length=f;0===f&&(a=this._uniqueSymbolsReferences.get(c),a.delete(b),0===a.size&&this._uniqueSymbolsReferences.delete(c));e.unique=null}}_addSymbols(b,a){if(0!==a.size){var c=this._visibleTiles;for(const d of c)d.parentTile||d.key.world!==b.world||d.key.level===b.level&&!d.key.equals(b)||this._matchSymbols(d,b,
a);for(const [d,e]of a)for(const f of e)null==f.unique&&(b=this._createUnique(),f.unique=b,b.tileSymbols.push(f),a=this._uniqueSymbolsReferences.get(d),a||(a=new Set,this._uniqueSymbolsReferences.set(d,a)),a.add(b))}}_matchSymbols(b,a,c){if(b.key.level>a.level){var d=b.key.level-a.level;if(b.key.row>>d!==a.row||b.key.col>>d!==a.col)return}if(a.level>b.key.level&&(d=a.level-b.key.level,a.row>>d!==b.key.row||a.col>>d!==b.key.col))return;if(a.equals(b.key))for(var e of b.childrenTiles)this._matchSymbols(e,
a,c);else{e=new Map;for(const [h,k]of c){var f=[];for(const l of k)c=p.tileCoordChange(this.tileCoordRange,l.xTile,a.level,a.col,b.key.level,b.key.col),d=p.tileCoordChange(this.tileCoordRange,l.yTile,a.level,a.row,b.key.level,b.key.row),0<=c&&c<this.tileCoordRange&&0<=d&&d<this.tileCoordRange&&f.push({symbol:l,xTransformed:c,yTransformed:d});c=[];d=b.key.level<a.level?1:1<<b.key.level-a.level;const m=this._tiles.get(b.id).symbols.get(h);if(m){const l=m.flat;for(const q of f){var g=!1;let t;const u=
q.xTransformed,v=q.yTransformed;t=null!=m.index?m.index.getCell(u,v):l;f=q.symbol;const x=f.hash;for(const n of t)if(x===n.hash&&Math.abs(u-n.xTile)<=d&&Math.abs(v-n.yTile)<=d){g=n.unique;f.unique=g;g.tileSymbols.push(f);g=!0;break}g||c.push(f)}}0<c.length&&e.set(h,c)}for(const h of b.childrenTiles)this._matchSymbols(h,a,e)}}_createUniqueSymbolLayerArray(){var b=this._uniqueSymbolsReferences;const a=Array(b.size);let c=0;for(const [d,e]of b){const f=Array(e.size);b=0;for(const g of e)f[b++]=g;a[c]=
{styleLayerUID:d,uniqueSymbols:f};c++}return a}}r.SymbolRepository=w;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});