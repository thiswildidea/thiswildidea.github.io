// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../../core/has ../../../../core/maybe ../brushes ../vectorTiles/shaders/VTLMaterialManager ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./TextureUploadManager ./WorldExtentClipRenderer ./effects/AnimationEffect ./effects/BlendEffect ./effects/FeatureEffect ./effects/HighlightEffect ./effects/HittestEffect ./effects/HittestEffectVTL ./effects/post-processing/EffectManager ./painter/RenderPass ../../../webgl/contextUtils ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Renderbuffer ../../../webgl/RenderbufferDescriptor ../../../webgl/TextureDescriptor".split(" "),
function(O,p,h,w,x,g,y,z,A,B,C,D,t,E,F,G,H,I,J,f,q,K,L,u){function M(a,c){switch(a){case g.WGLGeometryType.LINE:return h.brushes.line;case g.WGLGeometryType.TEXT:return h.brushes.text;case g.WGLGeometryType.LABEL:return h.brushes.label;case g.WGLGeometryType.FILL:switch(c){case g.WGLSymbologyType.DOT_DENSITY:return h.brushes.dotDensity;default:return h.brushes.fill}case g.WGLGeometryType.MARKER:switch(c){case g.WGLSymbologyType.HEATMAP:return h.brushes.heatmap;case g.WGLSymbologyType.PIE_CHART:return h.brushes.pieChart;
default:return h.brushes.marker}}}function v(a,c,b,d){return a!==g.WGLDrawPhase.LABEL_ALPHA&&a!==g.WGLDrawPhase.LABEL&&a!==g.WGLDrawPhase.HIGHLIGHT&&(1!==d||null!=c&&"normal"!==c||null!=b&&0<b.length)}class N{constructor(a,c,b){this.context=a;this._blitRenderer=new x.BitBlitRenderer;this._worldExtentRenderer=new B.WorldExtentRenderer;this._brushCache=new Map;this._lastHeight=this._lastWidth=null;this._vtlMaterialManager=new w;this._blendEffect=new D.BlendEffect;this._stencilBuf=null;this._prevBeforeLayerFBOStack=
[];this._fboPool=[];this.effects={highlight:new E,hittest:new F.HittestEffect,hittestVTL:new G.HittestEffectVTL,integrate:new C.AnimationEffect,insideEffect:new t.FeatureEffect("inside"),outsideEffect:new t.FeatureEffect("outside")};this.materialManager=new y(a);this.textureManager=new z(c,b,a.type===J.ContextType.WEBGL2);this.textureUploadManager=new A.TextureUploadManager(a,c);this._effectsManager=new H.EffectManager}dispose(){this.materialManager.dispose();this.textureManager.dispose();this.textureUploadManager.destroy();
this._blitRenderer=p.disposeMaybe(this._blitRenderer);this._worldExtentRenderer=p.disposeMaybe(this._worldExtentRenderer);this._brushCache&&(this._brushCache.forEach(a=>a.dispose()),this._brushCache.clear(),this._brushCache=null);if(this._fbos){let a;for(a in this._fbos)this._fbos[a]&&this._fbos[a].dispose()}for(const a of this._fboPool)a.dispose();this._fboPool.length=0;if(this.effects){let a;for(a in this.effects)this.effects[a]&&this.effects[a].dispose()}this._effectsManager.dispose();this._blendEffect.dispose(this.context);
this._vtlMaterialManager=p.disposeMaybe(this._vtlMaterialManager)}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getFbos(){if(!this._fbos)throw Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(a,c){if(0<this._fboPool.length)var b=this._fboPool.pop();else b=new u.TextureDescriptor(a,c),b.samplingMode=f.TextureSamplingMode.NEAREST,b.wrapMode=f.TextureWrapMode.CLAMP_TO_EDGE,b=new q.FramebufferObject(this.context,
b,this._stencilBuf);b.width===a&&b.height===c||b.resize(a,c);return b}releaseFbo(a){this._fboPool.push(a)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(a,c,b){const {context:d}=a;this._worldExtentRenderer.render(a,c,b);const {width:e,height:k}=d.getViewport();this.updateFBOs(e,k);this._prevFBO=d.getBoundFramebufferObject();d.bindFramebuffer(this.getFbos().output);d.setColorMask(!0,!0,!0,!0);if(null!=c){const {r:l,g:m,b:r,a:n}=c;d.setClearColor(n*l/255,n*m/255,n*r/255,n)}else d.setClearColor(0,
0,0,0);d.setDepthWriteEnabled(!0);d.setClearDepth(1);d.clear(d.gl.COLOR_BUFFER_BIT|d.gl.DEPTH_BUFFER_BIT);d.setDepthWriteEnabled(!1)}afterRenderPhases(a){({context:a}=a);a.bindFramebuffer(this._prevFBO);a.setStencilFunction(f.CompareFunction.EQUAL,1,255);a.setStencilTestEnabled(!0);a.setDepthTestEnabled(!1);this.blitTexture(a,this.getFbos().output.colorTexture,f.TextureSamplingMode.NEAREST)}beforeRenderLayer(a,c,b){const {context:d,blendMode:e,effects:k,drawPhase:l,requireFBO:m}=a;if(m||v(l,e,k,b)){a=
d.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(a);const {width:r,height:n}=d.getViewport();a=this.acquireFbo(r,n);d.bindFramebuffer(a);d.setColorMask(!0,!0,!0,!0);d.setClearColor(0,0,0,0);d.setDepthWriteEnabled(!0);d.setClearDepth(1);d.clear(d.gl.COLOR_BUFFER_BIT|d.gl.DEPTH_BUFFER_BIT);d.setDepthWriteEnabled(!1)}d.setDepthWriteEnabled(!1);d.setDepthTestEnabled(!1);d.setStencilTestEnabled(!0);d.setClearStencil(c);d.setStencilWriteMask(255);d.clear(d.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(a,
c){const {context:b,blendMode:d,effects:e,requireFBO:k,drawPhase:l}=a;if(k||v(l,d,e,c)){const m=b.getBoundFramebufferObject();null!=e&&0<e.length&&l===g.WGLDrawPhase.MAP&&this._applyEffects(a,e,m);b.bindFramebuffer(this._prevBeforeLayerFBOStack.pop());b.setStencilTestEnabled(!1);b.setStencilWriteMask(0);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA,f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setColorMask(!0,!0,!0,!0);this._blendEffect.draw(a,
m.colorTexture,f.TextureSamplingMode.NEAREST,null==d||l===g.WGLDrawPhase.HIGHLIGHT?"normal":d,c);this.releaseFbo(m)}}getBrush(a,c){a=M(a,c);c=this._brushCache.get(a);void 0===c&&(c=new a,this._brushCache.set(a,c));return c}renderObject(a,c,b,d){if(b=h.brushes[b]){var e=this._brushCache.get(b);void 0===e&&(e=new b,this._brushCache.set(b,e));e.prepareState(a,d);e.draw(a,c,d)}}renderObjects(a,c,b,d){if(b=h.brushes[b]){var e=this._brushCache.get(b);void 0===e&&(e=new b,this._brushCache.set(b,e));e.drawMany(a,
c,d)}}registerRenderPass(a){const c=a.brushes.map(b=>{this._brushCache.has(b)||this._brushCache.set(b,new b);return this._brushCache.get(b)});return new I(c,a)}blitTexture(a,c,b,d=1){a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA,f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setColorMask(!0,!0,!0,!0);this._blitRenderer.render(a,c,b,d)}getPostProcessingEffects(a){return this._effectsManager.getPostProcessingEffects(a)}updateFBOs(a,c){if(a!==
this._lastWidth||c!==this._lastHeight)if(this._lastWidth=a,this._lastHeight=c,this._fbos)for(var b in this._fbos)this._fbos[b].resize(a,c);else b=new u.TextureDescriptor(a,c),b.samplingMode=f.TextureSamplingMode.NEAREST,b.wrapMode=f.TextureWrapMode.CLAMP_TO_EDGE,a=new L.RenderbufferDescriptor(f.RenderbufferFormat.DEPTH_STENCIL,a,c),this._stencilBuf=new K.Renderbuffer(this.context,a),this._fbos={output:new q.FramebufferObject(this.context,b,this._stencilBuf),effect0:new q.FramebufferObject(this.context,
b,this._stencilBuf)}}_applyEffects(a,c,b){const {context:d}=a;c=this._effectsManager.getPostProcessingEffects(c);for(const {postProcessingEffect:e,effect:k}of c)d.bindFramebuffer(b),e.draw(a,b,k)}}return N});