// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define(["exports","../definitions","./CollisionGrid"],function(u,v,q){function p(f,d){const e=[];f.forEachTile(c=>e.push(c));e.sort((c,a)=>c.instanceId-a.instanceId);e.forEach(c=>{null!=c.labelMetrics&&c.isReady&&d(c,c.labelMetrics.getCursor())})}class x{run(f,d,e){const c=[];for(let a=f.length-1;0<=a;a--){const b=f[a];b.labelingCollisionInfos&&c.push(...b.labelingCollisionInfos)}this._transformMetrics(c);this._runCollision(c,d,e)}_runCollision(f,d,e){const [c,a]=d.state.size,b=new q.CollisionBitsetGrid(c,
a,d.pixelRatio);for(const {tileRenderer:g,deconflictionEnabled:r,visible:m}of f){const l=g.featuresView.attributeView;r?m?(this._prepare(g),this._collideVisible(b,g,e),this._collideInvisible(b,g)):p(g,(k,h)=>{for(;h.nextId();)l.setLabelMinZoom(h.id,255)}):p(g,(k,h)=>{for(;h.nextId();)l.setLabelMinZoom(h.id,0),m&&b.insertMetrics(h)})}}_isFiltered(f,d,e){f=d.getFilterFlags(f);d=null==e.featureEffect||e.featureEffect.excludedLabelsVisible||!!(f&v.effectFlag0);return!((!e.hasFilter||f&v.filterFlag0)&&
d)}_prepare(f){const d=f.featuresView.attributeView,e=new Set;p(f,(c,a)=>{for(;a.nextId();)e.has(a.id)||(e.add(a.id),this._isFiltered(a.id,d,f.layerView)?d.setLabelMinZoom(a.id,254):0!==d.getLabelMinZoom(a.id)?d.setLabelMinZoom(a.id,255):d.setLabelMinZoom(a.id,0))})}_collideVisible(f,d,e){const c=d.featuresView.attributeView,a=new Set;p(d,(b,g)=>{for(;g.nextId();)if(!a.has(g.id))if(b.key.level!==e)c.setLabelMinZoom(g.id,254);else if(0===c.getLabelMinZoom(g.id))switch(f.insertMetrics(g)){case q.hasCollision:c.setLabelMinZoom(g.id,
254);a.add(g.id);break;case q.none:c.setLabelMinZoom(g.id,0),a.add(g.id)}})}_collideInvisible(f,d){const e=d.featuresView.attributeView,c=new Set;p(d,(a,b)=>{for(;b.nextId();)if(!c.has(b.id)&&255===e.getLabelMinZoom(b.id))switch(f.insertMetrics(b)){case q.hasCollision:e.setLabelMinZoom(b.id,255);c.add(b.id);break;case q.none:e.setLabelMinZoom(b.id,0),c.add(b.id)}})}_transformMetrics(f){for(const {tileRenderer:d,geometryType:e,vvEvaluators:c}of f)p(d,(a,b)=>{const g=d.featuresView.attributeView;a=
a.transforms.labelMat2d;a[4]=Math.round(a[4]);a[5]=Math.round(a[5]);const r="polyline"===e;for(;b.next();){const y=b.boundsCount,t=b.anchorX,w=b.anchorY;var m=b.size,l=c[0];if(null!=l){var k=g.getVVSize(b.id);l=l(k);m=isNaN(l)||null==l||Infinity===l?m:l}l=m/2*b.directionX;m=m/2*b.directionY;for(k=0;k<y;k++){var h=t,n=b.anchorY;r?(h=h+b.boundsX(k)+l,n=n+b.boundsY(k)+m,h=a[0]*h+a[2]*n+a[4],n=a[1]*h+a[3]*n+a[5],b.setBoundsComputedAnchorX(k,Math.floor(h)),b.setBoundsComputedAnchorY(k,Math.floor(n))):
(h=a[0]*t+a[2]*w+a[4],n=a[1]*t+a[3]*w+a[5],h=h+b.boundsX(k)+l,n=n+b.boundsY(k)+m,b.setBoundsComputedAnchorX(k,h),b.setBoundsComputedAnchorY(k,n))}}})}}u.CollisionEngine=x;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});