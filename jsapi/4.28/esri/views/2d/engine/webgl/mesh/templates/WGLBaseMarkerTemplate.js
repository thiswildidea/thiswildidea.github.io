// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../../../../core/screenUtils ../../../../../../chunks/mat2d ../../../../../../chunks/mat2df32 ../../../../../../chunks/vec2 ../../../../../../chunks/vec2f32 ../../../../../../geometry/GeometryCursor ../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper ../../definitions ../../enums ../../number ../../materialKey/MaterialKey".split(" "),function(y,p,z,m,w,A,B,q,x,l,C){const r=3.14159265359/180;return D=>class extends D{constructor(...a){super(...a);this.height=this.width=
this.yOffset=this.xOffset=this.angle=0;this.boundsType="square";this._computedHeight=this._computedWidth=this._anchorY=this._anchorX=0;this._allowBorrowing=!0;this._vertexBoundsScaleY=this._vertexBoundsScaleX=1;this.geometryType=x.WGLGeometryType.MARKER}_write(a,b,c,d){const h=b.getDisplayId();a.recordStart(h,this._materialKey,this.geometryType,!0);this._writeGeometry(a,b,h,c,d);a.recordEnd()}_writeGeometry(a,b,c,d,h){if(null!=this._markerPlacement)return this._writePlacedMarkers(a,b,d,h);this._allowBorrowing=
!0;if(!h&&"esriGeometryPoint"===b.geometryType)return d=b.getX(),b=b.getY(),!a.hasAggregates&&a.hasPixelBufferEnabled&&(0>d||513<=d||0>b||513<=b)?void 0:this._writeVertices(a,c,this._getPos(d,b),d,b);b=h?h.asOptimized():"esriGeometryPolygon"===b.geometryType?b.readCentroid():b.readGeometryForDisplay();if(null!=b){if(b.isPoint){const [e,f]=b.coords;return!a.hasAggregates&&a.hasPixelBufferEnabled&&(0>e||512<=e||0>f||512<=f)?void 0:this._writeVertices(a,c,this._getPos(e,f),e,f)}b.forEachVertex((e,f)=>
{const g=2*q.tileSize;e<-g||e>=g||f<-g||f>=g||this._writeVertices(a,c,this._getPos(e,f),e,f)})}}_writePlacedMarkers(a,b,c,d){if(d=d||A.GeometryCursor.fromFeatureSetReaderCIM(b))if(c=B.CIMMarkerPlacementHelper.getPlacement(d,-1,this._markerPlacement,y.pt2px(1),a.tileKey,c.geometryEngine)){this._allowBorrowing="esriGeometryPolygon"!==b.geometryType;b=b.getDisplayId();d=w.create();for(var h=z.create(),e=c.next();null!=e;){const f=e.tx,g=-e.ty;-128<=f&&640>=f&&-128<=g&&640>=g&&(this._applyTransformation(h,
d,-e.getAngle()/r),this._writeVertices(a,b,this._getPos(f,g),f,g));e=c.next()}}}_writeVertices(a,b,c,d,h){const e=C.MarkerMaterialKey.load(this._materialKey);switch(e.symbologyType){case x.WGLSymbologyType.HEATMAP:return this._writeHeatmapVertices(a,b,c);default:return this._writeMarkerVertices(a,b,e,c,d,h)}}_writeMarkerVertices(a,b,c,d,h,e){var f=c.vvRotation;c=a.vertexCount();let g=this._computedWidth*this._vertexBoundsScaleX;var k=this._computedHeight*this._vertexBoundsScaleY;this.angle&&(g=k=
Math.max(g,k));f&&(f=Math.max(this.xOffset,this.yOffset),g+=f,k+=f);this._allowBorrowing&&a.vertexBounds(h+this.xOffset,e-this.yOffset,g,k);a.vertexWrite(d);a.vertexWrite(this._offsetUpperLeft);a.vertexWrite(this._texUpperLeft);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetUpperRight);a.vertexWrite(this._texUpperRight);
a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetBottomLeft);a.vertexWrite(this._texBottomLeft);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();
a.vertexWrite(d);a.vertexWrite(this._offsetBottomRight);a.vertexWrite(this._texBottomRight);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();this._writeIndices(a,c)}_writeHeatmapVertices(a,b,c){const d=a.vertexCount();a.vertexWrite(c);a.vertexWrite(this._offsetUpperLeft);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetUpperRight);
a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetBottomLeft);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetBottomRight);a.vertexWrite(b);a.vertexEnd();this._writeIndices(a,d)}_writeIndices(a,b){a.indexWrite(b+0);a.indexWrite(b+1);a.indexWrite(b+2);a.indexWrite(b+1);a.indexWrite(b+3);a.indexWrite(b+2)}_applyTransformation(a,b,c=0){c?p.fromRotation(a,r*c):p.identity(a);p.translate(a,a,w.fromValues(this.xOffset,-this.yOffset));this.angle&&p.rotate(a,
a,r*this.angle);c=this._computedWidth;const d=this._computedHeight,h=-(.5+this._anchorX)*c,e=-(.5-this._anchorY)*d;m.set(b,h,e);m.transformMat2d(b,b,a);this._offsetUpperLeft=l.i1616to32(16*b[0],16*b[1]);m.set(b,h+c,e);m.transformMat2d(b,b,a);this._offsetUpperRight=l.i1616to32(16*b[0],16*b[1]);m.set(b,h,e+d);m.transformMat2d(b,b,a);this._offsetBottomLeft=l.i1616to32(16*b[0],16*b[1]);m.set(b,h+c,e+d);m.transformMat2d(b,b,a);this._offsetBottomRight=l.i1616to32(16*b[0],16*b[1])}_computeSize(a,b,c,d,h,
e,f,g){const k=a*c;c*=b;e.sdf&&!f?(d+=2,a=Math.min((g&&a>b?k:a)+d,k),b=Math.min(b+d,c)):(a=k,b=c);g=q.sdfTextureSize/Math.max(k,c);f=.5*(k-a)*g;var n=.5*(c-b)*g;g=e.rect.x+q.spritePadding+f;d=e.rect.y+q.spritePadding+n;f=g+e.width-2*f;e=d+e.height-2*n;n=Math.floor(g);const t=Math.floor(d),u=Math.ceil(f),v=Math.ceil(e);a*=(u-n)/(f-g);b*=(v-t)/(e-d);this._texUpperLeft=l.i1616to32(n,t);this._texUpperRight=l.i1616to32(u,t);this._texBottomLeft=l.i1616to32(n,v);this._texBottomRight=l.i1616to32(u,v);this._anchorX*=
k/a;this._anchorY*=c/b;this._computedWidth=a*h;this._computedHeight=b*h}_getPos(a,b){return l.i1616to32(Math.round(8*a),Math.round(8*b))}}});