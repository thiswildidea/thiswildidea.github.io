// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../../../../core/screenUtils ../../../../../../symbols/cim/utils ../../color ../../definitions ../../GeometryUtils ../../number ../../materialKey/MaterialKey ./util ./WGLBaseFillTemplate ./WGLDynamicMeshTemplate ../../util/Result".split(" "),function(r,m,v,b,w,t,z,A,B,C,D){class x extends B(C){constructor(a,c,u){super(a);this._minMaxZoom=t.i1616to32(Math.round(c*b.minMaxZoomPrecisionFactor),Math.round(u*b.minMaxZoomPrecisionFactor));m.isFeatureValueFn(a.color)?this._dynamicPropertyMap.set("fillColor",
(e,f,g)=>(e=a.color(e,f,g))&&v.premultiplyAlphaRGBA(e)||0):this.fillColor=(c=a.color)&&v.premultiplyAlphaRGBA(c)||0;const n="CIMMarkerPlacementInsidePolygon"===a.cim.placement?.type&&a.cim.placement.shiftOddRows?2:1,h=a.height;m.isFeatureValueFn(h)?this._dynamicPropertyMap.set("_height",(e,f,g)=>h(e,f,g)*n):this._height=(h||0)*n;const d=a.offsetX;m.isFeatureValueFn(d)?this._dynamicPropertyMap.set("_offsetX",(e,f,g)=>r.pt2px(d(e,f,g))):this._offsetX=r.pt2px(d||0);const k=a.offsetY;m.isFeatureValueFn(k)?
this._dynamicPropertyMap.set("_offsetY",(e,f,g)=>r.pt2px(-k(e,f,g))):this._offsetY=r.pt2px(-k||0);c=a.scaleX;m.isFeatureValueFn(c)?this._dynamicPropertyMap.set("_scaleX",c):this._scaleX=c||1;const l=a.angle;m.isFeatureValueFn(l)?this._dynamicPropertyMap.set("_angle",(e,f,g)=>w.degToByte(l(e,f,g))):this._angle=w.degToByte(l)||0;null!=a.effects&&(c=a.effects,m.isFeatureValueFn(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c);this._cimFillLayer=a;this._bitset=(a.colorLocked?b.bitsetGenericLockColor:
0)|(a.applyRandomOffset?b.bitsetFillRandomPatternOffset:0)|(a.sampleAlphaOnly?b.bitsetGenericConsiderAlphaOnly:0)|(a.hasUnresolvedReplacementColor?b.bitsetFillHasUnresolvedReplacementColor:0);this._fillMaterialKey=a.materialKey}static fromCIMFill(a,c){const [u,n]=A.getMinMaxZoom(a.scaleInfo,c);return new x(a,u,n)}bindFeature(a,c,u){const n=a.readLegacyFeature();this._dynamicPropertyMap.forEach((k,l)=>{this[l]=k(n,c,u)});a=z.FillMaterialKey.load(this._fillMaterialKey);var h=this._materialCache,d=this._cimFillLayer.materialHash;
d=d(n,c,u);d=h.get(d);h=null;d&&D.ok(d.spriteMosaicItem)&&(h=d.spriteMosaicItem);if(h){const {rect:k,width:l,height:e}=h;d=k.x+b.spritePadding;const f=k.y+b.spritePadding,g=d+l,y=f+e;let p=r.pt2px(this._height);0>=p&&(p=y-f);p<b.maxSizeForU16Compression&&(p*=b.compressionFactorForU16,this._bitset|=b.bitsetFillHasPatternHeightPrecisionFactor);p=Math.round(p);let q=r.pt2px(this._height/e*l);0>=q&&(q=g-d);q<b.maxSizeForU16Compression&&(q*=b.compressionFactorForU16,this._bitset|=b.bitsetFillHasPatternWidthPrecisionFactor);
q=Math.round(q);const E=this._scaleX;this.tl=t.i1616to32(d,f);this.br=t.i1616to32(g,y);this.aux21=t.i1616to32(q,p);this.aux22=t.i1616to32(this._offsetX,this._offsetY);this.aux3=t.i8888to32(E*b.compressionFactorForU16,1*b.compressionFactorForU16,this._angle,0);a.sdf=h.sdf;a.pattern=!0;a.textureBinding=h.textureBinding}else this.aux3=this.aux22=this.aux21=this.br=this.tl=0,a.sdf=!1,a.pattern=!1,a.textureBinding=0;this._materialKey=a.data}}return x});