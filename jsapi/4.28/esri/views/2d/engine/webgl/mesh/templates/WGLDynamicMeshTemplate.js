// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define(["../../../../../../core/Logger","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/cim/utils","./WGLMeshTemplate"],function(t,u,k,v){const m=t.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class w extends v{constructor(d){super();this._ongoingMaterialRequestMap=new Map;this._materialCache=new Map;this._dynamicPropertyMap=new Map;this._cimLayer=d}async analyze(d,b,e,f,g){if(g&&0===g.length)return null;const n=g&&0<g.length,h=b.readLegacyFeature();b=b.getObjectId();
const p=this._materialCache;var a=this._cimLayer.materialHash;if(!a)return m.error("A Dynamic mesh template must have a material hash value or function!"),null;const c="function"===typeof a?a(h,e,f,b):a;a=p.get(c);if(null!=a||(a=this._ongoingMaterialRequestMap.get(c)))return a;a=this._cimLayer;const q=u.analyzeCIMResource(a.cim,this._cimLayer.materialOverrides);q.mosaicHash=c;const {type:r,url:x}=a;b={cim:q,type:r,mosaicHash:c,url:x,size:null,dashTemplate:null,text:null,fontName:null,objectId:b,animatedSymbolProperties:null};
switch(r){case "marker":b.size=k.evaluateValueOrFunction(a.size,h,e,f);b.animatedSymbolProperties=k.evaluateValueOrFunction(a.animatedSymbolProperties,h,e,f);break;case "line":b.dashTemplate=a.dashTemplate;break;case "text":b.text=k.evaluateValueOrFunction(a.text,h,e,f),b.fontName=k.evaluateValueOrFunction(a.fontName,h,e,f)}d=d.getMosaicItem(b,g).then(l=>{n||(this._ongoingMaterialRequestMap.delete(c),p.set(c,l));return l}).catch(l=>{this._ongoingMaterialRequestMap.delete(c);m.error(".analyze()",l.message);
return null});n||this._ongoingMaterialRequestMap.set(c,d);return d}}return w});