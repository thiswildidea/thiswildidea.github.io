// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../../core/Error ../../../../core/events ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/perspectiveUtils ../../../../core/reactiveUtils ../../../../chunks/mat3f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../symbols/cim/enums ../DisplayObject ./animatedFormats/utils ../../../webgl/BufferObject ../../../webgl/contextUtils ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor ../../../webgl/VertexArrayObject".split(" "),
function(w,x,y,n,r,z,l,A,B,C,p,D,E,t,u,q,v,F,G){function H(b){return b?{...b,playAnimation:b.playing,repeatType:b.repeatType?I[b.repeatType]:void 0}:{}}const m=A.create(),I={none:p.AnimatedSymbolRepeatType.None,loop:p.AnimatedSymbolRepeatType.Loop,oscillate:p.AnimatedSymbolRepeatType.Oscillate};class J extends D.DisplayObject{constructor(b){super();this.elementView=b;this.isWrapAround=!1;this.perspectiveTransform=C.create();this._playHandle=null;this._vertices=new Float32Array(20);this._handles=[];
this._handles.push(l.watch(()=>this.elementView.element.opacity,c=>this.opacity=c,l.initial),l.watch(()=>[this.elementView.coords],()=>{this.requestRender()},l.initial),l.watch(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._playHandle?.remove();this.texture=r.disposeMaybe(this.texture);this.requestRender()},l.initial),l.when(()=>this.elementView.element.loaded,()=>{const c=this.elementView.element;this.ready();"video"===c.type&&null!=c.content&&
this._handles.push(x.on(c.content,"play",()=>this.requestRender()))},l.initial));b.element.load().catch(c=>{y.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new w("element-load-error","Element cannot be displayed",{element:b,error:c}))})}destroy(){this._playHandle?.remove();this._handles.forEach(b=>b.remove());this.texture=r.disposeMaybe(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(b){const {context:c}=b,a=this.elementView.element.content;if(null!=a){var d=a instanceof
HTMLImageElement;const h=a instanceof HTMLVideoElement,k=d?a.naturalWidth:h?a.videoWidth:a.width;d=d?a.naturalHeight:h?a.videoHeight:a.height;this._updatePerspectiveTransform(k,d);if(this.texture)h&&!a.paused&&(this.texture.setData(a),this.requestRender(),(c.type===u.ContextType.WEBGL2||n.isPowerOfTwo(k)&&n.isPowerOfTwo(d))&&this.texture.generateMipmap());else{const g=new F.TextureDescriptor;g.wrapMode=q.TextureWrapMode.CLAMP_TO_EDGE;g.preMultiplyAlpha=!0;g.width=k;g.height=d;if("getFrame"in a){const f=
e=>{this.texture?this.texture.setData(e):this.texture=new v.Texture(c,g,e);this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=E.play(a,H(this.elementView.element.animationOptions),null,f))}else this.texture=new v.Texture(c,g,a);(c.type===u.ContextType.WEBGL2||n.isPowerOfTwo(k)&&n.isPowerOfTwo(d))&&this.texture.generateMipmap();h&&!a.paused&&this.requestRender()}}super.beforeRender(b)}_createTransforms(){return null}updateDrawCoords(b,c){var a=this.elementView.coords;
if(null!=a){var [d,h,k,g]=a.rings[0];a=this._vertices;var {x:f,y:e}=b;(b=0!==c)?a.set([h[0]-f,h[1]-e,d[0]-f,d[1]-e,k[0]-f,k[1]-e,g[0]-f,g[1]-e,g[0]-f,g[1]-e,h[0]+c-f,h[1]-e,h[0]+c-f,h[1]-e,d[0]+c-f,d[1]-e,k[0]+c-f,k[1]-e,g[0]+c-f,g[1]-e]):a.set([h[0]-f,h[1]-e,d[0]-f,d[1]-e,k[0]-f,k[1]-e,g[0]-f,g[1]-e]);this.isWrapAround=b}}getVAO(b,c,a){if(null==this.elementView.coords)return null;var d=this._vertices;this._vao?this._geometryVbo.setData(d):(this._geometryVbo=t.BufferObject.createVertex(b,q.Usage.DYNAMIC_DRAW,
d),d=t.BufferObject.createVertex(b,q.Usage.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1])),this._vao=new G.VertexArrayObject(b,a,c,{geometry:this._geometryVbo,tex:d}));return this._vao}_updatePerspectiveTransform(b,c){const a=this._vertices;z.getProjectiveTransform(m,[0,0,b,0,0,c,b,c],[a[0],a[1],a[4],a[5],a[2],a[3],a[6],a[7]]);B.set(this.perspectiveTransform,m[6]/m[8]*b,m[7]/m[8]*c)}}return J});