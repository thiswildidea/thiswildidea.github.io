// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../../chunks/tslib.es6 ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../engine/imagery/RasterTileContainer ./BaseImageryTileSubView2D ../support/util".split(" "),function(l,q,k,w,x,r,t,u,v){k=class extends u.BaseImageryTileSubView2D{constructor(){super(...arguments);this.type="raster"}attach(){super.attach();this.container=new t.RasterTileContainer(this._tileInfoView);
this.container.isCustomTilingScheme=this._isCustomTilingScheme;this.updateRasterFunctionParameters()}detach(){super.detach();this.container.removeAllChildren();this.container=null}canUseWebGLForProcessing(){const {symbolizer:a}=this.layer;var b=a.lookup?.colormapLut?.indexedColormap;b=b&&b.length>this._maxIndexedColormapSize;return this.useWebGLForProcessing&&a.canRenderInWebGL&&!b&&!("majority"===this.layer.interpolation&&v.canUseMajorityInterpolationOnDataSource(this.layer))}fetchTile(a,b){return this.layer.fetchTile(a.level,
a.row,a.col,b)}updateRasterFunctionParameters(){const {raster:a,type:b}=this.layer,{container:d}=this;if("Function"!==a.datasetFormat||"wcs"===b)d.rasterFunctionChain=null,d.children.forEach(c=>{({bitmap:c}=c);c&&(c.suspended=!0,c.processed=!1,c.projected&&(c.invalidateTexture(),c.rasterTexture=null))}),this._rasterFunctionState="na";else{var h=this._rasterFunctionState,{rasterFunction:g,primaryRasters:e}=a,f=g.supportsGPU&&(!e||1>=e.rasters.length),m=f?g.flatWebGLFunctionChain:null,{renderer:n}=
this.layer;f=!f||!m?.functions.length||"raster-stretch"===n?.type&&n.dynamicRangeAdjustment||!this.canUseWebGLForProcessing();d.rasterFunctionChain=f?null:m;var p=null==g?"na":d.rasterFunctionChain?"gpu":"cpu";d.children.forEach(c=>{({bitmap:c}=c);c&&(c.suspended=h!==p,c.processed=!1,c.processedTexture=null)});this._rasterFunctionState=p}}async updateTileSource(a,b){const d=this._getBandIds(),h=this._getLayerInterpolation(),g=this.canUseWebGLForProcessing(),{source:e,globalSymbolizerParams:f,suspended:m,
coords:n,resolution:p}=b;b=this.layerView.hasTilingEffects?f:b.symbolizerParams;({bitmap:a}=a);[a.x,a.y]=n;a.resolution=p;if(null!=e?.pixelBlock){var c={extent:e.extent,pixelBlock:e.pixelBlock,srcPixelSize:e.srcTilePixelSize};a.rawPixelData=c;g?(a.source=e.pixelBlock,a.isRendereredSource=!1):(c=await this.layer.applyRenderer(c,"stretch"===f?.type?f:void 0),a.source=c,a.isRendereredSource=!0);a.symbolizerParameters=g?b:null;a.transformGrid=g?e.transformGrid:null}else c=this.createEmptyTilePixelBlock(),
a.source=c,a.symbolizerParameters=g?b:null,a.transformGrid=null;a.bandIds=g?d:null;a.width=this._tileInfoView.tileInfo.size[0];a.height=this._tileInfoView.tileInfo.size[1];a.interpolation=h;a.suspended=m;a.invalidateTexture()}async updateTileSymbolizerParameters(a,b){const {local:d,global:h}=b;b=this._getBandIds();const g=this._getLayerInterpolation(),e=this.canUseWebGLForProcessing();({bitmap:a}=a);const {rawPixelData:f}=a;e||null==f?(a.isRendereredSource&&null!=f&&(a.source=f.pixelBlock),a.isRendereredSource=
!1):(a.source=await this.layer.applyRenderer(f,"stretch"===h?.type?h:void 0),a.isRendereredSource=!0);a.symbolizerParameters=e?this.layerView.hasTilingEffects?h:d:null;a.bandIds=e?b:null;a.interpolation=g;a.suspended=!1}_getLayerInterpolation(){const {interpolation:a,renderer:b}=this.layer;if(!b)return a;const d=b.type;return"raster-colormap"===d||"unique-value"===d||"class-breaks"===d?"nearest":"raster-stretch"===b.type&&null!=b.colorRamp?"bilinear"===a||"cubic"===a?"bilinear":"nearest":a}};l.__decorate([q.property()],
k.prototype,"container",void 0);l.__decorate([q.property()],k.prototype,"layer",void 0);l.__decorate([q.property()],k.prototype,"type",void 0);return k=l.__decorate([r.subclass("esri.views.2d.layers.imagery.ImageryTileView2D")],k)});