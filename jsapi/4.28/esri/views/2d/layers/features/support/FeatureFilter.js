// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../../../core/Error ../../../../../core/Logger ../../../../../geometry/support/aaBoundingRect ../../../../../geometry/support/boundsUtils ../../../../../layers/graphics/data/queryUtils ../../../../../layers/graphics/data/spatialQuerySupport ../../../../../layers/graphics/data/timeSupport ../../../../../rest/support/Query ../FeatureStore2D ./whereUtils".split(" "),function(h,k,l,m,n,p,q,r,t,u){class v{constructor(a){this._geometryBounds=l.create();this._idToVisibility=new Map;this._serviceInfo=
a}get hash(){return this._hash}check(a){return this._applyFilter(a)}clear(){const a=this._resetAllHiddenIds();this.update();return{show:a,hide:[]}}invalidate(){this._idToVisibility.forEach((a,b)=>{this._idToVisibility.set(b,0)})}setKnownIds(a){for(const b of a)this._idToVisibility.set(b,1)}setTrue(a){const b=[],c=[],f=new Set(a);this._idToVisibility.forEach((d,e)=>{d=!!(this._idToVisibility.get(e)&1);const g=f.has(e);!d&&g?b.push(e):d&&!g&&c.push(e);this._idToVisibility.set(e,g?3:0)});return{show:b,
hide:c}}createQuery(){const {geometry:a,spatialRel:b,where:c,timeExtent:f,objectIds:d}=this;return r.fromJSON({geometry:a,spatialRel:b,where:c,timeExtent:f,objectIds:d})}async update(a,b){this._hash=JSON.stringify(a);a=await n.normalizeQueryLike(a,null,b);await Promise.all([this._setGeometryFilter(a),this._setIdFilter(a),this._setAttributeFilter(a),this._setTimeFilter(a)])}async _setAttributeFilter(a){a?.where?(this._clause=await u.createWhereClause(a.where,this._serviceInfo.fieldsIndex),this.where=
a.where):this.where=this._clause=null}_setIdFilter(a){this._idsToShow=a?.objectIds&&new Set(a.objectIds);this._idsToHide=a?.hiddenIds&&new Set(a.hiddenIds);this.objectIds=a?.objectIds}async _setGeometryFilter(a){if(a?.geometry){var b=a.geometry;a=a.spatialRel||"esriSpatialRelIntersects";var c=await p.getSpatialQueryOperator(a,b,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM);m.getBoundsXY(this._geometryBounds,b);this._spatialQueryOperator=c;this.geometry=b;this.spatialRel=
a}else this.spatialRel=this.geometry=this._spatialQueryOperator=null}_setTimeFilter(a){this.timeExtent=this._timeOperator=null;a?.timeExtent&&(this._serviceInfo.timeInfo?(this.timeExtent=a.timeExtent,this._timeOperator=q.getTimeOperator(this._serviceInfo.timeInfo,a.timeExtent,t.featureAdapter)):(a=new h("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",a.timeExtent),k.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter").error(a)))}_applyFilter(a){return this._filterByGeometry(a)&&
this._filterById(a)&&this._filterByTime(a)&&this._filterByExpression(a)}_filterByExpression(a){return this.where?this._clause(a):!0}_filterById(a){return(!this._idsToHide?.size||!this._idsToHide.has(a.getObjectId()))&&(!this._idsToShow?.size||this._idsToShow.has(a.getObjectId()))}_filterByGeometry(a){return this.geometry?(a=a.readHydratedGeometry())?this._spatialQueryOperator(a):!1:!0}_filterByTime(a){return null==this._timeOperator?!0:this._timeOperator(a)}_resetAllHiddenIds(){const a=[];this._idToVisibility.forEach((b,
c)=>{b&1||(this._idToVisibility.set(c,1),a.push(c))});return a}}return v});