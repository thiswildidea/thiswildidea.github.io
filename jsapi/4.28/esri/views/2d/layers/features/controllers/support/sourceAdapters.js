// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/has ../../../../../../core/workers/Connection ../../../../../../geometry/support/quantizationUtils ../../../../../../layers/graphics/featureConversionUtils ../../../../../../layers/ogc/ogcFeatureUtils ../../../../../../layers/support/FieldsIndex ../../../../../../rest/query/operations/query ../../support/FeatureSetReaderJSON ../../support/FeatureSetReaderPBF".split(" "),function(h,p,q,m,k,n,r,l,e,t){async function u(a){const b=new q;await b.open(a,{});return b}
class f{constructor(a){this.service=a;this._arcadeLayerSchema={...a,fieldsIndex:r.fromJSON(a.fieldsIndex)}}destroy(){}}class v extends f{constructor(a){super(a);this._portsOpen=u(a.source).then(b=>this.client=b)}destroy(){this.client.close();this.client=null}async executeQuery(a,b){await this._portsOpen;a=await this.client.invoke("queryFeatures",a.toJSON(),b);return e.FeatureSetReaderJSON.fromFeatureSet(a,this._arcadeLayerSchema)}}class w extends f{async executeQuery(a,b){({data:b}=await l.executeQueryPBFBuffer(this.service.source,
a,b));return t.FeatureSetReaderPBF.fromBuffer(b,this._arcadeLayerSchema,!a.quantizationParameters)}}class x extends f{async executeQuery(a,b){const {source:d,capabilities:g,spatialReference:y,objectIdField:z,geometryType:A}=this.service;if(null!=a.quantizationParameters&&!g.query.supportsQuantization){const c=a.clone();a=m.toQuantizationTransform(c.quantizationParameters);c.quantizationParameters=null;({data:b}=await l.executeQuery(d,c,y,b));b=k.convertFromFeatureSet(b,z);k.quantizeOptimizedFeatureSet(a,
b);return e.FeatureSetReaderJSON.fromOptimizedFeatureSet(b,this._arcadeLayerSchema)}({data:a}=await l.executeQuery(d,a,this.service.spatialReference,b));"esriGeometryPoint"===A&&(a.features=a.features?.filter(c=>null!=c.geometry?(c=c.geometry,Number.isFinite(c.x)&&Number.isFinite(c.y)):!0));return e.FeatureSetReaderJSON.fromFeatureSet(a,this._arcadeLayerSchema)}}class B extends f{async executeQuery(a,b){var {capabilities:d}=this.service;if(a.quantizationParameters&&!d.query.supportsQuantization){const g=
a.clone();d=m.toQuantizationTransform(g.quantizationParameters);g.quantizationParameters=null;a=await n.queryOptimizedFeatureSet(this.service.source,a,b);k.quantizeOptimizedFeatureSet(d,a);return e.FeatureSetReaderJSON.fromOptimizedFeatureSet(a,this._arcadeLayerSchema)}a=await n.queryOptimizedFeatureSet(this.service.source,a,b);return e.FeatureSetReaderJSON.fromOptimizedFeatureSet(a,this._arcadeLayerSchema)}}h.SourceAdapter=f;h.createSourceAdapter=function(a){const {capabilities:b}=a;return"ogc-source"===
a.source?.type?new B(a):Array.isArray(a.source)?new v(a):b.query.supportsFormatPBF&&p("featurelayer-pbf")?new w(a):new x(a)};Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});