// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/CircularArray ../../../../core/Evented ../../../../core/has ../../../../chunks/rbush ../../../../geometry/support/aaBoundingBox ./Store2D ./support/FeatureSetReaderPBFIndirect".split(" "),function(h,n,p,v,q,k,r,t){const l=k.create(),m={getObjectId(a){return a.getObjectId()},getAttributes(a){return a.readAttributes()},getAttribute(a,b){return a.readAttribute(b)},getAttributeAsTimestamp(a,b){return a.readAttributeAsTimestamp(b)},cloneWithGeometry(a,b){return a},getGeometry(a){return a.readHydratedGeometry()},
getCentroid(a,b){return a.readCentroid()}};class u extends r.Store2D{constructor(a,b,c){super(a,b);this.featureAdapter=m;this.events=new p;this._featureSetsByInstance=new Map;this._objectIdToDisplayId=new Map;this._spatialIndexInvalid=!0;this._indexSearchCache=new n(50);this._index=q.rbush(9,d=>({minX:this._storage.getXMin(d),minY:this._storage.getYMin(d),maxX:this._storage.getXMax(d),maxY:this._storage.getYMax(d)}));this.mode=c}get storeStatistics(){let a=0,b=0,c=0;this.forEach(d=>{if(d=d.readGeometry())b+=
d.isPoint?1:d.lengths.reduce((e,f)=>e+f,0),c+=d.isPoint?1:d.lengths.length,a+=1});return{featureCount:a,vertexCount:b,ringCount:c}}hasInstance(a){return this._featureSetsByInstance.has(a)}onTileData(a,b,c){if(null==b.addOrUpdate)return b;b.addOrUpdate.attachStorage(this._storage);if("snapshot"===this.mode){for(var d=b.addOrUpdate.getCursor();d.next();){const e=d.getDisplayId();this.setComputedAttributes(this._storage,d,e,a.scale,c)}return b}this._featureSetsByInstance.set(b.addOrUpdate.instance,b.addOrUpdate);
for(d=b.addOrUpdate.getCursor();d.next();)this._insertFeature(d,a.scale,c);this._spatialIndexInvalid=!0;this.events.emit("changed");return b}search(a){this._rebuildIndex();const b=a.id;var c=this._indexSearchCache.find(f=>f.tileId===b);if(null!=c)return c.readers;c=new Map;a=this._searchIndex(a.bounds);const d=[];for(const f of a){var e=this._storage.getInstanceId(f);a=(4294901760&e)>>>16;e&=65535;c.has(a)||c.set(a,[]);c.get(a).push(e)}c.forEach((f,g)=>{g=this._featureSetsByInstance.get(g);d.push(t.FeatureSetReaderIndirect.from(g,
f))});this._indexSearchCache.enqueue({tileId:b,readers:d});return d}insert(a){const b=a.getCursor(),c=this._storage;for(;b.next();){var d=b.getIndex();d|=b.instance<<16;const e=b.getObjectId(),f=this._objectIdToDisplayId.get(e)??this._storage.createDisplayId();b.setDisplayId(f);c.setInstanceId(f,d);this._objectIdToDisplayId.set(e,f)}this._featureSetsByInstance.set(a.instance,a);this._spatialIndexInvalid=!0}remove(a){const b=this._objectIdToDisplayId.get(a);if(b){var c=this._storage.getInstanceId(b),
d=65535&c;c=(4294901760&c)>>>16;var e=this._featureSetsByInstance.get(c);this._objectIdToDisplayId.delete(a);this._storage.releaseDisplayId(b);e.removeAtIndex(d);e.isEmpty&&this._featureSetsByInstance.delete(c);this._spatialIndexInvalid=!0}}forEach(a){this._objectIdToDisplayId.forEach(b=>{b=this._storage.getInstanceId(b);b=this._lookupFeature(b);a(b)})}forEachUnsafe(a){this._objectIdToDisplayId.forEach(b=>{var c=this._storage.getInstanceId(b);b=65535&c;c=this._getFeatureSet((4294901760&c)>>>16);c.setIndex(b);
a(c)})}forEachInBounds(a,b){a=this._searchIndex(a);for(const c of a)a=this.lookupFeatureByDisplayId(c,this._storage),b(a)}forEachBounds(a,b){this._rebuildIndex();for(const c of a)c.readGeometry()&&(a=c.getDisplayId(),k.fromRectValues(l,this._storage.getXMin(a),this._storage.getYMin(a),this._storage.getXMax(a),this._storage.getYMax(a)),b(l))}sweepFeatures(a,b,c){this._spatialIndexInvalid=!0;this._objectIdToDisplayId.forEach((d,e)=>{a.has(d)||(b.releaseDisplayId(d),c&&c.unsetAttributeData(d),this._objectIdToDisplayId.delete(e))});
this.events.emit("changed")}sweepFeatureSets(a){this._spatialIndexInvalid=!0;this._featureSetsByInstance.forEach((b,c)=>{a.has(c)||this._featureSetsByInstance.delete(c)})}lookupObjectId(a,b){a=this.lookupFeatureByDisplayId(a,b);return null==a?null:a.getObjectId()}lookupDisplayId(a){return this._objectIdToDisplayId.get(a)}lookupFeatureByDisplayId(a,b){a=b.getInstanceId(a);return this._lookupFeature(a)}lookupByDisplayIdUnsafe(a){var b=this._storage.getInstanceId(a);a=65535&b;b=this._getFeatureSet((4294901760&
b)>>>16);if(!b)return null;b.setIndex(a);return b}_insertFeature(a,b,c){const d=this._storage,e=a.getObjectId();var f=a.getIndex();f|=a.instance<<16;d.getInstanceId(a.getDisplayId());let g=this._objectIdToDisplayId.get(e);g||(g=d.createDisplayId(),this._objectIdToDisplayId.set(e,g),this._spatialIndexInvalid=!0);a.setDisplayId(g);d.setInstanceId(g,f);this.setComputedAttributes(d,a,g,b,c)}_searchIndex(a){this._rebuildIndex();return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}_rebuildIndex(){if(this._spatialIndexInvalid){var a=
[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(b=>{for(b=b.getCursor();b.next();){const c=b.getDisplayId();this._storage.setBounds(c,b)&&a.push(c)}}):this._objectIdToDisplayId.forEach(b=>{const c=this._storage.getInstanceId(b);this._storage.setBounds(b,this._lookupFeature(c))&&a.push(b)});this._index.clear();this._index.load(a);this._indexSearchCache.clear();this._spatialIndexInvalid=!1}}_lookupFeature(a){var b=this._getFeatureSet((4294901760&a)>>>16);if(b)return b=b.getCursor(),b.setIndex(65535&
a),b}_getFeatureSet(a){return this._featureSetsByInstance.get(a)}}h.FeatureStore2D=u;h.featureAdapter=m;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});