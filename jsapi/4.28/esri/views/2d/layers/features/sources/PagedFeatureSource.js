// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Error","../../../../../core/Logger","../../../../../core/promiseUtils","./BaseFeatureSource"],function(q,r,t,h,u){class v extends u.BaseFeatureSource{constructor(a){super(a)}async _fetchDataTile(a){const d=this._subscriptions.get(a.key.id);let f=!1,m=0,e=0;const l=(g,c)=>{e--;h.throwIfAborted(d);const k=a.id,b=g.reader;g=g.query;b.exceededTransferLimit?(c={id:k,addOrUpdate:b,end:f&&0===e,type:"append"},d.add({message:c,query:g}),this._onMessage(c)):(f=!0,c={id:k,
addOrUpdate:b,end:0===e,type:"append"},d.add({message:c,query:g}),this._onMessage(c))};let p=0,w=0;for(;!f&&20>w++;){let g;for(let c=0;c<p+1;c++){const k=m++;e++;g=this._fetchDataTilePage(a,k,d).then(b=>b&&l(b,k)).catch(b=>{f=!0;if(!h.isAbortError(b)){t.getLogger("esri.views.2d.layers.features.sources.PagedFeatureSource").error(new r("mapview-query-error","Encountered error when fetching tile",{tile:a,error:b}));b={id:a.id,addOrUpdate:null,end:f,type:"append"};var n={start:this.pageSize*m,num:this.pageSize,
returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};null!=this.maxRecordCountFactor&&(n.maxRecordCountFactor=this.maxRecordCountFactor);n=this.createTileQuery(a,n);d.add({message:b,query:n});this._onMessage(b)}})}await g;h.throwIfAborted(d);p=Math.min(p+2,6)}}async _fetchDataTilePage(a,d,f){h.throwIfAborted(f);const m=this._queryInfo;var e={start:this.pageSize*d,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};
null!=this.maxRecordCountFactor&&(e.maxRecordCountFactor=this.maxRecordCountFactor);e=this.createTileQuery(a,e);try{const l=await this.enqueueQuery({tile:a,query:e,signal:f.signal,depth:d});h.throwIfAborted(f);return l?m!==this._queryInfo?this._fetchDataTilePage(a,d,f):{reader:l,query:e}:null}catch(l){return h.throwIfNotAbortError(l),null}}}q.PagedFeatureSource=v;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});