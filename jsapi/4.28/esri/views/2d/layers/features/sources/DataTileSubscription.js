// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/arrayUtils ../../../../../core/CircularArray ../../../../../core/has ../../../../../core/promiseUtils ../support/FeatureSetReaderJSON ../support/UpdateToken".split(" "),function(g,l,m,h,e,n,d){class p{constructor(a,b){this.requests={done:[],stream:new m(10)};this._edits=null;this._abortController=new AbortController;this._version=0;this.didSend=this._isDone=!1;this.tile=a;this._version=b;this._resolver=e.createResolver();this._resolver.promise.catch(c=>e.throwIfNotAbortError(c))}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length&&
null==this.edits}get edits(){return this._edits}get done(){return this._resolver.promise}get isDone(){return this._isDone}resolve(){this._isDone=!0;this._resolver.resolve()}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(b=>b.message.status.unset(a));this._version=a.version;null!=this._edits&&this._edits.status.unset(a)}add(a){a.message.status=a.message.status??d.UpdateToken.empty();a.message.status.version=this._version;h("esri-2d-update-debug")&&console.debug(this.tile.id,
"DataTileSubscription:add",this._version);a.message.end&&(this.requests.done.forEach(b=>{null!=b.message&&b.message.end&&(b.message.end=!1)}),this._resolver.resolve(),this._isDone=!0);this.requests.done.push(a)}edit(a,b){const c=a.getQuantizationTransform(),q=a.fullSchema(),k=Array.from(a.features()).filter(l.isSome),r=k.map(f=>f.objectId);b=[...b,...r];this.removeIds(b);this._invalidate();null==this._edits?this._edits={type:"append",addOrUpdate:n.FeatureSetReaderJSON.fromOptimizedFeatures(k,q,c),
id:this.tile.id,status:d.UpdateToken.empty(),end:!0}:(this.requests.done.forEach(f=>f.message.end=!1),this._edits.addOrUpdate.append(a.features()))}*readers(){for(const {message:a}of this.requests.done)null!=a.addOrUpdate&&(yield a.addOrUpdate);null!=this._edits?.addOrUpdate&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=d.UpdateToken.empty();null!=this._edits&&(this._edits.status=d.UpdateToken.empty())}removeIds(a){this._invalidate();for(const {message:b}of this.requests.done){const c=
b.addOrUpdate;null!=c&&(c.removeIds(a),c.isEmpty&&(h("esri-2d-update-debug")&&console.debug("Removing FeatureSetReader"),b.addOrUpdate=null))}null!=this._edits?.addOrUpdate&&this._edits.addOrUpdate.removeIds(a);this.requests.done=this.requests.done.filter(b=>b.message.addOrUpdate||b.message.end)}abort(){this._abortController.abort();this._resolver.reject(e.createAbortError())}}g.DataTileSubscription=p;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});