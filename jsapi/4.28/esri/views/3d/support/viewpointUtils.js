// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../Camera ../../../geometry ../../../Graphic ../../../Viewpoint ../../../core/asyncUtils ../../../core/has ../../../core/Cyclical ../../../core/Error ../../../core/promiseUtils ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projection ../../../geometry/projection/computeTranslationToOriginAndRotation ../../../geometry/projection/projectPointToVectorWithEngine ../../../geometry/projection/projectVectorToPoint ../../../geometry/projection/projectVectorToVector ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../geometry/support/scaleUtils ../camera/intersectionUtils ./cameraUtils ./ElevationProvider ../../../geometry/Point ../../../geometry/Extent ../../../geometry/SpatialReference ../../../geometry/Geometry ../../../geometry/Multipoint".split(" "),
function(x,R,Aa,ea,H,S,Ba,w,I,T,U,fa,ha,n,B,u,ia,J,V,ja,q,W,ka,la,y,k,X,C,ma,Y,na,oa){async function Z(a,b,c,e){var f=b.camera;if(null!=f)return pa(f,k.getViewSR(a),e);({targetGeometry:f}=b);if(null==f)throw Error("Viewpoint has no targetGeometry!");const {camera:d,mode:g}=aa(a,b.rotation,c);if("point"===f.type)return qa(a,b,f,d,g,e);b=f.extent;if(null==b)throw Error("Target geometry has no extent!");return k.fromExtentAsync(a,b,d.heading,d.tilt,g,e)}async function pa(a,b,c){b=await u.projectWithZConversion(a.position,
b,{signal:c});T.throwIfAborted(c);a=a.clone();a.position=b.clone();return a}function aa(a,b,c){a=k.internalToExternal(a,a.state.camera);let e=k.OrientationMode.ADJUST;null!=b&&(a.heading=360-w.cyclicalDegrees.normalize(b),e=k.OrientationMode.LOCKED);null!=c&&(a.tilt=c);return{camera:a,mode:e}}async function qa(a,b,c,e,f,d){const g=a.spatialReference;c=await u.projectWithZConversion(c.clone(),g,{signal:d});T.throwIfAborted(d);b=null!=b.scale?k.scaleToDistance(a,b.scale,c.latitude):a.state.camera.distance;
return k.fromCenterDistanceAsync(a,c,b,e,f,d)}function K(a,b){return null==b.scale&&null!=b.zoom?k.zoomToScale(a,b.zoom):b.scale}function L(a,b){let c=!1;null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=360-w.cyclicalDegrees.normalize(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&(a.fov=b.fov);return c}function M(a,b,c,e){const f=a.spatialReference||Y.WGS84;b=null!=b?b:k.externalToInternal(a,c);if(null==b)return e;e.targetGeometry=V.projectVectorToPoint(b.center,
a.renderSpatialReference,f);e.scale=k.computeScale(a,b);e.rotation=w.cyclicalDegrees.normalize(360-c.heading);e.camera=c;return e}async function D(a,b,c,e){const f=()=>new I("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!b)throw f();"mesh"===b.type&&(b=b.extent);const d=b.spatialReference,g=a.spatialReference,h=a.basemapTerrain.spatialReference;if(!b.hasZ&&a.basemapTerrain){let l;switch(b.type){case "point":l=b;break;case "multipoint":case "polyline":l=b.extent?.center;
break;case "extent":l=b.center;break;case "polygon":l=b.centroid}null!=l&&null!=h&&null!=a.elevationProvider?(l=await u.projectWithZConversion(l,h,{signal:e}),m[2]=X.getElevationAtPoint(a.elevationProvider,l)??0):m[2]=0}const p=[];(0,ra[b.type])(b,b.hasZ?l=>{p.push([l[0],l[1],l[2]])}:l=>{p.push([l[0],l[1]])},m);if(0===p.length)throw f();a=await u.projectWithZConversion(new oa({spatialReference:d,hasZ:b.hasZ,hasM:!1,points:p}),g,{signal:e});b.hasZ&&(c.hasZ=!0);if(b.hasZ)for(const [l,t,z]of a.points)m[0]=
l,m[1]=t,m[2]=z,q.expandWithVec3(c.boundingBox,m);else for(const [l,t]of a.points)m[0]=l,m[1]=t,q.expandWithVec3(c.boundingBox,m)}async function sa(a,b,c,e,f){const d=await S.result(a.whenViewForGraphic(b));if(!1!==d.ok&&null!=d.value&&"whenGraphicBounds"in d.value)if(c=await S.result(d.value.whenGraphicBounds(b,{minDemResolution:c})),!1!==c.ok&&c.value){var {screenSpaceObjects:g,boundingBox:h}=c.value;q.expandWithAABB(e.boundingBox,h);g&&g.forEach(p=>{e.screenSpaceObjects.push(p)});isFinite(h[2])&&
(e.hasZ=!0)}else await D(a,b.geometry,e,f);else await D(a,b.geometry,e,f)}async function ba(a,b,c,e,f){if(Array.isArray(b)&&2===b.length){const d=b[0],g=b[1];if("number"===typeof d&&"number"===typeof g){r.x=d;r.y=g;r.z=void 0;r.spatialReference=a.spatialReference?.isGeographic?a.spatialReference:Y.WGS84;await D(a,r,e,f);return}}b&&"map"in b&&"function"===typeof b.map?await Promise.allSettled(b.map(d=>ba(a,d,c,e,f))):b instanceof na?await D(a,b,e,f):b instanceof ea&&await sa(a,b,c,e,f)}async function ta(a,
b,c,e,f){if(null!=b.camera)return ca(a,b.camera,e,f);f.scale=b.scale;f.rotation=b.rotation;f.targetGeometry=null!=b.targetGeometry?b.targetGeometry.clone():null;f.camera=null;null!=c.heading?f.rotation=w.cyclicalDegrees.normalize(360-c.heading):null!=c.rotation&&(f.rotation=c.rotation);b=K(a,c);null!=b&&(f.scale=b);f.camera=await Z(a,f,c.tilt,e);return f}async function ca(a,b,c,e){c=await u.projectWithZConversion(b.position,a.spatialReference,{signal:c});b=b.clone();b.fov=a.camera.fov;b.position=
c;return M(a,null,b,e)}async function ua(a,b,c,e,f,d,g){const h=a.renderSpatialReference;await J.projectPointToVectorWithEngine(b,N,h,0,{signal:g});await J.projectPointToVectorWithEngine(c,E,h,0,{signal:g});d.targetGeometry=new C(b);f.position=new C(c);n.subtract(F,N,E);k.directionToHeadingTilt(a,E,F,e.up,f);d.scale=k.distanceToScale(a,n.distance(E,N),d.targetGeometry.latitude);d.rotation=w.cyclicalDegrees.normalize(360-f.heading);d.camera=f;return d}async function O(a,b,c,e,f,d){if(null==c)throw new I("createfromcenter",
"invalid point");d.targetGeometry=c.clone();const g=y.cameraOnContentAlongViewDirection(a);if(b.position)return ua(a,d.targetGeometry,b.position,g,e,d,f);if(b.zoomFactor){var h=g.distance/b.zoomFactor;const p=n.scale(m,g.viewForward,-h);g.eye=n.add(m,g.center,p);d.scale=k.distanceToScale(a,h,c.latitude)}k.internalToExternal(a,g,e);h=L(e,b)?k.OrientationMode.LOCKED:k.OrientationMode.ADJUST;b.zoomFactor||(b=K(a,b),null==b?({renderSpatialReference:b}=a,await J.projectPointToVectorWithEngine(c,m,b,0,
{signal:f}),ka.intersectsPoint(g.frustum,m)?d.scale=k.distanceToScale(a,n.distance(g.eye,m),c.latitude):d.scale=k.computeScale(a,g)):d.scale=b,d.camera=await k.fromCenterScale(a,d.targetGeometry,d.scale,e,h,f));return d}async function va(a,b,c,e,f){var d=y.cameraOnContentAlongViewDirection(a);n.copy(F,d.viewForward);k.directionToHeadingTilt(a,d.eye,F,d.up,P);d=a.spatialReference;const {position:g}=b;g?(f=await u.projectWithZConversion(g,d,{signal:f}),c.position=f):c.position=new C;c.heading=null!=
b.heading?b.heading:P.heading;c.tilt=null!=b.tilt?b.tilt:P.tilt;return M(a,null,c,e)}async function wa(a,b,c,e,f){var d=y.cameraOnContentAlongViewDirection(a);const {spatialReference:g,renderSpatialReference:h}=a;d=V.projectVectorToPoint(d.center,h,g);return O(a,b,d,c,e,f)}async function xa(a,b,c,e,f,d){d.targetGeometry=c.clone();const g=y.cameraOnContentAlongViewDirection(a);k.internalToExternal(a,g,e);b=L(e,b)?k.OrientationMode.LOCKED:k.OrientationMode.ADJUST;d.camera=await k.fromExtentAsync(a,
c,e.heading,e.tilt,b,f);return d}async function ya(a,b,c,e,f,d,g,h){h.targetGeometry=c.clone();const p=y.cameraOnContentAlongViewDirection(a);var l=0;null!=c.z?l=c.z:a.basemapTerrain&&a.elevationProvider&&(l=X.getElevationAtPoint(a.elevationProvider,c));n.set(m,c.x,c.y,l);ia.computeTranslationToOriginAndRotation(a.spatialReference,m,da,a.renderSpatialReference);U.fromMat4(G,da);U.transpose(G,G);q.empty(A);c=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(var t=0;t<c.length;t++){const z=
c[t];let Q=e[z[2]];isFinite(Q)||(Q=l);n.set(m,e[z[0]],e[z[1]],Q);ja.projectVectorToVector(m,a.spatialReference,m,a.renderSpatialReference);q.expandWithVec3(A,n.transformMat3(m,m,G))}e=q.width(A);l=q.height(A);c=q.depth(A);t=1/Math.tan(p.fovY/2);f=Math.max(.5*Math.sqrt(e*e+c*c)*Math.max(t,1/Math.tan(p.fovX/2))+.5*l,.5*l*t+.5*Math.max(e,c))/f;k.internalToExternal(a,p,d);b=L(d,b)?k.OrientationMode.LOCKED:k.OrientationMode.ADJUST;h.scale=k.distanceToScale(a,f,h.targetGeometry.latitude);h.camera=await k.fromCenterScale(a,
h.targetGeometry,h.scale,d,b,g);return h}function v(a){null!=a?.camera&&(a.rotation=w.cyclicalDegrees.normalize(360-a.camera.heading));return a}const m=B.create(),da=ha.create(),G=fa.create(),A=q.create(),za=W.create(),F=B.create(),E=B.create(),N=B.create(),P={heading:0,tilt:0},r=new C,ra={point(a,b,c){c[0]=a.x;c[1]=a.y;null!=a.z&&(c[2]=a.z);b(c)},polygon(a,b,c){const e=a.hasZ;for(let f=0;f<a.rings.length;f++){const d=a.rings[f];for(let g=0;g<d.length;g++)c[0]=d[g][0],c[1]=d[g][1],e&&(c[2]=d[g][2]),
b(c)}},polyline(a,b,c){const e=a.hasZ;for(let f=0;f<a.paths.length;f++){const d=a.paths[f];for(let g=0;g<d.length;g++)c[0]=d[g][0],c[1]=d[g][1],e&&(c[2]=d[g][2]),b(c)}},multipoint(a,b,c){const e=a.points;a=a.hasZ;for(let f=0;f<e.length;f++)c[0]=e[f][0],c[1]=e[f][1],a&&(c[2]=e[f][2]),b(c)},extent(a,b,c){null!=a.zmin&&null!=a.zmax?(b(n.set(c,a.xmin,a.ymin,a.zmin)),b(n.set(c,a.xmax,a.ymin,a.zmin)),b(n.set(c,a.xmin,a.ymax,a.zmin)),b(n.set(c,a.xmax,a.ymax,a.zmin)),b(n.set(c,a.xmin,a.ymin,a.zmax)),b(n.set(c,
a.xmax,a.ymin,a.zmax)),b(n.set(c,a.xmin,a.ymax,a.zmax)),b(n.set(c,a.xmax,a.ymax,a.zmax))):(b(n.set(c,a.xmin,a.ymin,c[2])),b(n.set(c,a.xmax,a.ymin,c[2])),b(n.set(c,a.xmin,a.ymax,c[2])),b(n.set(c,a.xmax,a.ymax,c[2])))}};x.create=async function(a,b,c){if(b&&a.spatialReference){var e={target:void 0};"declaredClass"in b||Array.isArray(b)?e.target=b:(Object.assign(e,b),b.center&&!e.target&&(e.target=b.center));b=e}else b=null;if(!b)throw new I("viewpointutils-create:no-target","Missing target for creating viewpoint");
e=new R({fov:a.camera.fov});const f=new H({camera:e});if(b.target instanceof H)return a=await ta(a,b.target,b,c,f),v(a);if(b.target instanceof R)return v(await ca(a,b.target,c,f));var d=null!=b.scale||null!=b.zoom;if(b.target instanceof ma){var g=b.target.xmin===b.target.xmax||b.target.ymin===b.target.ymax;return d||g?v(await O(a,b,b.target.center,e,c,f)):v(await xa(a,b,b.target,e,c,f))}g={boundingBox:q.empty(),hasZ:!1,screenSpaceObjects:[]};var h=d?(h=K(a,b))?la.getResolutionInMetersForScale(h):
void 0:void 0;await ba(a,b.target,h,g,c);if(isFinite(g.boundingBox[0])){q.center(g.boundingBox,m);r.x=m[0];r.y=m[1];r.z=m[2];r.spatialReference=a.spatialReference;isFinite(r.z)&&g.hasZ?h=q.isPoint(g.boundingBox):(r.z=void 0,h=W.isPoint(q.toRect(g.boundingBox,za)));if(d||h)return v(await O(a,b,r,e,c,f));d=g.screenSpaceObjects;if(d.length){h=Number.NEGATIVE_INFINITY;for(let p=0;p<d.length;p++){const l=d[p].screenSpaceBoundingRect;h=Math.max(h,Math.abs(l[0]),Math.abs(l[1]),Math.abs(l[2]),Math.abs(l[3]))}d=
.66-h/Math.min(a.width,a.height)*2}else d=.66;return v(await ya(a,b,r,g.boundingBox,d,e,c,f))}return b.position?v(await va(a,b,e,f,c)):v(await wa(a,b,e,c,f))};x.fromCamera=function(a,b,c=null){null==c&&(c=new H);return M(a,null,b.clone(),c)};x.toCameraAsync=Z;x.toCameraSync=function(a,b,c){var e=b.camera;if(null!=e){a:{a=k.getViewSR(a);var f=e.position;try{var d=u.project(f,a)}catch(p){a=null;break a}a=e.clone();a.position=d.clone()}return a}({targetGeometry:d}=b);if(null==d)return null;const {camera:g,
mode:h}=aa(a,b.rotation,c);if("point"===d.type){a:{e=a.spatialReference;try{f=u.project(d.clone(),e)}catch(p){a=null;break a}d=null!=b.scale?k.scaleToDistance(a,b.scale,f.latitude):a.state.camera.distance;a=k.fromCenterDistanceSync(a,f,d,g,h)}return a}d=d.extent;return null==d?null:k.fromExtentSync(a,d,g.heading,g.tilt,h)};Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});