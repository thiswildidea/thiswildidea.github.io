// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../Camera ../../../core/Cyclical ../../../core/Logger ../../../core/mathUtils ../../../core/promiseUtils ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/Point ../../../geometry/projection ../../../geometry/SpatialReference ../../../geometry/projection/projectPointToVector ../../../geometry/projection/projectPointToVectorWithEngine ../../../geometry/projection/projectVectorToPoint ../../../geometry/projection/projectVectorToPointWithEngine ../../../geometry/projection/projectVectorToVector ../../ViewingMode ../camera/intersectionUtils ../../../chunks/cameraUtilsPlanar ../../../chunks/cameraUtilsSpherical ./earthUtils ./ElevationProvider ../../support/spatialReferenceSupport".split(" "),
function(k,z,G,ca,w,m,t,q,da,n,A,B,H,ea,x,I,C,D,fa,J,K,ha,L,ia){function r(a){return a.spatialReference??B.WGS84}function p(a){return"global"===a.viewingMode?K.cameraUtilsSpherical:J.cameraUtilsPlanar}function M(a,b,c){const d=a.state.camera,e=d.width/2/d.pixelRatio;a.renderCoordsHelper.viewingMode===D.ViewingMode.Global&&null!=c&&(b*=Math.cos(w.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return e/(96*39.37/b)/Math.tan(d.fovX/2)}function N(a,b,c){const d=a.state.camera;b=96*39.37/(d.width/2/
d.pixelRatio/(b*Math.tan(d.fovX/2)));a.renderCoordsHelper.viewingMode===D.ViewingMode.Global&&null!=c&&(b/=Math.cos(w.deg2rad(c)));return b*a.renderCoordsHelper.unitInMeters}async function O(a,b,c,d,e,f){b=await E(a,d.heading,d.tilt,b,c,e,f);m.throwIfAborted(f);return P(a,b,d.fov,f)}function Q(a,b,c,d,e){return p(a).directionToHeadingTilt(b,c,d,e)}function R(a,b){return!!(a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,y,a.spatialReference)&&a.elevationProvider&&(L.getElevationAtPoint(a.elevationProvider,
y)??0)>y[2]-1)}async function ja(a,b,c){if(R(a,b))return!0;const {elevationProvider:d,spatialReference:e,renderCoordsHelper:f}=a;if(null==d||!f.fromRenderCoords(b,y,e))return!1;const [g,h,l]=y;a=await d.queryElevation(g,h,l,e,"ground",c)??0;m.throwIfAborted(c);return a>l-1}async function ka(a,b,c){const d=q.create();if(null==b)return t.copy(d,a.state.camera.center);if(b instanceof n){const {renderSpatialReference:e,basemapTerrain:f,elevationProvider:g}=a,h=b.spatialReference;await ea.projectPointToVectorWithEngine(b,
d,e,0,{signal:c});m.throwIfAborted(c);null==b.z&&null!=f&&null!=g&&(b=await g.queryElevation(b.x,b.y,b.z??0,h,"ground",c),m.throwIfAborted(c),null!=b&&a.renderCoordsHelper.setAltitude(d,b));return d}return t.copy(d,b)}function la(a,b){const c=q.create();if(null==b)return t.copy(c,a.state.camera.center);if(b instanceof n){if(!H.projectPointToVector(b,c,a.renderSpatialReference))return null;const {basemapTerrain:d,elevationProvider:e}=a;null==b.z&&null!=d&&null!=e&&(b=L.getElevationAtPoint(e,b),null!=
b&&a.renderCoordsHelper.setAltitude(c,b));return c}return t.copy(c,b)}function F(a,b,c,d,e,f){const g=d instanceof n?d:null;d=la(a,d);return S(a,b,c,g,d,e,f)}async function E(a,b,c,d,e,f,g){const h=d instanceof n?d:null;d=await ka(a,d,g);m.throwIfAborted(g);return T(a,b,c,h,d,e,f,g)}function S(a,b,c,d,e,f,g){if(null==e)return null;d??(d=x.projectVectorToPoint(e,a.renderSpatialReference,r(a)));if(null==d)return null;const h=U(a,b,c,e,f,g);if(V(a,c,g)&&R(a,h.eye)){const {tilt:l,mode:u}=W(a,c,e,f);return S(a,
b,l,d,e,f,u)}return{...h,center:q.clone(e)}}async function T(a,b,c,d,e,f,g,h){d??(d=await I.projectVectorToPointWithEngine(e,a.renderSpatialReference,r(a),{signal:h}));m.throwIfAborted(h);const l=U(a,b,c,e,f,g);if(V(a,c,g)&&await ja(a,l.eye,h)){m.throwIfAborted(h);const {tilt:u,mode:ma}=W(a,c,e,f);return T(a,b,u,d,e,f,ma,h)}return{...l,center:q.clone(e)}}function U(a,b,c,d,e,f){e=Math.max(e,a.state.constraints.minimumPoiDistance);var g=c;c=e;var h=0;if(f=f===k.OrientationMode.ADJUST)if(h=a.pointsOfInterest.centerOnSurfaceFrequent.distance,
8<Math.log(c/h)/Math.LN2)f=!0;else{var l=a.renderSpatialReference,u=r(a);f=x.projectVectorToPoint(d,l,u);l=x.projectVectorToPoint(a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,l,u);null==f||null==l?f=!1:(h*=Math.tan(.5*a.state.camera.fov),f=5<l.distance(f)/h)}f?(b=0,g=p(a).eyeTiltToLookAtTilt(g,d,c),a.state.constraints.tilt?(f=a.state.constraints.tilt(c),f.max=Math.min(f.max,.5*Math.PI),h=Math.min(g,f.min*(1-.7)+.7*f.max)):h=g):h=p(a).eyeTiltToLookAtTilt(g,d,c);g=h=a.state.constraints.clampTilt(c,
h);c=g=p(a).lookAtTiltToEyeTilt(g,d,c);a=p(a).eyeForCenterWithHeadingTilt;return a(d,e,b,c)}function V(a,b,c){const d=a.map.ground.navigationConstraint;return c===k.OrientationMode.ADJUST&&"global"===a.viewingMode&&0<b&&(null==d||"stay-above"===d.type)}function W(a,b,c,d){{let f=p(a).eyeTiltToLookAtTilt(b,c,d);if(a.state.constraints.tilt){var e=a.state.constraints.tilt(d);f=Math.min(f,.5*Math.PI);e=e.min*(1-.7)+.7*f}else e=f}a=p(a).lookAtTiltToEyeTilt(e,c,d);return{tilt:a,mode:1>b-a?k.OrientationMode.LOCKED:
k.OrientationMode.ADJUST}}function X(a,b){const {state:c,spatialReference:d}=a;a=b.spatialReference;return c.isGlobal&&ia.isSpatialReferenceSupported(a,D.ViewingMode.Global)||c.isLocal&&d.equals(a)}function Y(a,b){let c;if(a.state.isGlobal){const f=new n(b.xmin,b.ymin,b.spatialReference),g=new n(b.xmax,b.ymax,b.spatialReference),h=b.spatialReference.isGeographic?na:oa;var d=new n({x:h.center(f.x,g.x),y:(g.y+f.y)/2,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:b.spatialReference});
const l=da.getReferenceEllipsoid(b.spatialReference);var e=ha.getGreatCircleSpanAt(d,f,g);c=e.lon;e=e.lat;h.diff(f.x,g.x)>h.range/2&&(c+=l.halfCircumference);c=Math.min(c,l.halfCircumference);e=Math.min(e,l.halfCircumference)}else d=a.renderSpatialReference??b.spatialReference,d.equals(b.spatialReference)||(b=A.project(b,d)),c=b.xmax-b.xmin,e=b.ymax-b.ymin,d=new n({x:b.xmin+.5*c,y:b.ymin+.5*e,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:d});a=a.state.camera;return{center:d,
distance:Math.max(1/Math.tan(a.fovX/2)*c*.5,1/Math.tan(a.fovY/2)*e*.5,1/Math.tan(a.fov/2)*(null!=b.zmax&&null!=b.zmin?b.zmax-b.zmin:0)*.5)/1}}function Z(a,b,c,d){if(null==b)return null;a=x.projectVectorToPoint(b.eye,a.renderSpatialReference,r(a));if(null==a)return null;d??(d=new z);d.position=a;d.heading=b.heading;d.tilt=b.tilt;d.fov=c;return d}async function P(a,b,c,d){a=await I.projectVectorToPointWithEngine(b.eye,a.renderSpatialReference,r(a),{signal:d});m.throwIfAborted(d);return new z(a,b.heading,
b.tilt,c)}const aa=ca.getLogger("esri.views.3d.support.cameraUtils"),ba=q.create(),pa={heading:0,tilt:0},y=q.create(),oa=new G.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),na=new G.Cyclical(-180,180);k.OrientationMode=void 0;(function(a){a[a.LOCKED=0]="LOCKED";a[a.ADJUST=1]="ADJUST"})(k.OrientationMode||(k.OrientationMode={}));const v=q.create();k.computeScale=function(a,b){C.projectVectorToVector(b.center,a.renderSpatialReference,ba,B.WGS84);return N(a,b.distance,ba[1])};k.directionToHeadingTilt=
Q;k.distanceToScale=N;k.externalToInternal=function(a,b){if(null==b)return null;var c=a.renderSpatialReference;const d=p(a).headingTiltToDirectionUp,e=q.create();if(!H.projectPointToVector(b.position,e,c))return null;c=d(e,b.heading,b.tilt);t.scale(c.direction,c.direction,a.state.camera.distance);t.add(c.direction,c.direction,e);a=fa.cameraOnContentAlongViewDirection(a,e,c.direction,c.up);a.fov=w.deg2rad(b.fov);return a};k.fromCenterDistanceAsync=O;k.fromCenterDistanceSync=function(a,b,c,d,e,f){b=
F(a,d.heading,d.tilt,b,c,e);return Z(a,b,d.fov,f)};k.fromCenterScale=async function(a,b,c,d,e,f){c=M(a,c,b.latitude);return O(a,b,c,d,e,f)};k.fromExtentAsync=async function(a,b,c,d,e,f){b=X(a,b)?b:await A.projectWithZConversion(b,a.spatialReference,{signal:f});m.throwIfAborted(f);const {center:g,distance:h}=Y(a,b);c=await E(a,c,d,g,h,e,f);m.throwIfAborted(f);return P(a,c,a.camera.fov,f)};k.fromExtentSync=function(a,b,c,d,e,f){let g;try{g=X(a,b)?b:A.project(b,a.spatialReference)}catch(u){return null}const {center:h,
distance:l}=Y(a,g);b=F(a,c,d,h,l,e);return null==b?null:Z(a,b,a.camera.fov,f)};k.getObserverForPointAtDistanceAsync=E;k.getObserverForPointAtDistanceSync=F;k.getViewSR=r;k.headingTiltToDirectionUp=function(a,b,c,d,e){return p(a).headingTiltToDirectionUp(b,c,d,e)};k.internalToExternal=function(a,b,c){const d=a.renderSpatialReference,e=Q(a,b.eye,b.viewForward,b.up,pa);a=r(a);C.projectVectorToVector(b.eye,d,v,a)||(a=B.WGS84,C.projectVectorToVector(b.eye,d,v,a));if(null==c)return new z(new n(v,a),e.heading,
e.tilt,w.rad2deg(b.fov));c.position.x=v[0];c.position.y=v[1];c.position.z=v[2];c.position.spatialReference=a;c.heading=e.heading;c.tilt=e.tilt;c.fov=w.rad2deg(b.fov);return c};k.scaleToDistance=M;k.scaleToZoom=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.levelAtScale(b);aa.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};k.toExtent=function(a,b,c){const d=x.projectVectorToPoint(c,a.renderSpatialReference,r(a));if(null==d)return null;var e=Math.tan(b.fovX/
2),f=Math.tan(b.fovY/2);b=t.dist(b.eye,c);e*=2*b;f*=2*b;return"global"===a.viewingMode?K.toExtent(a,d,e,f):J.toExtent(a,d,e,f)};k.zoomToScale=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.scaleAtLevel(b);aa.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")};Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});