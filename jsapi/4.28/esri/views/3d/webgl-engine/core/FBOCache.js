// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ./FBOPool ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Renderbuffer ../../../webgl/RenderbufferDescriptor ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(e,v,t,b,D,E,u,w,h){class F{constructor(a){this.rctx=a;this._acquired=new Set;this._cache=new t.FBOPool(a.newCache,"FBOCache");this._depthCache=new t.FBOPool(a.newCache,"DepthAttachmentCache");this._colorCache=new t.FBOPool(a.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy();
this._depthCache.destroy();this._colorCache.destroy()}clean(){this._cache.clean();this._colorCache.clean();this._depthCache.clean()}frame(){this._cache.frame();this._colorCache.frame();this._depthCache.frame()}get usedMemory(){return Array.from(this._acquired.values()).reduce((a,c)=>a+("colorTexture"in c?c.colorTexture?.gpuMemoryUsage??0:c.usedMemory),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(a){this._cache.interactive=this._colorCache.interactive=
this._depthCache.interactive=a}acquire(a,c,f){const k=`${a}x${c}x${f}`,d=this._cache.pop(k)||new G(k,new D.FramebufferObject(this.rctx,{...x[a],width:c,height:f}),g=>{d.releaseDepth();d.depth=this._acquireDepth(g,d.fbo.width,d.fbo.height);d.fbo.attachDepthStencil(d.depth.attachment);return d},(g,y)=>{g=this._acquireColor(g,c,f);d.colors??(d.colors=new Map);d.colors.set(y,g);d.fbo.attachColorTexture(g.attachment,y);return d});d.release=()=>{this._acquired.delete(d);d.releaseDepth();this._cache.put(d);
d.release=()=>console.log(`Double FBO release in ${Error().stack}`)};this.rctx.unbindTexture(d.fbo.colorTexture);return this._trackHandle(d)}acquireDepth(a,c,f){return this._acquireDepth(a,c,f)}_acquireDepth(a,c,f){const k=`${a}x${c}x${f}`,d=this._depthCache.pop(k);if(d)return this._trackHandle(d);const g=a===e.DepthFormat.DEPTH_STENCIL_TEXTURE?new z(k,new w.Texture(this.rctx,{...A[a],width:c,height:f}),()=>{this._acquired.delete(g);this._depthCache.put(g)}):new z(k,new E.Renderbuffer(this.rctx,{...A[a],
width:c,height:f}),()=>{this._acquired.delete(g);this._depthCache.put(g)});return this._trackHandle(g)}_acquireColor(a,c,f){const k=`${a}x${c}x${f}`,d=this._colorCache.pop(k);if(d)return this._trackHandle(d);const g=new H(k,new w.Texture(this.rctx,{...x[a],width:c,height:f}),()=>{this._acquired.delete(g);this._colorCache.put(g)});return this._trackHandle(g)}_trackHandle(a){this._acquired.add(a);return a}}class G{constructor(a,c,f,k){this.key=a;this.fbo=c;this.acquireDepth=f;this.acquireColor=k;this.release=
()=>{};this.incarnation=0}dispose(){this.fbo.dispose()}releaseDepth(){this.fbo.detachDepthStencilTexture();this.fbo.detachDepthStencilBuffer();this.depth=v.releaseMaybe(this.depth)}detachDepth(){const a=this.depth;this.depth=void 0;this.fbo.detachDepthStencilTexture();this.fbo.detachDepthStencilBuffer();return a}attachDepth(a){this.releaseDepth();a&&(this.fbo.attachDepthStencil(a.attachment),this.depth=a);return this}releaseColor(a){this.fbo.detachColorTexture(a);const c=this.colors?.get(a);this.colors?.delete(a);
v.releaseMaybe(c)}get colorTexture(){return this.fbo?.colorTexture}getColorTexture(a=b.ColorAttachment.COLOR_ATTACHMENT0){return this.fbo?.getColorTexture(a)}get usedMemory(){return this.fbo.gpuMemoryUsage}}class B{constructor(a,c,f){this.key=a;this.attachment=c;this.release=f;this.incarnation=0}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.gpuMemoryUsage}}class z extends B{}class H extends B{constructor(a,c,f){super(a,c,f);this.attachment=c;this.release=f}}e.ColorFormat=
void 0;(function(a){a[a.RED=0]="RED";a[a.RG=1]="RG";a[a.RGBA4=2]="RGBA4";a[a.RGBA=3]="RGBA";a[a.RGBA_MIPMAP=4]="RGBA_MIPMAP";a[a.R16F=5]="R16F";a[a.RGBA16F=6]="RGBA16F"})(e.ColorFormat||(e.ColorFormat={}));const n=new h.TextureDescriptor;n.pixelFormat=b.PixelFormat.RED;n.internalFormat=b.SizedPixelFormat.R8;n.wrapMode=b.TextureWrapMode.CLAMP_TO_EDGE;const p=new h.TextureDescriptor;p.pixelFormat=b.PixelFormat.RG;p.internalFormat=b.SizedPixelFormat.RG8;p.wrapMode=b.TextureWrapMode.CLAMP_TO_EDGE;const q=
new h.TextureDescriptor;q.internalFormat=b.SizedPixelFormat.RGBA4;q.dataType=b.PixelType.UNSIGNED_SHORT_4_4_4_4;q.wrapMode=b.TextureWrapMode.CLAMP_TO_EDGE;const C=new h.TextureDescriptor;C.wrapMode=b.TextureWrapMode.CLAMP_TO_EDGE;const l=new h.TextureDescriptor;l.wrapMode=b.TextureWrapMode.CLAMP_TO_EDGE;l.samplingMode=b.TextureSamplingMode.LINEAR_MIPMAP_LINEAR;l.hasMipmap=!0;l.maxAnisotropy=8;const m=new h.TextureDescriptor;m.pixelFormat=b.PixelFormat.RED;m.dataType=b.PixelType.HALF_FLOAT;m.internalFormat=
b.SizedPixelFormat.R16F;m.samplingMode=b.TextureSamplingMode.NEAREST;const r=new h.TextureDescriptor;r.dataType=b.PixelType.HALF_FLOAT;r.internalFormat=b.SizedPixelFormat.RGBA16F;r.samplingMode=b.TextureSamplingMode.NEAREST;const x={[e.ColorFormat.RED]:n,[e.ColorFormat.RG]:p,[e.ColorFormat.RGBA4]:q,[e.ColorFormat.RGBA]:C,[e.ColorFormat.RGBA_MIPMAP]:l,[e.ColorFormat.R16F]:m,[e.ColorFormat.RGBA16F]:r};e.DepthFormat=void 0;(function(a){a[a.DEPTH_STENCIL_TEXTURE=0]="DEPTH_STENCIL_TEXTURE";a[a.DEPTH_STENCIL_BUFFER=
1]="DEPTH_STENCIL_BUFFER";a[a.DEPTH24_BUFFER=2]="DEPTH24_BUFFER";a[a.DEPTH16_BUFFER=3]="DEPTH16_BUFFER"})(e.DepthFormat||(e.DepthFormat={}));h=new h.TextureDescriptor;h.pixelFormat=b.PixelFormat.DEPTH_STENCIL;h.dataType=b.PixelType.UNSIGNED_INT_24_8;h.samplingMode=b.TextureSamplingMode.NEAREST;h.wrapMode=b.TextureWrapMode.CLAMP_TO_EDGE;const A={[e.DepthFormat.DEPTH_STENCIL_TEXTURE]:h,[e.DepthFormat.DEPTH_STENCIL_BUFFER]:new u.RenderbufferDescriptor(b.RenderbufferFormat.DEPTH24_STENCIL8,4),[e.DepthFormat.DEPTH24_BUFFER]:new u.RenderbufferDescriptor(b.RenderbufferFormat.DEPTH_COMPONENT24,
4),[e.DepthFormat.DEPTH16_BUFFER]:new u.RenderbufferDescriptor(b.RenderbufferFormat.DEPTH_COMPONENT16,4)};e.FBOCache=F;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});