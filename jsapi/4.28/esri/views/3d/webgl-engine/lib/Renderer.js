// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/colorUtils ../../../../core/has ../../../../core/maybe ../../../../core/PooledArray ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../chunks/boundedPlane ../../support/debugFlags ../../terrain/TerrainRenderer ../core/FBOCache ../core/renderPasses/RenderPassManager ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/hud/HUDRenderStyle ../effects/RenderPluginInput ../effects/RenderPluginManager ../effects/blit/Blit ../effects/highlight/Highlight ../effects/highlight/ShadowHighlight ../effects/smaa/SMAA ../effects/ssao/SSAO ./AnimationTimeStep ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderFeature ./RenderSlot ./ShadowAccumulator ./ShadowMap ./SliceHelper ./TransparencyPassType ./edgeRendering/EdgeView ./edgeRendering/interfaces ../materials/renderers/MergedRenderer ../shaders/CompositingTechniqueConfiguration ../statistics/RendererPerformanceInfo ../../../support/RenderState ../../../webgl/enums".split(" "),
function(p,x,X,Y,Z,N,t,R,B,y,za,aa,F,G,ba,S,ca,da,O,n,ea,l,A,fa,ha,ia,ja,ka,la,ma,na,C,oa,T,pa,v,qa,ra,sa,D,c,ta,P,ua,w,va,J,wa,E,m,xa,z){function ya(a){return b=>a.immediate.schedule(b)}p.Renderer=class extends X{get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(a=null,b=!N("disable-feature:high-quality-idle")){this._renderStateFeatures=D.setupFeatureDefaults(b,a);this.notifyChange("_renderStateFeatures");this._renderPlugins.renderFeatureChanged();this._requestRender()}isFeatureEnabled(a,
b=this._state){return this._renderStateFeatures.get(b,a)??!1}setFeatureEnabled(a,b,d){this._renderStateFeatures.set(b,a,d);this.notifyChange("_renderStateFeatures");this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(D.RenderFeature.HighQualityTransparency)}get hasReflections(){return this.hasWater&&(this._ssrEnabled||this.isFeatureEnabled(D.RenderFeature.WaterReflection))}get hasDecorations(){return this._materialRenderersHas.decorations||
this._renderPlugins.hasDecorations}get hasHighlights(){return this._materialRenderersHas.highlights||this._renderPlugins.produces(c.RenderSlot.OPAQUE_MATERIAL,l.ShaderOutput.Highlight)||this._renderPlugins.produces(c.RenderSlot.DRAPED_MATERIAL,l.ShaderOutput.Highlight)}get hasShadowHighlights(){return this._materialRenderersHas.highlights||this._renderPlugins.produces(c.RenderSlot.OPAQUE_MATERIAL,l.ShaderOutput.ShadowHighlight)}get _magnifierEnabled(){return this._bindParameters.decorations===C.Decorations.ON&&
this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(D.RenderFeature.HighResolutionAtmosphere)}get hasWater(){return this._materialRenderersHas.water||this._hasOverlayWater}constructor(a,b,d,e,h,k,g,q){super({});this._stage=a;this._techniqueRepository=e;this._rctx=h;this._compositingHelper=k;this._magnifierHelper=g;this._requestRender=q;this._materialRenderers=new R;this._needsTransparentPass=!1;this._materialRenderersHas=
{hudElements:!1,highlights:!1,water:!1,decorations:!1,occludees:!1};this._hasOverlayWater=!1;this.renderOverlay=f=>{};this._isRendering=!1;this._backgroundColor=S.fromValues(0,0,0,1);this._sliceHelper=new ua;this._state=xa.RenderState.IDLE;this._highQualityTransparencyEnabled=!0;this._terrainTransparency=O.TransparencyMode.Opaque;this._hasAnimations=this._ssrEnabled=!1;this._animationTimestep=new na.AnimationTimeStep;this._renderHiddenTransparentEdges=()=>{};this._pluginInput=new fa.RenderPluginInput;
this._releaseGeometryLinearDepth=f=>f?.release();this._geometryLinearDepthFormat=n.DepthFormat.DEPTH16_BUFFER;this.fboCache=new n.FBOCache(h);this._renderStateFeatures=D.setupFeatureDefaults(!N("disable-feature:high-quality-idle"),a.view.qualityProfile);this._offscreen=new qa.OffscreenRendering(this.fboCache,this._compositingHelper);this.performanceInfo=new m.RendererPerformanceInfo(this._rctx);this._shadowMap=new P.ShadowMap(this.fboCache,a.viewingMode);this._highlight=new ja.Highlight({view:a.view});
this._shadowHighlight=new ka.ShadowHighlight({view:a.view,viewingMode:a.viewingMode});this._shadowAccumulator=new ta.ShadowAccumulator(this.fboCache,e,a,f=>{const r=this.shadowsEnabled;this._shadowMap.enabled=!0;this._prepare(f.camera,f.contentCamera);this._renderPlugins.prepareRender();this._shadowMap.enabled=r},(f,r,K)=>{f.shadowMap.start(f.camera,r,K,!0,this._stage.view.qualitySettings.maximumPixelRatio);this._renderShadowCascades(l.ShaderOutput.Shadow,f.shadowMap);f.shadowMap.finish();f.camera.setGLViewport(this._rctx);
this._prepare(f.camera,f.contentCamera)},q);this._ssao=new ma.SSAO({view:this._stage.view});this._renderContext=new ra.RenderContext(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper);this._renderPlugins=new ha.RenderPluginManager({renderContext:this._renderContext,techniqueRepository:e,textureRepository:d,materialRepository:b,requestRender:q,controller:a,fbos:this.fboCache,isFeatureEnabled:f=>this.isFeatureEnabled(f)});this.renderPassManager=new ea.RenderPassManager;this._renderPlugins.add(this.renderPassManager);
this._smaa=new la.SMAA({view:this._stage.view});this._renderPlugins.add(this._smaa);this._blit=new ia.Blit({opacity:1,alphaMode:E.AlphaMode.None});this._renderPlugins.add(this._blit);this._renderPlugins.add(this._ssao);this._renderPlugins.add(this._highlight);this._renderPlugins.add(this._shadowHighlight);this.addHandles([B.watch(()=>this._stage.view.state.camera,()=>q(),B.syncAndInitial),B.watch(()=>da.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,f=>{this._renderHiddenTransparentEdges=f?()=>this._renderEdges(J.Transparency.TRANSPARENT):
()=>{};q()},B.initial),B.watch(()=>this._stage.view.environment.background?.color,f=>{f=f?Z.unitRGBAFromColor(f):S.ZEROS;ba.set(this._backgroundColor,f[0]*f[3],f[1]*f[3],f[2]*f[3],f[3]);q()},B.syncAndInitial)])}normalizeCtorArgs(){return{}}destroy(){this._smaa.destroy();this._blit.destroy();this._gpuTimerHandle=t.removeMaybe(this._gpuTimerHandle);this._materialRenderers.forAll(a=>a.dispose());this._materialRenderers.clear();this._offscreen.dispose();this._shadowMap.dispose();this._ssao.destroy();
this._highlight.dispose();this._shadowHighlight.destroy();this._shadowAccumulator.dispose();this._edgeView=t.destroyMaybe(this._edgeView);this.renderPassManager.dispose();this._releaseFBOs();this._disposeOffscreenBuffers();this.fboCache.destroy();oa.BoundingInfo.prune()}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=t.releaseMaybe(this._bindParameters.ssr.lastFrameColor);this._bindParameters.multipassTerrain.linearDepth=t.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth);this._bindParameters.multipassGeometry.linearDepth=
t.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose();this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers();this._bindParameters.linearDepth=t.releaseMaybe(this._bindParameters.linearDepth);this._bindParameters.hudVisibility=t.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||
this._renderPlugins.updating||!this.isCameraFinal}ensureEdgeView(){null==this._edgeView&&(this._edgeView=new va.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:ya(this._stage.view.resourceController)}),this.addHandles(B.watch(()=>this._edgeView?.updating,()=>this._requestRender(),B.sync)),this._requestRender());return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return F.equals(this._bindParameters.ssr.reprojectionMatrix,
G.IDENTITY)}set _reprojectionMatrix(a){Y.update(this._bindParameters.ssr.reprojectionMatrix,a)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(a){const {_shadowMap:b,_bindParameters:d}=this;void 0!==a.qualitySettings?.reflections&&this._ssrEnabled!==a.qualitySettings.reflections&&(this._ssrEnabled=a.qualitySettings.reflections,this._requestRender());void 0!==a.shadowMap&&this._shadowMap.enabled!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,
this._requestRender());void 0!==a.shadowMapMaxCascades&&b.maxCascades!==a.shadowMapMaxCascades&&(b.maxCascades=a.shadowMapMaxCascades,this._requestRender());if(null!=a.environment){null!=a.environment.weather&&(this._bindParameters.weather=a.environment.weather,this._bindParameters.weatherVisible=!!a.weatherVisible);const e="virtual"!==a.environment.lighting.type;d.enableFillLights!==e&&(d.enableFillLights=e,this._requestRender())}void 0!==a.highQualityTransparency&&this._highQualityTransparencyEnabled!==
a.highQualityTransparency&&(this._highQualityTransparencyEnabled=a.highQualityTransparency,this._requestRender());void 0!==a.hasOverlayWater&&this._hasOverlayWater!==a.hasOverlayWater&&(this._hasOverlayWater=a.hasOverlayWater,this._requestRender());void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=a.slicePlane,this._requestRender());void 0!==a.terrainTransparency&&this._terrainTransparency!==a.terrainTransparency&&(this._terrainTransparency=a.terrainTransparency,
this._requestRender());void 0!==a.shadowCastOptions&&this._shadowAccumulator.setOptions(a.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(a,b){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:d,removes:e,updates:h}=a;if(0!==d.length||0!==
e.length||0!==h.length){var k=!1;sa.splitRenderGeometryChangeSetByMaterial(a).forEach((g,q)=>{if(!b.done){var f=this._materialRenderers.find(r=>r.material===q);null==f&&0<g.adds.length&&(f=new wa.MergedRenderer({material:q}),f.initializeRenderContext(this._renderPlugins._context),this._materialRenderers.push(f));f&&(f.modify(g),f.isEmpty&&(k=!0));g.removes.forEach(r=>a.removes.removeUnordered(r));g.adds.forEach(r=>a.adds.removeUnordered(r));g.updates.forEach(r=>a.updates.removeUnordered(r));b.madeProgress()}});
k&&this._materialRenderers.filterInPlace(g=>g.isEmpty?(g.dispose(),!1):!0);this._updateHasFlags();this._requestRender()}}_updateHasFlags(){const a=this._materialRenderersHas;a.decorations=!1;a.highlights=!1;a.hudElements=!1;a.water=!1;a.occludees=!1;this._materialRenderers.forAll(b=>{a.highlights||(a.highlights=b.hasHighlights);a.occludees||(a.occludees=b.hasOccludees);a.water||(a.water=b.hasWater);a.decorations||(a.decorations=b.isDecoration);a.hudElements||(a.hudElements=b.material.produces(c.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,
l.ShaderOutput.Color)||b.material.produces(c.RenderSlot.HUD_MATERIAL,l.ShaderOutput.Color)||b.material.produces(c.RenderSlot.LABEL_MATERIAL,l.ShaderOutput.Color))});this._bindParameters.hasOccludees=a.occludees}updateAnimation(a){const b=this._hasAnimations;this._hasAnimations=!1;this._materialRenderers.forAll(d=>this._hasAnimations=d.updateAnimation(a)||this._hasAnimations);this._hasAnimations=this._renderPlugins.updateAnimation(a)||this._hasAnimations;this._hasAnimations!==b&&(this._gpuTimerHandle=
b?t.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo());return this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(a,b,d,e,h){const k=null!=a;this._isRendering=!0;this.performanceInfo.startFrame();this.fboCache.frame();this._disposeBindBuffers();var g=this._offscreen;const {camera:q,
contentCamera:f,mode:r,alignPixelEnabled:K}=d;this._state=r;this._bindParameters.overlay=this.renderOverlay(h);this.performanceInfo.advance(m.PerformanceCategory.OVERLAY);this._renderContext.time=h;this._bindParameters.transparencyPassType=w.TransparencyPassType.NONE;this._bindParameters.alignPixelEnabled=K;this._bindParameters.decorations=e;d=ca.create(this._sliceHelper.plane);e===C.Decorations.OFF&&(this._sliceHelper.plane=null);q.setGLViewport(this._rctx);e=g.initializeFrame(q,this._backgroundColor,
k);this.hasReflections?this._bindParameters.ssr.lastFrameColor=e:e?.release();this._prepare(q,f);this._renderPlugins.prepareRender();this.performanceInfo.advance(m.PerformanceCategory.PREPARE);const L=this._computeDepthRange(q);this._renderShadowMap(q,this._bindParameters.lighting.mainLight.direction,L);this.performanceInfo.advance(m.PerformanceCategory.SHADOW_MAP);this._ensureBindParameters(q,f);const M=this._renderPlugins.produces(c.RenderSlot.OPAQUE_TERRAIN)&&(this._terrainTransparency===O.TransparencyMode.Semitransparent||
this._terrainTransparency===O.TransparencyMode.TransparentWithDraped);e=this._highQualityTransparency&&M;const Q=this._needsTransparentPass||this._renderPlugins.produces(c.RenderSlot.TRANSPARENT_MATERIAL);this._prepareShaders(e,Q);this._renderLinearDepth();this.performanceInfo.advance(m.PerformanceCategory.LINEAR_DEPTH);this._renderShadowAccumulation(L,q,f);this.performanceInfo.advance(m.PerformanceCategory.ACCUMULATED_SHADOWS);this._ensureBindParametersSSR(h);this._renderSSAO();this.performanceInfo.advance(m.PerformanceCategory.SSAO);
this._renderContext.output=l.ShaderOutput.Color;g.bindFbo();this._renderOpaqueGeometry();this._renderPlugins.render(c.RenderSlot.ENVIRONMENT_OPAQUE);this.performanceInfo.advance(m.PerformanceCategory.OPAQUE);this._renderTerrainLinearDepth(e);this._setMultipassTerrain(e);this._renderEdges(J.Transparency.OPAQUE);this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES);g.bindFbo();this._renderPlugins.render(c.RenderSlot.VOXEL);this.performanceInfo.advance(m.PerformanceCategory.VOXEL);this._renderHiddenTransparentEdges();
Q&&(this._oitEnabled?this._renderOITPass(H.Geometry):this._renderTransparentMaterial());this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT);h=this._renderGeometryLinearDepth(e);this._renderHUDVisibility(h);e||this._renderInternalSlot(c.RenderSlot.LINE_CALLOUTS);this.performanceInfo.advance(m.PerformanceCategory.HUD_VISIBILITY);this._renderObjectAndLayerIdColor(b);this.performanceInfo.advance(m.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR);this._renderEdges(J.Transparency.TRANSPARENT,
h);this._releaseGeometryLinearDepth(h);this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES);(b=M?this._renderTransparentTerrain():null)&&this._bindParameters.hudVisibility&&(e?this._renderLineCallouts(A.HUDRenderStyle.Occluded):g.compositeToHUDVisibility(this._bindParameters,b.colorTexture),this._renderHUD(A.HUDRenderStyle.Occluded,g.color),this.performanceInfo.advance(m.PerformanceCategory.HUD_OCCLUDED));this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_TERRAIN);this._setTerrainCulling(!1);
b&&(g.compositeToFramebuffer(this._bindParameters,b.colorTexture,E.AlphaMode.PremultipliedAlpha,1),b.release(),e&&(this._renderEdges(J.Transparency.OPAQUE),this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES),Q&&(this._oitEnabled?this._renderOITPass(H.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT),this._renderEdges(J.Transparency.TRANSPARENT),this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES)));this._bindParameters.ssao=
t.releaseMaybe(this._bindParameters.ssao);e&&this._renderLineCallouts(A.HUDRenderStyle.NotOccluded);this._setMultipassEnabled(!1);this._shadowAccumulator.render(this._bindParameters);g.bindFbo();this._renderInternalSlot(c.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);this._renderPlugins.render(c.RenderSlot.ENVIRONMENT_TRANSPARENT);this.performanceInfo.advance(m.PerformanceCategory.ENVIRONMENT);this._renderLaserlines();this.performanceInfo.advance(m.PerformanceCategory.LASER_LINES);this._renderOccluded();
this.performanceInfo.advance(m.PerformanceCategory.OCCLUDED);g=this._magnifierEnabled&&null==a?this.fboCache.acquire(n.ColorFormat.RGBA,this._offscreen.width,this._offscreen.height):null;b=this._renderComposite(g??a,this._offscreen.color)??a;this.performanceInfo.advance(m.PerformanceCategory.ANTIALIASING);this._renderHUD(A.HUDRenderStyle.NotOccluded,b);this.performanceInfo.advance(m.PerformanceCategory.HUD);this._renderHighlights(b,this._bindParameters);this.performanceInfo.advance(m.PerformanceCategory.HIGHLIGHTS);
this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters);b!==a&&(this._rctx.bindFramebuffer(a?.fbo),this._compositingHelper.composite(this._bindParameters,g?.colorTexture,E.AlphaMode.None));g!==a&&g?.release();if(this.onPostRender)this.onPostRender();this._releaseFBOs();this._offscreen.releaseBuffers();this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera);this._sliceHelper.plane=d;this._isRendering=!1;this.performanceInfo.finishFrame();k&&(this._releaseFBOs(),
this._disposeOffscreenBuffers())}_prepareShaders(a,b){this._renderContext.output=l.ShaderOutput.Color;this._prepareOpaqueGeometrySlots();this._setMultipassTerrain(a);this._renderPlugins.prepare(c.RenderSlot.TRANSPARENT_TERRAIN);this._setMultipassTerrain(!1);a||this._prepareInternalSlots(this._materialRenderers,c.RenderSlot.LINE_CALLOUTS);b&&this._prepareTransparencySlots();this._prepareInternalSlots(this._materialRenderers,c.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);this._renderPlugins.prepare(c.RenderSlot.ENVIRONMENT_TRANSPARENT);
this._renderPlugins.prepare(c.RenderSlot.LASERLINES);this._rctx.gl.flush()}_renderObjectAndLayerIdColor(a){if(null!=a&&N("enable-feature:objectAndLayerId-rendering")){var b=this._renderContext.output;this._rctx.bindFramebuffer(a.fbo);this._offscreen.renderToFBO(()=>this._renderAllGeometry(l.ShaderOutput.ObjectAndLayerIdColor),[0,0,0,0],!0,!0);this._rctx.bindFramebuffer(a.fbo);this._offscreen.renderToFBO(()=>{this._bindParameters.hudRenderStyle=A.HUDRenderStyle.NotOccluded;this._renderInternalSlot(c.RenderSlot.HUD_MATERIAL)},
void 0,!0,!0);this._renderContext.output=b}}finish(a){this._hasAnimations||this._animationTimestep.clear();var b=this.performanceInfo.gpuSamplingEnabled;if((a=a===C.RenderRequestType.BACKGROUND)||b){const d=a?this.performanceInfo.elapsedTime:0;b=b?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();this._animationTimestep.frame(Math.max(d,b),a)}}readDepthPixels(a,b,d){var e=this._bindParameters.linearDepth?.fbo;e?.colorTexture?e.readPixels(b[0],b[1],b[2],b[3],z.PixelFormat.RGBA,
z.PixelType.UNSIGNED_BYTE,d):(e=this.fboCache.acquire(n.ColorFormat.RGBA,this._offscreen.width,this._offscreen.height).acquireDepth(n.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(e.fbo),this._ensureBindParameters(a,a),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(z.ClearBufferBit.COLOR_BUFFER_BIT|z.ClearBufferBit.DEPTH_BUFFER_BIT|z.ClearBufferBit.STENCIL_BUFFER_BIT),this._renderAllGeometry(l.ShaderOutput.Depth),e.fbo.readPixels(b[0],
b[1],b[2],b[3],z.PixelFormat.RGBA,z.PixelType.UNSIGNED_BYTE,d),e.release())}readHUDVisibility(a,b,d,e,h){this._bindParameters.hudVisibility?.fbo.readPixels(a,b,d,e,z.PixelFormat.RGBA,z.PixelType.UNSIGNED_BYTE,h)}readAccumulatedShadow(a){return this._shadowAccumulator.readAccumulatedShadow(a[0],a[1])}_setMultipassTerrain(a){this._setMultipassEnabled(a);this._setTerrainCulling(a)}_setMultipassEnabled(a){this._bindParameters.multipassEnabled=a}_setTerrainCulling(a){this._bindParameters.multipassTerrain.cullAboveGround=
a}_renderEdges(a,b){const d=this._edgeView;if(d?.shouldRender()){const {width:e,height:h,depth:k}=this._offscreen,g=this.fboCache.acquire(n.ColorFormat.RGBA,e,h);this._offscreen.renderToTargets(()=>d.render(this._bindParameters,a),g,b??k,U);this._offscreen.compositeToFramebuffer(this._bindParameters,g.colorTexture,E.AlphaMode.Alpha,1);g.release()}}_renderShadowMap(a,b,d){const e=this._shadowMap;e.enabled&&(e.start(a,b,d,this.isFeatureEnabled(D.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),
this._shadowHighlight.updateParameters(a,b),this._needsShadowHighlight?(this._renderShadowCascades(l.ShaderOutput.ShadowHighlight,this._shadowMap),e.moveSnapshot(P.SnapshotSlot.Highlight),e.clear(),this._renderShadowCascades(l.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),e.copySnapshot(P.SnapshotSlot.Default),this._renderShadowCascades(l.ShaderOutput.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(l.ShaderOutput.Shadow),e.finish(),a.setGLViewport(this._rctx))}_renderShadowCascades(a,
b=this._shadowMap){for(const d of b.cascades)d.camera.setGLViewport(this._rctx),this._prepare(d.camera,d.camera),this._renderAllGeometry(a)}get _needsLinearDepth(){return this._renderPlugins.consumes(l.ShaderOutput.Depth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,()=>this._renderAllGeometry(l.ShaderOutput.Depth),[0,0,0,0],n.ColorFormat.RGBA,
n.DepthFormat.DEPTH_STENCIL_BUFFER),this._bindParameters.linearDepth.releaseDepth(),this._offscreen.bindFbo()):this._bindParameters.linearDepth=t.releaseMaybe(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(a){a?(a=this._renderContext.output,this._renderContext.output=l.ShaderOutput.Depth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,()=>this._renderTransparentTerrain(),[-1E10,-1E10,-1E10,1]),this._bindParameters.multipassTerrain.linearDepth.releaseDepth(),
this._renderContext.output=a):this._bindParameters.multipassTerrain.linearDepth=t.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(a){if(a)return a=this._renderContext.output,this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,()=>this._renderOpaqueGeometryAndTransparentMaterial(l.ShaderOutput.Depth),[1,1,1,1],n.ColorFormat.RGBA,this._geometryLinearDepthFormat),this._renderContext.output=
a,this._bindParameters.multipassGeometry.linearDepth.detachDepth();this._bindParameters.multipassGeometry.linearDepth=t.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(a){if(!this._needsDepthRange)return T.zero;const b=pa.depthRangeFromScene(a,this._materialRenderers,this._stage.layers);T.union(b,this._renderPlugins.queryDepthRange(a));b.near=Math.max(a.near,b.near);b.far=Math.min(a.far,
b.far);return b}_renderAllGeometry(a){this._renderContext.output=a;this._renderPlugins.prepare(c.RenderSlot.TRANSPARENT_TERRAIN);this._renderOpaqueGeometryAndTransparentMaterial(a);this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(a){this._renderContext.output=a;this._renderPlugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);this._renderOpaqueGeometry();this._renderTransparentMaterial()}_renderSSAO(){if(this._renderPlugins.produces(c.RenderSlot.SSAO)){var a=this._offscreen.renderToCachedFBO(null,
()=>this._renderAllGeometry(l.ShaderOutput.Normal),[0,0,0,0],n.ColorFormat.RGBA4,n.DepthFormat.DEPTH24_BUFFER);a.releaseDepth();this._offscreen.bindFbo();this._pluginInput.normal=a;this._bindParameters.ssao=this._renderPlugins.render(c.RenderSlot.SSAO,this._pluginInput);a.release()}}_prepareOpaqueGeometrySlots(){this._renderPlugins.prepare(c.RenderSlot.INTEGRATED_MESH);this._renderPlugins.prepare(c.RenderSlot.OPAQUE_TERRAIN);this._renderPlugins.prepare(c.RenderSlot.OPAQUE_MATERIAL);this._renderPlugins.prepare(c.RenderSlot.ENVIRONMENT_OPAQUE);
this._prepareInternalSlots(this._materialRenderers,c.RenderSlot.OPAQUE_MATERIAL)}_renderOpaqueGeometry(){this._renderPlugins.render(c.RenderSlot.INTEGRATED_MESH);this._renderPlugins.render(c.RenderSlot.OPAQUE_TERRAIN);this._renderInternalSlot(c.RenderSlot.OPAQUE_MATERIAL);this._renderPlugins.render(c.RenderSlot.OPAQUE_MATERIAL)}_renderTransparentMaterial(){this._renderInternalSlot(c.RenderSlot.TRANSPARENT_MATERIAL);this._renderPlugins.render(c.RenderSlot.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){if(this._renderPlugins.produces(c.RenderSlot.TRANSPARENT_TERRAIN)){var a=
()=>this._renderPlugins.render(c.RenderSlot.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==l.ShaderOutput.Color)a();else{var {width:b,height:d,depth:e}=this._offscreen,h=this.fboCache.acquire(n.ColorFormat.RGBA,b,d);this._offscreen.renderToTargets(a,h,e,[0,0,0,0]);return h}}}_renderHUDVisibility(a){this._shouldRenderInternalSlot(this._materialRenderers,c.RenderSlot.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,
()=>this._renderInternalSlot(c.RenderSlot.OCCLUSION_PIXELS),a),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=t.releaseMaybe(this._bindParameters.hudVisibility)}_renderLineCallouts(a){this._bindParameters.hudRenderStyle=a;if(a===A.HUDRenderStyle.Occluded){const {width:b,height:d,color:e}=this._offscreen;a=this.fboCache.acquireDepth(n.DepthFormat.DEPTH16_BUFFER,b,d);this._offscreen.renderToTargets(()=>this._renderInternalSlot(c.RenderSlot.LINE_CALLOUTS),e,a,void 0,!0,!0);a.release()}else this._renderInternalSlot(c.RenderSlot.LINE_CALLOUTS)}_renderLaserlines(){this._renderPlugins.render(c.RenderSlot.LASERLINES);
if(this._renderPlugins.produces(c.RenderSlot.LASERLINES_CONTRAST_CONTROL)){const a=this._offscreen,{width:b,height:d,depth:e}=a,h=this.fboCache.acquire(n.ColorFormat.RGBA,b,d);a.renderToTargets(()=>this._renderPlugins.render(c.RenderSlot.LASERLINES_CONTRAST_CONTROL),h,e,U);a.compositeToFramebuffer(this._bindParameters,h.colorTexture,E.AlphaMode.PremultipliedAlpha,1);h.release()}}_renderHUD(a,b){if(this._materialRenderersHas.hudElements)if(this._oitEnabled){const d=this._renderOITPass(H.HUD,a);this._rctx.bindFramebuffer(b?.fbo);
this._compositingHelper.composite(this._bindParameters,d.colorTexture,E.AlphaMode.PremultipliedAlpha);d.release()}else if(a===A.HUDRenderStyle.Occluded){const {width:d,height:e,color:h}=this._offscreen;b=this.fboCache.acquireDepth(n.DepthFormat.DEPTH16_BUFFER,d,e);this._offscreen.renderToTargets(()=>this._renderHUDElements(a),h,b,void 0,!0,!0);b.release()}else this._rctx.bindFramebuffer(null),b?.acquireDepth(n.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(b?.fbo),this._renderHUDElements(a),
b?.releaseDepth()}_renderHUDElements(a){this._bindParameters.hudRenderStyle=a;this._prepareInternalSlots(this._materialRenderers,c.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,c.RenderSlot.HUD_MATERIAL,c.RenderSlot.LABEL_MATERIAL);this._renderInternalSlot(c.RenderSlot.LINE_CALLOUTS_HUD_DEPTH);this._renderInternalSlot(c.RenderSlot.HUD_MATERIAL);this._renderInternalSlot(c.RenderSlot.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._renderPlugins.produces(c.RenderSlot.SHADOW_HIGHLIGHT)&&
this.hasShadowHighlights}_renderHighlights(a,b){this.hasHighlights&&b.decorations!==C.Decorations.OFF&&(b=this._offscreen.renderToCachedFBO(null,()=>{this._renderAllGeometry(l.ShaderOutput.Highlight);this._rctx.clearSafe(z.ClearBufferBit.DEPTH_BUFFER_BIT);this._renderHUDElements(A.HUDRenderStyle.Both)},[0,0,0,0],n.ColorFormat.RGBA4,n.DepthFormat.DEPTH_STENCIL_BUFFER),b.releaseDepth(),this._needsShadowHighlight&&(this._pluginInput.highlight=b,this._renderPlugins.render(c.RenderSlot.SHADOW_HIGHLIGHT,
this._pluginInput,a)),this._renderPlugins.produces(c.RenderSlot.HIGHLIGHT)&&(this._pluginInput.composite=null,this._pluginInput.normal=null,this._pluginInput.highlight=b,this._renderPlugins.render(c.RenderSlot.HIGHLIGHT,this._pluginInput,a)),b.release())}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(a,b,d){this._needsShadowCast&&this._bindParameters.linearDepth?.colorTexture&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,
a,b,d)}_prepareTransparencySlots(){this._renderContext.output=l.ShaderOutput.Alpha;this._bindParameters.transparencyPassType=w.TransparencyPassType.Alpha;this._prepareInternalSlots(this._materialRenderers,c.RenderSlot.TRANSPARENT_MATERIAL);this._renderPlugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);this._renderContext.output=l.ShaderOutput.Color;this._bindParameters.transparencyPassType=w.TransparencyPassType.Color;this._prepareInternalSlots(this._materialRenderers,c.RenderSlot.TRANSPARENT_MATERIAL);
this._renderPlugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);this._bindParameters.transparencyPassType=w.TransparencyPassType.FrontFace;this._prepareInternalSlots(this._materialRenderers,c.RenderSlot.TRANSPARENT_MATERIAL);this._renderPlugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);this._bindParameters.transparencyPassType=w.TransparencyPassType.NONE}_renderOITPass(a,b=A.HUDRenderStyle.Both){var d=a===H.HUD;a=d?this.fboCache.acquire(n.ColorFormat.RGBA,this._offscreen.width,this._offscreen.height):
null;const e=d?()=>this._renderHUDElements(b):()=>this._renderTransparentMaterial(),h=this._renderContext.output;this._renderContext.output=l.ShaderOutput.Alpha;this._bindParameters.transparencyPassType=w.TransparencyPassType.Alpha;const k=this._offscreen.renderOITPass(e,w.TransparencyPassType.Alpha,d);this._renderContext.output=l.ShaderOutput.Color;this._bindParameters.transparencyPassType=w.TransparencyPassType.Color;const g=this._offscreen.renderOITPass(e,w.TransparencyPassType.Color,d);this._bindParameters.transparencyPassType=
w.TransparencyPassType.FrontFace;d=this._offscreen.renderOITPass(e,w.TransparencyPassType.FrontFace,d);this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,g,k,d,a);a?.releaseDepth();d.release();g.release();k.release();this._bindParameters.transparencyPassType=w.TransparencyPassType.NONE;this._renderContext.output=h;return a}_renderOccluded(){let a=0;u.clear();this._materialRenderers.forAll(k=>{k.material&&k.material.isVisible()&&k.material.parameters.renderOccluded===v.RenderOccludedFlag.OccludeAndTransparentStencil&&
(a|=k.material.parameters.renderOccluded,u.push(k))});const b=this._offscreen,d=(k,g,q,f,r)=>{if(0!==(a&g)){var {width:K,height:L,depth:M}=b;g=this.fboCache.acquire(n.ColorFormat.RGBA,K,L);b.renderToTargets(q,g,M,[0,0,0,0],f,r);b.compositeToFramebuffer(this._bindParameters,g.colorTexture,E.AlphaMode.PremultipliedAlpha,k);g.release()}};0!==u.length&&(this._prepareInternalSlots(u,c.RenderSlot.OCCLUDER_MATERIAL,c.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL),this._renderInternalSlot(c.RenderSlot.OCCLUDER_MATERIAL,
u),d(.5,v.RenderOccludedFlag.OccludeAndTransparentStencil,()=>this._renderInternalSlot(c.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,u),!1,!1));u.clear();this._materialRenderers.forAll(k=>{k.material&&k.material.isVisible()&&(k.material.parameters.renderOccluded===v.RenderOccludedFlag.OccludeAndTransparent||k.material.parameters.renderOccluded===v.RenderOccludedFlag.Transparent||k.material.parameters.renderOccluded===v.RenderOccludedFlag.Opaque)&&(a|=k.material.parameters.renderOccluded,u.push(k))});
const e=this._renderPlugins.renderOccludedFlags;if(a|=e){var h=k=>{this._renderContext.renderOccludedMask=k;this._prepareInternalSlots(u,c.RenderSlot.OPAQUE_MATERIAL,c.RenderSlot.TRANSPARENT_MATERIAL,c.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);e>v.RenderOccludedFlag.Occlude&&this._renderPlugins.render(c.RenderSlot.OCCLUDED_TERRAIN);this._renderInternalSlot(c.RenderSlot.OPAQUE_MATERIAL,u);this._renderInternalSlot(c.RenderSlot.TRANSPARENT_MATERIAL,u);this._renderInternalSlot(c.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,
u);this._renderContext.resetRenderOccludedMask()};this._renderContext.output=l.ShaderOutput.Color;d(.5,v.RenderOccludedFlag.OccludeAndTransparent,()=>h(v.RenderOccludedFlag.OccludeAndTransparent),!0,C.StencilBits.OutlineVisualElementMask);d(.5,v.RenderOccludedFlag.Transparent,()=>h(v.RenderOccludedFlag.Transparent),!0,C.StencilBits.OutlineVisualElementMask);d(1,v.RenderOccludedFlag.Opaque,()=>h(v.RenderOccludedFlag.Opaque),!0,C.StencilBits.OutlineVisualElementMask);u.clear()}}_renderComposite(a,b){this._renderPlugins.consumes(l.ShaderOutput.CompositeColor)&&
(this._pluginInput.composite=b);b=null;const d=this._renderPlugins.produces(c.RenderSlot.COMPOSITE);d&&(b=this._renderPlugins.renderComposition(c.RenderSlot.COMPOSITE,this._pluginInput),this._pluginInput.composite=b);const e=this._renderPlugins.produces(c.RenderSlot.ANTIALIASING);a=this._renderPlugins.render(e?c.RenderSlot.ANTIALIASING:c.RenderSlot.BLIT,this._pluginInput,a);d&&b?.release();return a}_prepare(a,b){this._needsTransparentPass=this._materialRenderers.some(d=>d.material.produces(c.RenderSlot.TRANSPARENT_MATERIAL,
l.ShaderOutput.Color));this._bindParameters.camera=a;this._bindParameters.contentCamera=b}_ensureBindParameters(a,b){this._bindParameters.camera=a;this._bindParameters.contentCamera=b;a=this._renderContext.offscreenRenderingHelper;this._bindParameters.mainColor=a.colorTexture;this._bindParameters.mainDepth=a.depthTexture}_ensureBindParametersSSR(a){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=a);this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?
this._reprojectionMatrix=G.IDENTITY:(F.invert(V,this._bindParameters.camera.viewMatrix),F.invert(W,this._bindParameters.camera.projectionMatrix),F.multiply(I,V,W),F.multiply(I,this._renderContext.lastFrameCamera.viewMatrix,I),F.multiply(I,this._renderContext.lastFrameCamera.projectionMatrix,I),this._reprojectionMatrix=I);const b=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=0<b?Math.min(b,a-this._ssrEnableTime)/b:1;1>this._bindParameters.ssr.fadeFactor&&this._requestRender()}else this._reprojectionMatrix=
G.IDENTITY,this._ssrEnableTime=null}_shouldRenderInternalSlot(a,b){this._bindParameters.slot=b;return a.some(d=>null!=d.prepareTechnique(this._renderContext))}_prepareInternalSlots(a,...b){for(const d of b)this._bindParameters.slot=d,a.forAll(e=>null!=e.prepareTechnique(this._renderContext))}_renderInternalSlot(a,b=this._materialRenderers){this._bindParameters.slot=a;b.forAll(d=>{const e=d.prepareTechnique(this._renderContext);e&&d.renderNode(this._renderContext,e)})}get memoryInfo(){return{fbos:this.fboCache.usedMemory,
vaos:this._materialRenderers.reduce((a,b)=>a+b.usedMemory,0),plugins:this._renderPlugins.usedMemory}}getMemoryForMaterial(a){return null==a?0:this._materialRenderers.find(b=>b.material===a)?.usedMemory??0}get usedMemory(){return this.fboCache.usedMemory+(this.edgeView?.usedMemory??0)+this._renderPlugins.usedMemory}get test(){const a=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,
shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{a._renderStateFeatures=D.setupFeatureDefaults();this._renderPlugins.renderFeatureChanged();this._requestRender()},releaseGeometryLinearDepth(b){a._releaseGeometryLinearDepth=b??(d=>d?.release());a._geometryLinearDepthFormat=b?n.DepthFormat.DEPTH_STENCIL_TEXTURE:n.DepthFormat.DEPTH16_BUFFER},getFramebufferTexture:b=>{switch(b){case p.FramebufferId.Color:return a._offscreen.colorTexture;
case p.FramebufferId.LinearDepth:return a._bindParameters.linearDepth?.colorTexture;case p.FramebufferId.ShadowMap:return a._shadowMap.depthTexture;case p.FramebufferId.HudVisibility:return a._bindParameters.hudVisibility?.colorTexture}}}}};x.__decorate([y.property()],p.Renderer.prototype,"_renderPlugins",void 0);x.__decorate([y.property()],p.Renderer.prototype,"_shadowAccumulator",void 0);x.__decorate([y.property()],p.Renderer.prototype,"_state",void 0);x.__decorate([y.property()],p.Renderer.prototype,
"_renderStateFeatures",void 0);x.__decorate([y.property({readOnly:!0})],p.Renderer.prototype,"fullResolutionAtmosphere",null);x.__decorate([y.property()],p.Renderer.prototype,"_smaa",void 0);x.__decorate([y.property()],p.Renderer.prototype,"_blit",void 0);x.__decorate([y.property({autoDestroy:!0})],p.Renderer.prototype,"_edgeView",void 0);x.__decorate([y.property()],p.Renderer.prototype,"updating",null);x.__decorate([y.property()],p.Renderer.prototype,"isCameraFinal",null);p.Renderer=x.__decorate([aa.subclass("esri.views.3d.webgl-engine.lib.Renderer")],
p.Renderer);var H;(function(a){a[a.Geometry=0]="Geometry";a[a.HUD=1]="HUD"})(H||(H={}));p.FramebufferId=void 0;(function(a){a[a.Color=0]="Color";a[a.LinearDepth=1]="LinearDepth";a[a.ShadowMap=2]="ShadowMap";a[a.HudVisibility=3]="HudVisibility"})(p.FramebufferId||(p.FramebufferId={}));const U=[0,0,0,0],u=new R,W=G.create(),V=G.create(),I=G.create();Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});