// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/maybe ../core/FBOCache ./TransparencyPassType ../../../webgl/enums ../../../webgl/FramebufferObject".split(" "),function(m,v,k,g,l,h,q){class r{constructor(a,b){this._fbos=a;this.compositingHelper=b;this._height=this._width=4}dispose(){this._color=k.releaseMaybe(this._color);this.releaseBuffers()}get framebuffer(){this.color.detachDepth();this.color.attachDepth(this.depth);return this.color.fbo}get colorTexture(){return this.color.colorTexture}get depthTexture(){return this.depth.attachment}initializeFrame(a,
b,d){this._fbos.interactive=!d;d=this._fbos.rctx;this._width=a.fullWidth;this._height=a.fullHeight;q.ensureAttachmentMaxSize(this,d.parameters.maxTextureSize);a=this._color;this._color=null;this.releaseBuffers();this.bindFbo();d.setClearStencil(0);d.setClearColor(b[0],b[1],b[2],b[3]);d.clearSafe(h.ClearBufferBit.COLOR_BUFFER_BIT|h.ClearBufferBit.DEPTH_BUFFER_BIT|h.ClearBufferBit.STENCIL_BUFFER_BIT);return a}releaseBuffers(){this._color?.detachDepth();this._depth=k.releaseMaybe(this._depth)}renderHUDVisibility(a,
b,d){if(a?.fbo.width!==this._width||a?.fbo.height!==this._height)a?.release(),a=this._fbos.acquire(g.ColorFormat.RGBA4,this._width,this._height);a.attachDepth(d||this.depth);this._fbos.rctx.bindFramebuffer(a.fbo);this.renderToFBO(b,t);a.detachDepth();return a}compositeToHUDVisibility(a,b){this._fbos.rctx.bindFramebuffer(a.hudVisibility?.fbo);this.compositingHelper.compositeHUD(a,b)}renderOITPass(a,b,d){let c,e;switch(b){case l.TransparencyPassType.Color:c=this._fbos.acquire(g.ColorFormat.RGBA16F,
this._width,this._height);e=[0,0,0,0];break;case l.TransparencyPassType.Alpha:c=this._fbos.acquire(g.ColorFormat.R16F,this._width,this._height);e=[1,1,1,1];break;case l.TransparencyPassType.FrontFace:c=this._fbos.acquire(g.ColorFormat.RGBA,this._width,this._height),e=[0,0,0,0]}d?(c.acquireDepth(g.DepthFormat.DEPTH16_BUFFER),this._fbos.rctx.bindFramebuffer(c.fbo),this.renderToFBO(a,e,!0,!0),c.releaseDepth()):(c.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(c.fbo),this.renderToFBO(a,e),c.detachDepth());
return c}compositeToFramebuffer(a,b,d,c){this.bindFbo();this.compositingHelper.composite(a,b,d,c)}compositeTransparentOntoOpaque(a,b,d,c,e){e?(this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.setClearColor(0,0,0,1E-13),this._fbos.rctx.clearSafe(h.ClearBufferBit.COLOR_BUFFER_BIT)):this.bindFbo();this.compositingHelper.compositeOIT(a,b.colorTexture,d.colorTexture,c.colorTexture)}renderDepthDetached(a){this._bindTarget(this.color);a();this._bindTarget(this.color,this.depth)}renderToCachedFBO(a,
b,d,c=g.ColorFormat.RGBA,e=g.DepthFormat.DEPTH16_BUFFER,f=this._width,n=this._height,u=null){if(a?.fbo.width!==f||a?.fbo.height!==n)a=k.releaseMaybe(a);a=a??this._fbos.acquire(c,f,n);null!=e&&a.acquireDepth(e);u?.forEach(p=>{a.acquireColor(p.format,p.attachment)});this._fbos.rctx.bindFramebuffer(a.fbo);this.renderToFBO(b,d,!0,!0);return a}renderToFBO(a,b,d=!1,c=!1){const e=this._fbos.rctx;let f=0;b&&(e.setClearColor(b[0],b[1],b[2],Math.max(1E-13,b[3])),f|=h.ClearBufferBit.COLOR_BUFFER_BIT);d&&(f|=
h.ClearBufferBit.DEPTH_BUFFER_BIT);!1===c?c=0:(!0===c&&(c=255),f|=h.ClearBufferBit.STENCIL_BUFFER_BIT);f&&e.clearSafe(f,c);a();e.gl.flush()}renderToTargets(a,b,d,c,e=!1,f=!1){this._bindTarget(b,d);this.renderToFBO(a,c,e,f);b.detachDepth()}bindFbo(){this._bindTarget(this.color,this.depth)}_bindTarget(a,b){a.detachDepth();a.attachDepth(b);this._fbos.rctx.bindFramebuffer(a.fbo)}get width(){return this._width}get height(){return this._height}get color(){this._color||(this._color=this._fbos.acquire(g.ColorFormat.RGBA,
this._width,this._height));return this._color}get depth(){this._depth||(this._depth=this._fbos.acquireDepth(g.DepthFormat.DEPTH_STENCIL_TEXTURE,this._width,this._height));return this._depth}}const t=[0,1,0,1];m.OffscreenRendering=r;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});