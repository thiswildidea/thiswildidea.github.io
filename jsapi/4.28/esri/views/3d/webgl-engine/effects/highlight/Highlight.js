// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/colorUtils ../../../../../core/has ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec2 ../../core/FBOCache ../RenderPlugin ./HighlightApplyTechnique ./HighlightBlurTechnique ./HighlightDefaults ./HighlightDownsampleTechnique ./HighlightPassParameters ../../lib/DefaultVertexAttributeLocations ../../lib/DefaultVertexBufferLayouts ../../lib/RenderSlot ../../lib/VertexArrayObject ../../../../../chunks/HighlightBlur.glsl ../../../../../chunks/HighlightDownsample.glsl ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/Util".split(" "),
function(p,t,A,E,q,n,B,Q,R,F,u,v,C,G,H,w,I,J,K,L,M,N,O,m,P,x,y){p.Highlight=class extends C.SyncRenderPlugin{constructor(g){super(g);this._context=null;this._passParameters=new J.HighlightPassParameters;this._downsampleDrawParameters=new m.HighlightDownsampleDrawParameters;this._blurDrawParameters=new O.HighlightBlurDrawParameters;this._blurColorFormat=E("mac")?v.ColorFormat.RGBA:v.ColorFormat.RGBA4;this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0};
this.produces=new Map([[M.RenderSlot.HIGHLIGHT,()=>!0]])}consumes(){return C.ConsumesHighlight}initializeRenderContext(g){this._context=g;null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(H.HighlightBlurTechnique));null==this._downsampleTechnique&&(this._downsampleTechnique=this._context.techniqueRepository.acquire(I.HighlightDownsampleTechnique));null==this._applyTechnique&&(this._applyTechnique=this._context.techniqueRepository.acquire(G.HighlightApplyTechnique));
this.addHandles([n.watch(()=>this.view.highlightOptions.color,f=>{this._passParameters.color=A.unitRGBAFromColor(f??w.defaultColor);this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color);this._context.requestRender()},n.syncAndInitial),n.watch(()=>this.view.highlightOptions.haloColor,f=>{this._passParameters.haloColor=null!=f?A.unitRGBAFromColor(f):this._passParameters.color;this._context.requestRender()},n.syncAndInitial),n.watch(()=>this.view.highlightOptions.haloOpacity,
f=>{this._passParameters.haloOpacity=f??w.defaultHaloOpacity;this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity;this._context.requestRender()},n.syncAndInitial),n.watch(()=>this.view.highlightOptions.fillOpacity,f=>{this._passParameters.fillOpacity=f??w.defaultFillOpacity;this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity;this._context.requestRender()},n.syncAndInitial)])}uninitializeRenderContext(){this._context=null}dispose(){this._blurTechnique=
q.releaseMaybe(this._blurTechnique);this._downsampleTechnique=q.releaseMaybe(this._downsampleTechnique);this._applyTechnique=q.releaseMaybe(this._applyTechnique);this._grid.coverage=q.releaseMaybe(this._grid.coverage);this._grid.vao=q.disposeMaybe(this._grid.vao)}renderNode(g,f,d,e){d=d?.highlight?.colorTexture;if(this._context&&d)if(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled){f=g.bindParameters.camera;var b=f.pixelRatio,l=Math.ceil(f.fullWidth/
b);b=Math.ceil(f.fullHeight/b);var c=this._context.fbos,a=c.rctx;this._gridUpdateResources(d);this._gridComputeCoverage(d,g.bindParameters);this._passParameters.highlightTexture=d;this._passParameters.coverageTexture=this._grid.coverage?.colorTexture;var {width:h,height:k}=d.descriptor;u.set(this._passParameters.coverageRounding,h/(Math.ceil(h/m.gridCellPixelSize)*m.gridCellPixelSize),k/(Math.ceil(k/m.gridCellPixelSize)*m.gridCellPixelSize));var D=a.bindTechnique(this._blurTechnique,this._passParameters,
g.bindParameters),r=this._grid.vao;a.bindVAO(r);var z=c.acquire(this._blurColorFormat,l,b);a.bindFramebuffer(z.fbo);a.setViewport(0,0,l,b);a.clear(x.ClearBufferBit.COLOR_BUFFER_BIT);this._blurDrawParameters.blurInputTexture=d;u.set(this._blurDrawParameters.blurSize,1/l,0);D.bindDraw(this._blurDrawParameters,g.bindParameters,this._passParameters);a.drawArrays(this._blurTechnique.primitiveType,0,y.vertexCount(r,"geometry"));d=c.acquire(this._blurColorFormat,l,b);a.bindFramebuffer(d.fbo);a.clear(x.ClearBufferBit.COLOR_BUFFER_BIT);
this._blurDrawParameters.blurInputTexture=z.colorTexture;u.set(this._blurDrawParameters.blurSize,0,1/b);D.bindDraw(this._blurDrawParameters,g.bindParameters,this._passParameters);a.drawArrays(this._blurTechnique.primitiveType,0,y.vertexCount(r,"geometry"));a.bindFramebuffer(e?.fbo);a.setViewport4fv(f.fullViewport);this._passParameters.blurTexture=d.colorTexture;a.bindTechnique(this._applyTechnique,this._passParameters,g.bindParameters);a.drawArrays(this._applyTechnique.primitiveType,0,y.vertexCount(r,
"geometry"));d.release();z.release()}else this._context.requestRender()}_gridUpdateResources(g){if(this._context){var f=this._context.fbos.rctx,d=this._grid,e=Math.ceil(g.descriptor.height/m.gridCellPixelSize),b=Math.ceil(g.descriptor.width/m.gridCellPixelSize);if(!d.vao||d.verticalCellCount!==e||d.horizontalCellCount!==b){d.verticalCellCount=e;d.horizontalCellCount=b;g=e+1;var l=b+1;e=1/e;b=1/b;var c=new Float32Array(24*g*l),a=0;for(let h=0;h<g;h++)for(let k=0;k<l;k++)c[a++]=(k-.5)*b*2-1,c[a++]=
(h-.5)*e*2-1,c[a++]=k*b,c[a++]=h*e,c[a++]=(k+.5)*b*2-1,c[a++]=(h-.5)*e*2-1,c[a++]=k*b,c[a++]=h*e,c[a++]=(k-.5)*b*2-1,c[a++]=(h+.5)*e*2-1,c[a++]=k*b,c[a++]=h*e,c[a++]=(k-.5)*b*2-1,c[a++]=(h+.5)*e*2-1,c[a++]=k*b,c[a++]=h*e,c[a++]=(k+.5)*b*2-1,c[a++]=(h-.5)*e*2-1,c[a++]=k*b,c[a++]=h*e,c[a++]=(k+.5)*b*2-1,c[a++]=(h+.5)*e*2-1,c[a++]=k*b,c[a++]=h*e;d.vao?.dispose();d.vao=new N.VertexArrayObject(f,K.Default3D,{geometry:L.Pos2Tex},{geometry:P.BufferObject.createVertex(f,x.Usage.STATIC_DRAW,c)})}}}_gridComputeCoverage(g,
f){if(this._context){var d=this._context.fbos.rctx,e=this._grid,b=g.descriptor,l=Math.ceil(b.width/m.gridCellPixelSize);b=Math.ceil(b.height/m.gridCellPixelSize);e.coverage?.release();e.coverage=this._context.fbos.acquire(v.ColorFormat.RG,l,b);this._downsampleDrawParameters.input=g;d.bindFramebuffer(e.coverage.fbo);d.bindTechnique(this._downsampleTechnique,this._passParameters,f).bindDraw(this._downsampleDrawParameters,f,this._passParameters);d.setViewport(0,0,l,b);d.screen.draw()}}get test(){return{coverage:this._grid.coverage}}};
t.__decorate([B.property()],p.Highlight.prototype,"_context",void 0);t.__decorate([B.property()],p.Highlight.prototype,"view",void 0);p.Highlight=t.__decorate([F.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],p.Highlight);Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});