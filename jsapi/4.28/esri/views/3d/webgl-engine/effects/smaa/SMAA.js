// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/tslib.es6 ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../support/requestImageUtils ../../core/FBOCache ../RenderPlugin ./SMAABlendWeightsTechnique ./SMAABlurTechnique ./SMAAEdgeDetectTechnique ./SMAAPassParameters ../../lib/RenderFeature ../../lib/RenderSlot ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(x,f,h,m,k,p,l,G,H,I,y,q,r,t,z,A,B,C,u,D,g,E,F){function v(a,b,d,c){const e=new F.TextureDescriptor;e.pixelFormat=d;e.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE;e.width=c.width;e.height=c.height;e.samplingMode=b;return new E.Texture(a,e,c)}f.SMAA=class extends t.SyncRenderPlugin{constructor(a){super(a);this._searchTexture=this._areaTexture=this._context=null;this._isEnabled=!1;this._smaaParameters=new C.SMAAPassParameters;this.produces=new Map([[D.RenderSlot.ANTIALIASING,()=>this._isEnabled&&
null!=this._context]])}consumes(){return t.ConsumesCompositeColor}get updating(){return null!=this._abortController}initializeRenderContext(a){this._context=a;this.addHandles([p.watch(()=>this.view.qualitySettings.antialiasingEnabled,b=>b||this._context?.isFeatureEnabled(u.RenderFeature.Antialiasing)?this.enable():this.disable(),p.syncAndInitial)])}renderFeatureChanged(){this.view.qualitySettings.antialiasingEnabled||this._context?.isFeatureEnabled(u.RenderFeature.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable();
this._context=null}enable(){if(!this._isEnabled&&this._context&&!this._abortController)if(null==this._edgeTechnique&&(this._edgeTechnique=this._context.techniqueRepository.acquire(B.SMAAEdgeDetectTechnique)),null==this._blendTechnique&&(this._blendTechnique=this._context.techniqueRepository.acquire(z.SMAABlendWeightsTechnique)),null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(A.SMAABlurTechnique)),this._areaTexture&&this._searchTexture)this._isEnabled=!0;else{this._abortController=
new AbortController;var a=this._abortController.signal;(new Promise((b,d)=>x(["./SMAAData"],b,d))).then(b=>this._loadTextures(this._context,b,a)).then(()=>{this._context?.requestRender();this._abortController=null}).catch(b=>{k.isAbortError(b)||this._disposeTextures()})}}_loadTextures(a,b,d){k.throwIfAborted(d);return a?Promise.all([q.requestImage(b.areaTexture).then(c=>v(a.fbos.rctx,g.TextureSamplingMode.LINEAR,g.PixelFormat.RGB,c)),q.requestImage(b.searchTexure).then(c=>v(a.fbos.rctx,g.TextureSamplingMode.NEAREST,
g.PixelFormat.LUMINANCE,c))]).then(([c,e])=>{k.isAborted(d)?(c.dispose(),e.dispose(),k.throwIfAborted(d)):(this._areaTexture=c,this._searchTexture=e,this._isEnabled=!0)}):Promise.reject()}_disposeTextures(){this._areaTexture=m.disposeMaybe(this._areaTexture);this._searchTexture=m.disposeMaybe(this._searchTexture)}disable(){this._abortController=m.abortMaybe(this._abortController);this._isEnabled=!1}destroy(){this.disable();this._disposeTextures()}renderNode(a,b,d,c){b=d?.composite?.colorTexture;if(!(this._isEnabled&&
this._context&&d&&b))return c;if(!(this._edgeTechnique?.compiled&&this._blendTechnique?.compiled&&this._blurTechnique?.compiled))return this._context.requestRender(),c;d=b.descriptor.width;const e=b.descriptor.height,w=this._context.fbos;a=a.rctx;a.setViewport(0,0,d,e);const n=w.acquire(r.ColorFormat.RG,d,e);a.bindFramebuffer(n.fbo);a.setClearColor(0,0,0,1);a.clear(g.ClearBufferBit.COLOR_BUFFER_BIT);this._smaaParameters.color=b;a.bindTechnique(this._edgeTechnique,this._smaaParameters);a.screen.draw();
b=w.acquire(r.ColorFormat.RGBA,d,e);a.bindFramebuffer(b.fbo);a.setClearColor(0,0,1,1);a.clear(g.ClearBufferBit.COLOR_BUFFER_BIT);this._smaaParameters.inputTexture=n.colorTexture;this._smaaParameters.areaTexture=this._areaTexture;this._smaaParameters.searchTexture=this._searchTexture;a.bindTechnique(this._blendTechnique,this._smaaParameters);a.screen.draw();a.bindFramebuffer(c?.fbo);n.release();a.setClearColor(0,1,0,1);a.clear(g.ClearBufferBit.COLOR_BUFFER_BIT);this._smaaParameters.inputTexture=b.colorTexture;
a.bindTechnique(this._blurTechnique,this._smaaParameters);a.screen.draw();b.release();return c}};h.__decorate([l.property()],f.SMAA.prototype,"view",void 0);h.__decorate([l.property()],f.SMAA.prototype,"_context",void 0);h.__decorate([l.property()],f.SMAA.prototype,"_abortController",void 0);h.__decorate([l.property({readOnly:!0})],f.SMAA.prototype,"updating",null);f.SMAA=h.__decorate([y.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],f.SMAA);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});