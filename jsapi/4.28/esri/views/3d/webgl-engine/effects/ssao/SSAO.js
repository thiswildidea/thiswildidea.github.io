// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/time ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec2 ../../core/FBOCache ../RenderPlugin ./SSAOBlurTechnique ./SSAONoiseData ./SSAOParameters ./SSAOTechnique ../../lib/RenderFeature ../../lib/RenderSlot ../../../../../chunks/SSAO.glsl ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(g,n,z,u,A,v,K,L,M,B,w,p,q,C,D,x,E,F,G,H,m,I,J){g.SSAO=class extends q.SyncRenderPlugin{constructor(c){super(c);this._context=null;this._passParameters=new x.SSAOPassParameters;this._drawParameters=new x.BlurDrawParameters;this.produces=new Map([[G.RenderSlot.SSAO,()=>this._produces()]])}_produces(){return null!=this._enableTime&&null!=this._context}consumes(){return this._produces()?q.ConsumesDepthNormal:q.ConsumesNone}initializeRenderContext(c){this._context=c;this.addHandles([u.watch(()=>
this.view.qualitySettings.ambientOcclusion||this._context?.isFeatureEnabled(F.RenderFeature.SSAO),b=>b?this._enable():this._disable(),u.syncAndInitial)])}uninitializeRenderContext(){this._disable();this._context=null}_disable(){this._passParameters.noiseTexture=z.disposeMaybe(this._passParameters.noiseTexture);this._enableTime=null}destroy(){this._disable()}_enable(){if(null==this._enableTime&&this._context){var c=Uint8Array.from(atob(D.noiseData),a=>a.charCodeAt(0)),b=new J.TextureDescriptor;b.wrapMode=
m.TextureWrapMode.CLAMP_TO_EDGE;b.pixelFormat=m.PixelFormat.RGB;b.wrapMode=m.TextureWrapMode.REPEAT;b.hasMipmap=!0;b.width=32;b.height=32;this._passParameters.noiseTexture=new I.Texture(this._context.renderContext.rctx,b,c);null==this._ssaoTechnique&&(this._ssaoTechnique=this._context.techniqueRepository.acquire(E.SSAOTechnique));null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(C.SSAOBlurTechnique));this._enableTime=A.Milliseconds(0);this._context?.requestRender()}}renderNode(c,
b,a){b=c.bindParameters;var e=b.linearDepth?.colorTexture,f=a?.normal?.colorTexture;if(null!=this._enableTime&&null!=this._context&&null!=e&&f){if(this._ssaoTechnique.compiled&&this._blurTechnique.compiled){0===this._enableTime&&(this._enableTime=c.time);a=c.rctx;var k=b.camera,d=this.view.qualitySettings.fadeDuration;c=0<d?Math.min(d,c.time-this._enableTime)/d:1;this._passParameters.normalTexture=f;this._passParameters.depthTexture=e;this._passParameters.projScale=1/k.computeScreenPixelSizeAtDist(1);
this._passParameters.intensity=2/H.getRadius(k)**6*c;e=k.fullViewport[2];f=k.fullViewport[3];d=Math.round(e/2);var l=Math.round(f/2),h=this._context.fbos,r=h.acquire(p.ColorFormat.RED,e,f);a.bindFramebuffer(r.fbo);a.setViewport(0,0,e,f);a.bindTechnique(this._ssaoTechnique,this._passParameters,b).bindDraw(this._drawParameters,b,this._passParameters);a.screen.draw();var y=a.bindTechnique(this._blurTechnique,this._passParameters,b);a.setViewport(0,0,d,l);var t=h.acquire(p.ColorFormat.RED,d,l);a.bindFramebuffer(t.fbo);
this._drawParameters.colorTexture=r.colorTexture;w.set(this._drawParameters.blurSize,0,2/f);y.bindDraw(this._drawParameters,b,this._passParameters);a.setViewport(0,0,d,l);a.screen.draw();r.release();h=h.acquire(p.ColorFormat.RED,d,l);a.bindFramebuffer(h.fbo);a.setViewport(0,0,e,f);a.setClearColor(1,1,1,0);a.clear(m.ClearBufferBit.COLOR_BUFFER_BIT);a.setViewport(0,0,d,l);this._drawParameters.colorTexture=t.colorTexture;w.set(this._drawParameters.blurSize,2/e,0);y.bindDraw(this._drawParameters,b,this._passParameters);
a.screen.draw();a.setViewport4fv(k.fullViewport);t.release();1>c&&this._context.requestRender();return h}this._enableTime=c.time;this._context.requestRender()}}};n.__decorate([v.property({constructOnly:!0})],g.SSAO.prototype,"view",void 0);n.__decorate([v.property()],g.SSAO.prototype,"_context",void 0);g.SSAO=n.__decorate([B.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],g.SSAO);g.blurSizePixels=2;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});