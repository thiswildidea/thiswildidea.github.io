// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/promiseUtils ../../../../chunks/vec4f64 ../core/FBOCache ../lib/basicInterfaces ../../../support/RenderState ../../../support/screenshotUtils ../../../webgl/enums ../../../webgl/FramebufferObject ../../../../core/imageUtils".split(" "),function(q,u,v,r,l,w,x,n,y,t){class z{constructor(b,a,d){this.parameters=b;this.frameHasDecorations=a;this.fbos=d}}class A{constructor(b,a,d){this._rctx=b;this._renderFunctions=a;this._forceCameraHook=d;this.supersample=!0;this._screenshotQueue=
[]}destroy(){this._rctx=null}async takeScreenshot(b){await this._renderFunctions.prepareOverlay();this._renderFunctions.requestRenderScene(l.RenderRequestType.BACKGROUND);const a=u.createResolver();this._screenshotQueue.push({settings:b,resolver:a});return a.promise}update(b,a){for(const d of this._screenshotQueue){if(null==this._rctx){d.resolver.reject();continue}const c=this._renderScreenshot(b,{...d.settings,pixelRatio:d.settings.pixelRatio*b.parameters.camera.pixelRatio},a);d.resolver(c)}this._screenshotQueue.length=
0}_renderScreenshotOverlay(b,a,d){b.width=a.width;b.height=a.height;const c=b.getContext("2d"),f=d.pixelRatio;c.save();c.translate(0,a.height);c.scale(1,-1);d.region&&c.translate(-d.region.x,-d.region.y);c.scale(f,f);a=this._renderFunctions.renderOverlay(b,d.disableDecorations?l.Decorations.OFF:l.Decorations.ON,a);c.restore();return a}_readbackScreenshot(b,a){return b.resample?this._readbackScreenshotResampled({...b,resample:b.resample},a):this._readbackScreenshotImmediate(b,a)}_readbackScreenshotResampled(b,
a){const {framebufferWidth:d,framebufferHeight:c,region:f,resample:e}=b,h=this._ensureScreenshotEncodeCanvas();let g=t.createEmptyImageData(d,c,h);this._rctx.gl.readPixels(0,0,d,c,n.PixelFormat.RGBA,n.DataType.UNSIGNED_BYTE,new Uint8Array(g.data.buffer));a();g=this._renderScreenshotOverlay(h,g,{...b,region:void 0});b=t.createEmptyImageData(f.width,f.height,h);return x.resampleHermite(g,b,!0,e.region.x,c-(e.region.y+e.region.height),e.region.width,e.region.height)}_readbackScreenshotImmediate(b,a){const {framebufferHeight:d,
region:c}=b,f=this._ensureScreenshotEncodeCanvas(),e=t.createEmptyImageData(c.width,c.height,f);this._rctx.gl.readPixels(c.x,d-(c.y+c.height),c.width,c.height,n.PixelFormat.RGBA,n.DataType.UNSIGNED_BYTE,new Uint8Array(e.data.buffer));a();return this._renderScreenshotOverlay(f,e,b)}_renderScreenshot(b,a,d){var c=b.parameters.camera,f={width:a.framebufferWidth,height:a.framebufferHeight};y.ensureAttachmentMaxSize(f,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));
var e=!1,h=a.disableDecorations&&b.frameHasDecorations,g=a.ignorePadding&&c.pixelRatio!==a.pixelRatio;h=f.width!==c.fullWidth||f.height!==c.fullHeight||h||g||a.objectAndLayerIdColor;let m=null;a.objectAndLayerIdColor&&(m=b.fbos.acquire(r.ColorFormat.RGBA,f.width,f.height),m.acquireDepth(r.DepthFormat.DEPTH_STENCIL_BUFFER));let p=null;if(h){e=c.clone();if(a.ignorePadding){g=v.clone(e.padding);for(var k=0;4>k;k++)g[k]=Math.round(g[k]/e.pixelRatio*a.pixelRatio);e.padding=g}e.fullWidth=f.width;e.fullHeight=
f.height;e.pixelRatio=a.pixelRatio;g=c.fovX-e.fovX;k=c.fovY-e.fovY;0>g&&g<k?e.fovX=c.fovX:0>k&&k<g&&(e.fovY=c.fovY);c={camera:e,contentCamera:e,mode:w.RenderState.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(c);e=!0;p=b.fbos.acquire(r.ColorFormat.RGBA,f.width,f.height);this._renderFunctions.renderScene(p,m,c,a.disableDecorations?l.Decorations.OFF:l.Decorations.ON,d)}this._rctx.bindFramebuffer(p?.fbo);d=this._readbackScreenshot(a,()=>{this._rctx.bindFramebuffer(null);
p?.release()});f=null;a.objectAndLayerIdColor&&(this._rctx.bindFramebuffer(m?.fbo),f=this._readbackScreenshot(a,()=>{this._rctx.bindFramebuffer(null);m?.release()}),this._rctx.bindFramebuffer(null));if(h&&!this._rctx.contextAttributes.alpha)for(a=3;a<d.data.length;a+=4)d.data[a]=255;if(f&&!this._rctx.contextAttributes.alpha)for(a=3;a<f.data.length;a+=4)f.data[a]=255;e&&this._forceCameraHook(b.parameters);return[d,f]}_ensureScreenshotEncodeCanvas(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=
document.createElement("canvas"));return this._screenshotEncodeCanvas}}q.ScreenshotContext=z;q.ScreenshotManager=A;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});