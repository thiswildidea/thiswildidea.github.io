// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3f32 ../../../geometry/ellipsoidUtils ../../../chunks/Clouds.glsl ./CloudsData ./CloudsParameters ./CloudsPresets ./CloudsTechnique ./CloudsTechniqueConfiguration ./NoiseTextureAtlas ../webgl-engine/lib/BindParameters ../webgl-engine/lib/glUtil3D ../../support/Scheduler ../../webgl/enums ../../webgl/FramebufferObject ../../webgl/TextureDescriptor".split(" "),
function(c,f,y,l,q,w,h,P,Q,R,z,A,B,C,r,D,k,E,x,t,F,d,G,n,H,I,J,u,v,K,L){c.CloudsGenerator=class extends y{constructor(a){super(a);this._techniques=[];this._techniqueConfiguration=new n.CloudsTechniqueConfiguration;this._bindParameters=new I.BindParameters(null,null);this._passParameters=new x.CloudsPassParameters;this._drawParameters=new x.CloudsDrawParameters;this._weatherTile=D.create();this._weatherTileCount=128;this._tileIndex=this._faceIndex=0;this.coverage=l.lerp(d.cloudPresets.default.coverage[0],
d.cloudPresets.default.coverage[1],.5);this.density=l.lerp(d.cloudPresets.default.density[0],d.cloudPresets.default.density[1],.5);this.absorption=l.lerp(d.cloudPresets.default.absorption[0],d.cloudPresets.default.absorption[1],.5);this.cloudSize=l.lerp(d.cloudPresets.default.cloudSize[0],d.cloudPresets.default.cloudSize[1],.5);this.detailSize=l.lerp(d.cloudPresets.default.detailSize[0],d.cloudPresets.default.detailSize[1],.5);this.smoothness=l.lerp(d.cloudPresets.default.smoothness[0],d.cloudPresets.default.smoothness[1],
.5);this.cloudHeight=l.lerp(d.cloudPresets.default.cloudHeight[0],d.cloudPresets.default.cloudHeight[1],.5);this.raymarchingSteps=d.cloudPresets.default.raymarchingSteps;this._viewMatrix=C.create();this.running=this._dirty=!1;this._vao=J.createQuadVAO(a.context.renderContext.rctx)}_getTechnique(a){const b=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,e=b===t.CloudsTextureChannels.RG?2*a:2*a+1,g=this._techniques[e];if(g)return g;this._techniqueConfiguration.writeTextureChannels=
b;this._techniqueConfiguration.steps=a;this._techniques[e]=new G.CloudsTechnique({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration);return this._techniques[e]}updateWeatherTile(){var a=this.view.camera.position.latitude,b=this.view.camera.position.longitude;null!=a&&null!=b&&(r.set(this._weatherTile,(a+90)/180,(b+180)/360),a=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1)),this._weatherTile[0]=Math.floor(2*this._weatherTileCount*
this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-a)*this._weatherTile[1]),b=a=0,null!=this.view.environment&&"virtual"!==this.view.environment.lighting.type&&null!=this.view.environment.lighting.date&&(b=new Date(this.view.environment.lighting.date),b.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),a=31*b.getUTCMonth()+b.getUTCDate(),b=b.getUTCFullYear()),this._weatherTile[0]=(this._weatherTile[0]+a)%
(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+b%100)%(4*this._weatherTileCount),r.equals(this._passParameters.weatherTile,this._weatherTile)||this.setDirty())}initialize(){const a=E.getReferenceEllipsoid(this.view.spatialReference);this._passParameters.cloudRadius=.5*a.radius;this.setDirty();this.updateWeatherTile();this.addHandles([this.view.resourceController.scheduler.registerTask(u.TaskPriority.CLOUDS_GENERATOR,this),w.watch(()=>[this.coverage,this.density,this.absorption,
this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),w.initial)])}destroy(){this._techniques.forEach(a=>q.releaseMaybe(a));this._frameBufferCube=q.disposeMaybe(this._frameBufferCube);this._techniques.length=0;this._vao.dispose();this._passParameters.noiseTexture=q.destroyMaybe(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case n.RayMarchingSteps.SIXTEEN:return 1;case n.RayMarchingSteps.HUNDRED:return 4;
case n.RayMarchingSteps.COUNT:case n.RayMarchingSteps.TWOHUNDRED:return 8}}get usedMemory(){return(this._frameBufferCube?.gpuMemoryUsage??0)+(this._passParameters.noiseTexture?.textureAtlas?.gpuMemoryUsage??0)}_ensureNoiseTexture(){null==this._passParameters.noiseTexture&&(this._passParameters.noiseTexture=new H.NoiseTextureAtlas({context:this.context}));this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);return null!=this._passParameters.noiseTexture.textureAtlas}_ensureFrameBufferCube(a){null==
this._frameBufferCube&&(a=new L.TextureDescriptor(a),a.target=v.TextureType.TEXTURE_CUBE_MAP,a.wrapMode=v.TextureWrapMode.CLAMP_TO_EDGE,this._frameBufferCube=new K.FramebufferObject(this.context.renderContext.rctx,a));return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=q.disposeMaybe(this._frameBufferCube)}applyPreset(a,b){const e=a.median,g=m=>{const p=l.lerp(m[0],m[1],e);return.5>b?l.lerp(m[0],p,2*b):l.lerp(p,m[1],2*(b-.5))};this.coverage=
g(a.coverage);this.density=g(a.density);this.absorption=g(a.absorption);this.cloudSize=g(a.cloudSize);this.detailSize=g(a.detailSize);this.smoothness=g(a.smoothness);this.cloudHeight=g(a.cloudHeight);this.raymarchingSteps=a.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(a){0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),r.copy(this._passParameters.weatherTile,this._weatherTile));var b=this._getTechnique(this._passParameters.raymarchingSteps);
if(!b.compiled||this.context.renderContext.bindParameters.cloudsFade.fadeMode===F.FadeMode.CROSS_FADE||!this._ensureNoiseTexture())return u.Task.YIELD;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=t.CloudsRenderingStages.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=
this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const e=this.context.renderContext.rctx,g=e.bindTechnique(b,this._passParameters,this._bindParameters);e.bindVAO(this._vao);g.assertCompatibleVertexAttributeLocations(this._vao);const m=e.getViewport();b=b.configuration.cubeMapSize;const p=b/this._tilesPerFace;e.setViewport(0,this._tileIndex*p,b,p);b=this._ensureFrameBufferCube(b);e.bindFramebuffer(b);B.targetTo(this._viewMatrix,
M,N[this._faceIndex],O[this._faceIndex]);A.fromMat4(this._drawParameters.viewMatrix,this._viewMatrix);b.setColorTextureTarget(v.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex);g.bindDraw(this._drawParameters,this._bindParameters,this._passParameters);e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4);e.gl.flush();e.setViewport(m.x,m.y,m.width,m.height);this.requestRender();++this._tileIndex;4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._tileIndex=this._faceIndex=
0,this.running||(this.context.renderContext.bindParameters.cloudsFade.renderingStage=t.CloudsRenderingStages.FADING)):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0);a.madeProgress();return u.Task.YIELD}};f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"context",void 0);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"view",void 0);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"requestRender",
void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"coverage",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"density",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"absorption",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudSize",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"detailSize",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"smoothness",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,
"cloudHeight",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"raymarchingSteps",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"running",void 0);c.CloudsGenerator=f.__decorate([z.subclass("esri.views.3d.environment.CloudsGenerator")],c.CloudsGenerator);const N=[k.fromValues(1,0,0),k.fromValues(-1,0,0),k.fromValues(0,1,0),k.fromValues(0,-1,0),k.fromValues(0,0,1)],O=[k.fromValues(0,1,0),k.fromValues(0,1,0),k.fromValues(0,0,-1),k.fromValues(0,0,1),k.fromValues(0,1,0)],
M=k.zeros();Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});