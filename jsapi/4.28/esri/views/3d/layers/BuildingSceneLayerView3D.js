// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/handleUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../layers/buildingSublayers/BuildingGroupSublayer ./BuildingComponentSublayerView3D ./BuildingSublayerView3D ./LayerView3D ./i3s/BuildingFilterUtil ./i3s/I3SUtil ../support/updatingProperties ../../layers/BuildingSceneLayerView".split(" "),
function(h,n,g,r,p,t,u,v,m,l,k,G,H,w,I,x,y,z,A,B,C,D){const E=y.BuildingSublayerView3DMixin(g);g=class extends z.LayerView3D(D){constructor(a){super(a);this.type="building-scene-3d";this.sublayerViews=new p;this._abortController=new AbortController;this._loadingComponents=0;this._pendingWhenSublayerViews=new Map;this.ignoresMemoryFactor=!1}get filterExpression(){const a=this.layer.activeFilterId;var b=null!=a?this.layer.filters.find(c=>c.id===a):null;return(b=null!=b?b.filterBlocks?.find(c=>"solid"===
c.filterMode.type):null)?b.filterExpression:null}get filterExpressions(){const a=this.layer.activeFilterId,b=null!=a?this.layer.filters.find(c=>c.id===a):null;return b?.filterBlocks?b.filterBlocks.toArray().map(c=>[c.filterExpression??"",A.parseFilterMode(c)]):[]}get updatingProgressValue(){const a=this.sublayerViews,b=this._loadingComponents+(a?a.length:0);return a.reduce((c,e)=>c+e.updatingProgress,0)/b}isUpdating(){return 0<this._loadingComponents||this.sublayerViews&&this.sublayerViews.some(a=>
a.updating)}initialize(){B.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode);this._initializeSubLayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach(a=>a.destroy()),this.sublayerViews=null);this._abortController=v.abortMaybe(this._abortController)}_initializeSubLayerViews(a,b){const c=this,e=this.view;a.forEach(d=>{if(!d.isEmpty)if("building-group"===d.type){const f=new E({sublayer:d,view:e,parent:b});this._initializeSubLayerViews(d.sublayers,
f)}else"mesh"===d.geometryType&&(this._loadingComponents++,d.load({signal:this._abortController.signal}).then(()=>{const f=new x({sublayer:d,layerView:c,view:e,parent:b});this.sublayerViews.push(f);const q=this._pendingWhenSublayerViews.get(d);if(q){for(const F of q)F.resolve(f);this._pendingWhenSublayerViews.delete(d)}this.addHandles([l.watch(()=>f.updating,()=>this.notifyChange("updating"),l.syncAndInitial),l.watch(()=>f.updatingProgress,()=>this.notifyChange("updatingProgressValue"),l.syncAndInitial)])}).catch(f=>
{m.isAbortError(f)||u.getLogger(this).error(`Error while creating view for sublayer ${d.id}\nLayer: ${this.layer.url}\n`,f)}).then(()=>{this._loadingComponents--;this.notifyChange("updating");this.notifyChange("updatingProgressValue")}))})}getGraphicFromIntersectorTarget(a){for(const b of this.sublayerViews.items)if(b.sublayer.uid===a.sublayerUid)return b.getGraphicFromIntersectorTarget(a);return null}async fetchPopupFeatures(a,b){if(!b?.clientGraphics||0===b.clientGraphics.length)return[];var c=
r.groupToMap(b.clientGraphics,d=>d.sourceLayer);const e=[];for(const [d,f]of c)c=this._findComponent(d),null!=c&&e.push(c.fetchPopupFeatures(a,{...b,clientGraphics:f}));return(await m.allSettledValues(e)).flat()}whenGraphicBounds(a){const b=this._findComponent(a.sourceLayer);return null==b?Promise.reject():b.whenGraphicBounds(a)}getAABBFromIntersectorTarget(a){for(const b of this.sublayerViews.items)if(b.sublayer.uid===a.sublayerUid)return b.getAABBFromIntersectorTarget(a);return null}async whenSublayerView(a){var b=
this._findComponent(a);if(null!=b)return b;b=this._pendingWhenSublayerViews.get(a);const c=m.createResolver();b?b.push(c):this._pendingWhenSublayerViews.set(a,[c]);return c.promise}_findComponent(a){return this.sublayerViews.find(b=>a===b.sublayer)}highlight(a){a instanceof n?a=[a]:a instanceof p&&(a=a.toArray());const b=[];if(Array.isArray(a)&&0<a.length&&a[0]instanceof n){const c=new Map;for(const e of a)a=c.get(e.sourceLayer),null==a&&(a=[],c.set(e.sourceLayer,a)),a.push(e);this.sublayerViews.forEach(e=>
{const d=c.get(e.sublayer);d&&b.push(e.highlight(d))})}return t.handlesGroup(b)}get usedMemory(){return this.sublayerViews.reduce((a,b)=>a+b.usedMemory,0)}get unloadedMemory(){return this.sublayerViews.reduce((a,b)=>a+b.unloadedMemory,0)}};h.__decorate([k.property()],g.prototype,"sublayerViews",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"filterExpression",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"filterExpressions",null);h.__decorate([k.property(C.updatingProgress)],
g.prototype,"updatingProgress",void 0);h.__decorate([k.property({readOnly:!0,dependsOn:[]})],g.prototype,"updatingProgressValue",null);return g=h.__decorate([w.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],g)});