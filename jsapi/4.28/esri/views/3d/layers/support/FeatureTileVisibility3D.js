// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/mathUtils ../../../../core/ObjectPool ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/support/frustum ../../../../geometry/support/plane ../../../../geometry/support/ray ../../../ViewingMode ./FeatureTileDescriptor3D ../../state/Frustum ../../support/FrustumExtentIntersection".split(" "),function(p,v,w,k,x,y,c,h,z,q,e,m,A){class B{constructor(a){this._renderCoordsHelper=a;this._surfaceElevation=0;this._cache=
new Map;this._frustum=new m.Frustum(a);this._extendedFrustum=new m.Frustum(a);this._intersector=new A.FrustumExtentIntersection({renderCoordsHelper:a});this._renderCoordsHelper=a}begin(a,b){this._surfaceElevation=b;this._aboveGround=this._renderCoordsHelper.getAltitude(a.eye)>b;this._frustum.update(a);this._shortenFrustumFarPlane(this._frustum);this._updateExtendedFrustum(a)}end(){this._cache.clear()}calculate(a){if(this._allTilesInvisible)return e.Visibility.INVISIBLE;const b=this._renderCoordsHelper.viewingMode===
q.ViewingMode.Global&&2<=a.lij[0]&&6>a.lij[0],d=this._getOrCalculateSingleTileVisibility(a,!b);return d!==e.Visibility.INVISIBLE&&b?this._calculateAggregatedChildrenVisibility(a):d}_shortenFrustumFarPlane(a){var b=m.Frustum.nearFarLineIndices;const d=a.mutablePoints;for(const l of b){const [g,n]=l;b=d[g];k.subtract(f,d[n],b);k.scale(f,f,.95);k.add(d[n],b,f)}a.updatePoints(d)}_calculateAggregatedChildrenVisibility(a){let b=e.Visibility.INVISIBLE;var d=this._cache.get(a.id);if(null!=d)return d;d=r.acquire();
a.getChildren(d);for(const l of d){const g=this.calculate(l);if(g!==e.Visibility.INVISIBLE&&(b=g,g===e.Visibility.VISIBLE_ON_SURFACE))break}r.release(d);this._cache.set(a.id,b);return b}_getOrCalculateSingleTileVisibility(a,b){var d=this._cache.get(a.id);if(null!=d)return d;d=this._calculateSingleTileVisibility(a);b&&this._cache.set(a.id,d);return d}_calculateSingleTileVisibility(a){if(!this._aboveGround&&this._renderCoordsHelper.viewingMode===q.ViewingMode.Global&&12>a.lij[0]){if(this._calculateSingleTileVisibilitySided(a,
!1)===e.Visibility.INVISIBLE)return this._calculateSingleTileVisibilitySided(a,!0)}else return this._calculateSingleTileVisibilitySided(a,this._aboveGround)}_calculateSingleTileVisibilitySided(a,b){this._intersector.update(a.extent,a.tilingScheme.spatialReference,this._surfaceElevation,b);a=y.getReferenceEllipsoid(a.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,a)?this._intersector.isVisibleInFrustum(this._frustum,a,!0)?e.Visibility.VISIBLE_ON_SURFACE:
e.Visibility.VISIBLE_WHEN_EXTENDED:e.Visibility.INVISIBLE}_updateExtendedFrustum(a){this._extendedFrustum.update(a);this._shortenFrustumFarPlane(this._extendedFrustum);var b=this._renderCoordsHelper.worldUpAtPosition(a.eye,f);this._aboveGround||k.negate(b,b);b=v.acosClamped(-k.dot(b,a.viewForward));this._allTilesInvisible=b>(Math.PI+a.fovY)/2;if(!this._allTilesInvisible&&(this._hasExtendedFrustum=b>a.fovY/2)){a=this._extendedFrustumParameters();b=this._extendedFrustum.mutablePoints;for(let d=0;4>
d;d++){const l=a.pointIndices[d],g=b[l],n=this._renderCoordsHelper.getAltitude(g);if(a.needsAltitudeAdjustment(n)){this._renderCoordsHelper.worldUpAtPosition(g,f);switch(l){case c.PointIndex.FAR_BOTTOM_LEFT:case c.PointIndex.FAR_TOP_LEFT:case c.PointIndex.NEAR_BOTTOM_LEFT:case c.PointIndex.NEAR_TOP_LEFT:h.projectVector(this._extendedFrustum.planes[c.PlaneIndex.LEFT],f,f);break;case c.PointIndex.FAR_BOTTOM_RIGHT:case c.PointIndex.FAR_TOP_RIGHT:case c.PointIndex.NEAR_BOTTOM_RIGHT:case c.PointIndex.NEAR_TOP_RIGHT:h.projectVector(this._extendedFrustum.planes[c.PlaneIndex.RIGHT],
f,f)}k.scale(f,f,a.direction);this._renderCoordsHelper.intersectInfiniteManifold(z.wrap(g,f),a.zWithMargin,g)}}this._extendedFrustum.updatePoints(b);h.fromPoints(b[c.PointIndex.NEAR_BOTTOM_LEFT],b[c.PointIndex.NEAR_BOTTOM_RIGHT],b[c.PointIndex.NEAR_TOP_RIGHT],t);h.fromPoints(b[c.PointIndex.NEAR_BOTTOM_RIGHT],b[c.PointIndex.NEAR_TOP_RIGHT],b[c.PointIndex.NEAR_TOP_LEFT],u);0>k.dot(h.normal(t),h.normal(u))&&(a=this._extendedFrustum.mutablePoints,this._aboveGround?[a[c.PointIndex.NEAR_BOTTOM_LEFT],a[c.PointIndex.NEAR_BOTTOM_RIGHT]]=
[a[c.PointIndex.NEAR_BOTTOM_RIGHT],a[c.PointIndex.NEAR_BOTTOM_LEFT]]:[a[c.PointIndex.NEAR_TOP_LEFT],a[c.PointIndex.NEAR_TOP_RIGHT]]=[a[c.PointIndex.NEAR_TOP_RIGHT],a[c.PointIndex.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(a))}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const a=this._surfaceElevation-1;return{zWithMargin:a,pointIndices:m.Frustum.planePointIndices.bottom,
direction:-1,needsAltitudeAdjustment(b){return b>a}}}_extendedFrustumParametersBelowSurface(){const a=this._surfaceElevation+1;return{zWithMargin:a,pointIndices:m.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment(b){return b<a}}}}const f=x.create(),t=h.create(),u=h.create(),r=new w(Array,a=>{4!==a.length&&(a[0]=new e.FeatureTileDescriptor3D,a[1]=new e.FeatureTileDescriptor3D,a[2]=new e.FeatureTileDescriptor3D,a[3]=new e.FeatureTileDescriptor3D)},a=>{a[0].release();a[1].release();a[2].release();
a[3].release()});p.FeatureTileVisibility3D=B;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});