// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/screenUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/frustum ../../../../geometry/support/plane ../../../../geometry/support/triangle ./FeatureTileDescriptor3D ./FeatureTileVisibility3D ../../webgl-engine/lib/Camera".split(" "),function(x,k,y,l,d,q,z,A,r,C,D){class E{constructor(a){this._camera=new D.Camera;this._focusOnMap=[0,0];this._screenRect=d.create();this._tileSize=a.tileSize;
this._renderCoordsHelper=a.renderCoordsHelper;this._tilingScheme=a.tilingScheme;this._visibility=new C.FeatureTileVisibility3D(a.renderCoordsHelper)}begin(a,c,b){this._camera.copyFrom(a);this._surfaceElevation=b;this._focusOnMap[0]=c.x;this._focusOnMap[1]=c.y;d.fromValues(0,0,a.fullWidth,a.fullHeight,this._screenRect);this._visibility.begin(this._camera,b)}end(){this._visibility.end()}updateTile(a){a.measures.visibility=this._visibility.calculate(a);a.measures.distance=d.distance(a.extent,this._focusOnMap);
a.measures.visibility!==r.Visibility.INVISIBLE&&this._updateScreenMeasure(a)}_updateScreenMeasure(a){const c=a.measures.screenRect;d.empty(c);let b=0;const e=a.lij[0]+2,h=a.lij[1]<<2,F=a.lij[2]<<2;var t=this._tileSizeWithBias(a);t*=t;for(let u=0;4>u;u++)for(let v=0;4>v;v++)if(b+=this._computeScreenArea(a,e,h+u,F+v,c),b>t){a.measures.shouldSplit=!0;return}a.measures.shouldSplit=!1}_tileSizeWithBias(a){return a.measures.visibility===r.Visibility.VISIBLE_WHEN_EXTENDED?5*this._tileSize:this._tileSize}_computeScreenArea(a,
c,b,e,h){this._projectToScreen(c,b,e,a.measures.visibility===r.Visibility.VISIBLE_WHEN_EXTENDED,f);d.empty(w);for(a=0;4>a;a++)d.expandPointInPlace(w,f[a]);d.expand(h,w,h);return A.areaPoints2d(f[0],f[1],f[2])+A.areaPoints2d(f[0],f[2],f[3])}_projectToScreen(a,c,b,e,h){this._tilingScheme.ensureMaxLod(a);this._tilingScheme.getExtent(a,c,b,m);this._toRenderCoords(m,0,3,g[0]);this._toRenderCoords(m,2,3,g[1]);this._toRenderCoords(m,2,1,g[2]);this._toRenderCoords(m,0,1,g[3]);e&&(this._projectToPlane(g,this._camera.frustum[q.PlaneIndex.NEAR]),
this._projectToPlane(g,this._camera.frustum[q.PlaneIndex.TOP]),this._projectToPlane(g,this._camera.frustum[q.PlaneIndex.BOTTOM]));for(a=0;4>a;a++)this._camera.projectToRenderScreen(g[a],B),this._camera.renderToScreen(B,h[a])}_projectToPlane(a,c){for(var b=0;4>b;b++)n[b]=z.signedDistance(c,a[b]);b=Math.max(n[0],n[1],n[2],n[3]);if(0<b)for(c=y.scale(p,z.normal(c),-b),b=0;4>b;b++)y.add(a[b],a[b],c)}_toRenderCoords(a,c,b,e){p[0]=a[c];p[1]=a[b];p[2]=this._surfaceElevation;this._renderCoordsHelper.toRenderCoords(p,
this._tilingScheme.spatialReference,e);return e}}const w=d.create(),f=[k.createScreenPointArray(),k.createScreenPointArray(),k.createScreenPointArray(),k.createScreenPointArray()],m=d.create(),p=l.create(),g=[l.create(),l.create(),l.create(),l.create()],n=[0,0,0,0],B=k.createRenderScreenPointArray3();x.FeatureTileMeasurements3D=E;Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});