// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/Logger ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../symbols/support/unitConversionUtils ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/VertexAttribute".split(" "),
function(g,k,v,w,x,y,m,F,G,H,z,r,n,l,A,B,C,D,E){g.StageLayerElevationProvider=class extends w.EventedMixin(v){get spatialReference(){return this.view?.spatialReference}constructor(a){super(a);this._elevationOffset=0;this._layerHandlesKey="layerHandles"}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper;this._intersectLayers=[this.stageLayer];this._intersector=C.newIntersector(this.view.state.viewingMode);this._intersector.options.store=D.StoreResults.MIN;var a=this._computeLayerExtent(this.spatialReference,
this.stageLayer);this._zmin=a[2];this._zmax=a[5];a=this.stageLayer.events;this.addHandles([a.on("layerObjectAdded",({object:b})=>this._objectChanged(b)),a.on("layerObjectRemoved",({object:b})=>this._objectChanged(b)),a.on("geometryAdded",({object:b})=>this._objectChanged(b)),a.on("geometryRemoved",({object:b})=>this._objectChanged(b)),a.on("attributesChanged",({attribute:b,object:c})=>E.affectsGeometry(b)&&this._objectChanged(c)),a.on("transformationChanged",b=>this._objectChanged(b))],this._layerHandlesKey)}dispose(){this.removeHandles(this._layerHandlesKey)}elevationInfoChanged(){const a=
null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"on-the-ground"!==a.mode){const b=y.getMetersPerVerticalUnitForSR(this.layer.spatialReference),c=B.getMetersPerUnit(a.unit??"meters");this._elevationOffset=(a.offset??0)*c/b}else this._elevationOffset=0}getElevation(a,b,c,h){d[0]=a;d[1]=b;d[2]=c;if(!this._renderCoordsHelper.toRenderCoords(d,h,d))return x.getLogger(this).error("could not project point for elevation alignment"),null;a=this._elevationOffset;b=this._zmin+a;this._renderCoordsHelper.setAltitude(t,
this._zmax+a,d);this._renderCoordsHelper.setAltitude(u,b,d);this._intersector.reset(t,u,null);this._intersector.intersect(this._intersectLayers,null,1,null,e=>!!e.lastValidElevationBB);return this._intersector.results.min.getIntersectionPoint(d)?this._renderCoordsHelper.getAltitude(d):null}_objectChanged(a){const b=this.spatialReference;if(a.lastValidElevationBB&&b){l.empty(f);var c=a.lastValidElevationBB;c.isEmpty()||this._expandExtent(b,c.min,c.max,f);var {min:h,max:e}=a.boundingVolumeWorldSpace;
this._expandExtent(b,h,e,f);l.toRect(f,p);this._zmin=Math.min(this._zmin,f[2]);this._zmax=Math.max(this._zmax,f[5]);q.extent=p;q.spatialReference=b;this.emit("elevation-change",q);r.copy(c.min,h);r.copy(c.max,e)}}_computeLayerExtent(a,b){l.empty(f);null!=a&&b.objects.forAll(c=>this._expandExtent(a,c.boundingVolumeWorldSpace.min,c.boundingVolumeWorldSpace.max,f));return f}_expandExtent(a,b,c,h){for(let e=0;8>e;++e)d[0]=e&1?b[0]:c[0],d[1]=e&2?b[1]:c[1],d[2]=e&4?b[2]:c[2],this._renderCoordsHelper.fromRenderCoords(d,
d,a),l.expandWithVec3(h,d);return h}};k.__decorate([m.property({constructOnly:!0})],g.StageLayerElevationProvider.prototype,"layer",void 0);k.__decorate([m.property({constructOnly:!0})],g.StageLayerElevationProvider.prototype,"stageLayer",void 0);k.__decorate([m.property({constructOnly:!0})],g.StageLayerElevationProvider.prototype,"view",void 0);k.__decorate([m.property()],g.StageLayerElevationProvider.prototype,"spatialReference",null);g.StageLayerElevationProvider=k.__decorate([z.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],
g.StageLayerElevationProvider);const f=l.empty(),p=A.empty(),q={spatialReference:null,extent:p,context:"scene"},d=n.create(),t=n.create(),u=n.create();Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});