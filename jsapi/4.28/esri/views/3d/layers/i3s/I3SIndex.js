// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../chunks/vec3 ../../../../geometry/projection/projectBoundingSphere ../../../../chunks/sphere ../../../../support/featureFlags ./ElevationRange ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),function(F,A,L,P,G,y,Q,H,q,t,M){function N(a){null!=a.node&&(t.invalidateMbs(a.node.renderMbs),t.invalidateObb(a.node.serviceObbInRenderSR));null!=a.ref&&(t.invalidateMbs(a.ref.renderMbs),t.invalidateObb(a.ref.serviceObbInRenderSR))}
function B(a,b){return 0>a?-1:0<b?a/b|0:0}function w(a,b){return 0>a?-a-1:0===b?a:a%b}function E(a,b,c){return-1===b?-(a+1):0===c?a:b*c+a}function O(a){if(a)for(let b=0;b<a.length;b++)for(const c of R)if(c[0]===a[b].metricType)return{lodMetric:c[1],maxError:a[b].maxError};return{lodMetric:q.LodMetric.None,maxError:0}}function S(a){return Math.sqrt(4/Math.PI*a)}class I{constructor(a,b,c,d,e){this.childOffset=a;this.childCount=b;this.visibilityCache=c;this.ref=d;this.node=e;this.useAsHole=0;this.filterImpact=
q.NodeFilterImpact.NotChecked;this.traversalState=null;this.parent=-1}}class J{constructor(a=[],b=[]){this.nodes=a;this.children=b;this.numNodesWithLoadedChildren=this.lastTraversed=0}}class T{get _useNodePages(){return 0<this._pageSize}constructor(a,b,c,d,e,f,k,h,p,g,l,v,n,m,r){this._layer=a;this._streamDataController=c;this._clientNodeLoader=d;this._viewportQueries=e;this._logger=f;this.holeFilling=k;this._isLoaded=h;this._isReloading=p;this._isSelected=g;this._enable=l;this._needsUpdate=v;this._canRequest=
n;this._computeVisibilityObb=m;this._computeNodeFiltering=r;this._dirty=!0;this._nodePages=new Map;this._clientNodePage=null;this._rootIndex=this._pageSize=0;this._lodMetric=q.LodMetric.None;this._lodConversion=x=>x;this._isEditable=!1;this._urlPrefix="";this._loadingNodes=new Set;this._loadingPages=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._version=t.addWraparound(0,
2);this._visibilityCacheVersion=t.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leavesReached:!1};this._unloadedMemoryEstimate=0;this._missingPagesAndNodes=new A({deallocator:null});this._prefetchNodes=new A({deallocator:null});this._updates=new U(this._missingPagesAndNodes);this._imModificationUncategorized=new A({deallocator:null});this.ignoreServiceObb=!1;this.progressiveLoadPenalty=0;this._pageQueue=[];this._newPages=[];this._layerHasFilter=this.layerHasModifications=this.needNodeElevationRange=
!1;this._frameNumber=0;this._isEditable=Q.i3sPatchingEnabled()&&null!=a.associatedLayer?.infoFor3D;a.serviceUpdateTimeStamp?.lastUpdate&&(this._lastUpdate=`${a.serviceUpdateTimeStamp.lastUpdate}`);this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1;this._init(b)}_init(a){if("page"===a.type){var b=a.rootPage;this._urlPrefix=a.urlPrefix;this._pageSize=a.pageSize;switch(a.lodMetric){case "maxScreenThreshold":this._lodMetric=q.LodMetric.MaxScreenThreshold;break;case "maxScreenThresholdSQ":this._lodMetric=
q.LodMetric.MaxScreenThreshold,this._lodConversion=S}if(this._isEditable){this._rootIndex=-1;var c=w(a.rootIndex,a.pageSize);c=b.nodes[c];c={nodes:[{index:this._rootIndex,children:[a.rootIndex],mesh:void 0,obb:c.obb,lodThreshold:c.lodThreshold}]};this._addPage(B(this._rootIndex,this._pageSize),c);this.getNode(-1).serviceObb=void 0}else this._rootIndex=a.rootIndex;this._addPage(B(a.rootIndex,this._pageSize),b);this._updateParentsAndLevel()}else"node"===a.type&&(this._urlPrefix=a.urlPrefix,b=new J,
this._nodePages.set(0,b),this._isEditable?(this._clientNodePage=new J,b={id:"-1",version:null,mbs:a.rootNode.mbs,obb:a.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:a.rootNode.mbs,obb:a.rootNode.obb}]},this._rootIndex=this._makeClientRefNode(new q.NodeBase(b.id,null),-1),(b=this._validateNode(b.id,b))&&this._addNode(b,this._rootIndex)):this._rootIndex=this._makeRefNode(new q.NodeBase(a.rootNode.id,null),-1),(a=this._validateNode(a.rootNode.id,
a.rootNode))&&this._addNode(a,0))}addClientNodeToIndex(a,b){a=new q.NodeBase(a,b);a=this._makeClientRefNode(a,-1);this._linkChildToParentNode(-1,a);this.requestUpdate();return a}removeClientNodeFromIndex(a,b,c){this._destroyClientRefNode(a,b,c);this.requestUpdate()}_loadPage(a){this._loadingPages.add(a);this._streamDataController.request(this._urlPrefix+a,"json").then(b=>{this._pageQueue.push({pageIndex:a,page:b})}).catch(b=>{this._loadingPages.delete(a);L.isAbortError(b)||(this._failedPages.add(a),
this._logger.error("#loadPage()",this._layer,`Error when loading page ${a}`,b))})}_addQueuedPages(a){for(;0<this._pageQueue.length&&!a.done;){const {pageIndex:b,page:c}=this._pageQueue.shift();this._addPage(b,c);this._loadingPages.delete(b);a.madeProgress();this.needNodeElevationRange&&this._newPages.push(b)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(a){if(this.needNodeElevationRange)for(;0<this._newPages.length&&!a.done;){var b=this._nodePages.get(this._newPages.shift());
if(null!=b){b=b.nodes;for(let c=0;c<this._pageSize;c++){let d=b[c].parent;for(;null!=d&&d!==this._rootIndex;){const e=this.getNode(d);e&&!Number.isNaN(e?.elevationRangeMin)&&(e.invalidateElevationRange(),this.invalidateBoundingVolumeCache(d));d=this.getParentIndex(d)}}}}}_addPage(a,b){const c=[],d=[];b=b.nodes.map((e,f)=>{const k=c.length,h=e.children?e.children.length:0;d.push(this._rootIndex);for(var p=0;p<h;p++)c.push(e.children[p]);const g=`${e.index}`;p=M.clone(e.obb);const l=y.fromValues(p.center[0],
p.center[1],p.center[2],P.length(p.halfSize));var v=e.mesh?.attribute;const n=e.mesh?.geometry,m=e.mesh?.material;v={hasSharedResource:!1,isEmpty:null==n,attributes:null!=v?.resource?`${v.resource}`:void 0,geometry:null!=n?.resource?`${n.resource}`:void 0,texture:null!=m?.resource?`${m.resource}`:void 0,geometryDefinition:n?n.definition:-1,materialDefinition:m?m.definition:-1};e=new q.Node(g,E(f,a,this._pageSize),l,h,0,v,this._lastUpdate,this._lodMetric,this._lodConversion(e.lodThreshold),n?n.featureCount:
null);e.serviceObb=p;e.visibilityObb=this._computeVisibilityObb(e);e.vertexCount=n?n.vertexCount:0;return new I(k,h,t.addWraparound(this._visibilityCacheVersion,-2),null,e)});b=new J(b,c);-1===a?this._clientNodePage=b:this._nodePages.set(a,b)}_updateParentsAndLevel(){const a=[],b=(c,d,e)=>{var f=this._getPage(c);if(null!=f){const k=w(c,this._pageSize);f=f.nodes[k];f.parent=null!=d?d:-1;d=f.node;null!=d&&(d.level=e,a.push(c))}};for(b(this._rootIndex,null,0);a.length;){const c=a.pop(),d=this.getNode(c);
if(null!=d)for(let e=0;e<d.childCount;e++){const f=this.getChildIndex(d.index,e);b(f,c,d.level+1);this._maxLevel=Math.max(this._maxLevel,d.level+1)}}}_getPage(a){a=B(a,this._pageSize);return 0>a?this._clientNodePage:this._nodePages.get(a)}_getNodeInternal(a){const b=this._getPage(a);if(null==b)return null;b.lastTraversed=this._frameNumber;return b.nodes[w(a,this._pageSize)]}_addNode(a,b){null!=a.children&&this.populateChildren(b,a.children);var c=this.getParent(b);c=null!=c?c.level+1:0;this._maxLevel=
Math.max(this._maxLevel,a.children?c+1:c);const {lodMetric:d,maxError:e}=O(a.lodSelection),f=this._getNodeInternal(b);f.node=new q.Node(a.id,b,a.mbs,f.childCount,c,a.resources,a.version,d,e,a.numFeatures);a.obb&&(f.node.serviceObb=M.clone(a.obb));f.node.visibilityObb=this._computeVisibilityObb(f.node);null!=f.ref&&(null==f.ref.mbs&&(f.ref.mbs=a.mbs),f.node.renderMbs=f.ref.renderMbs,f.node.serviceObbInRenderSR=f.ref.serviceObbInRenderSR,f.ref.visibilityObb=f.node.visibilityObb);return f.node}_makeRefNode(a,
b){const c=this._nodePages.get(0);if(-1>b)return this._makeClientRefNode(a,b);if(null==c)return-1;const d=c.nodes.length,e=new I(0,0,t.addWraparound(this._visibilityCacheVersion,-2),a,null);c.nodes.push(e);e.parent=b;t.invalidateMbs(a.renderMbs);t.invalidateObb(a.serviceObbInRenderSR);return d}_makeClientRefNode(a,b){const c=this._clientNodePage;if(null==c)return-1;if(0<=b)throw Error("I3SIndex::client side nodes can not be made children of service side nodes.");const d=-(c.nodes.length+1),e=new I(0,
0,t.addWraparound(this._visibilityCacheVersion,-2),a,null);c.nodes.push(e);e.parent=b;t.invalidateMbs(a.renderMbs);t.invalidateObb(a.serviceObbInRenderSR);return d}_linkChildToParentNode(a,b){const c=this._clientNodePage;if(!(null==c||0<=a)){var d=w(a,this._pageSize),e=w(b,this._pageSize);d=c.nodes[d];var f=d.childOffset;c.children.splice(d.childOffset+d.childCount,0,b);d.childCount+=1;null!=d.node&&(d.node.childCount+=1);for(const k of c.nodes)k.childOffset>f&&(k.childOffset+=1);c.nodes[e].parent=
a;this._updateParentBoundingInformation(a)}}_destroyClientRefNode(a,b,c){const d=this._clientNodePage;if(null!=d){var e=this.getParentIndex(a);if(null!=e){var f=new Set,k=new Map,h=D=>{var z=w(D,this._pageSize);z=d.nodes[z];if(0<z.childCount)for(var C=z.childOffset;C<z.childOffset+z.childCount;++C)h(d.children[C]);C=z.node?.id??z.ref?.id;if(null==C)throw Error("Node has no id");b(C,D);f.add(z)};h(a);a=d.nodes;var p=d.children,g=d.nodes.map(()=>-1),l=[],v=[];for(var n=0;n<a.length;++n){var m=a[n];
if(!f.has(m)){var r=l.length,x=E(n,-1,this._pageSize);r=E(r,-1,this._pageSize);m.node&&(m.node.index=r);g[n]=r;l.push(m);if(x!==r){m=m.node?.id??m.ref?.id;if(null==m)throw Error("Node has no id");c(m,x,r);k.set(x,r)}}}for(c=0;c<l.length;++c){k=E(c,-1,this._pageSize);n=l[c];x=v.length;for(m=n.childOffset;m<n.childOffset+n.childCount;++m)if(r=p[m],0<=r)v.push(r);else{r=w(r,this._pageSize);const D=a[r];f.has(D)||(v.push(g[r]),D.parent=k)}n.childOffset=x;n.childCount=v.length-x;n.node&&(n.node.childCount=
n.childCount)}d.nodes=l;d.children=v;this._updateParentBoundingInformation(g[w(e,this._pageSize)])}}}_updateParentBoundingInformation(a){do{let d=null;var b=this._clientNodeLoader.indexSR;const e=this._clientNodeLoader.renderSR,f=this._getNodeInternal(a);if(null==f)break;for(let k=0;k<f.childCount;k++){var c=this.getChildIndex(a,k);c=this._getNodeInternal(c);c=null!=c?c.ref||c.node:null;if(null!=c&&0<c.mbs[3])if(null==d)d=y.copy(c.mbs,V);else{const h=W,p=X,g=Y;G.projectBoundingSphere(c.mbs,b,h,e);
G.projectBoundingSphere(d,b,p,e);y.union(h,p,g);G.projectBoundingSphere(g,e,d,b)}}b=f.ref||f.node;null!=b&&(null!=d?b.mbs=y.copy(d,null!=b.mbs?b.mbs:y.create()):t.invalidateMbs(b.mbs),t.invalidateMbs(b.renderMbs),t.invalidateObb(b.serviceObbInRenderSR),b.geometryObb=null);this.invalidateNodeVisibilityCacheInternal(f);a=this.getParentIndex(a)}while(null!=a)}populateChildren(a,b){var c=this._getNodeInternal(a);const d=this._getPage(a);c.childOffset=d.children.length;c.childCount=b.length;for(c=0;c<
b.length;c++){const e=this._makeRefNode(b[c],a);d.children.push(e)}}getNode(a){a=this._getNodeInternal(a);return null!=a?a.node:null}getIndexById(a){let b;this._forAllNodes((c,d)=>{null!=c.node&&c.node.id===a?b=d:null!=c.ref&&c.ref.id===a&&(b=d)});return b}getNodeById(a){a=this.getIndexById(a);return null!=a&&0<=a?this.getNode(a):null}getChildIndex(a,b){const c=this._getPage(a);if(null==c)return-1;a=c.nodes[w(a,this._pageSize)];return c.children[a.childOffset+b]}getParentIndex(a){const b=this._getPage(a);
return null!=b&&a!==this._rootIndex?b.nodes[w(a,this._pageSize)].parent:null}getParent(a){a=this.getParentIndex(a);return null!=a?this.getNode(a):null}isLeaf(a){a=this._getNodeInternal(a);return null!=a&&0===a.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes(a=>{null!=a.node&&(a.node.geometryObb=null)})}invalidateVisibilityCache(){this._visibilityCacheVersion=t.addWraparound(this._visibilityCacheVersion,
2)}invalidateNodeVisibilityCache(a){a=this._getNodeInternal(a);null!=a&&this.invalidateNodeVisibilityCacheInternal(a)}invalidateNodeVisibilityCacheInternal(a){a.visibilityCache=t.addWraparound(this._visibilityCacheVersion,-2)}invalidateBoundingVolumeCache(a){a=this._getNodeInternal(a);null!=a&&(N(a),this.invalidateNodeVisibilityCacheInternal(a))}updateElevationChanged(a){const b=this._getNodeInternal(a);null!=b&&(this.needNodeElevationRange?(a=null!=b.node?b.node:b.ref,null!=a&&a.invalidateElevationRange()):
this.invalidateBoundingVolumeCache(a))}invalidateGeometryVisibility(a){a=this._getNodeInternal(a);null!=a?.node&&(a.node.geometryObb=null,t.invalidateMbs(a.node.renderMbs),t.invalidateObb(a.node.serviceObbInRenderSR))}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,a=>{a.visibilityObb=this._computeVisibilityObb(a);a.geometryObb=null;return!0})}_updateElevationRange(a){this._updateElevationRangeInternal(a,null)}_updateElevationRangeInternal(a,b){const c=this._getNodeInternal(a);
if(!c)return!1;const d=c?.node??c?.ref;if(!d)return!1;const e=d.elevationRangeMin;if(!Number.isNaN(e))return H.expandElevationRange(b,d),!0;const f={elevationRangeMin:Infinity,elevationRangeMax:-Infinity};var k=!1;for(let h=0;h<c.childCount;h++){const p=this.getChildIndex(a,h);this._updateElevationRangeInternal(p,f)||(k=!0)}(0===c.childCount||k)&&this._viewportQueries.expandElevationRange(d,!c.node?.resources.isEmpty,f);k=d.elevationRangeMax;if(!Number.isNaN(e)&&e===f.elevationRangeMin&&k===f.elevationRangeMax)return H.expandElevationRange(b,
d),!0;c.node&&(c.node.elevationRangeMin=f.elevationRangeMin,c.node.elevationRangeMax=f.elevationRangeMax);c.ref&&(c.ref.elevationRangeMin=f.elevationRangeMin,c.ref.elevationRangeMax=f.elevationRangeMax);this.invalidateBoundingVolumeCache(a);H.expandElevationRange(b,d);return!0}isNodeVisible(a){const b=this._getNodeInternal(a);if(null==b||null!=b.ref&&!b.ref.mbs)return!0;this.needNodeElevationRange&&this._updateElevationRange(a);if((b.visibilityCache&-2)!==this._visibilityCacheVersion){a=b.node;const d=
!a||b.ref&&!a.visibilityObb?b.ref??null:a;if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=a||null!=b.ref)&&b.filterImpact===q.NodeFilterImpact.NotChecked){var c=null!=a?a.mbs:null!=b.ref?b.ref.mbs:null;b.filterImpact=null!=c?this._computeNodeFiltering(c):q.NodeFilterImpact.Unmodified}c=null!=a&&b.filterImpact===q.NodeFilterImpact.Culled;a=!(null!=a&&a.imModificationImpact===q.NodeIMModificationImpact.Culled)&&(!d||this._viewportQueries.isNodeVisible(d))&&!c;b.visibilityCache=this._visibilityCacheVersion+
(a?1:0);return a}return 1===(b.visibilityCache&1)}isGeometryVisible(a){if(!this.isNodeVisible(a))return!1;a=this._getNodeInternal(a);return null==a?.node?.geometryObb||this.layerHasModifications&&a.node.imModificationImpact===q.NodeIMModificationImpact.NotChecked?!0:this._viewportQueries.isGeometryVisible(a.node)}_traverseCoverage(a,b,c,d,e){a=this._getPage(a);if(null!=a&&0!==b.childCount){var f=b.childOffset+b.childCount,k=[];for(b=b.childOffset;b<f;++b){const h=a.children[b],p=this._getNodeInternal(h);
null!=p?.node&&this.isGeometryVisible(h)&&k.push(p)}d/=k.length;for(const h of k)a=h.node.index,this._isLoaded(a)||this._isReloading(a)?(e.delta=Math.max(e.delta,c),e.coverage+=d):this._traverseCoverage(a,h,c+1,d,e)}}useNodeAsHole(a){if("off"===this.holeFilling)return!1;const b=this._getNodeInternal(a);if(null==b)return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);const c={delta:0,coverage:0};this._traverseCoverage(a,b,0,1,c);a=.5>=c.delta*
c.coverage;b.useAsHole=this._version+(a?1:0);return a}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune();this._updates.update.prune()}requestUpdate(){this._dirty=!0;this._indexMissing=1;this._version=t.addWraparound(this._version,2)}imModificationsChanged(a){this.layerHasModifications=a;this._forAllNodes(({node:b})=>{null!=b&&(b.imModificationImpact=q.NodeIMModificationImpact.NotChecked,b.visibilityObb=this._computeVisibilityObb(b),b.hasModifications&&
this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()}layerFilterChanged(a){this._layerHasFilter=a;this._forAllNodes(b=>{null!=b&&(b.filterImpact=q.NodeFilterImpact.NotChecked,b=b.node,null!=b&&this.invalidateNodeVisibilityCache(b.index))});this.invalidateVisibilityCache()}update(a,b,c){if(this._dirty){0<this._pageQueue.length&&this._addQueuedPages(b);this._invalidateElevationRangeForNewPages(b);this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missingPagesAndNodes.clear();
this._prefetchNodes.clear();this._updates.reset(a);u.clear();var d=!0,e=new K,f=new K,k=this._imModificationUncategorized;k.clear();var h=new Set;this.traverseVisible((g,l,v)=>{var n=B(g,this._pageSize);h.add(n);if(null==l)g=this._entryPriority(g),Infinity===g&&(g=this._entryPriority(v)),u.set(n,Math.max(g,u.get(n)||0)),this._loadingPages.has(n)||this._failedPages.has(n)||this._missingPagesAndNodes.push(n),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,g);else{var m=l.node;this._updateNodeFeatureEstimate(m,
f);if(null==m)l=this._entryPriority(g),this._loadingNodes.has(g)||this._failedNodes.has(g)||(this._missingPagesAndNodes.push(g),u.set(g,l)),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l);else{v=this._getPage(g);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(n=0;n<l.childCount;n++){const r=v.children[l.childOffset+n],x=this._getNodeInternal(r);null==x||x.node||this._loadingNodes.has(r)||this._failedNodes.has(r)||(u.set(r,this._entryPriority(r)),this._prefetchNodes.push(r))}m.failed||
m.resources.isEmpty?d&&0<l.childCount&&this._isSelected(m)&&(d=!1):this._isLoaded(g)?(e.known+=m.memory,++e.knownNodes,this._isSelected(m)?0<l.childCount&&(d=!1):(e.unremoved+=m.memory,d=!1),this._needsUpdate(m)&&(l=this._entryPriority(g),u.set(g,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.update.push(g))):(m.memory&&(e.known+=m.memory,++e.knownNodes),this._isSelected(m)?(0<l.childCount&&(d=!1),m.memory?(e.missing+=m.memory,e.known+=m.memory,++e.knownNodes):++e.missingNodes,
a.includes(m.index)?(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(g)),this._updates.cancel=this._updates.cancel.filter(r=>r!==m.index)):!b.done&&this._enable(m)?b.madeProgress():(l=this._entryPriority(g),u.set(g,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.add.push(g),this.layerHasModifications&&c&&null!=m&&m.imModificationImpact===q.NodeIMModificationImpact.NotChecked&&k.push(g))):this._isReloading(g)&&this._updates.remove.push(g))}}});
this._frameNumber++;this._missingPagesAndNodes.sort((g,l)=>g-l);this._missingPagesAndNodes.filterInPlace((g,l)=>1>l||this._missingPagesAndNodes.data[l-1]!==g);this._missingPagesAndNodes.sort((g,l)=>u.get(g)-u.get(l));0<this._missingPagesAndNodes.length&&(this._maxUnloadedPrio=u.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear());var p=this._updates.add;0<p.length&&this.layerHasModifications&&(0<k.length&&c?.(k),p.filterInPlace(g=>{var l=this._getNodeInternal(g);(l=null==l?.node||l.node.imModificationImpact!==
q.NodeIMModificationImpact.Culled)||this.invalidateNodeVisibilityCache(g);return l}));this._unloadedMemoryEstimate=e.missing-e.unremoved;3<e.knownNodes&&0<e.missingNodes&&(this._unloadedMemoryEstimate+=e.known/e.knownNodes*e.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(f);this._featureEstimate.leavesReached=d;this._updates.add.filterInPlace(g=>u.get(g)>=this._maxUnloadedPrio).sort((g,l)=>u.get(g)-
u.get(l));this._updates.update.sort((g,l)=>u.get(g)-u.get(l));this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length;this._dirty=0<this._indexMissing;u.clear()}}checkFeatureTarget(a,b){const c=this._viewportQueries.updateScreenSpaceErrorBias(b);let d=b,e=b,f=c,k=10;for(;k--;){const h=new K;this._updateFeatureEstimate(d,h);if(this._computeFeatureEstimate(h)<=a){if(d>=b||0<h.missingNodes||0===k)break;f=d;d=.5*(d+e)}else e=d,d=.5*(d+f)}this._version=t.addWraparound(this._version,
2);this._viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,d)}_updateFeatureEstimate(a,b){this._version=t.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible((c,d)=>this._updateNodeFeatureEstimate(null!=d?d.node:void 0,b))}_updateNodeFeatureEstimate(a,b){null!=a&&!a.failed&&null!=a.numFeatures&&this._isSelected(a)&&(null!=a.numFeatures?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes)}_computeFeatureEstimate(a){let b=
a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){this._prefetchNodes.sort((a,b)=>u.get(a)-u.get(b));return this._load(this._prefetchNodes)}_load(a){if(0===a.length||!this._canRequest())return!1;for(;0<a.length&&this._canRequest();){const b=a.pop();this._useNodePages?0<=b?this._loadPage(b):this._loadNode(b):this._loadNode(b)}return!0}get isLoading(){return 0<this._indexMissing}get isPrefetching(){return 0<
this._prefetchNodes.length}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(a){if(null==a)return null;const b=a.index,c=this._getNodeInternal(b);if(!c)return null;let d=c?.traversalState;
if(d&&(d.version&-2)===this._version)return d;const e=this._viewportQueries.getLodLevel(a),f=this._viewportQueries.hasLOD(a);let k=!0;f?(a=this.getParentIndex(b),null!=a?(a=this._getNodeInternal(a)?.traversalState,k=!!a&&e>a.lodLevel):k=0<e):k=0===a.childCount;if(d)return d.lodLevel=e,d.isChosen=k,d.version=this._version+1,d;d=new q.NodeTraversalState(f,k,e,this._version+1);return c.traversalState=d}async _loadNode(a){this._loadingNodes.add(a);var b=this._getNodeInternal(a).ref;if(null==b)this._failedNodes.add(a);
else{b=b.id;var c=this._urlPrefix+b,d=()=>{this._loadingNodes.delete(a);0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()},e=null;try{e=0<=a?await this._streamDataController.request(c,"json"):await this._clientNodeLoader.loadNodeJSON(b)}catch(f){d();L.isAbortError(f)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+c),this._failedNodes.add(a));return}d();b=this._validateNode(b,e);null!=b&&(b.obb&&this.invalidateNodeVisibilityCache(a),b=this._addNode(b,
a),this.nodeTraversalState(b))}}_validateNode(a,b){if(null==b||"object"!==typeof b||b.id!==a)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${a}"`),null;if(!Array.isArray(b.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${a}.`),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${a}"`);
var c=b.geometryData;null==c||Array.isArray(c)&&0===c.length||Array.isArray(c)&&1===c.length&&"./geometries/0"===c[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${a}"`);c=b.attributeData;const d=this._layer.attributeStorageInfo;null==c||Array.isArray(c)&&!c.some((h,p)=>h.href!==`./attributes/${d?.[p]?.key??`f_${p}`}/0`)||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${a}"`);b.featureData&&1<b.featureData.length&&this._logger.warn("#validateNode()",
this._layer,`Node ${a} has ${b.featureData.length} bundles. Only the first bundle will be loaded.`);c=b.hasOwnProperty("obb")&&!this.ignoreServiceObb?b.obb:null;const e=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+1:void 0;var f=h=>{if(null==h)return null;var p=g=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${a}: ${g}`);if("number"===typeof h.id)p(`id ${h.id} is a number instead of a string.`);
else if("string"!==typeof h.id||!Array.isArray(h.mbs))return p("Missing or invalid id."),null;if(!Array.isArray(h.mbs))return p(`Invalid bounding volume on reference ${h.id}.`),null;h.href&&h.href!=="../"+h.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${a}"`);p=h.hasOwnProperty("obb")&&!this.ignoreServiceObb?h.obb:null;h=new q.NodeBase(`${h.id}`,h.mbs);h.serviceObb=p;h.visibilityObb=this._computeVisibilityObb(h);return h};f=Array.isArray(b.children)?b.children.map(f).filter(h=>
null!=h):null;const k=!0===b.isEmpty;return{id:a,mbs:b.mbs,obb:c,children:f,resources:{isEmpty:!(b.featureData?.length??!1)&&k,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:void 0,texture:b.textureData&&0<b.textureData.length?a:void 0,geometry:null!=b.geometryData?a:void 0},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:e}}resetFailedNodes(){this._failedNodes.clear();this._failedPages.clear();this._forAllNodes(a=>
{null!=a.node&&(a.node.failed=!1)})}_entryPriority(a){var b=this._getNodeInternal(a),c=this.getParentIndex(a);if(null==b||null==c&&null==b.node)return null==c?Infinity:this._entryPriority(c);let d=0;b.node&&null!=c&&(c=this._getNodeInternal(c).traversalState,null!=c&&(d=c.lodLevel));for(c=this.progressiveLoadPenalty;null!=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=null!=b.ref?this._viewportQueries.distToPOI(b.ref):null!=b.node?this._viewportQueries.distToPOI(b.node):0;return-b-d*
(b+this.progressiveLoadPenalty)+c}traverseVisible(a){const b=this._getNodeInternal(this._rootIndex);null==b?a(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,null,b,a)}_traverseVisible(a,b,c,d){if(c.node&&0===c.childCount)this.isGeometryVisible(a)&&d(a,c,b);else if(this.isNodeVisible(a)&&(d(a,c,b),null!=c.node&&(b=this.nodeTraversalState(c.node),!b?.nodeHasLOD||b.lodLevel!==this._maxLodLevel))){b=this._getPage(a);for(let e=0;e<c.childCount;e++){const f=b.children[c.childOffset+e],
k=this._getNodeInternal(f);k?this._traverseVisible(f,a,k,d):d(f,null,a)}}}traverse(a,b){b(a)&&this.traverseChildren(a,b)}traverseChildren(a,b){a=a.index;const c=this._getNodeInternal(a);null!=c&&this._traverseChildren(a,c,b)}_traverseChildren(a,b,c){a=this._getPage(a);if(null!=a){var d=b.childOffset+b.childCount;for(b=b.childOffset;b<d;++b){const e=a.children[b],f=this._getNodeInternal(e);null!=f?.node&&c(f.node)&&this._traverseChildren(e,f,c)}}}updateChildrenLoaded(a,b){for(a=this.getNode(a);null!=
a;){var c=a.childrenLoaded;const d=c+b;a.childrenLoaded=d;c=0===c?1:0===d?-1:0;a=a.index;0!==c&&(this._getPage(a).numNodesWithLoadedChildren+=c);a=this.getParent(a)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;const a=[],b=c=>{let d=this._isLoaded(c.index)||this._isReloading(c.index)?1:0;this.traverseChildren(c,e=>{d+=b(e);return!1});c.childrenLoaded!==d&&a.push(c.index);return d};b(this.rootNode);a.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+
a.join(","));return 0<a.length}updateStats(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);a.index=this._nodePages.size*(this._pageSize||1)+(this._clientNodePage?.nodes.length??0);a.prio=this._maxProcessingPrio;if(this._indexMissing||0<this._prefetchNodes.length)a.index+=" + "+this._indexMissing||this._prefetchNodes.length;if(this._featureEstimate.estimate){const b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}}updateElevationInfo(a,
b){this.needNodeElevationRange=b&&!!a&&("relative-to-ground"===a.mode||"on-the-ground"===a.mode);this._viewportQueries.updateElevationInfo(a);this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes(a=>{N(a);null!=a.node&&a.node.invalidateElevationRange();null!=a.ref&&a.ref.invalidateElevationRange()})}_forAllNodes(a){if(null!=this._clientNodePage){var b=this._clientNodePage;for(var c=0;c<b.nodes.length;c++)a(b.nodes[c],-(c+1))}for(const [d,e]of this._nodePages)for(b=d*
this._pageSize,c=0;c<e.nodes.length;c++)a(e.nodes[c],b+c)}clearCaches(){if(this._useNodePages){const a=this._nodePages,b=new Set;this.traverseVisible(c=>b.add(B(c,this._pageSize)));for(const [c,d]of a)if(0!==d.numNodesWithLoadedChildren||b.has(c))for(const e of d.nodes)e.traversalState=null;else this._deleteNodePage(c)}}_deleteNodePage(a){this._nodePages.delete(a)}get test(){return{addNode:(a,b)=>this._addNode(a,b),getNodeInternal:a=>this._getNodeInternal(a),getPageIndex:a=>B(a,this._pageSize),getIndexWithinPage:a=>
w(a,this._pageSize),getNodePage:a=>0>a?this._clientNodePage:this._nodePages.get(a),getChildIndices:a=>{const b=this._getNodeInternal(a);a=this._getPage(a);if(null==b||null==a)return[];const c=[];for(let d=b.childOffset;d<b.childOffset+b.childCount;++d)c.push(a.children[d]);return c},rootIndex:this._rootIndex,clientNodePage:this._clientNodePage,nodePages:this._nodePages}}}const u=new Map;class U{constructor(a){this.missing=a;this.update=new A({deallocator:null});this.add=new A({deallocator:null});
this.remove=new A({deallocator:null});this.cancel=[]}reset(a){this.add.clear();this.update.clear();this.cancel=a}}const R=[["maxScreenThreshold",q.LodMetric.MaxScreenThreshold],["screenSpaceRelative",q.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",q.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",q.LodMetric.DistanceRangeFromDefaultCamera]];class K{constructor(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0}}const V=y.create(),W=y.create(),
X=y.create(),Y=y.create();F.I3SIndex=T;F.selectErrorMetric=O;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});