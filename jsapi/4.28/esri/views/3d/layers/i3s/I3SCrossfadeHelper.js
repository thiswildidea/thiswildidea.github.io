// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/maybe","../../../../core/scheduling","../support/I3SLayerView"],function(k,l,m,h){class n{constructor(){this.lodCrossfadeSignedDuration=0}}class p{constructor(a){this._view=a;this._currentFrameStartTime=this._preRenderFrameTaskHandle=null;this._numFadingNodes=0}destroy(){this._preRenderFrameTaskHandle?.remove();this._view=this._preRenderFrameTaskHandle=null}get updating(){return 0<this._numFadingNodes}stopNodeFading(a){null!=a.lodCrossfadeProgress&&(this._numFadingNodes--,
a.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=l.removeMaybe(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(a,b,e){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=m.addFrameTask({preRender:d=>this._updateAllNodeFading(d)}),this._view.notifyLODUpdate());null==a.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate());a.lodCrossfadeSignedDuration=
e;a.lodCrossfadeProgress=b}_updateAllNodeFading(a){const b=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode((e,d)=>{if(null!=d?.lodCrossfadeProgress){const c=d.lodCrossfadeSignedDuration,f=d.lodCrossfadeProgress+Math.abs(a.deltaTime/c),g=!b||1<=f||0===c,q=(0<c?this._view.fullOpacity:0)-(g?0:0<c?1:-1)*(1-f);g?(this.stopNodeFading(d),0>c&&this._view.markNodeToRemove(e)):d.lodCrossfadeProgress=f;this._view.setNodeOpacityByIndex(e,q)}});this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode((a,
b)=>{null!=b?.lodCrossfadeProgress&&(this.stopNodeFading(b),b=b.lodCrossfadeSignedDuration,0>b&&this._view.markNodeToRemove(a),this._view.setNodeOpacityByIndex(a,0<b?this._view.fullOpacity:0))});this._view.removeMarkedNodes()}fadeNode(a,b,e,d){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());var c=this._view;const f=c.nodeCrossfadingEnabled,g=e===h.FadeDirection.FadeIn?c.fullOpacity:0;d=f?d?e===h.FadeDirection.FadeIn?c.lodCrossfadeinDuration:c.lodCrossfadeoutDuration:c.lodCrossfadeUncoveredDuration:
0;c=this._view.getNodeOpacityByIndex(a);f&&c!==g&&0<d?this._startNodeFading(b,1-Math.abs(g-c),(e===h.FadeDirection.FadeIn?1:-1)*d):(this.stopNodeFading(b),this._view.setNodeOpacityByIndex(a,g),e===h.FadeDirection.FadeOut&&this._view.removeNode(a))}isNodeFullyFadedIn(a){const b=this._view.getNodeCrossfadeMetaData(a);return null==b||null==b.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(a)===this._view.fullOpacity}}k.I3SCrossfadeHelper=p;k.NodeCrossfadeMetaData=n;Object.defineProperty(k,Symbol.toStringTag,
{value:"Module"})});