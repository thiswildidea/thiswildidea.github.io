// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/mathUtils ./enums ../../webgl-engine/core/material/RenderTexture ../../webgl-engine/core/shaderLibrary/util/AlphaCutoff ../../webgl-engine/core/shaderLibrary/util/EllipsoidMode ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Texture ../../webgl-engine/materials/pbrUtils ../../../webgl/enums".split(" "),function(p,D,x,d,t,y,E,g,F,q,w){function z(b){return b.sort((a,c)=>a.encoding-c.encoding)}function u(b,a,c){if(null==b||c===d.TextureUsage.None)return null;
for(let e=0;e<b.length;e++){const f=b[e];if(null!=f&&0!==(f.usage&c))return b=a[e],null!=b?b.id:null}return null}function G(b){switch(b){case d.TextureEncoding.KTX2:return g.TextureEncodingMimeType.KTX2_ENCODING;case d.TextureEncoding.Basis:return g.TextureEncodingMimeType.BASIS_ENCODING;case d.TextureEncoding.DDS_S3TC:return g.TextureEncodingMimeType.DDS_ENCODING;case d.TextureEncoding.PNG:return"image/png";case d.TextureEncoding.JPG:return"image/jpeg";case d.TextureEncoding.KTX_ETC2:return"image/ktx";
default:return""}}const H={ktx2:d.TextureEncoding.KTX2,basis:d.TextureEncoding.Basis,dds:d.TextureEncoding.DDS_S3TC,png:d.TextureEncoding.PNG,jpg:d.TextureEncoding.JPG,"ktx-etc2":d.TextureEncoding.KTX_ETC2},A={[g.TextureEncodingMimeType.KTX2_ENCODING]:d.TextureEncoding.Basis,[g.TextureEncodingMimeType.BASIS_ENCODING]:d.TextureEncoding.Basis,[g.TextureEncodingMimeType.DDS_ENCODING]:d.TextureEncoding.DDS_S3TC,"image/png":d.TextureEncoding.PNG,"image/jpg":d.TextureEncoding.JPG,"image/jpeg":d.TextureEncoding.JPG,
"image/ktx":d.TextureEncoding.KTX_ETC2},B=()=>({alphaMode:"opaque",alphaCutoff:y.defaultMaskAlphaCutoff,doubleSided:!0,cullFace:g.CullFaceOptions.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}),I={s:w.TextureWrapMode.CLAMP_TO_EDGE,t:w.TextureWrapMode.CLAMP_TO_EDGE},J={s:w.TextureWrapMode.REPEAT,
t:w.TextureWrapMode.REPEAT};p.configureMaterial=function(b,a,c,e,f,h){const l=h.rendererTextureUsage;var m=a.metallicRoughness.baseColorFactor,k=x.clamp(a.metallicRoughness.baseColorFactor[3],0,1);b.baseColor=[m[0],m[1],m[2],k];b.hasParametersFromSource=!!a.hasParametersFromSource;b.usePBR=h.usePBR;b.mrrFactors=[a.metallicRoughness.metallicFactor,a.metallicRoughness.roughnessFactor,a.hasParametersFromSource?q.defaultSchematicMRRFactors[2]:q.defaultAdvancedMRRFactors[2]];b.emissiveFactor=a.emissiveFactor;
b.isIntegratedMesh=h.isIntegratedMesh;b.textureAlphaCutoff="mask"===a.alphaMode?a.alphaCutoff:y.defaultMaskAlphaCutoff;b.alphaDiscardMode="opaque"===a.alphaMode?g.AlphaDiscardMode.Opaque:"mask"===a.alphaMode?g.AlphaDiscardMode.Mask:g.AlphaDiscardMode.MaskBlend;m=[];k=u(e,c,(d.TextureUsage.Color|d.TextureUsage.AlphaMask)&l);null!=k&&(b.baseColorTexture=new t.RenderTexture(f,k),m.push(b.baseColorTexture.loadPromise));k=u(e,c,d.TextureUsage.MetallicRoughness&l);null!=k&&(b.metallicRoughnessTexture=new t.RenderTexture(f,
k),m.push(b.metallicRoughnessTexture.loadPromise));k=u(e,c,d.TextureUsage.Emissive&l);null!=k&&(b.emissionTexture=new t.RenderTexture(f,k),m.push(b.emissionTexture.loadPromise));k=u(e,c,d.TextureUsage.Occlusion&l);null!=k&&(b.occlusionTexture=new t.RenderTexture(f,k),m.push(b.occlusionTexture.loadPromise));c=u(e,c,d.TextureUsage.Normal&l);null!=c&&(b.normalTexture=new t.RenderTexture(f,c),m.push(b.normalTexture.loadPromise));b.commonMaterialParameters.hasSlicePlane=h.slicePlaneEnabled;b.commonMaterialParameters.doubleSided=
a.doubleSided;b.commonMaterialParameters.cullFace=a.cullFace;b.ellipsoidMode=E.getEllipsoidMode(h.viewSpatialReference);return Promise.all(m)};p.createTexture=function(b,a,c,e){if(null==b?.data)return null;const f=b.data;e=e.renderingContext.parameters.maxMaxAnisotropy;const h=1<e;c=c||!a.wrapTextures?I:J;const l=G(b.encoding);return new F.Texture(f,{mipmap:h,maxAnisotropy:e,encoding:l,wrap:c,components:b.usage&d.TextureUsage.Color?"opaque"===a.alphaMode?3:4:3,noUnpackFlip:!0})};p.defaultMaterial=
B;p.getMaterialAndTextures=function(b,a){const c=new Map,e=(v,r)=>{if(null==v)return-1;var n=c.get(v.id);if(n)return n.usage|=r,n.id;n=c.size;c.set(v.id,{id:n,usage:r});return n};var f=a.pbrMetallicRoughness;const h=f?.baseColorFactor,l=a.emissiveFactor,m=q.useSchematicPBR({normalTexture:a.normalTexture,emissiveTexture:a.emissiveTexture,emissiveFactor:a.emissiveFactor,occlusionTexture:a.occlusionTexture,metallicRoughnessTexture:f?.metallicRoughnessTexture,metallicFactor:f?.metallicFactor,roughnessFactor:f?.roughnessFactor}),
k=m?q.defaultSchematicMRRFactors[0]:f?.metallicFactor??q.defaultAdvancedMRRFactors[0],K=m?q.defaultSchematicMRRFactors[1]:f?.roughnessFactor??q.defaultAdvancedMRRFactors[1];f={baseColorFactor:h?[h[0],h[1],h[2],h[3]]:[1,1,1,1],baseColorTextureId:e(f?.baseColorTexture,"mask"===a.alphaMode?d.TextureUsage.Color|d.TextureUsage.AlphaMask:d.TextureUsage.Color),metallicRoughnessTextureId:e(f?.metallicRoughnessTexture,d.TextureUsage.MetallicRoughness),metallicFactor:k,roughnessFactor:K};a={alphaMode:a.alphaMode,
alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,cullFace:"none"===a.cullFace?g.CullFaceOptions.None:"back"===a.cullFace?g.CullFaceOptions.Back:"front"===a.cullFace?g.CullFaceOptions.Front:g.CullFaceOptions.None,normalTextureId:e(a.normalTexture,d.TextureUsage.Normal),emissiveTextureId:e(a.emissiveTexture,d.TextureUsage.Emissive),occlusionTextureId:e(a.occlusionTexture,d.TextureUsage.Occlusion),emissiveFactor:l?[l[0],l[1],l[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:m};
const C=[];c.forEach(({usage:v},r)=>{var n=null!=b&&b[r]&&b[r].formats;n=n?z(n.map(({name:L,format:M})=>({name:L,encoding:H[M]}))):[];C.push({id:r,usage:v,encodings:n})});return{material:a,textures:C}};p.getMaterialAndTexturesFromShared=function(b){var a=b?.materialDefinitions?Object.keys(b.materialDefinitions)[0]:null,c=b?.textureDefinitions?Object.keys(b.textureDefinitions)[0]:null;a=a?b.materialDefinitions?.[a]:null;c=c?b.textureDefinitions?.[c]:null;b=B();if(null!=a){a=a.params;a.diffuse&&(b.metallicRoughness.baseColorFactor=
[a.diffuse[0],a.diffuse[1],a.diffuse[2],1]);null!=a.doubleSided&&(b.doubleSided=a.doubleSided,b.cullFace=a.doubleSided?g.CullFaceOptions.None:g.CullFaceOptions.Back);if("none"===a.cullFace||"front"===a.cullFace||"back"===a.cullFace)b.cullFace="none"===a.cullFace?g.CullFaceOptions.None:"back"===a.cullFace?g.CullFaceOptions.Back:g.CullFaceOptions.Front;a.transparency&&(b.metallicRoughness.baseColorFactor[3]=x.clamp(1-a.transparency,0,1));if(a.useVertexColorAlpha||1>b.metallicRoughness.baseColorFactor[3])b.alphaMode=
"blend"}a=[];if(null!=c){!c.wrap||"repeat"!==c.wrap[0]&&"repeat"!==c.wrap[1]||(b.wrapTextures=!0);let e=d.TextureUsage.Color;"rgba"===c.channels&&(b.alphaMode="blend",e|=d.TextureUsage.AlphaMask);const f=c.images[c.images.length-1];c=Array.isArray(c.encoding)?z(c.encoding.map((h,l)=>({name:f.href[l]?.split("/").pop(),encoding:A[h]||0}))):[{name:f.href?.split("/").pop(),encoding:A[c.encoding]||0}];a.push({id:0,usage:e,encodings:c});b.metallicRoughness.baseColorTextureId=0}return{material:b,textures:a}};
p.getSupportedEncodings=function(b){const a=!!b.compressedTextureS3TC;b=!!b.compressedTextureETC;const c=D("disable-feature:i3s-basis")?0:d.TextureEncoding.Basis|d.TextureEncoding.KTX2,e=c|d.TextureEncoding.DDS_S3TC;return d.TextureEncoding.JPG|d.TextureEncoding.PNG|(a?e:0)|(b?c:0)};p.selectEncoding=function(b,a){if(null!=a)return b.find(c=>0!==(c.encoding&a))};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});