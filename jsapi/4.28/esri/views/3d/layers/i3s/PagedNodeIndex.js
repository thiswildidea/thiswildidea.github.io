// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define(["../../../../geometry/support/aaBoundingBox","./I3SUtil","../../support/orientedBoundingBox"],function(q,u,r){class v{constructor(a,b,c){this._pages=[];this.pageSize=0;this._renderSR=this._nodeSR=null;this._nodeSR=a;this._renderSR=b;this.pageSize=c}addPage(a,b,c=0){for(;this._pages.length<a;)this._pages.push(null);var e=this._nodeSR,f=this._renderSR;for(var g=0;g<b.length;g++){var d=b[g];u.transformObb(d.obb,e,d.obbInRenderSR,f,c)}this._pages[a]={nodes:b,parents:new Uint32Array(this.pageSize)};
a=this._pages;b=this.pageSize;for(c=[0];c.length;)for(e=c.pop(),f=a[e/b|0].nodes[e%b],g=0;g<f.childCount;g++)d=f.firstChild+g,null!=a[d/b|0]&&(a[d/b|0].parents[d%b]=e,c.push(d))}hasPage(a){return!!this._pages[a]}getNode(a){const b=this.pageSize;return this._pages[a/b|0].nodes[a%b]}getRenderObb(a){const b=this.pageSize;return this._pages[a/b|0].nodes[a%b].obbInRenderSR}getRenderCenter(a){return this.getRenderObb(a).center}setRenderObb(a,b){const c=this.pageSize;r.set(b,this._pages[a/c|0].nodes[a%c].obbInRenderSR)}getParentId(a){const b=
this.pageSize;return this._pages[a/b|0].parents[a%b]}hasNodes(a,b){var c=a/this.pageSize|0;for(a=(a+b-1)/this.pageSize|0;c<=a;c++)if(null==this._pages[c])return!1;return!0}forEachNodeId(a){for(let b=0;b<this._pages.length;b++){const c=this._pages[b];if(c)for(let e=0;e<c.nodes.length;e++)a(b*this.pageSize+e)}}createVisibilityTraverse(){var a=this,b=[],c=[],e=q.create();return(f,g)=>{if(a.hasNodes(0,1))for(b.length=0,b.push(0),c.length=0,c.push(0);0<b.length;){var d=b.pop();let p=c.pop();var m=a.getNode(d),
n=a.getRenderObb(d),l=!0;if(null!=f.clippingBox){var k=1<<f.frustum.length;if(0===(p&k)){var h=r.toAaBoundingBox(n,e);q.contains(f.clippingBox,h)?p|=k:q.intersects(f.clippingBox,h)||(l=!1)}}for(k=0;k<f.frustum.length&&l;k++)if(h=1<<k,0===(p&h)){const t=r.intersectPlane(n,f.frustum[k]);0<t?l=!1:0>t&&(p|=h)}if(g.predicate(d,m,l)){n=m.firstChild;m=m.childCount;l=!1;h=n/a.pageSize|0;for(k=(n+m-1)/a.pageSize|0;h<=k;h++)if(!a.hasPage(h)){g.pageMiss(d,h);l=!0;break}if(!l)for(d=0;d<m;d++)b.push(n+d),c.push(p)}}}}}
return v});