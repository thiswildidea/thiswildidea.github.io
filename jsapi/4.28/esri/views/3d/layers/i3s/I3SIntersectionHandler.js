// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../ViewingMode ./I3SUtil ./Intersector ../../support/orientedBoundingBox ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/verticalOffsetUtils".split(" "),function(t,z,u,A,v,B,w,C){function D(a,e,c,f=0){f=a[3]+f;const d=e[0]-a[0],l=e[1]-a[1];a=e[2]-a[2];e=c[0];const g=c[1];c=c[2];const h=e*d+g*l+c*a;return 0<=h*h-(e*e+g*g+c*c)*(d*d+l*l+a*a-f*f)}class E{constructor(a){this.type=w.IntersectorType.I3S;this._needVerticalOffset=
!1;this.layerUid=a.layerUid;this.sublayerUid=a.sublayerUid;this._collection=a.collection;this._traverseNodeHierarchy=a.traverseNodeHierarchy;this.slicePlaneEnabled=a.slicePlaneEnabled;this.isGround=a.isGround}updateElevationAlignState(a,e){this._needVerticalOffset=a&&e===z.ViewingMode.Global}intersect(a,e,c,f){const d=a.results,l=a.options.store===w.StoreResults.ALL,g=a.ray.direction,h=a.tolerance;let x=b=>b,q=b=>b;const m=C.getVerticalOffsetI3S(null!=a.verticalOffset?a.verticalOffset:this._needVerticalOffset?
0:null);null!=a.verticalOffset&&null!=m&&(x=b=>m.applyToMbs(b),q=b=>m.applyToObb(b));this._traverseNodeHierarchy((b,y)=>{if(0===b.childrenLoaded)return!1;const r=null!=b.serviceObbInRenderSR&&u.isValidObb(b.serviceObbInRenderSR)?b.serviceObbInRenderSR:null;if(null!=r&&!v.intersectLine(q(r),c,g,h))return!1;!y||null==r&&u.isValidMbs(b.renderMbs)&&!D(x(b.renderMbs),c,g,h)||null!=b.geometryObb&&!v.intersectLine(q(b.geometryObb),c,g,h)||this._collection.intersect(y,c,f,h,m,(F,k,G,H)=>{if(0<=k&&(null==
e||e(c,f,k))){var p=n=>{const I=new A.I3sTarget(this.layerUid,this.sublayerUid,b.index,F,H);n.set(this.type,I,k,G)};this.isGround&&(null==d.ground.dist||k<d.ground.dist)&&p(d.ground);if(!a.options.isFiltered&&((null==d.min.dist||k<d.min.dist)&&p(d.min),(null==d.max.dist||k>d.max.dist)&&p(d.max),l)){const n=B.newIntersectorResult(a.ray);p(n);a.results.all.push(n)}}});return!0})}}t.I3SIntersectionHandler=E;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});