// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/Collection ../../../core/Logger ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./RenderContext ../webgl-engine/core/shaderLibrary/ShaderOutput ../webgl-engine/effects/RenderPlugin ../webgl-engine/lib/RenderSlot".split(" "),function(d,g,k,l,h,m,u,v,w,n,p,q,r,f){function c(a,b,e){if("function"===
typeof a[b]&&null!=e)a[b]?.(e)}d.StageRenderer=class extends r.SyncRenderPlugin{constructor(a){super(a);this.produces=new Map([[f.RenderSlot.OPAQUE_MATERIAL,()=>this.renderers.some(b=>"function"===typeof b.render)],[f.RenderSlot.TRANSPARENT_MATERIAL,()=>this.renderers.some(b=>"function"===typeof b.renderTransparent)]]);this.renderers=new k;this.context=null}initialize(){this.addHandles([h.watch(()=>this.view.ready,a=>{a?(this.context=new p(this.view),this.view._stage.addRenderPlugin(this)):(this.renderers.forEach(b=>
c(b,"dispose",this.context)),this.context=null)},h.initial)])}destroy(){this.renderers.drain(a=>{this.context&&c(a,"dispose",this.context)});this.view._stage?.removeRenderPlugin(this);this.context=null}add(a){this.renderers.includes(a)?l.getLogger("esri.views.3d.externalRenderers.ExternalRendererStore").warn("add(): Cannot add external renderer: renderer has already been added"):(this.renderers.add(a),this.context&&(this._webglStateReset(),c(a,"setup",this.context),this.view._stage.renderView.requestRender()))}remove(a){const b=
this.renderers.indexOf(a);-1!==b&&(this.renderers.removeAt(b),this.context&&(c(a,"dispose",this.context),this.view._stage.renderView.requestRender()))}initializeRenderContext(a){this.context.rctx=a.renderContext.rctx;0<this.renderers.length&&this._webglStateReset();this.renderers.forEach(b=>c(b,"setup",this.context))}uninitializeRenderContext(){}renderNode(a){if(0!==this.renderers.length&&a.output===q.ShaderOutput.Color){var b=e=>{this._updateContext(a);this._webglStateReset();this.renderers.forEach(t=>
c(t,e,this.context))};a.bindParameters.slot===f.RenderSlot.OPAQUE_MATERIAL?b("render"):b("renderTransparent")}}_updateContext(a){this.context.camera.copyFrom(a.bindParameters.camera);this.context.sunLight=a.bindParameters.lighting.legacy;this.context._renderTargetHelper=a.offscreenRenderingHelper}_webglStateReset(){this.context.rctx.resetState();this.context._renderTargetHelper?.bindFbo()}};g.__decorate([m.property({constructOnly:!0})],d.StageRenderer.prototype,"view",void 0);d.StageRenderer=g.__decorate([n.subclass("esri.views.3d.externalRenderers.StageRenderer")],
d.StageRenderer);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});