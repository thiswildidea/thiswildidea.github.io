// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../Color ../../../core/has ../../../core/maybe ../../../core/MemCachePool ../../../core/ObjectPool ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/buffer/BufferView ../../ViewingMode ./interfaces ./LayerClass ./OverlayContent ./OverlayRenderer ./PatchRenderData ./RenderOrder ./TerrainAttributesCache ./terrainUtils ./TileRenderer ./TileUpdate ./tileUtils ../webgl-engine/collections/Component/ComponentIntersectionData ../webgl-engine/core/shaderLibrary/ShaderOutput ../../../chunks/Terrain.glsl ../webgl-engine/core/shaderLibrary/terrain/TileBlendInput ../webgl-engine/effects/RenderPlugin ../webgl-engine/lib/Attribute ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/Material ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/VertexAttribute ../webgl-engine/lib/verticalOffsetUtils ../webgl-engine/materials/DrawParameters ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainTechnique ../webgl-engine/shaders/TerrainTechniqueConfiguration ../../webgl/enums".split(" "),
function(f,q,fa,ha,V,ia,ja,v,Ha,Ia,ka,la,J,w,ma,W,na,oa,N,pa,C,X,qa,Y,ra,sa,ta,K,O,Z,g,ua,L,P,va,Q,wa,xa,M,aa,x,ya,za,ba,ca,da,Aa,Ba,R){const S=W.create();f.TransparencyMode=void 0;(function(a){a[a.Opaque=0]="Opaque";a[a.Semitransparent=1]="Semitransparent";a[a.TransparentWithDraped=2]="TransparentWithDraped";a[a.Empty=3]="Empty"})(f.TransparencyMode||(f.TransparencyMode={}));f.TerrainRenderer=class extends P.SyncPrepareRenderPlugin{get _isGlobal(){return this._stage.viewingMode===oa.ViewingMode.Global}get _techniques(){return this._context.techniqueRepository}get _rctx(){return this._context.renderContext.rctx}constructor(a,
b,d,c,k){super({});this._overlayRenderer=a;this._stage=b;this._allTiles=d;this._ellipsoidRadius=c;this.type=M.IntersectorType.TERRAIN;this.isGround=!0;this._tileSize=256;this._techniqueConfiguration=new Ba.TerrainTechniqueConfiguration;this._passParameters=new ua.TerrainPassParameters;this._renderDataPool=new ja(qa.PatchRenderData);this._visiblePatchesByOrigin=new Map;this._allPatchesByOrigin=new Map;this._patchSortingDirty=this._patchesByOriginDirty=!0;this._tileIterator=new O.IteratorPreorder;this._transparencyState=
f.TransparencyMode.Opaque;this._castShadows=!1;this._tileRenderer=this._emptyTex=null;this._stencilEnabledLayerExtents=[];this._numOriginsRendered=this._numTilesCulled=this._numTilesRendered=0;this.renderOccludedFlags=aa.RenderOccludedFlag.Occlude;this.produces=new Map([[x.RenderSlot.OPAQUE_TERRAIN,()=>this._produces()],[x.RenderSlot.TRANSPARENT_TERRAIN,()=>this._produces()],[x.RenderSlot.OCCLUDED_TERRAIN,()=>this._produces()]]);this._tileTextureCache=new ia.MemCachePool((n,e)=>k.newCache(n,e),"TileTexture");
this.tileGeometryCache=new ra.TerrainAttributesCache(k)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this)}destroy(){this._stage.removeRenderPlugin(this);this._tileTextureCache.destroy();this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?P.ConsumesDepth:P.ConsumesNone}set renderingDisabled(a){this._set("renderingDisabled",!!a);this.setDirty()}set visible(a){this._set("visible",
!!a);this.setDirty()}set transparency(a){this._transparencyState!==a&&(this._techniqueConfiguration.invisible=a===f.TransparencyMode.TransparentWithDraped||a===f.TransparencyMode.Empty,this._transparencyState=a,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(a){this._techniqueConfiguration.tileBorders!==a&&(this._techniqueConfiguration.tileBorders=a,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(a){this._techniqueConfiguration.visualizeNormals!==
a&&(this._techniqueConfiguration.visualizeNormals=a,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(a){this._techniqueConfiguration.backfaceCullingEnabled!==a&&(this._techniqueConfiguration.backfaceCullingEnabled=a,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(a){this._set("renderOrder",a);this._setSortingDirty()}get layerUid(){return ba.terrainId}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(a){this._techniqueConfiguration.hasSlicePlane!==
a&&(this._techniqueConfiguration.hasSlicePlane=a,this.setNeedsRender())}set textureFadingEnabled(a){this._techniqueConfiguration.textureFadingEnabled!==a&&(this._techniqueConfiguration.textureFadingEnabled=a,this.setNeedsRender())}set pbrMode(a){this._techniqueConfiguration.pbrMode!==a&&(this._techniqueConfiguration.pbrMode=a,this.setNeedsRender())}setDebugScreenSizePerspective(a){this._techniqueConfiguration.screenSizePerspective!==a&&(this._techniqueConfiguration.screenSizePerspective=a,this.setNeedsRender())}setRootTiles(a){this._rootTiles=
a;this.setDirty()}setRenderOccludedOverlay(a){this.renderOccludedFlags=a?X.overlayRenderOccludedFlag:aa.RenderOccludedFlag.Occlude;this.setNeedsRender()}setStencilEnabledLayerExtents(a){this._stencilEnabledLayerExtents=a;this._setSortingDirty()}setTileSize(a){this._tileSize=a;null!=this._tileRenderer&&(this._tileRenderer.tileSize=a);this.setDirty()}_prepareTileForLoading(a){a.renderData||(a.renderData=this._renderDataPool.acquire(),a.renderData.init(a),a.renderData.localOrigin=this._getLocalOriginOfTile(a))}loadTile(a){this._prepareTileForLoading(a);
this.updateTileGeometryState(a);this.updateTileTexture(a,K.TileUpdate.TEXTURE_FADING)}updateTileTexture(a,b){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(a,b===K.TileUpdate.TEXTURE_FADING?N.TextureUpdate.FADING:N.TextureUpdate.UNFADED),this.setNeedsRender(),a.resetPendingUpdate(b))}updateTileGeometryState(a){for(const b of a.layerInfo[pa.LayerClass.ELEVATION])b.pendingUpdates&=~K.TileUpdate.GEOMETRY;a.resetPendingUpdate(K.TileUpdate.GEOMETRY);(a=a.renderData.updateGeometryState())&&
this.setDirty();return a}updateGeometryIfNeeded(a){a.isLoaded&&a.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(a){const b=a.renderData;b&&(b.releaseGeometry(),this._renderDataPool.release(b),b.clear(),a.renderData=null,a.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(a){const b=Math.max(0,7*Math.floor((a.level-3)/7));if(this._isGlobal&&0===b)return w.ZEROS;for(;a.parent&&a.level>b;)a=a.parent;return a.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,
numOriginsRendered:this._numOriginsRendered}}set wireframe(a){this._get("wireframe")!==a&&(this._set("wireframe",a),this.setNeedsRender())}setDirty(a=Q.RenderRequestType.UPDATE){this._patchesByOriginDirty=!0;this._context.requestRender(a)}_setSortingDirty(a=Q.RenderRequestType.UPDATE){this._patchSortingDirty=!0;this._context.requestRender(a)}setNeedsRender(a=Q.RenderRequestType.UPDATE){this._context.requestRender(a)}initializeRenderContext(a){this._context=a;this._tileRenderer=new ta.TileRenderer(this._rctx,
this._tileSize,this._techniques,this._tileTextureCache);this.updateTileBackground();this._emptyTex=wa.createEmptyTexture(this._rctx)}uninitializeRenderContext(){this._emptyTex=V.disposeMaybe(this._emptyTex);this._tileRenderer=V.disposeMaybe(this._tileRenderer)}intersect(a,b,d,c){if(!(!this._rootTiles||a.options.selectOpaqueTerrainOnly&&a.options.selectionMode&&this.transparency!==f.TransparencyMode.Opaque)){var k=Ca,n=Da;J.subtract(k,c,d);J.set(n,1/k[0],1/k[1],1/k[2]);var e=a.results.min,h=a.results.max,
r=a.results.ground,t=a.options.store===M.StoreResults.MIN,D=!!a.results.ground.target,p=ba.getVerticalOffsetTerrain(a.verticalOffset),B=a.tolerance,E,T=t&&null!=e.dist?e.dist:Infinity,Ga=y=>{var z=y.renderData;if(z?.vao){var l=z.geometry;W.set(S,l.boundingBox);var A=z.localOrigin;null!=p&&(p.localOrigin=A,p.applyToAabb(S));F[0]=d[0]-A[0];F[1]=d[1]-A[1];F[2]=d[2]-A[2];if(da.intersectAabbInvDirBefore(S,F,n,B,T)){var G=(m,u,Ea)=>{m.set(this.type,y,u,Ea,la.IDENTITY);T=t&&null!=e.dist?e.dist:Infinity};
z=(m,u)=>{null!=u&&0<=m&&(a.options.backfacesTerrain||0>J.dot(u,k))&&(a.options.invisibleTerrain||!a.options.selectionMode||null==b||b(d,c,m))&&((null==r.dist||m<r.dist)&&G(r,m,u),a.options.isFiltered||(a.options.store===M.StoreResults.ALL&&(null==E?(E=xa.newIntersectorResult(a.ray),G(E,m,u),a.results.all.push(E)):m<E.dist&&G(E,m,u)),(null==e.dist||m<e.dist)&&G(e,m,u),a.options.store!==M.StoreResults.MIN&&(null==h.dist||m>h.dist)&&G(h,m,u)))};var U=Fa;J.subtract(U,c,A);A=l.indices;var H=l.vertexAttributes,
I=H.getField(za.VertexAttribute.POSITION,na.BufferViewVec3f);H=new va.Vertices(I.typedBuffer,3,H.stride/4);l=l.indexCount/3;!p&&l>Z.componentMinimalSizeForIntersectionData?(I=y.renderData,null==I.intersectionData&&(I.intersectionData=new Z.ComponentIntersectionData(A,0,l,H)),I.intersectionData.intersectRay({r0:F,r1:U},z)):da.intersectTriangles(F,U,0,l,A,H,null,p,z)}}},ea=this._rootTiles;null!=ea&&(()=>{const y=this._tileIterator;y.reset(ea);const z=a.options.invisibleTerrain;for(let l=y.next();l;l=
y.next())!(l.visible||z&&l.intersectsClippingArea)||null==p&&!l.intersectsRay(d,k,B,T)||D&&this._useStencilForTile(l)?y.skipSubtree():Ga(l)})()}}processScaleRangeQueries(a,b){if(!b.done)for(this._updatePatchGroups();a.updating&&!b.done;){a.prepare();for(const d of this._visiblePatchesByOrigin.values())for(const c of d)null!=c.renderData?.textureReference&&a.queriesForTile(c);a.process();b.madeProgress()}}prepareTechnique(a){const b=ha("enable-feature:terrain-shadows")&&a.bindParameters.shadowMap.enabled;
b!==this._castShadows&&(this._castShadows=b,this._patchesByOriginDirty=!0);if(a.bindParameters.slot===x.RenderSlot.OCCLUDED_TERRAIN){if(0===(a.renderOccludedMask&X.overlayRenderOccludedFlag))return null}else if(a.bindParameters.slot!==(this.transparency===f.TransparencyMode.Opaque?x.RenderSlot.OPAQUE_TERRAIN:x.RenderSlot.TRANSPARENT_TERRAIN))return null;if(this.transparency===f.TransparencyMode.Empty)return null;switch(a.output){case g.ShaderOutput.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=
null!=a.bindParameters.ssr.lastFrameColor,this._techniqueConfiguration.hasCloudsReflections=null!=a.bindParameters.cloudsFade.data,this._techniqueConfiguration.receiveShadows=a.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=null!=a.bindParameters.ssao,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(g.ShaderOutput.Color,a.bindParameters.slot===x.RenderSlot.OCCLUDED_TERRAIN);case g.ShaderOutput.Shadow:case g.ShaderOutput.ShadowExcludeHighlight:if(this._castShadows)return this._techniqueConfiguration.receiveShadows=
this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.Shadow,!1);break;case g.ShaderOutput.Depth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.Depth,!1);case g.ShaderOutput.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.Normal,!1);case g.ShaderOutput.ObjectAndLayerIdColor:return this._updateTechnique(g.ShaderOutput.ObjectAndLayerIdColor,
!1);case g.ShaderOutput.Highlight:if(this._overlayRenderer.hasHighlights)return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.Highlight,!1)}return null}renderNode(a,b){this._updatePatchGroups();b.useStencil=!1;switch(a.output){case g.ShaderOutput.Color:this._renderMaterialPass(a,b,a.bindParameters.slot===x.RenderSlot.OCCLUDED_TERRAIN?C.OverlayContent.Occluded:C.OverlayContent.Color);break;case g.ShaderOutput.Depth:case g.ShaderOutput.Normal:this._renderAuxiliaryPass(a,
b,C.OverlayContent.Color,this._visiblePatchesByOrigin);break;case g.ShaderOutput.Highlight:this._renderAuxiliaryPass(a,b,C.OverlayContent.Highlight,this._visiblePatchesByOrigin);break;case g.ShaderOutput.Shadow:case g.ShaderOutput.ShadowExcludeHighlight:this._renderAuxiliaryPass(a,b,null,this._allPatchesByOrigin);break;case g.ShaderOutput.ObjectAndLayerIdColor:this._renderAuxiliaryPass(a,b,C.OverlayContent.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(a){if(null!=this._tileRenderer){var b=
this._tileRenderer;if(null!=a){a=fa.toUnitRGBA(a);var d=w.fromValues(a[0]||0,a[1]||0,a[2]||0)}b.setBackground(d);this._allTiles.forAll(c=>b.updateTileTexture(c,N.TextureUpdate.FADING));this._techniqueConfiguration.tileBlendInput=b.backgroundIsGrid?L.TileBlendInput.GridComposite:null!=b.backgroundColor?L.TileBlendInput.ColorComposite:L.TileBlendInput.LayerOnly;this.setNeedsRender()}}_updatePatchGroups(){this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=
!0);if(this._patchSortingDirty&&this.renderOrder!==Y.RenderOrder.NONE){const a=Array.from(this._visiblePatchesByOrigin.values()),b=this._stencilEnabledLayerExtents;for(const d of a)O.sortTiles(this.renderOrder,d,b);a.sort((d,c)=>O.compareTiles(d[0],c[0],this.renderOrder));this._visiblePatchesByOrigin=new Map(a.map(d=>[d[0].renderData.localOrigin,d]));this._patchSortingDirty=!1}}_rebuildPatchGroups(){const a=this._rootTiles;if(null!=a){a[0]?.surface.checkAllTilesWaterproofness();this._visiblePatchesByOrigin.clear();
this._allPatchesByOrigin.clear();for(const b of a)this._rebuildPatchGroupsForRootTile(b)}}_rebuildPatchGroupsForRootTile(a){const b=this._tileIterator;for(b.resetOne(a);!b.done;){a=b.next();var d=a.renderData;if(d){d=d.localOrigin;if(this._castShadows){var c=this._allPatchesByOrigin.get(d);c||(c=[],this._allPatchesByOrigin.set(d,c));c.push(a)}a.visible?(c=this._visiblePatchesByOrigin.get(d),c||(c=[],this._visiblePatchesByOrigin.set(d,c)),c.push(a),b.skipSubtree()):(this._numTilesCulled++,b.skipSubtree())}else this._numTilesCulled++}}_useStencilForTile(a){for(const b of this._stencilEnabledLayerExtents)if(a.intersectsExtent(b))return!0;
return!1}_renderAuxiliaryPass(a,b,d,c){const k=a.rctx;this._passParameters.overlayContent=d;k.bindTechnique(b,this._passParameters,a.bindParameters);const n=0<this._stencilEnabledLayerExtents.length;c.forEach(e=>{b.program.bindDraw(new ca.DrawParameters(e[0].renderData.localOrigin),a.bindParameters,this._passParameters);for(let h=0;h<e.length;h++)this._renderPatch(a,b,e[h],R.PrimitiveType.TRIANGLES,n,d)});a.rctx.bindVAO(null)}_renderMaterialPass(a,b,d){var {rctx:c}=a;this._passParameters.overlayContent=
d;c.bindTechnique(b,this._passParameters,a.bindParameters);this._numOriginsRendered=this._numTilesCulled=this._numTilesRendered=0;var k=a.bindParameters.camera;c=b.program;this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest&&ya.getSettings(this._stage.viewingMode,this._ellipsoidRadius).update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:k.fovY});k=0<this._stencilEnabledLayerExtents.length;const n=d===C.OverlayContent.Occluded;n&&(c.bindTexture("tex",
this._emptyTex),c.setUniform3fv("textureOpacities",w.ZEROS),c.setUniform4fv("texOffsetAndScale",ma.ZEROS));var e=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:w.ZEROS;this._techniqueConfiguration.tileBlendInput===L.TileBlendInput.ColorComposite&&c.setUniform3fv("backgroundColor",e);e=this.wireframe?R.PrimitiveType.LINES:R.PrimitiveType.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&c.bindTexture("texNext",this._emptyTex);var h=this._visiblePatchesByOrigin;
for(const r of h.values()){b.program.bindDraw(new ca.DrawParameters(r[0].renderData.localOrigin),a.bindParameters,this._passParameters);this._numOriginsRendered++;for(const t of r){h=t.renderData;const D=h.textureReference;if(null!=D){if(!n){c.setUniform4fv("texOffsetAndScale",D.offsetAndScale);c.bindTexture("tex",D.texture.texture);const p=h.textureFadeFactor,B=1>p?h.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&null!=B&&1>p?(c.setUniform1f("fadeFactor",p),c.setUniform4fv("nextTexOffsetAndScale",
B.offsetAndScale),c.setUniform3fv("nextTexOpacities",B.opacities),c.bindTexture("texNext",B.texture.texture)):c.setUniform1f("fadeFactor",1);h.textureIsFading&&this.setNeedsRender();c.setUniform3fv("textureOpacities",D.opacities)}this._renderPatch(a,b,t,e,k,d);t.renderOrder=this._numTilesRendered;this._numTilesRendered++}}}a.rctx.bindVAO(null)}_renderPatch(a,b,d,c,k,n){const e=d.renderData,h=e.vao,r=h?.indexBuffer;if(null==r)sa.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",
d.lij," : ",e);else{var t=b.program;null==n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(t,e.overlay);k&&(b.useStencil=this._useStencilForTile(d),a.rctx.setPipelineState(b.getPipeline()));b=e.geometry.indexCount;a.rctx.bindVAO(h);t.assertCompatibleVertexAttributeLocations(h);a.rctx.drawElements(c,b,r.indexType,0)}}_bindOverlayPatchData(a,b){a.setUniform4fv("overlayTexOffset",b.offsets);a.setUniform4fv("overlayTexScale",b.scales)}_updateTechnique(a,b){this._techniqueConfiguration.output=
a;this._techniqueConfiguration.renderOccluded=b;return this._shaderTechnique=this._techniques.releaseAndAcquire(Aa.TerrainTechnique,this._techniqueConfiguration,this._shaderTechnique)}get test(){return{tileRenderer:this._tileRenderer}}};q.__decorate([v.property({readOnly:!0})],f.TerrainRenderer.prototype,"_isGlobal",null);q.__decorate([v.property({value:!1})],f.TerrainRenderer.prototype,"renderingDisabled",null);q.__decorate([v.property({value:!0})],f.TerrainRenderer.prototype,"visible",null);q.__decorate([v.property()],
f.TerrainRenderer.prototype,"renderPatchBorders",null);q.__decorate([v.property()],f.TerrainRenderer.prototype,"visualizeNormals",null);q.__decorate([v.property()],f.TerrainRenderer.prototype,"cullBackFaces",null);q.__decorate([v.property({value:Y.RenderOrder.FRONT_TO_BACK})],f.TerrainRenderer.prototype,"renderOrder",null);q.__decorate([v.property()],f.TerrainRenderer.prototype,"wireframe",null);f.TerrainRenderer=q.__decorate([ka.subclass("esri.views.3d.terrain.TerrainRenderer")],f.TerrainRenderer);
const Ca=w.create(),Da=w.create(),F=w.create(),Fa=w.create();Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});