// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/support/UpdatingHandles ../../../../../layers/graphics/dehydratedPoint ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../../SnappingVisualizer3D ../geometryUtils ../isSupportedGraphicUtils ../manipulatorUtils ../meshFastUpdateUtils ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ./isSupportedGraphic ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchTooltipOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TranslateTooltipInfos ../../../../support/automaticLengthMeasurementUtils ../../../../support/euclideanLengthMeasurementUtils".split(" "),
function(l,q,H,I,J,u,v,w,r,ha,ia,ja,K,L,M,x,N,O,P,Q,R,S,T,U,m,V,W,X,B,Y,C,Z,aa,D,ba,ca,da,y,E,ea){class F{constructor(a){this.allGraphics=a;this.type="graphic-move-start"}}class G{constructor(a,b,c){this.dx=a;this.dy=b;this.allGraphics=c;this.type="graphic-move"}}class A{constructor(a){this.allGraphics=a;this.type="graphic-move-stop"}}l.GraphicMoveTool=class extends I.EventedMixin(Z.InteractiveToolBase){constructor(a){super(a);this._infos=new Map;this.graphics=new H;this.enableZ=!0;this.tooltipOptions=
new D;this.type="move-3d";this._updatingHandles=new L.UpdatingHandles;this._translateGraphicZTooltipInfo=this._translateGraphicXYTooltipInfo=this._translateGraphicTooltipInfo=this._tooltip=this._moveManipulation=null}initialize(){const {view:a}=this;this.addHandles([this.graphics.on("change",c=>{c.removed.forEach(e=>this.removeHandles(e));this._updateGraphicInfos(c);this._setupFastTransformUpdates(c.added);this._refreshManipulators()}),w.watch(()=>this.tooltipOptions.enabled,c=>{this._tooltip=c?new da.Tooltip({view:a}):
u.destroyMaybe(this._tooltip)},w.syncAndInitial)]);const b=this.graphics.toArray();this._updateGraphicInfos({added:b,removed:[]});this._setupFastTransformUpdates(b);this._refreshManipulators();this.finishToolCreation()}destroy(){this._tooltip=u.destroyMaybe(this._tooltip);this._moveManipulation=u.destroyMaybe(this._moveManipulation);this._set("view",null);this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:a,removed:b}){for(const c of a){if(X.isSupportedGraphic(c)!==
Q.SupportedGraphicResult.SUPPORTED)continue;a=new fa(c);const e=this.view.trackGraphicState(a.state);this._infos.set(a.graphic,{info:a,handle:e})}for(const c of b)this._infos.get(c)?.handle.remove(),this._infos.delete(c)}_setupFastTransformUpdates(a){for(const b of a)({info:a}=this._infos.get(b)),this.addHandles(S.meshTransformFastUpdateHandles(a.state),b)}_refreshManipulators(){this.removeHandles("manipulators");this._moveManipulation=u.destroyMaybe(this._moveManipulation);this.manipulators.removeAll();
if(0!==this._infos.size){var a=Array.from(this._infos.values(),({info:b})=>b);this._createManipulators(a);this._createVisualElements(a);this._updateMoveManipulation(a)}}_createManipulators(a){for(const b of a){const c=b.state;b.manipulationXY=new W.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:c});b.manipulationXY.forEachManipulator(e=>this.addHandles([e.events.on("immediate-click",d=>{this.emit("immediate-click",{...d,graphic:c.graphic});d.stopPropagation()}),e.events.on("grab-changed",
({action:d})=>{const {tooltipOptions:f,_tooltip:g}=this;null!=g&&("start"===d?(this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new y.TranslateGraphicTooltipInfo({tooltipOptions:f})),g.info=this._translateGraphicTooltipInfo,g.info.tooltipOptions=f,g.info.distance=v.zeroMeters):g.clear())})],"manipulators"));this.addHandles(b.manipulationXY.createDragPipeline((e,d,f,g)=>this._buildDragEventPipeline(a,m.ManipulationType.XY,e,d,f,g)),"manipulators")}this._createMoveManipulation(a)}_createMoveManipulation(a){const b=
new m.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?m.MoveManipulation.radiusForSymbol(a[0].graphic.symbol):U.discRadius});this._moveManipulation=b;b.elevationInfo={mode:"absolute-height",offset:0};b.forEachManipulator(d=>{this.addHandles(d.events.on("immediate-click",f=>{b.zManipulation.hasManipulator(d)||1!==this.graphics.length||this.emit("immediate-click",{...f,graphic:this.graphics.at(0)});f.stopPropagation()}),"manipulators")});
var c=d=>f=>{this.addHandles(f.events.on("focus-changed",({action:g})=>{const k=this._tooltip;null!=k&&("focus"===g?this._updateMoveTooltip(a,d):k.clear())}),"manipulators")};this._moveManipulation.xyManipulation.forEachManipulator(c(m.ManipulationType.XY));this._moveManipulation.xyAxisManipulation.forEachManipulator(c(m.ManipulationType.XY_AXIS));this._moveManipulation.zManipulation.forEachManipulator(c(m.ManipulationType.Z));c=()=>this._updateMoveManipulation(a);for(const d of a)this.addHandles([d.state.on("changed",
c),w.watch(()=>d.state.displaying,c)],"manipulators");const e=a[a.length-1];this.addHandles(e.state.on("changed",()=>this._updateMoveManipulationAngle(e)),"manipulators");this.addHandles(b.createDragPipeline((d,f,g,k,n)=>this._buildDragEventPipeline(a,d,f,g,k,n),x.getGraphicEffectiveElevationInfo(e.graphic),e.graphic.geometry.spatialReference,e.graphic),"manipulators");this._updateMoveManipulationAngle(e)}_createVisualElements(a){for(const b of a){const c=T.createVisualElements({view:this.view,graphic:b.graphic,
forEachManipulator:e=>{b.manipulationXY?.forEachManipulator(e);this._moveManipulation?.forEachManipulator(e)},onManipulatorsChanged:()=>J.makeHandle()});null!=c&&(b.geometryRepresentation=c.visualElement,b.geometryRepresentation instanceof B.OutlineVisualElement&&this.addHandles([b.geometryRepresentation.events.on("attachment-origin-changed",()=>{b.state.isDraped||this._updateMoveManipulation(a)}),w.watch(()=>b.state.isDraped,()=>this._updateMoveManipulation(a))],"manipulators"),this.addHandles(c,
"manipulators"))}}_updateMoveManipulationAngle(a){this._moveManipulation&&(this._moveManipulation.angle=P.orientation(a.graphic.geometry))}_updateMoveManipulation(a){const b=M.makeDehydratedPoint(0,0,0,this.view.spatialReference);let c=0,e=!1;const d=this._moveManipulation;if(d){for(const f of a)if(f.state.displaying&&(a=f.state.graphic,this.enableZ&&R.canMoveZ(a)&&(e=!0),a=f.geometryRepresentation instanceof B.OutlineVisualElement&&!f.state.isDraped?f.geometryRepresentation.attachmentOrigin:N.getGraphicAttachmentOrigin(this.view,
a),null!=a)){const {x:g,y:k,z:n}=a;b.x+=g;b.y+=k;n&&(b.z??(b.z=0),b.z+=n);c++}0<c?(b.x/=c,b.y/=c,b.z??(b.z=0),b.z/=c,d.location=b,d.xyManipulation.available=!0,d.xyAxisManipulation.available=!0,d.zManipulation.available=e):d.available=!1}}_buildDragEventPipeline(a,b,c,e,d,f){const g=[],k=[];let n=null,t=null;const z=()=>{for(const h of g)h.dragging=!1;g.length=0;k.length=0;t=n=null;this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===a.length&&b===m.ManipulationType.XY){const h=
a[0].graphic;({steps:e,cancel:d}=this._buildSnappingPipelineSteps(h,x.getGraphicEffectiveElevationInfo(h),e,d,f))}d=d.next(h=>t?.(h)).next(()=>{this.emit("graphic-move-stop",new A(k));this.destroyed||z();return null});e=e.next(h=>{if("start"===h.action){g.length=0;k.length=0;for(const p of a)p.dragging||!p.manipulationXY?.hasManipulator(c)&&p.manipulationXY?.grabbing||(g.push(p),k.push(p.graphic),p.dragging=!0);if(0!==k.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),n=C.dragGraphicMany(k,
this.view.state.viewingMode),t=C.resetGraphicMany(k),this.emit("graphic-move-start",new F(k)),this.destroyed))return null}return 0!==k.length?h:null}).next(h=>n?.(h)).next(h=>{this._updateMoveTooltip(a,b,h);return h}).next(h=>{switch(h.action){case "start":case "update":if(h.translationX||h.translationY||h.translationZ){const p=this.view.toScreen(h.mapStart);h=this.view.toScreen(h.mapEnd);this.emit("graphic-move",new G(h.x-p.x,h.y-p.y,k))}break;case "end":this.emit("graphic-move-stop",new A(k)),this.destroyed||
z()}return null});return{steps:e,cancel:d}}_updateMoveTooltip(a,b,c){const {tooltipOptions:e,_tooltip:d}=this;if(null!=d){d.clear();var f=0===a.length?"absolute-height":a[0].state.isDraped?"on-the-ground":"absolute-height";switch(b){case m.ManipulationType.XY:d.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new y.TranslateGraphicTooltipInfo({tooltipOptions:e}));this._updateMoveTooltipDistance(d.info,c,(g,k)=>E.autoHorizontalDistanceByElevationModeBetweenPoints(g,k,f));
break;case m.ManipulationType.XY_AXIS:d.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new y.TranslateGraphicXYTooltipInfo({tooltipOptions:e}));this._updateMoveTooltipDistance(d.info,c,(g,k)=>{g=E.autoHorizontalDistanceByElevationModeBetweenPoints(g,k,f);return v.scale(g,V.axisConstrainedDragSign(c))});break;case m.ManipulationType.Z:d.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new y.TranslateGraphicZTooltipInfo({tooltipOptions:e})),
this._updateMoveTooltipDistance(d.info,c,ea.verticalSignedDistanceBetweenPoints)}d.info.tooltipOptions=e}}_updateMoveTooltipDistance(a,b,c){if(null!=b&&"end"!==b.action){const {mapStart:e,mapEnd:d}=b;b=c(e,d);a.distance=null!=b?b:v.zeroMeters}else a.distance=v.zeroMeters}_buildSnappingPipelineSteps(a,b,c,e,d){const f=a.geometry;if(null==f||"point"!==f.type&&"mesh"!==f.type)return{steps:c,cancel:e};const g=("point"===f.type?f:f.anchor).clone(),k=new ba.SnappingContext({elevationInfo:b,pointer:d,editGeometryOperations:aa.EditGeometryOperations.fromGeometry(g,
this.view.state.viewingMode),visualizer:new O.SnappingVisualizer3D,excludeFeature:a}),{snappingStep:n,cancelSnapping:t}=ca.createSnapDragEventPipelineStep({snappingContext:k,snappingManager:this.snappingManager,updatingHandles:this._updatingHandles});e=e.next(t);c=c.next(z=>{g.z=x.getConvertedElevation(this.view,g,x.getGraphicEffectiveElevationInfo(a),{mode:"absolute-height",offset:0});const h=k.coordinateHelper.pointToVector(g);return{...z,snapOrigin:h}}).next(...n);return{steps:c,cancel:e}}get test(){return{tooltip:this._tooltip}}};
q.__decorate([r.property({constructOnly:!0,nonNullable:!0})],l.GraphicMoveTool.prototype,"view",void 0);q.__decorate([r.property()],l.GraphicMoveTool.prototype,"graphics",void 0);q.__decorate([r.property({constructOnly:!0,nonNullable:!0})],l.GraphicMoveTool.prototype,"enableZ",void 0);q.__decorate([r.property({constructOnly:!0,type:D})],l.GraphicMoveTool.prototype,"tooltipOptions",void 0);q.__decorate([r.property({constructOnly:!0})],l.GraphicMoveTool.prototype,"snappingManager",void 0);q.__decorate([r.property()],
l.GraphicMoveTool.prototype,"type",void 0);q.__decorate([r.property()],l.GraphicMoveTool.prototype,"updating",null);l.GraphicMoveTool=q.__decorate([K.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],l.GraphicMoveTool);class fa{constructor(a){this.manipulationXY=this.geometryRepresentation=null;this.dragging=!1;this.state=new Y.GraphicState({graphic:a})}get graphic(){return this.state.graphic}}l.GraphicMoveEvent=G;l.GraphicMoveStartEvent=F;l.GraphicMoveStopEvent=A;
Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});