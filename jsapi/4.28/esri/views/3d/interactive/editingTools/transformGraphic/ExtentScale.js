// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/vec2 ../../../../../chunks/vec2f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/boundedPlane ../../../../../geometry/support/plane ../../../../../geometry/support/vectorStacks ../../../analysis/Slice/ResizeManipulator ../../../analysis/Slice/sliceToolUtils ../dragEventPipeline3D ../ManipulatorType ./extentUtils ../../../support/geometryUtils/ray ../../../../interactive/dragEventPipeline ../../../../interactive/editGeometry/interfaces ../../../../interactive/editGeometry/operations/UpdateVertices ../../../../interactive/editGeometry/support/editPlaneUtils ../../../../interactive/tooltip/ExtentTooltipInfos".split(" "),
function(v,m,w,h,C,x,D,q,E,r,F,G,A,H,I,B,J,K,L){class M{get zMax(){if(!this._zMaxDirty)return this._zMax;var a=this._editGeometryOperations.data;if(a.geometry.hasZ){const b=a.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const c of a.components)for(const d of c.vertices)a=b.getZ(d.pos)??0,this._zMax=Math.max(a,this._zMax)}else this._zMax=0;this._zMaxDirty=!1;return this._zMax}constructor(a,b,c,d,k){this._tool=a;this._graphicState=b;this._editGeometryOperations=c;this._bounds=d;this._preserveAspectRatioStep=
k;this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}];this._scaleTooltipInfo=null;this._displayBoundsStart=x.create();this._displayBoundsMarginStart=0;this._startScale=w.create();this._endScale=w.create();this._sizeStart=null;this._zMax=0;this._zMaxDirty=!0;const g=this._tool,f=g.view;this.resizeManipulators=this._resizeHandles.map(e=>{const l=new E.ResizeManipulator(f,e);g.addHandles([l.events.on("grab-changed",
y=>this._onResizeGrab(y)),this._createResizeDragPipeline(l,e)]);return l});g.manipulators.addMany(this.resizeManipulators);g.addHandles([g.on("graphic-scale-start",e=>{m.set(this._startScale,e.xScale,e.yScale);m.set(this._endScale,e.xScale,e.yScale)}),g.on("graphic-scale",e=>{m.set(this._endScale,e.xScale,e.yScale)}),g.on("graphic-scale-stop",()=>{m.set(this._startScale,0,0);m.set(this._endScale,0,0)}),this._graphicState.on("changed",()=>{"resize"!==g.inputState?.type&&(this._zMaxDirty=!0)})])}destroy(){this.forEachManipulator(a=>
{this._tool.manipulators.remove(a);a.destroy()})}forEachManipulator(a){this.resizeManipulators.forEach(b=>a(b,G.ManipulatorType.SCALE))}updateManipulators(a,b){this.resizeManipulators.forEach((c,d)=>{r.updateResizeHandle(c,this._resizeHandles[d],a,b)})}getUpdatedTooltipInfo(){return this.resizeManipulators.some(a=>a.focused)?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){var a=this._tool,b=a.tooltipOptions;b=this._scaleTooltipInfo??(this._scaleTooltipInfo=new L.ExtentScaleTooltipInfo({tooltipOptions:b}));
a=a.graphic.geometry;if(null==a)return null;a=A.mapPlaneAutoHorizontalSizeByElevationMode(this._bounds.mapBounds,this.zMax,a.spatialReference,this._graphicState.isDraped);if(null==a)return null;b.xSize=a[0];b.ySize=a[1];null!=this._sizeStart&&this.resizeManipulators.some(c=>c.dragging)?(b.xScale=a[0].value/this._sizeStart[0].value,b.yScale=a[1].value/this._sizeStart[1].value):(b.xScale=1,b.yScale=1);return b}_onResizeGrab({action:a,screenPoint:b}){const c=this._tool,d=this._bounds;"start"===a&&b&&
c.graphic.geometry&&(a=H.fromScreenNormalized(c.view.state.camera,b),D.intersectRay(d.displayBounds.plane,a,q.sv3d.get())&&(d.backupMapBounds(),x.copy(d.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=d.displayBoundsMargin,this._sizeStart=A.mapPlaneAutoHorizontalSizeByElevationMode(d.mapBoundsStart,this.zMax,c.graphic.geometry.spatialReference,this._graphicState.isDraped),c.inputState={type:"resize"}))}_createResizeDragPipeline(a,b){const c=this._tool,d=c.graphic;return I.createManipulatorDragEventPipeline(a,
(k,g,f)=>{null!=c.inputState&&(g.next(e=>{"start"===e.action&&c.emit("graphic-scale-start",{graphic:d,xScale:1,yScale:1});return e}).next(F.screenToRenderPlane(c.view,this._displayBoundsStart.plane)).next(e=>({...e,handle:b})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next(e=>{const l={graphic:d,xScale:e.factor1,yScale:e.factor2};switch(e.action){case "start":case "update":c.emit("graphic-scale",l);break;case "end":c.inputState=
null,c.emit("graphic-scale-stop",l)}return e}),f.next(()=>{null!=c.inputState&&c.emit("graphic-scale-stop",{graphic:d,xScale:1,yScale:1});c.cancel()}))})}_resizeDragRenderPlaneToFactors(){const a=this._bounds;return b=>{const c=this._displayBoundsStart,d=b.handle.direction,k=a.displayBoundsMargin,g=this._displayBoundsMarginStart;var f=h.copy(q.sv3d.get(),c.origin);h.scaleAndAdd(f,f,c.basis1,-d[0]);h.scaleAndAdd(f,f,c.basis2,-d[1]);const e=h.subtract(q.sv3d.get(),b.renderEnd,f),l=h.subtract(q.sv3d.get(),
b.renderStart,f),y=r.isDiagonalResizeHandle(b.handle);f=r.calculateDiagonalResizeHandleScale(c);const N=r.calculateDiagonalResizeHandleScale(a.displayBounds)/f;f=(n,z)=>{if(0===n)return 1;let p=h.length(z),t=.5*n*h.dot(z,e)/p;const u=0>t?-1:1;y&&(n=p-.5*n*h.dot(z,l)/p,t+=n*u*N);n=p<1.5*g?1:1E-6;p=Math.max(p-g,1E-6);0<u&&(t-=k);return u*Math.max(t/p*u,n)};return{...b,factor1:f(d[0],c.basis1),factor2:f(d[1],c.basis2)}}}_resizeDragUpdateGeometry(){const a=this._tool,b=this._bounds;return c=>{var d=h.copy(C.create(),
b.mapBoundsStart.origin);h.scaleAndAdd(d,d,b.mapBoundsStart.basis1,-c.handle.direction[0]);h.scaleAndAdd(d,d,b.mapBoundsStart.basis2,-c.handle.direction[1]);const k=m.set(w.create(),b.mapBoundsStart.basis1[0],b.mapBoundsStart.basis1[1]);m.normalize(k,k);const g=[];for(const f of this._editGeometryOperations.data.components)g.push(...f.vertices);d=this._editGeometryOperations.scaleVertices(g,d,k,c.factor1,c.factor2,"start"===c.action?B.AccumulationBehaviour.NEW_STEP:B.AccumulationBehaviour.ACCUMULATE_STEPS,
J.AccumulationType.REPLACE);x.copy(b.mapBoundsStart,b.mapBounds);K.apply(d,b.mapBounds);a.graphic.geometry=this._editGeometryOperations.data.geometry;return c}}}v.ExtentScale=M;v.scaleEpsilon=1E-6;Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});