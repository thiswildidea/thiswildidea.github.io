// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/PooledArray ../../../../core/screenUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/ray ../../../../geometry/support/vectorStacks ../../../ViewingMode ../../support/geometryUtils/ray ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtils".split(" "),function(A,H,w,x,I,t,J,r,K,C,v,n,B){function D(a){y&&y.viewingMode===a||
(y=v.newIntersector(a));return y}class L{constructor(a,b,c){this.viewingMode=a;this._forEachLayer=b;this._view=c;this._externalIntersectionHandlers=new H;this._tolerance=v.defaultTolerance;this._tmpRay=J.create();this._tmpRegion=t.create();this._validateHUDIntersector=v.newIntersector(this.viewingMode);this._validateHUDIntersector.options.hud=!1}intersectScreen(a,b,c){return this.intersectRay(this._getPickRay(a,this._tmpRay),D(this.viewingMode),b,c)}intersectScreenFreePointFallback(a,b,c){return this.intersectRayFreePointFallback(this._getPickRay(a,
this._tmpRay),b,c)}intersectRayFreePointFallback(a,b,c){return this.intersectRay(a,D(this.viewingMode),b,c)||this._intersectRayFreePointLocal(a,b)}intersectRay(a,b,c,f){b.options.selectionMode=!1;b.options.store=n.StoreResults.MIN;this.computeIntersection(a,b,f);return b.results.min?b.results.min.getIntersectionPoint(c):!1}getCenterRayWithSubpixelOffset(a,b,c=.5,f=.5){a.getRenderCenter(u,c,f);u[0]+=.0466;u[1]-=.0123;return C.fromRenderAtEye(a,u,b)}intersectIntersectorScreen(a,b,c){this.computeIntersection(this._getPickRay(a,
this._tmpRay),b,c)}intersectToolIntersectorScreen(a,b,c){a=this._getPickRay(a,this._tmpRay);this.intersectToolIntersectorRay(a,b,c)}intersectToolIntersectorRay(a,b,c){b.options.selectionMode=!0;this.computeIntersection(a,b,c);const f=b.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||B.isValidIntersectorResult(f)&&f.intersector!==n.IntersectorType.TERRAIN||(b.options.selectionMode=!1,this.computeIntersection(a,b,c))}setTolerance(a=v.defaultTolerance){this._tolerance=a}addIntersectionHandler(a){this._externalIntersectionHandlers.push(a);
this._externalIntersectionHandlers.sort((b,c)=>b.type===n.IntersectorType.TERRAIN?1:c.type===n.IntersectorType.TERRAIN?-1:0)}removeIntersectionHandler(a){null!=this._externalIntersectionHandlers.removeUnordered(a)&&this._externalIntersectionHandlers.sort((b,c)=>b.type===n.IntersectorType.TERRAIN?1:c.type===n.IntersectorType.TERRAIN?-1:0)}_getPickRay(a,b){return C.fromScreen(this._view.state.camera,a,b)}_intersectRayFreePointLocal(a,b){if(this.viewingMode!==K.ViewingMode.Local||null==a)return!1;x.add(b,
a.origin,x.normalize(r.sv3d.get(),a.direction));return!1}intersectElevationFromScreen(a,b,c=0,f=null){return this._intersectElevation(this._getPickRay(a,this._tmpRay),b,c,f)}_intersectElevation(a,b,c=0,f=null){if(null==a)return null;var e=null!=b?b.mode:"absolute-height",k=b?.offset??0,l="on-the-ground"!==e?k+c:0;b=l/this._view.renderCoordsHelper.unitInMeters;if("absolute-height"===e)return this._view.renderCoordsHelper.intersectInfiniteManifold(a,l,z)?(c=this._view.computeMapPointFromVec3d(z),c.z??
(c.z=0),c.z-=k,c):null;k=this._view.state.camera;const m=w.castRenderScreenPointArray3(r.sv3d.get());k.projectToRenderScreen(a.origin,m);l=new E(null,this._forEachLayer);const p=this._view.slicePlane,q=null!=p?B.sliceFilterPredicate(p):null,g=v.newIntersector(this.viewingMode);g.options.store=n.StoreResults.MIN;g.options.verticalOffset=b;b=a.origin;a=x.add(r.sv3d.get(),b,a.direction);g.reset(b,a,k);g.point=m;const h=f?"type"in f&&"graphics"===f.type?d=>d.layerUid!==f.uid:d=>d.graphicUid!==f.uid:null;
switch(e){case "relative-to-scene":g.intersect(l.layers,m,this._tolerance,null,d=>(!h||h(d))&&!!d.lastValidElevationBB);this._externalIntersectionHandlers.forAll(d=>{d.type!==n.IntersectorType.I3S&&d.type!==n.IntersectorType.TERRAIN||d.intersect(g,d.slicePlaneEnabled?q:null,g.rayBegin,g.rayEnd,m)});break;case "on-the-ground":case "relative-to-ground":this._externalIntersectionHandlers.forAll(d=>{d.isGround&&d.intersect(g,d.slicePlaneEnabled?q:null,g.rayBegin,g.rayEnd,m)})}return g.results.min.getIntersectionPoint(z)?
(e=this._view.computeMapPointFromVec3d(z),e.z=c,e):null}computeIntersection(a,b,c){if(null!=a){var f=this._view.state.camera,e=w.castRenderScreenPointArray3(r.sv3d.get());f.projectToRenderScreen(a.origin,e);var k=new E(c,this._forEachLayer);b.options.selectOpaqueTerrainOnly=!c||!("include"in c||"exclude"in c);var l=a.origin,m=x.add(r.sv3d.get(),a.origin,a.direction);b.reset(l,m,f);b.intersect(k.layers,e,this._tolerance);a=this._view.slicePlane;var p=null!=a?B.sliceFilterPredicate(a):null;b.intersect(k.sliceableLayers,
e,this._tolerance,p);var q=c&&(c.requiresGroundFeedback||c.enableDraped);this._externalIntersectionHandlers.forAll(g=>{var h=g.layerUid;const d=Array.isArray(h);h=d?h:[h];d&&(b.options.filteredLayerUids=[]);let F=!1;for(const G of h)k.filterLayerUid(G)?F=!0:d&&b.options.filteredLayerUids.push(G);b.options.isFiltered=!F;(g.isGround&&q||!b.options.isFiltered)&&g.intersect(b,g.slicePlaneEnabled?p:null,l,m,e)});a=r.sv3d.get();f=this._view.basemapTerrain;if(c&&c.enableDraped&&null!=f.spatialReference&&
b.results.ground.getIntersectionPoint(a)){c=f.overlayManager.renderer;const g=this._view.renderCoordsHelper.spatialReference,h=r.sv3d.get();this._view.renderCoordsHelper.fromRenderCoords(a,h,f.spatialReference);h[2]=this._view.elevationProvider?.getElevation(a[0],a[1],a[2],g,"ground")??0;c.intersect(b,h,b.results.ground,d=>k.filterRenderGeometry(d))}b.sortResults();this._processHUDResults(b)}}_processHUDResults(a){var b=a.results.hud;t.copy(this._tmpRegion,t.negativeInfinity);const c=this._view.state.camera,
f=[],e=this._tmpRegion;var k=h=>{const d=new M(h);c.projectToRenderScreen(h.target.center,d.screenPoint);d.screenPoint[0]=Math.floor(d.screenPoint[0]);d.screenPoint[1]=Math.floor(d.screenPoint[1]);f.push(d);t.expandPointInPlace(e,d.screenPoint)};a.sortResults(b.all);null!=b.min.dist&&k(b.min);for(var l of b.all)b.min.target.object!==l.target.object&&b.max.target.object!==l.target.object&&k(l);null!=b.max.dist&&b.max.target.object!==b.min.target.object&&k(b.max);if(f.length){e[0]===e[2]&&(e[2]+=1);
e[1]===e[3]&&(e[3]+=1);b=c.fullWidth;k=c.fullHeight;var m=Math.max(0,e[0]-1),p=Math.max(0,e[1]-1);l=Math.min(t.width(e)+2,b-m);var q=Math.min(t.height(e)+2,k-p),g=new Uint8Array(l*q*4);this._view._stage.renderer.readHUDVisibility(m,p,l,q,g);m=!0;p=null==a.results.max.dist;q=0;for(const h of f)for(const d of N)if(g[4*(Math.min(h.screenPoint[0]+d[0],b)-e[0]+(Math.min(h.screenPoint[1]+d[1],k)-e[1])*l)]){m&&(a.results.min.copy(h.result),m=!1);p&&a.results.max.copy(h.result);a.options.store===n.StoreResults.ALL&&
a.results.all.splice(q++,0,h.result);break}}}}const N=(()=>{const a=[];for(let b=-1;1>=b;b++)for(let c=-1;1>=c;c++)a.push([c+1,b+1]);return a})();class M{constructor(a){this.result=a;this.screenPoint=w.createRenderScreenPointArray3()}}let y;class E{constructor(a,b){this.layers=[];this.sliceableLayers=[];this.include=a?.include;this.exclude=a?.exclude;b(c=>{c.pickable&&this.filterLayerUid(c.apiLayerUid)&&(c.sliceable?this.sliceableLayers:this.layers).push(c)})}filterLayerUid(a){const {include:b,exclude:c}=
this;return null==a?null==b&&null==c:(null==b||b.has(a))&&(null==c||!c.has(a))}filterRenderGeometry(a){return this.filterLayerUid(a.layerUid)}}const z=I.create(),u=w.createRenderScreenPointArray3();A.SceneIntersectionHelper=L;A.isIntersectionHandler=function(a){return"object"===typeof a&&"intersect"in a};Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});