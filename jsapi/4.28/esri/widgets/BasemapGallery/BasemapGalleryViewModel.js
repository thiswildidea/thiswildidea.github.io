// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../Basemap ../../core/Collection ../../core/Loadable ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/cast ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/projection ../../geometry/support/spatialReferenceUtils ../../support/basemapUtils ./support/basemapCompatibilityUtils ./support/BasemapGalleryItem ./support/LocalBasemapsSource ./support/PortalBasemapsSource".split(" "),
function(e,x,p,q,l,g,y,c,C,z,n,r,A,t,u,B,m){const v=p.ofType(u);c=class extends q{constructor(a){super(a);this._loadingProjectionEngine=!1;this._originalActiveBasemap=null;this.includeCurrentBasemap=!1;this.items=new v;this.source=new m;this.view=null}initialize(){const a=()=>this._recreateItems();this.addHandles([l.watch(()=>[this.view,this.view?.ready],()=>{this.view?.ready&&(this._originalActiveBasemap=this.activeBasemap)},{initial:!0}),l.watch(()=>"ready"===this.state?this.compatibilityFunction:
null,()=>this._updateItems()),l.watch(()=>[this._effectiveIncludeCurrentBasemap,this._originalActiveBasemap],a),l.on(()=>this.source?.basemaps,"change",a,{onListenerAdd:a}),l.when(()=>this.view,()=>{this.source instanceof m&&(this.source.viewType=this.view?.type)},{once:!0})])}destroy(){const a=this.source.basemaps.find(b=>b===this.activeBasemap);a&&this.source.basemaps.remove(a);this.source?.destroy()}get _effectiveIncludeCurrentBasemap(){return this.includeCurrentBasemap&&this.source?.basemaps.every(a=>
"loading"!==a.loadStatus)}get activeBasemap(){return this.view?.map?.basemap??null}set activeBasemap(a){const b=this.view;if(b?.map){var f="string"===typeof a?x.fromId(a):a;if(f&&b.ready){var d=f.spatialReference||this.items?.find(k=>this.basemapEquals(f,k.basemap))?.spatialReference;if(d&&"spatialReferenceLocked"in b&&!b.spatialReferenceLocked){const k=b.spatialReference;null==d||r.equals(k,d)||n.canProjectWithoutEngine(b.spatialReference,d)||n.isLoaded()?(b.map.basemap=f,this._clearOverride("activeBasemap"),
null==d||r.equals(b.spatialReference,d)||(b.spatialReference=d)):(this._override("activeBasemap",f),this._loadingProjectionEngine=!0,n.load().then(()=>{this._get("activeBasemap")===a&&(b.map.basemap=a,b.spatialReference=d,this._clearOverride("activeBasemap"))},()=>{}).then(()=>{this._loadingProjectionEngine=!1}))}else b.map.basemap=f,this._clearOverride("activeBasemap")}else b.map.basemap=f,this._clearOverride("activeBasemap")}}get activeBasemapIndex(){const {state:a,activeBasemap:b}=this;return"ready"!==
a?-1:this._findBasemapIndex(b)}get compatibilityFunction(){return"3d"===this.view?.type?t.default3DCompatibility:t.default2DCompatibility}set compatibilityFunction(a){this._overrideIfSome("compatibilityFunction",a)}castSource(a){return Array.isArray(a)||p.isCollection(a)?new B({basemaps:a}):a&&"esri.portal.Portal"===a.declaredClass?new m({portal:a}):!a||a instanceof m||!a.portal&&!a.query?a&&"basemaps"in a&&"state"in a&&"refresh"in a?a:null:new m(a)}get state(){return this.view?.ready&&this.source?
this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(a,b){return A.contentEquals(a,b)}refresh(){this._recreateItems()}load(a){this.addResolvingPromise(q.isLoadable(this.source)?this.source.load(a):null);return Promise.resolve(this)}_findBasemapIndex(a){const {items:b}=this,f=b.findIndex(d=>d.basemap===a);return-1===f?b.findIndex(d=>this.basemapEquals(d.basemap,a)):f}_recreateItems(){function a(h){const w=k.get(h);return w?(k.delete(h),w):new u({basemap:h,compatibilityFunction:d,
view:f})}var b=this.source?.basemaps;const {view:f,compatibilityFunction:d}=this,k=new Map(this.items.map(h=>[h.basemap,h]));this.items.removeAll();b&&this.items.addMany(b.map(a));b=-1!==this._findBasemapIndex(this._originalActiveBasemap);this._effectiveIncludeCurrentBasemap&&!b&&null!=this._originalActiveBasemap&&this.items.unshift(a(this._originalActiveBasemap));k.forEach(h=>h.destroy())}_updateItems(){for(const a of this.items)a.compatibilityFunction=this.compatibilityFunction,a.view=this.view}};
e.__decorate([g.property()],c.prototype,"_effectiveIncludeCurrentBasemap",null);e.__decorate([g.property()],c.prototype,"_loadingProjectionEngine",void 0);e.__decorate([g.property()],c.prototype,"_originalActiveBasemap",void 0);e.__decorate([g.property()],c.prototype,"activeBasemap",null);e.__decorate([g.property({readOnly:!0})],c.prototype,"activeBasemapIndex",null);e.__decorate([g.property()],c.prototype,"compatibilityFunction",null);e.__decorate([g.property()],c.prototype,"includeCurrentBasemap",
void 0);e.__decorate([g.property({readOnly:!0,type:v})],c.prototype,"items",void 0);e.__decorate([g.property()],c.prototype,"source",void 0);e.__decorate([y.cast("source")],c.prototype,"castSource",null);e.__decorate([g.property({readOnly:!0})],c.prototype,"state",null);e.__decorate([g.property()],c.prototype,"view",void 0);return c=e.__decorate([z.subclass("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],c)});