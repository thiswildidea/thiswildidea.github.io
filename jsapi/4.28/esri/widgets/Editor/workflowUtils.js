// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require exports ../../Graphic ../../core/arrayUtils ../../core/asyncUtils ../../core/has ../../core/handleUtils ../../core/lang ../../core/promiseUtils ../../core/reactiveUtils ../../core/screenUtils ../../core/accessorSupport/diffUtils ../../layers/support/fieldUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../support/featureFlags ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/3d/layers/graphics/GraphicState ../../views/support/drapedUtils ../../views/support/hitTestSelectUtils ../support/templateUtils".split(" "),
function(K,n,X,Y,Z,L,t,aa,v,w,D,ba,z,ca,da,M,N,O,ea,E,P,fa,F,ha){function Q(a){const b=a.sourceLayer;var c;if(!(c=!b||"feature"!==b.type)){a:switch(b.renderer?.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":case "pie-chart":c=!0;break a;default:c=!1}c=!c}if(c)return{rotation:null,size:null};let d=c=null;var e=b.renderer.getVisualVariablesForType("rotation").filter(f=>(!f.axis||"heading"===f.axis)&&f.field&&!f.valueExpression&&null!=N.getRotationAngle(f,
a));1===e.length&&(c=ia(e[0],b));e=b.renderer.getVisualVariablesForType("size").filter(f=>f.field&&!f.useSymbolValue&&!f.valueExpression&&M.getTransformationType(f)===M.TransformationType.RealWorldSize&&null!=N.getSize(f,a));1===e.length&&(d=ja(e[0],b));return{rotation:c,size:d}}function ia(a,b){const c="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,d=a.field,e=(b=b.fields&&b.fields.filter(h=>h.name===d))&&1===b.length?b[0].type:"double";var f=0,g=0;return{field:d,fieldType:e,
getDefault:()=>Promise.resolve(0),getValue:h=>{g=f-c*h;return G((g+360)%360,e)},initValue:h=>{f=null!=h?h:g;g=0},isUpdatingInteractively:!1,rotationType:a.rotationType??"geographic"}}function ka(a,b){switch(b){case "width":return a[0];case "depth":return a[1];case "height":return a[2];default:return a[2]||a[1]||a[0]}}async function la(a,b,c){if(null==b)return 0;({symbol:b}=ea.to3D(b));if(null==b||"web-style"===b.type||"cim"===b.type)return 0;b=b.symbolLayers.at(0);if(!b)return 0;switch(b.type){case "icon":return{computeIconLayerResourceSize:c}=
await new Promise((e,f)=>K(["../../symbols/support/symbolLayerUtils"],e,f)),b.size||Math.min(u.icon,(await c(b,u.icon))[0])||u.icon;case "text":return b.size||u.text;case "line":return b.size||u.line;case "object":const {computeObjectLayerResourceSize:d}=await new Promise((e,f)=>K(["../../symbols/support/symbolLayerUtils"],e,f));a=await d(b,a.scale/u.viewScaleSizeFactor);return ka(a,c);case "path":return(null!=b.width?b.width:b.height)||a.scale/u.viewScaleSizeFactor;case "extrude":return b.size||
a.scale/u.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}}function ja(a,b){const c=a.field,d=a.axis,e=(b=b.fields&&b.fields.filter(k=>k.name===c))&&1===b.length?b[0].type:"double";var f=0,g=0;const h=da.meterIn[a.valueUnit]??1;let l;l="area"===a.valueRepresentation?k=>(k*h/2)**2*Math.PI:"radius"===a.valueRepresentation||"distance"===a.valueRepresentation?k=>k*h/2:k=>k*h;return{field:c,fieldType:e,getDefault:async(k,m)=>G(l(await la(m,k,d)),e),getValue:(k,m)=>{f||(f=m.pixelSizeAt(m.center));
g=f*k;return G(g,e)},initValue:k=>{f=null!=k?k:g;g=0},isUpdatingInteractively:!1,displayUnit:R(a.valueUnit),axis:a.axis}}function G(a,b){switch(b){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}async function x(a,b,c){b=await E.getDisplayedSymbol(a,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:b,scale:c});null!=ba.diff(a.symbol,b)&&(a.symbol=b)}function ma(a){if(!a)throw Error("no geometry type");return"multipatch"===
a?"mesh":a}async function H(a,b,c){const d=b.layer,e={...b.template?.prototype.attributes,...b.attributeOverrides};let f=null;const {view:g}=a,h="2d"===g?.type;await S(a,d,e,c,h?g.scale:null);if(h){const m=v.debounce(p=>S(a,d,e,c,p));f=w.watch(()=>g.scale,p=>m(p))}const {data:l,editing:k}=d.capabilities;a.layer.elevationInfo=d.elevationInfo;await a.create(ma(d.geometryType),{graphicProperties:{attributes:e,sourceLayer:d},hasZ:l.supportsZ,defaultZ:(h?k.zDefault:null)??a.defaultCreateOptions.defaultZ,
geometryToPlace:b.geometryToPlace??void 0});return f??t.makeHandle()}async function S(a,b,c,d,e){b=new X({sourceLayer:b,attributes:c});const {rotation:f,size:g}=Q(b);let h=await E.getDisplayedSymbol(b,{useSourceLayer:!0,webStyleCache:d,scale:e}),l=!1;for(const k of[g,f])null!=k&&null==c[k.field]&&(c[k.field]=await k.getDefault(h,a.view),l=!0);l&&(h=await E.getDisplayedSymbol(b,{useSourceLayer:!0,webStyleCache:d,scale:e}));switch(h?.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=h;break;
case "simple-line":case "line-3d":a.polylineSymbol=h;break;case "simple-marker":case "picture-marker":case "point-3d":case "cim":a.pointSymbol=h;break;case "mesh-3d":a.meshSymbol=h}T(a.tooltipOptions,g,f)}function T(a,b,c){a.visualVariables=null!=b||null!=c?{size:null!=b?{unit:b.displayUnit,axis:b.axis,valueType:b.fieldType}:null,rotation:null!=c?{valueType:c.fieldType,rotationType:c.rotationType??"geographic"}:null}:null}async function na(a,b,c,d){if(0===a.length)return[];const {updatable:e,graphicsByLayer:f}=
await c.async(async()=>{var {results:g}=await v.whenOrAbort(F.hitTestSelectSimilarDistance(b,c),d);const h=new Map;F.filterGraphicHits(g).forEach(({graphic:l})=>{var k=l.layer;var m=h.get(k);m?k=m:(m=[],h.set(k,m),k=m);return k.push(l)});g=a.filter(({supports:l,layer:k})=>l.includes("update")&&h.has(k));0!==g.length&&c.stopPropagation();return{updatable:g,graphicsByLayer:h}});return v.whenOrAbort(Promise.allSettled(e.map(async({layer:g})=>{var h=f.get(g);const l=U(g);if(h.every(p=>z.featureHasFields(l,
p)))return h;const k=[];for(var m of h)k.push(m.getObjectId()),h=Object.keys(m.attributes),Y.addMany(l,h);m=g.createQuery();m.returnGeometry=!1;m.objectIds=k;m.outFields=z.fixFields(g.fieldsIndex,l);return g.queryFeatures(m,{signal:d}).then(({features:p})=>p)})),d)}async function oa(a,b,c,d){if(0===a.length)return[];let e=null;const f=await c.async(async()=>{var {results:g}=await v.whenOrAbort(b.hitTest(c),d);if(0===g.length)return[];const h=new Set;e=F.filterGraphicHits(g);e.forEach(({graphic:l})=>
l&&h.add(l.layer));g=a.items.filter(({layer:l,supports:k,attachmentsOnUpdateEnabled:m})=>h.has(l)&&(k.includes("update")||k.includes("delete")||m));0<g.length&&c.stopPropagation();return g});return v.whenOrAbort(Promise.allSettled(f.map(async({layer:g})=>{const h=g.createQuery();h.returnGeometry=!1;h.outFields=U(g);const l="renderer"in g?ca.calculateTolerance({renderer:g.renderer,event:c}):0;h.geometry=fa.createQueryGeometry(c.mapPoint,l,b);h.outSpatialReference=b.spatialReference;const {features:k}=
await g.queryFeatures(h,{signal:d});e?.forEach(({graphic:m})=>{m.layer!==g||k.some(p=>p.getObjectId()===m.getObjectId())||k.push(m)});return k})),d)}function U(a){return z.fixFields(a.fieldsIndex,[a.objectIdField,z.getDisplayFieldName({displayField:"displayField"in a?a.displayField:null,fields:a.fields})])}async function I(a){const {graphic:b,sketchViewModel:c,sourceLayer:d,visualVariables:e,webStyleCache:f}=a;let g=!1;const {rotation:h,size:l}=e;[h,l].forEach(async k=>{if(null!=k){var m=b.getAttribute(k.field);
null!=m?k.initValue(m):(m=await k.getDefault(b.symbol,c.view),k.initValue(m),b.setAttribute(k.field,m),g=!0)}});g&&await x(b,f,"2d"===c.view?.type?c.view.scale:null);a={multipleSelectionEnabled:!1};"point"===d.geometryType&&(a.enableRotation=null!=h,a.enableScaling=null!=l);T(c.tooltipOptions,l,h);c.layer.elevationInfo=d.elevationInfo;return c.update(b,a)}async function V(a,b,c,d,e){if(null!=b.geometry&&"point"===b.geometry?.type){var f=d.rotation;var g=c.toolEventInfo;g=null==g||"rotate-start"!==
g.type&&"rotate"!==g.type&&"rotate-stop"!==g.type?null:g;if(null!=f&&null!=g)if("rotate-stop"===g.type)f.isUpdatingInteractively=!1,f.initValue();else{f.isUpdatingInteractively=!0;const {field:h,getValue:l}=f;b.setAttribute(h,l(g.angle,a))}d=d.size;c=c.toolEventInfo;c=null==c||"scale-start"!==c.type&&"scale"!==c.type&&"scale-stop"!==c.type?null:c;if(null!=d&&null!=c)if("scale-stop"===c.type)d.isUpdatingInteractively=!1,d.initValue();else{d.isUpdatingInteractively=!0;const {field:h,getValue:l}=d;b.setAttribute(h,
l(c.xScale,a))}await x(b,e,"2d"===a.type?a.scale:null)}}function pa(a,b,c){if("3d"===a.type){const d=new P.GraphicState({graphic:b});return t.handlesGroup([a.trackGraphicState(d),w.watch(()=>d.displaying,c)])}return w.watch(()=>b.visible,c)}async function W(a,b){if("3d"===a.type){const c=new P.GraphicState({graphic:b});a=a.trackGraphicState(c);await w.whenOnce(()=>c.displaying);a.remove()}else await w.whenOnce(()=>b.visible)}function R(a){switch(a){case "unknown":case "decimal-degrees":return null;
default:return a}}function J(a){const b=a.geometry;if("mesh"===b?.type){const c=a.cloneShallow();c.attributes=aa.clone(a.attributes);c.geometry=b.cloneShallow();c.geometry.transform=b.transform?.clone()??null;return c}return a.clone()}const u={icon:D.px2pt(24),text:D.px2pt(12),line:D.px2pt(1),viewScaleSizeFactor:100},A=(a,b)=>a.whenLayerView("subtype-sublayer"===b.type?b.parent:b);L=Symbol();n.UsesSketchViewModelSymbol=L;n.avoidFeatureTemplateSelectionWithOnlyOneItem=function(a,b){a.viewModel.syncFeatureTemplates();
a=a.creationInfo;if("awaiting-feature-creation-info"===b[0].id&&a){const c=a.layer,d=ha.getAllTemplatesForLayer(c);1===d.length&&"scene"!==c.type&&(a.template=d[0],b.shift())}return b};n.canCreateInteractiveEditSession=function(a){return"createInteractiveEditSession"in a};n.cloneGraphicExceptMesh=J;n.createWorkflowSteps=function(a,b,c){let d=!1;return a.filter(e=>d?!0:d=e===b).map(e=>c[e]())};n.fetchCandidates=async function(a,b,c,d){switch(b.type){case "3d":return na(a,b,c,d);case "2d":return oa(a,
b,c,d)}};n.fetchFullFeature=async function(a,b,c){const {sourceLayer:d}=a,e=d.createQuery();e.objectIds=[a.getAttribute(d.objectIdField)];e.outFields=["*"];e.outSpatialReference=b;e.returnM=d.capabilities.data.supportsM;e.returnZ=d.capabilities.data.supportsZ;O.sceneLayerEditingEnabled()&&O.i3sPatchingEnabled()&&"scene"===d.type&&null!=d.infoFor3D&&(e.returnGeometry=!0,e.formatOf3DObjects="3D_glb");a=await d.queryFeatures(e,{signal:c});v.throwIfAborted(c);return a.features[0]};n.findLayerInfo=function(a,
b){return a?a.find(c=>c.layer===b):void 0};n.getVisualVariableAttributes=Q;n.isTerminalUpdateEventType=a=>/-stop/.test(a)||/vertex-/.test(a);n.prepareAttachmentsForCreateWorkflow=function(a){a.filesEnabled=!0;a.mode="view";a.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}};n.setUpFeatureAdd=async function(a,b,c,d){(await H(a,b,d)).remove();const e=a.on("create",async f=>{"cancel"===f.state&&(await H(a,b,d)).remove();"complete"===f.state&&(f=f.graphic,f.sourceLayer||(f.sourceLayer=
b.layer),f.attributes||(f.attributes={...b.template?.prototype.attributes}),await x(f,d,"2d"===a.view?.type?a.view?.scale:null),c(f))});return t.handlesGroup([e,t.makeHandle(()=>a.cancel())])};n.setUpGeometryUpdate=async function({feature:a,featureClone:b,visualVariableAttributes:c,sketchViewModel:d,view:e,onUpdate:f,webStyleCache:g}){await x(b,g,"2d"===e.type?e.scale:null);let h=null;if("2d"===d?.view?.type){const q=v.debounce(r=>x(b,g,r));h=w.watch(()=>d?.view?.scale,r=>q(r))}e.map.add(d.layer);
const l=b.sourceLayer;var k=A(e,l);await I({graphic:b,sketchViewModel:d,sourceLayer:l,visualVariables:c,webStyleCache:g});let m=null;k.then(q=>m=q).catch(()=>{});const p=c.size,B=c.rotation;k=w.watch(()=>a.attributes,async q=>{let r=!1;for(const y in q){const C=q[y];C!==b.getAttribute(y)&&(b.setAttribute(y,C),null==p||p.isUpdatingInteractively||p.field!==y||p.initValue(C),null==B||B.isUpdatingInteractively||B.field!==y||B.initValue(C),null==m||m.requiredFields.includes(y))&&(r=!0)}r&&await x(b,g,
"2d"===e.type?e.scale:null)});const qa=d.on("update",async q=>{const r=q.graphics[0];if("complete"===q.state)return I({graphic:r,sketchViewModel:d,sourceLayer:l,visualVariables:c,webStyleCache:g});await V(e,r,q,c,g);f(J(r),q)}),ra=d.on(["undo","redo"],async q=>{f(J(q.graphics[0]),q)});return t.handlesGroup([ra,qa,t.makeHandle(()=>d.cancel()),k,h])};n.shouldShowAttachmentsForCreateWorkflow=function(a){const {creationInfo:b,viewModel:c}=a;if(!b)return!1;const {layer:d}=b;if(a=c.editableItems.find(f=>
f.layer===d))return a.attachmentsOnCreateEnabled;a=d.capabilities?.data;const e=c.layerInfos?.find(f=>f.layer===d);return!(!(a&&"supportsAttachment"in a&&a.supportsAttachment)||e&&(!1===e.allowAttachments||!1===e.attachmentsOnUpdateEnabled))};n.showProgressCursor=function(a){const b=a.cursor;a.cursor="progress";return t.makeHandle(()=>a.cursor=b)};n.sizeDefaults=u;n.sizeVariableUnitToLengthUnit=R;n.startCreatingNewFeature=H;n.startUpdatingFeature=I;n.swapForEditingSession=async function(a,b,c){function d(l){h?.abort();
h=Z.createTask(async k=>{const m=await A(e,f);v.throwIfAborted(k);m.setVisibility?.(g,l)})}const e=a.view;a.layer.add(c);const f=b.sourceLayer,g=b.getAttribute(b.layer.objectIdField);let h=null;await W(e,c);d(!1);return t.handlesGroup([pa(e,c,l=>d(!l)),t.makeHandle(async()=>{d(!0);try{const l=await A(e,f);await w.whenOnce(()=>!l.updating)}finally{a.layer.remove(c)}})])};n.updateGraphicSymbolWhenRequired=x;n.visualVariableInteractiveUpdate=V;n.whenEditorLayerView=A;n.whenGraphicDisplayed=W;Object.defineProperty(n,
Symbol.toStringTag,{value:"Module"})});