// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("require ../../chunks/tslib.es6 ../../Graphic ../../core/arrayUtils ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/uuid ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ../../views/draw/support/helpMessageUtils ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./modelUploadUtils ./Workflow ./workflowUtils".split(" "),
function(J,v,K,A,q,B,L,y,H,w,t,V,M,z,N,O,P,C,Q,p){function R(a,c){let b=null;const g=()=>{null!=b&&(a.snappingOptions.featureSources.remove(b),b=B.destroyMaybe(b))};return q.handlesGroup([y.watch(()=>{const e=c.creationInfo?.layer,d=a.snappingOptions.featureSources.find(k=>k.layer===e);return{hasFeatureLayerSource:!!d,enabled:d?.enabled??!1}},({hasFeatureLayerSource:e,enabled:d})=>{if(e)null==b&&(b=new O({layer:a.layer}),a.snappingOptions.featureSources.add(b)),b.enabled=d;else return g()},y.syncAndInitial),
q.makeHandle(g)])}function S(a,c,b,g){const e=[];c.forEach((d,k)=>{if(!d.error){const m=a[k];k=g.get(m)||[];m.attributes[b.objectIdField]=d.objectId;k.forEach(({form:f})=>e.push({feature:m,attachment:f}))}});return e}function T(a,c,b){const g=[],e=c.globalIdField;a.forEach((d,k)=>{var m;(m=a[k].attributes)[e]??(m[e]=H.generateBracedUUID());(b?.get(d)||[]).forEach(({file:f})=>g.push({feature:d,attachment:{globalId:H.generateBracedUUID(),data:f}}))});return g.length?{addFeatures:a,addAttachments:g}:
{addFeatures:a}}var D;const G=Symbol(),I=Symbol(),x=Symbol(),E=Symbol();t=D=class extends Q{constructor(a){super(a);this.type="create-features";this.createFeatureState="create-new";this.isNested=!1;this._getDrawMeshHelpMessage=void 0;this._featureFormHandle=null;this._visualVariableAttributes={rotation:null,size:null};this._attachmentFileInfos=new Map;this._highlightHandles=new Map;this._preventDefaultActionOnCancel=!1;this._lastActiveGraphics=[];this._isActive=!0;this._updateGraphicDebounced=L.debounce((c,
b,g)=>p.updateGraphicSymbolWhenRequired(c,b,g))}initialize(){this.isNested&&(this._isActive=!1)}get hasPendingEdits(){if(0<this.numPendingFeatures)return!0;const {data:a}=this;var {sketchViewModel:c}=a.viewModel,{activeComponent:b}=c;c=c.createGraphic?.geometry;if(!("polyline"!==c?.type&&"polygon"!==c?.type&&"multipoint"!==c?.type||"draw-2d"!==b?.type&&"draw-3d"!==b?.type)&&0<b.drawOperation.committedVertices.length)return!0;({upload:b}=a);return b&&("pending"===b.state||"success"===b.state)||a.creationInfo?.geometryToPlace?
!0:!1}get helpMessage(){const {creationInfo:a,viewModel:c}=this.data;if("creating-features"===this.stepId&&a){var b=a.layer.geometryType,g=c.sketchViewModel.createGraphic;return"mesh"===b?(this._getDrawMeshHelpMessage||(new Promise((e,d)=>J(["../../views/draw/support/helpMessageUtils3d"],e,d))).then(e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage}),{view:b}=c,"3d"===b?.type?this._getDrawMeshHelpMessage?.(g,b):void 0):N.getDrawHelpMessage(b,g?.geometry)}}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===
this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){var {creationInfo:a}=this.data;if(!a)return!1;({layer:a}=a);const c=a.capabilities?.operations.supportsAdd,b=z.getEffectiveLayerCapabilities(a)?.operations.supportsAdd;return z.getEffectiveEditingEnabled(a)&&!a.editingEnabled||!!b&&!c}get shouldShowAttachments(){return this.data.creationInfo&&this.data.viewModel?p.shouldShowAttachmentsForCreateWorkflow(this.data):!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get test(){return{addAttachment:(a,
c)=>{this._attachmentFileInfos.set(a,c)}}}async enter(){this._isActive=!0;const {featureFormViewModel:a}=this.data.viewModel,c=a.relatedRecordCallbacks;a.relatedRecordCallbacks=null;this.addHandles(q.makeHandle(()=>{a.relatedRecordCallbacks=c}),I);"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1;this.removeHandles([I,E])}async updatePendingFeature(a,c){this._preventDefaultActionOnCancel=!0;this.data.viewModel.sketchViewModel.cancel();A.remove(this._lastActiveGraphics,
a);return this._startUpdating(a,c)}async start(){await super.start();return z.isTable(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{}}}static create(a){const {addAttachmentsCallback:c,applyEditsCallback:b,isNested:g,creationInfo:e,parent:d,startAt:k,viewModel:m}=a,f=new D({data:new P.CreateFeaturesWorkflowData({creationInfo:e,parent:d,viewModel:m}),isNested:g,onCommit:async h=>{var {creationInfo:l}=h;if(l){h=h.pendingFeatures.toArray();({layer:l}=l);var u=f._attachmentFileInfos;
if(l.capabilities?.editing.supportsGlobalId&&"globalIdField"in l)h=T(h,l,u),await b(l,h,{globalIdUsed:!0});else{var n=await b(l,{addFeatures:h});0<u.size&&await c(l,S(h,n?.addFeatureResults??[],l,u))}}}});f._set("steps",this._createWorkflowSteps(f,k));return f}_fadeExistingFeatures(a){if("effect"in a){const b=a.effect;a.effect="saturate(0.6) opacity(0.8)";return q.makeHandle(()=>a.effect=b)}const c=a.opacity;a.opacity=.7;return q.makeHandle(()=>a.opacity=c)}_highlight(a){const c=this.data.viewModel.view;
"3d"===c?.type&&this._highlightHandles.set(a,c.highlight(a))}_removeHighlight(a){B.removeMaybe(this._highlightHandles.get(a));this._highlightHandles.delete(a)}async _startCreating(a){this.removeHandles(x);const {data:c}=this,{creationInfo:b}=c;b&&(this.createFeatureState="create-new",a=await p.startCreatingNewFeature(c.viewModel.sketchViewModel,b,a),this.addHandles(a,x))}async _startUpdating(a,c){var {pendingFeatures:b}=this;b.includes(a)||b.add(a);const {creationInfo:g,viewModel:e}=this.data,{attachmentsViewModel:d,
editableItems:k,featureFormViewModel:m,layerInfos:f,sketchViewModel:h,view:l}=e;if(l&&g){var u=g.layer;b=p.findLayerInfo(f,u)?.formTemplate;var n=l.spatialReference;this.data.editableItem=k.find(r=>r.layer===u);m.set({arcadeEditType:"INSERT",feature:a,formTemplate:b,spatialReference:n,map:l.map});"add"!==d.mode&&"edit"!==d.mode||e.activeWorkflow?.previous();d.graphic=a;d.fileInfos.removeAll();d.mode="view";(this._attachmentFileInfos.get(a)||[]).forEach(({file:r,form:F})=>d.addFile(r,F));this._removeHighlight(a);
await p.updateGraphicSymbolWhenRequired(a,c,"2d"===l.type?l.scale:null);this.removeHandles(x);B.removeMaybe(this._featureFormHandle);"2d"===l.type&&(b=y.watch(()=>l.scale,r=>this._updateGraphicDebounced(a,c,r)),this.addHandles(b,x));this._featureFormHandle=q.handlesGroup([m.on("value-change",async()=>{a.attributes=m.getValues();await p.updateGraphicSymbolWhenRequired(a,c,"2d"===l.type?l.scale:null)}),h.on(["update","undo","redo"],r=>{("undo"===r.type||"redo"===r.type||"update"===r.type&&null!=r.toolEventInfo&&
p.isTerminalUpdateEventType(r.toolEventInfo.type))&&m.notifyFeatureGeometryChanged()})]);this.createFeatureState="update-pending";this._visualVariableAttributes=p.getVisualVariableAttributes(a);if(!z.isTable(u))return p.startUpdatingFeature({graphic:a,sketchViewModel:h,sourceLayer:u,visualVariables:this._visualVariableAttributes,webStyleCache:c})}}static _createWorkflowSteps(a,c="awaiting-feature-creation-info"){const {data:b}=a;c=p.createWorkflowSteps(["awaiting-feature-creation-info","creating-features",
"adding-attachment","editing-attachment"],c,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const {creationInfo:g,viewModel:e}=b,{view:d}=e;d&&(C.isModelUpload(g)?a.addHandles(await C.handleModelUpload({view:d,data:b,next:()=>a.next(),cancel:()=>e.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(b.parent&&g&&(a.addHandles(e.lockFeatureTemplatesViewModel(),this.id),e.featureTemplatesViewModel.layers=[g.layer]),a.addHandles(e.featureTemplatesViewModel.on("select",
({item:k})=>{k&&(b.creationInfo={...b.creationInfo,layer:k.layer,template:k.template},a.next())}),this.id)))},async tearDown(){a.removeHandles([this.id,x])}}),"creating-features":()=>({id:"creating-features",async setUp(){a._isActive&&await a._setUpCreatingFeaturesStep()},async tearDown(g){const {viewModel:e}=b;g.canceled&&(a.removeHandles([E,G,x]),e.attachmentsViewModel.fileInfos.removeAll(),a._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",
async setUp(){},async tearDown(){const {attachmentsViewModel:g}=b.viewModel,{graphic:e,fileInfos:d}=g;a._attachmentFileInfos.set(e,d.toArray());g.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:g}=b.viewModel,{graphic:e,fileInfos:d}=g;a._attachmentFileInfos.set(e,d.toArray());g.mode="view"}})});return p.avoidFeatureTemplateSelectionWithOnlyOneItem(b,c)}static _configureSketchViewModel(a,c){const {data:b}=
a;var {viewModel:g}=b;const {view:e}=g,d=g.sketchViewModel;let k=null;g=[];if(!e)return{beforeCommit:q.makeHandle(),afterCommit:q.makeHandle()};const m=d.updateOnGraphicClick;d.updateOnGraphicClick=!1;"2d"===e.type&&b.creationInfo&&g.push(a._fadeExistingFeatures(b.creationInfo.layer));g.push(d.on("create",async f=>{if("cancel"===f.state){if(a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}if(1>a._lastActiveGraphics.length)return a._startCreating(c);f=a._lastActiveGraphics.pop();
return a._startUpdating(f,c)}if("complete"===f.state&&f.graphic)return a._startUpdating(f.graphic,c)}),d.on("update",async f=>{var {viewModel:h}=b;const {attachmentsViewModel:l,featureFormViewModel:u}=h;var n=f.graphics[0];if("complete"===f.state){n!==k&&(a._lastActiveGraphics.push(n),a._highlight(n));k=null;if(a.numPendingFeatures===b.creationInfo?.maxFeatures)return f=a._lastActiveGraphics.pop(),a._startUpdating(f,c);"add"!==l.mode&&"edit"!==l.mode||h.activeWorkflow?.previous();if(f.aborted&&a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=
!1;return}a.addHandles([p.showProgressCursor(e),e.on("click",U=>U.preventDefault())],G);await y.whenOnce(()=>!u.updating);a.removeHandles(G);a._startCreating(c)}"start"===f.state&&a._removeHighlight(n);h=a._visualVariableAttributes;await p.visualVariableInteractiveUpdate(e,n,f,h,c);f=n.attributes;const {rotation:r,size:F}=h;null!=r&&({field:n}=r,u.setValue(n,f[n]));null!=F&&({field:n}=F,u.setValue(n,f[n]))}),d.on("delete",async f=>{f=f.graphics[0];a.pendingFeatures.remove(f);A.remove(a._lastActiveGraphics,
f);k=f}),e.on("immediate-click",async f=>{!C.isModelUpload(b.creationInfo)&&({results:f}=await e.hitTest(f,{include:d.layer}),f=f.find(h=>"graphic"===h.type&&h.graphic.sourceLayer===b.creationInfo?.layer))&&(f=f.graphic,"transform"!==d.activeTool&&"reshape"!==d.activeTool||d.updateGraphics.at(0)===f||await a.updatePendingFeature(f,c))}),q.makeHandle(()=>{a._preventDefaultActionOnCancel=!0;d.cancel()}),R(d,b));return{beforeCommit:q.handlesGroup(g),afterCommit:q.makeHandle(()=>{d.updateOnGraphicClick=
m})}}async _setUpCreatingFeaturesStep(){if(!this.hasHandles(E)){var {creationInfo:a,viewModel:c}=this.data,{attachmentsViewModel:b,view:g}=c;if(g){var e=new Map,d=[],k=[];this._lastActiveGraphics=[];this._featureFormHandle=B.removeMaybe(this._featureFormHandle);this._visualVariableAttributes={rotation:null,size:null};p.prepareAttachmentsForCreateWorkflow(b);d.push(y.watch(()=>b.mode,h=>{switch(h){case "add":this.go("adding-attachment");break;case "edit":this.go("editing-attachment")}}));var m=p.showProgressCursor(g);
d.push(m);var f=z.isTable(a?.layer);try{if(C.isModelUpload(a)&&k.push(q.makeHandle(()=>c.cancelWorkflow({warnIfNoWorkflow:!1}))),f){const h=a?.initialFeature??new K({attributes:{...a?.template?.prototype.attributes,...a?.attributeOverrides},sourceLayer:a?.layer});await this._startUpdating(h,e)}else{const h=D._configureSketchViewModel(this,e);d.push(h.beforeCommit);k.push(h.afterCommit);a?.initialFeature?(c.sketchViewModel.layer.add(a.initialFeature),await this._startUpdating(a.initialFeature,e)):
await this._startCreating(e)}}finally{m.remove()}e=q.makeHandle(()=>this.pendingFeatures.drain(h=>c.sketchViewModel.layer.remove(h)));d.push(this._featureFormHandle);this.addHandles(d.filter(A.isSome),this._handleKeys.beforeCommit);this.addHandles([q.makeHandle(()=>b.fileInfos.removeAll()),...d,...k,e].filter(A.isSome),E)}}}};v.__decorate([w.property({constructOnly:!0})],t.prototype,"isNested",void 0);v.__decorate([w.property()],t.prototype,"hasPendingEdits",null);v.__decorate([w.property()],t.prototype,
"_getDrawMeshHelpMessage",void 0);v.__decorate([w.property()],t.prototype,"helpMessage",null);v.__decorate([w.property()],t.prototype,"parent",null);v.__decorate([w.property()],t.prototype,"keyboardCancellationEnabled",null);v.__decorate([w.property()],t.prototype,"reliesOnOwnerAdminPrivileges",null);v.__decorate([w.property()],t.prototype,"shouldShowAttachments",null);v.__decorate([w.property()],t.prototype,"shouldAllowAttachmentEditing",null);return t=D=v.__decorate([M.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],
t)});