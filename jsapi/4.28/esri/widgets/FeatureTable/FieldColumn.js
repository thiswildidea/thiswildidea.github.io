// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.28/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../intl/date ../../intl/number ../../layers/support/CodedValueDomain ../../layers/support/editableLayers ../../layers/support/fieldUtils ../../layers/support/layerUtils ../FeatureForm/FieldInput ./Grid/EditorColumn ../support/DatePicker ../support/dateUtils ../support/legacyIcon ../support/TimePicker ../support/widgetUtils".split(" "),
function(k,C,F,l,g,S,T,G,y,u,H,I,n,J,K,L,M,t,z,N,v){const O=y.convertDateFormatToIntlOptions("short-date-short-time"),P=y.convertDateFormatToIntlOptions("short-date"),D={useGrouping:!0,maximumFractionDigits:20};g=class extends L{constructor(b){super(b);this._inputField=null;this.cellValueFormatFunction=({rowData:a,value:c})=>{if(this.formatFunction){const {template:e,field:f}=this;return this.formatFunction({template:e,field:f,value:v.renderingSanitizer.sanitize(c)})}if(null===c)return"\x26nbsp;";
var {field:d}=this;if(a=this._getDomainForFeature(a?.item?.feature)){const e=this._getComputedDomain(c,a);return"date"===d.type&&"range"===a.type?this._formatDateValueForDisplay(d,e):n.isNumericField(d)&&"range"===a.type?(d=(d=this.template?.format)?u.convertNumberFormatToIntlOptions(d):D,u.formatNumber(parseFloat(c),d)):t.dateFieldsWithStringFieldValue.has(d.type)?"range"===a.type?v.renderingSanitizer.sanitize(t.getLabelForDateFieldValue(d,e)):v.renderingSanitizer.sanitize(e):e}return"date"===d.type||
t.dateFieldsWithStringFieldValue.has(d.type)?this._formatDateValueForDisplay(d,c):n.isNumericField(d)?(d=(d=this.template?.format)?u.convertNumberFormatToIntlOptions(d):D,u.formatNumber(parseFloat(c),d)):v.renderingSanitizer.sanitize(c)};this.cellValueValidatorFunction=({oldValue:a,value:c})=>{const {_inputField:d,field:e}=this;return d&&!d.valid||this.required&&(null==c||""===c)?!1:n.isNumericField(e)&&n.validateFieldValue(e,c)?(C.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),
!1):a!==c};this.editingEnabled=!1;this.formatFunction=this.field=this.expressionInfos=null;this.headerRenderFunction=a=>{const {root:c}=a,{editable:d,editingEnabled:e,headerMenuEnabled:f,sortable:h}=this;this.removeCellContent(c);c.classList.add("esri-field-column__header-content");e&&!d&&c.appendChild(this.createLockedElement());if(h)this.headerSorterRenderFunction(a);else{const m=document.createElement("div");m.classList.add("esri-field-column__header-label");m.textContent=this.label;c.appendChild(m)}f&&
this.headerMenuRenderFunction(a)};this.inputRenderFunction=({root:a,column:c,rowData:d})=>{if(!this.activeEditInfo?.updating&&this.editable){var e=this.getCellValue(c,d),{field:f}=this;n.isNumericField(f)&&n.validateFieldValue(f,e)?C.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value."):(f=this.createInputElement({root:a,column:c,rowData:d,value:e}),this._set("activeEditInfo",{column:c,input:f,root:a,rowData:d,updating:!0,
oldValue:e}),"date"===this.field.type?this._renderDateEditors(e,a,f):(c=this.createInputContainer(),c.appendChild(f),this.removeCellContent(a),a.appendChild(c),f.focus(),f instanceof HTMLInputElement&&f.select(),this.grid?.notifyResize()))}};this.layer=null;this.parseInputValueFunction=({input:a})=>{const c=this._inputField;if(!c)return null;a=a.value;const {dataType:d,required:e}=c;return e||""!==a?"number"===d||"date"===d?parseFloat(a):"text"===d?a.trim():a:null};this.template=this.store=null;this.updateRowItemFunction=
({rowData:a,column:c,value:d})=>{a&&(a.item.feature.attributes[c.path]=d)};this.updateStoreItemFunction=async({rowData:a,column:c,value:d})=>{a&&this.store&&(a=this.store.getObjectIdIndex(a.item.objectId)??a.index,await this.store.updateItem({index:a,name:c.path,value:d}))}}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.field?.description??null}get editable(){const {editingEnabled:b,field:a,layer:c,
template:d}=this;if(null==a||null==c)return!1;const e=I.isEditableLayer(c),f=J.getEffectiveLayerCapabilities(c);return a.editable&&e&&f?.operations.supportsUpdate&&!t.dateFieldsWithStringFieldValue.has(a.type)?b?!1!==d?.editable:!!d?.editable:!1}get header(){return this.template?.label||this.alias||this.path||null}get hidden(){const {template:b}=this;return!1===b?.visible||this._get("hidden")||!1}set hidden(b){this._set("hidden",b)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const {field:b,
template:a}=this,c=b?.length??-1,d=a?.input&&"maxLength"in a.input?a.input.maxLength:null;return null!=d&&!isNaN(d)&&-1<=d&&(-1===c||d<=c)?d:c}get minLength(){const {template:b,maxLength:a}=this,c=b?.input&&"minLength"in b.input?b.input.minLength:null;return a&&c<=a?c:null}get name(){return this.field?.name}get nullable(){return this.field?.nullable??!1}get path(){return this.field?.name}get required(){const {field:b,template:a}=this;return this.editable&&(!b?.nullable||!0===a?.required)}get sortable(){return!1!==
this.template?.sortable}createInputElement({rowData:b,value:a}){b=b?.item;if(!b?.feature)return null;this._inputField=this._setUpInputField(b.feature,a);const {field:c,maxLength:d,minLength:e,required:f}=this;({domain:b}=this._inputField);let h;"coded-value"===b?.type?(h=this._createSelectElement(a,b.codedValues.map(({code:r,name:A})=>({value:r,name:A})),this._inputField),h.onchange=()=>{h.onblur=null;q()}):(h=document.createElement("input"),h.type=n.isNumericField(c)?"number":"text",-1<d&&(h.maxLength=
d),0<e&&(h.minLength=e));h.classList.add("esri-field-column__cell-input");h.value=a;h.required=f;let m=!1;h.onkeydown=r=>{m="Escape"===r.key};h.onblur=()=>{h.onblur=null;q()};const q=()=>{m?this.cancel():this.submit();this._inputField=null};return h}createInputContainer(){const b=document.createElement("div");b.classList.add("esri-field-column__cell__input-container");return b}createLockedElement(){const b=document.createElement("div");b.classList.add(z.legacyIcon.locked);return b}getCellValue({path:b},
a){return a?.item?.feature?.attributes?.[b]??null}_formatDateValueForDisplay(b,a){const {timeZone:c,timeZoneName:d}=this;return null!=a?t.getLabelForDateFieldValue(b,a,{...this._getDateFormatOptions(),timeZone:c??void 0,timeZoneName:d??void 0}):null}_renderDateEditors(b,a,c){const {messagesCommon:d,template:e,timeZone:f}=this;var h=b?new Date(b):new Date(Date.now());const m=new M({dateInputEnabled:!0,timeZone:f,value:h}),q=new N({timeZone:f,value:h});c.value=h.getTime().toString();let r=!b;const A=
()=>{r=!0;const w=this._getCombinedDateTime(m.value,q.value);c.value=w.getTime().toString()},Q=()=>{r?this.submit():this.cancel()},R=()=>{c.value=null;this.submit()};F.watch(()=>[m.value,q.value],()=>A());var p=document.createElement("div");const E=document.createElement("div");m.container=p;q.container=E;b=document.createElement("button");b.classList.add("esri-field-column__button",z.legacyIcon.save);b.onclick=()=>Q();b.title=d?.save;h=document.createElement("button");h.classList.add("esri-field-column__button",
z.legacyIcon.trash);h.onclick=()=>R();h.title=d?.clear;const x=document.createElement("div");x.classList.add("esri-field-column__cell__date-input-wrapper");x.appendChild(p);(!e||e?.input&&"datetime-picker"===e.input.type&&!1!==e.input.includeTime)&&x.appendChild(E);p=document.createElement("div");p.classList.add("esri-field-column__cell__date-input-container");p.appendChild(x);p.appendChild(b);p.appendChild(h);m.when(()=>{const w=m._inputOrButtonNode;w&&(w.onblur=B=>{(B=B.relatedTarget)&&B.className.includes("esri-date-picker")||
m.close(!1)});this.grid?.notifyResize()});q.when(()=>this.grid?.notifyResize());this.removeCellContent(a);a.appendChild(p);this.grid?.notifyResize()}_createSelectElement(b,a,c){let d=!1;a=a.map(f=>{f.value===b&&(d=!0);const h=document.createElement("option");h.text=f.name;h.value=f.value;return h});if(null!=b&&""!==b&&!d){const f=document.createElement("option");f.text=b;f.value=b;a.unshift(f)}c.required||null!=c.value||(c=document.createElement("option"),c.value="",a.unshift(c));const e=document.createElement("select");
a.forEach(f=>e.add(f));e.value=b;return e}_setUpInputField(b,a){const {field:c,layer:d}=this;b=new K({feature:b,initialFeature:b.clone(),field:c,layer:d});b.set("value",a);return b}_isDomainCompatible(b){const {field:a}=this;if(b&&"coded-value"===b.type){const c=typeof b.codedValues[0].code;if("string"===c&&n.isStringField(a)||"number"===c&&n.isNumericField(a))return!0}return b&&"range"===b.type&&n.isNumericField(a)?!0:!1}_getDomainForFeature(b){const {layer:a,name:c,template:d}=this;if(!a||"wfs"===
a.type||"geojson"===a.type||"csv"===a.type)return null;if(d?.domain&&this._isDomainCompatible(d.domain))return d.domain;const {typeIdField:e}=a,f=this.field.domain;return e!==c||f?e&&null!=c&&a.getFieldDomain(c,{feature:b})||f:new H({name:"__internal-type-based-coded-value-domain__",codedValues:a.types?.map(({id:h,name:m})=>({code:h,name:m}))})}_getComputedDomain(b,a){return a?"range"===a.type?b:"coded-value"===a.type?(a=a.codedValues.filter(c=>c.hasOwnProperty("code")&&c.code===b))&&a.length?a[0].name:
b:null:null}_getCombinedDateTime(b,a){return new Date(b.getFullYear(),b.getMonth(),b.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())}_getDateFormatOptions(){const {template:b}=this,a=b?.format?.dateFormat;return a?y.convertDateFormatToIntlOptions(a):b?.input&&"includeTime"in b.input&&!1===b.input.includeTime?P:O}};k.__decorate([l.property({readOnly:!0})],g.prototype,"alias",null);k.__decorate([l.property()],g.prototype,"cellValueFormatFunction",void 0);k.__decorate([l.property()],g.prototype,
"cellValueValidatorFunction",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"defaultValue",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"description",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"editable",null);k.__decorate([l.property()],g.prototype,"editingEnabled",void 0);k.__decorate([l.property()],g.prototype,"expressionInfos",void 0);k.__decorate([l.property()],g.prototype,"field",void 0);k.__decorate([l.property()],g.prototype,"formatFunction",void 0);
k.__decorate([l.property({readOnly:!0})],g.prototype,"header",null);k.__decorate([l.property()],g.prototype,"hidden",null);k.__decorate([l.property()],g.prototype,"headerRenderFunction",void 0);k.__decorate([l.property()],g.prototype,"inputRenderFunction",void 0);k.__decorate([l.property()],g.prototype,"layer",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"loadingMessage",null);k.__decorate([l.property()],g.prototype,"maxLength",null);k.__decorate([l.property()],g.prototype,"minLength",
null);k.__decorate([l.property({readOnly:!0})],g.prototype,"name",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"nullable",null);k.__decorate([l.property()],g.prototype,"parseInputValueFunction",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"path",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"required",null);k.__decorate([l.property()],g.prototype,"sortable",null);k.__decorate([l.property()],g.prototype,"store",void 0);k.__decorate([l.property()],g.prototype,
"template",void 0);k.__decorate([l.property()],g.prototype,"updateRowItemFunction",void 0);k.__decorate([l.property()],g.prototype,"updateStoreItemFunction",void 0);return g=k.__decorate([G.subclass("esri.widgets.FeatureTable.FieldColumn")],g)});